<!DOCTYPE html>
<html lang="de" dir="ltr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Schülerverwaltung</title>

  <link rel="icon" type="image/png" sizes="128x128"
        href="https://drive.google.com/thumbnail?id=1T7-S0REmEvmSJbsBxajYQcSb2laWC7Jd&sz=w128-h128">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Alexandria:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" referrerpolicy="no-referrer">
<style>
/* iOS MODERN THEME & DARK MODE SUPPORT */
:root {
  --bg: #f2f2f7;
  --surface: #ffffff;
  --surface-2: #e5e5ea;
  --primary: #007aff;
  --primary-dark: #005bb5;
  --text: #1c1c1e;
  --text-sec: #8e8e93;
  --danger: #ff3b30;
  --warning: #ff9500;
  --success: #34c759;
  --border: #e5e5ea;
  --radius: 10px;
}
.dark-mode {
  --bg: #000000;
  --surface: #1c1c1e;
  --surface-2: #2c2c2e;
  --primary: #0a84ff;
  --primary-dark: #3a97ff;
  --text: #ffffff;
  --text-sec: #8e8e93;
  --danger: #ff453a;
  --warning: #ffd60a;
  --success: #32d74b;
  --border: #3a3a3c;
}
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body { margin: 0; padding: 0; font-family: 'Alexandria', sans-serif; background: var(--bg); color: var(--text); overflow: hidden; }

.hidden { display: none !important; }
.flex { display: flex; }
.flex-col { flex-direction: column; }
.center { align-items: center; justify-content: center; }
.gap-2 { gap: 0.5rem; }
.w-full { width: 100%; }
.p-4 { padding: 1rem; }
.text-sm { font-size: 0.875rem; }
.font-bold { font-weight: 700; }
.text-sec { color: var(--text-sec); }

#qs-app-root { position: fixed; inset: 0; z-index: 10; display: flex; flex-direction: column; }

#login-overlay { position: fixed; inset: 0; z-index: 9999; background: var(--bg); display: flex; flex-direction: column; align-items: center; justify-content: center; }
.login-box { background: var(--surface); padding: 2rem; border-radius: var(--radius); width: 90%; max-width: 350px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
.login-box input { width: 100%; padding: 12px; margin-top: 1rem; background: var(--surface-2); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 1.2rem; text-align: center; letter-spacing: 4px; }
.login-box input.login-text { letter-spacing: 0; text-align: left; }
.btn { background: var(--primary); color: white; border: none; padding: 12px 20px; border-radius: 10px; font-weight: 500; cursor: pointer; margin-top: 1rem; width: 100%; font-family: inherit; transition: 0.2s; box-shadow: none; }
.btn:active { transform: scale(0.98); opacity: 0.9; }
.btn-sec { background: var(--surface-2); color: var(--text); }

/* LOGIN TABS */
.login-tabs { display: flex; margin-bottom: 20px; background: var(--surface-2); border-radius: 8px; padding: 4px; }
.login-tab { flex: 1; padding: 8px; text-align: center; cursor: pointer; border-radius: 6px; font-size: 0.85rem; color: var(--text-sec); transition: 0.2s; }
.login-tab.active { background: var(--surface); color: var(--primary); font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

header { background: var(--surface); padding: 1rem; display: flex; align-items: center; justify-content: space-between; border-bottom: 0; box-shadow: 0 0.5px 0 rgba(0, 0, 0, 0.1); position: relative; z-index: 100; }
.logo-area { display: flex; align-items: center; gap: 10px; }
.logo-img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
.header-actions { display: flex; gap: 8px; }
.icon-btn { background: var(--bg); color: var(--primary); border: none; width: 44px; height: 44px; border-radius: 50%; cursor: pointer; position: relative; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; transition: background-color 0.1s; stroke-width: 2.5; stroke: currentColor; fill: none; }
.icon-btn:active { background: var(--surface-2); }
.icon-btn i { font-size: 1.15rem; line-height: 1; }

/* Cloud sync status */
#btn-cloud{ position: relative; }
#btn-cloud.cloud-ok{ color: var(--success); }
#btn-cloud.cloud-pending{ color: var(--warning); animation: cloudPulse 1.1s ease-in-out infinite; }
#btn-cloud.cloud-error{ color: var(--danger); }
@keyframes cloudPulse{ 0%{ transform: scale(1); } 50%{ transform: scale(1.06); } 100%{ transform: scale(1); } }
.badge { position: absolute; top: -2px; right: -2px; background: var(--danger); color: white; font-size: 10px; width: 16px; height: 16px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }

#filter-panel { background: var(--surface); overflow: hidden; max-height: 0; transition: max-height 0.3s ease; border-bottom: 0; box-shadow: 0 0.5px 0 rgba(0, 0, 0, 0.1); }
#filter-panel.open { max-height: 400px; overflow-y: auto; }
.search-bar { width: 100%; background: var(--bg); border: none; padding: 10px; color: var(--text); border-radius: 10px; font-family: inherit; }
.chips-container { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
.chip { padding: 6px 12px; background: var(--bg); border-radius: 20px; font-size: 0.8rem; cursor: pointer; border: 1px solid var(--border); user-select: none; color: var(--text); }
.chip.active { background: var(--primary); color: white; border-color: var(--primary); }

.filter-checkbox-group { display: flex; flex-wrap: wrap; gap: 10px; margin-top:6px;
  margin-bottom:6px; padding-top: 10px; border-top: 1px solid var(--border); }
.filter-checkbox { display: flex; align-items: center; font-size: 0.85rem; cursor: pointer; user-select: none; background: var(--bg); padding: 5px 10px; border-radius: 8px; border: 1px solid var(--border); }
.filter-checkbox input { margin-right: 8px; margin-left: 0; width: 18px; height: 18px; accent-color: var(--primary); }

main { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 1rem; padding-top: 5px; padding-bottom: 80px; position: relative; }

/* Unified gap below header */
main > .p-4{ padding-top: 0 !important; padding-left: 0 !important; padding-right: 0 !important; }


.card { background: var(--surface); border-radius: 12px; padding: 1rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 1rem; position: relative; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
.card-avatar { width: 50px; height: 50px; border-radius: 50%; background: var(--surface-2); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; font-weight: bold; overflow: hidden; flex-shrink: 0; color: var(--text); }
.card-avatar img { width: 100%; height: 100%; object-fit: cover; }
.card-info { flex: 1; min-width: 0; word-break: break-word; overflow-wrap: anywhere; }
.money-badge { position: absolute; top: 10px; right: 10px; background: var(--danger); color: #fff; font-size: 10px; padding: 2px 6px; border-radius: 4px; }
.status-badge { font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; margin-top: 4px; display: inline-block; }
.status-warning { background: var(--danger); color: var(--text); opacity: 0.7; }
.status-full { background: var(--warning); color: var(--text); opacity: 0.7; }

/* --- NEW ATTENDANCE BUTTON STYLES --- */
.attend-actions { display: flex; flex-direction: column; gap: 6px; align-items: flex-end; }
.att-select-btn { display: flex; align-items: center; justify-content: center; width: 55px; height: 40px; border-radius: 12px; border: 2px solid #8e8e93; cursor: pointer; transition: all 0.2s ease-in-out; user-select: none; box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-weight: bold; }
.att-select-btn:active { transform: scale(0.95); }
.att-select-btn i { font-size: 1.05rem; line-height: 1; }
.att-select-btn.is-present { background: var(--success); color: white; border-color: #8e8e93; }
.att-select-btn.selected { background: var(--danger); color: white; border-color: var(--text); box-shadow: 0 0 12px var(--danger); }
.att-select-btn.is-absent-db { background: var(--danger); color: white; border-color: #8e8e93; box-shadow: 0 0 10px var(--danger); }
.att-select-btn.is-late-db { background: var(--warning); color: var(--text); border-color: #8e8e93; box-shadow: 0 0 10px var(--warning); }
.att-select-btn.is-late-db i { font-size: 1.05rem; line-height: 1; }
.att-select-btn.is-absent-db.selected { background: var(--success); box-shadow: none; border-color: var(--text); }

/* Floating Action Button */
.fab-container { position: fixed; bottom: 90px; left: 0; right: 0; display: flex; justify-content: center; pointer-events: none; z-index: 90; transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); transform: translateY(150px); }
.fab-container.show { transform: translateY(0); pointer-events: auto; }
.fab-btn { background: var(--primary); color: white; border: none; padding: 12px 24px; border-radius: 30px; font-weight: bold; font-size: 1rem; box-shadow: 0 4px 15px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 10px; cursor: pointer; transition: 0.2s; }
.fab-btn:active { transform: scale(0.95); }
.fab-btn i { font-size: 1.1rem; line-height: 1; }

/* User FAB */
.fab-user-add { position: fixed; bottom: 90px; right: 20px; background: var(--primary); color: white; width: 56px; height: 56px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(0,0,0,0.3); cursor: pointer; z-index: 80; transition: 0.2s; border: none; }
.fab-user-add:active { transform: scale(0.95); }

/* PROGRESS OVERLAY */
#progress-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
#progress-overlay.visible { opacity: 1; pointer-events: auto; }
.progress-box { background: var(--surface); padding: 25px; border-radius: 20px; width: 85%; max-width: 320px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
.progress-bar-track { width: 100%; height: 10px; background: var(--surface-2); border-radius: 10px; margin: 15px 0; overflow: hidden; }
.progress-bar-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s ease; border-radius: 10px; }
.progress-text { font-size: 0.9rem; font-weight: bold; color: var(--text); }
.success-msg { color: var(--success); font-weight: bold; margin-top: 10px; display: none; }

.checkbox-list { max-height: 200px; overflow-y: auto; background: var(--bg); border-radius: 10px; padding: 5px; margin-top: 5px; border: 1px solid var(--border); }
.checkbox-item { display: flex; align-items: center; padding: 8px; border-bottom: 1px solid var(--border); }
.checkbox-item:last-child { border-bottom: none; }
.checkbox-item input[type="checkbox"] { width: 20px; height: 20px; margin-right: 10px; margin-left: 0; accent-color: var(--primary); }
.checkbox-item label { flex: 1; font-size: 0.9rem; cursor: pointer; }

nav.bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--surface); border-top: 0; box-shadow: 0 -0.5px 0 rgba(0, 0, 0, 0.1); padding: 0.5rem; display: flex; justify-content: space-around; z-index: 50; padding-bottom: calc(0.5rem + env(safe-area-inset-bottom)); }
.nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: var(--text-sec); font-size: 0.7rem; background: none; border: none; cursor: pointer; position: relative; padding: 5px 0; }
.nav-item.active { color: var(--primary); }
.nav-item i { font-size: 1.1rem; line-height: 1; }

.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 100; display: flex; align-items: flex-end; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
.modal-overlay.visible { opacity: 1; pointer-events: auto; }
.modal-content { position: relative; background: var(--surface); width: 100%; max-height: 90vh; border-radius: 20px 20px 0 0; padding: 1.5rem; overflow-y: auto; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.4, 1); }
.modal-overlay.visible .modal-content { transform: translateY(0); }

.close-icon { position: absolute; top: 15px; right: 15px; background: var(--surface-2); border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: none; font-size: 1.2rem; color: var(--text-sec); z-index: 20; transition: background 0.2s; }
.close-icon:active { background: var(--border); }
.clickable-name { cursor: pointer; text-decoration: underline; text-decoration-color: rgba(255, 59, 48, 0.3); transition: opacity 0.2s; }
.clickable-name:active { opacity: 0.7; }

.detail-header { text-align: center; margin-bottom: 1.5rem; }
.detail-avatar { width: 80px; height: 80px; border-radius: 50%; margin: 0 auto 1rem; background: var(--surface-2); display: flex; align-items: center; justify-content: center; overflow: hidden; font-size: 2rem; }
.detail-avatar img { width: 100%; height: 100%; object-fit: cover; }
.detail-grid { display: flex; flex-direction: column; gap: 10px; text-align: left; }

.detail-item { background: var(--bg); padding: 0.8rem; border-radius: 10px; word-break: break-word; overflow-wrap: anywhere; }
.detail-label { font-size: 0.8rem; color: var(--text-sec); margin-bottom: 2px; font-weight: 500;}

.form-group { margin-bottom: 1rem; text-align: left; }
.form-label { display: block; font-size: 0.8rem; margin-bottom: 4px; color: var(--text-sec); }
.form-input, .form-select, .form-textarea { width: 100%; background: var(--bg); border: 1px solid var(--border); padding: 10px; color: var(--text); border-radius: 10px; font-family: inherit; }
.form-input:focus, .form-select:focus, .form-textarea:focus { border-color: var(--primary); outline: none; }

.msg-card { background: var(--surface); padding: 1rem; margin-bottom: 1rem; border-radius: 12px; border-left: 4px solid var(--surface-2); box-shadow: 0 1px 3px rgba(0,0,0,0.08); transition: 0.2s; }
.msg-card.new { border-left-color: var(--primary); }
.msg-header { display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.8rem; color: var(--text-sec); }
.msg-text { white-space: pre-wrap; word-break: break-word; overflow-wrap: anywhere; }
.msg-text a { color: var(--primary); text-decoration: underline; }

.notes-section { margin-top: 2rem; border-top: 1px solid var(--border); padding-top: 1rem; }
.notes-list { margin-bottom: 1rem; display: flex; flex-direction: column; gap: 8px; }
.note-item { background: var(--bg); padding: 10px; border-radius: 8px; font-size: 0.9rem; border: 1px solid var(--border); word-break: break-word; overflow-wrap: anywhere; }
.note-item a { color: var(--primary); text-decoration: underline; }
.note-meta { font-size: 0.75rem; color: var(--text-sec); margin-top: 4px; display: flex; justify-content: space-between; }
.detail-item a { color: var(--primary); text-decoration: underline; }

#toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: var(--surface); padding: 10px 20px; border-radius: 15px; color: var(--text); font-size: 0.9rem; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 200; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
#toast.show { opacity: 1; bottom: 150px; }

@media print {
  body * { visibility: hidden; }
  #print-container, #print-container * { visibility: visible; }
  #qs-app-root, #login-overlay { display: none !important; }
  #print-container { position: absolute; left: 0; top: 0; width: 100%; background: white; color: black; padding: 20px; }
}

html[dir="ltr"] .money-badge { left: auto; right: 10px; }
html[dir="ltr"] .close-icon { left: auto; right: 15px; }

.doc-actions { display: flex; gap: 10px; flex-shrink: 0; }
.doc-btn { background: var(--surface-2); color: var(--primary); border: none; border-radius: 8px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
.doc-btn:active { transform: scale(0.95); opacity: 0.8; }
.doc-btn i { font-size: 1.05rem; line-height: 1; }

.user-action-btn { background: var(--surface-2); border: none; width: 36px; height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text); }

/* TAB CONTROLS for Modals */
.tab-controls { display: flex; margin-bottom: 1rem; border-bottom: 1px solid var(--border); }
.tab-ctrl { flex: 1; padding: 10px; text-align: center; cursor: pointer; color: var(--text-sec); border-bottom: 2px solid transparent; font-size: 0.9rem; }
.tab-ctrl.active { color: var(--primary); border-bottom-color: var(--primary); font-weight: bold; }


/* --- LESSON (Quran) Modal Styles --- */
.verse-card { background: var(--bg); border: 1px solid var(--border); border-radius: 12px; padding: 12px; margin-bottom: 10px; width: 100%; }
.verse-top { display:flex; align-items:center; justify-content:space-between; gap:10px; }
.verse-num { font-size: 0.8rem; color: var(--text-sec); }
.verse-ar { direction: rtl; text-align: right; font-size: 1.35rem; line-height: 2.2rem; margin-top: 8px; font-family: 'Alexandria', sans-serif; }
.verse-de { direction:ltr; text-align:left; font-size: 0.95rem; margin-top: 10px; color: var(--text); }
.audio-row { display:flex; gap:8px; margin-top:10px; }
.audio-btn { background: var(--primary); color:#fff; border:none; padding:6px 8px; border-radius:10px; cursor:pointer; font-weight:600; font-family:inherit; flex:0 0 auto; }
.audio-btn:active { transform: scale(0.98); opacity:0.9; }
.audio-btn.sec { background: var(--surface-2); color: var(--text); }
.lesson-meta { font-size:0.85rem; color: var(--text-sec); margin-top: 2px; }

/* --- FLOATING AUDIO PLAYER --- */
.floating-audio-player {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  background: var(--surface);
  padding: 12px 15px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.15);
  z-index: 99;
  transform: translateY(calc(-100% - 2px));
  transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  border-bottom: 1px solid var(--border);
}
.floating-audio-player.show {
  transform: translateY(var(--header-h, 0px));
}
.floating-audio-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}
.floating-audio-title {
  font-weight: bold;
  font-size: 0.9rem;
  color: var(--primary);
  flex: 1;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.floating-audio-close {
  background: var(--surface-2);
  border: none;
  width: 28px;
  height: 28px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 0.9rem;
  color: var(--text-sec);
  flex-shrink: 0;
}
.floating-audio-controls {
  display: flex;
  gap: 8px;
  align-items: center;
  justify-content: center;
  margin-top: 8px;
  flex-wrap: wrap;
}
.floating-audio-progress {
  width: 100%;
  height: 4px;
  background: var(--surface-2);
  border-radius: 2px;
  margin: 8px 0;
  overflow: hidden;
}
.floating-audio-progress-fill {
  height: 100%;
  background: var(--primary);
  width: 0%;
  transition: width 0.1s;
}
.floating-audio-info {
  font-size: 0.75rem;
  color: var(--text-sec);
  margin-top: 5px;
  text-align: center;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* Quran Search Bar in Lesson Modal */
.quran-search-bar {
  display: flex;
  gap: 8px;
  margin-bottom: 15px;
  flex-wrap: wrap;
}
.quran-search-input {
  flex: 1;
  min-width: 0;
  background: var(--bg);
  border: 1px solid var(--border);
  padding: 10px;
  border-radius: 10px;
  color: var(--text);
  font-family: inherit;
}
.quran-search-btn {
  background: var(--primary);
  color: white;
  border: none;
  padding: 10px 15px;
  border-radius: 10px;
  cursor: pointer;
  font-weight: 600;
  font-family: inherit;
  white-space: nowrap;
}
.quran-search-btn:active {
  transform: scale(0.98);
  opacity: 0.9;
}

/* Surah Header in Lesson Modal */
.surah-header {
  text-align: center;
  margin-bottom: 15px;
  padding-bottom: 10px;
  border-bottom: 1px solid var(--border);
}
.surah-name-arabic {
  font-size: 1.5rem;
  font-weight: bold;
  color: var(--primary);
  margin-bottom: 5px;
  font-family: 'Alexandria', sans-serif;
}
.surah-name-latin {
  font-size: 1rem;
  color: var(--text-sec);
  margin-bottom: 5px;
}
.surah-info {
  font-size: 0.85rem;
  color: var(--text-sec);
  display: flex;
  justify-content: center;
  gap: 15px;
  margin-top: 5px;
}


/* Unified Login (one PIN field for all roles) */
.login-unified{
  margin-top: 14px;
  display:flex;
  flex-direction:column;
  gap:10px;
}
.login-badge{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  align-self:flex-start;
  padding:6px 10px;
  border-radius:999px;
  background: var(--surface-2);
  border:1px solid var(--border);
  color: var(--text-sec);
  font-size:0.8rem;
}
.login-text{
  background: var(--bg);
  border: 1px solid var(--border);
  padding: 12px 12px;
  border-radius: 10px;
  color: var(--text);
  font-size: 1rem;
  font-family: inherit;
  width: 100%;
}
.login-help{
  font-size: 0.78rem;
  color: var(--text-sec);
  line-height: 1.4;
}



/* Quran "mushaf" view (Tarteel-like) */
.lesson-view-toolbar{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  justify-content:flex-end;
  margin: 8px 0 12px;
}
.pill-btn{
  background: var(--surface-2);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 8px 12px;
  border-radius: 999px;
  cursor:pointer;
  font-weight:600;
  font-family: inherit;
}
.pill-btn:active{ transform: scale(0.98); opacity: 0.92; }

.mushaf-card{
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 16px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.06);
}
.mushaf-arabic{
  direction: rtl;
  text-align: justify;
  font-size: var(--mushaf-font, 1.65rem);
  line-height: 2.7rem;
  letter-spacing: 0;
  font-family: 'Alexandria', system-ui, -apple-system, Segoe UI, sans-serif;
  user-select: text;
}
.ayah-span{
  display:inline;
  cursor:pointer;
  border-radius: 8px;
  padding: 2px 4px;
  margin: 0 1px;
}
.ayah-span:hover{
  background: rgba(10,132,255,0.10);
}
.ayah-span.in-range{
  background: rgba(10,132,255,0.12);
  box-shadow: 0 0 0 1px rgba(10,132,255,0.28) inset;
}
.ayah-span.playing{
  background: rgba(52,199,89,0.12);
  box-shadow: 0 0 0 1px rgba(52,199,89,0.28) inset;
}
.ayah-num{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  width: 1.55em;
  height: 1.55em;
  margin: 0 0.25em 0 0.15em;
  border-radius: 999px;
  border: 1px solid var(--border);
  background: var(--bg);
  color: var(--text-sec);
  font-size: 0.55em;
  line-height: 1;
  vertical-align: middle;
}

.lesson-translation{
  margin-top: 12px;
  display:flex;
  flex-direction:column;
  gap:8px;
}
.trans-item{
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 12px;
}
.trans-head{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin-bottom: 6px;
}
.trans-ayah{
  font-weight:700;
  color: var(--primary);
}
.trans-text{
  color: var(--text-sec);
  font-size: 0.95rem;
  line-height: 1.55;
}


/* Homework type selector */
.hw-type-row{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}
.hw-type{
  display:flex;
  align-items:center;
  gap:8px;
  padding:8px 10px;
  border-radius:12px;
  border:1px solid var(--border);
  background: var(--surface-2);
  cursor:pointer;
  user-select:none;
  font-size:0.95rem;
}
.hw-type input{ margin:0; }

/* Memorization (save) view: each ayah as its own card (Arabic + translation) */
.ayah-cards{
  display:flex;
  flex-direction:column;
  gap:10px;
}
.ayah-card{
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}
.ayah-card-head{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin-bottom: 8px;
}
.ayah-card-title{
  font-weight: 800;
  color: var(--primary);
  font-size: 0.95rem;
}
.ayah-card-ar{
  direction: rtl;
  text-align: right;
  font-size: 1.25rem;
  line-height: 2.05rem;
  font-family: 'Alexandria', system-ui, -apple-system, Segoe UI, sans-serif;
}
.ayah-card-tr{
  margin-top: 8px;
  color: var(--text-sec);
  font-size: 0.86rem;
  line-height: 1.55;
  white-space: pre-wrap;
}


/* Floating reader toggle (student) */
.reader-fab{
  position: fixed;
  bottom: 84px; /* above bottom nav */
  right: 18px;
  width: 52px;
  height: 52px;
  border-radius: 999px;
  border: 1px solid var(--border);
  background: var(--primary);
  color: white;
  box-shadow: 0 8px 18px rgba(0,0,0,0.25);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index: 99999;
  cursor:pointer;
}
.reader-fab i{ font-size: 1.35rem; }
.reader-fab.hidden{ display:none; }
.reader-fab:active{ transform: scale(0.98); opacity: 0.92; }


.ayah-span.selected{
  background: rgba(10,132,255,0.18);
  box-shadow: 0 0 0 1px rgba(10,132,255,0.35) inset;
}


/* Student memorize (surah list) */
.surah-card{
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 18px;
  padding: 12px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  cursor:pointer;
}
.surah-left{
  display:flex;
  gap:12px;
  align-items:center;
  min-width:0;
}
.surah-badge{
  width: 44px;
  height: 44px;
  border-radius: 14px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight: 800;
  color: white;
  background: var(--primary);
  flex: 0 0 auto;
}
.surah-names{
  min-width:0;
}
.surah-ar{
  font-weight: 800;
  font-size: 1.15rem;
  line-height: 1.2;
  color: var(--text);
  direction: rtl;
}
.surah-la{
  font-size: 0.9rem;
  color: var(--text-sec);
  margin-top: 2px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.surah-meta{
  font-size: 0.78rem;
  color: var(--text-sec);
  margin-top: 6px;
}
.surah-open{
  width: auto;
  padding: 10px 14px;
  border-radius: 14px;
}


/* ===== iPhone Premium Polish (override) ===== */
:root{
  --radius: 16px;
  --radius-lg: 22px;
  --shadow-1: 0 2px 10px rgba(0,0,0,0.06);
  --shadow-2: 0 10px 30px rgba(0,0,0,0.18);
  --glass: rgba(255,255,255,0.72);
  --glass-2: rgba(255,255,255,0.55);
}
.dark-mode{
  --glass: rgba(28,28,30,0.72);
  --glass-2: rgba(28,28,30,0.55);
}
body{
  font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", "Alexandria", system-ui, sans-serif;
  background: radial-gradient(1200px 700px at 20% -10%, rgba(0,122,255,0.12), transparent 60%),
              radial-gradient(900px 600px at 90% 0%, rgba(52,199,89,0.10), transparent 55%),
              var(--bg);
}
header{
  background: var(--glass);
  backdrop-filter: saturate(180%) blur(22px);
  -webkit-backdrop-filter: saturate(180%) blur(22px);
  border-bottom: 1px solid rgba(60,60,67,0.12);
  box-shadow: none;
}
nav.bottom-nav{
  background: var(--glass);
  backdrop-filter: saturate(180%) blur(22px);
  -webkit-backdrop-filter: saturate(180%) blur(22px);
  border-top: 1px solid rgba(60,60,67,0.12);
  box-shadow: none;
}
.card, .surah-card, .mushaf-card, .msg-card, .progress-box, .login-box, .modal-content{
  border-radius: var(--radius-lg);
}
.card{ box-shadow: var(--shadow-1); }
.surah-card{ box-shadow: var(--shadow-1); }
.mushaf-card{ box-shadow: var(--shadow-1); }
.icon-btn{ background: rgba(118,118,128,0.12); }
.icon-btn:active{ background: rgba(118,118,128,0.22); }
.search-bar, .form-input, .form-select, .form-textarea, .quran-search-input{
  background: rgba(118,118,128,0.10);
  border: 1px solid rgba(60,60,67,0.14);
}
.chip{ background: rgba(118,118,128,0.10); border: 1px solid rgba(60,60,67,0.14); }
.modal-overlay{
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
}
.modal-content{
  background: var(--glass);
  border: 1px solid rgba(60,60,67,0.12);
  box-shadow: var(--shadow-2);
}
.btn{
  box-shadow: 0 8px 18px rgba(0,122,255,0.25);
}
.btn.btn-sec{
  box-shadow: none;
}
.ayah-span{
  touch-action: manipulation; /* prevent double-tap zoom + improves multi-tap gestures */
}
@media (prefers-reduced-motion: reduce){
  *{ transition: none !important; animation: none !important; }
}

/* Quick Verse Sheet (meaning / phonetic) */
.quick-sheet-overlay{
  position: fixed;
  inset: 0;
  z-index: 999999;
  display: flex;
  align-items: flex-end;
  justify-content: center;
  padding: 16px;
  padding-bottom: calc(16px + env(safe-area-inset-bottom));
  background: rgba(0,0,0,0.25);
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.22s ease;
}
.quick-sheet-overlay.show{
  opacity: 1;
  pointer-events: auto;
}
.quick-sheet{
  width: min(680px, 100%);
  background: var(--glass);
  backdrop-filter: saturate(180%) blur(26px);
  -webkit-backdrop-filter: saturate(180%) blur(26px);
  border: 1px solid rgba(60,60,67,0.14);
  border-radius: 26px;
  box-shadow: var(--shadow-2);
  padding: 14px 14px 12px;
  transform: translateY(18px);
  transition: transform 0.22s ease;
}
.quick-sheet-overlay.show .quick-sheet{ transform: translateY(0); }
.quick-sheet-top{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin-bottom: 8px;
}
.quick-sheet-title{
  font-weight: 800;
  letter-spacing: -0.01em;
  color: var(--primary);
  font-size: 0.98rem;
}
.quick-sheet-actions{
  display:flex;
  gap:8px;
  align-items:center;
}
.quick-sheet-btn{
  border: 1px solid rgba(60,60,67,0.14);
  background: rgba(118,118,128,0.12);
  color: var(--text);
  border-radius: 12px;
  padding: 8px 10px;
  cursor:pointer;
  font-weight: 700;
  font-family: inherit;
}
.quick-sheet-btn:active{ transform: scale(0.98); opacity: 0.92; }
.quick-sheet-close{
  width: 36px;
  height: 36px;
  border-radius: 999px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size: 1.1rem;
}
.quick-sheet-ar{
  direction: rtl;
  text-align: right;
  font-size: 1.20rem;
  line-height: 2.00rem;
  padding: 10px 12px;
  border-radius: 16px;
  border: 1px solid rgba(60,60,67,0.14);
  background: rgba(118,118,128,0.10);
  font-family: 'Alexandria', -apple-system, system-ui, sans-serif;
}
.quick-sheet-body{
  margin-top: 10px;
  padding: 10px 12px;
  border-radius: 16px;
  border: 1px solid rgba(60,60,67,0.14);
  background: rgba(118,118,128,0.08);
  color: var(--text);
  line-height: 1.6;
  font-size: 0.90rem;
  word-break: break-word;
  overflow-wrap: anywhere;
}
.quick-sheet-sub{
  margin-top: 8px;
  font-size: 0.78rem;
  color: var(--text-sec);
}



/* === Login redesign (cleaner + more organized) === */
.login-box{
  width: min(420px, 92vw);
  padding: 22px;
  text-align: left;
}
.login-brand{
  display:flex;
  align-items:center;
  gap:14px;
  margin-bottom: 14px;
}
.login-logo{
  width: 64px;
  height: 64px;
  border-radius: 14px;
  object-fit: cover;
  box-shadow: 0 6px 18px rgba(0,0,0,0.12);
}
.login-brand-text h2{
  margin:0;
  line-height: 1.2;
}
.login-sub{
  margin-top: 4px;
  font-size: 0.85rem;
  color: var(--text-sec);
}
.login-form .form-group{ margin-top: 10px; }
.login-remember{
  display:flex;
  align-items:center;
  gap:8px;
  margin-top: 12px;
  font-size: 0.92rem;
  justify-content:flex-start;
}

/* Fix: keep "Angemeldet bleiben" aligned with its checkbox */
.login-remember input[type="checkbox"]{
  width: 18px;
  height: 18px;
  margin: 0;
  padding: 0;
  flex: 0 0 auto;
  accent-color: var(--primary);
}
.login-remember span{
  line-height: 1.1;
}

.login-error{
  color: var(--danger);
  margin-top: 10px;
  font-size: 0.9rem;
  min-height: 1.2em;
}
.login-pin{
  text-align:center;
  letter-spacing: 4px;
  font-size: 1.15rem;
}

/* === Red dot badge for "new" on tabs === */
.dot-badge{
  position:absolute;
  top: 6px;
  right: 16px;
  width: 10px;
  height: 10px;
  border-radius: 999px;
  background: var(--danger);
  box-shadow: 0 0 0 2px var(--bg);
}

/* Student popup alerts */
#alert-modal .modal-content{
  border-radius: 18px;
  width: min(520px, calc(100% - 32px));
  height: auto;
  max-height: 80vh;
  margin: 10vh auto;
  transform: translateY(18px) scale(0.99);
}
#alert-modal.visible .modal-content{
  transform: translateY(0) scale(1);
}


/* === Stats: make Today boxes compact + horizontal on mobile (Teacher/Admin) === */
.stats-mini-row{
  display: grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 10px;
  margin-top: 1rem;
}
.stats-mini-row .card{
  margin: 0 !important;
  padding: 0.75rem;
  gap: 0.35rem;
  align-items: center;
  justify-content: center;
  text-align: center;
}
.stats-mini-row .text-sec{
  font-size: 0.72rem;
  line-height: 1.15;
}
.stats-mini-row .font-bold{
  font-size: 1.55rem !important; /* override inline 2rem */
  line-height: 1.2;
}
@media (max-width: 360px){
  .stats-mini-row{ gap: 8px; }
  .stats-mini-row .card{ padding: 0.65rem; }
  .stats-mini-row .font-bold{ font-size: 1.35rem !important; }
}



/* === Fortschritt inline summary (Akte + Home) === */
.prog-inline{
  display:flex;
  flex-direction:column;      /* كل سورة في سطر */
  align-items:flex-end;       /* محاذاة لليمين */
  gap:4px;
  line-height: 1.35;
  max-width: 100%;
}
.prog-item{
  display:block;              /* سطر مستقل */
  font-weight: 900;
  font-size: 0.95rem;
  white-space: nowrap;
}
.prog-item.partial{ color: var(--danger); }
.prog-item.complete{ color: var(--success); }
/* separator not used anymore */
.prog-sep{ display:none; }
@media (max-width: 420px){
  .prog-item{ font-size: 0.9rem; white-space: normal; }
}



/* --- Header layout update: logo + title centered, icons under --- */
.app-header{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:2px;
  text-align:center;
}

.app-header .logo-area{
  display:flex;
  flex-direction:row; /* keep logo beside text */
  justify-content:center;
  align-items:center;
  gap:6px;
}
.app-header .logo-text{
  display:flex;
  flex-direction:column;
  align-items:flex-start;
  text-align:left;
}

.app-header .header-actions{
  width:100%;
  display:flex;
  justify-content:center;
  align-items:center;
  gap:6px;
  flex-wrap:wrap;
}

/* header-actions tighten */
.header-actions{ margin:0; padding:0; }



/* --- Header ultra-compact --- */
header.app-header{
  padding: 1px 8px 1px 8px; /* 1px top, 1px bottom */
}
header.app-header .logo-img{ width:32px; height:32px; }
header.app-header .icon-btn{ width:30px; height:30px; font-size:1.05rem; }
header.app-header .logo-text{ line-height:1.05; }

.app-header .logo-text{
  line-height: 1.15;
}
.app-header .logo-img{
  width: 34px;
  height: 34px;
}
.app-header .icon-btn{
  width: 44px;
  height:  44px;
  padding:  9px;
}
.app-header .icon-btn i { font-size: 1.15rem; line-height: 1; }
/* --- Bigger header icons (touch friendly) --- */
.app-header .icon-btn{
  width: 45px !important;
  height: 45px !important;
  padding: 7px !important;
  margin: 0 !important;
}
.app-header .icon-btn i { font-size: 1.15rem; line-height: 1; }
/* keep only 1px gap to header bottom */
header.app-header{
  padding-top: 1px !important;
  padding-bottom: 1px !important;
}


/* === Ultra-compact Schüler cards (requested) === */
#tab-students { padding-top: 5px !important; padding-left: 6px !important; padding-right: 6px !important; }
#tab-students .card{
  padding:  2px 10px !important;          /* +2px top/bottom for taller student rows */
  margin-bottom: 3px !important;       /* minimal space between students */
  gap: 10px !important;
  align-items: stretch !important;      /* let action column span full height */
}
#tab-students .card-avatar{
  width: 44px !important;
  height: 44px !important;
  align-self: center !important;
}
#tab-students .card-info{
  align-self: center !important;
}
#tab-students .card-info .font-bold{
  line-height: 1.05 !important;
  margin: 0 !important;
}
#tab-students .card-info .text-sm{
  line-height: 1.05 !important;
  margin-top: 1px !important;
}
#tab-students .card-info .status-badge{
  margin-top: 1px !important;
}
#tab-students .attend-actions{
  align-self: stretch !important;
  justify-content: space-between !important; /* first button touches top, second touches bottom */
  gap: 0 !important;
  padding: 0 !important;
  margin: 0 !important;
}
#tab-students .att-select-btn{
  margin: 0 !important;
}



/* --- Saved profiles (quick login) --- */
.saved-profiles{
  margin-top: 10px;
  padding: 8px 10px;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.04);
}
.saved-profiles.hidden{ display:none !important; }

.saved-profiles-title{
  font-weight: 700;
  font-size: 13px;
  line-height: 1.1;
  margin: 0 0 8px 0;
  opacity: .95;
}
.saved-profiles-hint{
  font-size: 11px;
  line-height: 1.1;
  margin-top: 8px;
  opacity: .75;
}
.saved-profiles-list{
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.profile-tile{
  position: relative;
  width: 86px;
  padding: 8px 6px 6px;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.06);
  cursor: pointer;
  user-select: none;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  transition: transform .08s ease, background .08s ease, border-color .08s ease;
}
.profile-tile:active{ transform: scale(.98); }
.profile-tile:hover{ background: rgba(255,255,255,.09); border-color: rgba(255,255,255,.22); }

.profile-avatar{
  width: 48px;
  height: 48px;
  border-radius: 999px;
  display: grid;
  place-items: center;
  font-weight: 800;
  font-size: 16px;
  letter-spacing: .4px;
  background: rgba(0,0,0,.25);
  border: 1px solid rgba(255,255,255,.20);
}
body.dark .profile-avatar{ background: rgba(255,255,255,.10); }

.profile-name{
  margin-top: 6px;
  font-size: 11px;
  line-height: 1.05;
  text-align: center;
  max-width: 100%;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  opacity: .95;
}

.profile-sub{
  margin-top: 2px;
  font-size: 10px;
  line-height: 1.05;
  opacity: .70;
}

.profile-remove{
  position: absolute;
  top: 4px;
  right: 4px;
  width: 18px;
  height: 18px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.22);
  background: rgba(0,0,0,.25);
  color: inherit;
  font-size: 14px;
  line-height: 16px;
  padding: 0;
  cursor: pointer;
}
.profile-remove:hover{ background: rgba(255,0,0,.22); border-color: rgba(255,0,0,.35); }

@media (max-width: 420px){
  .profile-tile{ width: 78px; }
  .profile-avatar{ width: 44px; height: 44px; }
}
/* === Login Loading Overlay (modern + animated) === */
#login-loading-overlay{
  position: fixed;
  inset: 0;
  z-index: 100000; /* فوق شاشة الدخول */
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 18px;
  padding-bottom: calc(18px + env(safe-area-inset-bottom));
  background: rgba(0,0,0,0.35);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.25s ease;
}
#login-loading-overlay.visible{
  opacity: 1;
  pointer-events: auto;
}
.login-loading-card{
  width: min(360px, 92vw);
  border-radius: 26px;
  padding: 18px 16px 16px;
  background: radial-gradient(900px 500px at 20% 0%, rgba(0,122,255,0.55), rgba(0,0,0,0.20) 55%),
              radial-gradient(700px 520px at 90% 0%, rgba(52,199,89,0.30), rgba(0,0,0,0.0) 58%),
              rgba(18,18,20,0.55);
  border: 1px solid rgba(255,255,255,0.18);
  box-shadow: 0 20px 60px rgba(0,0,0,0.40);
  color: #fff;
  text-align: center;
}
.login-loading-text{
  margin-top: 12px;
  font-weight: 800;
  letter-spacing: -0.01em;
  font-size: 0.95rem;
  opacity: 0.95;
}
.login-loading-sub{
  margin-top: 4px;
  font-size: 0.78rem;
  opacity: 0.78;
}
#lbl-login-btn:disabled{
  opacity: 0.65;
  cursor: not-allowed;
}

/* HTML:
   <div class="loader"></div>
*/
.loader {
  width: 75px;
  aspect-ratio: 1;
  display: grid;
  margin: 0 auto;
}
.loader:before,
.loader:after {
  content: "";
  grid-area: 1/1;
  width: 35px;
  aspect-ratio: 1;
  box-shadow: 0 0 0 3px #fff inset;
  filter: drop-shadow(40px 40px 0 #fff);
  animation: l8 2s infinite alternate;
}
.loader:after {
  margin: 0 0 0 auto;
  filter: drop-shadow(-40px 40px 0 #fff);
  animation-delay: -1s;
}
@keyframes l8 {
  0%,10%   {border-radius:0}
  30%,40%  {border-radius:50% 0}
  60%,70%  {border-radius:50%}
  90%,100% {border-radius:0 50%}
}

/* --- Inline saved profiles dropdown inside username field --- */
#saved-profiles{ display:none !important; } /* hide old tiles UI (replaced by dropdown) */

.input-dd{
  position: relative;
}
.input-dd #login-identifier{ padding-right: 54px; }

.input-dd .dd-btn{
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  width: 34px;
  height: 34px;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.08);
  color: inherit;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  transition: transform .12s ease, background .12s ease;
}
.input-dd .dd-btn:active{ transform: translateY(-50%) scale(.98); }
.input-dd .dd-btn:hover{ background: rgba(255,255,255,.12); }

.input-dd .dd-panel{
  position:absolute;
  left:0;
  right:0;
  top: calc(100% + 8px);
  z-index: 1000;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(18,18,22,.72);
  backdrop-filter: blur(14px);
  -webkit-backdrop-filter: blur(14px);
  box-shadow: 0 18px 40px rgba(0,0,0,.35);
  overflow:hidden;
  max-height: 260px;
}
.input-dd .dd-panel.hidden{ display:none !important; }

.dd-item{
  width:100%;
  display:flex;
  align-items:center;
  gap:10px;
  padding:10px 10px;
  background: transparent;
  border: 0;
  color: inherit;
  text-align:left;
  cursor:pointer;
}
.dd-item:hover{ background: rgba(255,255,255,.08); }
.dd-item:active{ background: rgba(255,255,255,.11); }

.dd-avatar{
  width: 34px;
  height: 34px;
  border-radius: 12px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight: 700;
  background: rgba(255,255,255,.10);
  border: 1px solid rgba(255,255,255,.12);
  flex: 0 0 auto;
}
.dd-meta{
  min-width: 0;
  flex: 1 1 auto;
}
.dd-name{
  font-weight: 650;
  font-size: 0.95rem;
  line-height: 1.1;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.dd-sub{
  opacity: .78;
  font-size: 0.78rem;
  margin-top: 2px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.dd-remove{
  width: 28px;
  height: 28px;
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.06);
  color: inherit;
  cursor: pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  flex: 0 0 auto;
}
.dd-remove:hover{ background: rgba(255,255,255,.10); }


/* --- iOS-style exit confirmation (Back button) --- */
#ios-exit-confirm{
  position: fixed;
  inset: 0;
  z-index: 99999;
  display: grid;
  place-items: center;
  pointer-events: none;
}
#ios-exit-confirm.hidden{ display:none; }
#ios-exit-confirm .ios-backdrop{
  position:absolute;
  inset:0;
  background: rgba(0,0,0,.35);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  opacity: 0;
  transition: opacity .18s ease;
}
#ios-exit-confirm .ios-card{
  position: relative;
  width: min(340px, calc(100vw - 40px));
  border-radius: 16px;
  background: rgba(255,255,255,.92);
  color: #111;
  box-shadow: 0 12px 40px rgba(0,0,0,.25);
  transform: translateY(8px) scale(.98);
  opacity: 0;
  transition: transform .18s ease, opacity .18s ease;
  overflow: hidden;
  direction: rtl;
  text-align: right;
}
body.dark #ios-exit-confirm .ios-card{
  background: rgba(28,28,30,.92);
  color: #f5f5f7;
  box-shadow: 0 14px 44px rgba(0,0,0,.45);
}
#ios-exit-confirm.visible{ pointer-events:auto; }
#ios-exit-confirm.visible .ios-backdrop{ opacity: 1; }
#ios-exit-confirm.visible .ios-card{
  transform: translateY(0) scale(1);
  opacity: 1;
}
#ios-exit-confirm .ios-body{
  padding: 16px 18px 14px;
}
#ios-exit-confirm .ios-title{
  font-weight: 700;
  font-size: 16px;
  line-height: 1.2;
  margin-bottom: 6px;
}
#ios-exit-confirm .ios-msg{
  font-size: 14px;
  line-height: 1.45;
  opacity: .9;
}
#ios-exit-confirm .ios-actions{
  display: grid;
  grid-template-columns: 1fr 1fr;
  border-top: 1px solid rgba(0,0,0,.12);
}
body.dark #ios-exit-confirm .ios-actions{
  border-top-color: rgba(255,255,255,.12);
}
#ios-exit-confirm .ios-btn{
  appearance:none;
  border:0;
  background: transparent;
  padding: 12px 10px;
  font-size: 15px;
  cursor: pointer;
  color: inherit;
}
#ios-exit-confirm .ios-btn + .ios-btn{
  border-right: 1px solid rgba(0,0,0,.12);
}
body.dark #ios-exit-confirm .ios-btn + .ios-btn{
  border-right-color: rgba(255,255,255,.12);
}
#ios-exit-confirm .ios-btn.ios-cancel{
  font-weight: 600;
}
#ios-exit-confirm .ios-btn.ios-exit{
  font-weight: 700;
  color: #ff3b30;
}


/* --- Bulk Homework (Teacher/Admin) --- */
#hw-bulk-progress { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
#hw-bulk-progress.visible { opacity: 1; pointer-events: auto; }
.hw-admin-card{
  padding: 14px !important;
}
.hw-admin-grid{
  width:100%;
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:10px;
}
@media (max-width: 520px){
  .hw-admin-grid{ grid-template-columns: 1fr; }
}
.hw-admin-actions{
  width:100%;
  display:flex;
  gap:5px;
  margin-top:5px;
}

.hw-admin-actions-wide{ flex-wrap: wrap; align-items: center; ; justify-content:flex-start}
.btn-danger{
  background: rgba(255,59,48,0.14);
  border: 1px solid rgba(255,59,48,0.35);
  color: #ff3b30;
}
.btn-danger:hover{ background: rgba(255,59,48,0.22); }
.btn-danger:active{ transform: scale(0.98); }

.icon-btn-mini{
  border: 1px solid var(--border);
  background: rgba(255,255,255,0.06);
  color: var(--text);
  padding: 6px 10px;
  border-radius: 10px;
  font-weight: 900;
  cursor: pointer;
}
body.dark .icon-btn-mini{ background: rgba(255,255,255,0.04); }
.icon-btn-mini:active{ transform: scale(0.98); }
.icon-btn-mini.danger{
  border-color: rgba(255,59,48,0.35);
  color: #ff3b30;
}
.hw-all-actions{
  display:flex;
  align-items:center;
  gap:5px;
}

.hw-admin-actions .btn{ flex:1; display:flex; align-items:center; justify-content:center; gap:6px; padding:8px 10px; min-height:36px; line-height:1; }
.hw-admin-actions .btn i{ font-size:1.05em; }


.bulk-list{
  width:100%;
  margin-top:10px;
  max-height: 420px;
  overflow:auto;
  border: 0;
  border-radius: 0;
  background: transparent;
}
body.dark .bulk-list{
  background: transparent;
}
.bulk-row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:6px 8px;
  border-bottom: 1px solid var(--border);
}
.bulk-row:last-child{ border-bottom:none; }
.bulk-row .bulk-left{
  display:flex;
  align-items:center;
  gap:8px;
  min-width:0;
}
.bulk-row .bulk-name{
  font-weight:800;
  font-size:0.95rem;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.bulk-row .bulk-meta{
  font-size:0.75rem;
  color: var(--text-sec);
  margin-top:1px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.bulk-empty{
  padding:12px;
  color: var(--text-sec);
  font-size:0.85rem;
  text-align:center;
}


.hw-top-actions{
  width:100%;
  display:flex;
  gap:10px;
  margin: 8px 0 10px 0;
}
.hw-top-actions .btn{ flex:1; }

.bulk-list-open{
  max-height: 55vh;
  overflow:auto;
}
.hw-all-panel{
  width:100%;
  padding:8px 10px;
  border-bottom: 1px solid var(--border);
}
.hw-all-item{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:10px;
  padding:6px 0;
  border-top:1px solid var(--border);
}
.hw-all-item:first-child{ border-top:0; }
.hw-all-item .hw-all-left{ min-width:0; flex:1; }
.hw-all-item .hw-all-title{ font-weight:800; }
.hw-all-item .hw-all-sub{ font-size:0.75rem; color:var(--text-sec); margin-top:2px; }
.hw-all-item .hw-all-actions{
  display:flex;
  flex-direction:column;
  gap:5px;
  align-items:flex-end;
  flex:0 0 auto;
}
.hw-mini-toggle{
  display:flex;
  align-items:center;
  gap:5px;
  font-size:0.85rem;
  color: var(--text);
  user-select:none;
}
.hw-mini-toggle input{ transform: scale(1.05); }
.hw-expand-btn{
  border:0;
  background:transparent;
  color: var(--text);
  font-weight:900;
  font-size:1rem;
  padding:6px 8px;
  border-radius:10px;
}
.hw-expand-btn:active{ transform: scale(0.98); }


/* Shared filter summary for Aufgaben (uses same filter as Schüler) */
.hw-filter-summary{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  width:100%;
  margin-top:6px;
}
.hw-filter-summary .btn{
  width:auto;
  padding:8px 10px;
  white-space:nowrap;
}

/* Homework admin header alignment */
#tab-homework-admin .p-4{ padding-top:12px; }
.hw-admin-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin:0 0 10px 0;
}
#btn-hw-back-assign{ padding:6px 8px; font-size:0.82rem; white-space:nowrap; }
#btn-hw-back-assign .back-ico{ font-size:0.9em; }

.hw-admin-header h3{ margin:0 !important; font-size:16px; }
#tab-homework-admin h4{ font-size:14px; }
#tab-homework-admin .section-title{ font-size:14px; }
#tab-homework-admin .hw-filter-summary{ margin:0 0 5px 0; }
</style>
</head>
<body>

<div id="login-overlay">
  <div style="position: absolute; top: 20px; right: 20px;">
    <button class="icon-btn" onclick="toggleDarkMode()">
      <i id="dark-mode-icon" class="fa-solid fa-moon"></i>
    </button>
  </div>

  <div class="login-box">
  <div class="login-brand">
    <img src="https://drive.google.com/thumbnail?id=1PnvFFWtTcnNiMCNIZuBsAjaz3cV4-Lbw&sz=w200-h200"
         alt="Logo"
         class="login-logo">
    <div class="login-brand-text">
      <h2 id="lbl-login-title">Anmelden</h2>
      <div class="login-sub" id="lbl-login-sub">Lehrer / Schüler / Admin</div>
    </div>
  </div>

  <div class="login-form">
    <div class="login-badge" id="login-badge">Lehrer / Schüler / Admin</div>

    <!-- Saved profiles (Netflix-like quick login) -->
    <div id="saved-profiles" class="saved-profiles hidden">
      <div class="saved-profiles-title" id="lbl-saved-profiles">Schnellstart</div>
      <div id="saved-profiles-list" class="saved-profiles-list"></div>
      <div class="saved-profiles-hint" id="lbl-saved-profiles-hint">Tippe auf ein Profil, um dich schneller anzumelden.</div>
    </div>

    
    <div class="form-group" style="margin-top:10px;">
      <label class="form-label" id="lbl-login-id">Benutzername / Student ID</label>

      <!-- Username input with inline dropdown (saved profiles) -->
      <div class="input-dd" id="login-identifier-wrap">
        <input type="text" id="login-identifier" class="login-text" inputmode="text" autocapitalize="none" spellcheck="false"
               placeholder="Benutzername أو Student ID" autocomplete="username">

        <button type="button" class="dd-btn" id="btn-id-dropdown" aria-label="Open saved profiles">
          <i class="fa-solid fa-chevron-down"></i>
        </button>

        <div class="dd-panel hidden" id="id-dropdown-panel" role="listbox" aria-label="Saved profiles"></div>
      </div>
    </div>


    <div class="form-group" style="margin-top:10px;">
      <label class="form-label" id="lbl-login-pin">PIN</label>
      <input type="password" id="login-pin" class="login-text login-pin" placeholder="PIN / الرقم السري" inputmode="numeric" autocomplete="current-password">
    </div>

    <div class="login-help" id="login-help">اكتب اسم المستخدم للمعلم/الإدارة أو Student ID للطالب ثم أدخل الرقم السري.</div>
  </div>

  <label class="login-remember">
    <input type="checkbox" id="chk-remember" />
    <span id="lbl-remember">Angemeldet bleiben</span>
  </label>

  <button class="btn" onclick="doLogin()" id="lbl-login-btn">Einloggen</button>
  <p id="login-error" class="login-error"></p>
</div></div>
</div>

<!-- Login Loading Overlay -->
<div id="login-loading-overlay" class="hidden" aria-hidden="true">
  <div class="login-loading-card">
    <div class="loader" aria-label="Loading"></div>
    <div class="login-loading-text" id="login-loading-text">جارٍ التحقق...</div>
    <div class="login-loading-sub" id="login-loading-sub">Bitte warten…</div>
  </div>
</div>

<div id="qs-app-root" class="hidden">
  <!-- Floating Audio Player -->
  <div id="floating-audio-player" class="floating-audio-player">
    <div class="floating-audio-header">
      <div class="floating-audio-title" id="floating-audio-title">Keine Audio-Wiedergabe</div>
      <button class="floating-audio-close" onclick="hideFloatingAudio()"><i class="fa-solid fa-xmark"></i></button>
    </div>
    
    <div class="floating-audio-progress">
      <div id="floating-audio-progress-fill" class="floating-audio-progress-fill"></div>
    </div>
    
    <div class="floating-audio-controls">
      <button class="audio-btn sec" onclick="previousAyah()" id="btn-prev-ayah">◀</button>
      <button class="audio-btn" onclick="togglePlayPause()" id="btn-play-pause">▶</button>
      <button class="audio-btn sec" onclick="nextAyah()" id="btn-next-ayah">▶▶</button>
      <select id="floating-audio-repeat" class="form-select" style="width: auto; padding: 6px 8px; font-size: 0.8rem;">
        <option value="1">1×</option>
        <option value="2">2×</option>
        <option value="3">3×</option>
        <option value="5">5×</option>
        <option value="10">10×</option>
      </select>
    </div>
    
    <div class="floating-audio-info" id="floating-audio-info">Bereit</div>
  </div>

  <header class="app-header">
    <div class="logo-area">
      <img src="https://drive.google.com/thumbnail?id=1PnvFFWtTcnNiMCNIZuBsAjaz3cV4-Lbw&sz=w200-h200" class="logo-img" alt="Logo">
      <div class="logo-text">
        <div style="font-size:0.9rem; font-weight:bold;" id="hdr-title">Schülerverwaltung</div>
        <div style="font-size:0.7rem; color:var(--text-sec);" id="hdr-sync">Synchronisiere...</div>
        <div style="font-size:0.65rem; color:var(--primary);" id="hdr-user"></div>
      </div>
    </div>
    <div class="header-actions">
      <button class="icon-btn" onclick="refreshData()" style="color: var(--primary);">
        <i class="fa-solid fa-arrows-rotate"></i>
      </button>

      <button class="icon-btn" onclick="toggleLang()" style="color: var(--primary);">
        <i class="fa-solid fa-globe"></i>
      </button>
      <button class="icon-btn" onclick="toggleFilter()" style="color: var(--primary);" id="btn-filter">
        <i class="fa-solid fa-sliders"></i>
      </button>
      <button class="icon-btn cloud-ok" id="btn-cloud" onclick="openSyncIssues()" title="Gespeichert / تم الحفظ">
        <i id="cloud-icon" class="fa-solid fa-cloud"></i>
        <span class="badge hidden" id="badge-cloud">!</span>
      </button>


      <button class="icon-btn" id="btn-logout" onclick="doLogout()" title="Logout / تسجيل الخروج" style="color: var(--danger);">
        <i class="fa-solid fa-right-from-bracket"></i>
      </button>

      <button class="icon-btn hidden" id="btn-add-student" onclick="openAddStudent()">
        <i class="fa-solid fa-user-plus"></i>
      </button>
    </div>
  </header>

  <div id="filter-panel">
    <div class="p-4">
      <input type="text" id="search-input" class="search-bar" placeholder="Suchen..." oninput="handleSearchInput()">
      <div id="student-count-result" class="text-sm font-bold" style="margin-top: 5px; color: var(--primary);"></div>
      <div style="margin-top:10px; font-size:0.8rem; color:var(--text-sec);" id="lbl-groups">Gruppen</div>
      <div class="chips-container" id="group-chips"></div>
      <div style="margin-top:10px; font-size:0.8rem; color:var(--text-sec);" id="lbl-days">Tage</div>
      <div class="chips-container" id="day-chips"></div>
      <div class="filter-checkbox-group hidden" id="admin-filters">
         <label class="filter-checkbox"><input type="checkbox" id="chk-fin-prob" onchange="updateFilterState()"><span id="lbl-fin-prob">Mahnwesen</span></label>
         <label class="filter-checkbox"><input type="checkbox" id="chk-abgemeldet" onchange="updateFilterState()"><span id="lbl-abgemeldet">Abgemeldet anzeigen</span></label>
      </div>
      <div id="capacity-warning" class="hidden" style="margin-top:10px; color:var(--danger); font-size:0.8rem;">⚠ <span id="lbl-cap-warn">Gruppe voll</span></div>
    </div>
  </div>

  <main id="tab-students">
    <div id="students-list"></div>
    <div id="fab-attendance" class="fab-container">
        <button class="fab-btn" onclick="submitBatchAttendance()">
            <i class="fa-solid fa-paper-plane"></i>
            <span id="lbl-send-btn">Senden</span>
        </button>
    </div>
  </main>

  
<main id="tab-student-home" class="hidden">
  <div class="p-4">
    <div style="display:flex; align-items:center; justify-content:flex-start; gap:10px;">
      <h3 id="stu-home-title" style="margin:0;">Home</h3>
</div>

        <div style="margin-top:12px; display:flex; flex-direction:column; gap:8px;" id="student-home-alerts"></div>
        <div id="student-home-achievements" style="margin-top:14px; display:flex; flex-direction:column; gap:8px;"></div>
  </div>
</main>

<main id="tab-student-homework" class="hidden">
  <div class="p-4">
    <h3 id="stu-hw-title">Meine Hausaufgaben</h3>
    <div id="student-homework-list" style="display:flex; flex-direction:column; gap:6px;"></div>
  </div>
</main>

<main id="tab-student-memorize" class="hidden">
  <div class="p-4">
    <h3 id="stu-mem-title">Auswendiglernen</h3>
    <input type="text" id="surah-search" class="search-bar" placeholder="Sure suchen..." oninput="renderSurahList()" style="margin-top:10px;">
    <div id="surah-list" style="margin-top:12px; display:flex; flex-direction:column; gap:6px;"></div>
  </div>
</main>

<main id="tab-student-rating" class="hidden">
  <div class="p-4">
    <h3 id="stu-akte-title">Akte</h3>

    <!-- Section: Evaluations -->
    <div class="card flex-col" style="align-items:flex-start; cursor:pointer; margin-bottom:10px;" onclick="openStudentAkteEval()">
      <div style="width:100%; display:flex; align-items:center; justify-content:space-between; gap:12px;">
        <div>
          <div style="font-weight:bold;" id="akte-eval-head">Bewertung</div>
          <div class="text-sm text-sec" id="akte-eval-sub" style="margin-top:4px;">Durchschnitt</div>
        </div>
        <div style="text-align:right;">
          <div id="akte-eval-stars" style="font-size:1.4rem; line-height:1.6rem;">—</div>
          <div class="text-sm text-sec" id="akte-eval-grade" style="margin-top:2px;">—</div>
        </div>
      </div>
    </div>

    <!-- Section: Attendance (late/absent) -->
    <div class="card flex-col" style="align-items:flex-start; cursor:pointer;" onclick="openStudentAkteAttendance()">
      <div style="width:100%; display:flex; align-items:center; justify-content:space-between; gap:12px;">
        <div>
          <div style="font-weight:bold;" id="akte-att-head">Anwesenheit</div>
          <div class="text-sm text-sec" id="akte-att-sub" style="margin-top:4px;">Verspätungen & Fehlzeiten</div>
        </div>
        <div style="text-align:right; line-height:1.4;">
          <div class="text-sm" style="font-weight:800; color:var(--warning);"><span id="akte-att-late-count">0</span> <span id="akte-att-late-label">Verspätungen</span></div>
          <div class="text-sm" style="font-weight:800; color:var(--danger);"><span id="akte-att-abs-count">0</span> <span id="akte-att-abs-label">Fehlzeiten</span></div>
        </div>
      </div>
    </div>

    
    <!-- Section: Fortschritt (auswendig bestätigt) -->
    <div class="card flex-col" style="align-items:flex-start; cursor:pointer; margin-top:10px;" onclick="openStudentAkteProgress()">
      <div style="width:100%; display:flex; align-items:center; justify-content:space-between; gap:12px;">
        <div>
          <div style="font-weight:bold;" id="akte-prog-head">Fortschritt</div>
          <div class="text-sm text-sec" id="akte-prog-sub" style="margin-top:4px;">Auswendig gelernte Verse</div>
        </div>
        <div style="text-align:right;">
          <div id="akte-prog-sum" class="prog-inline" style="font-size:1.1rem; font-weight:900; line-height:1.6rem;; white-space:normal;">—</div>
          <div class="text-sm text-sec" id="akte-prog-last" style="margin-top:2px;">—</div>
        </div>
      </div>
    </div>

<!-- Legacy container kept hidden (in case any code still targets it) -->
    <div id="student-eval-list" class="hidden"></div>
  </div>
</main>

<main id="tab-student-parent" class="hidden">
  <div class="p-4">
    <h3 id="stu-parent-title">Elterninfo</h3>
    <div class="card flex-col" style="align-items:flex-start;">
      <div style="font-weight:bold;" id="stu-parent-head">Abmeldung für heute</div>
      <div class="text-sm text-sec" id="stu-parent-hint" style="margin-top:6px;">
        Wenn Ihr Kind heute nicht kommt, aktivieren Sie bitte diese Option. Der Lehrer sieht dann eine Markierung beim Namen.
      </div>
      <label class="filter-checkbox" style="margin-top:12px; width:100%; justify-content:flex-start;">
        <input type="checkbox" id="chk-parent-absent" onchange="toggleParentAbsentUI()" />
        <span id="stu-parent-label">Mein Kind ist heute abwesend</span>
      </label>

      <div id="parent-absent-extra" class="hidden" style="width:100%; margin-top:12px;">
        <textarea id="parent-absent-reason" class="form-textarea" rows="3" placeholder="سبب الغياب / Grund..."></textarea>

        <label class="filter-checkbox" style="margin-top:5px; width:100%; justify-content:flex-start;">
          <input type="checkbox" id="chk-parent-cert" />
          <span>شهادة طبية / Attest vorhanden</span>
        </label>
        <button class="btn" style="margin-top:12px; width:100%;" onclick="submitParentAbsent()" id="btn-parent-absent-send">Senden</button>
      </div>

      <div class="text-sm text-sec" id="stu-parent-status" style="margin-top:10px;"></div>
    </div>
    <div class="card flex-col" style="align-items:flex-start; margin-top:10px;">
      <div style="font-weight:bold;" id="stu-notif-head">Benachrichtigungen</div>
      <div class="text-sm text-sec" id="stu-notif-hint" style="margin-top:6px;">
        Aktivieren Sie Benachrichtigungen für neue Hausaufgaben / Notizen (solange die Seite geöffnet ist).
      </div>
      <label class="filter-checkbox" style="margin-top:12px; width:100%; justify-content:flex-start;">
        <input type="checkbox" id="chk-stu-notif" onchange="toggleStudentNotifications()" />
        <span id="stu-notif-label">Bei neuen Einträgen benachrichtigen</span>
      </label>
      <div class="text-sm text-sec" id="stu-notif-status" style="margin-top:10px;"></div>
    </div>

    <div class="card flex-col" style="align-items:flex-start; margin-top:10px;">
      <div style="font-weight:bold;" id="stu-pin-head">PIN ändern</div>
      <div class="text-sm text-sec" id="stu-pin-hint" style="margin-top:6px;">
        Ändern Sie die PIN dieses Schülers. Bitte bewahren Sie die neue PIN sicher auf.
      </div>

      <div style="width:100%; margin-top:10px;">
        <div class="form-group">
          <label class="form-label" id="lbl-stu-old-pin">Alte PIN</label>
          <input type="password" id="stu-old-pin" class="form-input" inputmode="numeric" autocomplete="current-password" placeholder="••••">
        </div>
        <div class="form-group">
          <label class="form-label" id="lbl-stu-new-pin">Neue PIN</label>
          <input type="password" id="stu-new-pin" class="form-input" inputmode="numeric" autocomplete="new-password" placeholder="••••">
        </div>
        <div class="form-group">
          <label class="form-label" id="lbl-stu-new-pin2">Neue PIN bestätigen</label>
          <input type="password" id="stu-new-pin2" class="form-input" inputmode="numeric" autocomplete="new-password" placeholder="••••">
        </div>
        <button class="btn" onclick="changeStudentPin()" id="btn-stu-pin-save" style="width:100%;">Speichern</button>
        <div class="text-sm text-sec" id="stu-pin-status" style="margin-top:10px;"></div>
      </div>
    </div>


  </div>
</main>


  <main id="tab-comm" class="hidden">
    <div class="p-4" style="background:var(--surface); border-radius:12px; margin-bottom:1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
      <h4 style="margin:0 0 10px 0;" id="lbl-send-msg">Nachricht senden</h4>
      <select id="msg-dest-type" class="form-select" onchange="toggleMsgRecipient()">
        <option value="Lehrer">Lehrer</option>
        <option value="Admin">Admin</option>
      </select>
      <div id="msg-dest-wrapper">
          <div class="text-sm text-sec" style="margin-top: 8px;">Lehrer auswählen:</div>
          <div id="teacher-checklist" class="checkbox-list"></div>
      </div>
      <textarea id="msg-body" class="form-textarea" rows="3" style="margin-top:5px;" placeholder="..."></textarea>
<button class="btn" style="margin-top:10px;" onclick="sendTeacherMessage()" id="btn-send">Senden</button>

      <label class="filter-checkbox" style="margin-top:12px; width:100%; justify-content:flex-start;">
        <input type="checkbox" id="chk-msg-notif" onchange="toggleMessageNotifications()" />
        <span id="lbl-msg-notif">Benachrichtigungen für neue Nachrichten</span>
      </label>
      <div class="text-sm text-sec" id="msg-notif-status" style="margin-top:8px;"></div>
    </div>
    <div id="messages-list"></div>
  </main>

  <main id="tab-homework-admin" class="hidden">
  <div class="p-4">
    <div class="hw-admin-header" id="hw-admin-assign-header">
      <h3 id="hw-admin-title">Hausaufgaben zuweisen</h3>
      <button class="btn btn-sec" type="button" id="btn-hw-go-all" onclick="openAllHomeworkAdmin()"><i class="fa-solid fa-rectangle-list"></i> <span id="txt-hw-go-all">Übersicht</span></button>
    </div>

    <div id="hw-admin-assign-view">


    <div class="card flex-col hw-admin-card" style="align-items:flex-start;">
      <div class="hw-filter-summary" id="hw-filter-summary-assign">
  <div class="text-sm text-sec" id="hw-filter-summary-assign-text"></div>
</div>
<label class="filter-checkbox" style="margin-top:5px; width:100%; justify-content:flex-start;">
        <input type="checkbox" id="hw-bulk-selectall" onchange="toggleBulkHomeworkSelectAll(this.checked)" />
        <span><span id="hw-bulk-selectall-label">Alle auswählen</span> • <b id="hw-bulk-count">0</b></span>
      </label>

      <div id="hw-bulk-students" class="bulk-list"></div>

      <div class="hw-type-row" style="margin-top:12px;">
        <label class="hw-type"><input type="radio" name="hw-type-bulk" value="memorized" checked onchange="toggleBulkHomeworkTypeUI()"> <span id="hw-bulk-type-mem">Auswendig (Von–Bis)</span></label>
        <label class="hw-type"><input type="radio" name="hw-type-bulk" value="text" onchange="toggleBulkHomeworkTypeUI()"> <span id="hw-bulk-type-text">Freier Text</span></label>
      </div>

      <div id="hw-bulk-verses-fields" style="width:100%; margin-top:10px;">
        <div class="form-group" style="margin:0;">
          <label class="form-label">Sure</label>
          <input type="text" id="hw-bulk-surah" class="form-input" placeholder="z.B. 1 oder Al-Fatiha">
          <div id="hw-bulk-surah-dd" class="card hidden" style="margin-top:6px; padding:8px; max-height:180px; overflow:auto;"></div>
        </div>
        <div class="hw-admin-grid" style="margin-top:10px;">
          <div class="form-group" style="margin:0;">
            <label class="form-label">Von (Ayah)</label>
            <input type="number" id="hw-bulk-start" class="form-input" inputmode="numeric">
          </div>
          <div class="form-group" style="margin:0;">
            <label class="form-label">Bis (Ayah)</label>
            <input type="number" id="hw-bulk-end" class="form-input" inputmode="numeric">
          </div>
        </div>
      </div>

      <div id="hw-bulk-text-fields" class="hidden" style="width:100%; margin-top:10px;">
        <div class="form-group" style="margin:0;">
          <label class="form-label" id="hw-bulk-text-label">Freier Text</label>
          <textarea id="hw-bulk-free-text" class="form-textarea" rows="3" placeholder="اكتب المطلوب من الطلاب..."></textarea>
        </div>
      </div>

      <button class="btn" style="margin-top:12px; width:100%;" onclick="bulkAssignHomework()" id="btn-hw-assign">Hausaufgabe senden</button>
      <div class="text-sm text-sec" id="hw-bulk-status" style="margin-top:10px;"></div>
    </div>

    </div> <!-- /#hw-admin-assign-view -->

    <div id="hw-admin-all-view" class="hidden">
      <div class="hw-admin-header">
        <button class="btn btn-sec" type="button" id="btn-hw-back-assign" onclick="openAssignHomeworkAdmin()"><i class="fa-solid fa-chevron-left back-ico"></i> <span id="txt-hw-back">Zurück</span></button>
        <h3 id="hw-all-title" style="margin:0;">Alle Hausaufgaben</h3>
      </div>

      <div class="card flex-col" style="align-items:flex-start;">
        <div class="hw-filter-summary" id="hw-filter-summary-all">
  <div class="text-sm text-sec" id="hw-filter-summary-all-text"></div>
</div>
<div class="hw-admin-actions hw-admin-actions-wide" style="margin-top:5px;">
          <select id="hw-all-hw-select" class="form-select" style="flex:1; min-width:220px;" onchange="/* selection only */"></select>
          <button class="btn btn-sec" type="button" id="btn-hw-all-confirm-selected" onclick="bulkConfirmSelectedHomework(true)"><i class="fa-solid fa-circle-check"></i> <span id="txt-hw-all-confirm">Bestätigen</span></button>
          <button class="btn btn-sec" type="button" id="btn-hw-all-unconfirm-selected" onclick="bulkConfirmSelectedHomework(false)"><i class="fa-solid fa-circle-xmark"></i> <span id="txt-hw-all-unconfirm">Bestätigung entfernen</span></button>
          <button class="btn btn-danger" type="button" id="btn-hw-all-delete-selected" onclick="bulkDeleteSelectedHomework()"><i class="fa-solid fa-trash"></i> <span id="txt-hw-all-delete">Löschen</span></button>
        </div>


        <label class="filter-checkbox" style="margin-top:5px; width:100%; justify-content:flex-start;">
          <input type="checkbox" id="hw-all-selectall" onchange="toggleAllHomeworkSelectAll(this.checked)" />
          <span><span id="hw-all-selectall-label">Alle auswählen</span> • <b id="hw-all-count">0</b></span>
        </label>

        <div id="hw-all-students" class="bulk-list bulk-list-open"></div>

        <div class="text-sm text-sec" id="hw-all-status" style="margin-top:10px;"></div>
      </div>
    </div>

  </div>
</main>
<div id="hw-bulk-progress">
  <div class="progress-box">
    <h3 id="hw-bulk-progress-title" style="margin:0 0 10px 0;">Sende...</h3>
    <div class="progress-bar-track"><div id="hw-bulk-progress-fill" class="progress-bar-fill" style="width:0%"></div></div>
    <p id="hw-bulk-progress-text" class="progress-text">0/0</p>
  </div>
</div>


  <main id="tab-stats" class="hidden">
    <div class="p-4">
      <h3 id="lbl-stats-title">Statistiken</h3>
<div class="stats-mini-row">
        <div class="card flex-col"><div class="text-sec" id="lbl-present-today">Anwesend heute</div><div class="font-bold" style="font-size:2rem; color:var(--success);" id="stat-present-today">0</div></div>
        <div class="card flex-col"><div class="text-sec" id="lbl-absent-today">Abwesend heute</div><div class="font-bold" style="font-size:2rem; color:var(--danger);" id="stat-absent-today">0</div></div>
        <div class="card flex-col"><div class="text-sec" id="lbl-late-today">Verspätet heute</div><div class="font-bold" style="font-size:2rem; color:var(--warning);" id="stat-late-today">0</div></div>
      </div>
      <div id="stats-groups"></div>
    </div>
  </main>

  <main id="tab-docs" class="hidden">
    <div class="p-4">
      <h3 id="lbl-docs-title">Dokumente</h3>
      <input type="text" id="doc-search-input" class="search-bar" placeholder="Dokumente suchen..." style="margin-top:10px;" oninput="renderDocuments()">
      <div id="docs-list" style="margin-top:1rem; display:flex; flex-direction:column; gap:10px;"></div>
    </div>
  </main>

  <main id="tab-users" class="hidden">
    <div class="p-4">
      <h3 id="lbl-manage-users">إدارة المستخدمين</h3>
      <div id="users-list-container" style="display:flex; flex-direction:column; gap:10px; margin-top:1rem; padding-bottom: 80px;"></div>
      <button class="fab-user-add" onclick="openAddUser()">
        <i class="fa-solid fa-plus"></i>
      </button>
    </div>
  </main>

  <nav class="bottom-nav">
    <button class="nav-item hidden" onclick="switchTab('users')" id="nav-users"><i class="fa-solid fa-users"></i><span id="lbl-nav-users">User</span></button>
    <button class="nav-item active" onclick="switchTab('students')" id="nav-students"><i class="fa-solid fa-user-graduate"></i><span id="lbl-nav-stud">Schüler</span></button>
    
    
<button class="nav-item hidden" onclick="switchTab('student-home')" id="nav-stu-home">
  <i class="fa-solid fa-house"></i>
  <span id="lbl-nav-stu-home">Home</span>
  <span class="dot-badge hidden" id="badge-stu-home"></span>
</button>

<button class="nav-item hidden" onclick="switchTab('student-homework')" id="nav-stu-hw">
  <i class="fa-solid fa-clipboard"></i>
  <span id="lbl-nav-stu-hw">Aufgaben</span>
  <span class="dot-badge hidden" id="badge-stu-hw"></span>
</button>

<button class="nav-item hidden" onclick="switchTab('student-memorize')" id="nav-stu-mem">
  <i class="fa-solid fa-book-open"></i>
  <span id="lbl-nav-stu-mem">Koran</span>
</button>

<button class="nav-item hidden" onclick="switchTab('student-rating')" id="nav-stu-rate">
  <i class="fa-solid fa-star"></i>
  <span id="lbl-nav-stu-rate">Akte</span>
  <span class="dot-badge hidden" id="badge-stu-rate"></span>
</button>

<button class="nav-item hidden" onclick="switchTab('student-parent')" id="nav-stu-parent">
  <i class="fa-solid fa-user"></i>
  <span id="lbl-nav-stu-parent">Eltern</span>
</button><button class="nav-item" onclick="switchTab('homework-admin')" id="nav-homework-admin">
  <i class="fa-solid fa-clipboard"></i>
  <span id="lbl-nav-hw">Aufgaben</span>
</button>



    <button class="nav-item" onclick="switchTab('comm')" id="nav-comm"><i class="fa-solid fa-comments"></i>
  <span id="lbl-nav-comm">Komm.</span><span id="badge-msg-nav" class="badge hidden" style="top:0; right:10px;"></span></button>
    <button class="nav-item" onclick="switchTab('stats')" id="nav-stats"><i class="fa-solid fa-chart-line"></i>
  <span id="lbl-nav-stats">Statistik</span></button>
    <button class="nav-item" onclick="switchTab('docs')" id="nav-docs"><i class="fa-solid fa-file-lines"></i>
  <span id="lbl-nav-docs">Doku</span></button>
  </nav>
</div>



<div id="progress-overlay">
    <div class="progress-box">
        <h3 id="progress-title" style="margin:0 0 10px 0;">Sende Daten...</h3>
        <div class="progress-bar-track"><div id="progress-fill" class="progress-bar-fill"></div></div>
        <p id="progress-text" class="progress-text">0/0</p>
        <p id="success-msg" class="success-msg"><i class="fa-solid fa-circle-check"></i> Daten erfolgreich übertragen!</p>
    </div>
</div>

<div class="modal-overlay" id="detail-modal">
  <div class="modal-content">
    <button class="close-icon" onclick="closeModal('detail-modal')"><i class="fa-solid fa-xmark"></i></button>
    <div class="detail-header">
      <div class="detail-avatar" id="det-avatar"></div>
      <h2 id="det-name" style="margin:0;"></h2>
      <p id="det-sub" class="text-sec" style="margin:5px 0;"></p>
      <div id="det-alert" class="hidden" style="background:var(--danger); color:var(--text); opacity:0.8; padding:8px; border-radius:8px; font-size:0.8rem; margin-top:10px;"></div>
    </div>
    
    <div class="tab-controls">
        <div class="tab-ctrl active" onclick="switchDetailTab('info')" id="dt-info">Info</div>
        <div class="tab-ctrl" onclick="switchDetailTab('attendance')" id="dt-attendance">Attend.</div>
        <div class="tab-ctrl" onclick="switchDetailTab('curriculum')" id="dt-curriculum">Quran</div>
        <div class="tab-ctrl" onclick="switchDetailTab('eval')" id="dt-eval">Bewertung</div>
    </div>

    <div id="dview-info">
        <div class="detail-grid" id="det-grid"></div>
        <div class="notes-section">
            <h4 id="lbl-student-notes" style="margin-top:0; margin-bottom:10px;">Lehrer Notizen</h4>
            <div id="notes-list" class="notes-list"></div>
            <textarea id="new-student-note" class="form-textarea" rows="2" placeholder="..."></textarea>
            <button class="btn" onclick="saveStudentNote()" style="margin-top:5px;" id="btn-save-note">Notiz hinzufügen</button>
        </div>
        <div style="margin-top:2rem; display:flex; gap:10px;">
          <button class="btn btn-sec" onclick="printStudent()" id="btn-print-stud">Drucken</button>
          <button class="btn hidden" id="btn-edit-stud" onclick="openEditStudent()">Bearbeiten</button>
        </div>
    </div>

    <div id="dview-attendance" class="hidden">
        <div id="det-attendance-list"></div>
    </div>

    <div id="dview-curriculum" class="hidden">
        <h4 style="margin-bottom:10px;">Neuer Auftrag (Hausaufgabe)</h4>

        <div class="form-group">
          <label class="form-label">Aufgabe-Typ • نوع الواجب</label>
          <div class="hw-type-row">
            <label class="hw-type"><input type="radio" name="hw-type" value="memorized" checked onchange="toggleHomeworkTypeUI()"> حفظ من الآية… إلى الآية… / Auswendig (Von–Bis)</label>
            <label class="hw-type"><input type="radio" name="hw-type" value="text" onchange="toggleHomeworkTypeUI()"> نص حر / Freier Text</label>
          </div>
        </div>

        <div id="hw-verses-fields">
          <div class="form-group">
              <label class="form-label">Sure (Name/Nr)</label>
              <input type="text" id="hw-surah" class="form-input" placeholder="z.B. Al-Fatiha">
              <div id="hw-surah-dd" class="card hidden" style="margin-top:6px; padding:8px; max-height:180px; overflow:auto;"></div>
          </div>
          <div class="flex gap-2">
              <div class="form-group w-full">
                  <label class="form-label">Von Vers</label>
                  <input type="number" id="hw-start" class="form-input">
              </div>
              <div class="form-group w-full">
                  <label class="form-label">Bis Vers</label>
                  <input type="number" id="hw-end" class="form-input">
              </div>
          </div>
        </div>

        <div id="hw-text-fields" class="hidden">
          <div class="form-group">
            <label class="form-label">Text • نص الواجب</label>
            <textarea id="hw-free-text" class="form-textarea" rows="3" placeholder="اكتب المطلوب من الطالب..."></textarea>
          </div>
        </div>

        <button class="btn" onclick="assignHomework()" id="btn-hw-save">Speichern</button>
        <hr style="margin:20px 0; border:0; border-top:1px solid var(--border);">
        <h4>Verlauf</h4>
        <div id="hw-history-list" class="text-sm text-sec">Wird geladen...</div>
    </div>

    <div id="dview-eval" class="hidden">
         <h4 style="margin-bottom:10px;">Neue Bewertung</h4>
         <div class="form-group">
             <label class="form-label">Hifz (Hafiz)</label>
             <select id="eval-hifz" class="form-select">
                 <option value="">—</option>
                 <option value="Sehr Gut">Sehr Gut (ممتاز)</option>
                 <option value="Gut">Gut (جيد)</option>
                 <option value="Mittel">Mittel (متوسط)</option>
                 <option value="Schwach">Schwach (ضعيف)</option>
             </select>
         </div>
         <div class="form-group">
             <label class="form-label">Tajweed</label>
             <select id="eval-tajweed" class="form-select">
                 <option value="">—</option>
                 <option value="Sehr Gut">Sehr Gut</option>
                 <option value="Gut">Gut</option>
                 <option value="Mittel">Mittel</option>
             </select>
         </div>
         <div class="form-group">
             <label class="form-label">Verhalten</label>
             <select id="eval-behavior" class="form-select">
                 <option value="">—</option>
                 <option value="Vorbildlich">Vorbildlich</option>
                 <option value="Gut">Gut</option>
                 <option value="Störend">Störend</option>
             </select>
         </div>
         <div class="form-group">
             <label class="form-label">Notiz für Eltern</label>
             <textarea id="eval-note" class="form-textarea" rows="2"></textarea>
         </div>
         <div class="form-group" style="margin-top:10px;">
             <label class="form-label" style="display:flex; align-items:center; justify-content:space-between;">
               <span id="lbl-eval-note-only">Nur Notiz (ohne Bewertung) • ملاحظة فقط</span>
               <input type="checkbox" id="eval-note-only" onchange="toggleEvalNoteOnly()">
             </label>
             <div class="chips-container" style="margin-top:8px; justify-content:flex-start;">
               <button class="chip" onclick="applyEvalNoteTemplate('Keine Hausaufgaben dabei / لا يوجد واجبات', true)"><i class="fa-solid fa-thumbtack"></i> Keine Hausaufgaben</button>
               <button class="chip" onclick="applyEvalNoteTemplate('Hat seine Sachen nicht dabei / لم يحضر أدواته', true)">🧰 Keine Sachen</button>
               <button class="chip" onclick="applyEvalNoteTemplate('Bitte mit dem Lehrer sprechen / يرجى التواصل مع المعلم', true)">📞 Kontakt</button>
             </div>
         </div>
         <div class="flex gap-2" style="margin-top:8px;">
           <button class="btn w-full" onclick="submitEvaluation()">Bewertung Senden</button>
           <button class="btn btn-sec w-full" onclick="submitEvaluation({noteOnly:true})">Notiz senden</button>
         </div>
         <hr style="margin:20px 0; border:0; border-top:1px solid var(--border);">
         <h4>Historie</h4>
         <div id="eval-history-list" class="text-sm text-sec">Wird geladen...</div>
    </div>
  </div>
</div>

<div class="modal-overlay" id="edit-modal">
  <div class="modal-content">
    <button class="close-icon" onclick="closeModal('edit-modal')"><i class="fa-solid fa-xmark"></i></button>
    <h2 id="edit-title">Neuer Schüler</h2>
    <div id="last-id-display" style="text-align: center; color: var(--primary); font-weight: bold; margin-bottom: 10px; font-size: 0.9rem;"></div>
    <div id="edit-form"></div>
    <div class="flex gap-2" style="margin-top:1rem; flex-direction:column;">
      <div class="flex gap-2">
        <button class="btn" onclick="saveStudent()" id="btn-save-stud">Speichern</button>
        <button class="btn btn-sec" onclick="closeModal('edit-modal')" id="btn-cancel-stud">Abbrechen</button>
      </div>
      <button class="btn hidden" id="btn-delete-stud" style="background:var(--danger); margin-top:5px;" onclick="deleteStudent()">Schüler löschen</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="user-modal">
  <div class="modal-content">
    <button class="close-icon" onclick="closeModal('user-modal')"><i class="fa-solid fa-xmark"></i></button>
    <h2 id="lbl-user-modal-title">Benutzer</h2>
    <input type="hidden" id="user-edit-idx">
    <div class="form-group"><label class="form-label">Name</label><input type="text" id="new-user-name" class="form-input" placeholder="Name"></div>
    <div class="form-group"><label class="form-label">PIN</label><input type="text" id="new-user-pin" class="form-input" placeholder="PIN"></div>
    <div class="form-group"><label class="form-label">Rolle</label><select id="new-user-role" class="form-select"><option value="Lehrer">Lehrer (معلم)</option><option value="Admin">Admin (إدارة)</option></select></div>
    <div class="flex gap-2" style="margin-top:1rem;"><button class="btn" onclick="submitUser()" id="btn-save-user">Speichern</button></div>
  </div>
</div>


<div class="modal-overlay" id="lesson-modal">
  <div class="modal-content">
    <button class="close-icon" onclick="closeModal('lesson-modal')"><i class="fa-solid fa-xmark"></i></button>
    
    <!-- Search Bar for Quran -->
    <div class="quran-search-bar">
      <input type="text" id="lesson-search-input" class="quran-search-input" placeholder="سورة أو آية... / Sure oder Vers..." 
             onkeypress="if(event.key === 'Enter') searchInLesson()">
      <button class="quran-search-btn" onclick="searchInLesson()">بحث / Suche</button>
    </div>

    <!-- Surah Header -->
    <div id="surah-header" class="surah-header">
      <div class="surah-name-arabic" id="surah-name-arabic">الفاتحة</div>
      <div class="surah-name-latin" id="surah-name-latin">Al-Fātiha</div>
      <div class="surah-info">
        <span id="surah-number">الجزء 1</span>
        <span id="surah-verse-count">7 آيات</span>
      </div>
    </div>

    <div class="card" style="display:flex; flex-direction:column; gap:10px;">
      <div class="text-sm text-sec" id="lesson-hint">
        🎧 Play drücken • 📖 Bedeutung lesen
      </div>
      <audio id="lesson-audio" controls class="w-full" style="width:100%;"></audio>
      <div class="audio-row" style="flex-wrap:wrap; align-items:center; justify-content:space-between;">
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <span class="text-sm text-sec" id="lbl-repeat">Repeat</span>
          <select id="lesson-repeat-count" class="form-select" style="width:auto; padding:8px 10px;">
            <option value="1">1×</option>
            <option value="2">2×</option>
            <option value="3">3×</option>
            <option value="5">5×</option>
            <option value="10">10×</option>
          </select>
        </div>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button class="audio-btn" onclick="playAssignedRange()" id="btn-play-range">▶ Play Range</button>
          <button class="audio-btn sec" onclick="stopRangePlayback()" id="btn-stop-range">■ Stop</button>
        </div>
      </div>
    </div>

    <div style="margin-top: 10px;">
      <div class="lesson-view-toolbar">
        <button class="pill-btn" onclick="toggleLessonTranslation()" id="btn-toggle-translation">📝 ترجمة</button>
        <button class="pill-btn" onclick="adjustMushafFont(-1)" title="A−">A−</button>
        <button class="pill-btn" onclick="adjustMushafFont(1)" title="A+">A+</button>
      </div>

      <div id="lesson-verses"></div>
      <div id="lesson-translation" class="lesson-translation hidden"></div>
    </div>
  </div>
</div>


<!-- Student floating reader toggle (stays visible in student mode) -->
<button id="reader-toggle-fab" class="reader-fab hidden" onclick="toggleLessonFab()" aria-label="إخفاء/إظهار نافذة القراءة">
  <i id="reader-fab-icon" class="fa-solid fa-eye"></i>
</button>

<div id="print-container"></div>
<div id="toast">Gespeichert</div>

<!-- Quick Verse Sheet (Meaning / Phonetic) -->
<div id="quick-verse-sheet" class="quick-sheet-overlay" onclick="if(event.target.id==='quick-verse-sheet') hideQuickVerseSheet();">
  <div class="quick-sheet" role="dialog" aria-modal="true">
    <div class="quick-sheet-top">
      <div>
        <div class="quick-sheet-title" id="qvs-title">Vers</div>
        <div class="quick-sheet-sub" id="qvs-sub">Doppeltippen: Bedeutung • 4× Tippen: Phonetik</div>
      </div>
      <div class="quick-sheet-actions">
        <button class="quick-sheet-btn" id="qvs-copy" title="Kopieren" onclick="copyQuickVerseSheet()">⧉</button>
        <button class="quick-sheet-btn quick-sheet-close" title="Schließen" onclick="hideQuickVerseSheet()"><i class="fa-solid fa-xmark"></i></button>
      </div>
    </div>
    <div class="quick-sheet-ar" id="qvs-ar">—</div>
    <div class="quick-sheet-body" id="qvs-body">—</div>
  </div>
</div>


<script>
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycby4li-qZFJCx_0MoXEA6zV390FjD9A9k_-XyZMV2CH4V9CZyhDXjWbGgvdikZVvZoUj/exec'; 


// --- Optimistic UI + background Google Sheets sync (queue + retry) ---
const SYNC_QUEUE_KEY = 'pendingOps_v1';
const SYNC_FAILED_KEY = 'failedOps_v1';

let __pendingOps = [];
let __failedOps  = [];
let __syncProcessing = false;

function __loadQueues(){
  try{ __pendingOps = JSON.parse(localStorage.getItem(SYNC_QUEUE_KEY) || '[]') || []; }catch(e){ __pendingOps = []; }
  try{ __failedOps  = JSON.parse(localStorage.getItem(SYNC_FAILED_KEY) || '[]') || []; }catch(e){ __failedOps = []; }
}

function __saveQueues(){
  try{ localStorage.setItem(SYNC_QUEUE_KEY, JSON.stringify(__pendingOps)); }catch(e){}
  try{ localStorage.setItem(SYNC_FAILED_KEY, JSON.stringify(__failedOps)); }catch(e){}
  __updateCloudIcon();
}

function __updateCloudIcon(){
  const btn = document.getElementById('btn-cloud');
  const badge = document.getElementById('badge-cloud');
  if(!btn) return;

  // If not logged in yet, keep neutral
  if(!state || !state.user){
    btn.classList.remove('cloud-ok','cloud-pending','cloud-error');
    btn.classList.add('cloud-ok');
    btn.title = '—';
    if(badge) badge.classList.add('hidden');
    return;
  }

  const pending = __pendingOps.length;
  const failed  = __failedOps.length;

  btn.classList.remove('cloud-ok','cloud-pending','cloud-error');
  if(failed > 0){
    btn.classList.add('cloud-error');
    btn.title = (state.lang === 'de')
      ? `Nicht gespeichert (${failed}) – klicken für Details`
      : `غير محفوظ (${failed}) – اضغط للتفاصيل`;
    if(badge){
      badge.innerText = String(failed);
      badge.classList.remove('hidden');
    }
  } else if(pending > 0){
    btn.classList.add('cloud-pending');
    btn.title = (state.lang === 'de')
      ? `Speichere… (${pending})`
      : `جارٍ الإرسال… (${pending})`;
    if(badge) badge.classList.add('hidden');
  } else {
    btn.classList.add('cloud-ok');
    btn.title = (state.lang === 'de') ? 'Alles gespeichert' : 'تم حفظ كل شيء';
    if(badge) badge.classList.add('hidden');
  }
}

function enqueueSheetWrite(payload, meta = {}){
  __loadQueues();
  const op = {
    id: (crypto && crypto.randomUUID) ? crypto.randomUUID() : (Date.now() + '_' + Math.random().toString(16).slice(2)),
    createdAt: Date.now(),
    attempts: 0,
    maxAttempts: meta.maxAttempts || 4,
    payload: payload,
    label: meta.label || payload?.action || 'write'
  };
  __pendingOps.push(op);
  __saveQueues();
  __processQueue();
  return op.id;
}

async function __sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

async function __processQueue(){
  if(__syncProcessing) return;
  __loadQueues();
  if(!state || !state.user) { __updateCloudIcon(); return; }
  if(__pendingOps.length === 0) { __updateCloudIcon(); return; }

  __syncProcessing = true;
  try{
    while(__pendingOps.length > 0){
      __updateCloudIcon();
      const op = __pendingOps[0];

      try{
        const res = await fetch(WEB_APP_URL, {
          method:'POST',
          headers: { "Content-Type": "text/plain" },
          body: JSON.stringify(op.payload)
        }).then(r => r.json()).catch(()=>null);

        if(res && res.ok){
          __pendingOps.shift();
          __saveQueues();
          continue;
        }

        // Server replied with error or no JSON
        throw new Error((res && res.error) ? String(res.error) : 'no_response');
      }catch(err){
        op.attempts = (op.attempts || 0) + 1;
        __saveQueues();

        const backoff = [800, 1800, 4200, 9000, 15000][Math.min(op.attempts, 4)];
        if(op.attempts < (op.maxAttempts || 4)){
          // Retry after backoff (keep op in front)
          await __sleep(backoff);
          continue;
        }

        // Give up => move to failed list
        const failedOp = { ...op, failedAt: Date.now(), lastError: String(err && err.message ? err.message : err) };
        __failedOps.push(failedOp);
        __pendingOps.shift();
        __saveQueues();

        // Warn user to re-enter manually
        showToast(state.lang === 'de'
          ? `Nicht gespeichert: ${failedOp.label}. Bitte manuell erneut eingeben.`
          : `لم يتم الحفظ: ${failedOp.label}. يرجى إعادة إدخالها يدويًا.`);
      }
    }
  } finally {
    __syncProcessing = false;
    __updateCloudIcon();
  }
}

function openSyncIssues(){
  __loadQueues();
  __updateCloudIcon();

  if(!state || !state.user) return;

  if(__failedOps.length === 0){
    showToast(state.lang === 'de' ? 'Alles gespeichert.' : 'تم حفظ كل شيء.');
    return;
  }

  const titleEl = document.getElementById('sync-modal-title');
  const bodyEl  = document.getElementById('sync-modal-body');

  const lines = __failedOps.slice(-20).reverse().map(op=>{
    const dt = new Date(op.createdAt);
    const t = dt.toLocaleString('de-DE');
    return `• ${op.label} — ${t}`;
  });

  if(titleEl) titleEl.innerText = (state.lang === 'de') ? 'Nicht gespeicherte Änderungen' : 'تغييرات لم تُحفظ';
  if(bodyEl){
    bodyEl.innerText = (state.lang === 'de')
      ? `Fehlgeschlagene Änderungen (max. 20):\n\n${lines.join('\n')}\n\nBitte wiederhole diese Eingaben manuell.\n\nTipp: Du kannst unten "Wiederholen" drücken, wenn du gerade online bist.`
      : `التغييرات التي فشلت (حد أقصى 20):\n\n${lines.join('\n')}\n\nيرجى إعادة إدخالها يدويًا.\n\nملاحظة: يمكنك الضغط على "إعادة المحاولة" إذا عاد الاتصال.`;
  }

  openModal('sync-modal', {noHistory:true});
}

function retryFailedOps(){
  __loadQueues();
  if(__failedOps.length === 0){
    showToast(state.lang === 'de' ? 'Keine Warnungen.' : 'لا توجد تحذيرات.');
    return;
  }
  // move failed back to pending (keep order)
  __pendingOps = __pendingOps.concat(__failedOps.map(op=>{
    const copy = { ...op };
    delete copy.failedAt;
    copy.attempts = 0;
    return copy;
  }));
  __failedOps = [];
  __saveQueues();
  showToast(state.lang === 'de' ? 'Wiederhole Speichern...' : 'جارٍ إعادة المحاولة...');
  kickSyncQueue();
}

function clearFailedOps(){
  __loadQueues();
  __failedOps = [];
  __saveQueues();
  showToast(state.lang === 'de' ? 'Warnungen gelöscht.' : 'تم مسح التحذيرات.');
  closeModal('sync-modal');
}


// Call this after login or when app becomes active
function kickSyncQueue(){
  __loadQueues();
  __updateCloudIcon();
  __processQueue();
}
let state = {
  user: null,
  role: null,
  lang: 'de',
  darkMode: false,
  students: [],
  attendance: [],
  messages: [],
  teachers: [],
  allUsers: [],
  studentInfos: [],
  documents: [],
  filter: { groups: [], days: [], search: '', financial: false, abgemeldet: false },
  filteredStudents: [],
  loginMode: 'auto',
  studentData: null,
  currentDetailStudent: null,
  parentAbsencesToday: [],
  parentAbsentSet: new Set(),
  lastId: ''
};
let editingStudent = null; 
let msgPollingInterval = null; 
let studentPollingInterval = null;
let studentPollingPrimed = false;
let selectedForAttendance = new Set();
let editingUserIdx = null; 

// FLOATING AUDIO PLAYER STATE
let floatingAudio = {
  element: null,
  title: '',
  currentSurah: null,
  currentAyah: 1,
  totalAyahs: 0,
  verseList: [],
  repeatCount: 1,
  repeatLeft: 0,
  isPlaying: false,
  audioElement: null,
  mode: 'single'
};

// Attach an existing <audio> element to the floating player (pause/resume controls always visible)
function attachFloatingPlayerToAudio(audioEl, opts={}) {
  if(!audioEl) return;
  floatingAudio.audioElement = audioEl;
  floatingAudio.mode = opts.mode || floatingAudio.mode || 'single';
  if(opts.title) document.getElementById('floating-audio-title').textContent = opts.title;
  if(opts.info)  document.getElementById('floating-audio-info').textContent  = opts.info;

  // In range mode we disable the repeat dropdown because range repeat is controlled by lesson UI
  const rep = document.getElementById('floating-audio-repeat');
  if(rep) rep.disabled = (floatingAudio.mode === 'range');

  // Add listeners once per audio element
  if(!audioEl._qsFloatingListenersAdded){
    audioEl.addEventListener('play', () => {
      floatingAudio.isPlaying = true;
      updatePlayPauseButton();
      showFloatingAudio();
    });
    audioEl.addEventListener('pause', () => {
      floatingAudio.isPlaying = false;
      updatePlayPauseButton();
    });
    audioEl.addEventListener('ended', () => {
      floatingAudio.isPlaying = false;
      updatePlayPauseButton();
    });
    audioEl.addEventListener('timeupdate', () => {
      updateFloatingProgress();
    });
    audioEl._qsFloatingListenersAdded = true;
  }

  showFloatingAudio();
  updatePlayPauseButton();
  updateFloatingProgress();
}

function updateFloatingProgress(){
  const fill = document.getElementById('floating-audio-progress-fill');
  if(!fill) return;

  // For range playback: show progress across the selected range (not within a single mp3)
  if(floatingAudio.mode === 'range' && rangePlayback && rangePlayback.queue && rangePlayback.queue.length){
    const currentIndex = Math.max(0, (rangePlayback.idx || 0) - 1);
    const pct = (currentIndex / Math.max(1, rangePlayback.queue.length)) * 100;
    fill.style.width = `${pct}%`;
    return;
  }

  // For single/multi ayah playlist: show progress by ayah index
  if(floatingAudio.totalAyahs){
    const pct = ((floatingAudio.currentAyah - 1) / Math.max(1, floatingAudio.totalAyahs)) * 100;
    fill.style.width = `${pct}%`;
    return;
  }

  // Fallback: real audio percent if duration is known
  const a = floatingAudio.audioElement;
  if(a && a.duration){
    fill.style.width = `${(a.currentTime / a.duration) * 100}%`;
  }
}


// I18N
const i18n = {
  ar: {
    loginTitle: "تسجيل الدخول",
    loginBtn: "دخول",
    title: "طلاب دار القرآن",
    sync: "جاري المزامنة...",
    syncDone: "آخر تحديث: ",
    search: "ابحث بالاسم، الولي، الهاتف...",
    groups: "الأقسام",
    days: "أيام الدراسة",
    capWarn: "القسم ممتلئ",
    sendMsg: "إرسال رسالة",
    statsTitle: "الإحصائيات",
    totalStud: "عدد الطلاب الكلي",
    absentToday: "عدد الغياب لليوم",
    attendedToday: "عدد الحضور لليوم",
    presentCount: "عدد الحضور",
    navStud: "الطلاب",
    navComm: "التواصل",
    navStats: "إحصاء",
    navDocs: "وثائق",
navHw: "الواجبات",
hwAdminTitle: "توزيع واجب منزلي",
hwPickGroup: "اختر القسم",
hwPickDay: "اختر اليوم",
hwLoadStudents: "عرض الطلاب",
hwUseFilter: "استخدام الفلتر الحالي",
hwSelectAll: "تحديد الكل",
hwAssign: "إرسال الواجب",
hwTypeMem: "حفظ من الآية… إلى الآية…",
hwTypeText: "نص حر",
hwSearchStud: "بحث طالب...",
    docsTitle: "الوثائق",
    absentAlert: "هذا التلميذ تغيب 3 مرات متتالية، اتصل بالولي.",
    btnAbsent: "غياب",
    btnLate: "تأخير",
    lateToday: "تأخير اليوم",
    repeatedAbs: "غياب متكرر",
    printStud: "طباعة هذا التلميذ",
    editStud: "تعديل",
    save: "حفظ",
    cancel: "إلغاء",
    delete: "مسح الطالب",
    newMsg: "جديد",
    msgTo: "إلى",
    msgFrom: "من",
    saved: "تم الحفظ بنجاح",
    error: "حدث خطأ",
    expected: "المتوقع",
    confirmDelete: "هل أنت متأكد أنك تريد مسح هذا الطالب؟",
    studentNotes: "ملاحظات المعلم",
    addNote: "إضافة ملاحظة",
    l_referenz: "رقم الطالب",
    l_lastName: "اللقب",
    l_firstName: "الاسم",
    l_geburtsdatum: "تاريخ الميلاد", 
    l_parentName: "الولي",
    l_phone: "الهاتف",
    l_email: "البريد",
    l_days: "الأيام",
    l_group: "القسم", 
    l_iban: "IBAN",
    l_betrag: "المبلغ",
    l_alter: "العمر",
    l_gender: "الجنس",
    l_infos: "ملاحظات",
    l_fotoUrl: "رابط الصورة",
    l_abgemeldet: "منسحب (x)",
    l_kontrolleBank: "البنك (J)",
    l_finanzMark: "المالية (Y)",
    sendBatch: "إرسال",
    navUsers: "المستخدمين",
    manageUsers: "إدارة المستخدمين",
    addUser: "إضافة مستخدم",
    editUser: "تعديل مستخدم",
    role: "الدور",
    pin: "الرمز السري",
    name: "الاسم",
    visibleToTeacher: "يظهر للمعلم؟",
    userPlaceholder: "اسم المستخدم",
    pinPlaceholder: "PIN",
    confirmDelUser: "هل أنت متأكد من حذف هذا المستخدم؟",
    lblFinProb: "مشاكل دفع",
    lblAbgemeldet: "إظهار المنسحبين"
  },
  de: {
    loginTitle: "Anmelden",
    loginBtn: "Einloggen",
    title: "Koran-Schule Schüler",
    sync: "Synchronisiere...",
    syncDone: "Letztes Update: ",
    search: "Suche Name, Eltern, Tel...",
    groups: "Gruppen",
    days: "Unterrichtstage",
    capWarn: "Gruppe voll",
    sendMsg: "Nachricht senden",
    statsTitle: "Statistiken",
    totalStud: "Gesamtzahl Schüler",
    absentToday: "Fehlzeiten heute",
    attendedToday: "Anwesenheit heute",
    presentCount: "Anwesend",
    navStud: "Schüler",
    navComm: "Komm.",
    navStats: "Statistik",
    navDocs: "Doku",
navHw: "Aufgaben",
hwAdminTitle: "Hausaufgaben zuweisen",
hwPickGroup: "Gruppe wählen",
hwPickDay: "Tag wählen",
hwLoadStudents: "Schüler anzeigen",
hwUseFilter: "Aktuellen Filter verwenden",
hwSelectAll: "Alle auswählen",
hwAssign: "Hausaufgabe senden",
hwTypeMem: "Auswendig (Von–Bis)",
hwTypeText: "Freier Text",
hwSearchStud: "Schüler suchen...",
    docsTitle: "Dokumente",
    absentAlert: "Schüler fehlt 3x in Folge. Eltern kontaktieren.",
    btnAbsent: "Abwesend",
    btnLate: "Verspätet",
    lateToday: "Verspätet heute",
    repeatedAbs: "Häufiges Fehlen",
    printStud: "Drucken",
    editStud: "Bearbeiten",
    save: "Speichern",
    cancel: "Abbrechen",
    delete: "Schüler löschen",
    newMsg: "NEU",
    msgTo: "An",
    msgFrom: "Von",
    saved: "Erfolgreich gespeichert",
    error: "Fehler aufgetreten",
    expected: "Erwartet",
    confirmDelete: "Sind Sie sicher, dass Sie diesen Schüler löschen möchten?",
    studentNotes: "Lehrer Notizen",
    addNote: "Notiz hinzufügen",
    l_referenz: "Student ID",
    l_lastName: "Nachname",
    l_firstName: "Vorname",
    l_geburtsdatum: "Geburtsdatum", 
    l_parentName: "Eltern",
    l_phone: "Telefon",
    l_email: "Email",
    l_days: "Tage",
    l_group: "Gruppe", 
    l_iban: "IBAN",
    l_betrag: "Betrag",
    l_alter: "Alter",
    l_gender: "Geschlecht",
    l_infos: "Infos",
    l_fotoUrl: "Foto URL",
    l_abgemeldet: "Abgemeldet (x)",
    l_kontrolleBank: "Kontrolle Bank (J)",
    l_finanzMark: "Finanz Markierung (Y)",
    sendBatch: "Senden",
    navUsers: "Benutzer",
    manageUsers: "Benutzerverwaltung",
    addUser: "Nutzer hinzufügen",
    editUser: "Nutzer bearbeiten",
    role: "Rolle",
    pin: "PIN",
    name: "Name",
    visibleToTeacher: "Sichtbar für Lehrer?",
    userPlaceholder: "Benutzername",
    pinPlaceholder: "PIN",
    confirmDelUser: "Benutzer wirklich löschen?",
    lblFinProb: "Zahlungsprobleme",
    lblAbgemeldet: "Abgemeldete anzeigen"
  }
};

function t(key) { return i18n[state.lang][key] || key; }

// --- FLOATING AUDIO PLAYER FUNCTIONS ---
function showFloatingAudio() {
  document.getElementById('floating-audio-player').classList.add('show');
}

function hideFloatingAudio() {
  document.getElementById('floating-audio-player').classList.remove('show');

  // stop range playback (if active)
  try {
    if (rangePlayback) rangePlayback.active = false;
  } catch(e) {}

  if (floatingAudio.audioElement) {
    floatingAudio.audioElement.pause();
    floatingAudio.isPlaying = false;
    updatePlayPauseButton();
  }
}

function setupFloatingAudio(surah, start, end, verses) {
  floatingAudio.mode = 'single';
  floatingAudio.currentSurah = surah;
  floatingAudio.currentAyah = start;
  floatingAudio.verseList = verses;
  floatingAudio.totalAyahs = verses.length;
  floatingAudio.repeatLeft = parseInt(document.getElementById('floating-audio-repeat').value) || 1;
  
  const surahInfo = getSurahInfo(surah);
  document.getElementById('floating-audio-title').textContent = 
    `${surahInfo.arabic} - ${surahInfo.latin} (${start}-${end})`;
  
  showFloatingAudio();
  playCurrentAyah();
}

function playCurrentAyah() {
  if (floatingAudio.currentAyah < 1 || floatingAudio.currentAyah > floatingAudio.totalAyahs) {
    hideFloatingAudio();
    return;
  }

  const verse = floatingAudio.verseList[floatingAudio.currentAyah - 1];
  if (!verse || !verse.audio_url) return;

  // Create audio element if needed
  if (!floatingAudio.audioElement || floatingAudio.mode !== 'single') {
    floatingAudio.audioElement = new Audio();
  }
  floatingAudio.mode = 'single';

  const surahInfo = getSurahInfo(floatingAudio.currentSurah);
  attachFloatingPlayerToAudio(floatingAudio.audioElement, {
    mode: 'single',
    title: `${surahInfo.arabic} - ${surahInfo.latin}`,
    info: `سورة ${surahInfo.arabic} - آية ${floatingAudio.currentAyah}`
  });

  // (Re)bind ended handler for playlist+repeat
  floatingAudio.audioElement.onended = () => {
    floatingAudio.repeatLeft--;
    if (floatingAudio.repeatLeft > 0) {
      floatingAudio.audioElement.currentTime = 0;
      floatingAudio.audioElement.play().catch(()=>{});
      return;
    }
    floatingAudio.repeatLeft = parseInt(document.getElementById('floating-audio-repeat').value) || 1;
    if (floatingAudio.currentAyah < floatingAudio.totalAyahs) {
      floatingAudio.currentAyah++;
      playCurrentAyah();
    } else {
      hideFloatingAudio();
      showToast(state.lang === 'de' ? 'Lektion beendet' : 'انتهت الدرس');
    }
  };

  floatingAudio.audioElement.src = verse.audio_url;
  floatingAudio.audioElement.play().then(() => {
    floatingAudio.isPlaying = true;
    updatePlayPauseButton();
    updateFloatingProgress();
  }).catch(() => {});
}

function previousAyah() {
  if (floatingAudio.mode === 'range' && rangePlayback && rangePlayback.active && typeof rangePlayback._playNext === 'function') {
    // idx points to the next ayah -> go back one
    rangePlayback.idx = Math.max(0, (rangePlayback.idx || 0) - 2);
    rangePlayback._playNext();
    return;
  }

  if (floatingAudio.currentAyah > 1) {
    floatingAudio.currentAyah--;
    floatingAudio.repeatLeft = parseInt(document.getElementById('floating-audio-repeat').value) || 1;
    playCurrentAyah();
  }
}

function nextAyah() {
  if (floatingAudio.mode === 'range' && rangePlayback && rangePlayback.active && typeof rangePlayback._playNext === 'function') {
    rangePlayback._playNext();
    return;
  }

  if (floatingAudio.currentAyah < floatingAudio.totalAyahs) {
    floatingAudio.currentAyah++;
    floatingAudio.repeatLeft = parseInt(document.getElementById('floating-audio-repeat').value) || 1;
    playCurrentAyah();
  } else {
    hideFloatingAudio();
    showToast(state.lang === 'de' ? 'Lektion beendet' : 'انتهت الدرس');
  }
}

function togglePlayPause() {
  // If something is playing in the lesson player (range playback), hook it automatically
  if (!floatingAudio.audioElement) {
    const la = document.getElementById('lesson-audio');
    if (la && !la.paused) {
      attachFloatingPlayerToAudio(la, { mode: 'range' });
    } else {
      return;
    }
  }

  if (floatingAudio.isPlaying) {
    floatingAudio.audioElement.pause();
  } else {
    floatingAudio.audioElement.play().catch(()=>{});
  }
}

function updatePlayPauseButton() {
  const btn = document.getElementById('btn-play-pause');
  if (btn) {
    btn.textContent = floatingAudio.isPlaying ? '❚❚' : '▶';
  }
}

// Update floating audio repeat count when changed
document.getElementById('floating-audio-repeat')?.addEventListener('change', function() {
  floatingAudio.repeatLeft = parseInt(this.value) || 1;
});

// --- LOGIN LOGIC ---
function rememberedKey(){ return 'qs_remember_v1'; }

// Saved profiles store (multi account on same device)
function profilesKey(){ return 'qs_profiles_v1'; }

function getSavedProfiles(){
  try{
    const raw = localStorage.getItem(profilesKey());
    if(!raw) return [];
    const arr = JSON.parse(raw);
    return Array.isArray(arr) ? arr : [];
  }catch(e){ return []; }
}

function setSavedProfiles(arr){
  try{ localStorage.setItem(profilesKey(), JSON.stringify(arr || [])); }catch(e){}
}

function initialsFromName(name){
  const s = (name || '').trim();
  if(!s) return '👤';
  const parts = s.split(/\s+/).filter(Boolean);
  const a = parts[0]?.[0] || '';
  const b = parts.length>1 ? (parts[parts.length-1]?.[0] || '') : (parts[0]?.[1] || '');
  const out = (a + b).toUpperCase();
  return out || '👤';
}

function displayNameFromProfile(p){
  return (p && (p.displayName || p.userName || p.name)) ? String(p.displayName || p.userName || p.name) : (p?.identifier || '');
}

function upsertSavedProfile(profile){
  if(!profile || !profile.identifier) return;
  const id = String(profile.identifier).trim();
  if(!id) return;

  const arr = getSavedProfiles().filter(p => String(p.identifier||'').trim() !== id);
  const item = {
    identifier: id,
    pin: String(profile.pin || ''),
    displayName: String(profile.displayName || id),
    role: String(profile.role || ''),
    lastType: profile.lastType || null,
    lastUsed: Date.now()
  };
  arr.unshift(item);

  // keep it small
  const max = 10;
  setSavedProfiles(arr.slice(0, max));
  renderSavedProfiles();
}

function removeSavedProfile(identifier){
  const id = String(identifier || '').trim();
  if(!id) return;
  const arr = getSavedProfiles().filter(p => String(p.identifier||'').trim() !== id);
  setSavedProfiles(arr);
  renderSavedProfiles();
}

function renderSavedProfiles(){
  const box = document.getElementById('saved-profiles');
  const list = document.getElementById('saved-profiles-list');
  const title = document.getElementById('lbl-saved-profiles');
  const hint  = document.getElementById('lbl-saved-profiles-hint');
  if(!box || !list) return;

  const arr = getSavedProfiles()
    .slice()
    .sort((a,b) => (b?.lastUsed||0) - (a?.lastUsed||0));

  // Localized labels
  if(title){
    title.textContent = (state.lang === 'ar' ? 'تسجيل سريع' : 'Schnellstart');
  }
  if(hint){
    hint.textContent = (state.lang === 'ar'
      ? 'اضغط على الملف للدخول بسرعة (أو لملء البيانات).'
      : 'Tippe auf ein Profil für schnellen Login (oder zum Ausfüllen).');
  }

  if(arr.length === 0){
    box.classList.add('hidden');
    list.innerHTML = '';
    return;
  }

  box.classList.remove('hidden');
  list.innerHTML = '';

  arr.forEach(p => {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'profile-tile';
    btn.title = (state.lang === 'ar'
      ? 'اضغط لتسجيل الدخول'
      : 'Zum Anmelden tippen');

    const avatar = document.createElement('div');
    avatar.className = 'profile-avatar';
    avatar.textContent = initialsFromName(displayNameFromProfile(p));

    const name = document.createElement('div');
    name.className = 'profile-name';
    name.textContent = displayNameFromProfile(p);

    const sub = document.createElement('div');
    sub.className = 'profile-sub';
    const role = String(p.role||'').toLowerCase();
    sub.textContent = role ? (role.includes('student') ? (state.lang==='ar'?'طالب':'Student') : (state.lang==='ar'?'طاقم':'Staff')) : '';

    const rm = document.createElement('button');
    rm.type = 'button';
    rm.className = 'profile-remove';
    rm.textContent = '×';
    rm.title = (state.lang === 'ar' ? 'حذف' : 'Entfernen');
    rm.addEventListener('click', (ev) => {
      ev.preventDefault();
      ev.stopPropagation();
      removeSavedProfile(p.identifier);
    });

    btn.addEventListener('click', () => {
      const idEl = document.getElementById('login-identifier');
      const pinEl = document.getElementById('login-pin');
      const chk = document.getElementById('chk-remember');

      if(idEl) idEl.value = p.identifier || '';
      if(chk) chk.checked = true; // profile implies "remember me"
      if(pinEl) pinEl.value = p.pin || '';

      // Prefer last type when choosing order
      if(p.lastType) state.loginMode = p.lastType;

      // One-tap login only if we have a stored PIN
      if(p.pin){
        doLogin();
      }else{
        try{ pinEl?.focus(); }catch(e){}
      }
    });

    btn.appendChild(avatar);
    btn.appendChild(name);
    if(sub.textContent) btn.appendChild(sub);
    btn.appendChild(rm);
    list.appendChild(btn);
  });

  // Also update inline dropdown inside the username field
  try{ setupIdentifierDropdown(); }catch(e){}
  try{ renderSavedProfilesDropdown(''); }catch(e){}
}



// --- Saved profiles dropdown inside username input ---
let __idDropdownSetupDone = false;
let __idDropdownOpen = false;

function setupIdentifierDropdown(){
  if(__idDropdownSetupDone) return;
  const idEl = document.getElementById('login-identifier');
  const panel = document.getElementById('id-dropdown-panel');
  const btn = document.getElementById('btn-id-dropdown');
  const wrap = document.getElementById('login-identifier-wrap');
  if(!idEl || !panel || !btn || !wrap) return;
  __idDropdownSetupDone = true;

  btn.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();
    toggleIdDropdown();
  });

  idEl.addEventListener('focus', () => {
    renderSavedProfilesDropdown('');
    showIdDropdownIfAny(true);
  });

  idEl.addEventListener('input', () => {
    renderSavedProfilesDropdown('');
    showIdDropdownIfAny(true);
  });

  idEl.addEventListener('keydown', (ev) => {
    if(ev.key === 'Escape'){
      hideIdDropdown();
    }
  });

  // Close when clicking outside
  document.addEventListener('click', (ev) => {
    if(!wrap.contains(ev.target)){
      hideIdDropdown();
    }
  });
}

function showIdDropdownIfAny(forceShow=false){
  const panel = document.getElementById('id-dropdown-panel');
  if(!panel) return;
  const hasItems = !!panel.querySelector('.dd-item');
  if(!hasItems){
    panel.classList.add('hidden');
    __idDropdownOpen = false;
    return;
  }
  if(forceShow){
    panel.classList.remove('hidden');
    __idDropdownOpen = true;
  }
}

function toggleIdDropdown(){
  const panel = document.getElementById('id-dropdown-panel');
  const idEl = document.getElementById('login-identifier');
  if(!panel || !idEl) return;

  renderSavedProfilesDropdown('');
  const hasItems = !!panel.querySelector('.dd-item');

  if(!hasItems){
    panel.classList.add('hidden');
    __idDropdownOpen = false;
    return;
  }

  if(panel.classList.contains('hidden')){
    panel.classList.remove('hidden');
    __idDropdownOpen = true;
    try{ idEl.focus(); }catch(e){}
  }else{
    hideIdDropdown();
  }
}

function hideIdDropdown(){
  const panel = document.getElementById('id-dropdown-panel');
  if(panel) panel.classList.add('hidden');
  __idDropdownOpen = false;
}

function renderSavedProfilesDropdown(filterText=''){
  const panel = document.getElementById('id-dropdown-panel');
  if(!panel) return;

  const arr = getSavedProfiles()
    .slice()
    .sort((a,b) => (b?.lastUsed||0) - (a?.lastUsed||0));

  /* show all saved profiles even if user typed something */
  const filtered = arr;

  panel.innerHTML = '';
  filtered.forEach(p => {
    const item = document.createElement('button');
    item.type = 'button';
    item.className = 'dd-item';
    item.setAttribute('role','option');
    item.title = (state.lang === 'ar' ? 'اضغط لتسجيل الدخول' : 'Zum Anmelden tippen');

    const avatar = document.createElement('div');
    avatar.className = 'dd-avatar';
    avatar.textContent = initialsFromName(displayNameFromProfile(p));

    const meta = document.createElement('div');
    meta.className = 'dd-meta';

    const nm = document.createElement('div');
    nm.className = 'dd-name';
    nm.textContent = displayNameFromProfile(p);

    const sub = document.createElement('div');
    sub.className = 'dd-sub';
    const role = String(p.role||'').toLowerCase();
    const roleLabel = role ? (role.includes('student') ? (state.lang==='ar'?'طالب':'Student') : (state.lang==='ar'?'طاقم':'Staff')) : '';
    sub.textContent = (p.identifier ? String(p.identifier) : '') + (roleLabel ? ` • ${roleLabel}` : '');

    meta.appendChild(nm);
    meta.appendChild(sub);

    const rm = document.createElement('button');
    rm.type = 'button';
    rm.className = 'dd-remove';
    rm.textContent = '×';
    rm.title = (state.lang === 'ar' ? 'حذف' : 'Entfernen');
    rm.addEventListener('click', (ev) => {
      ev.preventDefault();
      ev.stopPropagation();
      removeSavedProfile(p.identifier);
      renderSavedProfilesDropdown('');
      showIdDropdownIfAny(true);
    });

    item.addEventListener('click', () => {
      const idEl = document.getElementById('login-identifier');
      const pinEl = document.getElementById('login-pin');
      const chk = document.getElementById('chk-remember');

      if(idEl) idEl.value = p.identifier || '';
      if(chk) chk.checked = true; // profile implies "remember me"
      if(pinEl) pinEl.value = p.pin || '';

      if(p.lastType) state.loginMode = p.lastType;

      hideIdDropdown();

      if(p.pin){
        doLogin();
      }else{
        try{ pinEl?.focus(); }catch(e){}
      }
    });

    item.appendChild(avatar);
    item.appendChild(meta);
    item.appendChild(rm);
    panel.appendChild(item);
  });
}


function applyRemembered(){
  try{
    const raw = localStorage.getItem(rememberedKey());
    if(!raw) return;
    const obj = JSON.parse(raw);
    document.getElementById('chk-remember').checked = !!obj.remember;

    const idEl  = document.getElementById('login-identifier');
    const pinEl = document.getElementById('login-pin');
    if(idEl)  idEl.value  = obj.identifier || obj.staffUser || obj.studentId || '';
    if(pinEl) pinEl.value = obj.pin || obj.staffPin || obj.studentPin || '';

    // optional: prefer the last successful type when auto-trying
    if(obj.lastType) state.loginMode = obj.lastType;
  }catch(e){}
}

function saveRemembered(lastType){
  const remember = !!document.getElementById('chk-remember')?.checked;
  const idVal  = (document.getElementById('login-identifier')?.value || '').trim();
  const pinVal = (document.getElementById('login-pin')?.value || '').trim();

  const payload = {
    remember: remember,
    identifier: remember ? idVal : '',
    pin: remember ? pinVal : '',
    lastType: remember ? (lastType || null) : null
  };
  try{ localStorage.setItem(rememberedKey(), JSON.stringify(payload)); }catch(e){}
}

function toggleLoginMode(mode) {
  state.loginMode = mode;

  document.querySelectorAll('.login-tab').forEach(el => el.classList.remove('active'));
  const tab = document.getElementById(`tab-login-${mode}`);
  if(tab) tab.classList.add('active');

  const staff = document.getElementById('login-staff-fields');
  const stu   = document.getElementById('login-student-fields');
  if(staff) staff.classList.toggle('hidden', mode !== 'staff');
  if(stu)   stu.classList.toggle('hidden', mode !== 'student');

  applyRemembered();
}

function showLoginLoading(show, msg){
  const overlay = document.getElementById('login-loading-overlay');
  if(!overlay) return;
  const tEl = document.getElementById('login-loading-text');
  const sEl = document.getElementById('login-loading-sub');

  const isAr = (typeof state !== 'undefined' && state.lang === 'ar');
  const defaultMsg = isAr ? 'جارٍ التحقق...' : 'Anmeldung wird geprüft…';
  const defaultSub = isAr ? 'الرجاء الانتظار…' : 'Bitte warten…';

  if(tEl) tEl.textContent = msg || defaultMsg;
  if(sEl) sEl.textContent = isAr ? defaultSub : defaultSub;

  const btn = document.getElementById('lbl-login-btn');
  if(btn) btn.disabled = !!show;

  if(show){
    overlay.classList.remove('hidden');
    // ensure transition
    requestAnimationFrame(() => overlay.classList.add('visible'));
  }else{
    overlay.classList.remove('visible');
    setTimeout(() => overlay.classList.add('hidden'), 260);
  }
}

async function doLogin() {
  const errEl = document.getElementById('login-error');
  if(errEl) errEl.innerText = "";
  const btnTxt = document.getElementById('lbl-login-btn');
  if(btnTxt) btnTxt.innerText = "...";

  // Show loading immediately while we verify credentials
  showLoginLoading(true);

  const identifierRaw = (document.getElementById('login-identifier')?.value || '').trim();
  const pinRaw = (document.getElementById('login-pin')?.value || '').trim();

  if(!identifierRaw){
    if(errEl) errEl.innerText = (state.lang === 'de' ? 'Bitte Benutzername/Student ID eingeben' : 'الرجاء إدخال اسم المستخدم أو رقم الطالب');
    if(btnTxt) btnTxt.innerText = t('loginBtn');
    showLoginLoading(false);
    return;
  }
  if(!pinRaw){
    if(errEl) errEl.innerText = (state.lang === 'de' ? 'Bitte PIN eingeben' : 'الرجاء إدخال الرقم السري');
    if(btnTxt) btnTxt.innerText = t('loginBtn');
    showLoginLoading(false);
    return;
  }

  // Case-insensitive fallback: try typed / lower / upper
  const normalizeDigits = (s) => {
    const v = String(s ?? '');
    const map = {
      '٠':'0','١':'1','٢':'2','٣':'3','٤':'4','٥':'5','٦':'6','٧':'7','٨':'8','٩':'9',
      '۰':'0','۱':'1','۲':'2','۳':'3','۴':'4','۵':'5','۶':'6','۷':'7','۸':'8','۹':'9'
    };
    return v.replace(/[٠-٩۰-۹]/g, ch => (map[ch] ?? ch));
  };

  const uniq = (arr) => arr.filter((x, i) => arr.indexOf(x) === i);

  const caseVariants = (s) => {
    const v = String(s ?? '');
    const out = [v];
    const low = v.toLowerCase();
    const up  = v.toUpperCase();
    if(low !== v) out.push(low);
    if(up !== v && up !== low) out.push(up);
    // de-dup while preserving order
    return uniq(out);
  };

  const identifierNorm = normalizeDigits(identifierRaw);
  const pinNorm = normalizeDigits(pinRaw);

  const looksStudentId = /^[0-9]{2,}$/.test(identifierNorm); // student IDs are usually numeric
  let inferred = looksStudentId ? 'student' : 'staff';

  // If this identifier exists in saved profiles, trust the last successful type
  try{
    const profiles = getSavedProfiles();
    const hit = profiles.find(p => {
      const pid = String(p.identifier || '').trim();
      return pid === String(identifierRaw).trim() || pid === String(identifierNorm).trim();
    });
    if(hit && (hit.lastType === 'student' || hit.lastType === 'staff')) inferred = hit.lastType;
  }catch(e){}

  const idBase = uniq([identifierRaw, identifierNorm].map(v => String(v || '').trim()).filter(Boolean));
  const pinBase = uniq([pinNorm].map(v => String(v || '').trim()).filter(Boolean));

  // For staff usernames, try case variants; for numeric student IDs keep it strict (faster)
  const idCandidates  = looksStudentId ? idBase : uniq(idBase.flatMap(v => caseVariants(v)));
  const pinCandidates = pinBase; // PIN is numeric → avoid extra slow retries

  // Decide try order (fast path for inferred type; fallback to other)
  const order = [];
  if(state.loginMode === 'student') order.push('student','staff');
  else if(state.loginMode === 'staff') order.push('staff','student');
  else order.push(inferred, inferred === 'student' ? 'staff' : 'student');


let lastError = null;

  for(const mode of order){
    for(const identifier of idCandidates){
      for(const pin of pinCandidates){
        const payload = { action:'login' };
        if(mode === 'staff'){
          payload.loginType = 'staff';
          payload.userName = identifier;
          payload.pin = pin;
        } else {
          payload.loginType = 'student';
          payload.studentId = identifier;
          payload.pin = pin;
        }

        try{
          const res = await fetch(WEB_APP_URL, {
            method:'POST',
            headers: { "Content-Type": "text/plain" },
            body: JSON.stringify(payload)
          }).then(r=>r.json());

          if(res && res.ok){
            saveRemembered(mode);

            // Store successful profile (multi profiles on same device) if 'remember me' is checked
            try{
              if(!!document.getElementById('chk-remember')?.checked){
                upsertSavedProfile({
                  identifier: identifier,
                  pin: pin,
                  displayName: (res && res.userName) ? res.userName : identifier,
                  role: (res && res.role) ? res.role : mode,
                  lastType: mode
                });
              }
            }catch(e){}

            state.user = res.userName;
            state.role = res.role;

            
            // start background queue syncing after login
            try{ kickSyncQueue(); }catch(e){}
if (String(state.role).toLowerCase() === 'student') {
              state.role = 'Student';
              state.studentData = { referenz: res.studentRef || payload.studentId };
            }
            showLoginLoading(false);
            document.getElementById('login-overlay').classList.add('hidden');
            document.getElementById('qs-app-root').classList.remove('hidden');

            setupUI();
            if(state.role !== 'Student') {
              loadData();
              startMessagePolling();
            } else {
              setupStudentUI();
            }

            if(btnTxt) btnTxt.innerText = t('loginBtn');
            return;
          } else {
            lastError = (res && res.error) ? res.error : null;
          }
        }catch(e){
          lastError = (state.lang === 'de' ? 'Verbindungsfehler: ' : 'خطأ في الاتصال: ') + (e?.message || e);
          break;
        }
      }
      if(lastError && String(lastError).toLowerCase().includes('verbindungsfehler')) break;
    }
    if(lastError && String(lastError).toLowerCase().includes('verbindungsfehler')) break;
  }
  showLoginLoading(false);

  if(errEl) errEl.innerText = lastError || (state.lang === 'de' ? 'Login fehlgeschlagen' : 'فشل تسجيل الدخول');
  if(btnTxt) btnTxt.innerText = t('loginBtn');
}

function setupUI() {
  // Reset navigation cache/history guards when role changes (prevents Student from seeing staff tabs via Back)
  try{ resetNavState(); }catch(e){}
  document.getElementById('hdr-user').innerText = `User: ${state.user} (${state.role})`;
  
  if(state.role === 'Student') {
      // Hide Teacher Navs
      document.getElementById('nav-users').classList.add('hidden');
      document.getElementById('nav-students').classList.add('hidden');
      document.getElementById('nav-comm').classList.add('hidden');
      document.getElementById('nav-stats').classList.add('hidden');
      document.getElementById('nav-docs').classList.add('hidden');
      document.getElementById('nav-homework-admin').classList.add('hidden');
      document.getElementById('btn-filter').classList.add('hidden');
      
      // Show Student Nav
      document.getElementById('nav-stu-home').classList.remove('hidden');
      document.getElementById('nav-stu-hw').classList.remove('hidden');
      document.getElementById('nav-stu-mem').classList.remove('hidden');
      document.getElementById('nav-stu-rate').classList.remove('hidden');
      document.getElementById('nav-stu-parent').classList.remove('hidden');

      // Default tab
      setReaderFabVisible(true);
      switchTab('student-home');
      return;
  }

  setReaderFabVisible(false);
  clearLessonFab();

  // Lehrer: show homework tab (Admin: hide)
  if(state.role === 'Lehrer'){
      document.getElementById('nav-homework-admin')?.classList.remove('hidden');
  } else {
      document.getElementById('nav-homework-admin')?.classList.add('hidden');
  }

  // Teacher/Admin Setup
  if(state.role === 'Admin') {
      document.getElementById('btn-add-student').classList.remove('hidden');
      document.getElementById('nav-users').classList.remove('hidden');
      document.getElementById('admin-filters').classList.remove('hidden');
  } else {
      document.getElementById('nav-users').classList.add('hidden');
      document.getElementById('admin-filters').classList.add('hidden');
  }
  updateLang();
  initMessageNotificationsUI();
  const daysMap = ["Sonntag","Montag","Dienstag","Mittwoch","Donnerstag","Freitag","Samstag"];
  state.filter.days = [daysMap[new Date().getDay()]]; 
  state.filter.groups = [];
  if (localStorage.getItem('darkMode') === 'true') state.darkMode = true; else state.darkMode = false;
  updateDarkModeIcon();

  setupHomeworkSurahDropdown();
  try{ initBulkHomeworkUI(); }catch(e){}
  try{ initAllHomeworkUI(); }catch(e){}
}

// --- LOGOUT ---
function resetNavDefaults(){
  // Teacher nav visible by default
  ['nav-students','nav-homework-admin','nav-comm','nav-stats','nav-docs'].forEach(id => {
    document.getElementById(id)?.classList.remove('hidden');
  });
  // Users only for Admin (keep hidden by default until login sets it)
  document.getElementById('nav-users')?.classList.add('hidden');

  // Student nav hidden by default
  ['nav-stu-home','nav-stu-hw','nav-stu-mem','nav-stu-rate','nav-stu-parent'].forEach(id => {
    document.getElementById(id)?.classList.add('hidden');
  });

  // Header actions defaults
  document.getElementById('btn-filter')?.classList.remove('hidden');
  document.getElementById('btn-add-student')?.classList.add('hidden');
  document.getElementById('admin-filters')?.classList.add('hidden');

  try{ setReaderFabVisible(false); }catch(e){}
}

function doLogout(){
  try{ showLoginLoading(false); }catch(e){}
  // Stop polling
  try{ if(msgPollingInterval){ clearInterval(msgPollingInterval); msgPollingInterval = null; } }catch(e){}
  try{ if(studentPollingInterval){ clearInterval(studentPollingInterval); studentPollingInterval = null; } }catch(e){}
  try{ studentPollingPrimed = false; }catch(e){}

  // Close overlays/modals
  try{ hideFloatingAudio(); }catch(e){}
  try{ document.querySelectorAll('.modal-overlay.visible').forEach(el => el.classList.remove('visible')); }catch(e){}
  try{ document.getElementById('progress-overlay')?.classList.remove('visible'); }catch(e){}
  try{ hideQuickVerseSheet(); }catch(e){}
  try{ clearLessonFab(); }catch(e){}
  try{ setReaderFabVisible(false); }catch(e){}

  // Reset volatile state (keep language + dark mode)
  state.user = null;
  state.role = null;
  state.students = [];
  state.attendance = [];
  state.messages = [];
  state.teachers = [];
  state.allUsers = [];
  state.studentInfos = [];
  state.documents = [];
  state.filteredStudents = [];
  state.studentData = null;
  state.currentDetailStudent = null;
  state.parentAbsencesToday = [];
  state.parentAbsentSet = new Set();
  state.studentHomeAlerts = [];

  try{ selectedForAttendance = new Set(); }catch(e){}
  try{ editingStudent = null; }catch(e){}
  try{ editingUserIdx = null; }catch(e){}

  // Reset UI defaults
  try{ resetNavState(); }catch(e){}
  resetNavDefaults();
  try{ switchTab('students', {noHistory:true}); }catch(e){}

  // Show login screen
  document.getElementById('qs-app-root')?.classList.add('hidden');
  document.getElementById('login-overlay')?.classList.remove('hidden');

  // Header text reset
  const hu = document.getElementById('hdr-user');
  if(hu) hu.innerText = '';
  const hs = document.getElementById('hdr-sync');
  if(hs) hs.innerText = t('sync');

  // Optional: clear PIN if remember is off
  try{
    const remember = !!document.getElementById('chk-remember')?.checked;
    if(!remember){
      const pinEl = document.getElementById('login-pin');
      if(pinEl) pinEl.value = '';
    }
  }catch(e){}

  try{ renderSavedProfiles(); }catch(e){}

  try{ document.getElementById('login-identifier')?.focus(); }catch(e){}
}

// --- STUDENT UI LOGIC ---

function setupStudentUI() {
  updateLang();
  // Security hardening: ensure no staff data is kept in memory in Student mode
  try{ state.students = []; state.filteredStudents = []; state.attendance = []; state.messages = []; state.teachers = []; }catch(e){}
  try{ document.getElementById('students-list') && (document.getElementById('students-list').innerHTML = ''); }catch(e){}
  try{ history.replaceState({qsNav:true, kind:'main', tab:'student-home'}, ''); ensureExitGuardState(); }catch(e){}
  // Popup alerts (lateness/absence/new entries)
  fetchStudentPopupAlerts({noModal:true});

  loadStudentHomework();
  loadStudentEvaluations();
  loadStudentAttendance();
    loadStudentProgress();
  loadParentAbsentState();
  renderSurahList();
  initStudentNotificationsUI();
  // Start polling only if user enabled notifications
  if(isStudentNotificationsEnabled()){
    startStudentPolling();
  }
}

// --- Student Home (Main tab) ---
state.studentHomeAlerts = state.studentHomeAlerts || [];

function isStudentHomeVisible(){
  const el = document.getElementById('tab-student-home');
  return !!el && !el.classList.contains('hidden');
}

async function loadStudentHome(){
  const listEl = document.getElementById('student-home-alerts');
  if(listEl){
    listEl.innerHTML = `<div class="text-sec text-center">${state.lang === 'de' ? 'Lade…' : 'جارٍ التحميل…'}</div>`;
  }
  // Use alerts API as the source of truth for "new updates"
  await fetchStudentPopupAlerts({ noModal:true, force:true });
}

function renderStudentHomeAlerts(alerts){
  const arr = Array.isArray(alerts) ? alerts : [];
  const listEl = document.getElementById('student-home-alerts');
  const countEl = document.getElementById('student-home-count');
  const btnAll = document.getElementById('stu-home-btn-markall');

  if(countEl) countEl.innerText = String(arr.length || 0);
  showDotBadge('badge-stu-home', arr.length > 0);

  if(btnAll){
    btnAll.classList.toggle('hidden', arr.length === 0);
  }

  if(!listEl) return;
  listEl.innerHTML = '';

  if(arr.length === 0){
    // If there are no alerts, show achievements alone (no "no updates") unless achievements are also empty.
    const hasAch = !!(state.studentProgress && state.studentProgress.length);
    listEl.innerHTML = hasAch ? '' : `<div class="text-sec text-center" style="padding:10px 0;">${state.lang === 'de' ? 'Keine neuen Einträge.' : 'لا توجد مستجدات جديدة.'}</div>`;
    renderStudentHomeAchievements();
    return;
  }

  arr.forEach((a, i) => {
    const txt = buildStudentAlertText(a);
    const date = dateOnly(a.date || a.timestamp || '');
    let gotoTab = '';
    if(a.type === 'homework') gotoTab = 'student-homework';
    else if(a.type === 'evaluation' || a.type === 'attendance') gotoTab = 'student-rating';

    const openBtn = gotoTab ? `
      <button class="btn btn-sec" style="flex:1;" onclick="switchTab('${gotoTab}')">
        ${state.lang === 'de' ? 'Öffnen' : 'فتح'}
      </button>` : '';

    listEl.innerHTML += `
      <div class="card flex-col" style="align-items:flex-start; padding:12px;">
        <div style="display:flex; width:100%; justify-content:space-between; align-items:flex-start; gap:10px;">
          <div style="font-weight:bold;">${escapeHtml(txt.title || '')}</div>
          <div class="text-sm text-sec" style="white-space:nowrap;">${escapeHtml(date || '')}</div>
        </div>
        <div class="text-sm" style="white-space:pre-wrap; margin-top:8px; line-height:1.5;">${escapeHtml(txt.body || '')}</div>
        <div style="display:flex; gap:10px; width:100%; margin-top:12px;">
          ${openBtn}
          <button class="btn" style="flex:1;" onclick="markStudentHomeAlertRead(${i})">
            ${state.lang === 'de' ? 'Gelesen' : 'تمت القراءة'}
          </button>
        </div>
      </div>
    `;
  });

  renderStudentHomeAchievements();
}

async function markStudentHomeAlertRead(i){
  const a = (state.studentHomeAlerts || [])[i];
  if(!a?.id) return;

  try{
    await fetch(WEB_APP_URL, {
      method:'POST',
      headers: { "Content-Type": "text/plain" },
      body: JSON.stringify({ action:'markStudentAlertRead', studentRef: state.studentData.referenz, alertId: a.id })
    }).then(r=>r.json());
  }catch(e){}

  // Refresh list (and keep popup state consistent)
  await fetchStudentPopupAlerts({ noModal:true, force:true });
}

async function markAllStudentHomeAlertsRead(){
  const arr = (state.studentHomeAlerts || []).slice();
  if(!arr.length) return;

  for(const a of arr){
    if(!a?.id) continue;
    try{
      await fetch(WEB_APP_URL, {
        method:'POST',
        headers: { "Content-Type": "text/plain" },
        body: JSON.stringify({ action:'markStudentAlertRead', studentRef: state.studentData.referenz, alertId: a.id })
      }).then(r=>r.json());
    }catch(e){}
  }
  await fetchStudentPopupAlerts({ noModal:true, force:true });
}


// --- Student Popup Alerts (shown on login + when new items arrive) ---
state.popupAlerts = state.popupAlerts || [];
state.popupAlertIndex = state.popupAlertIndex || 0;

async function fetchStudentPopupAlerts(opts = {}){
  try{
    if(!state.studentData?.referenz) return [];
    const noModal = !!(opts && opts.noModal);
    const force = !!(opts && opts.force);

    // Don’t interrupt if already visible (unless force refresh)
    const modal = document.getElementById('alert-modal');
    if(modal && modal.classList.contains('visible') && !force) return (state.popupAlerts || []);

    const res = await fetch(WEB_APP_URL, {
      method:'POST',
      headers: { "Content-Type": "text/plain" },
      body: JSON.stringify({ action:'getStudentAlerts', studentRef: state.studentData.referenz })
    }).then(r=>r.json());

    const alerts = (res && res.ok && Array.isArray(res.alerts)) ? res.alerts : [];
    state.popupAlerts = alerts;
    state.popupAlertIndex = 0;

    // Keep a copy for the Student "Home" tab
    state.studentHomeAlerts = alerts;
    renderStudentHomeAlerts(alerts);

    const onHome = isStudentHomeVisible();
    if(!noModal && !onHome && alerts.length){
      showCurrentStudentAlert();
    }
    return alerts;
  }catch(e){
    return [];
  }
}
function buildStudentAlertText(a){
  const de = (state.lang === 'de');
  if(!a) return { title:'', body:'' };

  // Attendance (late/absent)
  if(a.type === 'attendance'){
    const st = String(a.status || '').trim();
    const date = a.date || '';
    const isLate = (st === 'تأخير' || st === 'Verspätet' || st.toLowerCase() === 'late');
    const isAbs  = (st === 'غياب' || st === 'Abwesend' || st.toLowerCase() === 'absent');

    if(isLate){
      return {
        title: de ? '⚠️ Verspätung' : '⚠️ تنبيه تأخير',
        body:  de ? `Hinweis: Der Schüler ist am ${date} verspätet.` : `تنبيه: الطالب تأخر بتاريخ ${date}.`
      };
    }
    if(isAbs){
      return {
        title: de ? '⚠️ Abwesenheit' : '⚠️ تنبيه غياب',
        body:  de ? `Hinweis: Der Schüler war am ${date} abwesend.` : `تنبيه: الطالب تغيب بتاريخ ${date}.`
      };
    }
    return {
      title: de ? '⚠️ Hinweis' : '⚠️ تنبيه',
      body:  de ? `Es gibt einen neuen Hinweis (${date}).` : `يوجد تنبيه جديد (${date}).`
    };
  }

  // Homework
  if(a.type === 'homework'){
    const date = a.date || '';
    const info = decodeHomeworkSurah(a.surah || '');
    const range = (a.start && a.end) ? ` (${a.start}-${a.end})` : '';
    if(info.kind === 'text'){
      const txt = info.freeText || '';
      return {
        title: de ? '📝 Neue Hausaufgabe' : '📝 واجب جديد',
        body:  de ? `Datum: ${date}\n\n${txt}` : `التاريخ: ${date}\n\n${txt}`
      };
    }
    const label = info.label || (de ? 'Hausaufgabe' : 'واجب');
    return {
      title: de ? '📝 Neue Hausaufgabe' : '📝 واجب جديد',
      body:  de ? `Datum: ${date}\n${label}${range}` : `التاريخ: ${date}\n${label}${range}`
    };
  }

  // Evaluation / Note
  if(a.type === 'evaluation'){
    const date = a.date || '';
    const note = String(a.note || '').trim();
    const mem = String(a.memorization || '').trim();
    const taj = String(a.tajweed || '').trim();
    const beh = String(a.behavior || '').trim();

    let lines = [];
    if(mem) lines.push((de ? 'Hifz: ' : 'حفظ: ') + mem);
    if(taj) lines.push((de ? 'Tajweed: ' : 'تجويد: ') + taj);
    if(beh) lines.push((de ? 'Verhalten: ' : 'سلوك: ') + beh);
    if(note) lines.push((de ? 'Notiz: ' : 'ملاحظة: ') + note);

    const body = (de ? `Datum: ${date}` : `التاريخ: ${date}`) + (lines.length ? `\n\n${lines.join('\n')}` : '');
    return {
      title: de ? '📌 Neue Notiz/Bewertung' : '📌 ملاحظة/تقييم جديد',
      body
    };
  }

  // Fallback
  return {
    title: de ? '📢 Neuer Hinweis' : '📢 تنبيه جديد',
    body:  String(a.message || a.body || '')
  };
}

function showCurrentStudentAlert(){
  const arr = state.popupAlerts || [];
  const idx = Number(state.popupAlertIndex || 0);
  const a = arr[idx];
  if(!a) return;

  const txt = buildStudentAlertText(a);

  const titleEl = document.getElementById('alert-modal-title');
  const bodyEl  = document.getElementById('alert-modal-body');
  const cntEl   = document.getElementById('alert-modal-counter');
  const btnOk   = document.getElementById('alert-modal-confirm');
  const btnCls  = document.getElementById('alert-modal-close');

  if(titleEl) titleEl.innerText = txt.title || '';
  if(bodyEl)  bodyEl.innerText  = txt.body  || '';
  if(cntEl)   cntEl.innerText   = `${idx + 1} / ${arr.length}`;

  if(btnOk)  btnOk.innerText  = (state.lang === 'de' ? 'Gelesen bestätigen' : 'تأكيد القراءة');
  if(btnCls) btnCls.innerText = (state.lang === 'de' ? 'Schließen' : 'إغلاق');

  openModal('alert-modal', { noHistory:true });
}

function closeStudentAlertModal(){
  closeModal('alert-modal', { noHistory:true });
}

async function confirmStudentAlertRead(){
  const arr = state.popupAlerts || [];
  const idx = Number(state.popupAlertIndex || 0);
  const a = arr[idx];
  if(!a?.id) { closeStudentAlertModal(); return; }

  try{
    await fetch(WEB_APP_URL, {
      method:'POST',
      headers: { "Content-Type": "text/plain" },
      body: JSON.stringify({ action:'markStudentAlertRead', studentRef: state.studentData.referenz, alertId: a.id })
    }).then(r=>r.json());
  }catch(e){}

  // next alert
  state.popupAlertIndex = idx + 1;
  if(arr[state.popupAlertIndex]){
    showCurrentStudentAlert();
  } else {
    closeStudentAlertModal();
    state.popupAlerts = [];
    state.popupAlertIndex = 0;
  }
}

// Close WITHOUT confirming: will show again next login/poll until confirmed.
function dismissStudentAlertTemporarily(){
  closeStudentAlertModal();
}


// --- Student Notifications (Browser notifications while app is open) ---
function studentNotifEnabledKey(){
  return `qs_stu_notif_enabled:${state.studentData?.referenz || 'unknown'}`;
}
function studentLastHwKey(){
  return `qs_stu_last_hw:${state.studentData?.referenz || 'unknown'}`;
}
function studentLastEvKey(){
  return `qs_stu_last_ev:${state.studentData?.referenz || 'unknown'}`;
}
function isStudentNotificationsEnabled(){
  try{ return localStorage.getItem(studentNotifEnabledKey()) === '1'; }catch(e){ return false; }
}
function setStudentNotificationsEnabled(on){
  try{ localStorage.setItem(studentNotifEnabledKey(), on ? '1' : '0'); }catch(e){}
}
function setStuNotifStatus(text){
  const el = document.getElementById('stu-notif-status');
  if(el) el.innerText = text || '';
}
function initStudentNotificationsUI(){
  const box = document.getElementById('chk-stu-notif');
  const hint = document.getElementById('stu-notif-hint');
  const head = document.getElementById('stu-notif-head');
  const lbl  = document.getElementById('stu-notif-label');

  // i18n (simple inline)
  if(head) head.innerText = (state.lang === 'de' ? 'Benachrichtigungen' : 'تنبيهات');
  if(hint) hint.innerText = (state.lang === 'de'
    ? 'Aktiviere Browser-Benachrichtigungen für neue Hausaufgaben / Notizen (solange die Seite geöffnet ist).'
    : 'فعّل تنبيهات المتصفح عند وصول واجبات أو ملاحظات جديدة (طالما الصفحة مفتوحة).');
  if(lbl) lbl.innerText = (state.lang === 'de'
    ? 'Bei neuen Einträgen benachrichtigen'
    : 'تنبيه عند وصول جديد');

  if(!box) return;

  const supported = ('Notification' in window);
  box.disabled = !supported;
  box.checked = isStudentNotificationsEnabled() && supported;

  if(!supported){
    setStuNotifStatus(state.lang === 'de' ? 'Nicht unterstützt in diesem Browser.' : 'غير مدعوم في هذا المتصفح.');
  } else {
    setStuNotifStatus('');
  }
}

// --- Small "red dot" badges for tabs (new items) ---
function showDotBadge(badgeId, show){
  const el = document.getElementById(badgeId);
  if(!el) return;
  el.classList.toggle('hidden', !show);
}
function clearStudentBadgeForTab(tabId){
  if(tabId === 'student-homework') showDotBadge('badge-stu-hw', false);
  if(tabId === 'student-rating')  showDotBadge('badge-stu-rate', false);
}

// --- Change Student PIN (from Parent tab) ---
function updateRememberedPin(newPin){
  try{
    const raw = localStorage.getItem(rememberedKey());
    if(!raw) return;
    const obj = JSON.parse(raw);
    if(obj && obj.remember){
      obj.pin = newPin;
      localStorage.setItem(rememberedKey(), JSON.stringify(obj));
    }
  }catch(e){}
}
function setStuPinStatus(text){
  const el = document.getElementById('stu-pin-status');
  if(el) el.textContent = text || '';
}

async function changeStudentPin(){
  if(!state.studentData?.referenz){
    showToast(state.lang === 'de' ? 'Student nicht erkannt.' : 'لم يتم التعرف على الطالب.');
    return;
  }
  const oldPin = (document.getElementById('stu-old-pin')?.value || '').trim();
  const newPin = (document.getElementById('stu-new-pin')?.value || '').trim();
  const newPin2 = (document.getElementById('stu-new-pin2')?.value || '').trim();

  if(!newPin || newPin.length < 4){
    showToast(state.lang === 'de' ? 'Bitte neue PIN (mind. 4 Zeichen) eingeben.' : 'الرجاء إدخال رقم سري جديد (٤ أرقام على الأقل).');
    return;
  }
  if(newPin !== newPin2){
    showToast(state.lang === 'de' ? 'PIN-Bestätigung stimmt nicht.' : 'تأكيد الرقم السري غير مطابق.');
    return;
  }

  setStuPinStatus(state.lang === 'de' ? 'Speichern…' : 'جارٍ الحفظ…');

  try{
    const res = await fetch(WEB_APP_URL, {
      method:'POST',
      headers: { "Content-Type": "text/plain" },
      body: JSON.stringify({
        action: 'changeStudentPin',
        studentRef: state.studentData.referenz,
        oldPin: oldPin,
        newPin: newPin
      })
    }).then(r=>r.json());

    if(res && res.ok){
      showToast(state.lang === 'de' ? 'PIN geändert' : 'تم تغيير الرقم السري');
      updateRememberedPin(newPin);
      setStuPinStatus(state.lang === 'de' ? 'Erfolgreich gespeichert.' : 'تم الحفظ بنجاح.');
      ['stu-old-pin','stu-new-pin','stu-new-pin2'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
    } else {
      const msg = (res && res.error) ? res.error : (state.lang === 'de' ? 'Fehler beim Speichern.' : 'حدث خطأ أثناء الحفظ.');
      showToast(msg);
      setStuPinStatus(msg);
    }
  }catch(e){
    const msg = (state.lang === 'de' ? 'Verbindungsfehler: ' : 'خطأ في الاتصال: ') + (e?.message || e);
    showToast(msg);
    setStuPinStatus(msg);
  }
}



async function toggleStudentNotifications(){
  const box = document.getElementById('chk-stu-notif');
  if(!box) return;

  if(!('Notification' in window)){
    box.checked = false;
    setStuNotifStatus(state.lang === 'de' ? 'Nicht unterstützt in diesem Browser.' : 'غير مدعوم في هذا المتصفح.');
    return;
  }

  const wantOn = !!box.checked;

  if(wantOn){
    // Request permission
    let ok = false;
    try{
      if(Notification.permission === 'granted') ok = true;
      else if(Notification.permission === 'denied') ok = false;
      else {
        const perm = await Notification.requestPermission();
        ok = (perm === 'granted');
      }
    }catch(e){ ok = false; }

    if(!ok){
      box.checked = false;
      setStudentNotificationsEnabled(false);
      setStuNotifStatus(state.lang === 'de'
        ? 'Benachrichtigungen sind blockiert. Bitte im Browser erlauben.'
        : 'التنبيهات محجوبة. يرجى السماح بها من إعدادات المتصفح.');
      return;
    }

    setStudentNotificationsEnabled(true);
    setStuNotifStatus(state.lang === 'de' ? '✅ Aktiviert.' : '✅ تم التفعيل.');
    startStudentPolling();
    // Small test notification (optional)
    try{ new Notification(state.lang === 'de' ? 'Benachrichtigungen aktiv' : 'تم تفعيل التنبيهات', { body: state.lang === 'de' ? 'Du wirst bei neuen Einträgen informiert.' : 'سيصلك تنبيه عند وصول جديد.' }); }catch(e){}
  } else {
    setStudentNotificationsEnabled(false);
    stopStudentPolling();
    setStuNotifStatus(state.lang === 'de' ? 'Deaktiviert.' : 'تم الإيقاف.');
  }
}

function stopStudentPolling(){
  if(studentPollingInterval) clearInterval(studentPollingInterval);
  studentPollingInterval = null;
  studentPollingPrimed = false;
}

function makeItemSig(obj, keys){
  try{
    return keys.map(k => String(obj?.[k] ?? '')).join('|');
  }catch(e){
    return '';
  }
}

function dateKey(raw){
  const s = String(raw || '').trim();
  if(!s) return '';
  const mIso = s.match(/(\d{4})-(\d{2})-(\d{2})/);
  if(mIso) return `${mIso[1]}${mIso[2]}${mIso[3]}` + (s.match(/(\d{2}):(\d{2})/) ? s.match(/(\d{2}):(\d{2})/)[0].replace(':','') : '');
  const mDe = s.match(/(\d{2})\.(\d{2})\.(\d{4})/);
  if(mDe) return `${mDe[3]}${mDe[2]}${mDe[1]}` + (s.match(/(\d{2}):(\d{2})/) ? s.match(/(\d{2}):(\d{2})/)[0].replace(':','') : '');
  const d = new Date(s);
  if(!isNaN(d.getTime())){
    return `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}${String(d.getHours()).padStart(2,'0')}${String(d.getMinutes()).padStart(2,'0')}`;
  }
  return s;
}

function pickLatest(list, dateField){
  if(!Array.isArray(list) || list.length === 0) return null;
  let best = list[0];
  let bestKey = dateKey(best[dateField]);
  for(const it of list){
    const k = dateKey(it?.[dateField]);
    if(String(k) > String(bestKey)){
      best = it;
      bestKey = k;
    }
  }
  return best;
}

async function checkStudentUpdates({baseline=false} = {}){
  if(!state.studentData?.referenz) return;

  // Fetch homework + evaluations
  let hwRes = null, evRes = null;
  try{
    hwRes = await fetch(WEB_APP_URL, {
      method:'POST',
      headers: { "Content-Type": "text/plain" },
      body: JSON.stringify({ action: 'getStudentHomework', studentRef: state.studentData.referenz })
    }).then(r=>r.json());
  }catch(e){}
  try{
    evRes = await fetch(WEB_APP_URL, {
      method:'POST',
      headers: { "Content-Type": "text/plain" },
      body: JSON.stringify({ action: 'getStudentEvaluations', studentRef: state.studentData.referenz })
    }).then(r=>r.json());
  }catch(e){}

  // Homework
  if(hwRes && hwRes.ok && Array.isArray(hwRes.homework)){
    const latestHw = pickLatest(hwRes.homework, 'date');
    const sigHw = latestHw ? (dateKey(latestHw.date) + '|' + makeItemSig(latestHw, ['surah','start','end','date'])) : '';
    const prev = localStorage.getItem(studentLastHwKey()) || '';
    if(!studentPollingPrimed || baseline){
      try{ localStorage.setItem(studentLastHwKey(), sigHw); }catch(e){}
    } else if(sigHw && sigHw !== prev){
      try{ localStorage.setItem(studentLastHwKey(), sigHw); }catch(e){}
      const title = (state.lang === 'de' ? 'Neue Hausaufgabe' : 'واجب جديد');
      const body  = (state.lang === 'de' ? 'Es gibt eine neue Hausaufgabe.' : 'وصل واجب جديد.');
      showToast(body);
      if(isStudentNotificationsEnabled() && Notification.permission === 'granted'){
        try{ new Notification(title, { body }); }catch(e){}
      }
      // refresh UI if visible
      showDotBadge('badge-stu-hw', true);
      loadStudentHomework();
      // Also show as popup alert (until confirmed)
      fetchStudentPopupAlerts();
    }
  }

  // Evaluations / notes
  if(evRes && evRes.ok && Array.isArray(evRes.evaluations)){
    const latestEv = pickLatest(evRes.evaluations, 'date');
    const sigEv = latestEv ? (dateKey(latestEv.date) + '|' + makeItemSig(latestEv, ['memorization','tajweed','behavior','note','date'])) : '';
    const prev = localStorage.getItem(studentLastEvKey()) || '';
    if(!studentPollingPrimed || baseline){
      try{ localStorage.setItem(studentLastEvKey(), sigEv); }catch(e){}
    } else if(sigEv && sigEv !== prev){
      try{ localStorage.setItem(studentLastEvKey(), sigEv); }catch(e){}
      const title = (state.lang === 'de' ? 'Neue Notiz/Bewertung' : 'ملاحظة/تقييم جديد');
      const body  = (state.lang === 'de' ? 'Es gibt eine neue Notiz oder Bewertung.' : 'وصلت ملاحظة أو تقييم جديد.');
      showToast(body);
      if(isStudentNotificationsEnabled() && Notification.permission === 'granted'){
        try{ new Notification(title, { body }); }catch(e){}
      }
      showDotBadge('badge-stu-rate', true);
      loadStudentEvaluations();
      // Also show as popup alert (until confirmed)
      fetchStudentPopupAlerts();
    }
  }

  studentPollingPrimed = true;
}

function startStudentPolling(){
  stopStudentPolling();
  // Prime baseline once so we don’t notify on first login
  checkStudentUpdates({baseline:true});
  studentPollingInterval = setInterval(() => checkStudentUpdates(), 30000);
}


function loadStudentHomework() {
  return fetch(WEB_APP_URL, {
      method: 'POST',
      headers: { "Content-Type": "text/plain" },
      body: JSON.stringify({ action: 'getStudentHomework', studentRef: state.studentData.referenz })
  }).then(r=>r.json()).then(res => {
      const cont = document.getElementById('student-homework-list');
      cont.innerHTML = '';

      if(res.ok && res.homework && res.homework.length > 0) {
          res.homework.forEach(hw => {
             const info = decodeHomeworkSurah(hw.surah);
             const meta = `${escapeHtml(dateOnly(hw.date || ''))}`;

             // Free-text homework
             if(info.kind === 'text'){
               const txt = info.freeText || '';
               cont.innerHTML += `
               <div class="card flex-col" style="align-items:flex-start; padding:12px; margin-bottom:6px;">
                 <div style="font-weight:bold; color:var(--primary);">📝 ${state.lang === 'de' ? 'Hausaufgabe' : 'واجب'}</div>
                 ${txt ? `<div class="text-sm" style="white-space:pre-wrap;">${escapeHtml(txt)}</div>` : ''}
                 <div class="text-sm text-sec">${meta}</div>
               </div>`;
               return;
             }

             // Verse-based homework (normal or memorized)
             const badge = info.badge ? `<span style="font-size:0.72rem; padding:2px 8px; border-radius:999px; border:1px solid var(--border); background:var(--surface-2); margin-inline-start:6px;">${escapeHtml(info.badge)}</span>` : '';
             const range = (hw.start && hw.end) ? `${escapeHtml(hw.start)} - ${escapeHtml(hw.end)}` : '';
             const canOpen = !!info.surahNum && !!hw.start && !!hw.end;

             cont.innerHTML += `
             <div class="card flex-col" style="align-items:flex-start; padding:12px; margin-bottom:6px;">
                 <div style="font-weight:bold; color:var(--primary);">${escapeHtml(info.label)} ${badge}</div>
                 ${range ? `<div class="text-sm">${state.lang === 'de' ? 'Verse' : 'الآيات'}: ${range}</div>` : ''}
                 <div class="text-sm text-sec">${meta}</div>
                 ${canOpen ? `<button class="btn" style="width:100%; margin-top:8px;" onclick="openLesson(${info.surahNum}, ${parseInt(hw.start,10)}, ${parseInt(hw.end,10)}, {viewMode:'memorize'})">📖 ${state.lang === 'de' ? 'Öffnen' : 'فتح'}</button>` : ''}
             </div>`;
          });
      } else {
          cont.innerHTML = `<div class="text-sec text-center">${state.lang === 'de' ? 'Keine Hausaufgaben.' : 'لا توجد واجبات.'}</div>`;
      }
  });
}

function evalToStars(text) {
  const t = String(text || '').trim().toLowerCase();
  if(!t) return null;
  if (t.includes('sehr gut') || t.includes('ممتاز')) return 5;
  if (t.includes('gut') || t.includes('جيد')) return 4;
  if (t.includes('mittel') || t.includes('متوسط')) return 3;
  if (t.includes('schwach') || t.includes('ضعيف')) return 2;
  return 3;
}

function renderStars(n) {
  n = Math.max(0, Math.min(5, n|0));
  return '★★★★★'.slice(0,n) + '☆☆☆☆☆'.slice(0,5-n);
}

function gradeFromStars(stars){
  const s = Math.max(0, Math.min(5, Number(stars) || 0));
  // 1 = best, 6 = worst
  return Math.max(1, Math.min(6, 6 - Math.round(s)));
}

function isLateStatus(status){
  const st = String(status || '').trim().toLowerCase();
  return (st === 'تأخير' || st === 'verspätet' || st === 'late' || st.includes('versp'));
}
function isAbsentStatus(status){
  const st = String(status || '').trim().toLowerCase();
  return (st === 'غياب' || st === 'abwesend' || st === 'absent' || st.includes('abw'));
}

async function loadStudentEvaluations() {
  try{
    if(!state.studentData?.referenz) return;

    const res = await fetch(WEB_APP_URL, {
      method: 'POST',
      headers: { "Content-Type": "text/plain" },
      body: JSON.stringify({ action: 'getStudentEvaluations', studentRef: state.studentData.referenz })
    }).then(r=>r.json());

    const starsSummaryEl = document.getElementById('akte-eval-stars');
    const gradeSummaryEl = document.getElementById('akte-eval-grade');
    const listEl = document.getElementById('akte-eval-history-list');

    const evaluations = (res && res.ok && Array.isArray(res.evaluations)) ? res.evaluations : [];
    state.studentEvaluations = evaluations;
    state.studentEvaluationsLoaded = true;

    if(listEl) listEl.innerHTML = '';

    let allStars = [];

    if(evaluations.length > 0) {
      evaluations.forEach(ev => {
        const hasRating = !!String((ev.memorization||'') + (ev.tajweed||'') + (ev.behavior||'') + (ev.attendance||'')).trim();
        const d = escapeHtml(dateOnly(ev.date || ev.timestamp || ''));

        // NOTE ONLY (no rating fields)
        if(!hasRating){
          if(listEl){
            listEl.innerHTML += `
              <div class="card flex-col" style="align-items:flex-start; padding:12px; margin-bottom:6px;">
                <div style="font-weight:bold;">${d}</div>
                <div class="text-sm" style="margin-top:6px; font-style:italic;">📝 ${state.lang === 'de' ? 'Notiz' : 'ملاحظة'}</div>
                ${ev.note ? `<div class="text-sm" style="margin-top:6px; font-style:italic;">"${escapeHtml(ev.note)}"</div>` : ''}
              </div>`;
          }
          return;
        }

        const s1 = evalToStars(ev.memorization);
        const s2 = evalToStars(ev.tajweed);
        const parts = [s1, s2].filter(x => x !== null);
        const s = parts.length ? Math.round(parts.reduce((a,b)=>a+b,0) / parts.length) : null;
        if(s !== null) allStars.push(s);

        const grade = (s === null) ? null : gradeFromStars(s);

        if(listEl){
          listEl.innerHTML += `
            <div class="card flex-col" style="align-items:flex-start; padding:12px; margin-bottom:6px;">
              <div style="display:flex; width:100%; justify-content:space-between; align-items:flex-start; gap:10px;">
                <div style="font-weight:bold;">${d}</div>
                <div style="text-align:right;">
                  <div style="font-weight:900;">${s === null ? '—' : (renderStars(s) + ' (' + s + '/5)')}</div>
                  <div class="text-sm text-sec">${grade === null ? '' : ((state.lang==='de' ? 'Note' : 'التقييم') + ': ' + grade)}</div>
                </div>
              </div>
              <div class="text-sm" style="margin-top:6px;">${state.lang === 'de' ? 'Hifz' : 'الحفظ'}:
                <span style="font-weight:bold;">${s1 === null ? '—' : (renderStars(s1) + ' (' + escapeHtml(ev.memorization) + ')')}</span>
              </div>
              <div class="text-sm">${state.lang === 'de' ? 'Tajweed' : 'التجويد'}:
                <span style="font-weight:bold;">${s2 === null ? '—' : (renderStars(s2) + ' (' + escapeHtml(ev.tajweed) + ')')}</span>
              </div>
              ${ev.note ? `<div class="text-sm" style="margin-top:6px; font-style:italic;">"${escapeHtml(ev.note)}"</div>` : ''}
            </div>`;
        }
      });

      if(allStars.length > 0){
        const avg = Math.round(allStars.reduce((a,b)=>a+b,0)/allStars.length);
        const gradeAvg = gradeFromStars(avg);
        if(starsSummaryEl) starsSummaryEl.innerText = renderStars(avg) + `  (${avg}/5)`;
        if(gradeSummaryEl) gradeSummaryEl.innerText = (state.lang === 'de' ? `Note: ${gradeAvg}` : `التقييم: ${gradeAvg}`);
      } else {
        if(starsSummaryEl) starsSummaryEl.innerText = '—';
        if(gradeSummaryEl) gradeSummaryEl.innerText = '—';
      }
    } else {
      if(listEl){
        listEl.innerHTML = `<div class="text-sec text-center">${state.lang === 'de' ? 'Keine Einträge.' : 'لا توجد سجلات.'}</div>`;
      }
      if(starsSummaryEl) starsSummaryEl.innerText = '—';
      if(gradeSummaryEl) gradeSummaryEl.innerText = '—';
    }
  }catch(e){
    // Graceful fallback
    const starsSummaryEl = document.getElementById('akte-eval-stars');
    const gradeSummaryEl = document.getElementById('akte-eval-grade');
    const listEl = document.getElementById('akte-eval-history-list');
    if(listEl) listEl.innerHTML = `<div class="text-sec text-center">${state.lang === 'de' ? 'Fehler beim Laden.' : 'تعذر تحميل البيانات.'}</div>`;
    if(starsSummaryEl) starsSummaryEl.innerText = '—';
    if(gradeSummaryEl) gradeSummaryEl.innerText = '—';
  }
}

async function loadStudentAttendance(){
  try{
    if(!state.studentData?.referenz) return;

    const res = await fetch(WEB_APP_URL, {
      method: 'POST',
      headers: { "Content-Type": "text/plain" },
      body: JSON.stringify({ action: 'getStudentAttendance', studentRef: state.studentData.referenz })
    }).then(r=>r.json());

    const lateCountEl = document.getElementById('akte-att-late-count');
    const absCountEl  = document.getElementById('akte-att-abs-count');
    const listEl = document.getElementById('akte-att-history-list');

    const records = (res && res.ok && Array.isArray(res.records)) ? res.records : [];
    state.studentAttendance = records;
    state.studentAttendanceLoaded = true;

    let lateCount = 0, absCount = 0;
    for(const r of records){
      if(isLateStatus(r.status)) lateCount++;
      else if(isAbsentStatus(r.status)) absCount++;
    }

    if(lateCountEl) lateCountEl.innerText = String(lateCount);
    if(absCountEl)  absCountEl.innerText  = String(absCount);

    if(listEl){
      listEl.innerHTML = '';
      if(records.length === 0){
        listEl.innerHTML = `<div class="text-sec text-center">${state.lang === 'de' ? 'Keine Einträge.' : 'لا توجد سجلات.'}</div>`;
      } else {
        records.forEach(r => {
          const d = escapeHtml(dateOnly(r.date || ''));
          const st = String(r.status || '').trim();
          const late = isLateStatus(st);
          const abs  = isAbsentStatus(st);
          const col = abs ? 'var(--danger)' : (late ? 'var(--warning)' : 'var(--text)');
          listEl.innerHTML += `
            <div class="card flex-col" style="align-items:flex-start; padding:12px; margin-bottom:6px;">
              <div style="display:flex; width:100%; justify-content:space-between; align-items:center; gap:10px;">
                <div style="font-weight:bold;">${d}</div>
                <div style="font-weight:900; color:${col};">${escapeHtml(st)}</div>
              </div>
            </div>`;
        });
      }
    }

  }catch(e){
    const lateCountEl = document.getElementById('akte-att-late-count');
    const absCountEl  = document.getElementById('akte-att-abs-count');
    const listEl = document.getElementById('akte-att-history-list');
    if(lateCountEl) lateCountEl.innerText = '0';
    if(absCountEl)  absCountEl.innerText  = '0';
    if(listEl) listEl.innerHTML = `<div class="text-sec text-center">${state.lang === 'de' ? 'Fehler beim Laden.' : 'تعذر تحميل البيانات.'}</div>`;
  }
}


// --- Student: Fortschritt / تقدمي (confirmed memorization ranges) ---
state.studentProgress = state.studentProgress || [];
state.studentProgressLoaded = state.studentProgressLoaded || false;

// Merge overlapping/adjacent ranges within a surah (e.g. 1-6 then 3-10 => 1-10)
function mergeRanges_(ranges){
  const arr = (Array.isArray(ranges) ? ranges : [])
    .map(r => ({ start: Number(r.start||0), end: Number(r.end||0) }))
    .filter(r => Number.isFinite(r.start) && Number.isFinite(r.end) && r.start >= 1 && r.end >= r.start)
    .map(r => ({ start: Math.floor(r.start), end: Math.floor(r.end) }))
    .sort((a,b)=> a.start - b.start);

  const out = [];
  for(const r of arr){
    if(!out.length){ out.push({start:r.start, end:r.end}); continue; }
    const last = out[out.length-1];
    if(r.start <= last.end + 1){
      last.end = Math.max(last.end, r.end);
    } else {
      out.push({start:r.start, end:r.end});
    }
  }
  return out;
}

// Normalize + group progress by surah and merge ranges (prevents double count)
function normalizeStudentProgress_(progress){
  const arr = Array.isArray(progress) ? progress : [];
  const byKey = new Map();

  for(const p of arr){
    const surahText = String(p?.surahText ?? p?.surah ?? '').trim();
    const surahNum = parseSurahNumber(surahText);
    const key = surahNum ? `N:${surahNum}` : `T:${surahText}`;
    if(!surahText && !surahNum) continue;

    const entry = byKey.get(key) || {
      surahNum: surahNum || null,
      surahText: surahText || (surahNum ? String(surahNum) : ''),
      ranges: [],
      lastUpdatedKey: ''
    };

    const lk = String(p?.lastUpdatedKey ?? p?.lastUpdated ?? p?.updated ?? '').trim();
    if(lk && lk > String(entry.lastUpdatedKey || '')) entry.lastUpdatedKey = lk;

    const ranges = Array.isArray(p?.ranges) ? p.ranges : [];
    ranges.forEach(r => entry.ranges.push({ start: r?.start, end: r?.end }));

    byKey.set(key, entry);
  }

  const out = [];
  for(const entry of byKey.values()){
    const totalAyahs = entry.surahNum ? getSurahAyahCount(entry.surahNum) : 0;

    // Clamp + merge ranges
    let ranges = (entry.ranges || []).map(r => ({
      start: Math.max(1, Math.floor(Number(r.start || 0))),
      end: Math.floor(Number(r.end || 0))
    })).filter(r => Number.isFinite(r.start) && Number.isFinite(r.end) && r.end >= r.start);

    if(totalAyahs){
      ranges = ranges.map(r => ({ start: r.start, end: Math.min(totalAyahs, r.end) }))
                     .filter(r => r.end >= r.start);
    }

    ranges = mergeRanges_(ranges);

    const memorizedAyahs = ranges.reduce((acc, r) => acc + (r.end - r.start + 1), 0);
    const denom = totalAyahs || Math.max(0, ...ranges.map(r => r.end), 0);
    const pct = denom ? Math.min(100, Math.floor((memorizedAyahs / denom) * 100)) : 0;
    const complete = denom ? (memorizedAyahs >= denom) : false;

    out.push({
      ...entry,
      ranges,
      memorizedAyahs,
      totalAyahs: denom,
      pct,
      complete
    });
  }

  out.sort((a,b) => {
    const na = a.surahNum || 9999;
    const nb = b.surahNum || 9999;
    if(na !== nb) return na - nb;
    return String(a.surahText||'').localeCompare(String(b.surahText||''));
  });

  return out;
}

function fmtPct_(n){
  n = Math.max(0, Math.min(100, Number(n || 0)));
  return state.lang === 'ar' ? `${n}٪` : `${n}%`;
}

function buildProgressInlineHtml_(progress){
  const arr = Array.isArray(progress) ? progress.slice() : [];
  if(!arr.length) return '';

  // newest surahs on top (by last update), then by surah number
  arr.sort((a,b) => {
    const ka = String(a.lastUpdatedKey || '');
    const kb = String(b.lastUpdatedKey || '');
    if(kb !== ka) return kb.localeCompare(ka);

    const na = a.surahNum || parseSurahNumber(a.surahText || '') || 0;
    const nb = b.surahNum || parseSurahNumber(b.surahText || '') || 0;
    return na - nb;
  });

  return arr.map(p => {
    const surahNum = p.surahNum || parseSurahNumber(p.surahText || '');
    const label = surahNum ? getSurahLabel(surahNum) : (p.surahText || '');
    const safe = escapeHtml(label);

    if(p.complete){
      // complete: green, no percentage
      return `<div class="prog-item complete">${safe}</div>`;
    }
    // partial: red + percentage
    return `<div class="prog-item partial">${safe} ${escapeHtml(fmtPct_(p.pct))}</div>`;
  }).join('');
}


function calcTotalAyahs_(progress){
  let total = 0;
  (progress || []).forEach(p => {
    if(Number.isFinite(Number(p.memorizedAyahs))){
      total += Number(p.memorizedAyahs);
      return;
    }
    (p.ranges || []).forEach(r => {
      const s = Number(r.start || 0);
      const e = Number(r.end || 0);
      if(!isNaN(s) && !isNaN(e) && e >= s) total += (e - s + 1);
    });
  });
  return total;
}

function progressLastLabel_(progress){
  const arr = (progress || []).slice();
  arr.sort((a,b)=> String(b.lastUpdatedKey||'').localeCompare(String(a.lastUpdatedKey||'')));
  const p = arr[0];
  if(!p) return '—';
  const surahNum = p.surahNum || parseSurahNumber(p.surahText || '');
  const label = surahNum ? getSurahLabel(surahNum) : (p.surahText || '');
  const ranges = (p.ranges || []).map(r => `${r.start}-${r.end}`).join(', ');
  return (label && ranges) ? `${label} (${ranges})` : (label || ranges || '—');
}

async function loadStudentProgress(){
  try{
    if(!state.studentData?.referenz) return;

    const res = await fetch(WEB_APP_URL, {
      method: 'POST',
      headers: { "Content-Type": "text/plain" },
      body: JSON.stringify({ action: 'getStudentProgress', studentRef: state.studentData.referenz })
    }).then(r=>r.json());

    const progressRaw = (res && res.ok && Array.isArray(res.progress)) ? res.progress : [];
    const progress = normalizeStudentProgress_(progressRaw);

    state.studentProgress = progress;
    state.studentProgressLoaded = true;

    const sumEl = document.getElementById('akte-prog-sum');
    const lastEl = document.getElementById('akte-prog-last');

    if(sumEl){
      if(progress.length){
        sumEl.innerHTML = buildProgressInlineHtml_(progress);
      }else{
        sumEl.textContent = '—';
      }
    }

    if(lastEl){
      const totalAyahs = calcTotalAyahs_(progress);
      lastEl.textContent = progress.length
        ? (state.lang === 'de' ? `${totalAyahs} Verse` : `${totalAyahs} آية`)
        : '—';
    }

    renderStudentProgressList(progress);
    renderStudentHomeAchievements();
  }catch(e){
    state.studentProgress = [];
    state.studentProgressLoaded = true;
    renderStudentProgressList([]);
    renderStudentHomeAchievements();
    const sumEl = document.getElementById('akte-prog-sum');
    const lastEl = document.getElementById('akte-prog-last');
    if(sumEl) sumEl.textContent = '—';
    if(lastEl) lastEl.textContent = '—';
  }
}

function renderStudentProgressList(progress){
  const listEl = document.getElementById('akte-prog-history-list');
  if(!listEl) return;
  listEl.innerHTML = '';

  const arr = Array.isArray(progress) ? progress : [];
  if(arr.length === 0){
    listEl.innerHTML = `<div class="text-sec text-center">${state.lang === 'de' ? 'Noch keine Einträge.' : 'لا توجد إنجازات بعد.'}</div>`;
    return;
  }

  const sorted = arr.slice().sort((a,b) => {
    const na = a.surahNum || parseSurahNumber(a.surahText || '') || 9999;
    const nb = b.surahNum || parseSurahNumber(b.surahText || '') || 9999;
    if(na !== nb) return na - nb;
    return String(a.surahText||'').localeCompare(String(b.surahText||''));
  });

  sorted.forEach(p => {
    const surahNum = p.surahNum || parseSurahNumber(p.surahText || '');
    const label = surahNum ? getSurahLabel(surahNum) : (p.surahText || '');
    const ranges = (p.ranges || []).map(r => `${r.start} – ${r.end}`).join(' , ');

    const titleHtml = p.complete
      ? `<span class="prog-item complete">${escapeHtml(label)}</span>`
      : `<span class="prog-item partial">${escapeHtml(label)} ${escapeHtml(fmtPct_(p.pct))}</span>`;

    const metaRight = (p.totalAyahs && p.memorizedAyahs)
      ? `${p.memorizedAyahs}/${p.totalAyahs}`
      : (state.lang === 'de' ? `${(p.memorizedAyahs||0)} Verse` : `${(p.memorizedAyahs||0)} آية`);

    listEl.innerHTML += `
      <div class="card flex-col" style="align-items:flex-start; padding:12px;">
        <div style="display:flex; width:100%; justify-content:space-between; align-items:flex-start; gap:10px;">
          <div style="font-weight:bold;">${titleHtml}</div>
          <div class="text-sm text-sec" style="white-space:nowrap;">${escapeHtml(metaRight)}</div>
        </div>
        ${ranges ? `<div class="text-sm" style="margin-top:6px;">${state.lang === 'de' ? 'Bereich' : 'النطاق'}: <b>${escapeHtml(ranges)}</b></div>` : ''}
      </div>
    `;
  });
}

async function openStudentAkteProgress(){
  if(!state.studentProgressLoaded) await loadStudentProgress();
  openModal('stu-akte-prog-modal');
}

function renderStudentHomeAchievements(){
  const cont = document.getElementById('student-home-achievements');
  if(!cont) return;

  const progress = state.studentProgress || [];
  cont.innerHTML = '';

  cont.innerHTML += `
    <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-top:6px;">
      <div style="font-weight:800;" id="stu-home-ach-head">${state.lang === 'de' ? 'Meine Erfolge' : 'إنجازاتي'}</div>
      <div class="text-sm text-sec">${progress.length ? (state.lang === 'de' ? `${progress.length} Suren` : `${progress.length} سور`) : ''}</div>
    </div>
  `;

  if(!progress.length){
    cont.innerHTML += `<div class="text-sec text-center" style="padding:8px 0;">${state.lang === 'de' ? 'Noch keine bestätigten Fortschritte.' : 'لا توجد إنجازات مؤكدة حتى الآن.'}</div>`;
    return;
  }

  const totalAyahs = calcTotalAyahs_(progress);
  const lastLabel = progressLastLabel_(progress);

  cont.innerHTML += `
    <div class="card flex-col" style="align-items:flex-start; padding:12px; margin-top:8px;">
      <div style="display:flex; width:100%; justify-content:space-between; align-items:flex-start; gap:10px;">
        <div style="font-weight:800; color:var(--primary);">${state.lang === 'de' ? 'Fortschritt' : 'تقدمي'}</div>
        <div class="text-sm text-sec" style="white-space:nowrap;">${state.lang === 'de' ? `${totalAyahs} Verse` : `${totalAyahs} آية`}</div>
      </div>
      <div class="prog-inline" style="justify-content:flex-start; margin-top:8px;">${buildProgressInlineHtml_(progress)}</div>
      <div class="text-sm text-sec" style="margin-top:8px;">${state.lang === 'de' ? 'Zuletzt' : 'آخر تحديث'}: <b>${escapeHtml(lastLabel)}</b></div>
    </div>
  `;
}


async function openStudentAkteEval(){
  if(!state.studentEvaluationsLoaded) await loadStudentEvaluations();
  openModal('stu-akte-eval-modal');
}

async function openStudentAkteAttendance(){
  if(!state.studentAttendanceLoaded) await loadStudentAttendance();
  openModal('stu-akte-att-modal');
}

// --- Helpers (Student) ---
function escapeHtml(str){
  return String(str ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

// Format server timestamps to DATE only (hide hours/minutes)
function dateOnly(raw){
  const s = String(raw || '').trim();
  if(!s) return '';
  // dd.mm.yyyy
  const m1 = s.match(/(\d{2}\.\d{2}\.\d{4})/);
  if(m1) return m1[1];
  // yyyy-mm-dd
  const m2 = s.match(/(\d{4}-\d{2}-\d{2})/);
  if(m2){
    const parts = m2[1].split('-'); // [yyyy,mm,dd]
    if(parts.length === 3) return `${parts[2]}.${parts[1]}.${parts[0]}`;
    return m2[1];
  }
  // Fallback: Date parsing
  const d = new Date(s);
  if(!isNaN(d.getTime())){
    const loc = (state && state.lang === 'ar') ? 'ar-EG' : 'de-DE';
    return d.toLocaleDateString(loc, { day:'2-digit', month:'2-digit', year:'numeric' });
  }
  // Last resort: cut at first space
  return s.split(' ')[0];
}


const SURAH_LIST = [
  [1, "Al-Fātiha", "الفاتحة"], [2,"Al-Baqara","البقرة"], [3,"Āl ʿImrān","آل عمران"], [4,"An-Nisāʾ","النساء"],
  [5,"Al-Māʾida","المائدة"], [6,"Al-Anʿām","الأنعام"], [7,"Al-Aʿrāf","الأعراف"], [8,"Al-Anfāl","الأنفال"],
  [9,"At-Tawba","التوبة"], [10,"Yūnus","يونس"], [11,"Hūd","هود"], [12,"Yūsuf","يوسف"],
  [13,"Ar-Raʿd","الرعد"], [14,"Ibrāhīm","إبراهيم"], [15,"Al-Ḥijr","الحجر"], [16,"An-Naḥl","النحل"],
  [17,"Al-Isrāʾ","الإسراء"], [18,"Al-Kahf","الكهف"], [19,"Maryam","مريم"], [20,"Ṭā-Hā","طه"],
  [21,"Al-Anbiyāʾ","الأنبياء"], [22,"Al-Ḥajj","الحج"], [23,"Al-Muʾminūn","المؤمنون"], [24,"An-Nūr","النور"],
  [25,"Al-Furqān","الفرقان"], [26,"Ash-Shuʿarāʾ","الشعراء"], [27,"An-Naml","النمل"], [28,"Al-Qaṣaṣ","القصص"],
  [29,"Al-ʿAnkabūt","العنكبوت"], [30,"Ar-Rūm","الروم"], [31,"Luqmān","لقمان"], [32,"As-Sajda","السجدة"],
  [33,"Al-Aḥzāb","الأحزاب"], [34,"Sabaʾ","سبأ"], [35,"Fāṭir","فاطر"], [36,"Yā-Sīn","يس"],
  [37,"Aṣ-Ṣāffāt","الصافات"], [38,"Ṣād","ص"], [39,"Az-Zumar","الزمر"], [40,"Ghāfir","غافر"],
  [41,"Fuṣṣilat","فصلت"], [42,"Ash-Shūrā","الشورى"], [43,"Az-Zukhruf","الزخرف"], [44,"Ad-Dukhān","الدخان"],
  [45,"Al-Jāthiya","الجاثية"], [46,"Al-Aḥqāf","الأحقاف"], [47,"Muḥammad","محمد"], [48,"Al-Fatḥ","الفتح"],
  [49,"Al-Ḥujurāt","الحجرات"], [50,"Qāf","ق"], [51,"Adh-Dhāriyāt","الذاريات"], [52,"Aṭ-Ṭūr","الطور"],
  [53,"An-Najm","النجم"], [54,"Al-Qamar","القمر"], [55,"Ar-Raḥmān","الرحمن"], [56,"Al-Wāqiʿa","الواقعة"],
  [57,"Al-Ḥadīd","الحديد"], [58,"Al-Mujādila","المجادلة"], [59,"Al-Ḥashr","الحشر"], [60,"Al-Mumtaḥana","الممتحنة"],
  [61,"Aṣ-Ṣaff","الصف"], [62,"Al-Jumuʿa","الجمعة"], [63,"Al-Munāfiqūn","المنافقون"], [64,"At-Taghābun","التغابن"],
  [65,"Aṭ-Ṭalāq","الطلاق"], [66,"At-Taḥrīm","التحريم"], [67,"Al-Mulk","الملك"], [68,"Al-Qalem","القلم"],
  [69,"Al-Ḥāqqa","الحاقة"], [70,"Al-Maʿārij","المعارج"], [71,"Nūḥ","نوح"], [72,"Al-Jinn","الجن"],
  [73,"Al-Muzzammil","المزمل"], [74,"Al-Muddaththir","المدثر"], [75,"Al-Qiyāma","القيامة"], [76,"Al-Insān","الإنسان"],
  [77,"Al-Mursalāt","المرسلات"], [78,"An-Nabaʾ","النبأ"], [79,"An-Nāziʿāt","النازعات"], [80,"ʿAbasa","عبس"],
  [81,"At-Takwīr","التكوير"], [82,"Al-Infiṭār","الإنفطار"], [83,"Al-Muṭaffifīn","المطففين"], [84,"Al-Inshiqqāq","الإنشقاق"],
  [85,"Al-Burūj","البروج"], [86,"Aṭ-Ṭāriq","الطارق"], [87,"Al-Aʿlā","الأعلى"], [88,"Al-Ghāshiya","الغاشية"],
  [89,"Al-Fajr","الفجر"], [90,"Al-Balad","البلد"], [91,"Ash-Shams","الشمس"], [92,"Al-Layl","الليل"],
  [93,"Aḍ-Ḍuḥā","الضحى"], [94,"Ash-Sharḥ","الشرح"], [95,"At-Tīn","التين"], [96,"Al-ʿAlaq","العلق"],
  [97,"Al-Qadr","القدر"], [98,"Al-Bayyina","البينة"], [99,"Az-Zalzala","الزلزلة"], [100,"Al-ʿĀdiyāt","العاديات"],
  [101,"Al-Qāriʿa","القارعة"], [102,"At-Takāthur","التكاثر"], [103,"Al-ʿAṣr","العصر"], [104,"Al-Humaza","الهمزة"],
  [105,"Al-Fīl","الفيل"], [106,"Quraysh","قريش"], [107,"Al-Māʿūn","الماعون"], [108,"Al-Kawthar","الكوثر"],
  [109,"Al-Kāfirūn","الكافرون"], [110,"An-Naṣr","النصر"], [111,"Al-Masad","المسد"], [112,"Al-Ikhlāṣ","الإخلاص"],
  [113,"Al-Falaq","الفلق"], [114,"An-Nās","الناس"]
];

function getSurahInfo(surahNumber) {
  const row = SURAH_LIST.find(x => x[0] === surahNumber);
  if(!row) return { number: surahNumber, latin: `Sure ${surahNumber}`, arabic: `سورة ${surahNumber}` };
  return { number: row[0], latin: row[1], arabic: row[2] };
}

function initialsOfName(str){
  str = String(str||'').trim();
  if(!str) return '';
  const parts = str.split(/\s+/).filter(Boolean);
  return parts.map(p=>p[0]).join('').toLowerCase();
}

function setupHomeworkSurahDropdown(){
  const inp = document.getElementById('hw-surah');
  const dd = document.getElementById('hw-surah-dd');
  if(!inp || !dd) return;

  function close(){
    dd.classList.add('hidden');
    dd.innerHTML = '';
  }

  inp.addEventListener('input', ()=>{
    const q = (inp.value||'').trim().toLowerCase();
    dd.innerHTML = '';
    if(!q){ close(); return; }

    const matches = SURAH_LIST.filter(([num,de,ar])=>{
      const n = String(num);
      const deL = String(de).toLowerCase();
      const arS = String(ar);
      const iniDe = initialsOfName(de);
      const iniAr = initialsOfName(arS);
      return n.startsWith(q) || deL.includes(q) || arS.includes(q) || iniDe.startsWith(q) || iniAr.startsWith(q);
    }).slice(0, 20);

    if(matches.length === 0){ close(); return; }

    matches.forEach(([num,de,ar])=>{
      const item = document.createElement('div');
      item.style.padding = '8px';
      item.style.borderBottom = '1px solid var(--border)';
      item.style.cursor = 'pointer';
      item.innerHTML = `<b style="color:var(--primary)">${num}</b> — ${escapeHtml(de)} — ${escapeHtml(ar)}`;
      item.onclick = ()=>{
        inp.value = String(num);
        close();
      };
      dd.appendChild(item);
    });

    dd.classList.remove('hidden');
  });

  inp.addEventListener('blur', ()=> setTimeout(close, 150));
}

function getSurahLabel(n){
  const row = SURAH_LIST.find(x => x[0] === n);
  if(!row) return `Sure ${n}`;
  return `${row[1]} — ${row[2]}`;
}

// --- Homework helpers (support: TEXT|..., MEM|...) ---
function decodeHomeworkSurah(raw){
  raw = String(raw || '').trim();
  let kind = 'verses';
  let surahText = raw;
  let freeText = '';
  let badge = '';

  if(raw.startsWith('TEXT|')){
    kind = 'text';
    freeText = raw.slice(5).trim();
    surahText = '';
  } else if(raw.startsWith('MEM|')){
    kind = 'memorized';
    surahText = raw.slice(4).trim();
    badge = (state.lang === 'de' ? 'Auswendig' : 'محفوظ');
  }

  const surahNum = parseSurahNumber(surahText);
  const label = surahNum ? getSurahLabel(surahNum) : (surahText || (kind === 'text' ? (state.lang === 'de' ? 'Freier Text' : 'نص حر') : ''));
  return { kind, surahText, surahNum, label, freeText, badge };
}



function renderSurahList(){
  const q = (document.getElementById('surah-search')?.value || '').trim().toLowerCase();
  const cont = document.getElementById('surah-list');
  if(!cont) return;

  cont.innerHTML = '';
  cont.style.display = 'grid';
  cont.style.gridTemplateColumns = 'repeat(auto-fill, minmax(240px, 1fr))';
  cont.style.gap = '10px';

  const rows = SURAH_LIST.filter(([num,de,ar]) => !q || String(num).includes(q) || de.toLowerCase().includes(q) || ar.includes(q));

  rows.forEach(([num,de,ar]) => {
    const ayahCount = getSurahAyahCount(num);

    const el = document.createElement('div');
    el.className = 'surah-card';
    el.innerHTML = `
      <div class="surah-left">
        <div class="surah-badge">${num}</div>
        <div class="surah-names">
          <div class="surah-ar">${escapeHtml(ar)}</div>
          <div class="surah-la">${escapeHtml(de)}</div>
          <div class="surah-meta">${state.lang === 'de' ? `${ayahCount} Verse` : `${ayahCount} آية`}</div>
        </div>
      </div>
      <button class="btn surah-open" onclick="openLesson(${num}, 1, getSurahAyahCount(${num}))">📖</button>
    `;

    el.onclick = (e) => {
      if(e.target && e.target.tagName === 'BUTTON') return;
      openLesson(num, 1, getSurahAyahCount(num));
    };

    cont.appendChild(el);
  });
}

// --- Parent absence (student / parents) ---
function todayKey(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const da = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${da}`;
}

function normId(s){
  return String(s||'').trim().toLowerCase();
}

function parentAbsentStorageKey(){
  return `qs_parent_absent:${state.studentData?.referenz || 'unknown'}:${todayKey()}`;
}

function toggleParentAbsentUI(){
  const chk = document.getElementById('chk-parent-absent');
  const extra = document.getElementById('parent-absent-extra');
  if(extra) extra.classList.toggle('hidden', !chk?.checked);
}

async function loadParentAbsentState(){
  const chk = document.getElementById('chk-parent-absent');
  const st  = document.getElementById('stu-parent-status');
  const extra = document.getElementById('parent-absent-extra');
  const reasonEl = document.getElementById('parent-absent-reason');
  const certEl   = document.getElementById('chk-parent-cert');
  if(!chk || !st || !state.studentData) return;

  // 1) Try server (sync across devices)
  try{
    const res = await fetch(WEB_APP_URL, {
      method:'POST',
      headers: { "Content-Type": "text/plain" },
      body: JSON.stringify({
        action: 'getParentAbsentStatus',
        studentRef: state.studentData.referenz,
        date: todayKey()
      })
    }).then(r=>r.json());

    if(res && res.ok){
      const val = !!res.value;
      chk.checked = val;
      if(extra) extra.classList.toggle('hidden', !val);
      if(reasonEl) reasonEl.value = res.reason || '';
      if(certEl) certEl.checked = !!res.certificate;

      // cache locally (optional)
      try { localStorage.setItem(parentAbsentStorageKey(), val ? '1' : '0'); } catch(e){}

      st.innerText = val
        ? (state.lang === 'de' ? '✅ Abwesenheit gemeldet (synchronisiert).' : '✅ تم التبليغ عن الغياب (مزامن).')
        : '';
      return;
    }
  }catch(e){
    // ignore -> fallback local
  }

  // 2) Fallback: local storage
  const val = localStorage.getItem(parentAbsentStorageKey()) === '1';
  chk.checked = val;
  if(extra) extra.classList.toggle('hidden', !val);
  st.innerText = val ? (state.lang === 'de' ? '✅ Abwesenheit gemeldet.' : '✅ تم التبليغ عن الغياب.') : '';
}

async function submitParentAbsent(){
  if(!state.studentData) return;

  const chk = document.getElementById('chk-parent-absent');
  const st  = document.getElementById('stu-parent-status');
  const isOn = !!chk?.checked;

  const reason = (document.getElementById('parent-absent-reason')?.value || '').trim();
  const cert = !!document.getElementById('chk-parent-cert')?.checked;

  // require reason when absent is ON
  if(isOn && !reason){
    showToast(state.lang === 'de' ? 'Bitte Grund eingeben.' : 'اكتب سبب الغياب.');
    return;
  }

  showToast(state.lang === 'de' ? 'Sende...' : 'جاري الإرسال...');

  try{
    const res = await fetch(WEB_APP_URL, {
      method:'POST',
      headers: { "Content-Type": "text/plain" },
      body: JSON.stringify({
        action: 'setParentAbsentStatus',
        studentRef: state.studentData.referenz,
        date: todayKey(),
        value: isOn,
        reason: reason,
        certificate: cert
      })
    }).then(r=>r.json());

    if(res && res.ok){
      // Update local cache
      try { localStorage.setItem(parentAbsentStorageKey(), isOn ? '1' : '0'); } catch(e){}
      
      // Update UI
      st.innerText = isOn 
        ? (state.lang === 'de' ? '✅ Abwesenheit gemeldet (synchronisiert).' : '✅ تم التبليغ عن الغياب (مزامن).')
        : '';
      
      showToast(state.lang === 'de' ? 'Gesendet!' : 'تم الإرسال!');
    } else {
      showToast(state.lang === 'de' ? 'Fehler beim Senden.' : 'خطأ في الإرسال.');
    }
  } catch(e) {
    showToast(state.lang === 'de' ? 'Verbindungsfehler.' : 'خطأ في الاتصال.');
  }
}

// --- QURAN LESSON (Arabic + German + Audio) ---
const QURANENC_TRANSLATION_KEY = 'german_aburida';

// Ayah count for each surah (index 1..114)
const SURAH_AYAHS = [7,286,200,176,120,165,206,75,129,109,123,111,43,52,99,128,111,110,98,135,112,78,118,64,77,227,93,88,69,60,34,30,73,54,45,83,182,88,75,85,54,53,89,59,37,35,38,29,18,45,60,49,62,55,78,96,29,22,24,13,14,11,11,18,12,12,30,52,52,44,28,28,20,56,40,31,50,40,46,42,29,19,36,25,22,17,19,26,30,20,15,21,11,8,8,19,5,8,8,11,11,8,3,9,5,4,7,3,6,3,5,4,5,6];

function getSurahAyahCount(surahNumber){
  const n = parseInt(surahNumber,10);
  if(!n || n<1 || n>114) return 7;
  return SURAH_AYAHS[n-1] || 7;
}

function pad3(n) {
  n = parseInt(n, 10);
  return String(n).padStart(3, '0');
}

function everyAyahUrl(surahNumber, ayahNumber) {
  return `https://everyayah.com/data/Alafasy_64kbps/${pad3(surahNumber)}${pad3(ayahNumber)}.mp3`;
}

// Playback state for "range repeat"
let rangePlayback = {
  active:false,
  surahNumber:null,
  start:1,
  end:1,
  queue:[],
  idx:0,
  repeatLeft:1
};

function stopRangePlayback(){
  rangePlayback.active = false;
  rangePlayback.queue = [];
  rangePlayback.idx = 0;
  const audio = document.getElementById('lesson-audio');
  if(audio) {
    audio.pause();
  }
  showToast(state.lang === 'de' ? 'Gestoppt' : 'تم الإيقاف');
}

function playAssignedRange(){
  if(!rangePlayback.surahNumber) {
    showToast(state.lang === 'de' ? 'Keine Lektion geladen' : 'لم يتم تحميل الدرس');
    return;
  }
  const audio = document.getElementById('lesson-audio');
  if(!audio) return;

  const repeatCount = parseInt(document.getElementById('lesson-repeat-count')?.value || '1', 10) || 1;

  rangePlayback.active = true;
  rangePlayback.repeatLeft = repeatCount;
  rangePlayback.idx = 0;
  rangePlayback.queue = [];
  for(let a=rangePlayback.start; a<=rangePlayback.end; a++) rangePlayback.queue.push(a);

  const surahInfo = getSurahInfo(rangePlayback.surahNumber);
  attachFloatingPlayerToAudio(audio, {
    mode: 'range',
    title: `${surahInfo.arabic} - ${surahInfo.latin} (${rangePlayback.start}-${rangePlayback.end})`,
    info: `سورة ${surahInfo.arabic} - آية ${rangePlayback.start}`
  });

  const playNext = () => {
    if(!rangePlayback.active) return;

    if(rangePlayback.idx >= rangePlayback.queue.length) {
      rangePlayback.repeatLeft -= 1;
      if(rangePlayback.repeatLeft <= 0) {
        rangePlayback.active = false;
        showToast(state.lang === 'de' ? 'Fertig' : 'انتهى');
        hideFloatingAudio();
        return;
      }
      rangePlayback.idx = 0;
    }

    const ayah = rangePlayback.queue[rangePlayback.idx];
    rangePlayback.idx += 1;

    document.getElementById('floating-audio-info').textContent = `سورة ${surahInfo.arabic} - آية ${ayah}`;
    updateFloatingProgress();

    const el = document.querySelector(`[data-ayah-card="1"][data-ayah="${ayah}"]`);
    if(el) {
      el.scrollIntoView({behavior:'smooth', block:'center'});
      el.classList.add('selected');
      setTimeout(()=>el.classList.remove('selected'), 600);
    }

    audio.src = everyAyahUrl(rangePlayback.surahNumber, ayah);
    audio.play().catch(()=>{});
  };

  rangePlayback._playNext = playNext;
  audio.onended = playNext;
  playNext();
}

const SURAH_NAME_TO_NUM = {
  // Arabic
  "الفاتحة": 1, "البقرة": 2,
  // Common Latin
  "al-fatiha": 1, "fatiha": 1, "al fatiha": 1,
  "al-baqara": 2, "baqara": 2, "al baqara": 2,
  "ali-imran": 3, "al imran": 3, "imran": 3,
  "an-nisa": 4, "an nisa": 4, "nisa": 4,
  "al-maidah": 5, "al maidah": 5, "maidah": 5,
  "al-anam": 6, "al anam": 6, "anam": 6,
  "al-araf": 7, "al araf": 7, "araf": 7
};

function parseSurahNumber(input) {
  if (input === null || input === undefined) return null;
  const s = String(input).trim();
  if (!s) return null;

  if (/^\d+$/.test(s)) {
    const n = parseInt(s, 10);
    if (n >= 1 && n <= 114) return n;
  }

  const norm = s.toLowerCase()
    .replace(/[’'`]/g, '')
    .replace(/[\u064B-\u0652]/g, '')
    .replace(/[^a-z0-9\u0600-\u06FF\s-]/g, '')
    .replace(/\s+/g, ' ')
    .trim();

  if (SURAH_NAME_TO_NUM[norm]) return SURAH_NAME_TO_NUM[norm];

  const m1 = norm.match(/\((\d{1,3})\)/);
  if (m1) {
    const n = parseInt(m1[1], 10);
    if (n >= 1 && n <= 114) return n;
  }
  const m2 = norm.match(/^(\d{1,3})\b/);
  if (m2) {
    const n = parseInt(m2[1], 10);
    if (n >= 1 && n <= 114) return n;
  }

  return null;
}

async function fetchGermanTranslationForSura(surahNumber) {
  const url = `https://quranenc.com/api/v1/translation/sura/${QURANENC_TRANSLATION_KEY}/${surahNumber}`;
  const r = await fetch(url);
  if (!r.ok) throw new Error('QuranEnc Fehler: ' + r.status);
  const data = await r.json();
  const arr = Array.isArray(data) ? data : (data.result || data.data || data.translations || []);
  return arr;
}

async function fetchArabicSurahUthmani(surahNumber){
  const url = `https://api.quran.com/api/v4/quran/verses/uthmani?chapter_number=${surahNumber}`;
  const r = await fetch(url);
  if(!r.ok) throw new Error('Quran.com Arabic Fehler: ' + r.status);
  const data = await r.json();
  const verses = data?.verses || data?.quran_verses || data?.data || [];
  const map = new Map();
  verses.forEach(v => {
    const vk = v.verse_key || '';
    let ay = v.verse_number;
    if(!ay && vk.includes(':')) ay = parseInt(vk.split(':')[1], 10);
    const txt = v.text_uthmani || v.text || v.uthmani || '';
    if(ay) map.set(parseInt(ay,10), txt);
  });
  return map;
}

async function fetchArabicAyahFallback(surahNumber, ayahNumber) {
  const url = `https://api.alquran.cloud/v1/ayah/${surahNumber}:${ayahNumber}/quran-uthmani`;
  const r = await fetch(url);
  if (!r.ok) throw new Error('Arabic API Fehler: ' + r.status);
  const data = await r.json();
  return data?.data?.text || '';
}

// --- Quran Reader UI (mushaf / Tarteel-like) ---
let lessonFabState = { hasLesson:false, hidden:false };
let mushafFontRem = 1.65;

function arabicIndicDigits(n){
  return String(n).replace(/\d/g, d => "٠١٢٣٤٥٦٧٨٩"[parseInt(d,10)]);
}

function setReaderFabVisible(isVisible){
  const fab = document.getElementById('reader-toggle-fab');
  if(!fab) return;
  fab.classList.toggle('hidden', !isVisible);
  updateLessonFab();
}

function updateLessonFab(){
  const fab = document.getElementById('reader-toggle-fab');
  const icon = document.getElementById('reader-fab-icon');
  if(!fab || !icon) return;

  if(!lessonFabState.hasLesson){
    icon.className = 'fa-solid fa-book-open';
    fab.title = (state.lang === 'de' ? 'Kein Leser geöffnet' : 'لا توجد نافذة قراءة مفتوحة');
    return;
  }

  if(lessonFabState.hidden){
    icon.className = 'fa-solid fa-eye';
    fab.title = (state.lang === 'de' ? 'Leser anzeigen' : 'إظهار نافذة القراءة');
  } else {
    icon.className = 'fa-solid fa-eye-slash';
    fab.title = (state.lang === 'de' ? 'Leser ausblenden' : 'إخفاء نافذة القراءة');
  }
}

function toggleLessonFab(){
  if(!lessonFabState.hasLesson){
    showToast(state.lang === 'de' ? 'Kein Leser geöffnet' : 'لا يوجد درس مفتوح');
    return;
  }
  const modal = document.getElementById('lesson-modal');
  if(!modal) return;

  const isVisible = modal.classList.contains('visible');
  if(isVisible){
    hideModalOnly('lesson-modal');
    lessonFabState.hidden = true;
  } else {
    openModal('lesson-modal');
    lessonFabState.hidden = false;
  }
  updateLessonFab();
}

function clearLessonFab(){
  lessonFabState.hasLesson = false;
  lessonFabState.hidden = false;
  updateLessonFab();
}

function toggleLessonTranslation(){
  const el = document.getElementById('lesson-translation');
  if(!el) return;
  el.classList.toggle('hidden');
}

function adjustMushafFont(delta){
  mushafFontRem = Math.max(1.15, Math.min(2.4, mushafFontRem + (delta * 0.1)));
  document.documentElement.style.setProperty('--mushaf-font', mushafFontRem + 'rem');
}

function setPlayingAyah(ayah){
  document.querySelectorAll('.ayah-span.playing').forEach(x => x.classList.remove('playing'));
  const el = document.querySelector(`.ayah-span[data-ayah="${ayah}"]`);
  if(el) el.classList.add('playing');
}

// ===== Multi-Tap on Ayah (2× = German meaning, 4×+ = phonetic) =====
let quickVerseSheetState = { title:'', ar:'', body:'' };

function showQuickVerseSheet({ title, sub, ar, body }) {
  const ov = document.getElementById('quick-verse-sheet');
  if(!ov) return;

  const tEl = document.getElementById('qvs-title');
  const sEl = document.getElementById('qvs-sub');
  const aEl = document.getElementById('qvs-ar');
  const bEl = document.getElementById('qvs-body');

  quickVerseSheetState = { title: title || '', ar: ar || '', body: body || '' };

  if(tEl) tEl.textContent = title || '';
  if(sEl) sEl.textContent = sub || '';
  if(aEl) aEl.textContent = ar || '';
  if(bEl) bEl.textContent = body || '';

  ov.classList.add('show');
}

function hideQuickVerseSheet(){
  document.getElementById('quick-verse-sheet')?.classList.remove('show');
}

async function copyQuickVerseSheet(){
  const txt = `${quickVerseSheetState.ar}\n\n${quickVerseSheetState.body}`.trim();
  if(!txt) return;
  try{
    await navigator.clipboard.writeText(txt);
    showToast(state.lang === 'de' ? 'Kopiert' : 'تم النسخ');
  }catch(e){
    showToast(state.lang === 'de' ? 'Kopieren nicht möglich' : 'لا يمكن النسخ');
  }
}

// A pragmatic Arabic → Latin phonetic (good enough for memorization cues)
function arabicToPhonetic(input){
  if(!input) return '';
  let s = String(input);

  // normalize Allah ligatures + remove common Quran punctuation
  s = s.replace(/ﷲ/g, 'الله')
       .replace(/[۝ۖۗۘۙۚۛۜ۞ۣ۟۠ۡۢۤۥۦۧۨ۩]/g,'')
       .replace(/[﴿﴾]/g,'')
       .replace(/\s+/g,' ')
       .trim();

  // keep spaces, remove Arabic-Indic digits and verse ornaments
  s = s.replace(/[0-9٠-٩]/g,'').replace(/[ـ]/g,''); // tatweel

  const HARAKAT = {
    '\u064B':'an', '\u064C':'un', '\u064D':'in',
    '\u064E':'a',  '\u064F':'u',  '\u0650':'i',
    '\u0652':'',   '\u0670':'a',  // sukun, dagger alif
  };
  const SHADDA = '\u0651';

  const MAP = {
    'ا':'a','أ':'a','إ':'i','آ':'aa','ٱ':'a',
    'ب':'b','ت':'t','ث':'th','ج':'j','ح':'h','خ':'kh',
    'د':'d','ذ':'dh','ر':'r','ز':'z','س':'s','ش':'sh',
    'ص':'s','ض':'d','ط':'t','ظ':'z','ع':'‘','غ':'gh',
    'ف':'f','ق':'q','ك':'k','ل':'l','م':'m','ن':'n',
    'ه':'h','ة':'a','و':'w','ي':'y','ى':'a','ء':"’",'ؤ':'u','ئ':'i',
    'ﻻ':'la','لا':'la',
  };

  // helper: strip non-letters except spaces
  const keep = s.replace(/[^\u0600-\u06FF\s]/g,' ').replace(/\s+/g,' ').trim();

  // build per-character with diacritics support
  let out = '';
  let prevCons = '';
  for(let i=0;i<keep.length;i++){
    const ch = keep[i];

    if(ch === ' '){
      out += ' ';
      prevCons = '';
      continue;
    }

    // diacritics
    if(HARAKAT[ch] !== undefined){
      out += HARAKAT[ch];
      continue;
    }
    if(ch === SHADDA){
      // double the previous consonant token
      out += prevCons;
      continue;
    }

    let token = MAP[ch];
    if(token === undefined){
      token = '';
    }

    // store last consonant-ish token for shadda doubling
    prevCons = (token && !['a','i','u','aa','an','in','un'].includes(token)) ? token : prevCons;

    out += token;
  }

  // Post-processing: clean up
  out = out
    .replace(/\s+/g,' ')
    .replace(/‘/g,'')          // optional: remove ayn marker for simplicity
    .replace(/’/g,'')          // optional: remove hamza marker
    .replace(/\bllaah\b/g,'allah') // fallback
    .trim()
    .toLowerCase();

  // Arabic definite article "ال" often becomes "al" (simplistic)
  // Fix common: "alhamd" spacing to match your example style
  out = out.replace(/^al(?=[a-z])/,'al ');

  // Some small friendly fixes
  out = out.replace(/\ballah\b/g,'allah');
  return out;
}

// Attach gesture to each ayah span without breaking existing playback
function attachAyahMultiTap(span, verse, surahNumber, verses){
  let taps = 0;
  let timer = null;

  const doPlay = () => {
    stopRangePlayback();
    setPlayingAyah(verse.ayah);
    setupFloatingAudio(surahNumber, verse.ayah, verse.ayah, verses);
  };

  const doMeaning = () => {
    const info = getSurahInfo(surahNumber);
    const title = `${info.latin} • ${surahNumber}:${verse.ayah}`;
    const body = (verse.german || '').trim() || (state.lang==='de'?'(Keine Übersetzung verfügbar)':'(لا توجد ترجمة متاحة)');
    showQuickVerseSheet({
      title,
      sub: 'Deutsch (Bedeutung) — Doppeltippen',
      ar: (verse.arabic || '').trim(),
      body
    });
  };

  const doPhonetic = () => {
    const info = getSurahInfo(surahNumber);
    const title = `${info.latin} • ${surahNumber}:${verse.ayah}`;
    const phon = arabicToPhonetic((verse.arabic || '').trim());
    showQuickVerseSheet({
      title,
      sub: 'Phonetik — 4× Tippen oder mehr',
      ar: (verse.arabic || '').trim(),
      body: phon || '(—)'
    });
  };

  span.addEventListener('click', (ev) => {
    // prevent accidental selection on fast multi-tap, and avoid bubbling to mushaf container
    try { ev.preventDefault(); } catch(e) {}
    ev.stopPropagation();

    taps += 1;
    span.classList.add('selected');

    if(timer) clearTimeout(timer);
    timer = setTimeout(() => {
      span.classList.remove('selected');
      const c = taps;
      taps = 0;

      if(c === 1) return doPlay();
      if(c === 2 || c === 3) return doMeaning();
      if(c >= 4) return doPhonetic();
    }, 340);
  }, { passive: false });
}


function renderLessonVerses({ surahNumber, surahLabel, start, end, verses, viewMode = 'mushaf' }) {
  const searchInput = document.getElementById('lesson-search-input');
  const surahNameArabic = document.getElementById('surah-name-arabic');
  const surahNameLatin = document.getElementById('surah-name-latin');
  const surahNumberSpan = document.getElementById('surah-number');
  const surahVerseCount = document.getElementById('surah-verse-count');
  const cont = document.getElementById('lesson-verses');
  const transCont = document.getElementById('lesson-translation');
  const audio = document.getElementById('lesson-audio');

  const surahInfo = getSurahInfo(surahNumber);
  if(surahNameArabic) surahNameArabic.textContent = surahInfo.arabic;
  if(surahNameLatin)  surahNameLatin.textContent = surahInfo.latin;
  if(surahNumberSpan) surahNumberSpan.textContent = state.lang === 'de' ? `Sure ${surahNumber}` : `سورة ${surahNumber}`;
  if(surahVerseCount) surahVerseCount.textContent = state.lang === 'de' ? `${verses.length} Verse` : `${verses.length} آيات`;

  rangePlayback.surahNumber = surahNumber;
  rangePlayback.start = start;
  rangePlayback.end = end;

  if(cont) cont.innerHTML = '';
  if(transCont) { transCont.innerHTML = ''; transCont.classList.add('hidden'); }

  if(audio){
    audio.pause();
    audio.removeAttribute('src');
    audio.load();
    audio.onended = null;
  }

  // Remember view mode on the modal (used for UI tweaks)
  const modal = document.getElementById('lesson-modal');
  if(modal) modal.dataset.viewMode = viewMode;

  // Hide translation toggle in memorization view (translation is shown per-ayah)
  const tBtn = document.getElementById('btn-toggle-translation');
  if(tBtn) tBtn.style.display = (viewMode === 'memorize') ? 'none' : '';

  if(viewMode === 'memorize'){
    // Memorization (save) view: each ayah as its own card with translation
    const cards = document.createElement('div');
    cards.className = 'ayah-cards';

    verses
      .filter(v => v.ayah >= start && v.ayah <= end)
      .forEach(v => {
        const ayText = (v.arabic || '').trim() || (state.lang === 'de' ? '(Arabischer Text nicht verfügbar)' : '(النص العربي غير متوفر)');

        const card = document.createElement('div');
        card.className = 'ayah-card';

        const head = document.createElement('div');
        head.className = 'ayah-card-head';

        const title = document.createElement('div');
        title.className = 'ayah-card-title';
        title.textContent = state.lang === 'de' ? `Vers ${v.ayah}` : `آية ${v.ayah}`;

        const actions = document.createElement('div');
        actions.style.display = 'flex';
        actions.style.gap = '8px';

        const btnPlay = document.createElement('button');
        btnPlay.className = 'audio-btn';
        btnPlay.textContent = '▶';
        btnPlay.title = state.lang === 'de' ? 'Abspielen' : 'تشغيل';
        btnPlay.onclick = () => {
          stopRangePlayback();
          setupFloatingAudio(surahNumber, v.ayah, v.ayah, verses);
        };

        const btnCopy = document.createElement('button');
        btnCopy.className = 'audio-btn sec';
        btnCopy.textContent = '⧉';
        btnCopy.title = state.lang === 'de' ? 'Kopieren' : 'نسخ';
        btnCopy.onclick = async () => {
          const text = `${(v.arabic || '').trim()}

${v.german || ''}`.trim();
          try { await navigator.clipboard.writeText(text); showToast(state.lang==='de'?'Kopiert':'تم النسخ'); }
          catch(e){ showToast(state.lang==='de'?'Kopieren nicht möglich':'لا يمكن النسخ'); }
        };

        actions.appendChild(btnPlay);
        actions.appendChild(btnCopy);

        head.appendChild(title);
        head.appendChild(actions);

        const ar = document.createElement('div');
        ar.className = 'ayah-card-ar';
        ar.textContent = ayText;

        const tr = document.createElement('div');
        tr.className = 'ayah-card-tr';
        tr.textContent = v.german || '';

        card.appendChild(head);
        card.appendChild(ar);
        card.appendChild(tr);
        cards.appendChild(card);
      });

    if(cont) cont.appendChild(cards);
    if(transCont) { transCont.innerHTML = ''; transCont.classList.add('hidden'); }
  } else {
  // Build mushaf-like card
    const mushafCard = document.createElement('div');
    mushafCard.className = 'mushaf-card';

    const arWrap = document.createElement('div');
    arWrap.className = 'mushaf-arabic';
    arWrap.setAttribute('lang','ar');

    verses.forEach(v => {
      const ayText = (v.arabic || '').trim() || (state.lang === 'de' ? '(Arabischer Text nicht verfügbar)' : '(النص العربي غير متوفر)');
      const span = document.createElement('span');
      span.className = 'ayah-span';
      span.dataset.ayahCard = "1";
      span.dataset.ayah = String(v.ayah);
      if(v.ayah >= start && v.ayah <= end) span.classList.add('in-range');

      attachAyahMultiTap(span, v, surahNumber, verses);

      span.appendChild(document.createTextNode(ayText + ' '));

      const num = document.createElement('span');
      num.className = 'ayah-num';
      num.textContent = (state.lang === 'ar') ? arabicIndicDigits(v.ayah) : String(v.ayah);

      span.appendChild(num);
      span.appendChild(document.createTextNode(' '));

      arWrap.appendChild(span);
    });

    mushafCard.appendChild(arWrap);
    if(cont) cont.appendChild(mushafCard);

    // Translation cards (only assigned range by default)
    if(transCont){
      verses
        .filter(v => v.ayah >= start && v.ayah <= end)
        .forEach(v => {
          const item = document.createElement('div');
          item.className = 'trans-item';

          const head = document.createElement('div');
          head.className = 'trans-head';

          const ay = document.createElement('div');
          ay.className = 'trans-ayah';
          ay.textContent = state.lang === 'de' ? `Vers ${v.ayah}` : `آية ${v.ayah}`;

          const actions = document.createElement('div');
          actions.style.display = 'flex';
          actions.style.gap = '8px';

          const btnPlay = document.createElement('button');
          btnPlay.className = 'audio-btn';
          btnPlay.textContent = state.lang === 'de' ? '▶' : '▶';
          btnPlay.title = state.lang === 'de' ? 'Abspielen' : 'تشغيل';
          btnPlay.onclick = () => {
            stopRangePlayback();
            setPlayingAyah(v.ayah);
            setupFloatingAudio(surahNumber, v.ayah, v.ayah, verses);
          };

          const btnCopy = document.createElement('button');
          btnCopy.className = 'audio-btn sec';
          btnCopy.textContent = '⧉';
          btnCopy.title = state.lang === 'de' ? 'Kopieren' : 'نسخ';
          btnCopy.onclick = async () => {
            const text = `${(v.arabic || '').trim()}\n\n${v.german || ''}`.trim();
            try { await navigator.clipboard.writeText(text); showToast(state.lang==='de'?'Kopiert':'تم النسخ'); }
            catch(e){ showToast(state.lang==='de'?'Kopieren nicht möglich':'لا يمكن النسخ'); }
          };

          actions.appendChild(btnPlay);
          actions.appendChild(btnCopy);

          head.appendChild(ay);
          head.appendChild(actions);

          const txt = document.createElement('div');
          txt.className = 'trans-text';
          txt.textContent = v.german || '';

          item.appendChild(head);
          item.appendChild(txt);
          transCont.appendChild(item);
        });
    }

  
  }
// Focus search input
  if (searchInput) searchInput.focus();

  // show modal + enable fab
  lessonFabState.hasLesson = true;
  lessonFabState.hidden = false;
  updateLessonFab();

  openModal('lesson-modal');
}

function searchInLesson() {
  const searchInput = document.getElementById('lesson-search-input');
  const searchValue = searchInput.value.trim();
  
  if (!searchValue) return;
  
  // Check if it's a surah number
  const surahNum = parseSurahNumber(searchValue);
  if (surahNum) {
    openLesson(surahNum, 1, getSurahAyahCount(surahNum));
    searchInput.value = '';
    return;
  }
  
  // Check if it's a verse reference (e.g., 2:255)
  const verseMatch = searchValue.match(/^(\d+)[:.](\d+)$/);
  if (verseMatch) {
    const surah = parseInt(verseMatch[1]);
    const ayah = parseInt(verseMatch[2]);
    if (surah >= 1 && surah <= 114 && ayah >= 1) {
      openLesson(surah, ayah, ayah);
      searchInput.value = '';
      return;
    }
  }
  
  // Search in surah list
  const surahMatch = SURAH_LIST.find(([num, latin, arabic]) => 
    latin.toLowerCase().includes(searchValue.toLowerCase()) || 
    arabic.includes(searchValue)
  );
  
  if (surahMatch) {
    openLesson(surahMatch[0], 1, getSurahAyahCount(surahMatch[0]));
    searchInput.value = '';
    return;
  }
  
  showToast(state.lang === 'de' ? 'Nicht gefunden' : 'غير موجود');
}

async function openLesson(surahInput, start, end, opts = {}) {
  try {
    const surahNumber = (typeof surahInput === 'number') ? surahInput : parseSurahNumber(surahInput);
    if (!surahNumber) {
      alert(state.lang === 'de'
        ? 'Bitte gib die Sure als Nummer ein (1–114) oder wähle eine Sure in der Liste.'
        : 'اكتب رقم السورة (1-114) أو اخترها من القائمة.');
      return;
    }
    start = parseInt(start, 10);
    end = parseInt(end, 10);
    if (!start || !end || start < 1 || end < start) {
      alert(state.lang === 'de' ? 'Ungültiger Vers-Bereich.' : 'نطاق الآيات غير صحيح.');
      return;
    }

    const ayahCount = getSurahAyahCount(surahNumber);
    const fullStart = 1;
    const fullEnd = ayahCount;

    const viewMode = (opts && opts.viewMode) ? opts.viewMode : 'mushaf';

    showToast(state.lang === 'de' ? 'Lade Sure...' : 'جاري تحميل السورة...');

    const tArr = await fetchGermanTranslationForSura(surahNumber);
    const tMap = new Map();
    tArr.forEach(x => {
      const ay = parseInt(x.aya ?? x.ayah ?? x.verse ?? x.a, 10);
      if(ay) tMap.set(ay, x.translation || x.text || x.trans || '');
    });

    let aMap = null;
    try {
      aMap = await fetchArabicSurahUthmani(surahNumber);
    } catch(e) {
      aMap = null;
    }

    const verses = [];
    for(let ay=fullStart; ay<=fullEnd; ay++) {
      let arabic = '';
      if(aMap && aMap.get(ay)) {
        arabic = aMap.get(ay) || '';
      } else {
        try {
          arabic = await fetchArabicAyahFallback(surahNumber, ay);
        } catch(e) {
          arabic = '';
        }
      }
      verses.push({
        ayah: ay,
        arabic,
        german: tMap.get(ay) || '',
        audio_url: everyAyahUrl(surahNumber, ay)
      });
    }

    renderLessonVerses({
      surahNumber,
      surahLabel: String(surahInput || 'Sure'),
      start,
      end,
      verses,
      viewMode
    });

  } catch (e) {
    console.error(e);
    alert((state.lang === 'de' ? 'Fehler beim Laden der Verse: ' : 'خطأ أثناء تحميل الآيات: ') + (e?.message || e));
  }
}

// --- STANDARD FUNCTIONS ---
function updateLang() {
  const L = i18n[state.lang];
  document.documentElement.lang = state.lang;
  document.documentElement.dir = state.lang === 'ar' ? 'rtl' : 'ltr';
  document.getElementById('hdr-title').innerText = L.title;
  document.getElementById('search-input').placeholder = L.search;
  document.getElementById('lbl-groups').innerText = L.groups;
  document.getElementById('lbl-days').innerText = L.days;
  document.getElementById('lbl-cap-warn').innerText = L.capWarn;
  document.getElementById('lbl-send-msg').innerText = L.sendMsg;
  document.getElementById('lbl-stats-title').innerText = L.statsTitle;
  if(document.getElementById('lbl-total-students')) document.getElementById('lbl-total-students').innerText = L.totalStud;
  if(document.getElementById('lbl-absent-today')) document.getElementById('lbl-absent-today').innerText = L.absentToday;
  if(document.getElementById('lbl-present-today')) document.getElementById('lbl-present-today').innerText = L.attendedToday;
  if(document.getElementById('lbl-late-today')) document.getElementById('lbl-late-today').innerText = L.lateToday;
  document.getElementById('lbl-nav-stud').innerText = L.navStud;
  document.getElementById('lbl-nav-comm').innerText = L.navComm;
  document.getElementById('lbl-nav-stats').innerText = L.navStats;
  document.getElementById('lbl-nav-docs').innerText = L.navDocs;
if(document.getElementById('lbl-nav-hw')) document.getElementById('lbl-nav-hw').innerText = L.navHw || (state.lang==='de'?'Aufgaben':'الواجبات');

// Bulk Homework UI
if(document.getElementById('hw-admin-title')) document.getElementById('hw-admin-title').innerText = L.hwAdminTitle || (state.lang==='de'?'Hausaufgaben zuweisen':'توزيع واجب منزلي');
if(document.getElementById('hw-lbl-group')) document.getElementById('hw-lbl-group').innerText = L.hwPickGroup || (state.lang==='de'?'Gruppe wählen':'اختر القسم');
if(document.getElementById('hw-lbl-day')) document.getElementById('hw-lbl-day').innerText = L.hwPickDay || (state.lang==='de'?'Tag wählen':'اختر اليوم');
if(document.getElementById('btn-hw-load')) document.getElementById('btn-hw-load').innerText = L.hwLoadStudents || (state.lang==='de'?'Schüler anzeigen':'عرض الطلاب');
if(document.getElementById('btn-hw-use-filter')) document.getElementById('btn-hw-use-filter').innerText = L.hwUseFilter || (state.lang==='de'?'Aktuellen Filter verwenden':'استخدام الفلتر الحالي');

if(document.getElementById('txt-hw-go-all')) document.getElementById('txt-hw-go-all').innerText = (state.lang==='de'?'Übersicht':'ملخص');
if(document.getElementById('txt-hw-back')) document.getElementById('txt-hw-back').innerText = (state.lang==='de'?'Zurück':'رجوع');
if(document.getElementById('hw-all-title')) document.getElementById('hw-all-title').innerText = (state.lang==='de'?'Alle Hausaufgaben':'كل الواجبات المنزلية');
if(document.getElementById('hw-all-lbl-group')) document.getElementById('hw-all-lbl-group').innerText = (state.lang==='de'?'Gruppe wählen':'اختر القسم');
if(document.getElementById('hw-all-lbl-day')) document.getElementById('hw-all-lbl-day').innerText = (state.lang==='de'?'Tag wählen':'اختر اليوم');
if(document.getElementById('hw-all-search')) document.getElementById('hw-all-search').placeholder = (state.lang==='de'?'Suchen...':'بحث...');
if(document.getElementById('hw-all-selectall-label')) document.getElementById('hw-all-selectall-label').innerText = (state.lang==='de'?'Alle auswählen':'تحديد الكل');
if(document.getElementById('txt-hw-all-confirm')) document.getElementById('txt-hw-all-confirm').innerText = (state.lang==='de'?'Bestätigen':'تأكيد');
if(document.getElementById('txt-hw-all-unconfirm')) document.getElementById('txt-hw-all-unconfirm').innerText = (state.lang==='de'?'Bestätigung entfernen':'إلغاء التأكيد');
if(document.getElementById('hw-bulk-selectall-label')) document.getElementById('hw-bulk-selectall-label').innerText = L.hwSelectAll || (state.lang==='de'?'Alle auswählen':'تحديد الكل');
if(document.getElementById('btn-hw-assign')) document.getElementById('btn-hw-assign').innerText = L.hwAssign || (state.lang==='de'?'Hausaufgabe senden':'إرسال الواجب');
if(document.getElementById('hw-bulk-type-mem')) document.getElementById('hw-bulk-type-mem').innerText = L.hwTypeMem || (state.lang==='de'?'Auswendig (Von–Bis)':'حفظ من الآية… إلى الآية…');
if(document.getElementById('hw-bulk-type-text')) document.getElementById('hw-bulk-type-text').innerText = L.hwTypeText || (state.lang==='de'?'Freier Text':'نص حر');
if(document.getElementById('hw-bulk-search')) document.getElementById('hw-bulk-search').placeholder = L.hwSearchStud || (state.lang==='de'?'Schüler suchen...':'بحث طالب...');
  document.getElementById('lbl-docs-title').innerText = L.docsTitle;
  document.getElementById('btn-print-stud').innerText = L.printStud;
  document.getElementById('btn-edit-stud').innerText = L.editStud;
  document.getElementById('lbl-login-btn').innerText = L.loginBtn;

  // Login (redesign)
  if(document.getElementById('lbl-login-title')) document.getElementById('lbl-login-title').innerText = L.loginTitle || (state.lang === 'de' ? 'Anmelden' : 'تسجيل الدخول');
  if(document.getElementById('lbl-login-id')) document.getElementById('lbl-login-id').innerText = (state.lang === 'de' ? 'Benutzername / Student ID' : 'اسم المستخدم / رقم الطالب');
  if(document.getElementById('lbl-login-pin')) document.getElementById('lbl-login-pin').innerText = (state.lang === 'de' ? 'PIN' : 'الرقم السري');
  if(document.getElementById('lbl-login-sub')) document.getElementById('lbl-login-sub').innerText = (state.lang === 'de' ? 'Lehrer / Schüler / Admin' : 'معلم / طالب / إدارة');
  if(document.getElementById('lbl-remember')) document.getElementById('lbl-remember').innerText = (state.lang === 'de' ? 'Angemeldet bleiben' : 'تذكرني');

  document.getElementById('btn-send').innerText = 'Senden';
  document.getElementById('btn-save-stud').innerText = L.save;
  document.getElementById('btn-cancel-stud').innerText = L.cancel;
  document.getElementById('btn-delete-stud').innerText = L.delete;
  document.getElementById('lbl-student-notes').innerText = L.studentNotes;
  document.getElementById('btn-save-note').innerText = L.addNote;
  document.getElementById('lbl-nav-users').innerText = t('navUsers');
  document.getElementById('lbl-manage-users').innerText = t('manageUsers');
  document.getElementById('new-user-name').placeholder = t('userPlaceholder');
  document.getElementById('new-user-pin').placeholder = t('pinPlaceholder');
  document.getElementById('btn-save-user').innerText = L.save;
  document.getElementById('lbl-fin-prob').innerText = L.lblFinProb;
  document.getElementById('lbl-abgemeldet').innerText = L.lblAbgemeldet;

  if(document.getElementById('lbl-repeat')) document.getElementById('lbl-repeat').innerText = (state.lang==='de'?'Wiederholen':'تكرار');
  if(document.getElementById('btn-play-range')) document.getElementById('btn-play-range').innerText = (state.lang==='de'?'▶ Bereich abspielen':'▶ تشغيل المقطع');
  if(document.getElementById('btn-stop-range')) document.getElementById('btn-stop-range').innerText = (state.lang==='de'?'■ Stop':'■ إيقاف');
  if(document.getElementById('btn-parent-absent-send')) document.getElementById('btn-parent-absent-send').innerText = (state.lang==='de'?'Senden':'إرسال');
  
  // Update floating audio player buttons
  if(document.getElementById('btn-prev-ayah')) document.getElementById('btn-prev-ayah').innerText = (state.lang==='de'?'◀ Zurück':'◀ السابق');
  if(document.getElementById('btn-next-ayah')) document.getElementById('btn-next-ayah').innerText = (state.lang==='de'?'▶▶ Weiter':'▶▶ التالي');
  if(document.getElementById('floating-audio-title') && floatingAudio.title) {
    document.getElementById('floating-audio-title').textContent = floatingAudio.title;
  }

  updateFabVisibility();
  if(state.students.length > 0) renderStudentList();

  if(document.getElementById('stu-hw-title')) document.getElementById('stu-hw-title').innerText = (state.lang === 'de' ? 'Meine Hausaufgaben' : 'واجباتي');
  if(document.getElementById('stu-mem-title')) document.getElementById('stu-mem-title').innerText = (state.lang === 'de' ? 'Auswendiglernen' : 'الحفظ');
    if(document.getElementById('stu-akte-title')) document.getElementById('stu-akte-title').innerText = 'Akte';
if(document.getElementById('akte-eval-head')) document.getElementById('akte-eval-head').innerText = (state.lang === 'de' ? 'Bewertung' : 'التقييم');
if(document.getElementById('akte-eval-sub')) document.getElementById('akte-eval-sub').innerText = (state.lang === 'de' ? 'Durchschnitt' : 'المعدل');
if(document.getElementById('akte-eval-grade') && (document.getElementById('akte-eval-grade').innerText || '').trim() === '—'){
  // keep placeholder
}
if(document.getElementById('akte-att-head')) document.getElementById('akte-att-head').innerText = (state.lang === 'de' ? 'Anwesenheit' : 'الحضور');
if(document.getElementById('akte-att-sub')) document.getElementById('akte-att-sub').innerText = (state.lang === 'de' ? 'Verspätungen & Fehlzeiten' : 'التأخيرات والغيابات');
if(document.getElementById('akte-att-late-label')) document.getElementById('akte-att-late-label').innerText = (state.lang === 'de' ? 'Verspätungen' : 'تأخير');
if(document.getElementById('akte-att-abs-label')) document.getElementById('akte-att-abs-label').innerText = (state.lang === 'de' ? 'Fehlzeiten' : 'غياب');
if(document.getElementById('stu-akte-eval-modal-title')) document.getElementById('stu-akte-eval-modal-title').innerText = (state.lang === 'de' ? 'Bewertungen' : 'سجل التقييمات');
if(document.getElementById('stu-akte-att-modal-title')) document.getElementById('stu-akte-att-modal-title').innerText = (state.lang === 'de' ? 'Anwesenheit' : 'سجل التأخير والغياب');

  // Student: Home tab

if(document.getElementById('akte-prog-head')) document.getElementById('akte-prog-head').innerText = (state.lang === 'de' ? 'Fortschritt' : 'تقدمي');
if(document.getElementById('akte-prog-sub')) document.getElementById('akte-prog-sub').innerText = (state.lang === 'de' ? 'Auswendig gelernte Verse' : 'الآيات المحفوظة');
if(document.getElementById('stu-akte-prog-modal-title')) document.getElementById('stu-akte-prog-modal-title').innerText = (state.lang === 'de' ? 'Fortschritt' : 'تقدمي');

  // Student: Home tab
  if(document.getElementById('stu-home-title')) document.getElementById('stu-home-title').innerText = (state.lang === 'de' ? 'Home' : 'الرئيسية');
  if(document.getElementById('stu-home-new-head')) document.getElementById('stu-home-new-head').innerText = (state.lang === 'de' ? 'Neuigkeiten' : 'المستجدات');
  if(document.getElementById('stu-home-new-sub')) document.getElementById('stu-home-new-sub').innerText = (state.lang === 'de'
    ? 'Neue Verspätung/Abwesenheit, Hausaufgabe oder Bewertung wird hier angezeigt.'
    : 'أي تأخير/غياب جديد أو واجب منزلي جديد أو تقييم جديد سيظهر هنا.');
  if(document.getElementById('stu-home-count-label')) document.getElementById('stu-home-count-label').innerText = (state.lang === 'de' ? 'Neue Einträge' : 'مستجدات');
  if(document.getElementById('stu-home-btn-markall')) document.getElementById('stu-home-btn-markall').innerText = (state.lang === 'de' ? 'Alles als gelesen' : 'تأكيد قراءة الكل');
  if(document.getElementById('stu-home-btn-hw')) document.getElementById('stu-home-btn-hw').innerText = (state.lang === 'de' ? 'Aufgaben' : 'الواجبات');
  if(document.getElementById('stu-home-btn-akte')) document.getElementById('stu-home-btn-akte').innerText = (state.lang === 'de' ? 'Akte' : 'الملف');
  if(document.getElementById('stu-home-btn-parent')) document.getElementById('stu-home-btn-parent').innerText = (state.lang === 'de' ? 'Eltern' : 'ولي الأمر');

  if(document.getElementById('stu-parent-title')) document.getElementById('stu-parent-title').innerText = (state.lang === 'de' ? 'Elterninfo' : 'معلومات ولي الأمر');
  if(document.getElementById('stu-parent-head')) document.getElementById('stu-parent-head').innerText = (state.lang === 'de' ? 'Abmeldung für heute' : 'إبلاغ الغياب لليوم');
  if(document.getElementById('stu-parent-hint')) document.getElementById('stu-parent-hint').innerText = (state.lang === 'de'
    ? 'Wenn Ihr Kind heute nicht kommt, aktivieren Sie bitte diese Option. Der Lehrer sieht dann eine Markierung beim Namen.'
    : 'إذا لم يحضر الطفل اليوم، فعّل هذا الخيار ليظهر تنبيه للمعلم بجانب اسم الطالب.');
  if(document.getElementById('stu-parent-label')) document.getElementById('stu-parent-label').innerText = (state.lang === 'de' ? 'Mein Kind ist heute abwesend' : 'طفلي غائب اليوم');
  if(document.getElementById('stu-notif-head')) document.getElementById('stu-notif-head').innerText = (state.lang === 'de' ? 'Benachrichtigungen' : 'تنبيهات');
  if(document.getElementById('stu-notif-hint')) document.getElementById('stu-notif-hint').innerText = (state.lang === 'de' ? 'Aktiviere Browser-Benachrichtigungen für neue Hausaufgaben / Notizen (solange die Seite geöffnet ist).' : 'فعّل تنبيهات المتصفح عند وصول واجبات أو ملاحظات جديدة (طالما الصفحة مفتوحة).');
  if(document.getElementById('stu-notif-label')) document.getElementById('stu-notif-label').innerText = (state.lang === 'de' ? 'Bei neuen Einträgen benachrichtigen' : 'تنبيه عند وصول جديد');
    if(document.getElementById('lbl-nav-stu-home')) document.getElementById('lbl-nav-stu-home').innerText = (state.lang === 'de' ? 'Home' : 'الرئيسية');
if(document.getElementById('lbl-nav-stu-hw')) document.getElementById('lbl-nav-stu-hw').innerText = (state.lang === 'de' ? 'Aufgaben' : 'واجب');
  if(document.getElementById('lbl-nav-stu-mem')) document.getElementById('lbl-nav-stu-mem').innerText = (state.lang === 'de' ? 'Koran' : 'حفظ');
    if(document.getElementById('lbl-nav-stu-rate')) document.getElementById('lbl-nav-stu-rate').innerText = 'Akte';
  if(document.getElementById('lbl-nav-stu-parent')) document.getElementById('lbl-nav-stu-parent').innerText = (state.lang === 'de' ? 'Eltern' : 'ولي');
  if(document.getElementById('lesson-hint')) document.getElementById('lesson-hint').innerText = (state.lang === 'de' ? '🎧 Play drücken • 📖 Bedeutung lesen' : '🎧 اضغط تشغيل للاستماع • 📖 اقرأ المعنى بالألمانية');
  if(document.getElementById('surah-search')) document.getElementById('surah-search').placeholder = (state.lang === 'de' ? 'Sure suchen...' : 'ابحث عن سورة...');
  if(document.getElementById('lesson-search-input')) document.getElementById('lesson-search-input').placeholder = (state.lang === 'de' ? 'سورة أو آية... / Sure oder Vers...' : 'سورة أو آية... / Sure oder Vers...');

// Student: Parent tab - PIN change
  if(document.getElementById('stu-pin-head')) document.getElementById('stu-pin-head').innerText = (state.lang === 'de' ? 'PIN ändern' : 'تغيير الرقم السري');
  if(document.getElementById('stu-pin-hint')) document.getElementById('stu-pin-hint').innerText = (state.lang === 'de'
    ? 'Ändern Sie die PIN dieses Schülers. Bitte bewahren Sie die neue PIN sicher auf.'
    : 'يمكنك تغيير الرقم السري لهذا الطالب. الرجاء حفظ الرقم الجديد في مكان آمن.');
  if(document.getElementById('lbl-stu-old-pin')) document.getElementById('lbl-stu-old-pin').innerText = (state.lang === 'de' ? 'Alte PIN' : 'الرقم الحالي');
  if(document.getElementById('lbl-stu-new-pin')) document.getElementById('lbl-stu-new-pin').innerText = (state.lang === 'de' ? 'Neue PIN' : 'رقم جديد');
  if(document.getElementById('lbl-stu-new-pin2')) document.getElementById('lbl-stu-new-pin2').innerText = (state.lang === 'de' ? 'Neue PIN bestätigen' : 'تأكيد الرقم الجديد');
  if(document.getElementById('btn-stu-pin-save')) document.getElementById('btn-stu-pin-save').innerText = (state.lang === 'de' ? 'Speichern' : 'حفظ');


  // Re-render student progress / achievements in the new language (no new fetch)
  try{
    const totalAyahs = calcTotalAyahs_(state.studentProgress || []);
    const sumEl = document.getElementById('akte-prog-sum');
    const lastEl = document.getElementById('akte-prog-last');
    if(sumEl) sumEl.innerText = (state.studentProgress && state.studentProgress.length) ? (state.lang === 'de' ? `${totalAyahs} Verse` : `${totalAyahs} آية`) : '—';
    if(lastEl) lastEl.innerText = (state.studentProgress && state.studentProgress.length) ? progressLastLabel_(state.studentProgress) : '—';
    renderStudentProgressList(state.studentProgress || []);
    renderStudentHomeAchievements();
  }catch(e){}

  // Staff: message notifications label
  initMessageNotificationsUI();

  // Keep Aufgaben filter summary in sync
  try{ updateHomeworkFilterSummary(); }catch(e){}
}


function toggleLang() { 
  state.lang = state.lang === 'ar' ? 'de' : 'ar'; 
  updateLang(); 
  try{ __updateCloudIcon(); }catch(e){}
}

function toggleDarkMode() { 
  state.darkMode = !state.darkMode; 
  localStorage.setItem('darkMode', state.darkMode); 
  updateDarkModeIcon(); 
}

function updateDarkModeIcon() {
  const root = document.documentElement;
  const icon = document.getElementById('dark-mode-icon');
  if (!icon) return;
  if (state.darkMode) {
    root.classList.add('dark-mode');
    icon.classList.remove('fa-moon');
    icon.classList.add('fa-sun');
  } else {
    root.classList.remove('dark-mode');
    icon.classList.remove('fa-sun');
    icon.classList.add('fa-moon');
  }
}



function __updateHeaderHeightVar(){
  const hdr = document.querySelector('header.app-header');
  if(!hdr) return;
  document.documentElement.style.setProperty('--header-h', hdr.offsetHeight + 'px');
}


document.addEventListener('DOMContentLoaded', ()=>{
  updateDarkModeIcon();
  __updateHeaderHeightVar();
  window.addEventListener('resize', __updateHeaderHeightVar);
  // Unified login: no manual mode switching needed
  state.loginMode = state.loginMode || 'auto';
  applyRemembered();
  try{ renderSavedProfiles(); }catch(e){}

  try{ wireIosExitConfirm(); }catch(e){}
  try{ ensureExitGuardState(); }catch(e){}
});

function loadData(opts = {}) {
  opts = (opts && typeof opts === 'object') ? opts : {};
  const scope = String(opts.scope || opts.tab || 'all');

  const hdr = document.getElementById('hdr-sync');
  if(hdr) hdr.innerText = t('sync');

  return fetch(WEB_APP_URL, { 
    method: 'POST', 
    body: JSON.stringify({ action: 'getData', userName: state.user, role: state.role }) 
  })
  .then(r => r.json())
  .then(res => {
    if(res && res.ok) {
      state.students = res.students; 
      state.attendance = res.attendance; 
      state.teachers = res.teachers || [];
      state.lastId = res.lastId || 'N/A'; 
      state.studentInfos = res.studentInfos || []; 
      state.documents = res.documents || [];
      state.allUsers = res.allUsers || [];
      state.parentAbsencesToday = res.parentAbsencesToday || [];
      state.parentAbsentSet = new Set((state.parentAbsencesToday || []).map(x => String(x.studentRef || '').trim()).filter(Boolean));

      // Sync localStorage cache so teacher sees parent-reported absences immediately
      try {
        const k = todayKey();
        (state.students || []).forEach(st => {
          const ref = String(st.referenz || '').trim();
          if(!ref) return;
          localStorage.setItem(`qs_parent_absent:${ref}:${k}`, state.parentAbsentSet.has(ref) ? '1' : '0');
        });
      } catch(e) {}

      // Update only the currently requested scope (so the refresh icon updates ONLY the open tab)
      if(scope === 'students'){
        initFilters();
        try{ initBulkHomeworkUI(); }catch(e){}
  try{ initAllHomeworkUI(); }catch(e){}
        applyFilters();
        selectedForAttendance.clear();
        updateFabVisibility();
      } else if(scope === 'docs'){
        renderDocuments();
      } else if(scope === 'users'){
        if(state.role === 'Admin') renderUsersList();
      } else if(scope === 'stats'){
        renderStatistics();
      } else {
        // default full refresh (e.g., after login)
        if(state.role === 'Admin') renderUsersList();
        renderDocuments();
        populateTeacherSelect();
        initFilters();
        try{ initBulkHomeworkUI(); }catch(e){}
  try{ initAllHomeworkUI(); }catch(e){}
        applyFilters();
        loadMessages();
        selectedForAttendance.clear();
        updateFabVisibility();
      }

      const now = new Date(); 
      if(hdr){
        hdr.innerText = t('syncDone') + 
          now.getHours().toString().padStart(2,'0') + ":" + 
          now.getMinutes().toString().padStart(2,'0');
      }
    }
    return res;
  });
}

async function refreshData() {
  const hdr = document.getElementById('hdr-sync');
  if(hdr) hdr.innerText = t('sync');

  const tab = navState.currentTab || getMainTabId();
  const role = String(state.role || '').toLowerCase();

  const stampDone = () => {
    const now = new Date();
    if(hdr){
      hdr.innerText = t('syncDone') + 
        now.getHours().toString().padStart(2,'0') + ":" + 
        now.getMinutes().toString().padStart(2,'0');
    }
  };

  try{
    // Student: sync only the visible tab (plus anything it depends on)
    if(role === 'student'){
      if(tab === 'student-home'){
        await Promise.all([ loadStudentHome(), loadStudentProgress() ]);
      } else if(tab === 'student-homework'){
        await loadStudentHomework();
      } else if(tab === 'student-rating'){
        await Promise.all([ loadStudentEvaluations(), loadStudentAttendance(), loadStudentProgress() ]);
      } else if(tab === 'student-parent'){
        await loadParentAbsentState();
      } else if(tab === 'student-memorize'){
        renderSurahList();
      } else {
        await loadStudentHome();
      }
      stampDone();
      return;
    }

    // Staff/Admin: refresh ONLY the open tab
    if(tab === 'comm'){
      await loadMessages();
      stampDone();
      return;
    }
    if(tab === 'docs'){
      await loadData({scope:'docs'});
      return;
    }
    if(tab === 'users'){
      await loadData({scope:'users'});
      return;
    }
    if(tab === 'stats'){
      await loadData({scope:'stats'});
      return;
    }
    // students (default)
    await loadData({scope:'students'});
  }catch(e){
    if(hdr) hdr.innerText = (state.lang === 'de' ? 'Synchronisierung fehlgeschlagen' : 'فشلت المزامنة');
  }
}

function toggleFilter() { 
  document.getElementById('filter-panel').classList.toggle('open'); 
}

function handleSearchInput() { 
  if(document.getElementById('search-input').value.length > 0) {
    document.querySelectorAll('.chip.active').forEach(c => c.classList.remove('active'));
  }
  updateFilterState(); 
}

const DAY_DE_TO_AR = {
  "Montag": "الإثنين",
  "Dienstag": "الثلاثاء",
  "Mittwoch": "الأربعاء",
  "Donnerstag": "الخميس",
  "Freitag": "الجمعة",
  "Samstag": "السبت",
  "Sonntag": "الأحد",
};

// Match day chip key (German) against student.days string (which may be German or Arabic)
function dayMatches(studentDaysStr, dayKeyDe){
  const s = String(studentDaysStr || '');
  const lower = s.toLowerCase();

  const ar = DAY_DE_TO_AR[dayKeyDe] || '';
  const variants = [
    dayKeyDe,
    dayKeyDe.toLowerCase(),
    ar,
    ar.replace(/^ال/, ''), // sometimes stored without "ال"
    ar.replace('إ', 'ا'),
    ar.replace('أ', 'ا'),
    ar.replace('آ', 'ا'),
  ].filter(Boolean);

  return variants.some(v => s.includes(v) || lower.includes(String(v).toLowerCase()));
}

function initFilters() {
  const groups = [...new Set(state.students.map(s => s.group).filter(Boolean))].sort();
  const days = ["Montag", "Dienstag", "Mittwoch", "Donnerstag", "Freitag", "Samstag", "Sonntag"];

  const gContainer = document.getElementById('group-chips');
  if(gContainer){
    gContainer.innerHTML = '';
    groups.forEach(g => {
      const chip = document.createElement('div');
      chip.className = 'chip';
      chip.dataset.value = g;
      chip.innerText = g;
      if(state.filter.groups.includes(g)) chip.classList.add('active');
      chip.onclick = () => { chip.classList.toggle('active'); updateFilterState(); };
      gContainer.appendChild(chip);
    });
  }

  const dContainer = document.getElementById('day-chips');
  if(dContainer){
    dContainer.innerHTML = '';
    days.forEach(d => {
      const chip = document.createElement('div');
      chip.className = state.filter.days.includes(d) ? 'chip active' : 'chip';
      chip.dataset.value = d; // keep filter keys stable (German)
      chip.innerText = (state.lang === 'ar') ? (DAY_DE_TO_AR[d] || d) : d;
      chip.onclick = () => { chip.classList.toggle('active'); updateFilterState(); };
      dContainer.appendChild(chip);
    });
  }

  updateFilterState();
}

function updateFilterState() {
  state.filter.groups = Array.from(document.querySelectorAll('#group-chips .chip.active'))
    .map(c => c.dataset.value || c.innerText);

  state.filter.days = Array.from(document.querySelectorAll('#day-chips .chip.active'))
    .map(c => c.dataset.value || c.innerText);

  state.filter.search = (document.getElementById('search-input')?.value || '').toLowerCase();

  const finEl = document.getElementById('chk-fin-prob');
  const abgEl = document.getElementById('chk-abgemeldet');
  state.filter.financial = !!finEl?.checked;
  state.filter.abgemeldet = !!abgEl?.checked;

  applyFilters();
}

function applyFilters() {
  const f = state.filter;

  function matchesDayForStudent(s){
    if(f.days.length === 0) return true;
    const dayStr = String(s.days || '');
    return f.days.some(dKey => dayMatches(dayStr, dKey));
  }

  const baseFilter = (s) => {
    let raw = s.abgemeldet;
    // Robust "withdrawn/abgemeldet" detection (supports Arabic/DE variants)
    if (raw === true) raw = "true";
    if (raw === false) raw = "false";
    const t = String(raw ?? '').trim().toLowerCase();

    const isAbgemeldet = !!t &&
      !['false','0','nein','no','n','-','—','none','null','undefined','لا','كلا'].includes(t);

    if (f.abgemeldet) {
      if (!isAbgemeldet) return false;
    } else {
      if (isAbgemeldet) return false;
    }

    const matchesGroup = f.groups.length === 0 || f.groups.includes(s.group);
    const matchesSearch = !f.search || (s.fullName + " " + s.parentName + " " + s.phone).toLowerCase().includes(f.search);

    let matchesFin = true;
    if (f.financial) {
      matchesFin = (s.kontrolleBank && s.kontrolleBank !== "") || (s.finanzMark && s.finanzMark !== "");
    }

    // apply day filter only in "normal" view (not when viewing only abgemeldet)
    let matchesDay = true;
    if (!f.abgemeldet) matchesDay = matchesDayForStudent(s);

    return matchesGroup && matchesDay && matchesSearch && matchesFin;
  };

  state.filteredStudents = state.students.filter(baseFilter);

  // If day filter kills the list completely (common when days are stored in Arabic),
  // auto-clear day filter so users don't think the list is broken.
  if(
    state.filteredStudents.length === 0 &&
    state.students.length > 0 &&
    f.days.length > 0 &&
    !f.search &&
    f.groups.length === 0 &&
    !f.financial &&
    !f.abgemeldet
  ){
    f.days = [];
    initFilters(); // re-render chips with cleared selection
    return;
  }

  const countEl = document.getElementById('student-count-result');
  if(countEl) countEl.innerText = `Gefilterte Schüler: ${state.filteredStudents.length}`;

  renderStudentList();
  renderStatistics();
  // keep Aufgaben tab in sync with the global filter
  try{ updateHomeworkFilterSummary(); }catch(e){}
  try{ if(!document.getElementById("tab-homework-admin")?.classList.contains("hidden")){ renderBulkHomeworkStudents(); } }catch(e){}
  try{ if(!document.getElementById("hw-admin-all-view")?.classList.contains("hidden")){ renderAllHomeworkStudents(); } }catch(e){}
}

function renderStudentList() {
  const container = document.getElementById('students-list'); 
  container.innerHTML = '';
  const attendanceMap = state.attendance.reduce((acc, a) => { 
    (acc[a.fullName] = acc[a.fullName] || []).push(a); 
    return acc; 
  }, {});
  
  const todayDate = new Date().toLocaleDateString('de-DE', {day:'2-digit', month:'2-digit', year:'numeric'});
  
  state.filteredStudents.forEach(s => {
    const studentAttendance = attendanceMap[s.fullName] || [];
    const todayRecord = studentAttendance.find(a => a.date === todayDate);
    const currentStatus = todayRecord ? (todayRecord.status || 'N/A') : 'N/A'; 
    const isAbsentInDB = currentStatus.includes('غياب') || currentStatus.includes('Abwesend');
    const isLateInDB = currentStatus.includes('تأخير') || currentStatus.includes('Verspätet');
    const isSelected = selectedForAttendance.has(s.rowIndex);
    const myAtt = studentAttendance.sort((a,b) => b.date.localeCompare(a.date));
    
    let consecAbsences = 0; 
    for(let i=0; i<myAtt.length; i++) { 
      if(myAtt[i].status.includes("غياب") || myAtt[i].status === "Abwesend") {
        consecAbsences++; 
      } else if (myAtt[i].status.includes("حضور")) break; 
    }
    
    const isWarning = consecAbsences >= 3;
    const isFinancial = (s.kontrolleBank && s.kontrolleBank !== "") || (s.finanzMark && s.finanzMark !== "");
    
    const el = document.createElement('div');
    const pKey = `qs_parent_absent:${s.referenz}:${todayKey()}`;
    const parentAbsent = (state.parentAbsentSet && state.parentAbsentSet.has(String(s.referenz || '').trim())) || (localStorage.getItem(pKey) === '1');
    
    el.className = 'card';
    const imgHtml = s.fotoUrl ? `<img src="${s.fotoUrl}">` : (s.firstName ? s.firstName[0] : '?');
    
    let rightSide = '';
    if(state.role === 'Lehrer') {
      let btnClass, iconSvg;
      if(isSelected) {
         if (isAbsentInDB) { 
           btnClass = 'att-select-btn is-absent-db selected'; 
           iconSvg = `<i class="fa-solid fa-circle-check"></i>`; 
         } else { 
           btnClass = 'att-select-btn selected'; 
           iconSvg = `<i class="fa-solid fa-circle-xmark"></i>`; 
         }
      } else if (isAbsentInDB) { 
        btnClass = 'att-select-btn is-absent-db'; 
        iconSvg = `<i class="fa-solid fa-circle-xmark"></i>`; 
      } else { 
        btnClass = 'att-select-btn is-present'; 
        iconSvg = `<i class="fa-solid fa-circle-check"></i>`; 
      }
      const lateBtnClass = isLateInDB ? 'att-select-btn is-late-db' : 'att-select-btn';
      const lateIcon = `<i class="fa-solid fa-clock"></i>`;
      rightSide = `<div class="attend-actions">
        <button class="${btnClass}" onclick="toggleAttendanceSelection(this, ${s.rowIndex})" title="${t('btnAbsent')}">${iconSvg}</button>
        <button class="${lateBtnClass}" onclick="toggleLateAttendance(this, ${s.rowIndex})" title="${t('btnLate')}">${lateIcon}</button>
      </div>`;
    }
    
    el.innerHTML = `
      ${(state.role === 'Admin' && isFinancial) ? '<div class="money-badge">€</div>' : ''}
      <div class="card-avatar" onclick="openStudentDetail(${s.rowIndex})">${imgHtml}</div>
      <div class="card-info" onclick="openStudentDetail(${s.rowIndex})">
        <div class="font-bold" style="color: var(--text);">${s.fullName} ${(state.role !== 'Lehrer') ? `<span style="font-size:0.7rem; color:var(--primary);">[${s.referenz}]</span>` : ''}</div>
        ${parentAbsent ? `<div class="status-badge" style="background: var(--danger); color: white; opacity:0.9;"><i class="fa-solid fa-ban"></i> ${state.lang === 'de' ? 'Abwesend gemeldet' : 'مبلّغ غياب'}</div>` : ''}
        ${isLateInDB ? `<div class="status-badge" style="background: var(--warning); color: var(--text); opacity:0.9;"><i class="fa-solid fa-clock"></i> ${state.lang === 'de' ? 'Verspätet' : 'متأخر'}</div>` : ''}
        <div class="text-sm text-sec">${s.group} • ${s.days}</div>
        ${isWarning ? `<span class="status-badge status-warning">${t('repeatedAbs')}</span>` : ''}
        ${s.abgemeldet ? `<span class="status-badge status-warning">Abgemeldet</span>` : ''}
      </div>
      ${rightSide}
    `;
    
    container.appendChild(el);
  });
}

function toggleAttendanceSelection(btnElement, rowIndex) { 
  if(selectedForAttendance.has(rowIndex)) {
    selectedForAttendance.delete(rowIndex); 
  } else {
    selectedForAttendance.add(rowIndex); 
  }
  renderStudentList(); 
  updateFabVisibility(); 
}



function toggleLateAttendance(btnElement, rowIndex) {
  const s = state.students.find(x => x.rowIndex == rowIndex);
  if(!s) return;

  const todayDate = new Date().toLocaleDateString('de-DE', {day:'2-digit', month:'2-digit', year:'numeric'});
  const todayRecord = state.attendance.find(a => a.fullName === s.fullName && a.date === todayDate);
  const currentStatus = todayRecord ? (todayRecord.status || '') : '';
  const isLate = currentStatus.includes('تأخير') || currentStatus.includes('Verspätet');
  const newStatus = isLate ? 'NULL' : 'تأخير';

  // 1) Optimistic UI update (instant)
  if(todayRecord){
    todayRecord.status = newStatus;
  } else {
    state.attendance.push({ fullName: s.fullName, date: todayDate, status: newStatus });
  }

  // Re-render immediately so the button/badge becomes orange/normal right away
  renderStudentList();
  updateFabVisibility();

  // 2) Background save (queue + retry)
  enqueueSheetWrite({
    action: 'markAttendance',
    group: s.group,
    days: s.days,
    lastName: s.lastName,
    firstName: s.firstName,
    fullName: s.fullName,
    status: newStatus,
    teacherName: state.user
  }, { label: (state.lang === 'de') ? 'Verspätung' : 'تأخير' });

  // UX feedback
  if(newStatus === 'NULL'){
    showToast(state.lang === 'de' ? 'Verspätung entfernt (wird gespeichert...)' : 'تم حذف التأخير (جارٍ الحفظ...)');
  } else {
    showToast(state.lang === 'de' ? 'Verspätung gesetzt (wird gespeichert...)' : 'تم تسجيل التأخير (جارٍ الحفظ...)');
  }

  // kick background processing (safe)
  kickSyncQueue();
}


function updateFabVisibility() { 
  const fab = document.getElementById('fab-attendance'); 
  if(selectedForAttendance.size > 0) { 
    fab.classList.add('show'); 
    document.getElementById('lbl-send-btn').innerText = `${t('sendBatch')} (${selectedForAttendance.size})`; 
  } else { 
    fab.classList.remove('show'); 
  } 
}

async function submitBatchAttendance() {
  if(selectedForAttendance.size === 0) return;
  const studentsToProcess = state.students.filter(s => selectedForAttendance.has(s.rowIndex));
  document.getElementById('fab-attendance').classList.remove('show');
  document.getElementById('progress-overlay').classList.add('visible');
  const todayDate = new Date().toLocaleDateString('de-DE', {day:'2-digit', month:'2-digit', year:'numeric'});
  const attendanceMap = state.attendance.reduce((acc, a) => { 
    (acc[a.fullName] = acc[a.fullName] || []).push(a); 
    return acc; 
  }, {});
  
  let processedCount = 0;

  for (const s of studentsToProcess) {
    const currentStatus = (attendanceMap[s.fullName] || []).find(a => a.date === todayDate)?.status || 'N/A';
    let newStatus = (currentStatus.includes('غياب') || currentStatus.includes('Abwesend')) ? 'NULL' : 'غياب';
    
    await fetch(WEB_APP_URL, { 
      method: 'POST', 
      body: JSON.stringify({ 
        action: 'markAttendance', 
        group: s.group, 
        days: s.days, 
        lastName: s.lastName, 
        firstName: s.firstName, 
        fullName: s.fullName, 
        status: newStatus, 
        teacherName: state.user 
      }) 
    });
    
    processedCount++;
    document.getElementById('progress-fill').style.width = `${(processedCount / studentsToProcess.length) * 100}%`;
    document.getElementById('progress-text').innerText = `${processedCount} / ${studentsToProcess.length}`;
  }
  
  document.getElementById('success-msg').style.display = 'block';
  setTimeout(() => { 
    document.getElementById('progress-overlay').classList.remove('visible'); 
    selectedForAttendance.clear(); 
    refreshData(); 
  }, 1500);
}

// --- DETAIL & TABS LOGIC ---
function openStudentDetail(rowIndex) {
  const s = state.students.find(x => x.rowIndex == rowIndex); 
  if(!s) return;
  
  state.currentDetailStudent = s; 
  // reset evaluation UI (note-only switch)
  try{
    const chk = document.getElementById('eval-note-only');
    if(chk) chk.checked = false;
    const noteEl = document.getElementById('eval-note');
    if(noteEl) noteEl.value = '';
    toggleEvalNoteOnly();
  } catch(e) {}
  
  // reset homework UI (default: verses)
  try{
    const r = document.querySelector('input[name="hw-type"][value="memorized"]');
    if(r) r.checked = true;
    toggleHomeworkTypeUI();
    const ft = document.getElementById('hw-free-text');
    if(ft) ft.value = '';
    // keep verse fields as-is? better clear
    const hs = document.getElementById('hw-surah'); if(hs) hs.value = '';
    const h1 = document.getElementById('hw-start'); if(h1) h1.value = '';
    const h2 = document.getElementById('hw-end'); if(h2) h2.value = '';
  } catch(e) {}
document.getElementById('det-name').innerText = s.fullName;
  document.getElementById('det-sub').innerText = `${s.group} • ${s.days}`;
  document.getElementById('det-avatar').innerHTML = s.fotoUrl ? `<img src="${s.fotoUrl}">` : (s.firstName ? s.firstName[0] : '?');
  
  const grid = document.getElementById('det-grid'); 
  grid.innerHTML = '';
  
  const addField = (lbl, val) => { 
    if(val) grid.innerHTML += `<div class="detail-item"><div class="detail-label">${lbl}</div><div style="font-weight:600;">${linkify(val.toString())}</div></div>`; 
  };
  
  if (state.role === 'Admin') addField("Student ID", s.referenz);
  addField("Group", s.group); 
  addField("Days", s.days); 
  addField("Age", s.alter);
  addField("Gender", s.gender); 
  addField("Birth", s.birthDate); 
  addField("Infos", s.infos);
  addField("Phone", s.phone); 

  if(state.role === 'Admin') {
    addField("Parent", s.parentName); 
    addField("Email", s.email);
    addField("IBAN", s.iban); 
    addField("Betrag", s.betrag);
    if(s.kontrolleBank) addField("Bank Check", `<span style="color:var(--danger);"⚠️ ${s.kontrolleBank}</span>`);
    if(s.finanzMark) addField("Finance", `<span style="color:var(--danger);">⚠️ ${s.finanzMark}</span>`);
    addField("Abgemeldet", s.abgemeldet); 
    addField("Foto URL", s.fotoUrl);
    document.getElementById('btn-edit-stud').classList.remove('hidden');
    document.getElementById('btn-edit-stud').onclick = () => openEditStudent(s);
  } else {
    document.getElementById('btn-edit-stud').classList.add('hidden');
  }

  const myAtt = state.attendance.filter(a => a.fullName === s.fullName).sort((a,b) => b.date.localeCompare(a.date));
  const abs = myAtt.filter(a => a.status.includes('غياب') || a.status === 'Abwesend').map(a => a.date);
  
  document.getElementById('det-attendance-list').innerHTML = abs.length > 0 ? 
    `<h4 style="color:var(--danger)">Fehlzeiten (${abs.length})</h4><ul>${abs.map(d=>`<li>${d}</li>`).join('')}</ul>` : 
    `<p class="text-sec">Keine Fehlzeiten</p>`;
    
  const nList = document.getElementById('notes-list'); 
  nList.innerHTML = ''; 
  nList.dataset.studentName = s.fullName;
  
  state.studentInfos.filter(n => n.studentName === s.fullName).forEach(n => {
    nList.innerHTML += `<div class="note-item"><div>${linkify(n.message)}</div><div class="note-meta"><span>${n.author}</span><span>${n.date}</span></div></div>`;
  });

  loadHomeworkHistory(s.referenz);
  loadEvalHistory(s.referenz);
  
  let consec = 0; 
  for(let a of myAtt) { 
    if(a.status.includes("غياب")) consec++; 
    else break; 
  }
  
  const alertBox = document.getElementById('det-alert');
  if(consec >= 3) { 
    alertBox.innerText = t('absentAlert'); 
    alertBox.classList.remove('hidden'); 
  } else {
    alertBox.classList.add('hidden');
  }

  document.getElementById('btn-print-stud').onclick = () => printSingleStudent(s);

  switchDetailTab('info');
  openModal('detail-modal');
}

function switchDetailTab(tab) {
  ['info','attendance','curriculum','eval'].forEach(t => {
    document.getElementById(`dview-${t}`).classList.add('hidden');
    document.getElementById(`dt-${t}`).classList.remove('active');
  });
  
  document.getElementById(`dview-${tab}`).classList.remove('hidden');
  document.getElementById(`dt-${tab}`).classList.add('active');
}

// --- HOMEWORK & EVAL LOGIC ---
function getSelectedHomeworkType(){
  return document.querySelector('input[name="hw-type"]:checked')?.value || 'memorized';
}

function toggleHomeworkTypeUI(){
  const type = getSelectedHomeworkType();
  const verseFields = document.getElementById('hw-verses-fields');
  const textFields  = document.getElementById('hw-text-fields');
  if(verseFields) verseFields.classList.toggle('hidden', type === 'text');
  if(textFields)  textFields.classList.toggle('hidden', type !== 'text');
}

function assignHomework() {
  const sRef = state.currentDetailStudent?.referenz;
  if(!sRef) return;

  const type = getSelectedHomeworkType();

  let surah = '';
  let start = '';
  let end   = '';

  if(type === 'text'){
    const txt = (document.getElementById('hw-free-text')?.value || '').trim();
    if(!txt) return showToast(state.lang === 'de' ? 'Bitte Text eingeben' : 'اكتب نص الواجب');
    surah = 'TEXT|' + txt;
  } else {
    surah = (document.getElementById('hw-surah')?.value || '').trim();
    start = (document.getElementById('hw-start')?.value || '').trim();
    end   = (document.getElementById('hw-end')?.value || '').trim();

    if(!surah) return showToast(state.lang === 'de' ? 'Bitte Sure eingeben' : 'ادخل السورة');
    if(!start || !end) return showToast(state.lang === 'de' ? 'Bitte Vers-Bereich eingeben' : 'ادخل نطاق الآيات');

    // Verse-Range is always treated as memorization (Auswendig)
    surah = 'MEM|' + surah;
  }

  fetch(WEB_APP_URL, {
    method: 'POST', 
    body: JSON.stringify({ 
      action: 'assignHomework', 
      studentRef: sRef, 
      surah, 
      ayahStart: start, 
      ayahEnd: end, 
      teacherName: state.user 
    })
  }).then(r=>r.json()).then(res => {
    if(res.ok) { 
      showToast(state.lang === 'de' ? 'Gespeichert' : 'تم الحفظ'); 
      if(type === 'text'){
        const t = document.getElementById('hw-free-text'); 
        if(t) t.value = '';
      } else {
        document.getElementById('hw-surah').value = ''; 
        document.getElementById('hw-start').value = ''; 
        document.getElementById('hw-end').value = ''; 
      }
      loadHomeworkHistory(sRef); 
    }
  });
}


/* --- BULK HOMEWORK (Teacher/Admin) --- */
let bulkHwSelectedRefs = new Set();
let bulkHwListOverride = null; // when using current filter

function getBulkHomeworkType(){
  return document.querySelector('input[name="hw-type-bulk"]:checked')?.value || 'memorized';
}

function toggleBulkHomeworkTypeUI(){
  const type = getBulkHomeworkType();
  const verseFields = document.getElementById('hw-bulk-verses-fields');
  const textFields  = document.getElementById('hw-bulk-text-fields');
  if(verseFields) verseFields.classList.toggle('hidden', type === 'text');
  if(textFields)  textFields.classList.toggle('hidden', type !== 'text');
}

function setupHomeworkSurahDropdownBulk(){
  const inp = document.getElementById('hw-bulk-surah');
  const dd = document.getElementById('hw-bulk-surah-dd');
  if(!inp || !dd) return;

  function close(){
    dd.classList.add('hidden');
    dd.innerHTML = '';
  }

  // Avoid duplicate listeners if called multiple times
  if(inp._qsSurahBulkBound) return;
  inp._qsSurahBulkBound = true;

  inp.addEventListener('input', ()=>{
    const q = (inp.value||'').trim().toLowerCase();
    dd.innerHTML = '';
    if(!q){ close(); return; }

    const matches = SURAH_LIST.filter(([num,de,ar])=>{
      const n = String(num);
      const deL = String(de).toLowerCase();
      const arS = String(ar);
      const iniDe = initialsOfName(de);
      const iniAr = initialsOfName(arS);
      return n.startsWith(q) || deL.includes(q) || arS.includes(q) || iniDe.startsWith(q) || iniAr.startsWith(q);
    }).slice(0, 20);

    if(matches.length === 0){ close(); return; }

    matches.forEach(([num,de,ar])=>{
      const item = document.createElement('div');
      item.style.padding = '8px';
      item.style.borderBottom = '1px solid var(--border)';
      item.style.cursor = 'pointer';
      item.innerHTML = `<b style="color:var(--primary)">${num}</b> — ${escapeHtml(de)} — ${escapeHtml(ar)}`;
      item.onclick = ()=>{
        inp.value = String(num);
        close();
      };
      dd.appendChild(item);
    });

    dd.classList.remove('hidden');
  });

  inp.addEventListener('blur', ()=> setTimeout(()=>{
    try{
      if(document.activeElement !== inp) close();
    }catch(e){ close(); }
  }, 150));
}


function formatUnifiedFilterSummary(){
  const groups = (state.filter && Array.isArray(state.filter.groups)) ? state.filter.groups : [];
  const days   = (state.filter && Array.isArray(state.filter.days)) ? state.filter.days : [];

  const gText = (groups.length > 0) ? groups.join(', ') : (state.lang==='de' ? 'Alle Gruppen' : 'كل الأقسام');
  const dText = (days.length > 0)
    ? days.map(d => (state.lang==='ar' ? (DAY_DE_TO_AR[d] || d) : d)).join(', ')
    : (state.lang==='de' ? 'Alle Tage' : 'كل الأيام');

  return (state.lang==='de')
    ? `Filter: ${gText} • ${dText}`
    : `الفلتر: ${gText} • ${dText}`;
}

function updateHomeworkFilterSummary(){
  const t1 = document.getElementById('hw-filter-summary-assign-text');
  const t2 = document.getElementById('hw-filter-summary-all-text');
  const txt = formatUnifiedFilterSummary();
  if(t1) t1.textContent = txt;
  if(t2) t2.textContent = txt;

  const b1 = document.getElementById('txt-hw-open-filter');
  const b2 = document.getElementById('txt-hw-open-filter-2');
  if(b1) b1.textContent = (state.lang==='de') ? 'Filter' : 'فلتر';
  if(b2) b2.textContent = (state.lang==='de') ? 'Filter' : 'فلتر';
}

function initBulkHomeworkUI(){
  // Teacher/Admin: Aufgaben uses the SAME filter as Schüler (global filter panel)
  try{ updateHomeworkFilterSummary(); }catch(e){}

  // Ensure UI state
  setupHomeworkSurahDropdownBulk();
  toggleBulkHomeworkTypeUI();

  // Render list (keep selection)
  renderBulkHomeworkStudents();
}




// ===== Homework Admin: All Homework View =====
let hwAllSelectedRefs = new Set();
let hwAllExpandedRefs = new Set();
let hwAllHomeworkCache = new Map(); // ref -> homework array

// --- Homework selection + bulk actions (by homework item) ---
const LOCAL_HIDDEN_HW_KEY = 'hidden_hw_rowidx_v1';
let hwAllPrimeTimer = null;
let hwAllPriming = false;

function getHiddenHwSet(){
  try{
    const raw = localStorage.getItem(LOCAL_HIDDEN_HW_KEY);
    const arr = raw ? JSON.parse(raw) : [];
    return new Set((Array.isArray(arr)?arr:[]).map(n=>Number(n)||0).filter(Boolean));
  }catch(e){ return new Set(); }
}
function persistHiddenHwSet(set){
  try{
    const arr = Array.from(set||[]).map(n=>Number(n)||0).filter(Boolean);
    localStorage.setItem(LOCAL_HIDDEN_HW_KEY, JSON.stringify(arr));
  }catch(e){}
}
function hideHomeworkRowLocal(rowIndex){
  rowIndex = Number(rowIndex||0);
  if(!rowIndex) return;
  const set = getHiddenHwSet();
  set.add(rowIndex);
  persistHiddenHwSet(set);
}

function hwKeyObj(h){
  const surah = String(h?.surah||'').trim();
  const a1 = String(h?.ayahStart ?? h?.start ?? '').trim();
  const a2 = String(h?.ayahEnd ?? h?.end ?? '').trim();
  return { surah: surah, ayahStart: a1, ayahEnd: a2 };
}
function hwKeyStr(h){
  return JSON.stringify(hwKeyObj(h));
}
function hwKeyEqual(h, keyObj){
  if(!keyObj) return false;
  const o = hwKeyObj(h);
  return (
    o.surah === String(keyObj.surah||'').trim() &&
    o.ayahStart === String(keyObj.ayahStart||'').trim() &&
    o.ayahEnd === String(keyObj.ayahEnd||'').trim()
  );
}

function hwDisplayLabel(h){
  const info = decodeHomeworkSurah(h?.surah);
  const a1 = String(h?.ayahStart||'').trim();
  const a2 = String(h?.ayahEnd||'').trim();

  if(info.kind === 'text'){
    const txt = (info.freeText || '').trim();
    const shortTxt = txt.length > 40 ? (txt.slice(0,40)+'…') : txt;
    return (state.lang==='de' ? `Text: ${shortTxt}` : `نص: ${shortTxt}`);
  }

  const sur = info.label || info.surahText || '';
  const range = (a1 && a2) ? `${a1}-${a2}` : (a1||a2||'');
  const badge = info.kind==='memorized' ? (state.lang==='de'?'(Auswendig)':'(حفظ)') : '';
  return `${sur}${range ? ' • '+range : ''} ${badge}`.trim();
}

function setAllHomeworkSelectOptions(options){
  const sel = document.getElementById('hw-all-hw-select');
  if(!sel) return;
  const prev = sel.value || '';
  sel.innerHTML = '';
  const o0 = document.createElement('option');
  o0.value = '';
  o0.textContent = (state.lang==='de') ? 'Hausaufgabe wählen…' : 'اختر الواجب…';
  sel.appendChild(o0);

  (options||[]).forEach(opt=>{
    const o = document.createElement('option');
    o.value = opt.sigKey;
    o.textContent = opt.label;
    sel.appendChild(o);
  });

  if(prev && Array.from(sel.options).some(o=>o.value===prev)){
    sel.value = prev;
  }
}

function schedulePrimeAllHomeworkOptions(){
  clearTimeout(hwAllPrimeTimer);
  hwAllPrimeTimer = setTimeout(()=>primeAllHomeworkOptionsForVisibleStudents(), 450);
}

async function fetchStudentHomeworkIntoCache(ref){
  ref = String(ref||'').trim();
  if(!ref) return [];
  if(hwAllHomeworkCache.has(ref)) return hwAllHomeworkCache.get(ref) || [];
  try{
    const res = await fetch(WEB_APP_URL, {
      method: 'POST',
      headers: { "Content-Type": "text/plain" },
      body: JSON.stringify({ action: 'getStudentHomework', studentRef: ref })
    }).then(r=>r.json());
    const raw = (res && res.ok) ? (res.homework || []) : [];
    // Normalize field names for consistent matching
    const list = (raw||[]).map(h=>({
      ...h,
      ayahStart: String(h?.ayahStart ?? h?.start ?? '').trim(),
      ayahEnd:   String(h?.ayahEnd ?? h?.end ?? '').trim()
    }));
    hwAllHomeworkCache.set(ref, list);
    return list;
  }catch(e){
    hwAllHomeworkCache.set(ref, []);
    return [];
  }
}

async function primeAllHomeworkOptionsForVisibleStudents(){
  if(hwAllPriming) return;
  hwAllPriming = true;

  const statusEl = document.getElementById('hw-all-status');
  try{
    const list = getAllHomeworkCurrentStudentList();
    if(list.length === 0){
      setAllHomeworkSelectOptions([]);
      if(statusEl) statusEl.textContent = '';
      return;
    }

    if(statusEl) statusEl.textContent = (state.lang==='de') ? 'Lade Hausaufgaben-Liste…' : 'جارٍ تجهيز قائمة الواجبات…';

    const hidden = getHiddenHwSet();
    const sigMap = new Map(); // keyStr -> {sigKey,label}

    const refs = list.map(s=>String(s.referenz||'').trim()).filter(Boolean);

    // Prefer ONE backend call (fast)
    let bulkOk = false;
    try{
      const res = await fetch(WEB_APP_URL, {
        method:'POST',
        headers: { "Content-Type": "text/plain" },
        body: JSON.stringify({ action:'getHomeworkForStudents', studentRefs: refs })
      }).then(r=>r.json());

      if(res && res.ok && res.homeworkByStudent && typeof res.homeworkByStudent === 'object'){
        bulkOk = true;
        for(const ref of refs){
          const raw = Array.isArray(res.homeworkByStudent[ref]) ? res.homeworkByStudent[ref] : [];
          const norm = raw.map(h=>({
            ...h,
            ayahStart: String(h?.ayahStart ?? h?.start ?? '').trim(),
            ayahEnd:   String(h?.ayahEnd ?? h?.end ?? '').trim()
          }));
          hwAllHomeworkCache.set(ref, norm);
          norm.forEach(h=>{
            const row = Number(h.rowIndex||0);
            if(row && hidden.has(row)) return;
            const keyStr = hwKeyStr(h);
            if(!keyStr) return;
            if(!sigMap.has(keyStr)){
              sigMap.set(keyStr, { sigKey: encodeURIComponent(keyStr), label: hwDisplayLabel(h) });
            }
          });
        }
      }
    }catch(e){ /* ignore, fallback below */ }

    if(!bulkOk){
      // Fallback: per-student fetching (older backend)
      const limit = 4;
      let i = 0;

      async function worker(){
        while(i < refs.length){
          const my = refs[i++];
          const hw = await fetchStudentHomeworkIntoCache(my);
          (hw||[]).forEach(h=>{
            const row = Number(h.rowIndex||0);
            if(row && hidden.has(row)) return;
            const keyStr = hwKeyStr(h);
            if(!keyStr) return;
            if(!sigMap.has(keyStr)){
              sigMap.set(keyStr, { sigKey: encodeURIComponent(keyStr), label: hwDisplayLabel(h) });
            }
          });
        }
      }

      const workers = Array.from({length: Math.min(limit, refs.length)}, ()=>worker());
      await Promise.all(workers);
    }

    const options = Array.from(sigMap.values()).sort((a,b)=>String(a.label).localeCompare(String(b.label)));
    setAllHomeworkSelectOptions(options);

    if(statusEl) statusEl.textContent = (state.lang==='de')
      ? `Bereit • ${options.length} Hausaufgaben gefunden.`
      : `جاهز • تم العثور على ${options.length} واجب.`;
  }finally{
    hwAllPriming = false;
  }
}

function getSelectedHomeworkSig(){
  const sel = document.getElementById('hw-all-hw-select');
  const rawVal = sel ? String(sel.value||'') : '';
  if(!rawVal) return null;
  try{
    const jsonStr = decodeURIComponent(rawVal);
    const obj = JSON.parse(jsonStr);
    if(!obj || typeof obj !== 'object') return null;
    return {
      surah: String(obj.surah||'').trim(),
      ayahStart: String(obj.ayahStart||'').trim(),
      ayahEnd: String(obj.ayahEnd||'').trim()
    };
  }catch(e){
    return null;
  }
}

async function deleteHomeworkRowSilent(rowIndex){
  rowIndex = Number(rowIndex||0);
  if(!rowIndex) return false;

  // Try known/likely backend actions
  const tries = ['deleteHomeworkRow','deleteHomework','removeHomework'];
  for(const actionName of tries){
    try{
      const res = await fetch(WEB_APP_URL, {
        method:'POST',
        headers: { "Content-Type": "text/plain" },
        body: JSON.stringify({ action: actionName, rowIndex: rowIndex, teacherName: state.user })
      }).then(r=>r.json());
      if(res && res.ok) return true;
    }catch(e){}
  }
  return false;
}

async function bulkConfirmSelectedHomework(makeConfirmed){
  const keyObj = getSelectedHomeworkSig();
  if(!keyObj){
    showToast(state.lang==='de' ? 'Bitte Hausaufgabe auswählen.' : 'اختر الواجب أولاً.');
    return;
  }

  const refs = Array.from(hwAllSelectedRefs || []);
  if(refs.length === 0){
    showToast(state.lang==='de' ? 'Bitte mindestens einen Schüler auswählen.' : 'اختر طالباً واحداً على الأقل.');
    return;
  }

  const statusEl = document.getElementById('hw-all-status');
  if(statusEl) statusEl.textContent = (state.lang==='de' ? 'Aktualisiere…' : 'جارٍ التحديث…');

  // Try server-side bulk update (fast)
  try{
    const res = await fetch(WEB_APP_URL, {
      method:'POST',
      headers: { "Content-Type": "text/plain" },
      body: JSON.stringify({
        action: 'bulkSetHomeworkConfirmed',
        studentRefs: refs,
        surah: keyObj.surah,
        ayahStart: keyObj.ayahStart,
        ayahEnd: keyObj.ayahEnd,
        confirmed: !!makeConfirmed,
        teacherName: state.user
      })
    }).then(r=>r.json());

    if(res && res.ok){
      if(statusEl){
        statusEl.textContent = (state.lang==='de')
          ? `Fertig: ${res.updated || 0} aktualisiert.`
          : `تم: تحديث ${res.updated || 0}.`;
      }
      showToast(state.lang==='de' ? 'Aktualisiert' : 'تم التحديث');

      // refresh caches + UI
      refs.forEach(r=>hwAllHomeworkCache.delete(r));
      hwAllExpandedRefs.forEach(r=>{
        if(refs.includes(r)) ensureAllHomeworkLoaded(r);
      });
      renderAllHomeworkStudents();
      schedulePrimeAllHomeworkOptions();
      return;
    }
  }catch(e){}

  // Fallback (older backend): toggle per-row
  let touched = 0, ok = 0;
  for(const ref of refs){
    const list = await fetchStudentHomeworkIntoCache(ref);
    const matches = (list||[]).filter(h=>hwKeyEqual(h, keyObj));
    for(const h of matches){
      const rowIndex = Number(h.rowIndex||0);
      if(!rowIndex) continue;
      touched++;
      const resOk = await toggleHomeworkConfirmedSilent(rowIndex, !!makeConfirmed);
      if(resOk) ok++;
    }
    hwAllHomeworkCache.delete(ref);
    if(hwAllExpandedRefs.has(ref)) ensureAllHomeworkLoaded(ref);
  }

  if(statusEl){
    statusEl.textContent = (state.lang==='de')
      ? `Fertig: ${ok}/${touched} aktualisiert.`
      : `تم: تحديث ${ok} من ${touched}.`;
  }
  if(touched>0) showToast(state.lang==='de' ? 'Aktualisiert' : 'تم التحديث');
  schedulePrimeAllHomeworkOptions();
}

async function bulkDeleteSelectedHomework(){
  const keyObj = getSelectedHomeworkSig();
  if(!keyObj){
    showToast(state.lang==='de' ? 'Bitte Hausaufgabe auswählen.' : 'اختر الواجب أولاً.');
    return;
  }

  const refs = Array.from(hwAllSelectedRefs || []);
  if(refs.length === 0){
    showToast(state.lang==='de' ? 'Bitte mindestens einen Schüler auswählen.' : 'اختر طالباً واحداً على الأقل.');
    return;
  }

  const statusEl = document.getElementById('hw-all-status');
  if(statusEl) statusEl.textContent = (state.lang==='de' ? 'Lösche…' : 'جارٍ الحذف…');

  // Try server-side bulk delete (fast)
  try{
    const res = await fetch(WEB_APP_URL, {
      method:'POST',
      headers: { "Content-Type": "text/plain" },
      body: JSON.stringify({
        action: 'bulkDeleteHomework',
        studentRefs: refs,
        surah: keyObj.surah,
        ayahStart: keyObj.ayahStart,
        ayahEnd: keyObj.ayahEnd,
        teacherName: state.user
      })
    }).then(r=>r.json());

    if(res && res.ok){
      if(statusEl){
        statusEl.textContent = (state.lang==='de')
          ? `Fertig: ${res.deleted || 0} gelöscht.`
          : `تم: حذف ${res.deleted || 0}.`;
      }
      showToast(state.lang==='de' ? 'Erledigt' : 'تم');

      refs.forEach(r=>hwAllHomeworkCache.delete(r));
      hwAllExpandedRefs.forEach(r=>{
        if(refs.includes(r)) ensureAllHomeworkLoaded(r);
      });
      renderAllHomeworkStudents();
      schedulePrimeAllHomeworkOptions();
      return;
    }
  }catch(e){}

  // Fallback (older backend): delete by rowIndex (or hide locally)
  let touched = 0, ok = 0, hiddenOnly = 0;

  for(const ref of refs){
    const list = await fetchStudentHomeworkIntoCache(ref);
    const matches = (list||[]).filter(h=>hwKeyEqual(h, keyObj));
    for(const h of matches){
      const rowIndex = Number(h.rowIndex||0);
      if(!rowIndex) continue;
      touched++;
      const resOk = await deleteHomeworkRowSilent(rowIndex);
      if(resOk){
        ok++;
      }else{
        hideHomeworkRowLocal(rowIndex);
        hiddenOnly++;
      }
    }
    hwAllHomeworkCache.delete(ref);
    if(hwAllExpandedRefs.has(ref)) ensureAllHomeworkLoaded(ref);
  }

  if(statusEl){
    if(hiddenOnly>0 && ok===0){
      statusEl.textContent = (state.lang==='de')
        ? `Hinweis: Einträge wurden lokal ausgeblendet (${hiddenOnly}). (Server-Löschung nicht verfügbar)`
        : `ملاحظة: تم إخفاء ${hiddenOnly} إدخال محلياً (الحذف من السيرفر غير متاح).`;
    }else{
      statusEl.textContent = (state.lang==='de')
        ? `Fertig: ${ok}/${touched} gelöscht.`
        : `تم: حذف ${ok} من ${touched}.`;
    }
  }
  showToast(state.lang==='de' ? 'Erledigt' : 'تم');
  renderAllHomeworkStudents();
  schedulePrimeAllHomeworkOptions();
}


async function deleteOneHomeworkEntryForStudent(ref, rowIndex){
  ref = String(ref||'').trim();
  rowIndex = Number(rowIndex||0);
  if(!ref || !rowIndex) return;

  const ok = await deleteHomeworkRowSilent(rowIndex);
  if(ok){
    showToast(state.lang==='de' ? 'Gelöscht' : 'تم الحذف');
  }else{
    hideHomeworkRowLocal(rowIndex);
    showToast(state.lang==='de' ? 'Ausgeblendet (lokal)' : 'تم الإخفاء (محلياً)');
  }

  hwAllHomeworkCache.delete(ref);
  if(hwAllExpandedRefs.has(ref)) ensureAllHomeworkLoaded(ref);
  renderAllHomeworkStudents();
  schedulePrimeAllHomeworkOptions();
}


function openAllHomeworkAdmin(){
  document.getElementById('hw-admin-assign-header')?.classList.add('hidden');
  document.getElementById('hw-admin-assign-view')?.classList.add('hidden');
  document.getElementById('hw-admin-all-view')?.classList.remove('hidden');
  // ensure filters are populated
  try{ initAllHomeworkUI(); }catch(e){}
  renderAllHomeworkStudents();
  // update top button label if needed
  try{ updateLang(); }catch(e){}
}

function openAssignHomeworkAdmin(){
  document.getElementById('hw-admin-assign-header')?.classList.remove('hidden');
  document.getElementById('hw-admin-all-view')?.classList.add('hidden');
  document.getElementById('hw-admin-assign-view')?.classList.remove('hidden');
  // no-op
}

function initAllHomeworkUI(){
  // Teacher/Admin: Aufgaben uses the SAME filter as Schüler (global filter panel)
  try{ updateHomeworkFilterSummary(); }catch(e){}

  // placeholder
  const s = document.getElementById('hw-all-search');
  if(s) s.placeholder = (state.lang === 'de') ? 'Suchen...' : 'بحث...';

  // homework selector placeholder handled in updateLang()
}


function getAllHomeworkCurrentStudentList(){
  // Use the unified global filter (same as Schüler tab)
  const base = Array.isArray(state.filteredStudents) ? state.filteredStudents : (state.students || []);
  const q = (document.getElementById('hw-all-search')?.value || '').trim().toLowerCase();

  return (base || []).filter(s=>{
    if(q){
      const hay = `${s.fullName||''} ${s.parentName||''} ${s.phone||''} ${s.referenz||''}`.toLowerCase();
      if(!hay.includes(q)) return false;
    }
    return true;
  });
}


function toggleAllHomeworkSelectAll(checked){
  const list = getAllHomeworkCurrentStudentList();
  if(checked){
    list.forEach(s=>{
      const ref = String(s.referenz||'').trim();
      if(ref) hwAllSelectedRefs.add(ref);
    });
  }else{
    // only clear visible
    list.forEach(s=>{
      const ref = String(s.referenz||'').trim();
      if(ref) hwAllSelectedRefs.delete(ref);
    });
  }
  renderAllHomeworkStudents();
}

function safeIdFromRef(ref){
  return 'hwref_' + String(ref||'').replace(/[^a-zA-Z0-9_-]/g,'_');
}

function renderAllHomeworkStudents(){
  const box = document.getElementById('hw-all-students');
  const countEl = document.getElementById('hw-all-count');
  const selAll = document.getElementById('hw-all-selectall');
  if(!box) return;

  const list = getAllHomeworkCurrentStudentList();
  if(countEl) countEl.textContent = String(list.length);

  // sync select-all with visible list
  if(selAll){
    const visibleRefs = list.map(s=>String(s.referenz||'').trim()).filter(Boolean);
    selAll.checked = visibleRefs.length>0 && visibleRefs.every(r=>hwAllSelectedRefs.has(r));
  }

  box.innerHTML = '';
  if(list.length === 0){
    const empty = document.createElement('div');
    empty.className = 'bulk-empty';
    empty.textContent = (state.lang==='de') ? 'Keine Schüler gefunden.' : 'لا يوجد طلاب.';
    box.appendChild(empty);
    return;
  }

  list.forEach(s=>{
    const ref = String(s.referenz||'').trim();
    const row = document.createElement('div');
    row.className = 'bulk-row';
    const checked = ref && hwAllSelectedRefs.has(ref);
    const expanded = ref && hwAllExpandedRefs.has(ref);
    const caret = expanded ? '▾' : '▸';

    row.innerHTML = `
      <div class="bulk-left">
        <input type="checkbox" ${checked ? 'checked' : ''} ${ref ? '' : 'disabled'} />
        <div style="min-width:0;">
          <div class="bulk-name">${escapeHtml(s.fullName || '')}</div>
        </div>
      </div>
      <button class="hw-expand-btn" type="button" ${ref ? '' : 'disabled'} aria-label="expand">${caret}</button>
    `;

    const cb = row.querySelector('input[type="checkbox"]');
    cb?.addEventListener('change', ()=>{
      if(!ref) return;
      if(cb.checked) hwAllSelectedRefs.add(ref);
      else hwAllSelectedRefs.delete(ref);
      renderAllHomeworkStudents();
    });

    const btn = row.querySelector('.hw-expand-btn');
    btn?.addEventListener('click', (ev)=>{
      ev.stopPropagation();
      if(!ref) return;
      if(hwAllExpandedRefs.has(ref)) hwAllExpandedRefs.delete(ref);
      else hwAllExpandedRefs.add(ref);
      renderAllHomeworkStudents();
      if(hwAllExpandedRefs.has(ref)){
        ensureAllHomeworkLoaded(ref);
      }
    });

    // click row toggles expand (not checkbox)
    row.addEventListener('click', (ev)=>{
      if(ev.target && (ev.target.tagName||'').toLowerCase()==='input') return;
      if(ev.target && ev.target.classList && ev.target.classList.contains('hw-expand-btn')) return;
      if(!ref) return;
      if(hwAllExpandedRefs.has(ref)) hwAllExpandedRefs.delete(ref);
      else hwAllExpandedRefs.add(ref);
      renderAllHomeworkStudents();
      if(hwAllExpandedRefs.has(ref)){
        ensureAllHomeworkLoaded(ref);
      }
    });

    box.appendChild(row);

    // panel
    if(ref && hwAllExpandedRefs.has(ref)){
      const panel = document.createElement('div');
      panel.className = 'hw-all-panel';
      panel.id = safeIdFromRef(ref);
      panel.innerHTML = `<div class="text-sm text-sec">${state.lang==='de'?'Lade...':'جارٍ التحميل...'}</div>`;
      box.appendChild(panel);

      // if already cached, render immediately
      const cached = hwAllHomeworkCache.get(ref);
      if(Array.isArray(cached)){
        renderAllHomeworkPanel(ref, cached);
      }
    }
  });
  schedulePrimeAllHomeworkOptions();
}

function ensureAllHomeworkLoaded(ref){
  ref = String(ref||'').trim();
  if(!ref) return;
  if(hwAllHomeworkCache.has(ref)){
    const cached = hwAllHomeworkCache.get(ref);
    if(Array.isArray(cached)) renderAllHomeworkPanel(ref, cached);
    return;
  }

  fetch(WEB_APP_URL, { 
    method: 'POST', 
    body: JSON.stringify({ action: 'getStudentHomework', studentRef: ref }) 
  }).then(r=>r.json()).then(res=>{
    if(res && res.ok){
      hwAllHomeworkCache.set(ref, res.homework || []);
      renderAllHomeworkPanel(ref, res.homework || []);
    }else{
      hwAllHomeworkCache.set(ref, []);
      renderAllHomeworkPanel(ref, []);
    }
  }).catch(()=>{
    hwAllHomeworkCache.set(ref, []);
    renderAllHomeworkPanel(ref, []);
  });
}

function renderAllHomeworkPanel(ref, homework){
  const panel = document.getElementById(safeIdFromRef(ref));
  if(!panel) return;

  const hidden = getHiddenHwSet();
  const raw = Array.isArray(homework) ? homework : [];
  const list = raw.filter(h=>{
    const row = Number(h?.rowIndex||0);
    if(row && hidden.has(row)) return false;
    return true;
  });

  if(list.length === 0){
    panel.innerHTML = `<div class="text-sm text-sec">${state.lang==='de'?'Keine Einträge.':'لا يوجد واجبات.'}</div>`;
    return;
  }

  // newest first if date is present
  const sorted = list.slice().sort((a,b)=>{
    const da = String(a?.date||'');
    const db = String(b?.date||'');
    return db.localeCompare(da);
  });

  panel.innerHTML = '';
  sorted.forEach(h=>{
    const info = decodeHomeworkSurah(h?.surah);
    const date = escapeHtml(h?.date || '');
    const teacher = h?.teacher ? (' • ' + escapeHtml(h.teacher)) : '';
    const rowIndex = Number(h?.rowIndex || 0);
    const sigKey = encodeURIComponent(hwKeyStr(h));

    const confirmed = (h?.confirmed === true)
      || (String(h?.confirmed || '').trim() === '1')
      || (String(h?.confirmed || '').toLowerCase() === 'true')
      || (String(h?.confirmedFlag || '').trim() === '1')
      || (String(h?.confirmedFlag || '').toLowerCase() === 'true');

    const confLabel = (info.kind === 'text')
      ? (state.lang==='de'?'Als erledigt bestätigt':'تم تنفيذ الواجب')
      : (state.lang==='de'?'Als auswendig bestätigt':'تم التسميع (حفظ)');

    let title = '';
    let body = '';

    if(info.kind === 'text'){
      title = (state.lang==='de' ? 'Text' : 'نص');
      body = escapeHtml(info.freeText || '');
    } else {
      title = escapeHtml(info.label || info.surahText || '');
      const a1 = String(h?.ayahStart || '').trim();
      const a2 = String(h?.ayahEnd || '').trim();
      body = escapeHtml([a1,a2].filter(Boolean).join(' - '));
      if(info.badge){
        title += ` <span class="pill" style="margin-left:6px; font-size:0.78rem; padding:2px 8px;">${escapeHtml(info.badge)}</span>`;
      }
    }

    const el = document.createElement('div');
    el.className = 'hw-all-item';
    el.dataset.rowIndex = String(rowIndex||'');
    el.dataset.sig = sigKey;

    el.innerHTML = `
      <div class="hw-all-left">
        <div class="hw-all-title" style="font-weight:900; font-size:0.95rem;">${title}</div>
        <div class="hw-all-meta text-sm text-sec" style="margin-top:1px;">${date}${teacher}</div>
        ${body ? `<div class="hw-all-body" style="margin-top:3px; white-space:pre-wrap;">${body}</div>` : ``}
      </div>
      <div class="hw-all-actions">
        <label class="hw-mini-toggle">
          <input type="checkbox" ${confirmed ? 'checked' : ''} ${rowIndex ? '' : 'disabled'} />
          <span>${escapeHtml(confLabel)}</span>
        </label>
        <button class="icon-btn-mini danger" type="button" data-row="${rowIndex}" title="${state.lang==='de'?'Löschen':'حذف'}" ${rowIndex ? '' : 'disabled'}><i class="fa-solid fa-trash"></i></button>
      </div>
    `;

    const chk = el.querySelector('input[type="checkbox"]');
    chk?.addEventListener('change', ()=>{
      if(!rowIndex) return;
      toggleHomeworkConfirmedSilent(rowIndex, chk.checked).then(ok=>{
        if(ok){
          hwAllHomeworkCache.delete(String(ref));
          ensureAllHomeworkLoaded(String(ref));
          schedulePrimeAllHomeworkOptions();
        }
      });
    });

    const delBtn = el.querySelector('button.icon-btn-mini.danger');
    delBtn?.addEventListener('click', (ev)=>{
      ev.stopPropagation();
      if(!rowIndex) return;
      deleteOneHomeworkEntryForStudent(String(ref), rowIndex);
    });

    panel.appendChild(el);
  });
}


function toggleHomeworkConfirmedSilent(rowIndex, confirmed){
  rowIndex = Number(rowIndex || 0);
  if(!rowIndex) return Promise.resolve(false);

  return fetch(WEB_APP_URL, {
    method: 'POST',
    headers: { "Content-Type": "text/plain" },
    body: JSON.stringify({
      action: 'toggleHomeworkConfirmed',
      rowIndex: rowIndex,
      confirmed: !!confirmed,
      teacherName: state.user
    })
  }).then(r=>r.json()).then(res=>{
    if(res && res.ok){
      return true;
    }
    return false;
  }).catch(()=>false);
}

async function bulkConfirmAllHomework(makeConfirmed){
  const statusEl = document.getElementById('hw-all-status');
  const refs = Array.from(hwAllSelectedRefs || []);
  if(refs.length === 0){
    showToast(state.lang==='de' ? 'Bitte mindestens einen Schüler auswählen.' : 'اختر طالباً واحداً على الأقل.');
    return;
  }
  if(statusEl) statusEl.textContent = (state.lang==='de' ? 'Lade Hausaufgaben...' : 'جارٍ تحميل الواجبات...');

  let touched = 0;
  let ok = 0;

  for(const ref of refs){
    let list = hwAllHomeworkCache.get(ref);
    if(!Array.isArray(list)){
      // fetch on demand
      try{
        const res = await fetch(WEB_APP_URL, { method:'POST', body: JSON.stringify({ action:'getStudentHomework', studentRef: ref }) }).then(r=>r.json());
        list = (res && res.ok) ? (res.homework || []) : [];
        hwAllHomeworkCache.set(ref, list);
      }catch(e){
        list = [];
        hwAllHomeworkCache.set(ref, list);
      }
    }

    // toggle only those that differ
    const toToggle = (list||[]).filter(h=>{
      const rowIndex = Number(h.rowIndex||0);
      if(!rowIndex) return false;
      const confirmed = (h.confirmed === true) || (String(h.confirmed || '').trim().toLowerCase() === 'true') || (String(h.confirmed || '').trim() === '1');
      return makeConfirmed ? !confirmed : confirmed;
    });

    for(const h of toToggle){
      touched++;
      const rowIndex = Number(h.rowIndex||0);
      const r = await toggleHomeworkConfirmedSilent(rowIndex, makeConfirmed);
      if(r) ok++;
    }

    // refresh cache for this student if expanded or selected
    hwAllHomeworkCache.delete(ref);
    if(hwAllExpandedRefs.has(ref)) ensureAllHomeworkLoaded(ref);
  }

  if(statusEl){
    statusEl.textContent = (state.lang==='de')
      ? `Fertig: ${ok}/${touched} aktualisiert.`
      : `تم: تحديث ${ok} من ${touched}.`;
  }
  if(touched>0) showToast(state.lang==='de' ? 'Aktualisiert' : 'تم التحديث');
}

function useCurrentFilterForHomework(){
  bulkHwListOverride = Array.isArray(state.filteredStudents) ? state.filteredStudents.slice() : null;
  bulkHwSelectedRefs = new Set((bulkHwListOverride||[]).map(s => String(s.referenz||'').trim()).filter(Boolean));
  const selAll = document.getElementById('hw-bulk-selectall');
  if(selAll) selAll.checked = true;
  renderBulkHomeworkStudents();
  showToast(state.lang === 'de' ? 'Filter übernommen.' : 'تم استخدام الفلتر الحالي.');
}

function toggleBulkHomeworkSelectAll(checked){
  const list = getBulkHomeworkCurrentList();
  const refs = list.map(s => String(s.referenz||'').trim()).filter(Boolean);
  if(checked){
    refs.forEach(r=>bulkHwSelectedRefs.add(r));
  }else{
    refs.forEach(r=>bulkHwSelectedRefs.delete(r));
  }
  renderBulkHomeworkStudents();
}

function getBulkHomeworkCurrentList(){
  // Use the unified global filter (same as Schüler tab)
  const base = Array.isArray(state.filteredStudents) ? state.filteredStudents : (state.students || []);
  const q = (document.getElementById('hw-bulk-search')?.value || '').trim().toLowerCase();

  return (base || []).filter(s=>{
    if(q){
      const hay = `${s.fullName||''} ${s.parentName||''} ${s.phone||''} ${s.referenz||''}`.toLowerCase();
      if(!hay.includes(q)) return false;
    }
    return true;
  });
}


function renderBulkHomeworkStudents(forceFromSelect=false){
  if(forceFromSelect){
    // user explicitly clicked "Schüler anzeigen" => follow selects
    bulkHwListOverride = null;
  }

  const box = document.getElementById('hw-bulk-students');
  const countEl = document.getElementById('hw-bulk-count');
  const selAll = document.getElementById('hw-bulk-selectall');

  if(!box) return;

  const list = getBulkHomeworkCurrentList();

  if(countEl) countEl.textContent = String(list.length);

  // Update select-all state (based on current list)
  if(selAll){
    const refs = list.map(s=>String(s.referenz||'').trim()).filter(Boolean);
    const allSelected = refs.length > 0 && refs.every(r => bulkHwSelectedRefs.has(r));
    selAll.checked = allSelected;
  }

  box.innerHTML = '';
  if(list.length === 0){
    box.innerHTML = `<div class="bulk-empty">${state.lang==='de' ? 'Keine Schüler gefunden.' : 'لا يوجد طلاب.'}</div>`;
    return;
  }

  list.forEach(s=>{
    const ref = String(s.referenz||'').trim();
    const checked = ref && bulkHwSelectedRefs.has(ref);
    const row = document.createElement('div');
    row.className = 'bulk-row';
    row.innerHTML = `
      <div class="bulk-left">
        <input type="checkbox" ${checked ? 'checked' : ''} ${ref ? '' : 'disabled'} />
        <div style="min-width:0;">
          <div class="bulk-name">${escapeHtml(s.fullName || '')}</div>
          <div class="bulk-meta">${escapeHtml(s.group || '')} • ${escapeHtml(s.days || '')}${ref ? '' : ' • (no ID)'}</div>
        </div>
      </div>
      <div class="text-sm text-sec">${escapeHtml(ref)}</div>
    `;
    const cb = row.querySelector('input[type="checkbox"]');
    cb.addEventListener('change', ()=>{
      if(!ref) return;
      if(cb.checked) bulkHwSelectedRefs.add(ref);
      else bulkHwSelectedRefs.delete(ref);
      // keep select-all in sync
      try{ renderBulkHomeworkStudents(); }catch(e){}
    });
    // click row toggles checkbox
    row.addEventListener('click', (ev)=>{
      if(ev.target && (ev.target.tagName || '').toLowerCase() === 'input') return;
      if(!ref) return;
      cb.checked = !cb.checked;
      cb.dispatchEvent(new Event('change'));
    });

    box.appendChild(row);
  });
}

async function bulkAssignHomework(){
  if(state.role === 'Student') return;

  const list = getBulkHomeworkCurrentList();
  const selected = list.filter(s => bulkHwSelectedRefs.has(String(s.referenz||'').trim()));

  if(selected.length === 0){
    return showToast(state.lang === 'de' ? 'Bitte mindestens einen Schüler auswählen.' : 'اختر طالباً واحداً على الأقل.');
  }

  const type = getBulkHomeworkType();
  let surah = '';
  let start = '';
  let end   = '';

  if(type === 'text'){
    const txt = (document.getElementById('hw-bulk-free-text')?.value || '').trim();
    if(!txt) return showToast(state.lang === 'de' ? 'Bitte Text eingeben' : 'اكتب نص الواجب');
    surah = 'TEXT|' + txt;
  } else {
    surah = (document.getElementById('hw-bulk-surah')?.value || '').trim();
    start = (document.getElementById('hw-bulk-start')?.value || '').trim();
    end   = (document.getElementById('hw-bulk-end')?.value || '').trim();

    if(!surah) return showToast(state.lang === 'de' ? 'Bitte Sure eingeben' : 'ادخل السورة');
    if(!start || !end) return showToast(state.lang === 'de' ? 'Bitte Vers-Bereich eingeben' : 'ادخل نطاق الآيات');

    surah = 'MEM|' + surah;
  }

  // Progress overlay
  const ov = document.getElementById('hw-bulk-progress');
  const fill = document.getElementById('hw-bulk-progress-fill');
  const txtEl = document.getElementById('hw-bulk-progress-text');
  const titleEl = document.getElementById('hw-bulk-progress-title');
  if(titleEl) titleEl.textContent = (state.lang === 'de') ? 'Sende Hausaufgaben...' : 'جارٍ إرسال الواجب...';
  if(fill) fill.style.width = '0%';
  if(txtEl) txtEl.textContent = `0 / ${selected.length}`;
  if(ov) ov.classList.add('visible');

  let okCount = 0;
  let queuedCount = 0;

  for(let i=0; i<selected.length; i++){
    const st = selected[i];
    const ref = String(st.referenz||'').trim();
    const payload = { action:'assignHomework', studentRef: ref, surah, ayahStart: start, ayahEnd: end, teacherName: state.user };

    try{
      const res = await fetch(WEB_APP_URL, {
        method: 'POST',
        headers: { "Content-Type": "text/plain" },
        body: JSON.stringify(payload)
      }).then(r=>r.json());

      if(res && res.ok){
        okCount++;
      }else{
        // fallback to queue
        enqueueSheetWrite(payload, { label: (state.lang==='de'?'Hausaufgabe':'واجب') + ` • ${st.fullName}` });
        queuedCount++;
      }
    }catch(e){
      enqueueSheetWrite(payload, { label: (state.lang==='de'?'Hausaufgabe':'واجب') + ` • ${st.fullName}` });
      queuedCount++;
    }

    const done = i+1;
    if(fill) fill.style.width = `${(done/selected.length)*100}%`;
    if(txtEl) txtEl.textContent = `${done} / ${selected.length}`;
  }

  if(ov) ov.classList.remove('visible');

  try{ kickSyncQueue(); }catch(e){}

  const status = document.getElementById('hw-bulk-status');
  if(status){
    const msg = (state.lang==='de')
      ? `Fertig: ${okCount} gespeichert${queuedCount ? `, ${queuedCount} in Warteschlange (offline/Fehler).` : '.'}`
      : `تم: حفظ ${okCount}${queuedCount ? `، و ${queuedCount} في قائمة الانتظار (بدون اتصال/خطأ).` : '.'}`;
    status.textContent = msg;
  }

  showToast(state.lang==='de'
    ? `Hausaufgabe gesendet: ${okCount} ✓${queuedCount?` (+${queuedCount} queued)`:''
      }`
    : `تم إرسال الواجب: ${okCount} ✓${queuedCount?` (+${queuedCount} انتظار)`:''}`);

  // Clear inputs (keep selection as-is? better clear)
  bulkHwSelectedRefs = new Set();
  const selAll = document.getElementById('hw-bulk-selectall');
  if(selAll) selAll.checked = false;

  try{
    if(type === 'text'){
      const t = document.getElementById('hw-bulk-free-text'); if(t) t.value = '';
    }else{
      const a = document.getElementById('hw-bulk-surah'); if(a) a.value = '';
      const b = document.getElementById('hw-bulk-start'); if(b) b.value = '';
      const c = document.getElementById('hw-bulk-end'); if(c) c.value = '';
    }
  }catch(e){}

  renderBulkHomeworkStudents();
}



// Teacher: confirm (checked) => counts as memorized/progress
function toggleHomeworkConfirmed(rowIndex, confirmed){
  rowIndex = Number(rowIndex || 0);
  if(!rowIndex) return;

  fetch(WEB_APP_URL, {
    method: 'POST',
    headers: { "Content-Type": "text/plain" },
    body: JSON.stringify({
      action: 'toggleHomeworkConfirmed',
      rowIndex: rowIndex,
      confirmed: !!confirmed,
      teacherName: state.user
    })
  }).then(r=>r.json()).then(res => {
    if(res && res.ok){
      showToast(state.lang === 'de' ? 'Aktualisiert' : 'تم التحديث');
      const sRef = state.currentDetailStudent?.referenz;
      if(sRef) loadHomeworkHistory(sRef);
    }else{
      showToast((state.lang === 'de' ? 'Fehler: ' : 'خطأ: ') + (res?.error || ''));
    }
  }).catch(() => {
    showToast(state.lang === 'de' ? 'Fehler beim Speichern.' : 'تعذر الحفظ.');
  });
}

function loadHomeworkHistory(ref) {
  document.getElementById('hw-history-list').innerHTML = "Lade...";
  fetch(WEB_APP_URL, { 
    method: 'POST', 
    body: JSON.stringify({ action: 'getStudentHomework', studentRef: ref }) 
  })
  .then(r=>r.json()).then(res => {
    const d = document.getElementById('hw-history-list'); 
    d.innerHTML = '';
    if(res.ok && res.homework.length > 0) {
      res.homework.forEach(h => {
        const info = decodeHomeworkSurah(h.surah);
        const date = escapeHtml(h.date || '');
        const teacher = h.teacher ? ' • ' + escapeHtml(h.teacher) : '';

        if(info.kind === 'text'){
          const txt = info.freeText || '';
          const confirmed = (h.confirmed === true) || (String(h.confirmed || '').trim().toLowerCase() === 'true') || (String(h.confirmed || '').trim() === '1');
          const confBy = (h.confirmedBy ? escapeHtml(h.confirmedBy) : '');
          const confAt = (h.confirmedAt ? escapeHtml(h.confirmedAt) : '');
          const confMeta = confirmed && (confBy || confAt) ? `<div class="text-sm text-sec" style="margin-top:4px;">${(state.lang==='de'?'Bestätigt':'تم التأكيد')}${confBy ? (' • ' + confBy) : ''}${confAt ? (' • ' + confAt) : ''}</div>` : '';
          const confRow = `
            <label class="filter-checkbox" style="margin-top:8px; width:100%; justify-content:flex-start;">
              <input type="checkbox" ${confirmed ? 'checked' : ''} onchange="toggleHomeworkConfirmed(${h.rowIndex}, this.checked)" />
              <span>${state.lang === 'de' ? 'Als erledigt bestätigt' : 'تم تنفيذ الواجب'}</span>
            </label>
            ${confMeta}
          `;
          d.innerHTML += `
            <div style="border-bottom:1px solid #eee; padding:8px 5px;">
              <b>📝 ${state.lang === 'de' ? 'Freier Text' : 'نص حر'}</b><br>
              ${txt ? `<div class="text-sm" style="white-space:pre-wrap; margin-top:6px;">${escapeHtml(txt)}</div>` : ''}
              <span style="font-size:0.7rem">${date}${teacher}</span>
              ${confRow}
            </div>`;
          return;
        }

        const badge = info.badge ? ` <span style="font-size:0.7rem; padding:2px 8px; border-radius:999px; border:1px solid var(--border); background:var(--surface-2);">${escapeHtml(info.badge)}</span>` : '';
        const range = (h.start && h.end) ? ` (${escapeHtml(h.start)}-${escapeHtml(h.end)})` : '';
        const confirmed = (h.confirmed === true) || (String(h.confirmed || '').trim().toLowerCase() === 'true') || (String(h.confirmed || '').trim() === '1');
        const confBy = (h.confirmedBy ? escapeHtml(h.confirmedBy) : '');
        const confAt = (h.confirmedAt ? escapeHtml(h.confirmedAt) : '');
        const confMeta = confirmed && (confBy || confAt) ? `<div style="font-size:0.72rem; margin-top:4px; color:var(--text-sec);">✅ ${state.lang === 'de' ? 'Bestätigt' : 'تم التسميع'}${confBy ? (' • ' + confBy) : ''}${confAt ? (' • ' + confAt) : ''}</div>` : '';
        const confRow = `
          <label class="filter-checkbox" style="margin-top:8px; width:100%; justify-content:flex-start;">
            <input type="checkbox" ${confirmed ? 'checked' : ''} onchange="toggleHomeworkConfirmed(${h.rowIndex}, this.checked)" />
            <span>${state.lang === 'de' ? 'Als auswendig bestätigt' : 'تم التسميع (حفظ)'}</span>
          </label>
          ${confMeta}
        `;
        d.innerHTML += `
          <div style="border-bottom:1px solid #eee; padding:8px 5px;">
            <b>${escapeHtml(info.label)}${badge}</b>${range} <br>
            <span style="font-size:0.7rem">${date}${teacher}</span>
            ${confRow}
          </div>`;
      });
    } else {
      d.innerHTML = "Keine Einträge.";
    }
  });
}

function toggleEvalNoteOnly(){
  const chk = document.getElementById('eval-note-only');
  const on = !!chk?.checked;

  ['eval-hifz','eval-tajweed','eval-behavior'].forEach(id => {
    const el = document.getElementById(id);
    if(!el) return;
    el.disabled = on;
    el.style.opacity = on ? 0.55 : 1;
    if(on) el.value = '';
  });
}

function applyEvalNoteTemplate(text, sendNow){
  const noteEl = document.getElementById('eval-note');
  const chk = document.getElementById('eval-note-only');
  if(noteEl) noteEl.value = text || '';
  if(chk) chk.checked = true;
  toggleEvalNoteOnly();
  if(sendNow) submitEvaluation({ noteOnly: true });
}

function submitEvaluation(opts = {}) {
  const sRef = state.currentDetailStudent?.referenz;
  if(!sRef) return;

  const noteOnly = !!opts.noteOnly || !!document.getElementById('eval-note-only')?.checked;

  let mem = document.getElementById('eval-hifz')?.value || '';
  let taj = document.getElementById('eval-tajweed')?.value || '';
  let beh = document.getElementById('eval-behavior')?.value || '';
  const note = (document.getElementById('eval-note')?.value || '').trim();

  // NOTE ONLY: no ratings required
  if(noteOnly){
    mem = ''; taj = ''; beh = '';
    if(!note){
      showToast(state.lang === 'de' ? 'Bitte Notiz eingeben.' : 'اكتب الملاحظة.');
      return;
    }
  }

  fetch(WEB_APP_URL, {
    method: 'POST', 
    body: JSON.stringify({ 
      action: 'submitEvaluation', 
      studentRef: sRef, 
      memorization: mem, 
      tajweed: taj, 
      behavior: beh, 
      note: note, 
      teacherName: state.user 
    })
  }).then(r=>r.json()).then(res => {
    if(res.ok) { 
      showToast(noteOnly ? (state.lang === 'de' ? 'Notiz gesendet' : 'تم إرسال الملاحظة') 
                        : (state.lang === 'de' ? 'Bewertung gesendet' : 'تم إرسال التقييم')); 
      document.getElementById('eval-note').value = ''; 
      // reset note-only switch after sending
      const chk = document.getElementById('eval-note-only');
      if(chk && noteOnly){ chk.checked = false; toggleEvalNoteOnly(); }
      loadEvalHistory(sRef); 
    } else {
      showToast("Fehler: " + (res.error || ''));
    }
  });
}

function loadEvalHistory(ref) {
  document.getElementById('eval-history-list').innerHTML = "Lade...";
  fetch(WEB_APP_URL, { 
    method: 'POST', 
    body: JSON.stringify({ action: 'getStudentEvaluations', studentRef: ref }) 
  })
  .then(r=>r.json()).then(res => {
    const d = document.getElementById('eval-history-list'); 
    d.innerHTML = '';
    if(res.ok && res.evaluations.length > 0) {
      res.evaluations.forEach(h => {
        const hasRating = !!String((h.memorization || '') + (h.tajweed || '') + (h.behavior || '')).trim();
        const head = hasRating
          ? `<b>${escapeHtml(h.memorization || '—')}</b> | ${escapeHtml(h.tajweed || '—')}`
          : `<b>📝 ${state.lang === 'de' ? 'Notiz' : 'ملاحظة'}</b>`;
        const noteHtml = h.note ? `<div class="text-sm" style="margin-top:6px; font-style:italic;">"${escapeHtml(h.note)}"</div>` : '';
        const meta = `<span style="font-size:0.7rem">${escapeHtml(h.date || '')}${h.teacher ? ' • ' + escapeHtml(h.teacher) : ''}</span>`;
        d.innerHTML += `<div style="border-bottom:1px solid #eee; padding:8px 5px;">${head}<br>${meta}${noteHtml}</div>`;
      });
    } else {
      d.innerHTML = "Keine Einträge.";
    }
  });
}


// --- Back button behavior (Android/browser) ---
// Rules:
// 1) If a modal is open -> close it.
// 2) Else if we are in a sub-tab -> go back to main tab.
// 3) Only allow leaving the page when already on the main tab.
let navState = {
  mainTab: null,
  currentTab: null,
  modalStack: [],
  popHandling: false,
  ignoreNextPop: false
};


// --- Back button exit confirmation
function resetNavState(){
  try{
    navState.mainTab = null;
    navState.currentTab = null;
    navState.modalStack = [];
    navState.popHandling = false;
    navState.ignoreNextPop = false;
    navState.exitAllow = false;
    navState.exitUiOpen = false;
  }catch(e){}
}

// --- Back button exit confirmation (iOS-style) ---
navState.exitAllow = false;           // when true, next popstate will actually exit (via double-back)
navState.exitUiOpen = false;

function __iosExitEl(){ return document.getElementById('ios-exit-confirm'); }

function showIosExitConfirm(){
  const el = __iosExitEl();
  if(!el) return;
  if(navState.exitUiOpen) return;
  navState.exitUiOpen = true;
  el.classList.remove('hidden');
  el.setAttribute('aria-hidden', 'false');
  // trigger transition
  requestAnimationFrame(()=> el.classList.add('visible'));
}

function hideIosExitConfirm(){
  const el = __iosExitEl();
  if(!el) return;
  navState.exitUiOpen = false;
  el.classList.remove('visible');
  el.setAttribute('aria-hidden', 'true');
  setTimeout(()=> el.classList.add('hidden'), 220);
}

function ensureExitGuardState(){
  try{
    if(history.state && history.state.qsNav && history.state.kind === 'exitGuard') return;
    history.pushState({qsNav:true, kind:'exitGuard'}, '');
  }catch(e){}
}

function wireIosExitConfirm(){
  const el = __iosExitEl();
  if(!el) return;

  const btnCancel = document.getElementById('ios-exit-cancel');
  const btnOk = document.getElementById('ios-exit-ok');
  const backdrop = el.querySelector('.ios-backdrop');

  if(btnCancel){
    btnCancel.addEventListener('click', ()=>{
      hideIosExitConfirm();
      ensureExitGuardState();
    });
  }
  if(backdrop){
    backdrop.addEventListener('click', ()=>{
      hideIosExitConfirm();
      ensureExitGuardState();
    });
  }
  if(btnOk){
    btnOk.addEventListener('click', ()=>{
      // Step 1: go back from guard -> main (popstate will fire)
      // Step 2: popstate sees exitAllow and performs the real exit (second back)
      navState.exitAllow = true;
      hideIosExitConfirm();
      try{ history.back(); }catch(e){}
    });
  }
}

function getMainTabId(){
  // IMPORTANT: do not cache across role changes (security: Student must never fall back to 'students')
  const role = String(state.role || '').toLowerCase();
  return (role === 'student') ? 'student-home' : 'students';
}

function getVisibleModalIds(){
  const ids = ['lesson-modal','detail-modal','edit-modal','user-modal','stu-akte-eval-modal','stu-akte-att-modal','alert-modal'];
  return ids.filter(id => document.getElementById(id)?.classList.contains('visible'));
}

function getTopVisibleModalId(){
  const visible = getVisibleModalIds();
  if(visible.length === 0) return null;

  // Prefer last opened (stack), fallback to last visible
  for(let i = (navState.modalStack || []).length - 1; i >= 0; i--){
    const id = navState.modalStack[i];
    if(visible.includes(id)) return id;
  }
  return visible[visible.length - 1];
}

function openModal(id, opts={}){
  const el = document.getElementById(id);
  if(!el) return;

  el.classList.add('visible');

  // maintain modal stack
  try{
    navState.modalStack = (navState.modalStack || []).filter(x => x !== id);
    navState.modalStack.push(id);
  }catch(e){}

  if(opts.noHistory || navState.popHandling) return;

  try{
    history.pushState({qsNav:true, kind:'modal', id:id, tab:(navState.currentTab || getMainTabId())}, '');
  }catch(e){}
}


function hideModalOnly(id, opts={}){
  const el = document.getElementById(id);
  if(!el) return;
  el.classList.remove('visible');

  // Keep modal stack clean
  try { navState.modalStack = (navState.modalStack || []).filter(x => x !== id); } catch(e) {}

  if(opts.fromPop || navState.popHandling) return;

  try{
    const st = history.state;
    if(st && st.qsNav && st.kind === 'modal' && st.id === id){
      navState.ignoreNextPop = true;
      history.back();
    }
  }catch(e){}
}

window.addEventListener('popstate', () => {
  // If the user isn't logged in yet, don't intercept.
  const appRoot = document.getElementById('qs-app-root');
  const appVisible = appRoot && !appRoot.classList.contains('hidden');
  if(!appVisible) return;

  // Ignore programmatic back (e.g., when user closes a modal via X and we call history.back()).
  if(navState.ignoreNextPop){
    navState.ignoreNextPop = false;
    return;
  }

  navState.popHandling = true;
  try{
    const modalId = getTopVisibleModalId();
    if(modalId){
      closeModal(modalId, {fromPop:true});
      return;
    }

    const mainTab = getMainTabId();
    if(navState.currentTab && navState.currentTab !== mainTab){
      switchTab(mainTab, {fromPop:true});
      ensureExitGuardState();
      return;
    }

    // We are already on the main tab -> allow leaving the page/app.
  
    // Instead of leaving immediately, show an iOS-style confirmation.
    // If user confirmed exit, perform a second back to actually leave the page/app.
    if(navState.exitAllow){
      navState.exitAllow = false;
      // perform the real exit (second back)
      setTimeout(()=>{ try{ history.back(); }catch(e){} }, 0);
      return;
    }
    showIosExitConfirm();
    // keep a guard state on top so the page doesn't close while the dialog is open
    ensureExitGuardState();
    return;
} finally {
    navState.popHandling = false;
  }
});

function dismissAllModalsNoHistory(){
  try{
    const visible = document.querySelectorAll('.modal-overlay.visible');
    visible.forEach(el => {
      const id = el.id || '';
      el.classList.remove('visible');
      try { navState.modalStack = (navState.modalStack || []).filter(x => x !== id); } catch(e) {}
      // clean up special modal resources
      if(id === 'lesson-modal'){
        try{ stopRangePlayback(); }catch(e){}
        try{ hideFloatingAudio(); }catch(e){}
        try{ clearLessonFab(); }catch(e){}
      }
    });
  }catch(e){}
}

function switchTab(tabId, opts={}) {

  // Back-button navigation state
  if(!opts || typeof opts !== 'object') opts = {};
  const roleLower = String(state.role || '').toLowerCase();

  // SECURITY: Student must never navigate to staff/admin tabs (even via Back/History).
  if(roleLower === 'student'){
    const allowed = ['student-home','student-homework','student-memorize','student-rating','student-parent'];
    if(!allowed.includes(tabId)) tabId = 'student-home';
  }

  const mainTab = getMainTabId();
  navState.currentTab = tabId;

  // Admin: hide Aufgaben tab
  if(tabId === 'homework-admin' && String(state.role||'').toLowerCase() === 'admin'){
    tabId = 'students';
  }
  // Ensure modals from previous view do not cover the new tab
  if(!opts.keepModals) dismissAllModalsNoHistory();
const tabs = ['students', 'homework-admin', 'comm', 'stats', 'docs', 'users',
                'student-home','student-homework','student-memorize','student-rating','student-parent'];
  const navs = ['students','homework-admin','comm','stats','docs','users',
                'stu-home','stu-hw','stu-mem','stu-rate','stu-parent'];

  tabs.forEach(tid => {
    const el = document.getElementById('tab-'+tid);
    if(el) el.classList.add('hidden');
  });

  navs.forEach(nid => {
    const nav = document.getElementById('nav-'+nid);
    if(nav) nav.classList.remove('active');
  });

  const tabEl = document.getElementById('tab-'+tabId);
  if(tabEl) tabEl.classList.remove('hidden');

  const navEl = document.getElementById('nav-'+tabId) || ({
    'student-home': document.getElementById('nav-stu-home'),
    'student-homework': document.getElementById('nav-stu-hw'),
    'student-memorize': document.getElementById('nav-stu-mem'),
    'student-rating': document.getElementById('nav-stu-rate'),
    'student-parent': document.getElementById('nav-stu-parent'),
  }[tabId]);
  
  if(navEl) navEl.classList.add('active');

  if(tabId === 'stats') renderStatistics();
  if(tabId === 'users' && state.role === 'Admin') renderUsersList();
  if(tabId === 'docs') renderDocuments();
  if(tabId === 'homework-admin') { try{ initBulkHomeworkUI(); }catch(e){}
  try{ initAllHomeworkUI(); }catch(e){} try{ renderBulkHomeworkStudents(); }catch(e){} }
  if(tabId === 'student-home') { loadStudentHome(); }
  if(tabId === 'student-homework') { clearStudentBadgeForTab(tabId); loadStudentHomework(); }
  if(tabId === 'student-rating') { clearStudentBadgeForTab(tabId); loadStudentEvaluations(); }
  if(tabId === 'student-memorize') renderSurahList();
  if(tabId === 'student-parent') loadParentAbsentState();

  // Sync browser history so "Back" behaves like: modal close -> back to main tab -> then allow exit
  if(!opts.fromPop && !navState.popHandling && !opts.noHistory){
    try{
      if(tabId === mainTab){
        history.replaceState({qsNav:true, kind:'main', tab:tabId}, '');
      } else {
        history.pushState({qsNav:true, kind:'tab', tab:tabId}, '');
      }
    }catch(e){}
  }

  // Keep an extra guard state so browser 'Back' shows exit confirmation instead of closing immediately
  if(!opts.noHistory && tabId === getMainTabId()) { try{ ensureExitGuardState(); }catch(e){} }
}

function closeModal(id, opts={}) { 
  const el = document.getElementById(id);
  if(el) el.classList.remove('visible');

  // keep modal stack clean
  try { navState.modalStack = (navState.modalStack || []).filter(x => x !== id); } catch(e) {}

  if(id === 'lesson-modal'){
    try{ stopRangePlayback(); }catch(e){}
    try{ hideFloatingAudio(); }catch(e){}
    clearLessonFab();
  }

  // If user closed the modal manually (X/button), keep history in sync by going back one step.
  // IMPORTANT: do NOT treat this programmatic back as a "user back" (so we don't jump tabs).
  if(opts && opts.fromPop) return;
  if(navState && navState.popHandling) return;
  if(opts && opts.noHistory) return;

  try{
    const st = history.state;
    if(st && st.qsNav && st.kind === 'modal' && st.id === id){
      navState.ignoreNextPop = true;
      history.back();
    }
  }catch(e){}
}

function showToast(msg) { 
  const t = document.getElementById('toast'); 
  t.innerText = msg; 
  t.classList.add('show'); 
  setTimeout(() => t.classList.remove('show'), 3000); 
}

function renderStatistics() {
  if (document.getElementById('stat-total')) document.getElementById('stat-total').innerText = state.students.length;
  const todayDate = new Date().toLocaleDateString('de-DE', {day:'2-digit', month:'2-digit', year:'numeric'});
  const groupStats = {};
  
  state.filteredStudents.forEach(s => {
    if (!s.group) return;
    if (!groupStats[s.group]) groupStats[s.group] = { 
      totalStudents: 0, 
      absentCount: 0, 
      absentNames: [], 
      lateCount: 0, 
      lateNames: [], 
      presentCount: 0 
    };
    groupStats[s.group].totalStudents++;
  });
  
  let totalAbsentToday = 0; 
  let totalLateToday = 0; 
  let totalPresentToday = 0;
  
  state.filteredStudents.forEach(s => {
    const a = state.attendance.find(att => att.fullName === s.fullName && att.date === todayDate);
    const g = s.group;
    if (a && (a.status === 'غياب' || a.status === 'Abwesend')) {
      totalAbsentToday++;
      if (g && groupStats[g]) { 
        groupStats[g].absentCount++; 
        groupStats[g].absentNames.push({ name: s.fullName, row: s.rowIndex });
      }
    } else {
      // present includes "late"
      totalPresentToday++;

      if (a && (a.status === 'تأخير' || a.status === 'Verspätet')) {
        totalLateToday++;
        if (g && groupStats[g]) { 
          groupStats[g].lateCount++; 
          groupStats[g].lateNames.push({ name: s.fullName, row: s.rowIndex });
        }
      }

      if (g && groupStats[g]) groupStats[g].presentCount++;
    }
  });
  
  if (document.getElementById('stat-absent-today')) {
    document.getElementById('stat-absent-today').innerText = totalAbsentToday;
  }
  
  if (document.getElementById('stat-present-today')) {
    document.getElementById('stat-present-today').innerText = totalPresentToday;
  }

  if (document.getElementById('stat-late-today')) {
    document.getElementById('stat-late-today').innerText = totalLateToday;
  }
  
  const box = document.getElementById('stats-groups'); 
  box.innerHTML = '';
  
  Object.keys(groupStats).sort().forEach(g => {
    const st = groupStats[g];
    let html = `
      <div class="card flex-col" style="margin-top: 1rem;">
        <div style="display:flex; justify-content:space-between; width:100%; border-bottom: 1px solid var(--border); padding-bottom: 8px;">
          <span class="font-bold">${g}</span><span class="text-sec">${st.totalStudents} (${t('expected')})</span>
        </div>
        <div style="display:flex; justify-content:space-between; width:100%; margin-top: 10px;">
          <div class="text-sec">${t('presentCount')}</div><div class="font-bold" style="color:var(--success);">${st.presentCount}</div>
        </div>
        <div style="display:flex; justify-content:space-between; width:100%; margin-top: 10px;">
          <div class="text-sec">${t('absentToday')}</div><div class="font-bold" style="color:var(--danger);">${st.absentCount}</div>
        </div>
        <div style="display:flex; justify-content:space-between; width:100%; margin-top: 10px;">
          <div class="text-sec">${t('lateToday')}</div><div class="font-bold" style="color:var(--warning);">${st.lateCount}</div>
        </div>`;
    
    if (st.absentNames.length > 0) {
      html += `
        <div style="width:100%; margin-top: 15px; padding-top: 10px; border-top: 1px solid var(--border);">
          <div class="text-sm font-bold" style="color:var(--danger); margin-bottom: 5px;">${t('btnAbsent')} (${st.absentCount})</div>
          <ul style="list-style: none; padding: 0; margin: 0; font-size: 0.9rem;">
            ${st.absentNames.map(obj => `<li onclick="openStudentDetail(${obj.row})" class="clickable-name" style="margin-bottom: 3px; color:var(--danger);">${obj.name}</li>`).join('')}
          </ul>
        </div>`;
    }
    
    if (st.lateNames.length > 0) {
      html += `
        <div style="width:100%; margin-top: 15px; padding-top: 10px; border-top: 1px solid var(--border);">
          <div class="text-sm font-bold" style="color:var(--warning); margin-bottom: 5px;">${t('btnLate')} (${st.lateCount})</div>
          <ul style="list-style: none; padding: 0; margin: 0; font-size: 0.9rem;">
            ${st.lateNames.map(obj => `<li onclick="openStudentDetail(${obj.row})" style="margin-bottom: 3px; color:var(--warning);">${obj.name}</li>`).join('')}
          </ul>
        </div>`;
    }

    html += `</div>`;
    box.innerHTML += html;
  });
}

function renderDocuments() {
  const container = document.getElementById('docs-list');
  container.innerHTML = '';
  const searchInput = document.getElementById('doc-search-input');
  const searchVal = searchInput ? searchInput.value.toLowerCase() : '';
  const filteredDocs = state.documents.filter(doc => doc.name && doc.name.toLowerCase().includes(searchVal));

  if (filteredDocs.length === 0) { 
    container.innerHTML = '<div class="text-sec" style="text-align:center; margin-top:20px;">Keine Dokumente gefunden</div>'; 
    return; 
  }

  filteredDocs.forEach(doc => {
    let directLink = doc.link;
    if (directLink && directLink.includes('docs.google.com') && directLink.includes('/d/')) {
      directLink = directLink.replace(/\/edit.*$|\/view.*$/, '/export?format=pdf');
    }
    
    let visibilityToggle = '';
    if (state.role === 'Admin') {
      const isChecked = doc.visibleToTeacher ? 'checked' : '';
      visibilityToggle = `
        <div style="margin-top:10px; border-top:1px solid var(--border); padding-top:5px;">
          <label class="checkbox-item" style="border:none; padding:0;">
            <input type="checkbox" ${isChecked} onchange="toggleDocVisibility(${doc.rowIndex}, this.checked)">
            <span>${t('visibleToTeacher')}</span>
          </label>
        </div>`;
    }
    
    const el = document.createElement('div'); 
    el.className = 'card flex-col'; 
    el.style.alignItems = 'stretch';
    
    el.innerHTML = `
      <div style="display:flex; align-items:center; gap:10px;">
        <div class="card-avatar" style="background:var(--surface-2); color:var(--primary);">
          <i class="fa-solid fa-file-pdf"></i>
        </div>
        <div class="card-info">
          <div class="font-bold" style="color: var(--text);">${doc.name}</div>
          <div class="text-sm text-sec">PDF</div>
        </div>
        <div class="doc-actions">
          <button class="doc-btn" onclick="openInGhostWindow('${directLink}')">
            <i class="fa-solid fa-download"></i>
          </button>
        </div>
      </div>
      ${visibilityToggle}
    `;
    
    container.appendChild(el);
  });
}

function openInGhostWindow(url) {
  var newWindow = window.open('', '_blank');
  if (newWindow) {
    newWindow.document.write('<p style="text-align:center; margin-top:50px; font-family:sans-serif;">Dokument wird vorbereitet...</p>');
    setTimeout(function() { newWindow.location.href = url; }, 100); 
  } else { 
    window.open(url, '_blank'); 
  }
}

function renderUsersList() {
  const container = document.getElementById('users-list-container'); 
  if (!container) return;
  
  container.innerHTML = '';
  state.allUsers.forEach(user => {
    const userEl = document.createElement('div'); 
    userEl.className = 'card';
    
    userEl.innerHTML = `
      <div style="flex:1;">
        <div class="font-bold">${user.userName}</div>
        <div class="text-sm text-sec">${user.role} - PIN: ****</div>
      </div>
      <div style="display:flex; gap:8px;">
        <button class="user-action-btn" onclick='openEditUser(${JSON.stringify(user)})'>
          <i class="fa-solid fa-pen-to-square"></i>
        </button>
        <button class="user-action-btn" style="color:var(--danger);" onclick="deleteUser(${user.rowIndex})">
          <i class="fa-solid fa-trash"></i>
        </button>
      </div>
    `;
    
    container.appendChild(userEl);
  });
}

function openAddStudent() {
  editingStudent = null; 
  document.getElementById('edit-title').innerText = "Neuer Schüler";
  document.getElementById('last-id-display').innerText = `Letzte ID im System: ${state.lastId}`;
  document.getElementById('btn-delete-stud').classList.add('hidden'); 
  renderForm({}); 
  openModal('edit-modal');
}

function openEditStudent(s) {
  if(!s) s = state.currentDetailStudent;
  editingStudent = s; 
  document.getElementById('edit-title').innerText = "Schüler bearbeiten";
  document.getElementById('last-id-display').innerText = "";
  document.getElementById('btn-delete-stud').classList.remove('hidden'); 
  renderForm(s); 
  closeModal('detail-modal'); 
  openModal('edit-modal');
}

function renderForm(vals) {
  const f = document.getElementById('edit-form'); 
  f.innerHTML = '';
  
  if (!editingStudent) {
    f.innerHTML += `
      <div class="form-group">
        <label class="form-label" style="color:var(--primary);">Manuelle ID (optional - leer lassen für automatisch)</label>
        <input type="text" class="form-input" id="inp-manualId" placeholder="z.B.: Dark 0500">
      </div>
    `;
  }
  
  const fields = [
    {k:'referenz', l:'l_referenz'}, 
    {k:'lastName', l:'l_lastName'}, 
    {k:'firstName', l:'l_firstName'}, 
    {k:'geburtsdatum', l:'l_geburtsdatum'}, 
    {k:'parentName', l:'l_parentName'}, 
    {k:'phone', l:'l_phone'}, 
    {k:'email', l:'l_email'},
    {k:'days', l:'l_days'}, 
    {k:'group', l:'l_group'}, 
    {k:'iban', l:'l_iban'}, 
    {k:'betrag', l:'l_betrag'},
    {k:'alter', l:'l_alter'}, 
    {k:'gender', l:'l_gender'}, 
    {k:'infos', l:'l_infos'}, 
    {k:'fotoUrl', l:'l_fotoUrl'},
    {k:'abgemeldet', l:'l_abgemeldet'}, 
    {k:'kontrolleBank', l:'l_kontrolleBank'}, 
    {k:'finanzMark', l:'l_finanzMark'}
  ];
  
  fields.forEach(field => {
    if(field.k === 'abgemeldet' && !editingStudent) return;
    if((field.k === 'kontrolleBank' || field.k === 'finanzMark') && state.role !== 'Admin') return; 
    
    let extraAttr = ""; 
    if (field.k === 'alter') extraAttr = "readonly style='background:var(--surface-2); opacity:0.7;'";
    
    f.innerHTML += `
      <div class="form-group">
        <label class="form-label">${t(field.l)}</label>
        <input type="text" class="form-input" id="inp-${field.k}" value="${vals[field.k] || ''}" ${extraAttr}>
      </div>
    `;
  });
  
  const birthInput = document.getElementById('inp-geburtsdatum');
  const ageInput = document.getElementById('inp-alter');
  if(birthInput && ageInput) {
    birthInput.addEventListener('input', function() { 
      ageInput.value = calculateAge(this.value); 
    });
    
    if(!ageInput.value && birthInput.value) { 
      ageInput.value = calculateAge(birthInput.value); 
    }
  }
}

function calculateAge(dateString) {
  if (!dateString) return "";
  const parts = dateString.split('.'); 
  if (parts.length !== 3) return "";
  
  const birth = new Date(parseInt(parts[2], 10), parseInt(parts[1], 10) - 1, parseInt(parts[0], 10));
  const today = new Date();
  let age = today.getFullYear() - birth.getFullYear();
  const m = today.getMonth() - birth.getMonth();
  
  if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) { 
    age--; 
  }
  
  return age >= 0 ? age : "";
}

function saveStudent() {
  const payload = { userName: state.user };
  const fields = ['lastName','firstName','geburtsdatum','parentName','phone','email','days','group','iban','betrag','alter','gender','infos','fotoUrl'];
  
  fields.forEach(k => payload[k] = document.getElementById('inp-'+k).value);
  
  if(editingStudent) {
    payload.action = 'updateStudent'; 
    payload.rowIndex = editingStudent.rowIndex;
    payload.abgemeldet = document.getElementById('inp-abgemeldet').value;
    payload.referenz = document.getElementById('inp-referenz').value;
    
    if(state.role === 'Admin') {
      payload.kontrolleBank = document.getElementById('inp-kontrolleBank').value;
      payload.finanzMark = document.getElementById('inp-finanzMark').value;
    }
  } else {
    payload.action = 'addStudent'; 
    payload.vereinsmitglied = ""; 
    payload.mitgliedSchule = ""; 
    payload.anmeldung = "";
    payload.manualId = document.getElementById('inp-manualId').value;
  }
  
  showToast("Speichern...");
  
  fetch(WEB_APP_URL, { 
    method: 'POST', 
    headers: { "Content-Type": "text/plain" }, 
    body: JSON.stringify(payload) 
  })
  .then(r=>r.json()).then(res => {
    if(res.ok) { 
      showToast(t('saved')); 
      closeModal('edit-modal'); 
      refreshData(); 
    } else {
      showToast("Fehler: " + res.error);
    }
  });
}

function deleteStudent() {
  if(!editingStudent) return;
  
  if(confirm(t('confirmDelete'))) {
    showToast("Lösche...");
    
    fetch(WEB_APP_URL, { 
      method: 'POST', 
      headers: { "Content-Type": "text/plain" }, 
      body: JSON.stringify({ 
        action: 'deleteStudent', 
        rowIndex: editingStudent.rowIndex, 
        userName: state.user 
      }) 
    })
  .then(r=>r.json()).then(res => {
      if(res.ok) { 
        showToast("Gelöscht"); 
        closeModal('edit-modal'); 
        refreshData(); 
      } else { 
        showToast("Fehler: " + res.error); 
      }
    });
  }
}

function printSingleStudent(s) {
  document.getElementById('print-container').innerHTML = `
    <div style="text-align:center; border:2px solid black; padding:20px; color:black; background:white;">
      <h1>${t('title')}</h1>
      ${s.fotoUrl ? `<img src="${s.fotoUrl}" style="width:100px; margin:10px;">` : ''}
      <h2>${s.fullName} <span style="font-size:0.8em;">[${s.referenz}]</span></h2>
      <h3>${s.group}</h3>
      <p>${s.days}</p>
      <hr>
      <p>Eltern: ${s.parentName || '-'}</p>
    </div>
  `;
  
  window.print();
}

function saveStudentNote() {
  const txt = document.getElementById('new-student-note').value;
  const sName = document.getElementById('notes-list').dataset.studentName;
  
  if (!txt || !sName) return;
  
  fetch(WEB_APP_URL, { 
    method: 'POST', 
    body: JSON.stringify({ 
      action: 'saveStudentInfo', 
      studentName: sName, 
      message: txt, 
      author: state.user 
    }) 
  })
  .then(r=>r.json()).then(res => { 
    if(res.ok) { 
      showToast("Gespeichert"); 
      document.getElementById('new-student-note').value = ''; 
      closeModal('detail-modal'); 
      refreshData(); 
    } 
  });
}

function sendTeacherMessage() {
  const type = document.getElementById('msg-dest-type').value;
  const txt = document.getElementById('msg-body').value;
  let recipients = [];
  
  if (type === 'Admin') {
    recipients = ['Admin'];
  } else {
    document.querySelectorAll('#teacher-checklist input:checked').forEach(cb => recipients.push(cb.value));
  }
  
  if(recipients.length === 0) return showToast("Empfänger wählen");
  
  fetch(WEB_APP_URL, { 
    method: 'POST', 
    body: JSON.stringify({ 
      action: 'addTeacherMessage', 
      senderName: state.user, 
      recipientType: type, 
      recipientName: recipients, 
      messageText: txt 
    }) 
  })
  .then(r=>r.json()).then(res => { 
    if(res.ok) { 
      document.getElementById('msg-body').value = ''; 
      showToast("Gesendet!"); 
      loadMessages(); 
    } 
  });
}

function msgLastKey(){ return `qs_last_msg_sig:${state.user || 'unknown'}`; }

function loadMessages() {
  return fetch(WEB_APP_URL, { 
    method: 'POST', 
    body: JSON.stringify({ 
      action: 'getMessages', 
      userName: state.user, 
      role: state.role 
    }) 
  })
  .then(r => r.json()).then(res => { 
    if(res.ok) { 
      const prevSig = (()=>{ try{ return localStorage.getItem(msgLastKey()) || ''; }catch(e){ return ''; } })();

      state.messages = res.messages || []; 
      renderMessages(); 
      updateMsgBadge();

      // Simple "push-like" browser notification on NEW unread message
      const unread = state.messages.filter(m => m.status === 'neu');
      const latest = unread.reduce((a,b)=>{
        const ai = parseInt(a?.rowIndex ?? -1,10);
        const bi = parseInt(b?.rowIndex ?? -1,10);
        return (bi > ai) ? b : a;
      }, null);

      const sig = latest ? String(latest.rowIndex ?? '') : '';
      if(sig && sig !== prevSig){
        try{ localStorage.setItem(msgLastKey(), sig); }catch(e){}
        if(isMessageNotificationsEnabled() && ('Notification' in window) && Notification.permission === 'granted'){
          const title = (state.lang === 'de' ? 'Neue Nachricht' : 'رسالة جديدة');
          const body  = (latest.text ? String(latest.text).slice(0,120) : (state.lang === 'de' ? 'Neue Nachricht erhalten.' : 'تم استلام رسالة جديدة.'));
          // Show only if user is not already on messages tab OR tab is hidden
          const isCommVisible = !document.getElementById('tab-comm')?.classList.contains('hidden');
          if(document.hidden || !isCommVisible){
            try{ new Notification(title, { body }); }catch(e){}
          }
        }
      } else if(!sig && !prevSig){
        // keep empty
      } else if(!sig){
        try{ localStorage.setItem(msgLastKey(), ''); }catch(e){}
      }
    }
  });
}


function renderMessages() {
  const c = document.getElementById('messages-list'); 
  c.innerHTML = '';
  
  state.messages.forEach(msg => {
    c.innerHTML += `
      <div class="msg-card ${msg.status==='neu'?'new':''}" onclick="${msg.status==='neu'?`markRead(${msg.rowIndex})`:''}">
        <div class="msg-header">
          <span>${msg.senderName}</span>
          <span>${msg.timestamp}</span>
        </div>
        <div class="msg-text">${linkify(msg.messageText)}</div>
        ${msg.status==='neu'?`<div style="color:var(--primary);font-size:0.7rem;margin-top:5px;font-weight:bold;">${t('newMsg')}</div>`:''}
      </div>
    `;
  });
}


function markRead(idx) {
  // 1) Optimistic UI: mark as read immediately so the badge/notification disappears
  const msg = state.messages.find(m => String(m.rowIndex) === String(idx));
  if(msg) msg.status = 'read';
  renderMessages();
  updateMsgBadge();

  // 2) Background save (queue + retry)
  enqueueSheetWrite({ action: 'markMessageRead', rowIndex: idx }, { label: (state.lang === 'de') ? 'Nachricht gelesen' : 'تأكيد قراءة رسالة' });
  showToast(state.lang === 'de' ? 'Bestätigt (wird gespeichert...)' : 'تم التأكيد (جارٍ الحفظ...)');

  kickSyncQueue();
}


function updateMsgBadge() { 
  const c = state.messages.filter(m => m.status === 'neu').length; 
  const b = document.getElementById('badge-msg-nav'); 
  
  if(c>0) { 
    b.innerText = c; 
    b.classList.remove('hidden'); 
  } else {
    b.classList.add('hidden'); 
  } 
}

function populateTeacherSelect() {
  const w = document.getElementById('teacher-checklist'); 
  w.innerHTML = '';
  
  state.teachers.forEach((tName, i) => { 
    w.innerHTML += `
      <div class="checkbox-item">
        <label for="chk-t-${i}">${tName}</label>
        <input type="checkbox" id="chk-t-${i}" value="${tName}">
      </div>
    `; 
  });
}

function toggleMsgRecipient() { 
  const t = document.getElementById('msg-dest-type').value; 
  document.getElementById('msg-dest-wrapper').classList.toggle('hidden', t === 'Admin'); 
}

function startMessagePolling() { 
  if(msgPollingInterval) clearInterval(msgPollingInterval); 
  msgPollingInterval = setInterval(() => loadMessages(), 10000); 
}

// --- Message Notifications (staff) ---
function msgNotifEnabledKey(){
  return `qs_msg_notif_enabled:${state.user || 'unknown'}`;
}
function isMessageNotificationsEnabled(){
  try{ return localStorage.getItem(msgNotifEnabledKey()) === '1'; }catch(e){ return false; }
}
function setMessageNotificationsEnabled(on){
  try{ localStorage.setItem(msgNotifEnabledKey(), on ? '1' : '0'); }catch(e){}
}
function setMsgNotifStatus(text){
  const el = document.getElementById('msg-notif-status');
  if(el) el.innerText = text || '';
}
function initMessageNotificationsUI(){
  const box = document.getElementById('chk-msg-notif');
  const lbl = document.getElementById('lbl-msg-notif');
  if(lbl) lbl.innerText = (state.lang === 'de' ? 'Benachrichtigungen für neue Nachrichten' : 'تنبيه عند وصول رسالة جديدة');

  if(!box) return;
  const supported = ('Notification' in window);
  box.disabled = !supported;
  box.checked = isMessageNotificationsEnabled() && supported;

  if(!supported){
    setMsgNotifStatus(state.lang === 'de' ? 'Nicht unterstützt in diesem Browser.' : 'غير مدعوم في هذا المتصفح.');
  } else {
    setMsgNotifStatus('');
  }
}

async function toggleMessageNotifications(){
  const box = document.getElementById('chk-msg-notif');
  if(!box) return;

  if(!('Notification' in window)){
    box.checked = false;
    setMsgNotifStatus(state.lang === 'de' ? 'Nicht unterstützt in diesem Browser.' : 'غير مدعوم في هذا المتصفح.');
    return;
  }

  const wantOn = !!box.checked;
  if(wantOn){
    if(Notification.permission === 'default'){
      const p = await Notification.requestPermission();
      if(p !== 'granted'){
        box.checked = false;
        setMessageNotificationsEnabled(false);
        setMsgNotifStatus(state.lang === 'de' ? 'Berechtigung abgelehnt.' : 'تم رفض الإذن.');
        return;
      }
    }
    if(Notification.permission !== 'granted'){
      box.checked = false;
      setMessageNotificationsEnabled(false);
      setMsgNotifStatus(state.lang === 'de' ? 'Berechtigung fehlt.' : 'لا يوجد إذن.');
      return;
    }
    setMessageNotificationsEnabled(true);
    setMsgNotifStatus(state.lang === 'de' ? 'Aktiviert.' : 'تم التفعيل.');
  } else {
    setMessageNotificationsEnabled(false);
    setMsgNotifStatus(state.lang === 'de' ? 'Deaktiviert.' : 'تم الإلغاء.');
  }
}



function openAddUser() {
  editingUserIdx = null;
  document.getElementById('lbl-user-modal-title').innerText = t('addUser');
  document.getElementById('new-user-name').value = '';
  document.getElementById('new-user-name').disabled = false;
  document.getElementById('new-user-pin').value = '';
  document.getElementById('new-user-role').value = 'Lehrer';
  document.getElementById('new-user-role').disabled = false;
  openModal('user-modal');
}

function openEditUser(user) {
  editingUserIdx = user.rowIndex;
  document.getElementById('lbl-user-modal-title').innerText = t('editUser');
  document.getElementById('new-user-name').value = user.userName;
  document.getElementById('new-user-name').disabled = true; 
  document.getElementById('new-user-pin').value = user.pin; 
  document.getElementById('new-user-role').value = user.role;
  document.getElementById('new-user-role').disabled = true;
  openModal('user-modal');
}

function submitUser() {
  const name = document.getElementById('new-user-name').value;
  const pin = document.getElementById('new-user-pin').value;
  const role = document.getElementById('new-user-role').value;
  
  if (!name || !pin) { 
    showToast("Bitte Name und PIN eingeben"); 
    return; 
  }
  
  let actionPayload = {};
  
  if (editingUserIdx) { 
    actionPayload = { 
      action: 'manageUser', 
      subAction: 'update', 
      rowIndex: editingUserIdx, 
      newPin: pin 
    }; 
  } else { 
    actionPayload = { 
      action: 'manageUser', 
      subAction: 'add', 
      newUserName: name, 
      newPin: pin, 
      newRole: role 
    }; 
  }
  
  showToast("Speichern...");
  
  fetch(WEB_APP_URL, { 
    method: 'POST', 
    headers: { "Content-Type": "text/plain" }, 
    body: JSON.stringify(actionPayload) 
  })
  .then(r => r.json()).then(res => { 
    if (res.ok) { 
      showToast("Gespeichert"); 
      closeModal('user-modal'); 
      refreshData(); 
    } else { 
      showToast("Fehler: " + res.error); 
    } 
  });
}

function deleteUser(rowIndex) {
  if (!confirm(t('confirmDelUser'))) return;
  
  fetch(WEB_APP_URL, { 
    method: 'POST', 
    headers: { "Content-Type": "text/plain" }, 
    body: JSON.stringify({ 
      action: 'manageUser', 
      subAction: 'delete', 
      rowIndex: rowIndex 
    }) 
  })
  .then(r => r.json()).then(res => { 
    if (res.ok) { 
      showToast("Benutzer gelöscht"); 
      refreshData(); 
    } else { 
      showToast("Fehler: " + res.error); 
    } 
  });
}

function toggleDocVisibility(rowIndex, isVisible) {
  fetch(WEB_APP_URL, { 
    method: 'POST', 
    headers: { "Content-Type": "text/plain" }, 
    body: JSON.stringify({ 
      action: 'toggleDoc', 
      rowIndex: rowIndex, 
      isVisible: isVisible 
    }) 
  })
  .then(r => r.json()).then(res => { 
    if (res.ok) { 
      showToast("Sichtbarkeit aktualisiert"); 
    } else { 
      showToast("Fehler: " + res.error); 
    } 
  });
}

function linkify(text) {
  if (!text) return "";
  var urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
  
  return text.replace(urlRegex, function(url) {
    var safeUrl = url.replace(/'/g, "\\'");
    return '<a href="javascript:void(0)" onclick="openInGhostWindow(\'' + safeUrl + '\')" style="color:var(--primary); text-decoration:underline;">' + url + '</a>';
  });
}

document.getElementById("login-pin")?.addEventListener("keypress", function(event) { 
  if (event.key === "Enter") { 
    event.preventDefault(); 
    doLogin(); 
  } 
});

document.getElementById("login-identifier")?.addEventListener("keypress", function(event) { 
  if (event.key === "Enter") { 
    event.preventDefault(); 
    doLogin(); 
  } 
});

// Add keypress listener for lesson search
document.getElementById("lesson-search-input")?.addEventListener("keypress", function(event) { 
  if (event.key === "Enter") { 
    event.preventDefault(); 
    searchInLesson(); 
  } 
});
</script>


<!-- Student Akte: Evaluation History -->
<div id="stu-akte-eval-modal" class="modal-overlay" aria-hidden="true">
  <div class="modal-content" role="dialog" aria-modal="true">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
      <div id="stu-akte-eval-modal-title" class="font-bold" style="font-size:1.05rem;">Bewertungen</div>
      <button class="icon-btn" onclick="closeModal('stu-akte-eval-modal')" aria-label="Close"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <div style="margin-top:12px;">
      <div id="akte-eval-history-list" style="display:flex; flex-direction:column; gap:6px;"></div>
    </div>
  </div>
</div>

<!-- Student Akte: Attendance History -->
<div id="stu-akte-att-modal" class="modal-overlay" aria-hidden="true">
  <div class="modal-content" role="dialog" aria-modal="true">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
      <div id="stu-akte-att-modal-title" class="font-bold" style="font-size:1.05rem;">Anwesenheit</div>
      <button class="icon-btn" onclick="closeModal('stu-akte-att-modal')" aria-label="Close"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <div style="margin-top:12px;">
      <div id="akte-att-history-list" style="display:flex; flex-direction:column; gap:6px;"></div>
    </div>
  </div>
</div>


<!-- Student Akte: Fortschritt / تقدمي -->
<div id="stu-akte-prog-modal" class="modal-overlay" aria-hidden="true">
  <div class="modal-content" role="dialog" aria-modal="true">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
      <div id="stu-akte-prog-modal-title" class="font-bold" style="font-size:1.05rem;">Fortschritt</div>
      <button class="icon-btn" onclick="closeModal('stu-akte-prog-modal')" aria-label="Close"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <div style="margin-top:12px;">
      <div id="akte-prog-history-list" style="display:flex; flex-direction:column; gap:6px;"></div>
    </div>
  </div>
</div>

<!-- Student Alert Popup (shows late/absent + new notes/homework/evaluations until confirmed) -->
<div id="alert-modal" class="modal-overlay" aria-hidden="true">
  <div class="modal-content" role="dialog" aria-modal="true">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
      <div id="alert-modal-title" class="font-bold" style="font-size:1.05rem;"></div>
      <button class="icon-btn" onclick="dismissStudentAlertTemporarily()" aria-label="Close"><i class="fa-solid fa-xmark"></i></button>
    </div>

    <div id="alert-modal-body" style="white-space:pre-wrap; line-height:1.5; margin-top:10px;"></div>

    <div style="display:flex; gap:10px; margin-top:14px;">
      <button id="alert-modal-confirm" class="btn" onclick="confirmStudentAlertRead()" style="flex:1;"></button>
      <button id="alert-modal-close" class="btn btn-sec" onclick="dismissStudentAlertTemporarily()" style="flex:1;"></button>
    </div>

    <div id="alert-modal-counter" class="text-sm text-sec" style="text-align:center; margin-top:8px;"></div>
  </div>
</div>



<!-- Sync Issues Modal (unsaved actions) -->
<div id="sync-modal" class="modal-overlay" aria-hidden="true">
  <div class="modal-content" role="dialog" aria-modal="true">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
      <div id="sync-modal-title" class="font-bold" style="font-size:1.05rem;"></div>
      <button class="icon-btn" onclick="closeModal('sync-modal')" aria-label="Close"><i class="fa-solid fa-xmark"></i></button>
    </div>

    <div id="sync-modal-body" style="white-space:pre-wrap; line-height:1.5; margin-top:10px;"></div>

    <div style="display:flex; gap:10px; margin-top:14px; flex-wrap:wrap;">
      <button class="btn" onclick="retryFailedOps()">إعادة المحاولة / Wiederholen</button>
      <button class="btn" style="background: var(--surface-2); color: var(--text);" onclick="clearFailedOps()">مسح التحذيرات / Warnungen löschen</button>
    </div>
  </div>
</div>


  <!-- iOS-style exit confirmation -->
  <div id="ios-exit-confirm" class="hidden" aria-hidden="true">
    <div class="ios-backdrop"></div>
    <div class="ios-card" role="dialog" aria-modal="true" aria-labelledby="ios-exit-title" aria-describedby="ios-exit-msg">
      <div class="ios-body">
        <div id="ios-exit-title" class="ios-title">الخروج من التطبيق</div>
        <div id="ios-exit-msg" class="ios-msg">هل تريد فعلاً الخروج من التطبيق؟</div>
      </div>
      <div class="ios-actions">
        <button id="ios-exit-cancel" class="ios-btn ios-cancel" type="button">إلغاء</button>
        <button id="ios-exit-ok" class="ios-btn ios-exit" type="button">خروج</button>
      </div>
    </div>
  </div>

</body>
</html>