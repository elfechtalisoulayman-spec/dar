<!DOCTYPE html>
<html lang="de" dir="ltr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Schülerverwaltung</title>

  <link rel="icon" type="image/png" sizes="128x128"
        href="https://drive.google.com/thumbnail?id=1T7-S0REmEvmSJbsBxajYQcSb2laWC7Jd&sz=w128-h128">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Alexandria:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" referrerpolicy="no-referrer">
<style>
/* iOS MODERN THEME & DARK MODE SUPPORT */
:root{
  /* Chrome / Google-like + Kids friendly palette */
  --bg: #f4f7ff;
  --surface: #ffffff;
  --surface-2: #eef2ff;
  --primary: #1a73e8;         /* Google Blue */
  --primary-dark: #1558b0;
  --text: #202124;
  --text-sec: #5f6368;
  --danger: #ea4335;          /* Google Red */
  --warning: #fbbc04;         /* Google Yellow */
  --success: #34a853;         /* Google Green */
  --border: rgba(32,33,36,.12);
  --radius: 16px;
  --shadow: 0 10px 26px rgba(0,0,0,.08);
  --shadow-sm: 0 6px 16px rgba(0,0,0,.08);

  /* playful accents */
  --kid-1: #7c3aed;
  --kid-2: #06b6d4;
  --kid-3: #f97316;
  --kid-4: #22c55e;
}
.dark-mode {
  --bg: #000000;
  --surface: #1c1c1e;
  --surface-2: #2c2c2e;
  --primary: #0a84ff;
  --primary-dark: #3a97ff;
  --text: #ffffff;
  --text-sec: #8e8e93;
  --danger: #ff453a;
  --warning: #ffd60a;
  --success: #32d74b;
  --border: #3a3a3c;
}
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body { margin: 0; padding: 0; font-family: 'Alexandria', sans-serif; background: var(--bg); color: var(--text); overflow: hidden; }

.hidden { display: none !important; }
.flex { display: flex; }
.flex-col { flex-direction: column; }
.center { align-items: center; justify-content: center; }
.gap-2 { gap: 0.5rem; }
.w-full { width: 100%; }
.p-4 { padding: 1rem; }
.text-sm { font-size: 0.875rem; }
.font-bold { font-weight: 700; }
.text-sec { color: var(--text-sec); }

#qs-app-root { position: fixed; inset: 0; z-index: 10; display: flex; flex-direction: column; }

#login-overlay { position: fixed; inset: 0; z-index: 9999; background: var(--bg); display: flex; flex-direction: column; align-items: center; justify-content: center; }
.login-box { background: var(--surface); padding: 2rem; border-radius: var(--radius); width: 90%; max-width: 350px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
.login-box input { width: 100%; padding: 12px; margin-top: 1rem; background: var(--surface-2); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 1.2rem; text-align: center; letter-spacing: 4px; }
.login-box input.login-text { letter-spacing: 0; text-align: left; }
.btn { background: var(--koran-player-accent); color: white; border: none; padding: 12px 20px; border-radius: 10px; font-weight: 500; cursor: pointer; margin-top: 1rem; width: 100%; font-family: inherit; transition: 0.2s; box-shadow: none; }
.btn:active { transform: scale(0.98); opacity: 0.9; }
.btn-sec { background: var(--surface-2); color: var(--text); }

/* LOGIN TABS */
.login-tabs { display: flex; margin-bottom: 20px; background: var(--surface-2); border-radius: 8px; padding: 4px; }
.login-tab { flex: 1; padding: 8px; text-align: center; cursor: pointer; border-radius: 6px; font-size: 0.85rem; color: var(--text-sec); transition: 0.2s; }
.login-tab.active { background: var(--surface); color: var(--koran-player-accent); font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

header { background: var(--surface); padding: 1rem; display: flex; align-items: center; justify-content: space-between; border-bottom: 0; box-shadow: 0 0.5px 0 rgba(0, 0, 0, 0.1); position: relative; z-index: 100; }
.logo-area { display: flex; align-items: center; gap: 10px; }
.logo-img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
.header-actions { display: flex; gap: 8px; }
.icon-btn { background: var(--bg); color: var(--koran-player-accent); border: none; width: 44px; height: 44px; border-radius: 50%; cursor: pointer; position: relative; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; transition: background-color 0.1s; stroke-width: 2.5; stroke: currentColor; fill: none; }
.icon-btn:active { background: var(--surface-2); }
.icon-btn i { font-size: 1.15rem; line-height: 1; }

/* Cloud sync status */
#btn-cloud{ position: relative; }
#btn-stu-comm{ position: relative; }

#btn-cloud.cloud-ok{ color: var(--success); }
#btn-cloud.cloud-pending{ color: var(--warning); animation: cloudPulse 1.1s ease-in-out infinite; }
#btn-cloud.cloud-error{ color: var(--danger); }
@keyframes cloudPulse{ 0%{ transform: scale(1); } 50%{ transform: scale(1.06); } 100%{ transform: scale(1); } }
.badge { position: absolute; top: -2px; right: -2px; background: var(--danger); color: white; font-size: 10px; width: 16px; height: 16px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }

#filter-panel { background: var(--surface); overflow: hidden; max-height: 0; transition: max-height 0.3s ease; border-bottom: 0; box-shadow: 0 0.5px 0 rgba(0, 0, 0, 0.1); }
#filter-panel.open { max-height: 400px; overflow-y: auto; }
.search-bar { width: 100%; background: var(--bg); border: none; padding: 10px; color: var(--text); border-radius: 10px; font-family: inherit; }
.chips-container { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
.chip { padding: 6px 12px; background: var(--bg); border-radius: 20px; font-size: 0.8rem; cursor: pointer; border: 1px solid var(--border); user-select: none; color: var(--text); }
.chip.active { background: var(--koran-player-accent); color: white; border-color: var(--koran-player-accent); }

.filter-checkbox-group { display: flex; flex-wrap: wrap; gap: 10px; margin-top:6px;
  margin-bottom:6px; padding-top: 10px; border-top: 1px solid var(--border); }
.filter-checkbox { display: flex; align-items: center; font-size: 0.85rem; cursor: pointer; user-select: none; background: var(--bg); padding: 5px 10px; border-radius: 8px; border: 1px solid var(--border); }
.filter-checkbox input { margin-right: 8px; margin-left: 0; width: 18px; height: 18px; accent-color: var(--koran-player-accent); }

main { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 1rem; padding-top: 5px; padding-bottom: 80px; position: relative; }

/* Unified gap below header */
main > .p-4{ padding-top: 0 !important; padding-left: 0 !important; padding-right: 0 !important; }


.card { background: var(--surface); border-radius: 12px; padding: 1rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 1rem; position: relative; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
.card-avatar { width: 50px; height: 50px; border-radius: 50%; background: var(--surface-2); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; font-weight: bold; overflow: hidden; flex-shrink: 0; color: var(--text); }
.card-avatar img { width: 100%; height: 100%; object-fit: cover; }
.card-info { flex: 1; min-width: 0; word-break: break-word; overflow-wrap: anywhere; }
.money-badge { position: absolute; top: 10px; right: 10px; background: var(--danger); color: #fff; font-size: 10px; padding: 2px 6px; border-radius: 4px; }
.status-badge { font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; margin-top: 4px; display: inline-block; }
.status-warning { background: var(--danger); color: var(--text); opacity: 0.7; }
.status-full { background: var(--warning); color: var(--text); opacity: 0.7; }

/* --- NEW ATTENDANCE BUTTON STYLES --- */
.attend-actions { display: flex; flex-direction: column; gap: 6px; align-items: flex-end; }
.att-select-btn { display: flex; align-items: center; justify-content: center; width: 55px; height: 40px; border-radius: 12px; border: 2px solid #8e8e93; cursor: pointer; transition: all 0.2s ease-in-out; user-select: none; box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-weight: bold; }
.att-select-btn:active { transform: scale(0.95); }
.att-select-btn i { font-size: 1.05rem; line-height: 1; }
.att-select-btn.is-present { background: var(--success); color: white; border-color: #8e8e93; }
.att-select-btn.selected { background: var(--danger); color: white; border-color: var(--text); box-shadow: 0 0 12px var(--danger); }
.att-select-btn.is-absent-db { background: var(--danger); color: white; border-color: #8e8e93; box-shadow: 0 0 10px var(--danger); }
.att-select-btn.is-late-db { background: var(--warning); color: var(--text); border-color: #8e8e93; box-shadow: 0 0 10px var(--warning); }
.att-select-btn.is-late-db i { font-size: 1.05rem; line-height: 1; }
.att-select-btn.is-absent-db.selected { background: var(--success); box-shadow: none; border-color: var(--text); }

/* Floating Action Button */
.fab-container { position: fixed; bottom: 90px; left: 0; right: 0; display: flex; justify-content: center; pointer-events: none; z-index: 90; transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); transform: translateY(150px); }
.fab-container.show { transform: translateY(0); pointer-events: auto; }
.fab-btn { background: var(--koran-player-accent); color: white; border: none; padding: 12px 24px; border-radius: 30px; font-weight: bold; font-size: 1rem; box-shadow: 0 4px 15px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 10px; cursor: pointer; transition: 0.2s; }
.fab-btn:active { transform: scale(0.95); }
.fab-btn i { font-size: 1.1rem; line-height: 1; }

/* User FAB */
.fab-user-add { position: fixed; bottom: 90px; right: 20px; background: var(--koran-player-accent); color: white; width: 56px; height: 56px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(0,0,0,0.3); cursor: pointer; z-index: 80; transition: 0.2s; border: none; }
.fab-user-add:active { transform: scale(0.95); }

/* PROGRESS OVERLAY */
#progress-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
#progress-overlay.visible { opacity: 1; pointer-events: auto; }
.progress-box { background: var(--surface); padding: 25px; border-radius: 20px; width: 85%; max-width: 320px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
.progress-bar-track { width: 100%; height: 10px; background: var(--surface-2); border-radius: 10px; margin: 15px 0; overflow: hidden; }
.progress-bar-fill { height: 100%; background: var(--koran-player-accent); width: 0%; transition: width 0.3s ease; border-radius: 10px; }
.progress-text { font-size: 0.9rem; font-weight: bold; color: var(--text); }
.success-msg { color: var(--success); font-weight: bold; margin-top: 10px; display: none; }

.checkbox-list { max-height: 200px; overflow-y: auto; background: var(--bg); border-radius: 10px; padding: 5px; margin-top: 5px; border: 1px solid var(--border); }
.checkbox-item { display: flex; align-items: center; padding: 8px; border-bottom: 1px solid var(--border); }
.checkbox-item:last-child { border-bottom: none; }
.checkbox-item input[type="checkbox"] { width: 20px; height: 20px; margin-right: 10px; margin-left: 0; accent-color: var(--koran-player-accent); }
.checkbox-item label { flex: 1; font-size: 0.9rem; cursor: pointer; }

nav.bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--surface); border-top: 0; box-shadow: 0 -0.5px 0 rgba(0, 0, 0, 0.1); padding: 0.5rem; display: flex; justify-content: space-around; z-index: 50; padding-bottom: calc(0.5rem + env(safe-area-inset-bottom)); }
.nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: var(--text-sec); font-size: 0.7rem; background: none; border: none; cursor: pointer; position: relative; padding: 5px 0; }
.nav-item.active { color: var(--primary); }
.nav-item i { font-size: 1.1rem; line-height: 1; }

.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 100; display: flex; align-items: flex-end; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
.modal-overlay.visible { opacity: 1; pointer-events: auto; }
.modal-content { position: relative; background: var(--surface); width: 100%; max-height: 90vh; border-radius: 20px 20px 0 0; padding: 1.5rem; overflow-y: auto; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.4, 1); }
.modal-overlay.visible .modal-content { transform: translateY(0); }

.close-icon { position: absolute; top: 15px; right: 15px; background: var(--surface-2); border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: none; font-size: 1.2rem; color: var(--text-sec); z-index: 20; transition: background 0.2s; }
.close-icon:active { background: var(--border); }
.clickable-name { cursor: pointer; text-decoration: underline; text-decoration-color: rgba(255, 59, 48, 0.3); transition: opacity 0.2s; }
.clickable-name:active { opacity: 0.7; }

.detail-header { text-align: center; margin-bottom: 1.5rem; }
.detail-avatar { width: 80px; height: 80px; border-radius: 50%; margin: 0 auto 1rem; background: var(--surface-2); display: flex; align-items: center; justify-content: center; overflow: hidden; font-size: 2rem; }
.detail-avatar img { width: 100%; height: 100%; object-fit: cover; }
.detail-grid { display: flex; flex-direction: column; gap: 10px; text-align: left; }

.detail-item { background: var(--bg); padding: 0.8rem; border-radius: 10px; word-break: break-word; overflow-wrap: anywhere; }
.detail-label { font-size: 0.8rem; color: var(--text-sec); margin-bottom: 2px; font-weight: 500;}

.form-group { margin-bottom: 1rem; text-align: left; }
.form-label { display: block; font-size: 0.8rem; margin-bottom: 4px; color: var(--text-sec); }
.form-input, .form-select, .form-textarea { width: 100%; background: var(--bg); border: 1px solid var(--border); padding: 10px; color: var(--text); border-radius: 10px; font-family: inherit; }
.form-input:focus, .form-select:focus, .form-textarea:focus { border-color: var(--koran-player-accent); outline: none; }

.msg-card { background: var(--surface); padding: 1rem; margin-bottom: 1rem; border-radius: 12px; border-left: 4px solid var(--surface-2); box-shadow: 0 1px 3px rgba(0,0,0,0.08); transition: 0.2s; }
.msg-card.new { border-left-color: var(--koran-player-accent); }
.msg-header { display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.8rem; color: var(--text-sec); }
.msg-text { white-space: pre-wrap; word-break: break-word; overflow-wrap: anywhere; }
.msg-text a { color: var(--koran-player-accent); text-decoration: underline; }



/* ===== Messages tab: practical inbox layout ===== */
.comm-header{
  position: sticky;
  top: 0;
  z-index: 20;
  margin: -1rem -1rem 12px;
  padding: 12px 1rem 10px;
  background: var(--glass);
  backdrop-filter: saturate(180%) blur(22px);
  -webkit-backdrop-filter: saturate(180%) blur(22px);
  border-bottom: 1px solid rgba(60,60,67,0.12);
}
.comm-title-row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
}
.comm-title{
  margin:0;
  font-size: 1.05rem;
  font-weight: 900;
  letter-spacing: -0.01em;
}
.comm-tools{
  margin-top: 10px;
  display:flex;
  flex-direction:column;
  gap:8px;
}
.comm-search{
  display:flex;
  align-items:center;
  gap:10px;
  background: rgba(118,118,128,0.10);
  border: 1px solid rgba(60,60,67,0.14);
  border-radius: 16px;
  padding: 10px 12px;
  padding-bottom: calc(10px + env(safe-area-inset-bottom, 0px));
}
.comm-search i{ color: var(--text-sec); }
.comm-search input{
  flex:1;
  border: none;
  outline:none;
  background: transparent;
  color: var(--text);
  font-family: inherit;
  font-size: 0.95rem;
}
.comm-search .icon-btn{
  width: 34px;
  height: 34px;
  border-radius: 14px;
}
.comm-chips{
  display:flex;
  gap: 8px;
  flex-wrap:wrap;
}
.comm-notif .filter-checkbox{
  background: rgba(118,118,128,0.08);
  border: 1px solid rgba(60,60,67,0.12);
}
.comm-notif .filter-checkbox input{
  margin-right: 0;
  margin-left: 0;
  margin-inline-end: 8px;
}

.compose-panel{
  background: var(--surface);
  border: 1px solid rgba(60,60,67,0.14);
  border-radius: 22px;
  padding: 12px;
  margin-bottom: 12px;
  box-shadow: var(--shadow-1);
}


/* ===== Compose overlay (mobile-friendly, stays above keyboard) ===== */
.compose-overlay{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.25);
  backdrop-filter: blur(6px);
  z-index: 999;
}

.compose-actions{ display:flex; justify-content:flex-end; margin-top:10px; }
.compose-divider{ height:1px; background: var(--border); margin: 12px 0; }
.row-between{ display:flex; align-items:center; justify-content:space-between; }

@media (max-width: 680px){
  body.compose-open{ overflow: hidden; }

  body.compose-open #compose-panel{
    position: fixed;
    top: calc(env(safe-area-inset-top, 0px) + 10px);
    left: 10px;
    right: 10px;
    margin: 0;
    z-index: 1000;
    max-height: calc(var(--vvh, 100svh) - env(safe-area-inset-top, 0px) - 20px);
    overflow: auto;
  }
  body.compose-open #compose-panel .compose-head{
    position: sticky;
    top: 0;
    background: var(--surface);
    padding-top: 2px;
    z-index: 2;
  }
  body.compose-open #compose-panel textarea{
    min-height: 160px;
  }
}
.compose-head{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin-bottom: 10px;
}
.compose-panel .form-select,
.compose-panel .form-textarea{
  background: rgba(118,118,128,0.08);
  border: 1px solid rgba(60,60,67,0.14);
}
.compose-panel textarea.form-textarea{
  min-height: 110px;
}
#teacher-checklist{
  max-height: 180px;
  overflow:auto;
  padding-right: 4px;
}

.messages-list{
  display:flex;
  flex-direction:column;
  gap:8px;
}
.msg-item{
  background: var(--surface);
  border: 1px solid rgba(60,60,67,0.14);
  border-radius: 22px;
  overflow: hidden;
  box-shadow: var(--shadow-1);
}
.msg-item.unread{ box-shadow: 0 0 0 1px rgba(10,132,255,0.35) inset, var(--shadow-1); }
.msg-top{
  display:flex;
  gap:10px;
  align-items:flex-start;
  justify-content:space-between;
  padding: 12px 12px;
  cursor:pointer;
  user-select:none;
}
.msg-left{ min-width:0; flex:1; }
.msg-sender{
  font-weight: 900;
  line-height: 1.15;
  color: var(--text);
}
.msg-time{
  font-size: 0.78rem;
  color: var(--text-sec);
  white-space: nowrap;
  margin-inline-start: 10px;
}
.msg-snippet{
  margin-top: 3px;
  font-size: 0.9rem;
  color: var(--text-sec);
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
  word-break: break-word;
}
.msg-dot{
  width: 10px;
  height: 10px;
  border-radius: 999px;
  background: var(--koran-player-accent);
  margin-top: 4px;
  flex-shrink:0;
}
.msg-open{
  border-top: 1px solid rgba(60,60,67,0.12);
  padding: 10px 12px 12px;
}
.msg-full{
  white-space: pre-wrap;
  word-break: break-word;
  overflow-wrap:anywhere;
  line-height: 1.55;
  color: var(--text);
}
.msg-full a{ color: var(--koran-player-accent); text-decoration: underline; }
.msg-actions{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-top: 10px;
}
.msg-actions .btn{
  width: auto;
  padding: 8px 10px;
  font-size: 0.86rem;
  margin-top: 0;
}
.msg-empty{
  padding: 20px 12px;
  text-align:center;
  color: var(--text-sec);
}.notes-section { margin-top: 2rem; border-top: 1px solid var(--border); padding-top: 1rem; }
.notes-list { margin-bottom: 1rem; display: flex; flex-direction: column; gap: 8px; }
.note-item { background: var(--bg); padding: 10px; border-radius: 8px; font-size: 0.9rem; border: 1px solid var(--border); word-break: break-word; overflow-wrap: anywhere; }
.note-item a { color: var(--koran-player-accent); text-decoration: underline; }
.note-meta { font-size: 0.75rem; color: var(--text-sec); margin-top: 4px; display: flex; justify-content: space-between; }
.detail-item a { color: var(--koran-player-accent); text-decoration: underline; }

#toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: var(--surface); padding: 10px 20px; border-radius: 15px; color: var(--text); font-size: 0.9rem; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 200; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
#toast.show { opacity: 1; bottom: 150px; }

@media print {
  body * { visibility: hidden; }
  #print-container, #print-container * { visibility: visible; }
  #qs-app-root, #login-overlay { display: none !important; }
  #print-container { position: absolute; left: 0; top: 0; width: 100%; background: white; color: black; padding: 20px; }
}

html[dir="ltr"] .money-badge { left: auto; right: 10px; }
html[dir="ltr"] .close-icon { left: auto; right: 15px; }

.doc-actions { display: flex; gap: 10px; flex-shrink: 0; }
.doc-btn { background: var(--surface-2); color: var(--koran-player-accent); border: none; border-radius: 8px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
.doc-btn:active { transform: scale(0.95); opacity: 0.8; }
.doc-btn i { font-size: 1.05rem; line-height: 1; }

.user-action-btn { background: var(--surface-2); border: none; width: 36px; height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text); }



/* Admin -> Benutzer: grouped user list */
.user-group-card{
  /* .card is flex-row by default; we need stacked layout (title on top, users under it) */
  display:flex;
  flex-direction:column;
  align-items:stretch;
  gap:10px;
  padding:12px;
}
.user-group-header{ width:100%; }

.user-group-header { display:flex; align-items:center; justify-content:space-between; gap:12px; cursor:pointer; user-select:none; }
.user-group-title { display:flex; flex-direction:column; gap:2px; min-width:0; }
.user-group-chevron { transition: transform 0.18s ease; opacity: 0.85; }
.user-group-chevron.open { transform: rotate(180deg); }

.user-group-body { margin-top: 10px; display:flex; flex-direction:column; gap:8px; }
.user-row { display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 12px; border-radius: 12px; background: var(--surface-2); }

/* TAB CONTROLS for Modals */
.tab-controls { display: flex; margin-bottom: 1rem; border-bottom: 1px solid var(--border); }
.tab-ctrl { flex: 1; padding: 10px; text-align: center; cursor: pointer; color: var(--text-sec); border-bottom: 2px solid transparent; font-size: 0.9rem; }
.tab-ctrl.active { color: var(--koran-player-accent); border-bottom-color: var(--koran-player-accent); font-weight: bold; }


/* --- LESSON (Quran) Modal Styles --- */
.verse-card { background: var(--bg); border: 1px solid var(--border); border-radius: 12px; padding: 12px; margin-bottom: 10px; width: 100%; }
.verse-top { display:flex; align-items:center; justify-content:space-between; gap:10px; }
.verse-num { font-size: 0.8rem; color: var(--text-sec); }
.verse-ar { direction: rtl; text-align: right; font-size: 1.35rem; line-height: 2.2rem; margin-top: 8px; font-family: 'Alexandria', sans-serif; }
.verse-de { direction:ltr; text-align:left; font-size: 0.95rem; margin-top: 10px; color: var(--text); }
.audio-row { display:flex; gap:8px; margin-top:10px; }
.audio-btn { background: var(--koran-player-accent); color:#fff; border:none; padding:6px 8px; border-radius:10px; cursor:pointer; font-weight:600; font-family:inherit; flex:0 0 auto; }
.audio-btn:active { transform: scale(0.98); opacity:0.9; }
.audio-btn.sec { background: var(--surface-2); color: var(--text); }
.lesson-meta { font-size:0.85rem; color: var(--text-sec); margin-top: 2px; }

/* --- FLOATING AUDIO PLAYER --- */
/* (تم إزالة ستايل المشغل القديم لتفادي ظهوره لحظة ثم اختفائه. ستايل المشغل الحالي موجود أسفل الملف.) */

/* Quran Search Bar in Lesson Modal */
.quran-search-bar {
  display: flex;
  gap: 8px;
  margin-bottom: 15px;
  flex-wrap: wrap;
}
.quran-search-input {
  flex: 1;
  min-width: 0;
  background: var(--bg);
  border: 1px solid var(--border);
  padding: 10px;
  border-radius: 10px;
  color: var(--text);
  font-family: inherit;
}
.quran-search-btn {
  background: var(--koran-player-accent);
  color: white;
  border: none;
  padding: 10px 15px;
  border-radius: 10px;
  cursor: pointer;
  font-weight: 600;
  font-family: inherit;
  white-space: nowrap;
}
.quran-search-btn:active {
  transform: scale(0.98);
  opacity: 0.9;
}

/* Surah Header in Lesson Modal */
.surah-header {
  text-align: center;
  margin-bottom: 15px;
  padding-bottom: 10px;
  border-bottom: 1px solid var(--border);
}
.surah-name-arabic {
  font-size: 1.5rem;
  font-weight: bold;
  color: var(--koran-player-accent);
  margin-bottom: 5px;
  font-family: 'Alexandria', sans-serif;
}
.surah-name-latin {
  font-size: 1rem;
  color: var(--text-sec);
  margin-bottom: 5px;
}
.surah-info {
  font-size: 0.85rem;
  color: var(--text-sec);
  display: flex;
  justify-content: center;
  gap: 15px;
  margin-top: 5px;
}


/* Unified Login (one PIN field for all roles) */
.login-unified{
  margin-top: 14px;
  display:flex;
  flex-direction:column;
  gap:10px;
}
.login-badge{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  align-self:flex-start;
  padding:6px 10px;
  border-radius:999px;
  background: var(--surface-2);
  border:1px solid var(--border);
  color: var(--text-sec);
  font-size:0.8rem;
}
.login-text{
  background: var(--bg);
  border: 1px solid var(--border);
  padding: 12px 12px;
  border-radius: 10px;
  color: var(--text);
  font-size: 1rem;
  font-family: inherit;
  width: 100%;
}
.login-help{
  font-size: 0.78rem;
  color: var(--text-sec);
  line-height: 1.4;
}



/* Quran "mushaf" view (Tarteel-like) */
.lesson-view-toolbar{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  justify-content:flex-end;
  margin: 8px 0 12px;
}
.pill-btn{
  background: var(--surface-2);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 8px 12px;
  border-radius: 999px;
  cursor:pointer;
  font-weight:600;
  font-family: inherit;
}
.pill-btn:active{ transform: scale(0.98); opacity: 0.92; }

.mushaf-card{
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 16px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.06);
}
.mushaf-arabic{
  direction: rtl;
  text-align: justify;
  font-size: var(--mushaf-font, 1.65rem);
  line-height: 2.7rem;
  letter-spacing: 0;
  font-family: 'Alexandria', system-ui, -apple-system, Segoe UI, sans-serif;
  user-select: text;
}
.ayah-span{
  display:inline;
  cursor:pointer;
  border-radius: 8px;
  padding: 2px 4px;
  margin: 0 1px;
}
.ayah-span:hover{
  background: rgba(10,132,255,0.10);
}
.ayah-span.in-range{
  background: rgba(10,132,255,0.12);
  box-shadow: 0 0 0 1px rgba(10,132,255,0.28) inset;
}
.ayah-span.playing{
  background: rgba(52,199,89,0.12);
  box-shadow: 0 0 0 1px rgba(52,199,89,0.28) inset;
}
.ayah-num{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  width: 1.55em;
  height: 1.55em;
  margin: 0 0.25em 0 0.15em;
  border-radius: 999px;
  border: 1px solid var(--border);
  background: var(--bg);
  color: var(--text-sec);
  font-size: 0.55em;
  line-height: 1;
  vertical-align: middle;
}

.lesson-translation{
  margin-top: 12px;
  display:flex;
  flex-direction:column;
  gap:8px;
}
.trans-item{
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 12px;
}
.trans-head{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin-bottom: 6px;
}
.trans-ayah{
  font-weight:700;
  color: var(--koran-player-accent);
}
.trans-text{
  color: var(--text-sec);
  font-size: 0.95rem;
  line-height: 1.55;
}




/* Immersive Quran reader (student mode) — hides header for more mushaf space */
#lesson-modal.immersive { align-items: stretch; }
#lesson-modal.immersive .modal-content{
  height: 100vh;
  max-height: 100vh;
  border-radius: 0;
  padding: 0;
  overflow-y: auto;
}
#lesson-modal.immersive .close-icon{ display:none !important; }
#lesson-modal.immersive .quran-search-bar,
#lesson-modal.immersive .surah-header,
#lesson-modal.immersive .card,
#lesson-modal.immersive .lesson-view-toolbar{ display:none !important; }

/* Let the mushaf use the full width */
#lesson-modal.immersive .mushaf-card{
  background: transparent;
  border: none;
  padding: 0;
  box-shadow: none;
}
#lesson-modal.immersive #lesson-verses{
  padding: calc(env(safe-area-inset-top) + 14px) 14px calc(env(safe-area-inset-bottom) + 18px);
}
#lesson-modal.immersive #lesson-translation{
  padding: 0 14px calc(env(safe-area-inset-bottom) + 18px);
}

.lesson-immersive-handle{
  position: fixed;
  top: calc(env(safe-area-inset-top) + 8px);
  left: 50%;
  transform: translateX(-50%);
  width: 56px;
  height: 4px;
  border-radius: 999px;
  background: rgba(255,255,255,0.38);
  z-index: 140;
  opacity: 0.95;
}
#lesson-modal:not(.immersive) .lesson-immersive-handle{ display:none; }

.lesson-immersive-bar{
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 141;
  display: flex;
  align-items: center;
  gap: 10px;
  padding: calc(env(safe-area-inset-top) + 10px) 12px 10px;
  background: rgba(28,28,30,0.72);
  backdrop-filter: saturate(180%) blur(20px);
  -webkit-backdrop-filter: saturate(180%) blur(20px);
  border-bottom: 1px solid rgba(255,255,255,0.10);
  color: #fff;
  transform: translateY(-120%);
  transition: transform 0.22s ease;
}
.lesson-immersive-bar.show{ transform: translateY(0); }
/* No top immersive controls in memorization (Hausaufgaben) overlay */
body.lesson-memo-open #lesson-immersive-bar,
body.lesson-memo-open #lesson-immersive-handle{ display:none !important; }

/* Remove Quran search option from memorization (Hausaufgaben) overlay */
body.lesson-memo-open #lesson-modal .quran-search-bar{ display:none !important; }
#lesson-modal:not(.immersive) .lesson-immersive-bar{ display:none; }

.lesson-immersive-btn{
  background: rgba(255,255,255,0.10);
  border: 1px solid rgba(255,255,255,0.14);
  color:#fff;
  width: 40px;
  height: 40px;
  border-radius: 12px;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
}
.lesson-immersive-btn i{ font-size: 1rem; line-height: 1; }
.lesson-immersive-btn:active{ transform: scale(0.97); opacity: 0.9; }

.lesson-immersive-title{
  font-weight: 800;
  font-size: 0.95rem;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  flex: 1;
  text-align: center;
}

.lesson-immersive-actions{
  display:flex;
  gap: 8px;
}

/* Homework type selector */
.hw-type-row{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}
.hw-type{
  display:flex;
  align-items:center;
  gap:8px;
  padding:8px 10px;
  border-radius:12px;
  border:1px solid var(--border);
  background: var(--surface-2);
  cursor:pointer;
  user-select:none;
  font-size:0.95rem;
}
.hw-type input{ margin:0; }

/* Memorization (save) view: each ayah as its own card (Arabic + translation) */
.ayah-cards{
  display:flex;
  flex-direction:column;
  gap:10px;
}
.ayah-card{
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}
.ayah-card-head{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin-bottom: 8px;
}
.ayah-card-title{
  font-weight: 800;
  color: var(--koran-player-accent);
  font-size: 0.95rem;
}
.ayah-card-ar{
  direction: rtl;
  text-align: right;
  font-size: 1.25rem;
  line-height: 2.05rem;
  font-family: 'Alexandria', system-ui, -apple-system, Segoe UI, sans-serif;
}

/* Word-by-word pronunciation (click a word to hear it) */
.ayah-word{
  display:inline-block;
  cursor:pointer;
  padding: 2px 6px;
  border-radius: 10px;
  margin: 0 1px;
  touch-action: manipulation;
  -webkit-tap-highlight-color: transparent;
  transition: background 0.15s ease, transform 0.15s ease;
  user-select:none;
}
.ayah-word:hover{
  background: rgba(10,132,255,0.12);
}
.ayah-word:active{
  transform: scale(0.98);
}
.ayah-word.playing{
  background: rgba(10,132,255,0.18);
  box-shadow: 0 0 0 1px rgba(10,132,255,0.35) inset;
}
.ayah-card-tr{
  margin-top: 8px;
  color: var(--text-sec);
  font-size: 0.86rem;
  line-height: 1.55;
  white-space: pre-wrap;
}



.ayah-card-tr.phonetic{
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  direction: ltr;
}
.audio-btn.active{
  box-shadow: 0 0 0 1px rgba(10,132,255,0.45) inset;
  background: rgba(10,132,255,0.18);
  color: var(--text);
}
/* Floating reader toggle (student) */
.reader-fab{
  position: fixed;
  bottom: 84px; /* above bottom nav */
  right: 18px;
  width: 52px;
  height: 52px;
  border-radius: 999px;
  border: 1px solid var(--border);
  background: var(--koran-player-accent);
  color: white;
  box-shadow: 0 8px 18px rgba(0,0,0,0.25);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index: 99999;
  cursor:pointer;
}
.reader-fab i{ font-size: 1.35rem; }
.reader-fab.hidden{ display:none; }
.reader-fab:active{ transform: scale(0.98); opacity: 0.92; }


.ayah-span.selected{
  background: rgba(10,132,255,0.18);
  box-shadow: 0 0 0 1px rgba(10,132,255,0.35) inset;
}


/* Student memorize (surah list) */
.surah-card{
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 18px;
  padding: 12px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  cursor:pointer;
}
.surah-left{
  display:flex;
  gap:12px;
  align-items:center;
  min-width:0;
}
.surah-badge{
  width: 44px;
  height: 44px;
  border-radius: 14px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight: 800;
  color: white;
  background: var(--koran-player-accent);
  flex: 0 0 auto;
}
.surah-names{
  min-width:0;
}
.surah-ar{
  font-weight: 800;
  font-size: 1.15rem;
  line-height: 1.2;
  color: var(--text);
  direction: rtl;
}
.surah-la{
  font-size: 0.9rem;
  color: var(--text-sec);
  margin-top: 2px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.surah-meta{
  font-size: 0.78rem;
  color: var(--text-sec);
  margin-top: 6px;
}
.surah-open{
  width: auto;
  padding: 10px 14px;
  border-radius: 14px;
}


/* ===== iPhone Premium Polish (override) ===== */
:root{
  --radius: 16px;
  --radius-lg: 22px;
  --shadow-1: 0 2px 10px rgba(0,0,0,0.06);
  --shadow-2: 0 10px 30px rgba(0,0,0,0.18);
  --glass: rgba(255,255,255,0.72);
  --glass-2: rgba(255,255,255,0.55);
}
.dark-mode{
  --glass: rgba(28,28,30,0.72);
  --glass-2: rgba(28,28,30,0.55);
}
body{
  font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", "Alexandria", system-ui, sans-serif;
  background: radial-gradient(1200px 700px at 20% -10%, rgba(0,122,255,0.12), transparent 60%),
              radial-gradient(900px 600px at 90% 0%, rgba(52,199,89,0.10), transparent 55%),
              var(--bg);
}
header{
  background: var(--glass);
  backdrop-filter: saturate(180%) blur(22px);
  -webkit-backdrop-filter: saturate(180%) blur(22px);
  border-bottom: 1px solid rgba(60,60,67,0.12);
  box-shadow: none;
}
nav.bottom-nav{
  background: var(--glass);
  backdrop-filter: saturate(180%) blur(22px);
  -webkit-backdrop-filter: saturate(180%) blur(22px);
  border-top: 1px solid rgba(60,60,67,0.12);
  box-shadow: none;
}
.card, .surah-card, .mushaf-card, .msg-card, .progress-box, .login-box, .modal-content{
  border-radius: var(--radius-lg);
}
.card{ box-shadow: var(--shadow-1); }
.surah-card{ box-shadow: var(--shadow-1); }
.mushaf-card{ box-shadow: var(--shadow-1); }
.icon-btn{ background: rgba(118,118,128,0.12); }
.icon-btn:active{ background: rgba(118,118,128,0.22); }
.search-bar, .form-input, .form-select, .form-textarea, .quran-search-input{
  background: rgba(118,118,128,0.10);
  border: 1px solid rgba(60,60,67,0.14);
}
.chip{ background: rgba(118,118,128,0.10); border: 1px solid rgba(60,60,67,0.14); }
.modal-overlay{
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
}
.modal-content{
  background: var(--glass);
  border: 1px solid rgba(60,60,67,0.12);
  box-shadow: var(--shadow-2);
}
.btn{
  box-shadow: 0 8px 18px rgba(0,122,255,0.25);
}
.btn.btn-sec{
  box-shadow: none;
}
.ayah-span{
  touch-action: manipulation; /* prevent double-tap zoom + improves multi-tap gestures */
}
@media (prefers-reduced-motion: reduce){
  *{ transition: none !important; animation: none !important; }
}

/* Quick Verse Sheet (meaning / phonetic) */
.quick-sheet-overlay{
  position: fixed;
  inset: 0;
  z-index: 999999;
  display: flex;
  align-items: flex-end;
  justify-content: center;
  padding: 16px;
  padding-bottom: calc(16px + env(safe-area-inset-bottom));
  background: rgba(0,0,0,0.25);
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.22s ease;
}
.quick-sheet-overlay.show{
  opacity: 1;
  pointer-events: auto;
}
.quick-sheet{
  width: min(680px, 100%);
  background: var(--glass);
  backdrop-filter: saturate(180%) blur(26px);
  -webkit-backdrop-filter: saturate(180%) blur(26px);
  border: 1px solid rgba(60,60,67,0.14);
  border-radius: 26px;
  box-shadow: var(--shadow-2);
  padding: 14px 14px 12px;
  transform: translateY(18px);
  transition: transform 0.22s ease;
}
.quick-sheet-overlay.show .quick-sheet{ transform: translateY(0); }
.quick-sheet-top{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin-bottom: 8px;
}
.quick-sheet-title{
  font-weight: 800;
  letter-spacing: -0.01em;
  color: var(--koran-player-accent);
  font-size: 0.98rem;
}
.quick-sheet-actions{
  display:flex;
  gap:8px;
  align-items:center;
}
.quick-sheet-btn{
  border: 1px solid rgba(60,60,67,0.14);
  background: rgba(118,118,128,0.12);
  color: var(--text);
  border-radius: 12px;
  padding: 8px 10px;
  cursor:pointer;
  font-weight: 700;
  font-family: inherit;
}
.quick-sheet-btn:active{ transform: scale(0.98); opacity: 0.92; }
.quick-sheet-close{
  width: 36px;
  height: 36px;
  border-radius: 999px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size: 1.1rem;
}
.quick-sheet-ar{
  direction: rtl;
  text-align: right;
  font-size: 1.20rem;
  line-height: 2.00rem;
  padding: 10px 12px;
  padding-bottom: calc(10px + env(safe-area-inset-bottom, 0px));
  border-radius: 16px;
  border: 1px solid rgba(60,60,67,0.14);
  background: rgba(118,118,128,0.10);
  font-family: 'Alexandria', -apple-system, system-ui, sans-serif;
}
.quick-sheet-body{
  margin-top: 10px;
  padding: 10px 12px;
  padding-bottom: calc(10px + env(safe-area-inset-bottom, 0px));
  border-radius: 16px;
  border: 1px solid rgba(60,60,67,0.14);
  background: rgba(118,118,128,0.08);
  color: var(--text);
  line-height: 1.6;
  font-size: 0.90rem;
  word-break: break-word;
  overflow-wrap: anywhere;
}
.quick-sheet-sub{
  margin-top: 8px;
  font-size: 0.78rem;
  color: var(--text-sec);
}



/* === Login redesign (cleaner + more organized) === */
.login-box{
  width: min(420px, 92vw);
  padding: 22px;
  text-align: left;
}
.login-brand{
  display:flex;
  align-items:center;
  gap:14px;
  margin-bottom: 14px;
}
.login-logo{
  width: 64px;
  height: 64px;
  border-radius: 14px;
  object-fit: cover;
  box-shadow: 0 6px 18px rgba(0,0,0,0.12);
}
.login-brand-text h2{
  margin:0;
  line-height: 1.2;
}
.login-sub{
  margin-top: 4px;
  font-size: 0.85rem;
  color: var(--text-sec);
}
.login-form .form-group{ margin-top: 10px; }
.login-remember{
  display:flex;
  align-items:center;
  gap:8px;
  margin-top: 12px;
  font-size: 0.92rem;
  justify-content:flex-start;
}

/* Fix: keep "Angemeldet bleiben" aligned with its checkbox */
.login-remember input[type="checkbox"]{
  width: 18px;
  height: 18px;
  margin: 0;
  padding: 0;
  flex: 0 0 auto;
  accent-color: var(--koran-player-accent);
}
.login-remember span{
  line-height: 1.1;
}

.login-error{
  color: var(--danger);
  margin-top: 10px;
  font-size: 0.9rem;
  min-height: 1.2em;
}
.login-pin{
  text-align:center;
  letter-spacing: 4px;
  font-size: 1.15rem;
}

/* === Red dot badge for "new" on tabs === */
.dot-badge{
  position:absolute;
  top: 6px;
  right: 16px;
  width: 10px;
  height: 10px;
  border-radius: 999px;
  background: var(--primary);
  box-shadow: 0 0 0 2px var(--bg);
}

/* Student popup alerts */
#alert-modal .modal-content{
  border-radius: 18px;
  width: min(520px, calc(100% - 32px));
  height: auto;
  max-height: 80vh;
  margin: 10vh auto;
  transform: translateY(18px) scale(0.99);
}
#alert-modal.visible .modal-content{
  transform: translateY(0) scale(1);
}


/* === Stats: make Today boxes compact + horizontal on mobile (Teacher/Admin) === */
.stats-mini-row{
  display: grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 10px;
  margin-top: 1rem;
}
.stats-mini-row .card{
  margin: 0 !important;
  padding: 0.75rem;
  gap: 0.35rem;
  align-items: center;
  justify-content: center;
  text-align: center;
}
.stats-mini-row .text-sec{
  font-size: 0.72rem;
  line-height: 1.15;
}
.stats-mini-row .font-bold{
  font-size: 1.55rem !important; /* override inline 2rem */
  line-height: 1.2;
}
@media (max-width: 360px){
  .stats-mini-row{ gap: 8px; }
  .stats-mini-row .card{ padding: 0.65rem; }
  .stats-mini-row .font-bold{ font-size: 1.35rem !important; }
}



/* === Fortschritt inline summary (Akte + Home) === */
.prog-inline{
  display:flex;
  flex-direction:column;      /* كل سورة في سطر */
  align-items:flex-end;       /* محاذاة لليمين */
  gap:4px;
  line-height: 1.35;
  max-width: 100%;
}
.prog-item{
  display:block;              /* سطر مستقل */
  font-weight: 900;
  font-size: 0.95rem;
  white-space: nowrap;
}
.prog-item.partial{ color: var(--danger); }
.prog-item.complete{ color: var(--success); }
/* separator not used anymore */
.prog-sep{ display:none; }
@media (max-width: 420px){
  .prog-item{ font-size: 0.9rem; white-space: normal; }
}



/* --- Header layout update: logo + title centered, icons under --- */
.app-header{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:2px;
  text-align:center;
}

.app-header .logo-area{
  display:flex;
  flex-direction:row; /* keep logo beside text */
  justify-content:center;
  align-items:center;
  gap:6px;
}
.app-header .logo-text{
  display:flex;
  flex-direction:column;
  align-items:flex-start;
  text-align:left;
}

.app-header .header-actions{
  width:100%;
  display:flex;
  justify-content:center;
  align-items:center;
  gap:6px;
  flex-wrap:wrap;
}

/* header-actions tighten */
.header-actions{ margin:0; padding:0; }



/* --- Header ultra-compact --- */
header.app-header{
  padding: 1px 8px 1px 8px; /* 1px top, 1px bottom */
}
header.app-header .logo-img{ width:32px; height:32px; }
header.app-header .icon-btn{ width:30px; height:30px; font-size:1.05rem; }
header.app-header .logo-text{ line-height:1.05; }

.app-header .logo-text{
  line-height: 1.15;
}
.app-header .logo-img{
  width: 34px;
  height: 34px;
}
.app-header .icon-btn{
  width: 44px;
  height:  44px;
  padding:  9px;
}
.app-header .icon-btn i { font-size: 1.15rem; line-height: 1; }
/* --- Bigger header icons (touch friendly) --- */
.app-header .icon-btn{
  width: 45px !important;
  height: 45px !important;
  padding: 7px !important;
  margin: 0 !important;
}
.app-header .icon-btn i { font-size: 1.15rem; line-height: 1; }
/* keep only 1px gap to header bottom */
header.app-header{
  padding-top: 1px !important;
  padding-bottom: 1px !important;
}


/* === Ultra-compact Schüler cards (requested) === */
#tab-students { padding-top: 5px !important; padding-left: 6px !important; padding-right: 6px !important; }
#tab-students .card{
  padding:  2px 10px !important;          /* +2px top/bottom for taller student rows */
  margin-bottom: 3px !important;       /* minimal space between students */
  gap: 10px !important;
  align-items: stretch !important;      /* let action column span full height */
}
#tab-students .card-avatar{
  width: 44px !important;
  height: 44px !important;
  align-self: center !important;
}
#tab-students .card-info{
  align-self: center !important;
}
#tab-students .card-info .font-bold{
  line-height: 1.05 !important;
  margin: 0 !important;
}
#tab-students .card-info .text-sm{
  line-height: 1.05 !important;
  margin-top: 1px !important;
}
#tab-students .card-info .status-badge{
  margin-top: 1px !important;
}
#tab-students .attend-actions{
  align-self: stretch !important;
  justify-content: space-between !important; /* first button touches top, second touches bottom */
  gap: 0 !important;
  padding: 0 !important;
  margin: 0 !important;
}
#tab-students .att-select-btn{
  margin: 0 !important;
}



/* --- Saved profiles (quick login) --- */
.saved-profiles{
  margin-top: 10px;
  padding: 8px 10px;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.04);
}
.saved-profiles.hidden{ display:none !important; }

.saved-profiles-title{
  font-weight: 700;
  font-size: 13px;
  line-height: 1.1;
  margin: 0 0 8px 0;
  opacity: .95;
}
.saved-profiles-hint{
  font-size: 11px;
  line-height: 1.1;
  margin-top: 8px;
  opacity: .75;
}
.saved-profiles-list{
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.profile-tile{
  position: relative;
  width: 86px;
  padding: 8px 6px 6px;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.06);
  cursor: pointer;
  user-select: none;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  transition: transform .08s ease, background .08s ease, border-color .08s ease;
}
.profile-tile:active{ transform: scale(.98); }
.profile-tile:hover{ background: rgba(255,255,255,.09); border-color: rgba(255,255,255,.22); }

.profile-avatar{
  width: 48px;
  height: 48px;
  border-radius: 999px;
  display: grid;
  place-items: center;
  font-weight: 800;
  font-size: 16px;
  letter-spacing: .4px;
  background: rgba(0,0,0,.25);
  border: 1px solid rgba(255,255,255,.20);
}
body.dark .profile-avatar{ background: rgba(255,255,255,.10); }

.profile-name{
  margin-top: 6px;
  font-size: 11px;
  line-height: 1.05;
  text-align: center;
  max-width: 100%;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  opacity: .95;
}

.profile-sub{
  margin-top: 2px;
  font-size: 10px;
  line-height: 1.05;
  opacity: .70;
}

.profile-remove{
  position: absolute;
  top: 4px;
  right: 4px;
  width: 18px;
  height: 18px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.22);
  background: rgba(0,0,0,.25);
  color: inherit;
  font-size: 14px;
  line-height: 16px;
  padding: 0;
  cursor: pointer;
}
.profile-remove:hover{ background: rgba(255,0,0,.22); border-color: rgba(255,0,0,.35); }

@media (max-width: 420px){
  .profile-tile{ width: 78px; }
  .profile-avatar{ width: 44px; height: 44px; }
}
/* === Login Loading Overlay (modern + animated) === */
#login-loading-overlay{
  position: fixed;
  inset: 0;
  z-index: 100000; /* فوق شاشة الدخول */
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 18px;
  padding-bottom: calc(18px + env(safe-area-inset-bottom));
  background: rgba(0,0,0,0.35);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.25s ease;
}
#login-loading-overlay.visible{
  opacity: 1;
  pointer-events: auto;
}
.login-loading-card{
  width: min(360px, 92vw);
  border-radius: 26px;
  padding: 18px 16px 16px;
  background: radial-gradient(900px 500px at 20% 0%, rgba(0,122,255,0.55), rgba(0,0,0,0.20) 55%),
              radial-gradient(700px 520px at 90% 0%, rgba(52,199,89,0.30), rgba(0,0,0,0.0) 58%),
              rgba(18,18,20,0.55);
  border: 1px solid rgba(255,255,255,0.18);
  box-shadow: 0 20px 60px rgba(0,0,0,0.40);
  color: #fff;
  text-align: center;
}
.login-loading-text{
  margin-top: 12px;
  font-weight: 800;
  letter-spacing: -0.01em;
  font-size: 0.95rem;
  opacity: 0.95;
}
.login-loading-sub{
  margin-top: 4px;
  font-size: 0.78rem;
  opacity: 0.78;
}
#lbl-login-btn:disabled{
  opacity: 0.65;
  cursor: not-allowed;
}

/* HTML:
   <div class="loader"></div>
*/
.loader {
  width: 75px;
  aspect-ratio: 1;
  display: grid;
  margin: 0 auto;
}
.loader:before,
.loader:after {
  content: "";
  grid-area: 1/1;
  width: 35px;
  aspect-ratio: 1;
  box-shadow: 0 0 0 3px #fff inset;
  filter: drop-shadow(40px 40px 0 #fff);
  animation: l8 2s infinite alternate;
}
.loader:after {
  margin: 0 0 0 auto;
  filter: drop-shadow(-40px 40px 0 #fff);
  animation-delay: -1s;
}
@keyframes l8 {
  0%,10%   {border-radius:0}
  30%,40%  {border-radius:50% 0}
  60%,70%  {border-radius:50%}
  90%,100% {border-radius:0 50%}
}

/* --- Inline saved profiles dropdown inside username field --- */
#saved-profiles{ display:none !important; } /* hide old tiles UI (replaced by dropdown) */

.input-dd{
  position: relative;
}
.input-dd #login-identifier{ padding-right: 54px; }

.input-dd .dd-btn{
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  width: 34px;
  height: 34px;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.08);
  color: inherit;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  transition: transform .12s ease, background .12s ease;
}
.input-dd .dd-btn:active{ transform: translateY(-50%) scale(.98); }
.input-dd .dd-btn:hover{ background: rgba(255,255,255,.12); }

.input-dd .dd-panel{
  position:absolute;
  left:0;
  right:0;
  top: calc(100% + 8px);
  z-index: 1000;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(18,18,22,.72);
  backdrop-filter: blur(14px);
  -webkit-backdrop-filter: blur(14px);
  box-shadow: 0 18px 40px rgba(0,0,0,.35);
  overflow:hidden;
  max-height: 260px;
}
.input-dd .dd-panel.hidden{ display:none !important; }

.dd-item{
  width:100%;
  display:flex;
  align-items:center;
  gap:10px;
  padding:10px 10px;
  background: transparent;
  border: 0;
  color: inherit;
  text-align:left;
  cursor:pointer;
}
.dd-item:hover{ background: rgba(255,255,255,.08); }
.dd-item:active{ background: rgba(255,255,255,.11); }

.dd-avatar{
  width: 34px;
  height: 34px;
  border-radius: 12px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight: 700;
  background: rgba(255,255,255,.10);
  border: 1px solid rgba(255,255,255,.12);
  flex: 0 0 auto;
}
.dd-meta{
  min-width: 0;
  flex: 1 1 auto;
}
.dd-name{
  font-weight: 650;
  font-size: 0.95rem;
  line-height: 1.1;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.dd-sub{
  opacity: .78;
  font-size: 0.78rem;
  margin-top: 2px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.dd-remove{
  width: 28px;
  height: 28px;
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.06);
  color: inherit;
  cursor: pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  flex: 0 0 auto;
}
.dd-remove:hover{ background: rgba(255,255,255,.10); }


/* --- iOS-style exit confirmation (Back button) --- */
#ios-exit-confirm{
  position: fixed;
  inset: 0;
  z-index: 99999;
  display: grid;
  place-items: center;
  pointer-events: none;
}
#ios-exit-confirm.hidden{ display:none; }
#ios-exit-confirm .ios-backdrop{
  position:absolute;
  inset:0;
  background: rgba(0,0,0,.35);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  opacity: 0;
  transition: opacity .18s ease;
}
#ios-exit-confirm .ios-card{
  position: relative;
  width: min(340px, calc(100vw - 40px));
  border-radius: 16px;
  background: rgba(255,255,255,.92);
  color: var(--koran-player-text);
  box-shadow: 0 12px 40px rgba(0,0,0,.25);
  transform: translateY(8px) scale(.98);
  opacity: 0;
  transition: transform .18s ease, opacity .18s ease;
  overflow: hidden;
  direction: rtl;
  text-align: right;
}
body.dark #ios-exit-confirm .ios-card{
  background: rgba(28,28,30,.92);
  color: #f5f5f7;
  box-shadow: 0 14px 44px rgba(0,0,0,.45);
}
#ios-exit-confirm.visible{ pointer-events:auto; }
#ios-exit-confirm.visible .ios-backdrop{ opacity: 1; }
#ios-exit-confirm.visible .ios-card{
  transform: translateY(0) scale(1);
  opacity: 1;
}
#ios-exit-confirm .ios-body{
  padding: 16px 18px 14px;
}
#ios-exit-confirm .ios-title{
  font-weight: 700;
  font-size: 16px;
  line-height: 1.2;
  margin-bottom: 6px;
}
#ios-exit-confirm .ios-msg{
  font-size: 14px;
  line-height: 1.45;
  opacity: .9;
}
#ios-exit-confirm .ios-actions{
  display: grid;
  grid-template-columns: 1fr 1fr;
  border-top: 1px solid rgba(0,0,0,.12);
}
body.dark #ios-exit-confirm .ios-actions{
  border-top-color: rgba(255,255,255,.12);
}
#ios-exit-confirm .ios-btn{
  appearance:none;
  border:0;
  background: transparent;
  padding: 12px 10px;
  font-size: 15px;
  cursor: pointer;
  color: inherit;
}
#ios-exit-confirm .ios-btn + .ios-btn{
  border-right: 1px solid rgba(0,0,0,.12);
}
body.dark #ios-exit-confirm .ios-btn + .ios-btn{
  border-right-color: rgba(255,255,255,.12);
}
#ios-exit-confirm .ios-btn.ios-cancel{
  font-weight: 600;
}
#ios-exit-confirm .ios-btn.ios-exit{
  font-weight: 700;
  color: #ff3b30;
}


/* --- Bulk Homework (Teacher/Admin) --- */
#hw-bulk-progress { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
#hw-bulk-progress.visible { opacity: 1; pointer-events: auto; }
.hw-admin-card{
  padding: 14px !important;
}
.hw-admin-grid{
  width:100%;
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:10px;
}
@media (max-width: 520px){
  .hw-admin-grid{ grid-template-columns: 1fr; }
}
.hw-admin-actions{
  width:100%;
  display:flex;
  gap:5px;
  margin-top:5px;
}

.hw-admin-actions-wide{ flex-wrap: wrap; align-items: center; ; justify-content:flex-start}
.btn-danger{
  background: rgba(255,59,48,0.14);
  border: 1px solid rgba(255,59,48,0.35);
  color: #ff3b30;
}
.btn-danger:hover{ background: rgba(255,59,48,0.22); }
.btn-danger:active{ transform: scale(0.98); }

.icon-btn-mini{
  border: 1px solid var(--border);
  background: rgba(255,255,255,0.06);
  color: var(--text);
  padding: 6px 10px;
  border-radius: 10px;
  font-weight: 900;
  cursor: pointer;
}
body.dark .icon-btn-mini{ background: rgba(255,255,255,0.04); }
.icon-btn-mini:active{ transform: scale(0.98); }
.icon-btn-mini.danger{
  border-color: rgba(255,59,48,0.35);
  color: #ff3b30;
}
.hw-all-actions{
  display:flex;
  align-items:center;
  gap:5px;
}

.hw-admin-actions .btn{ flex:1; display:flex; align-items:center; justify-content:center; gap:6px; padding:8px 10px; min-height:36px; line-height:1; }
.hw-admin-actions .btn i{ font-size:1.05em; }


.bulk-list{
  width:100%;
  margin-top:10px;
  max-height: 420px;
  overflow:auto;
  border: 0;
  border-radius: 0;
  background: transparent;
}
body.dark .bulk-list{
  background: transparent;
}
.bulk-row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:6px 8px;
  border-bottom: 1px solid var(--border);
}
.bulk-row:last-child{ border-bottom:none; }
.bulk-row .bulk-left{
  display:flex;
  align-items:center;
  gap:8px;
  min-width:0;
}
.bulk-row .bulk-name{
  font-weight:800;
  font-size:0.95rem;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

.bulk-name.hw-seen{ color: var(--success); }
.bulk-name.hw-unseen{ color: var(--warning); }

.bulk-row .bulk-meta{
  font-size:0.75rem;
  color: var(--text-sec);
  margin-top:1px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.bulk-empty{
  padding:12px;
  color: var(--text-sec);
  font-size:0.85rem;
  text-align:center;
}


.hw-top-actions{
  width:100%;
  display:flex;
  gap:10px;
  margin: 8px 0 10px 0;
}
.hw-top-actions .btn{ flex:1; }

.bulk-list-open{
  max-height: 55vh;
  overflow:auto;
}
.hw-all-panel{
  width:100%;
  padding:8px 10px;
  border-bottom: 1px solid var(--border);
}
.hw-all-item{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:10px;
  padding:6px 0;
  border-top:1px solid var(--border);
}
.hw-all-item:first-child{ border-top:0; }
.hw-all-item .hw-all-left{ min-width:0; flex:1; }
.hw-all-item .hw-all-title{ font-weight:800; }
.hw-all-item .hw-all-sub{ font-size:0.75rem; color:var(--text-sec); margin-top:2px; }
.hw-all-item .hw-all-actions{
  display:flex;
  flex-direction:column;
  gap:5px;
  align-items:flex-end;
  flex:0 0 auto;
}
.hw-mini-toggle{
  display:flex;
  align-items:center;
  gap:5px;
  font-size:0.85rem;
  color: var(--text);
  user-select:none;
}
.hw-mini-toggle input{ transform: scale(1.05); }
.hw-mini-stack{
  display:flex;
  flex-direction:column;
  align-items:flex-end;
  gap:4px;
}
.hw-mini-edit-btn{
  display:flex;
  align-items:center;
  gap:6px;
  padding:4px 10px;
  border-radius:10px;
  border:1px solid var(--border);
  background: var(--surface-2);
  color: var(--text);
  font-size:0.8rem;
  cursor:pointer;
}
.hw-mini-edit-btn i{ font-size:0.85rem; }
.hw-mini-edit-btn:active{ transform: scale(0.98); }
.hw-mini-edit-btn:disabled{ opacity:0.5; cursor:not-allowed; }

/* Homework confirmation colors */
.bulk-row.hw-all-confirmed{
  background: rgba(52,199,89,0.10);
}
body.dark-mode .bulk-row.hw-all-confirmed{
  background: rgba(50,215,75,0.16);
}
.hw-all-item.hw-confirmed{
  border-left: 4px solid var(--success);
  padding-left: 10px;
  background: rgba(52,199,89,0.06);
}
.hw-all-item.hw-pending{
  border-left: 4px solid var(--warning);
  padding-left: 10px;
  background: rgba(255,149,0,0.06);
}
body.dark-mode .hw-all-item.hw-confirmed{ background: rgba(50,215,75,0.10); }
body.dark-mode .hw-all-item.hw-pending{ background: rgba(255,214,10,0.10); }

.hw-ayah-range{
  font-weight: 900;
}
.hw-ayah-range.confirmed{ color: var(--success); }
.hw-ayah-range.pending{ color: var(--warning); }

/* Student homework cards: show confirmed vs pending with green/orange */
.student-hw-card.hw-confirmed{
  border-left: 4px solid var(--success);
  background: rgba(50,215,75,0.08);
}
.student-hw-card.hw-pending{
  border-left: 4px solid var(--warning);
  background: rgba(255,149,0,0.08);
}
body.dark-mode .student-hw-card.hw-confirmed{ background: rgba(50,215,75,0.10); }
body.dark-mode .student-hw-card.hw-pending{ background: rgba(255,214,10,0.10); }


/* Student homework tab: make cards more compact (about half height) */
#tab-student-homework .student-hw-card{
  padding: 6px 10px !important;
  margin-bottom: 4px !important;
  gap: 4px !important; /* compact vertical spacing between lines */
}
#tab-student-homework .student-hw-card .text-sm{
  line-height: 1.15;
}
#tab-student-homework .student-hw-card > *{ margin:0 !important; }
#tab-student-homework .student-hw-card .btn{
  margin-top: 0 !important;
  padding: 10px 12px;
  border-radius: 12px;
}
#tab-student-homework .stu-hw-actions{
  display: flex;
  gap: 8px;
  width: 100%;
  margin-top: 4px;
}

/* Student home: compact homework notification cards too */
#stu-home-hw-card .student-hw-card{
  padding: 6px 10px !important;
  margin-bottom: 4px !important;
  gap: 4px !important;
}
#stu-home-hw-card .student-hw-card .text-sm{ line-height: 1.15; }
#stu-home-hw-card .student-hw-card > *{ margin:0 !important; }
#stu-home-hw-card .student-hw-card .btn{ margin-top:0 !important; }

/* Student home: compact achievements progress card spacing */
#student-home-achievements .card.flex-col{
  gap: 4px !important;
}

/* Quick-assign (+) rows: per-student surah + ayah range + send */
.hw-qa-row{
  width:100%;
  max-width:100%;
  display:grid;
  grid-template-columns: 90px 80px 44px 44px 44px;
  gap:6px;
  align-items:center;
  padding:8px 0;
  border-top:1px solid var(--border);
  overflow:visible;
}
.hw-qa-row:first-child{ border-top:0; }


/* Aufgaben: quick-assign config (replaces filter + hint + search) */
.hw-admin-config{
  padding: 8px 10px;
  border: 1px solid var(--border);
  border-radius: 16px;
  background: rgba(0,0,0,0.02);
}
.hw-admin-type-seg{
  display:flex;
  gap:6px;
  align-items:center;
}
.hw-admin-type-seg .seg-btn{
  border: 1px solid var(--border);
  background: var(--card);
  color: var(--text);
  padding: 8px 10px;
  border-radius: 14px;
  font-size: 12px;
  line-height: 1;
  cursor: pointer;
  white-space: nowrap;
}
.hw-admin-type-seg .seg-btn.active{
  border-color: var(--primary);
  box-shadow: 0 0 0 2px rgba(0,122,255,0.15);
}
#hw-admin-text-global{
  width:100%;
}

/* When quick-assign text type is selected, make row compact */
.hw-qa-row.hw-qa-text .hw-qa-surah-wrap,
.hw-qa-row.hw-qa-text .hw-qa-start,
.hw-qa-row.hw-qa-text .hw-qa-end{
  display:none;
}

.hw-qa-row.hw-qa-text{
  grid-template-columns: 90px 1fr 44px;
}
.hw-qa-free{
  width:100%;
  min-width:0;
}

.hw-qa-name{ width:90px; min-width:0; overflow:hidden; }
.hw-qa-name .bulk-name{
  font-weight:900;
  display:-webkit-box;
  -webkit-line-clamp:2;
  -webkit-box-orient:vertical;
  overflow:hidden;
  white-space:normal;
  line-height:1.15;
}

.hw-qa-surah-wrap{ position:relative; min-width:0; }
.hw-qa-surah{ width:100%; }
.hw-qa-dd{
  position:absolute;
  left:0;
  right:0;
  top:100%;
  z-index:50;
}

.hw-qa-start, .hw-qa-end{ width:100%; }
.hw-qa-start, .hw-qa-end{ text-align:center; padding:8px 6px; font-variant-numeric: tabular-nums; }

.hw-qa-send{
  width:44px;
  height:44px;
  border-radius:14px;
  display:flex;
  align-items:center;
  justify-content:center;
  border:1px solid var(--border);
}

.hw-qa-status{
  grid-column: 1 / -1;
  margin-top:-2px;
}

.hw-qa-ok{
  background: rgba(52,199,89,0.08);
  border-left: 4px solid var(--success);
  padding-left:10px;
}
.hw-qa-fail{
  background: rgba(255,149,0,0.08);
  border-left: 4px solid var(--warning);
  padding-left:10px;
}

/* Small screens: keep everything داخل الشاشة (wrap to 2 rows) */
@media (max-width: 380px){
  .hw-qa-row{
    grid-template-columns: 90px 1fr 44px;
    grid-template-rows: auto auto;
    gap:6px;
  }
  .hw-qa-name{ grid-column:1; grid-row:1 / span 2; }
  .hw-qa-surah-wrap{ grid-column:2; grid-row:1; }
  .hw-qa-send{ grid-column:3; grid-row:1; }
  .hw-qa-start{ grid-column:2; grid-row:2; width:44px; justify-self:end; }
  .hw-qa-end{ grid-column:3; grid-row:2; width:44px; }
  .hw-qa-status{ grid-column: 1 / -1; }

  /* Text mode layout on small screens */
  .hw-qa-row.hw-qa-text{
    grid-template-columns: 90px 1fr 44px;
    grid-template-rows: auto auto;
  }
  .hw-qa-row.hw-qa-text .hw-qa-name{ grid-column:1; grid-row:1; }
  .hw-qa-row.hw-qa-text .hw-qa-free{ grid-column:2; grid-row:1; }
  .hw-qa-row.hw-qa-text .hw-qa-send{ grid-column:3; grid-row:1; }
  .hw-qa-row.hw-qa-text .hw-qa-status{ grid-column:1 / -1; grid-row:2; }
}


.hw-expand-btn{
  border:0;
  background:transparent;
  color: var(--text);
  font-weight:900;
  font-size:1rem;
  padding:6px 8px;
  border-radius:10px;
}
.hw-expand-btn:active{ transform: scale(0.98); }


/* Shared filter summary for Aufgaben (uses same filter as Schüler) */
.hw-filter-summary{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  width:100%;
  margin-top:6px;
}
.hw-filter-summary .btn{
  width:auto;
  padding:8px 10px;
  white-space:nowrap;
}

/* Homework admin header alignment */
#tab-homework-admin .p-4{ padding-top:12px; }
.hw-admin-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin:0 0 10px 0;
}

#hw-admin-add-toggle.active{
  background: var(--surface-2);
}

#hw-admin-manage-toggle.active{
  background: var(--surface-2);
}
.hw-adm-cb{
  width:18px;
  height:18px;
  flex:0 0 auto;
}
#btn-hw-back-assign{ padding:6px 8px; font-size:0.82rem; white-space:nowrap; }
#btn-hw-back-assign .back-ico{ font-size:0.9em; }

.hw-admin-header h3{ margin:0 !important; font-size:16px; }
#tab-homework-admin h4{ font-size:14px; }
#tab-homework-admin .section-title{ font-size:14px; }
#tab-homework-admin .hw-filter-summary{ margin:0 0 5px 0; }

/* ---- Koran Tab Reader ---- */
@font-face{
  font-family: "KFGQPC Uthmanic Hafs";
  src: url("https://cdn.jsdelivr.net/npm/kfgqpc-uthmanic-script-hafs-regular@1.0.0/arabic.otf") format("opentype");
  font-display: swap;
}

:root{
  --koran-font: "KFGQPC Uthmanic Hafs", "Amiri Quran", "Scheherazade New", "Noto Naskh Arabic", serif;
  --koran-audio-h: 138px;
  --koran-bottom-offset: 0px; /* updated by JS based on bottom-nav height */

  /* iOS-like premium player theme (Light) */
  --koran-player-bg: rgba(250, 250, 252, .94);          /* moon white */
  --koran-player-border: rgba(60, 60, 67, .18);         /* iOS separator */
  --koran-player-border-soft: rgba(60, 60, 67, .14);
  --koran-player-shadow: 0 -10px 28px rgba(0,0,0,.18);

  --koran-player-text: rgba(0,0,0,.92);
  --koran-player-muted: rgba(60, 60, 67, .72);

  --koran-player-surface: rgba(60, 60, 67, .10);
  --koran-player-surface2: rgba(60, 60, 67, .08);

  --koran-player-btn-bg: rgba(60, 60, 67, .08);
  --koran-player-btn-border: rgba(60, 60, 67, .16);

  --koran-player-accent: var(--primary); /* iOS blue */
}

/* Dark mode overrides for the Koran player */
.dark-mode{
  --koran-player-bg: rgba(28, 28, 30, .94);             /* iOS dark gray */
  --koran-player-border: rgba(255,255,255,.12);
  --koran-player-border-soft: rgba(255,255,255,.16);
  --koran-player-shadow: 0 -10px 28px rgba(0,0,0,.46);

  --koran-player-text: rgba(255,255,255,.92);
  --koran-player-muted: rgba(235,235,245,.60);

  --koran-player-surface: rgba(235,235,245,.12);
  --koran-player-surface2: rgba(235,235,245,.08);

  --koran-player-btn-bg: rgba(235,235,245,.10);
  --koran-player-btn-border: rgba(255,255,255,.16);

  --koran-player-accent: var(--primary);
}


body.koran-mode header.app-header{
  display:none !important;
}

body.koran-mode #floating-audio-player{
  display:none !important;
}

body.koran-mode main#tab-student-memorize{
  padding:0 !important;
}

body.koran-mode{
  background: var(--bg);
  color: var(--text);
}

.koran-tab{
  background: var(--bg);
  color: var(--text);
}

.koran-reader{
  position: relative;
  height: calc(100vh - var(--koran-bottom-offset, 0px));
  background: var(--bg);
  color: var(--text);
  overflow:hidden;
}

.koran-page-wrap{
  position:absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: calc(var(--koran-audio-h) + env(safe-area-inset-bottom, 0px));
  display:flex;
  align-items:center;
  justify-content:center;
  padding: 10px;
}

.koran-page-img{
  max-width: 100%;
  max-height: 100%;
  width: auto;
  height: auto;
  border-radius: 14px;
  background:#fff;
  box-shadow: 0 10px 30px rgba(0,0,0,.45);
  user-select: none;
  -webkit-user-drag: none;
}

/* Text-based page rendering (no PNG) */
.koran-page-text{
  max-width: 100%;
  max-height: 100%;
  width: min(940px, 100%);
  height: 100%;
  border-radius: 14px;
  background: #f8f5ee;
  color: #111;
  box-shadow: 0 10px 30px rgba(0,0,0,.45);
  overflow: auto;
  padding: 18px 18px 26px 18px;
  font-family: var(--koran-font);
  font-size: clamp(22px, 4.6vw, 34px);
  line-height: 2.05;
  text-align: justify;
  text-justify: inter-word;
  direction: rtl;
}

.koran-page-text .ayah{
  display: inline;
  cursor: pointer;
  border-radius: 8px;
  padding: 1px 2px;
}

.koran-page-text .ayah:hover{
  background: rgba(0,0,0,.06);
}

.koran-page-text .ayah.active{
  background: rgba(10,132,255,.16);
  outline: 1px solid rgba(10,132,255,.22);
}

.koran-page-text .ayah-num{
  font-size: .78em;
  opacity: .88;
  margin: 0 2px 0 0;
  white-space: nowrap;
}

.koran-page-loading{
  position:absolute;
  inset: 0;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index: 5;
  pointer-events:none;
}

.koran-page-loading .pill{
  padding: 10px 12px;
  padding-bottom: calc(10px + env(safe-area-inset-bottom, 0px));
  border-radius: 999px;
  background: rgba(0,0,0,.42);
  border: 1px solid rgba(255,255,255,.12);
  color:#fff;
  font-weight: 800;
  font-size: .92rem;
}

/* Audio bar: 2 rows */
.koran-audio-bar{
  flex-direction: column;
  align-items: stretch;
  justify-content: center;
}

.koran-audio-top{
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 10px;
}

.koran-audio-bottom{
  margin-top: 8px;
  display:flex;
  flex-direction: column;
  gap: 8px;
}

.koran-seek{
  width: 100%;
}

.koran-seek-row{
  display:flex;
  align-items:center;
  gap: 10px;
}

.koran-time{
  font-size: .82rem;
  opacity: .78;
  white-space: nowrap;
}

.koran-opts{
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 10px;
}

.koran-opts .mini{
  height: 34px;
  padding: 0 10px;
  border-radius: 12px;
  background: rgba(255,255,255,.08);
  border: 1px solid rgba(255,255,255,.10);
  color: #fff;
  display:flex;
  align-items:center;
  gap: 8px;
  font-weight: 800;
  font-size: .86rem;
}

.koran-opts .mini.active{
  background: rgba(10,132,255,.22);
  border-color: rgba(10,132,255,.30);
}

.koran-speed{
  display:flex;
  align-items:center;
  gap: 8px;
}

#koranSpeedSel{ height: 36px; border-radius: 14px; }

@media (max-width: 420px){
  :root{ --koran-audio-h: 148px; }
  .koran-page-text{ padding: 16px 14px 22px 14px; }
}

.koran-nav{
  position:absolute;
  top: 50%;
  transform: translateY(-50%);
  width: 44px;
  height: 44px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(0,0,0,.38);
  color:#fff;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  z-index: 3;
}

.koran-nav:active{
  transform: translateY(-50%) scale(.98);
}

.koran-prev{ right: 14px; }
.koran-next{ left: 14px; }

.koran-page-indicator{
  position:absolute;
  top: 12px;
  left: 12px;
  z-index: 4;
  padding: 8px 10px;
  border-radius: 999px;
  background: rgba(0,0,0,.42);
  border: 1px solid rgba(255,255,255,.12);
  font-weight: 800;
  font-size: .92rem;
}

.koran-page-indicator .sep{
  opacity: .65;
  margin: 0 6px;
}

.koran-audio-bar{
  position: fixed;
  left: 0;
  right: 0;
  bottom: calc(var(--koran-bottom-offset, 0px));
  height: auto;
  padding: 10px 12px;
  padding-bottom: calc(12px + env(safe-area-inset-bottom, 0px));
  background: var(--koran-player-bg);
  border-top: 1px solid var(--koran-player-border);
  border-top-left-radius: 22px;
  border-top-right-radius: 22px;
  box-shadow: var(--koran-player-shadow);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  display:flex;
  flex-direction: column;
  align-items: stretch;
  justify-content: center;
  gap: 10px;
  z-index: 50;
  color: var(--koran-player-text);
}
/* Koran custom audio UI (clean like the white player screenshot) */
.sr-only{
  position:absolute !important;
  width:1px; height:1px;
  padding:0; margin:-1px;
  overflow:hidden; clip:rect(0,0,0,0);
  white-space:nowrap; border:0;
}

.koran-audio-custom #koranAudio{ display:none; }

.koran-seek-row{
  display:flex;
  align-items:center;
  gap: 10px;
  padding: 8px 10px;
  border-radius: 18px;
  background: var(--koran-player-surface);
  border: 1px solid var(--koran-player-border-soft);
}

.koran-seek{
  flex: 1;
  height: 4px;
  accent-color: var(--koran-player-accent);
}

.koran-mute-btn{
  width: 40px;
  height: 40px;
  border-radius: 14px;
  background: var(--koran-player-btn-bg);
  border: 1px solid var(--koran-player-btn-border);
  color: var(--koran-player-text);
}

.koran-audio-row{
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 10px;
  flex-wrap: wrap;
}

.koran-mini .text-sm{ display:none; } /* hide "Repeat/Speed" labels to match minimal design */
.koran-mini-select{
  border-radius: 16px !important;
  height: 40px;
  background: var(--koran-player-surface);
  border: 1px solid var(--koran-player-border-soft);
}

.koran-play-pill{
  width: 54px;
  height: 54px;
  border-radius: 999px;
  background: var(--koran-player-accent);
  color: #fff;
  border: none;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size: 1.1rem;
  box-shadow: 0 10px 24px rgba(0,0,0,.18);
}

#koranAudioPrev, #koranAudioNext, #koranAudioStop{
  border-radius: 18px;
  background: var(--koran-player-surface);
  border: 1px solid var(--koran-player-border-soft);
  color: var(--koran-player-text);
  padding: 10px 14px;
}

.koran-mini-check{
  background: var(--koran-player-surface);
  border: 1px solid var(--koran-player-border-soft);
  border-radius: 18px;
  padding: 8px 10px;
}

.koran-audio-bar{
  max-height: 34vh; /* never eats half the screen */
}


/* Compact audio dock: start collapsed so it doesn't take half the screen */
.koran-audio-bar{ max-height: 42vh; overflow-y: auto; }
.koran-audio-bar.collapsed{
  padding: 10px 12px calc(10px + env(safe-area-inset-bottom, 0px));
  gap: 10px;
}

/* In collapsed mode show ONLY the 4 main buttons (prev / play / next / stop) */
.koran-audio-bar.collapsed .koran-audio-head{ display:none; }
.koran-audio-bar.collapsed .koran-audio-left{ display:none; }
.koran-audio-bar.collapsed .koran-seek-row{ display:none; }

.koran-audio-bar.collapsed .koran-audio-right{
  width: 100%;
  display:flex;
  align-items:center;
  justify-content:center;
  gap: 10px;
}
.koran-audio-right .audio-btn{
  min-width: 48px;
  height: 48px;
  padding: 0;
  border-radius: 16px;
  display:flex;
  align-items:center;
  justify-content:center;
  gap: 0;
}
.koran-audio-right .audio-btn i{ font-size: 1.05rem; }
.koran-audio-right .koran-play-pill{
  min-width: 56px;
  height: 48px;
}


.koran-audio-bar.collapsed .koran-audio-right .audio-btn{
  width: 48px;
  height: 48px;
  padding: 0;
  border-radius: 16px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size: 1.05rem;
}

.koran-audio-bar.collapsed .koran-audio-right .koran-play-pill{
  width: 56px;
  height: 48px;
}

.koran-audio-head-center{ cursor: pointer; }

.koran-audio-head{
  display:flex;
  align-items:center;
  gap: 10px;
}

.koran-audio-head-center{
  flex: 1;
  min-width: 0;
  text-align: center;
}

.koran-audio-title{
  color: var(--koran-player-accent);
  font-weight: 900;
  font-size: 1.08rem;
  line-height: 1.1;
  margin: 0;
}

.koran-audio-sub{
  font-size: .86rem;
  color: var(--koran-player-muted);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 76vw;
  margin: 2px auto 0 auto;
}

.koran-audio-close,
.koran-audio-bookmark,
.koran-audio-toggle{
  width: 40px;
  height: 40px;
  border-radius: 14px;
  background: var(--koran-player-btn-bg);
  color: var(--koran-player-muted);
}

.koran-audio-close:active,
.koran-audio-bookmark:active{
  background: var(--koran-player-surface);
}

.koran-audio-native{
  border-radius: 18px;
  overflow: hidden;
  background: var(--koran-player-surface2);
  padding: 6px 8px;
  border: 1px solid var(--koran-player-border-soft);
}

.koran-audio-native audio{
  width: 100%;
  border-radius: 14px;
}

.koran-audio-row{
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 10px;
  flex-wrap: wrap;
}

.koran-audio-left{
  display:flex;
  align-items:center;
  gap: 10px;
  flex-wrap: wrap;
}

.koran-mini{
  display:flex;
  align-items:center;
  gap: 6px;
}

.koran-mini .text-sm{
  color: var(--koran-player-muted);
  font-weight: 800;
}

.koran-mini-select{
  height: 36px;
  border-radius: 14px;
}

.koran-audio-right{
  display:flex;
  gap: 8px;
  flex-wrap: wrap;
  align-items:center;
}

.koran-audio-right .audio-btn{
  padding: 10px 12px;
  border-radius: 16px;
  font-weight: 800;
}

.koran-audio-right .audio-btn.sec{
  background: var(--koran-player-btn-bg);
  color: var(--koran-player-text);
}

.koran-audio-fab{
  position: fixed;
  left: 16px;
  right: auto;
  bottom: calc(var(--koran-bottom-offset, 0px) + 16px + env(safe-area-inset-bottom,0px));
  width: 56px;
  height: 56px;
  border-radius: 18px;
  border: 1px solid rgba(255,255,255,.18);
  background: var(--koran-player-accent);
  color: #fff;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index: 51;
  box-shadow: 0 14px 40px rgba(0,0,0,.30);
  cursor:pointer;
}

.koran-audio-fab:active{
  transform: scale(.98);
  opacity: .92;
}

@media (max-width: 420px){
  .koran-audio-right .audio-btn{ padding: 10px 10px; }
}


.koran-audio-meta{
  min-width: 0;
  display:flex;
  flex-direction: column;
  gap: 3px;
}

.koran-audio-title{
  font-weight: 900;
  letter-spacing: .2px;
}

.koran-audio-info{
  opacity: .78;
  font-size: .86rem;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 52vw;
}

.koran-audio-actions{
  display:flex;
  align-items:center;
  gap: 6px;
}

.koran-audio-actions .icon-btn{
  width: 38px;
  height: 38px;
  border-radius: 12px;
  background: rgba(255,255,255,.08);
  border: 1px solid rgba(255,255,255,.10);
  color: #fff;
}

.koran-audio-actions .icon-btn:active{
  transform: scale(.98);
}

#koranAudio{
  display:block;
  width:100%;
  margin-top: 8px;
}

.koran-fab{
  position: fixed;
  right: 14px;
  bottom: calc(var(--koran-bottom-offset, 0px) + var(--koran-audio-h) + 12px + env(safe-area-inset-bottom, 0px));
  width: 54px;
  height: 54px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.10);
  color:#fff;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  z-index: 60;
  box-shadow: 0 14px 30px rgba(0,0,0,.35);
}

.koran-fab i{ font-size: 1.2rem; }

.koran-drawer-overlay{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.55);
  z-index: 80;
}

.koran-drawer{
  position: fixed;
  top: 0;
  right: 0;
  height: 100vh;
  width: min(92vw, 360px);
  background: var(--surface);
  color: var(--text);
  border-left: 1px solid var(--border);
  z-index: 90;
  display:flex;
  flex-direction: column;
  transform: translateX(0);
}

.koran-drawer-head{
  display:flex;
  align-items:center;
  justify-content: space-between;
  padding: 14px 14px 10px 14px;
  border-bottom: 1px solid rgba(255,255,255,.08);
}

.koran-drawer-title{
  font-family: var(--koran-font);
  font-size: 1.2rem;
  font-weight: 900;
}

.koran-drawer-body{
  padding: 12px 14px 16px 14px;
  overflow:auto;
}

.koran-section-title{
  font-family: var(--koran-font);
  font-weight: 900;
  opacity: .9;
  margin-bottom: 8px;
}

.koran-jump-row{
  display:flex;
  gap: 8px;
  align-items:center;
}

.koran-jump-row .form-input{
  flex: 1;
  min-width: 0;
}

.koran-list{
  display:flex;
  flex-direction: column;
  gap: 8px;
}

.koran-item{
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 10px;
  padding: 10px 12px;
  padding-bottom: calc(10px + env(safe-area-inset-bottom, 0px));
  border-radius: 14px;
  border: 1px solid var(--border);
  background: var(--surface-2);
  cursor:pointer;
}

.koran-item:active{ transform: scale(.99); }

.koran-item .name{
  color: var(--text);
  font-family: var(--koran-font);
  font-size: 1.05rem;
  line-height: 1.35;
}

.koran-item .meta{
  color: var(--text-sec);
  font-size: .86rem;
  white-space: nowrap;
}

.koran-item .del{
  width: 32px;
  height: 32px;
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.06);
  color:#fff;
}

@media (max-width: 420px){
  .koran-audio-info{ max-width: 45vw; }
}


/* ===== Floating Audio (FAB + expandable sheet) ===== */
.floating-audio-player{
  position: fixed;
  right: 16px;
  bottom: 16px;
  top: auto;
  left: auto;
  width: auto;
  padding: 0;
  background: transparent;
  border: none;
  box-shadow: none;
  transform: none !important;
  z-index: 2147483647;
  display: none;
}
.floating-audio-player.show{ display:block; }

.audio-fab-btn{
  width: 56px;
  height: 56px;
  border-radius: 999px;
  border: none;
  background: var(--koran-player-accent);
  color: white;
  box-shadow: 0 10px 26px rgba(0,0,0,0.25);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.2rem;
}
.audio-fab-btn:active{ transform: scale(0.97); }

.floating-audio-panel{
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;
  background: var(--surface);
  border-top: 1px solid var(--border);
  border-radius: 18px 18px 0 0;
  padding: 12px 14px 18px;
  box-shadow: 0 -12px 28px rgba(0,0,0,0.25);
  transform: translateY(110%);
  transition: transform 220ms ease;
  max-height: 58vh;
  overflow: auto;
}
.floating-audio-player.expanded .floating-audio-panel{ transform: translateY(0); }
/* --- MEMORIZE MODAL: keep the player visible while the memorization window is open --- */
/* --- MEMORIZE MODAL: show the player as a FLOATING card فوق نافذة الحفظ --- */
body.lesson-memo-open #floating-audio-player{
  display:block !important;
  z-index: 2147483647 !important;

  /* floating above the memorization modal */
  left: 50% !important;
  right: auto !important;
  top: auto !important;
  bottom: calc(16px + env(safe-area-inset-bottom, 0px)) !important;
  transform: translateX(-50%) !important;

  width: min(560px, calc(100vw - 24px)) !important;
  background: transparent !important;
  border: none !important;
  box-shadow: none !important;
  padding: 0 !important;
}
body.lesson-memo-open #floating-audio-player .audio-fab-btn{ display:none !important; }
body.lesson-memo-open #floating-audio-player .floating-audio-close{ display:none !important; }

/* panel becomes a card (not a bottom-sheet) */
body.lesson-memo-open #floating-audio-player .floating-audio-panel{
  position: relative !important;
  left: auto !important;
  right: auto !important;
  bottom: auto !important;

  transform: none !important;
  border-radius: 18px !important;
  border: 1px solid var(--border) !important;
  box-shadow: 0 12px 28px rgba(0,0,0,0.28) !important;

  max-height: 42vh;
  overflow: auto;
  padding-bottom: 14px;
}

body.lesson-memo-open #lesson-modal .modal-content{
  /* keep space so the floating player doesn't cover the last ayat */
  padding-bottom: calc(170px + env(safe-area-inset-bottom, 0px)) !important;
}

/* Ensure the floating player stays ABOVE the memorization modal */
body.lesson-memo-open #lesson-modal.modal-overlay{ z-index: 2000 !important; }
body.lesson-memo-open #floating-audio-player{ z-index: 2147483647 !important; }


.floating-audio-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.floating-audio-title{ font-weight:700; font-size:0.95rem; }
.floating-audio-close{
  background: transparent;
  border: none;
  padding: 8px 10px;
  color: var(--text-sec);
  border-radius: 12px;
}
.floating-audio-close:active{ background: var(--surface-2); }

.floating-audio-seek{ width:100%; margin-top: 10px; }

.icon-btn{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:6px;
  padding: 10px 12px;
  padding-bottom: calc(10px + env(safe-area-inset-bottom, 0px));
  border-radius: 12px;
  border: 1px solid var(--border);
  background: var(--surface-2);
  color: var(--text);
}
.icon-btn i{ font-size: 0.95rem; }
.koran-jump-row .icon-btn{ padding: 10px 12px; }


/* ===== KORAN FULLSCREEN + QURAN.COM-LIKE PLAYER (v22) ===== */
body.koran-mode{
height: 100dvh;
  overflow: hidden !important;
  background: var(--bg);
}
body.koran-mode nav.bottom-nav{
  display:none !important;
}
body.koran-mode main#tab-student-memorize.koran-tab{
  position: fixed !important;
  inset: 0 !important;
  width: 100vw !important;
  height: 100dvh !important;
  padding: 0 !important;
  margin: 0 !important;
  z-index: 9999 !important;
  background: var(--bg);
}

body.koran-mode #koran-reader.koran-reader{
  height: 100dvh !important;
}

body.koran-mode #koran-page-wrap.koran-page-wrap{
  /* keep mushaf centered and leave space for the mini player */
  height: 100dvh !important;
  padding-bottom: calc(var(--koran-audio-h, 0px) + 6px) !important;
  padding-top: env(safe-area-inset-top, 0px) !important;
  box-sizing: border-box !important;
}

#koranPageText.koran-page-text{
  text-align: center !important;
  margin: 0 auto !important;
  max-width: min(920px, 96vw) !important;
}

/* Center each ayah bubble/line better */
#koranPageText.koran-page-text .ayah{
  text-align: center !important;
}

/* Player bar: iOS-like premium sheet (Light/Dark via vars) */
#koranAudioBar.koran-audio-bar{
  left: 0 !important;
  right: 0 !important;
  bottom: 0 !important;

  /* iOS sheet feel */
  background: var(--koran-player-bg) !important;
  border-top: 1px solid var(--koran-player-border) !important;
  box-shadow: var(--koran-player-shadow) !important;
  backdrop-filter: blur(14px) saturate(140%) !important;
  -webkit-backdrop-filter: blur(14px) saturate(140%) !important;

  color: var(--koran-player-text) !important;
  border-top-left-radius: 22px !important;
  border-top-right-radius: 22px !important;

  padding: 10px 12px !important;
  padding-bottom: calc(10px + env(safe-area-inset-bottom, 0px)) !important;
}

/* Collapse = only the icon row (+ optional slim progress) */
#koranAudioBar.koran-audio-bar.collapsed .koran-audio-head{ display:none !important; }
#koranAudioBar.koran-audio-bar.collapsed .koran-audio-left{ display:none !important; }
#koranAudioBar.koran-audio-bar.collapsed .koran-audio-row{ margin-top: 0 !important; }
#koranAudioBar.koran-audio-bar.collapsed .koran-audio-custom{
  display:block !important;
  margin: 0 6px 6px 6px !important;
}
#koranAudioBar.koran-audio-bar.collapsed .koran-seek-row{
  padding: 0 !important;
  gap: 10px !important;
  background: transparent !important;
  border: 0 !important;
}
#koranAudioBar.koran-audio-bar.collapsed .koran-time,
#koranAudioBar.koran-audio-bar.collapsed .koran-mute-btn{ display:none !important; }
#koranAudioBar.koran-audio-bar.collapsed input.koran-seek{
  height: 3px !important;
  opacity: .95 !important;
}
#koranAudioBar.koran-audio-bar.collapsed{
  padding-top: 8px !important;
  padding-bottom: calc(8px + env(safe-area-inset-bottom, 0px)) !important;
}

/* Controls row: compact iOS-style circular buttons */
#koranAudioBar .koran-audio-right{
  width: 100% !important;
  display:flex !important;
  justify-content: center !important;
  gap: 16px !important;
}

#koranAudioBar .audio-btn{
  width: 44px !important;
  height: 44px !important;
  border-radius: 999px !important;
  background: var(--koran-player-btn-bg) !important;
  border: 1px solid var(--koran-player-btn-border) !important;
  color: var(--koran-player-text) !important;
}
#koranAudioBar .audio-btn.sec{
  background: var(--koran-player-btn-bg) !important;
  border: 1px solid var(--koran-player-btn-border) !important;
  color: var(--koran-player-text) !important;
  opacity: .96 !important;
}
#koranAudioBar .koran-play-pill{
  width: 52px !important;
  height: 52px !important;
  border-radius: 999px !important;
  background: var(--koran-player-accent) !important;
  border: 0 !important;
  box-shadow: 0 12px 26px rgba(0,0,0,.20) !important;
}

/* Expanded view: keep it from getting huge */
#koranAudioBar:not(.collapsed){
  max-height: 38vh !important;
  overflow: hidden !important;
}


/* iOS-like micro feedback */
@keyframes qsHapticPulse{
  0%{ transform: scale(1); }
  50%{ transform: scale(.96); }
  100%{ transform: scale(1); }
}
.koran-haptic{
  animation: qsHapticPulse 120ms ease-out;
}

/* Smooth drag on the Koran audio bar */
#koranAudioBar.koran-audio-bar{
  transition: transform 220ms ease;
  will-change: transform;
}
#koranAudioBar.koran-audio-bar.qs-dragging{
  transition: none !important;
}


/* ===== Messages tab fixes: allow scrolling + long message scroll ===== */
#tab-comm{ touch-action: pan-y; }
#tab-comm *{ -webkit-tap-highlight-color: transparent; }
#messages-list{ touch-action: pan-y; }
.msg-open{
  max-height: 62vh;
  overflow: auto;
  -webkit-overflow-scrolling: touch;
}

/* --- Koran: hide page number indicator + side nav buttons (swipe only) --- */
#koranPrevPage, #koranNextPage{ display:none !important; }
.koran-page-indicator{ display:none !important; }


/* --- Page flip effect (RTL-friendly) --- */
.koran-page-wrap{
  position: relative;
  perspective: 1200px;
  transform-style: preserve-3d;
  will-change: transform, opacity;
}
.koran-page-wrap.koran-flip-leave{
  animation: koranFlipLeave 180ms ease-out forwards;
}
.koran-page-wrap.koran-flip-enter{
  animation: koranFlipEnter 260ms ease-out forwards;
}
@keyframes koranFlipLeave{
  from{ transform: rotateY(0deg) translateX(0); opacity: 1; }
  to  { transform: rotateY(calc(var(--flip-dir, -1) * 22deg)) translateX(calc(var(--flip-dir, -1) * -10px)); opacity: .35; }
}
@keyframes koranFlipEnter{
  from{ transform: rotateY(calc(var(--flip-dir, -1) * -18deg)) translateX(calc(var(--flip-dir, -1) * 12px)); opacity: .35; }
  to  { transform: rotateY(0deg) translateX(0); opacity: 1; }
}


/* Parent homework seen status (Teacher icon) */
/* Parent homework seen status (Teacher icon) */
.hw-parent-icon{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  width:22px;
  height:22px;
  border-radius:999px;
  margin-inline-end:6px;
  border:1px solid transparent;
  flex: 0 0 auto;
  background: transparent;
}
.hw-parent-icon i{ font-size:0.9em; }
.hw-parent-icon.is-green{
  background: rgba(34,197,94,0.12);
  border-color: rgba(34,197,94,0.35);
  color: var(--success);
}
.hw-parent-icon.is-red{
  background: rgba(255,59,48,0.12);
  border-color: rgba(255,59,48,0.35);
  color: var(--danger);
}
.hw-parent-icon.is-none{
  background: rgba(142,142,147,0.12);
  border-color: rgba(142,142,147,0.35);
  color: var(--text-sec);
}

/* Student/Parent "seen" panel */
#stu-hw-parentseen-panel .btn{ white-space:nowrap; }


/* === Admin branches (Benutzer/Warteliste/Gruppen) === */
.segmented-tabs{
  display:flex;
  gap:8px;
  background: var(--bg);
  padding: 6px;
  border-radius: 14px;
  border: 1px solid var(--border);
  margin-top: 10px;
}
.segmented-btn{
  flex:1;
  padding: 10px 12px;
  border:none;
  border-radius: 12px;
  background: transparent;
  color: var(--text-sec);
  font-family: inherit;
  font-weight: 700;
  cursor: pointer;
  display:flex;
  gap:8px;
  align-items:center;
  justify-content:center;
}
.segmented-btn.active{
  background: var(--surface);
  color: var(--text);
  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
}
.admin-section{ margin-top: 12px; }
.group-card{
  border-radius: 14px;
  padding: 14px;
  background: var(--surface);
  border: 1px solid var(--border);
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  cursor: pointer;
  transition: transform 0.08s ease;
}
.group-card.full{
  border-color: rgba(255,59,48,0.25);
  background: rgba(255,59,48,0.12);
}
.group-card.ok{
  border-color: rgba(52,199,89,0.25);
  background: rgba(52,199,89,0.12);
}

.group-card:active{
  transform: scale(0.99);
}
.group-card-title{
  font-weight: 800;
  font-size: 1rem;
}
.group-card-meta{
  margin-top: 8px;
  color: var(--text-sec);
  font-size: 0.85rem;
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  align-items:center;
}

.group-card-extra{
  margin-top: 4px;
  color: var(--text-sec);
  font-size: 0.85rem;
  display:flex;
  flex-direction:column;
  gap:4px;
}
.group-card-extra .line{
  display:flex;
  align-items:center;
  gap:8px;
}
.group-card-extra .line i{
  opacity: .9;
}
.badge-pill{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding: 4px 10px;
  border-radius: 999px;
  font-size: 0.75rem;
  font-weight: 800;
  background: var(--surface);
  border: 1px solid var(--border);
}



.group-det-badges{
  margin-top:10px;
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  align-items:center;
}
.group-info-rows{
  margin-top:12px;
  display:flex;
  flex-direction:column;
  gap:10px;
}
.group-info-row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:10px 12px;
  border:1px solid var(--border);
  border-radius:12px;
  background: var(--surface);
}
.group-info-row .k{
  font-weight:800;
  font-size:0.85rem;
}
.group-info-row .v{
  font-size:0.9rem;
  color: var(--text-sec);
  text-align:right;
}
.group-edit-grid{
  margin-top:10px;
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:10px;
}
@media (max-width: 520px){
  .group-edit-grid{ grid-template-columns: 1fr; }
}
.group-student-row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:10px 12px;
  border:1px solid var(--border);
  border-radius:12px;
  background: var(--surface);
  margin-top:8px;
  cursor:pointer;
}
.group-student-row .name{
  font-weight:800;
}
.group-student-row .sub{
  font-size:0.8rem;
  color: var(--text-sec);
}


/* =========================
   NEW UI SKIN (Chrome-like)
   ========================= */
body{
  background:
    radial-gradient(1200px 600px at 10% -10%, rgba(26,115,232,.16), transparent 60%),
    radial-gradient(900px 500px at 95% 0%, rgba(124,58,237,.14), transparent 55%),
    radial-gradient(900px 500px at 20% 110%, rgba(249,115,22,.12), transparent 55%),
    var(--bg);
}

header{
  position: sticky;
  top: 0;
  z-index: 200;
  background: rgba(255,255,255,.82);
  backdrop-filter: blur(14px);
  border-bottom: 0;
  box-shadow: var(--shadow-sm);
  padding: 12px 14px;
}

.icon-btn{
  border-radius: 14px;
  box-shadow: 0 1px 0 rgba(0,0,0,.05) inset;
}

.icon-btn:active{
  transform: translateY(1px) scale(.98);
}

.card{
  border: 1px solid rgba(32,33,36,.08);
  box-shadow: 0 1px 0 rgba(0,0,0,.03);
}

#filter-panel{
  background: rgba(255,255,255,.9);
  backdrop-filter: blur(12px);
}

#filter-panel.open{
  max-height: 520px;
}

.filter-topbar{
  display:flex;
  align-items:flex-end;
  gap:10px;
  flex-wrap: wrap;
}

.filter-field{
  display:flex;
  flex-direction:column;
  gap:6px;
  min-width: 160px;
  flex: 1 1 160px;
}

.filter-label{
  font-size: .78rem;
  color: var(--text-sec);
  font-weight: 700;
  letter-spacing: .2px;
}

.filter-select{
  width:100%;
  padding: 10px 12px;
  border-radius: 14px;
  border: 1px solid rgba(32,33,36,.14);
  background: linear-gradient(180deg, #fff, #fafbff);
  color: var(--text);
  font-weight: 700;
  outline: none;
}

.filter-select:focus{
  border-color: rgba(26,115,232,.6);
  box-shadow: 0 0 0 4px rgba(26,115,232,.14);
}

.filter-search-btn{
  height: 44px;
  width: 44px;
  border-radius: 14px;
  background: linear-gradient(180deg, rgba(26,115,232,.12), rgba(26,115,232,.06));
  color: var(--primary);
}

.filter-done-btn{
  height: 44px;
  padding: 0 14px;
  border-radius: 999px;
  border: 0;
  background: linear-gradient(135deg, var(--kid-2), var(--kid-1));
  color: #fff;
  font-weight: 900;
  cursor: pointer;
  box-shadow: var(--shadow-sm);
}

.filter-done-btn:active{
  transform: translateY(1px) scale(.99);
}

.search-bar{
  border: 1px solid rgba(32,33,36,.12);
  background: rgba(255,255,255,.9);
  border-radius: 14px;
}

.search-bar:focus{
  outline: none;
  border-color: rgba(26,115,232,.55);
  box-shadow: 0 0 0 4px rgba(26,115,232,.14);
}

/* Hide old chips visually if any remain (safety) */
.chips-container{ display:none !important; }

/* Desktop layout: turn bottom nav into Chrome-like sidebar */
@media (min-width: 900px){
  body{ overflow:hidden; }
  .bottom-nav{
    top: 72px;
    bottom: 14px;
    left: 14px;
    right: auto;
    width: 92px;
    height: auto;
    border-radius: 22px;
    box-shadow: var(--shadow);
    padding: 10px 6px;
    display:flex;
    flex-direction: column;
    gap: 8px;
  }
  main{
    padding-left: 120px;
    padding-bottom: 16px;
  }
  header{
    padding-left: 124px;
  }
  #filter-panel .p-4{
    padding-left: 124px;
  }
  .nav-item{
    border-radius: 18px;
    padding: 10px 6px;
  }
  .nav-item.active{
    background: rgba(26,115,232,.12);
    border: 1px solid rgba(26,115,232,.18);
  }
}


</style>
<style id="qc-audio-css">
/* Quran.com-inspired minimal iPhone-style bottom audio bar (RTL) */
:root{
  --qc-bar-bg: rgba(28, 30, 33, 0.92);
  --qc-bar-border: rgba(255,255,255,0.08);
  --qc-bar-text: rgba(255,255,255,0.92);
  --qc-bar-sub: rgba(255,255,255,0.62);
  --qc-accent: #ffffff;
}
.qc-audio-bar{
  position: fixed;
  left: 10px;
  right: 10px;
  bottom: calc(10px + env(safe-area-inset-bottom, 0px));
  z-index: 9999;
  color: var(--qc-bar-text);
  background: var(--qc-bar-bg);
  border: 1px solid var(--qc-bar-border);
  border-radius: 18px;
  box-shadow: 0 12px 30px rgba(0,0,0,0.35);
  backdrop-filter: blur(18px);
  -webkit-backdrop-filter: blur(18px);
  overflow: hidden;
  direction: rtl;
}
.qc-audio-bar[hidden]{ display:none !important; }

.qc-progress{
  position: relative;
  height: 22px;
  padding: 6px 10px 0 10px;
}
#koranSeek{
  width: 100%;
  margin: 0;
  -webkit-appearance: none;
  appearance: none;
  height: 4px;
  background: rgba(255,255,255,0.18);
  border-radius: 999px;
  outline: none;
}
#koranSeek::-webkit-slider-thumb{
  -webkit-appearance: none;
  appearance: none;
  width: 14px;
  height: 14px;
  border-radius: 999px;
  background: #fff;
  box-shadow: 0 2px 10px rgba(0,0,0,0.35);
  border: 0;
}
#koranSeek::-moz-range-thumb{
  width: 14px; height: 14px; border-radius: 999px;
  background: #fff; border: 0;
  box-shadow: 0 2px 10px rgba(0,0,0,0.35);
}
#koranSeek::-moz-range-track{
  height: 4px; background: rgba(255,255,255,0.18); border-radius: 999px;
}

.qc-controls{
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
  padding: 8px 10px 10px 10px;
}
.qc-btn{
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 38px;
  height: 38px;
  border-radius: 999px;
  border: 0;
  background: transparent;
  color: var(--qc-bar-text);
  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
  user-select: none;
}
.qc-btn:active{ transform: scale(0.97); opacity: 0.85; }

.qc-btn.qc-play{
  width: 46px;
  height: 46px;
  background: rgba(255,255,255,0.10);
  border: 1px solid rgba(255,255,255,0.10);
}

.qc-meta{
  display: none; /* hidden by default like Quran.com mobile */
  padding: 0 12px 10px 12px;
}
.qc-meta.show{ display:block; }
.qc-title{ font-size: 0.9rem; font-weight: 700; line-height: 1.2; }
.qc-sub{ font-size: 0.8rem; color: var(--qc-bar-sub); margin-top: 2px; }

/* Bottom sheet (More) */
.qc-sheet-backdrop{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  z-index: 9998;
}
.qc-sheet{
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 9999;
  background: rgba(24, 26, 29, 0.98);
  color: var(--qc-bar-text);
  border-top-left-radius: 20px;
  border-top-right-radius: 20px;
  padding: 10px 14px calc(14px + env(safe-area-inset-bottom, 0px)) 14px;
  transform: translateY(110%);
  transition: transform 240ms ease;
  box-shadow: 0 -18px 40px rgba(0,0,0,0.45);
}
.qc-sheet.open{ transform: translateY(0); }
.qc-handle{
  width: 44px;
  height: 5px;
  border-radius: 999px;
  background: rgba(255,255,255,0.22);
  margin: 6px auto 10px auto;
}
.qc-sheet h3{
  margin: 0 0 10px 0;
  font-size: 1rem;
  font-weight: 800;
  text-align: center;
}
.qc-row{
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  padding: 10px 6px;
  border-bottom: 1px solid rgba(255,255,255,0.08);
}
.qc-row:last-child{ border-bottom: 0; }
.qc-row label{ color: var(--qc-bar-sub); font-size: 0.9rem; }
.qc-row select, .qc-row input[type="number"]{
  background: rgba(255,255,255,0.08);
  color: var(--qc-bar-text);
  border: 1px solid rgba(255,255,255,0.10);
  border-radius: 12px;
  padding: 8px 10px;
  font-size: 0.95rem;
  outline: none;
}
.qc-row .qc-switch{
  display:flex; align-items:center; gap:10px;
}
.qc-row .qc-small{
  font-size: 0.85rem;
  color: var(--qc-bar-sub);
}
.qc-actions{
  display:flex; gap:10px; justify-content: space-between; padding-top: 12px;
}
.qc-actions button{
  flex: 1;
  border: 0;
  border-radius: 14px;
  padding: 12px 12px;
  background: rgba(255,255,255,0.10);
  color: var(--qc-bar-text);
  font-weight: 800;
  cursor: pointer;
}
.qc-actions button:active{ transform: scale(0.99); opacity: 0.9; }


/* Hide legacy qc audio bar (replaced by site floating player) */
#koranAudioBar, #qcAudioSheetBackdrop, #koranAudioAdvanced{ display:none !important; }
</style>
</head>
<body>

<div id="login-overlay">
  <div style="position: absolute; top: 20px; right: 20px;">
    <button class="icon-btn" onclick="toggleDarkMode()">
      <i id="dark-mode-icon" class="fa-solid fa-moon"></i>
    </button>
  </div>

  <div class="login-box">
  <div class="login-brand">
    <img src="https://drive.google.com/thumbnail?id=1PnvFFWtTcnNiMCNIZuBsAjaz3cV4-Lbw&sz=w200-h200"
         alt="Logo"
         class="login-logo">
    <div class="login-brand-text">
      <h2 id="lbl-login-title">Anmelden</h2>
      <div class="login-sub" id="lbl-login-sub">Lehrer / Schüler / Admin</div>
    </div>
  </div>

  <div class="login-form">
    <div class="login-badge" id="login-badge">Lehrer / Schüler / Admin</div>

    <!-- Saved profiles (Netflix-like quick login) -->
    <div id="saved-profiles" class="saved-profiles hidden">
      <div class="saved-profiles-title" id="lbl-saved-profiles">Schnellstart</div>
      <div id="saved-profiles-list" class="saved-profiles-list"></div>
      <div class="saved-profiles-hint" id="lbl-saved-profiles-hint">Tippe auf ein Profil, um dich schneller anzumelden.</div>
    </div>

    
    <div class="form-group" style="margin-top:10px;">
      <label class="form-label" id="lbl-login-id">Benutzername / Student ID</label>

      <!-- Username input with inline dropdown (saved profiles) -->
      <div class="input-dd" id="login-identifier-wrap">
        <input type="text" id="login-identifier" class="login-text" inputmode="text" autocapitalize="none" spellcheck="false"
               placeholder="Benutzername أو Student ID" autocomplete="username" enterkeyhint="next">

        <button type="button" class="dd-btn" id="btn-id-dropdown" aria-label="Open saved profiles">
          <i class="fa-solid fa-chevron-down"></i>
        </button>

        <div class="dd-panel hidden" id="id-dropdown-panel" role="listbox" aria-label="Saved profiles"></div>
      </div>
    </div>


    <div class="form-group" style="margin-top:10px;">
      <label class="form-label" id="lbl-login-pin">PIN</label>
      <input type="password" id="login-pin" class="login-text login-pin" placeholder="PIN / الرقم السري" inputmode="numeric" autocomplete="current-password" enterkeyhint="go">
    </div>

    <div class="login-help" id="login-help">اكتب اسم المستخدم للمعلم/الإدارة أو Student ID للطالب ثم أدخل الرقم السري.</div>
  </div>

  <label class="login-remember">
    <input type="checkbox" id="chk-remember" />
    <span id="lbl-remember">Angemeldet bleiben</span>
  </label>

  <button class="btn" onclick="doLogin()" id="lbl-login-btn">Einloggen</button>
  <p id="login-error" class="login-error"></p>
</div></div>
</div>

<!-- Login Loading Overlay -->
<div id="login-loading-overlay" class="hidden" aria-hidden="true">
  <div class="login-loading-card">
    <div class="loader" aria-label="Loading"></div>
    <div class="login-loading-text" id="login-loading-text">جارٍ التحقق...</div>
    <div class="login-loading-sub" id="login-loading-sub">Bitte warten…</div>
  </div>
</div>

<div id="qs-app-root" class="hidden">
  <!-- Floating Audio Player -->
  <div id="floating-audio-player" class="floating-audio-player collapsed" aria-live="polite">
    <button class="audio-fab-btn" id="audio-fab-btn" onclick="audioFabClick()" aria-label="تشغيل الصوت / Audio">
      <i id="audio-fab-icon" class="fa-solid fa-play"></i>
    </button>

    <div class="floating-audio-panel" role="dialog" aria-label="Audio controls">
      <div class="floating-audio-header">
        <div class="floating-audio-title" id="floating-audio-title">Keine Audio-Wiedergabe</div>
        <button class="floating-audio-close" onclick="collapseFloatingAudioPanel()" title="إغلاق / Schließen"><i class="fa-solid fa-xmark"></i></button>
      </div>

      <input id="floating-audio-seek" class="floating-audio-seek" type="range" min="0" max="100" value="0" step="0.1" />

      <div class="floating-audio-controls">
        <button class="audio-btn sec" onclick="previousAyah()" id="btn-prev-ayah" title="السابق">◀</button>
        <button class="audio-btn" onclick="togglePlayPause()" id="btn-play-pause" title="تشغيل/إيقاف">▶</button>
        <button class="audio-btn sec" onclick="nextAyah()" id="btn-next-ayah" title="التالي">▶▶</button>

        <select id="floating-audio-repeat" class="form-select" style="width:50px; padding:6px 8px; font-size:0.8rem;" title="تكرار">
          <option value="1">1×</option>
          <option value="2">2×</option>
          <option value="3">3×</option>
          <option value="5">5×</option>
          <option value="10">10×</option>
                  <option value="inf">∞</option>
        </select>

        <select id="floating-audio-speed" class="form-select" style="width:50px; padding:6px 8px; font-size:0.8rem;" title="السرعة">
          <option value="0.75">0.75×</option>
          <option value="1" selected>1×</option>
          <option value="1.25">1.25×</option>
          <option value="1.5">1.5×</option>
          <option value="2">2×</option>
        </select>
      </div>

      <div class="floating-audio-info" id="floating-audio-info">Bereit</div>
    </div>
  </div>


  <header class="app-header">
    <div class="logo-area">
      <img src="https://drive.google.com/thumbnail?id=1PnvFFWtTcnNiMCNIZuBsAjaz3cV4-Lbw&sz=w200-h200" class="logo-img" alt="Logo">
      <div class="logo-text">
        <div style="font-size:0.9rem; font-weight:bold;" id="hdr-title">Schülerverwaltung</div>
        <div style="font-size:0.7rem; color:var(--text-sec);" id="hdr-sync">Synchronisiere...</div>
        <div style="font-size:0.65rem; color:var(--primary);" id="hdr-user"></div>
      </div>
    </div>
    <div class="header-actions">
      <button class="icon-btn" onclick="refreshData()" style="color: var(--primary);">
        <i class="fa-solid fa-arrows-rotate"></i>
      </button>

      <button class="icon-btn" onclick="toggleLang()" style="color: var(--primary);">
        <i class="fa-solid fa-globe"></i>
      </button>
      <button class="icon-btn" onclick="toggleFilter()" style="color: var(--primary);" id="btn-filter">
        <i class="fa-solid fa-sliders"></i>
      </button>
      <button class="icon-btn cloud-ok" id="btn-cloud" onclick="openSyncIssues()" title="Gespeichert / تم الحفظ">
        <i id="cloud-icon" class="fa-solid fa-cloud"></i>
        <span class="badge hidden" id="badge-cloud">!</span>
      </button>
<button class="icon-btn" id="btn-logout" onclick="doLogout()" title="Logout / تسجيل الخروج" style="color: var(--danger);">
        <i class="fa-solid fa-right-from-bracket"></i>
      </button>

      <button class="icon-btn hidden" id="btn-add-student" onclick="openAddStudent()">
        <i class="fa-solid fa-user-plus"></i>
      </button>
    </div>
  </header>

  <div id="filter-panel">
    <div class="p-4">
      
    <!-- Modern Filter Bar (Gruppen + Unterrichtstage + Suche) -->
    <div class="filter-topbar">
      <div class="filter-field">
        <div class="filter-label" id="lbl-groups">Gruppen</div>
        <select id="group-select" class="filter-select" onchange="updateFilterState()"></select>
      </div>

      <div class="filter-field">
        <div class="filter-label" id="lbl-days">Unterrichtstage</div>
        <select id="day-select" class="filter-select" onchange="updateFilterState()"></select>
      </div>

      <button class="icon-btn filter-search-btn" type="button" onclick="toggleSearchBar()" title="Suche">
        <i class="fa-solid fa-magnifying-glass"></i>
      </button>

      <button class="filter-done-btn" type="button" onclick="closeFilters()" title="تم">
        تم
      </button>
    </div>

    <div id="search-wrap" class="hidden" style="margin-top:10px;">
      <input type="text" id="search-input" class="search-bar" placeholder="Suchen..." oninput="handleSearchInput()">
    </div>

    <div id="student-count-result" class="text-sm font-bold" style="margin-top: 8px; color: var(--primary);"></div>

    <div class="filter-checkbox-group hidden" id="admin-filters">
         <label class="filter-checkbox"><input type="checkbox" id="chk-fin-prob" onchange="updateFilterState()"><span id="lbl-fin-prob">Mahnwesen</span></label>
         
         <label class="filter-checkbox"><input type="checkbox" id="chk-warteliste" onchange="updateFilterState()"><span id="lbl-waitlist-only">Warteliste</span></label>
<label class="filter-checkbox"><input type="checkbox" id="chk-abgemeldet" onchange="updateFilterState()"><span id="lbl-abgemeldet">Abgemeldet anzeigen</span></label>
      </div>
      <div id="capacity-warning" class="hidden" style="margin-top:10px; color:var(--danger); font-size:0.8rem;">⚠ <span id="lbl-cap-warn">Gruppe voll</span></div>
    </div>
  </div>

  <main id="tab-students">
    <div id="students-list"></div>
    <div id="fab-attendance" class="fab-container">
        <button class="fab-btn" onclick="submitBatchAttendance()">
            <i class="fa-solid fa-paper-plane"></i>
            <span id="lbl-send-btn">Senden</span>
        </button>
    </div>
  </main>

  
<main id="tab-student-home" class="hidden">
  <div class="p-4">
    <div style="display:flex; align-items:center; justify-content:flex-start; gap:10px;">
      <h3 id="stu-home-title" style="margin:0;">Home</h3>
</div>


    <!-- Absence report (multi-date) -->
<div class="card flex-col" id="stu-home-abs-card" style="align-items:flex-start; margin-top:12px;">
  <label class="filter-checkbox" style="width:100%; justify-content:flex-start;">
    <input type="checkbox" id="chk-home-absent" onchange="toggleHomeAbsentUI()" />
    <span id="stu-home-abs-head">- الإبلاغ عن الغياب -</span>
  </label>

  <div id="home-absent-extra" class="hidden" style="width:100%; margin-top:12px;">
    <div class="text-sm text-sec" id="stu-home-abs-hint">
      اختر تواريخ الغياب (يمكنك إضافة أكثر من تاريخ) ثم أرسل البلاغ.
    </div>

    <div style="width:100%; margin-top:10px;">
      <div id="home-abs-dates"></div>
      <button class="btn btn-sec" type="button" style="margin-top:10px; width:100%;" onclick="addHomeAbsentDateRow()" id="btn-home-abs-adddate">
        <i class="fa-solid fa-plus"></i> <span id="lbl-home-abs-adddate">إضافة تاريخ</span>
      </button>
    </div>

    <textarea id="home-absent-reason" class="form-textarea" rows="3" style="margin-top:10px;" placeholder="سبب الغياب / Grund..."></textarea>

    <label class="filter-checkbox" style="margin-top:8px; width:100%; justify-content:flex-start;">
      <input type="checkbox" id="chk-home-cert" />
      <span id="home-cert-label">شهادة طبية / Attest vorhanden</span>
    </label>

    <button class="btn" style="margin-top:12px; width:100%;" onclick="submitHomeAbsent()" id="btn-home-abs-send">Senden</button>

    <div class="text-sm text-sec" id="home-abs-status" style="margin-top:10px;"></div>
  </div>
</div>


    <div style="margin-top:12px; display:flex; flex-direction:column; gap:4px;" id="student-home-alerts"></div>
    <div class="card flex-col hidden" id="stu-home-hw-card" style="align-items:flex-start; margin-top:12px; cursor:pointer;" onclick="openStudentHomeworkShortcut(event)">
      <div style="display:flex; align-items:center; justify-content:space-between; width:100%; gap:10px;">
        <div id="stu-home-hw-title" style="font-weight:900;">Hausaufgaben</div>
        <button class="btn btn-sm" type="button" onclick="switchTab('student-homework')">
          <i class="fa-solid fa-list-check"></i>
        </button>
      </div>
      <div id="student-home-homework-list" style="width:100%; display:flex; flex-direction:column; gap:4px; margin-top:4px;"></div>
    </div>

        <div id="student-home-achievements" style="margin-top:14px; display:flex; flex-direction:column; gap:4px;"></div>
  </div>
</main>

<main id="tab-student-homework" class="hidden">
  <div class="p-4">
    <h3 id="stu-hw-title">Meine Hausaufgaben</h3>
    
    <div id="stu-hw-parentseen-panel" class="card flex-row hidden" style="align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px;">
      <div style="flex:1; min-width:0;">
        <div id="stu-hw-parentseen-title" style="font-weight:900;">✅ تم الاطلاع</div>
        <div id="stu-hw-parentseen-hint" class="text-sm text-sec">اضغط لتأكيد اطلاع ولي الأمر على الواجبات الحالية.</div>
      </div>
      <button class="btn" id="btn-stu-hw-parentseen" type="button" onclick="markStudentHomeworkSeenAll()">تأكيد</button>
    </div>
<div id="student-homework-list" style="display:flex; flex-direction:column; gap:6px;"></div>
  </div>
</main>

<main id="tab-student-memorize" class="hidden koran-tab">
  <div id="koran-reader" class="koran-reader" dir="rtl">
    <div id="koran-page-wrap" class="koran-page-wrap">
<div id="koranPageLoading" class="koran-page-loading hidden"><div class="pill">تحميل الصفحة...</div></div>

      <div id="koranPageText" class="koran-page-text hidden" aria-label="نص الصفحة"></div>

      <img id="koranPageImg" class="koran-page-img hidden" alt="Quran page" />
</div>

    <button id="koranIndexFab" class="koran-fab" aria-label="الفهرس" type="button" title="الفهرس">
      <i class="fa-solid fa-list-ul"></i>
    </button>

    <div id="koranDrawerOverlay" class="koran-drawer-overlay hidden" aria-hidden="true"></div>
    <aside id="koranDrawer" class="koran-drawer hidden" aria-hidden="true">
      <div class="koran-drawer-head">
        <div class="koran-drawer-title">الفهرس</div>
        <button class="icon-btn" id="koranDrawerClose" aria-label="إغلاق" type="button">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>

      <div class="koran-drawer-body">
        <div class="koran-jump">
          <div class="koran-section-title">الانتقال إلى صفحة</div>
          <div class="koran-jump-row">
            <input id="koranJumpPageInput" type="number" min="1" max="604" class="form-input" placeholder="رقم الصفحة (1-604)" inputmode="numeric">
            <button class="icon-btn" id="koranJumpPageBtn" type="button" title="اذهب"><i class="fa-solid fa-arrow-right"></i></button>
          </div>
        </div>

        <div class="koran-bookmarks">
          <div class="koran-section-title">العلامات</div>
          <div id="koranBookmarksList" class="koran-list koran-bookmarks-list"></div>
        </div>

        <div class="koran-surahs">
          <div class="koran-section-title">السور</div>
          <input id="koranSurahSearch" type="text" class="search-bar" placeholder="ابحث عن سورة...">
          <div id="koranSurahList" class="koran-list"></div>
        </div>
      </div>
    </aside>

        <div id="koranAudioBar" class="qc-audio-bar" hidden dir="rtl" aria-live="polite">
  <div class="qc-progress">
    <input id="koranSeek" type="range" min="0" max="1000" value="0" aria-label="شريط التقدم">
  </div>

  <div class="qc-controls" role="group" aria-label="تحكم الصوت">
    <button class="qc-btn" id="koranAudioStop" type="button" title="إيقاف/إغلاق" aria-label="إيقاف/إغلاق"><i class="fa-solid fa-xmark"></i></button>
    <button class="qc-btn" id="koranAudioPrev" type="button" title="السابق" aria-label="السابق"><i class="fa-solid fa-backward-step"></i></button>

    <button class="qc-btn qc-play" id="koranAudioToggle" type="button" title="تشغيل/إيقاف" aria-label="تشغيل/إيقاف">
      <span id="koranPlayLabel"><i class="fa-solid fa-play"></i></span>
    </button>

    <button class="qc-btn" id="koranAudioNext" type="button" title="التالي" aria-label="التالي"><i class="fa-solid fa-forward-step"></i></button>
    <button class="qc-btn" id="qcMuteBtn" type="button" title="كتم الصوت" aria-label="كتم الصوت" aria-pressed="false">🔈</button>
    <button class="qc-btn" id="koranAudioMoreBtn" type="button" title="المزيد" aria-label="المزيد"><i class="fa-solid fa-ellipsis"></i></button>
  </div>

  <!-- مخفي افتراضيًا (يمكن إظهاره لاحقًا عند الحاجة) -->
  <div class="qc-meta" id="qcMeta">
    <div class="qc-title" id="koranAudioTitle"></div>
    <div class="qc-sub" id="koranAudioInfo"></div>
    <div class="qc-sub" id="koranAudioHint">اختر سورة من الفهرس ثم اضغط تشغيل</div>
  </div>
</div>

<div id="qcAudioSheetBackdrop" class="qc-sheet-backdrop" hidden></div>

<div id="koranAudioAdvanced" class="qc-sheet" aria-hidden="true" dir="rtl">
  <div class="qc-handle"></div>
  <h3>إعدادات الصوت</h3>

  <div class="qc-row">
    <label id="koranLblSpeed" for="koranSpeedSel">السرعة</label>
    <select id="koranSpeedSel" aria-label="سرعة التشغيل">
      <option value="0.5">0.5×</option>
      <option value="0.75">0.75×</option>
      <option value="1" selected>1×</option>
      <option value="1.25">1.25×</option>
      <option value="1.5">1.5×</option>
      <option value="2">2×</option>
    </select>
  </div>

  <div class="qc-row">
    <label id="koranLblRepeat" for="koranRepeatCount">التكرار</label>
    <select id="koranRepeatCount" aria-label="عدد التكرار">
      <option value="1" selected>مرة واحدة</option>
      <option value="2">مرتين</option>
      <option value="3">3 مرات</option>
      <option value="5">5 مرات</option>
      <option value="10">10 مرات</option>
      <option value="999">تكرار</option>
    </select>
  </div>

  <div class="qc-row">
    <div class="qc-switch">
      <input id="koranAutoNextChk" type="checkbox">
      <label id="koranLblAutoNext" for="koranAutoNextChk">تشغيل تلقائي للآية التالية</label>
    </div>
  </div>

  <div class="qc-row">
    <span class="qc-small" id="koranTime">00:00 / 00:00</span>
    <button id="koranBookmarkBtn" type="button" class="qc-btn" title="حفظ موضع" aria-label="حفظ موضع">🔖</button>
  </div>

  <div class="qc-actions">
    <button type="button" onclick="window.qcAudioSheet && window.qcAudioSheet.close()">إغلاق</button>
  </div>
</div>

<audio id="koranAudio" preload="none"></audio>

  </div>
</main>

<main id="tab-student-rating" class="hidden">
  <div class="p-4">
    <h3 id="stu-akte-title">Akte</h3>

    <!-- Section: Evaluations -->
    <div class="card flex-col" style="align-items:flex-start; cursor:pointer; margin-bottom:10px;" onclick="openStudentAkteEval()">
      <div style="width:100%; display:flex; align-items:center; justify-content:space-between; gap:12px;">
        <div>
          <div style="font-weight:bold;" id="akte-eval-head">Bewertung</div>
          <div class="text-sm text-sec" id="akte-eval-sub" style="margin-top:4px;">Durchschnitt</div>
        </div>
        <div style="text-align:right;">
          <div id="akte-eval-stars" style="font-size:1.4rem; line-height:1.6rem;">—</div>
          <div class="text-sm text-sec" id="akte-eval-grade" style="margin-top:2px;">—</div>
        </div>
      </div>
    </div>

    <!-- Section: Attendance (late/absent) -->
    <div class="card flex-col" style="align-items:flex-start; cursor:pointer;" onclick="openStudentAkteAttendance()">
      <div style="width:100%; display:flex; align-items:center; justify-content:space-between; gap:12px;">
        <div>
          <div style="font-weight:bold;" id="akte-att-head">Anwesenheit</div>
          <div class="text-sm text-sec" id="akte-att-sub" style="margin-top:4px;">Verspätungen & Fehlzeiten</div>
        </div>
        <div style="text-align:right; line-height:1.4;">
          <div class="text-sm" style="font-weight:800; color:var(--warning);"><span id="akte-att-late-count">0</span> <span id="akte-att-late-label">Verspätungen</span></div>
          <div class="text-sm" style="font-weight:800; color:var(--danger);"><span id="akte-att-abs-count">0</span> <span id="akte-att-abs-label">Fehlzeiten</span></div>
        </div>
      </div>
    </div>

    
    <!-- Section: Fortschritt (auswendig bestätigt) -->
    <div class="card flex-col" style="align-items:flex-start; cursor:pointer; margin-top:10px;" onclick="openStudentAkteProgress()">
      <div style="width:100%; display:flex; align-items:center; justify-content:space-between; gap:12px;">
        <div>
          <div style="font-weight:bold;" id="akte-prog-head">Fortschritt</div>
          <div class="text-sm text-sec" id="akte-prog-sub" style="margin-top:4px;">Auswendig gelernte Verse</div>
        </div>
        <div style="text-align:right;">
          <div id="akte-prog-sum" class="prog-inline" style="font-size:1.1rem; font-weight:900; line-height:1.6rem;; white-space:normal;">—</div>
          <div class="text-sm text-sec" id="akte-prog-last" style="margin-top:2px;">—</div>
        </div>
      </div>
    </div>

<!-- Legacy container kept hidden (in case any code still targets it) -->
    <div id="student-eval-list" class="hidden"></div>
  </div>
</main>

<main id="tab-student-parent" class="hidden">
  <div class="p-4">
    <h3 id="stu-parent-title">Elterninfo</h3>
<div class="card flex-col" style="align-items:flex-start; margin-top:10px;">
      <div style="font-weight:bold;" id="stu-notif-head">Benachrichtigungen</div>
      <div class="text-sm text-sec" id="stu-notif-hint" style="margin-top:6px;">
        Aktivieren Sie Benachrichtigungen für neue Hinweise / Notizen (solange die Seite geöffnet ist).
      </div>
      <label class="filter-checkbox" style="margin-top:12px; width:100%; justify-content:flex-start;">
        <input type="checkbox" id="chk-stu-notif" onchange="toggleStudentNotifications()" />
        <span id="stu-notif-label">Bei neuen Einträgen benachrichtigen</span>
      </label>
      <div class="text-sm text-sec" id="stu-notif-status" style="margin-top:10px;"></div>
    </div>

    <div class="card flex-col" style="align-items:flex-start; margin-top:10px;">
      <div style="font-weight:bold;" id="stu-pin-head">PIN ändern</div>
      <div class="text-sm text-sec" id="stu-pin-hint" style="margin-top:6px;">
        Ändern Sie die PIN dieses Schülers. Bitte bewahren Sie die neue PIN sicher auf.
      </div>

      <div style="width:100%; margin-top:10px;">
        <div class="form-group">
          <label class="form-label" id="lbl-stu-old-pin">Alte PIN</label>
          <input type="password" id="stu-old-pin" class="form-input" inputmode="numeric" autocomplete="current-password" placeholder="••••">
        </div>
        <div class="form-group">
          <label class="form-label" id="lbl-stu-new-pin">Neue PIN</label>
          <input type="password" id="stu-new-pin" class="form-input" inputmode="numeric" autocomplete="new-password" placeholder="••••">
        </div>
        <div class="form-group">
          <label class="form-label" id="lbl-stu-new-pin2">Neue PIN bestätigen</label>
          <input type="password" id="stu-new-pin2" class="form-input" inputmode="numeric" autocomplete="new-password" placeholder="••••">
        </div>
        <button class="btn" onclick="changeStudentPin()" id="btn-stu-pin-save" style="width:100%;">Speichern</button>
        <div class="text-sm text-sec" id="stu-pin-status" style="margin-top:10px;"></div>
      </div>
    </div>


  </div>
</main>


    <main id="tab-comm" class="hidden">
    <div class="comm-header">
      <div class="comm-title-row">
        <h3 class="comm-title" id="comm-inbox-title">Nachrichten</h3>
        <div style="display:flex; gap:8px; align-items:center;">
          <button class="icon-btn" type="button" onclick="toggleComposePanel()" aria-label="Compose">
            <i class="fa-solid fa-pen-to-square"></i>
          </button>
        </div>
      </div>

      <div class="comm-tools">
        <div class="comm-search" role="search">
          <i class="fa-solid fa-magnifying-glass"></i>
          <input type="text" id="msg-search" placeholder="Suchen..." oninput="onMsgSearch(this.value)" />
          <button class="icon-btn hidden" id="msg-search-clear" type="button" onclick="clearMsgSearch()" aria-label="Clear">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>

        <div class="comm-chips" id="msg-box-chips">
          <button class="chip active" type="button" id="msg-chip-inbox" onclick="setMsgBox('inbox')">Eingang</button>
          <button class="chip" type="button" id="msg-chip-sent" onclick="setMsgBox('sent')">Gesendet</button>
        </div>

        <div class="comm-chips" id="msg-filter-chips">
          <button class="chip active" type="button" id="msg-chip-all" onclick="setMsgFilter('all')">Alle</button>
          <button class="chip" type="button" id="msg-chip-unread" onclick="setMsgFilter('unread')">Ungelesen</button>
        </div>

        <div class="comm-notif">
          <label class="filter-checkbox" style="width:100%; justify-content:flex-start;">
            <input type="checkbox" id="chk-msg-notif" onchange="toggleMessageNotifications()" />
            <span id="lbl-msg-notif">Benachrichtigungen für neue Nachrichten</span>
          </label>
          <div class="text-sm text-sec" id="msg-notif-status" style="margin-top:8px;"></div>
        </div>
      </div>
    </div>

    <div class="compose-overlay hidden" id="compose-overlay" onclick="toggleComposePanel(false)"></div>

    <div class="compose-panel hidden" id="compose-panel" role="dialog" aria-modal="true" aria-label="Compose message">
      <div class="compose-head">
        <div class="font-bold" id="lbl-send-msg">Nachricht senden</div>
        <button class="icon-btn" type="button" onclick="toggleComposePanel(false)" aria-label="Close">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>

      <textarea id="msg-body" class="form-textarea" rows="5" style="margin-top:8px;" placeholder="."></textarea>

      <div class="compose-actions">
        <button class="btn" onclick="sendTeacherMessage()" id="btn-send"><span id="lbl-msg-send-btn">Senden</span></button>
      </div>

      <div class="compose-divider"></div>

      <div class="form-label" id="lbl-msg-recipient-type" style="margin-top:4px;">Empfänger</div>
      <select id="msg-dest-type" class="form-select" onchange="toggleMsgRecipient()">
        <option value="Lehrer">Lehrer</option>
        <option value="Admin">Admin</option>
        <option value="Student">Schüler</option>
        </select>

      <div id="msg-dest-wrapper" style="margin-top:10px;">
        <div id="teacher-select-container">
          <div class="form-label" style="margin-top:5px;" id="lbl-msg-teachers">Lehrer auswählen:</div>
          <div id="teacher-checklist" class="checkbox-list"></div>
        </div>

        <div id="student-select-container" class="hidden" style="margin-top:10px;">
          <div class="form-label" style="margin-top:5px;" id="lbl-msg-students">Schüler auswählen:</div>
          <div class="text-sm text-sec" id="msg-stu-filter-hint" style="margin-top:4px;"></div>

          <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-top:8px;">
            <label style="display:flex; gap:8px; align-items:center;">
              <input type="checkbox" id="msg-stu-selectall" onchange="toggleMsgStudentSelectAll(this.checked)" />
              <span class="text-sm" id="lbl-msg-stu-selectall">Alle</span>
            </label>
            <div class="text-sm text-sec">
              <span id="lbl-msg-stu-selected">Ausgewählt:</span>
              <span id="msg-stu-count">0</span>
            </div>
          </div>

          <div id="student-checklist" class="checkbox-list" style="margin-top:8px;"></div>
        </div>
</div>
    </div>

    <div id="messages-list" class="messages-list"></div>
  </main>

  
  <main id="tab-homework-admin" class="hidden">
    <div class="p-4">
      <div class="hw-admin-header">
        <h3 id="hw-admin-title">Hausaufgaben</h3>
        <div class="hw-admin-header-actions" style="display:flex; gap:8px; align-items:center;">
        <button class="icon-btn" id="hw-admin-add-toggle" type="button" onclick="toggleHomeworkAdminAssignMode()" title="+">
          <i class="fa-solid fa-plus"></i>
        </button>
</div>
      </div>

      <div class="card flex-col hw-admin-card" style="align-items:flex-start;">
        <div id="hw-admin-config" class="hw-admin-config hidden" style="width:100%; margin-top:2px;">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
            <div class="text-sm text-sec" id="hw-admin-config-label">نوع الواجب</div>
            <div class="hw-admin-type-seg" role="tablist" aria-label="homework type">
              <button id="hw-admin-type-quran" class="seg-btn active" type="button" onclick="setHwAdminQuickType('quran')">واجب قرآني</button>
              <button id="hw-admin-type-text" class="seg-btn" type="button" onclick="setHwAdminQuickType('text')">نص حر</button>
            </div>
          </div>
          <div id="hw-admin-text-wrap" class="hidden" style="margin-top:10px;">
            <input type="text" id="hw-admin-text-global" class="form-input" placeholder="اكتب نوع الواجب المنزلي..." />
          </div>
        </div>

        <div class="text-sm text-sec" id="hw-admin-count" style="margin-top:10px;"></div>

        <div id="hw-admin-select-all-row" class="hidden" style="margin-top:8px; display:flex; align-items:center; gap:10px;">
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer; user-select:none;">
            <input id="hw-admin-select-all" type="checkbox" onchange="hwAdminToggleSelectAll(this.checked)" />
            <span id="hw-admin-select-all-label" class="text-sm text-sec">تحديد الكل • Alle auswählen</span>
          </label>
        </div>

        <div id="hw-admin-students" class="bulk-list bulk-list-open"></div>

        <div id="hw-admin-add-panel" class="hidden" style="width:100%; margin-top:12px;">
          <div style="height:1px; background:var(--border); width:100%; margin:10px 0;"></div>

          <div class="text-sm text-sec" id="hw-admin-selected-count"></div>

          <h4 style="margin:10px 0 10px 0;">Neuer Auftrag (Hausaufgabe)</h4>

          <div class="form-group">
            <label class="form-label">Aufgabe-Typ • نوع الواجب</label>
            <div class="hw-type-row">
              <label class="hw-type"><input type="radio" name="hw-admin-type" value="memorized" checked onchange="toggleHomeworkAdminTypeUI()"> حفظ من الآية… إلى الآية… / Auswendig (Von–Bis)</label>
              <label class="hw-type"><input type="radio" name="hw-admin-type" value="text" onchange="toggleHomeworkAdminTypeUI()"> نص حر / Freier Text</label>
            </div>
          </div>

          <div id="hw-admin-add-verses-fields">
            <div class="form-group">
              <label class="form-label">Sure (Name/Nr)</label>
              <input type="text" id="hw-admin-add-surah" class="form-input" placeholder="z.B. Al-Fatiha">
              <div id="hw-admin-add-surah-dd" class="card hidden" style="margin-top:6px; padding:8px; max-height:180px; overflow:auto;"></div>
            </div>

            <div class="flex gap-2">
              <div class="form-group w-full">
                <label class="form-label">Von Vers</label>
                <input type="number" id="hw-admin-add-start" class="form-input">
              </div>
              <div class="form-group w-full">
                <label class="form-label">Bis Vers</label>
                <input type="number" id="hw-admin-add-end" class="form-input">
              </div>
            </div>
          </div>

          <div id="hw-admin-add-text-fields" class="hidden">
            <div class="form-group">
              <label class="form-label">Text • نص الواجب</label>
              <textarea id="hw-admin-add-free-text" class="form-textarea" rows="3" placeholder="اكتب المطلوب من الطالب..."></textarea>
            </div>
          </div>

<div class="hw-admin-actions" style="margin-top:10px;">
            <button class="btn primary" type="button" onclick="homeworkAdminAssignHomework()" id="btn-hw-admin-assign">
              <i class="fa-solid fa-paper-plane"></i>
              <span id="txt-hw-admin-assign">Hausaufgabe senden</span>
            </button>
          </div>

          <div class="text-sm text-sec" id="hw-admin-assign-status" style="margin-top:8px;"></div>
        </div>
          <div id="hw-admin-manage-panel" class="hidden" style="width:100%; margin-top:12px;">
            <div style="height:1px; background:var(--border); width:100%; margin:10px 0;"></div>

            <div class="text-sm text-sec" id="hw-admin-manage-selected-count"></div>

            <h4 id="hw-admin-manage-title" style="margin:10px 0 10px 0;">Hausaufgabe bearbeiten / löschen</h4>

            <div class="form-group">
              <label class="form-label" id="hw-admin-manage-select-label">Hausaufgabe auswählen</label>
              <select id="hw-admin-manage-select" class="form-input"></select>
            </div>

            <div class="text-sm text-sec" id="hw-admin-manage-common-hint" style="margin-top:-6px;"></div>

            <div id="hw-admin-manage-edit-panel" class="hidden" style="margin-top:12px;">
              <h4 id="hw-admin-manage-edit-title" style="margin:10px 0 10px 0;">Aufgabe ändern</h4>

              <div class="form-group">
                <label class="form-label" id="hw-admin-manage-type-label">Aufgabe-Typ • نوع الواجب</label>
                <div class="hw-type-row">
                  <label class="hw-type"><input type="radio" name="hw-admin-manage-type" value="memorized" checked onchange="toggleHomeworkAdminManageTypeUI()"> حفظ من الآية… إلى الآية… / Auswendig (Von–Bis)</label>
                  <label class="hw-type"><input type="radio" name="hw-admin-manage-type" value="text" onchange="toggleHomeworkAdminManageTypeUI()"> نص حر / Freier Text</label>
                </div>
              </div>

              <div id="hw-admin-manage-verses-fields">
                <div class="form-group">
                  <label class="form-label" id="hw-admin-manage-surah-label">Sure (Name/Nr)</label>
                  <input type="text" id="hw-admin-manage-surah" class="form-input" placeholder="z.B. Al-Fatiha">
                  <div id="hw-admin-manage-surah-dd" class="card hidden" style="margin-top:6px; padding:8px; max-height:180px; overflow:auto;"></div>
                </div>

                <div class="flex gap-2">
                  <div class="form-group w-full">
                    <label class="form-label" id="hw-admin-manage-from-label">Von Vers</label>
                    <input type="number" id="hw-admin-manage-start" class="form-input">
                  </div>
                  <div class="form-group w-full">
                    <label class="form-label" id="hw-admin-manage-to-label">Bis Vers</label>
                    <input type="number" id="hw-admin-manage-end" class="form-input">
                  </div>
                </div>
              </div>

              <div id="hw-admin-manage-text-fields" class="hidden">
                <div class="form-group">
                  <label class="form-label" id="hw-admin-manage-text-label">Text • نص الواجب</label>
                  <textarea id="hw-admin-manage-free-text" class="form-textarea" rows="3" placeholder="اكتب المطلوب من الطالب..."></textarea>
                </div>
              </div>
            </div>

            <div class="hw-admin-actions" style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
              <button class="btn" type="button" id="btn-hw-admin-manage-edit" onclick="homeworkAdminManageOpenEdit()">
                <i class="fa-solid fa-pen"></i>
                <span id="txt-hw-admin-manage-edit">Bearbeiten</span>
              </button>
<button class="btn primary hidden" type="button" id="btn-hw-admin-manage-save" onclick="homeworkAdminManageSaveChanges()">
                <i class="fa-solid fa-check"></i>
                <span id="txt-hw-admin-manage-save">Speichern</span>
              </button>

              <button class="btn hidden" type="button" id="btn-hw-admin-manage-cancel" onclick="homeworkAdminManageCancelEdit()">
                <i class="fa-solid fa-xmark"></i>
                <span id="txt-hw-admin-manage-cancel">Abbrechen</span>
              </button>
            </div>

            <div class="text-sm text-sec" id="hw-admin-manage-status" style="margin-top:8px;"></div>
          </div>

      </div>
    </div>
  </main>


  <main id="tab-stats" class="hidden">
    <div class="p-4">
      <h3 id="lbl-stats-title">Statistiken</h3>
<div class="stats-mini-row">
        <div class="card flex-col"><div class="text-sec" id="lbl-present-today">Anwesend heute</div><div class="font-bold" style="font-size:2rem; color:var(--success);" id="stat-present-today">0</div></div>
        <div class="card flex-col"><div class="text-sec" id="lbl-absent-today">Abwesend heute</div><div class="font-bold" style="font-size:2rem; color:var(--danger);" id="stat-absent-today">0</div></div>
        <div class="card flex-col"><div class="text-sec" id="lbl-late-today">Verspätet heute</div><div class="font-bold" style="font-size:2rem; color:var(--warning);" id="stat-late-today">0</div></div>
      </div>
      <div id="stats-groups"></div>
    </div>
  </main>

  <main id="tab-docs" class="hidden">
    <div class="p-4">
      <h3 id="lbl-docs-title">Dokumente</h3>
      <input type="text" id="doc-search-input" class="search-bar" placeholder="Dokumente suchen..." style="margin-top:10px;" oninput="renderDocuments()">
      <div id="docs-list" style="margin-top:1rem; display:flex; flex-direction:column; gap:10px;"></div>
    </div>
  </main>

  
  <main id="tab-users" class="hidden">
    <div class="p-4">
      <h3 id="lbl-manage-users">Verwaltung</h3>

      <div class="segmented-tabs" id="admin-branches">
        <button class="segmented-btn" id="btn-branch-users" onclick="switchAdminBranch('users')">
          <i class="fa-solid fa-users"></i>
          <span id="lbl-branch-users">Benutzer</span>
        </button>
        <button class="segmented-btn" id="btn-branch-waitlist" onclick="switchAdminBranch('waitlist')">
          <i class="fa-solid fa-hourglass-half"></i>
          <span id="lbl-branch-waitlist">Warteliste</span>
        </button>
        <button class="segmented-btn" active id="btn-branch-groups" onclick="switchAdminBranch('groups')">
          <i class="fa-solid fa-layer-group"></i>
          <span id="lbl-branch-groups">Gruppen</span>
        </button>
      </div>

      <div id="admin-branch-users" class="admin-section hidden">
        <div id="users-list-container" style="display:flex; flex-direction:column; gap:10px; margin-top:1rem; padding-bottom: 80px;"></div>
        <button class="fab-user-add" id="fab-add-user" onclick="openAddUser()">
          <i class="fa-solid fa-plus"></i>
        </button>
      </div>

      <div id="admin-branch-waitlist" class="admin-section hidden">
        <div class="text-sm text-sec" id="lbl-waitlist-hint" style="margin-top:10px;">—</div>
        <div id="waitlist-list-container" style="display:flex; flex-direction:column; gap:10px; margin-top:1rem; padding-bottom: 80px;"></div>
      </div>

      <div id="admin-branch-groups" class="admin-section">
        <div class="text-sm text-sec" id="lbl-groups-hint" style="margin-top:10px;">—</div>
        <div id="groups-cards-container" style="display:flex; flex-direction:column; gap:10px; margin-top:1rem; padding-bottom: 80px;"></div>
      </div>
    </div>
  </main>


  <nav class="bottom-nav">
    <button class="nav-item hidden" onclick="switchTab('users')" id="nav-users"><i class="fa-solid fa-users"></i><span id="lbl-nav-users">User</span></button>
    <button class="nav-item active" onclick="switchTab('students')" id="nav-students"><i class="fa-solid fa-user-graduate"></i><span id="lbl-nav-stud">Schüler</span></button>
    
    
<button class="nav-item hidden" onclick="switchTab('student-home')" id="nav-stu-home">
  <i class="fa-solid fa-house"></i>
  <span id="lbl-nav-stu-home">Home</span>
  <span class="dot-badge hidden" id="badge-stu-home"></span>
</button>

<button class="nav-item hidden" onclick="switchTab('student-homework')" id="nav-stu-hw">
  <i class="fa-solid fa-clipboard"></i>
  <span id="lbl-nav-stu-hw">Aufgaben</span>
  <span class="dot-badge hidden" id="badge-stu-hw"></span>
</button>

<button class="nav-item hidden" onclick="switchTab('student-memorize')" id="nav-stu-mem">
  <i class="fa-solid fa-book-open"></i>
  <span id="lbl-nav-stu-mem">Koran</span>
</button>

<button class="nav-item hidden" onclick="switchTab('student-rating')" id="nav-stu-rate">
  <i class="fa-solid fa-star"></i>
  <span id="lbl-nav-stu-rate">Akte</span>
  <span class="dot-badge hidden" id="badge-stu-rate"></span>
</button>

<button class="nav-item hidden" onclick="switchTab('student-parent')" id="nav-stu-parent">
  <i class="fa-solid fa-user"></i>
  <span id="lbl-nav-stu-parent">Eltern</span>
</button>
<button class="nav-item" onclick="switchTab('homework-admin')" id="nav-homework-admin">
  <i class="fa-solid fa-clipboard"></i>
  <span id="lbl-nav-hw">Aufgaben</span>
</button>



    <button class="nav-item" onclick="switchTab('comm')" id="nav-comm"><i class="fa-solid fa-comments"></i>
  <span id="lbl-nav-comm">Komm.</span><span id="badge-msg-nav" class="badge hidden" style="top:0; right:10px;"></span></button>
    <button class="nav-item" onclick="switchTab('stats')" id="nav-stats"><i class="fa-solid fa-chart-line"></i>
  <span id="lbl-nav-stats">Statistik</span></button>
    <button class="nav-item" onclick="switchTab('docs')" id="nav-docs"><i class="fa-solid fa-file-lines"></i>
  <span id="lbl-nav-docs">Doku</span></button>
  </nav>
</div>



<div id="progress-overlay">
    <div class="progress-box">
        <h3 id="progress-title" style="margin:0 0 10px 0;">Sende Daten...</h3>
        <div class="progress-bar-track"><div id="progress-fill" class="progress-bar-fill"></div></div>
        <p id="progress-text" class="progress-text">0/0</p>
        <p id="success-msg" class="success-msg"><i class="fa-solid fa-circle-check"></i> Daten erfolgreich übertragen!</p>
    </div>
</div>

<div class="modal-overlay" id="hw-edit-modal">
  <div class="modal-content">
    <button class="close-icon" onclick="closeModal('hw-edit-modal')"><i class="fa-solid fa-xmark"></i></button>
    <h2 id="hw-edit-title">Hausaufgabe bearbeiten</h2>

    <div class="form-group">
      <label class="form-label">Aufgabe-Typ • نوع الواجب</label>
      <div class="hw-admin-type-seg" style="gap:8px;">
        <button id="hw-edit-type-quran" class="seg-btn" type="button" onclick="setHwEditType('quran')">واجب قرآني</button>
        <button id="hw-edit-type-text" class="seg-btn" type="button" onclick="setHwEditType('text')">نص حر</button>
      </div>
    </div>

    <div id="hw-edit-quran-fields">
      <div class="form-group">
        <label class="form-label">Sure (Name/Nr)</label>
        <input type="text" id="hw-edit-surah" class="form-input" placeholder="z.B. Al-Baqara">
        <div id="hw-edit-surah-dd" class="card hidden" style="margin-top:6px; padding:8px; max-height:180px; overflow:auto;"></div>
      </div>

      <div class="flex gap-2">
        <div class="form-group w-full">
          <label class="form-label">Von Vers</label>
          <input type="number" id="hw-edit-start" class="form-input">
        </div>
        <div class="form-group w-full">
          <label class="form-label">Bis Vers</label>
          <input type="number" id="hw-edit-end" class="form-input">
        </div>
      </div>
    </div>

    <div id="hw-edit-text-fields" class="hidden">
      <div class="form-group">
        <label class="form-label">Text • نص</label>
        <textarea id="hw-edit-text" class="form-input" rows="3" style="min-height:90px; resize:vertical;" placeholder="اكتب نص الواجب..."></textarea>
      </div>
    </div>

    <div class="flex gap-2" style="margin-top:12px; flex-direction:column;">
      <div class="flex gap-2">
        <button class="btn primary" type="button" onclick="saveHomeworkEdit()" id="btn-hw-edit-save"><i class="fa-solid fa-check"></i> <span>Speichern</span></button>
        <button class="btn btn-sec" type="button" onclick="closeModal('hw-edit-modal')" id="btn-hw-edit-cancel"><i class="fa-solid fa-xmark"></i> <span>Abbrechen</span></button>
      </div>
      <div class="text-sm text-sec" id="hw-edit-status" style="min-height:18px;"></div>
    </div>
  </div>
</div>

<div class="modal-overlay" id="detail-modal">
  <div class="modal-content">
    <button class="close-icon" onclick="closeModal('detail-modal')"><i class="fa-solid fa-xmark"></i></button>
    <div class="detail-header">
      <div class="detail-avatar" id="det-avatar"></div>
      <h2 id="det-name" style="margin:0;"></h2>
      <p id="det-sub" class="text-sec" style="margin:5px 0;"></p>
      <div id="det-alert" class="hidden" style="background:var(--danger); color:var(--text); opacity:0.8; padding:8px; border-radius:8px; font-size:0.8rem; margin-top:10px;"></div>
    </div>
    
    <div class="tab-controls">
        <div class="tab-ctrl active" onclick="switchDetailTab('info')" id="dt-info">Info</div>
        <div class="tab-ctrl" onclick="switchDetailTab('attendance')" id="dt-attendance">Attend.</div>
        <div class="tab-ctrl" onclick="switchDetailTab('curriculum')" id="dt-curriculum">Quran</div>
        <div class="tab-ctrl" onclick="switchDetailTab('eval')" id="dt-eval">Bewertung</div>
    </div>

    <div id="dview-info">
        <div class="detail-grid" id="det-grid"></div>
        <div class="notes-section">
            <h4 id="lbl-student-notes" style="margin-top:0; margin-bottom:10px;">Lehrer Notizen</h4>
            <div id="notes-list" class="notes-list"></div>
            <textarea id="new-student-note" class="form-textarea" rows="2" placeholder="..."></textarea>
            <button class="btn" onclick="saveStudentNote()" style="margin-top:5px;" id="btn-save-note">Notiz hinzufügen</button>
        </div>
        <div style="margin-top:2rem; display:flex; gap:10px;">
          <button class="btn btn-sec" onclick="printStudent()" id="btn-print-stud">Drucken</button>
          <button class="btn hidden" id="btn-edit-stud" onclick="openEditStudent()">Bearbeiten</button>
        </div>
    </div>

    <div id="dview-attendance" class="hidden">
        <div id="det-attendance-list"></div>
    </div>

    <div id="dview-curriculum" class="hidden">
        <h4 style="margin-bottom:10px;">Neuer Auftrag (Hausaufgabe)</h4>

        <div class="form-group">
          <label class="form-label">Aufgabe-Typ • نوع الواجب</label>
          <div class="hw-type-row">
            <label class="hw-type"><input type="radio" name="hw-type" value="memorized" checked onchange="toggleHomeworkTypeUI()"> حفظ من الآية… إلى الآية… / Auswendig (Von–Bis)</label>
            <label class="hw-type"><input type="radio" name="hw-type" value="text" onchange="toggleHomeworkTypeUI()"> نص حر / Freier Text</label>
          </div>
        </div>

        <div id="hw-verses-fields">
          <div class="form-group">
              <label class="form-label">Sure (Name/Nr)</label>
              <input type="text" id="hw-surah" class="form-input" placeholder="z.B. Al-Fatiha">
              <div id="hw-surah-dd" class="card hidden" style="margin-top:6px; padding:8px; max-height:180px; overflow:auto;"></div>
          </div>
          <div class="flex gap-2">
              <div class="form-group w-full">
                  <label class="form-label">Von Vers</label>
                  <input type="number" id="hw-start" class="form-input">
              </div>
              <div class="form-group w-full">
                  <label class="form-label">Bis Vers</label>
                  <input type="number" id="hw-end" class="form-input">
              </div>
          </div>
        </div>

        <div id="hw-text-fields" class="hidden">
          <div class="form-group">
            <label class="form-label">Text • نص الواجب</label>
            <textarea id="hw-free-text" class="form-textarea" rows="3" placeholder="اكتب المطلوب من الطالب..."></textarea>
          </div>
        </div>

        <button class="btn" onclick="assignHomework()" id="btn-hw-save">Speichern</button>
        <hr style="margin:20px 0; border:0; border-top:1px solid var(--border);">
        <h4>Verlauf</h4>
        <div id="hw-history-list" class="text-sm text-sec">Wird geladen...</div>
    </div>

    <div id="dview-eval" class="hidden">
         <h4 style="margin-bottom:10px;">Neue Bewertung</h4>
         <div class="form-group">
             <label class="form-label">Hifz (Hafiz)</label>
             <select id="eval-hifz" class="form-select">
                 <option value="">—</option>
                 <option value="Sehr Gut">Sehr Gut (ممتاز)</option>
                 <option value="Gut">Gut (جيد)</option>
                 <option value="Mittel">Mittel (متوسط)</option>
                 <option value="Schwach">Schwach (ضعيف)</option>
             </select>
         </div>
         <div class="form-group">
             <label class="form-label">Tajweed</label>
             <select id="eval-tajweed" class="form-select">
                 <option value="">—</option>
                 <option value="Sehr Gut">Sehr Gut</option>
                 <option value="Gut">Gut</option>
                 <option value="Mittel">Mittel</option>
             </select>
         </div>
         <div class="form-group">
             <label class="form-label">Verhalten</label>
             <select id="eval-behavior" class="form-select">
                 <option value="">—</option>
                 <option value="Vorbildlich">Vorbildlich</option>
                 <option value="Gut">Gut</option>
                 <option value="Störend">Störend</option>
             </select>
         </div>
         <div class="form-group">
             <label class="form-label">Notiz für Eltern</label>
             <textarea id="eval-note" class="form-textarea" rows="2"></textarea>
         </div>
         <div class="form-group" style="margin-top:10px;">
             <label class="form-label" style="display:flex; align-items:center; justify-content:space-between;">
               <span id="lbl-eval-note-only">Nur Notiz (ohne Bewertung) • ملاحظة فقط</span>
               <input type="checkbox" id="eval-note-only" onchange="toggleEvalNoteOnly()">
             </label>
             <div class="chips-container" style="margin-top:8px; justify-content:flex-start;">
               <button class="chip" onclick="applyEvalNoteTemplate('Keine Hausaufgaben dabei / لا يوجد واجبات', true)"><i class="fa-solid fa-thumbtack"></i> Keine Hausaufgaben</button>
               <button class="chip" onclick="applyEvalNoteTemplate('Hat seine Sachen nicht dabei / لم يحضر أدواته', true)">🧰 Keine Sachen</button>
               <button class="chip" onclick="applyEvalNoteTemplate('Bitte mit dem Lehrer sprechen / يرجى التواصل مع المعلم', true)">📞 Kontakt</button>
             </div>
         </div>
         <div class="flex gap-2" style="margin-top:8px;">
           <button class="btn w-full" onclick="submitEvaluation()">Bewertung Senden</button>
           <button class="btn btn-sec w-full" onclick="submitEvaluation({noteOnly:true})">Notiz senden</button>
         </div>
         <hr style="margin:20px 0; border:0; border-top:1px solid var(--border);">
         <h4>Historie</h4>
         <div id="eval-history-list" class="text-sm text-sec">Wird geladen...</div>
    </div>
  </div>
</div>

<div class="modal-overlay" id="edit-modal">
  <div class="modal-content">
    <button class="close-icon" onclick="closeModal('edit-modal')"><i class="fa-solid fa-xmark"></i></button>
    <h2 id="edit-title">Neuer Schüler</h2>
    <div id="last-id-display" style="text-align: center; color: var(--primary); font-weight: bold; margin-bottom: 10px; font-size: 0.9rem;"></div>
    <div id="edit-form"></div>
    <div class="flex gap-2" style="margin-top:1rem; flex-direction:column;">
      <div class="flex gap-2">
        <button class="btn" onclick="saveStudent()" id="btn-save-stud">Speichern</button>
        <button class="btn btn-sec" onclick="closeModal('edit-modal')" id="btn-cancel-stud">Abbrechen</button>
      </div>
      <button class="btn hidden" id="btn-delete-stud" style="background:var(--danger); margin-top:5px;" onclick="deleteStudent()">Schüler löschen</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="group-modal">
  <div class="modal-content">
    <button class="close-icon" onclick="closeModal('group-modal')"><i class="fa-solid fa-xmark"></i></button>
    <h2 id="group-det-title" style="margin:0;"></h2>
    <p id="group-det-sub" class="text-sec" style="margin:6px 0 0 0;"></p>
    <div id="group-det-badges" class="group-det-badges"></div>

    <div class="group-info-rows" id="group-det-info"></div>

    <div style="margin-top:12px;">
      <button class="btn btn-sec w-full" id="btn-group-edit-toggle" onclick="toggleGroupEdit()"></button>
    </div>

    <div id="group-edit-panel" class="hidden" style="margin-top:12px;">
      <div class="group-edit-grid">
        <div class="form-group">
          <label class="form-label" id="lbl-group-teacher"></label>
          <select id="inp-group-teacher" class="form-select"></select>
        </div>
        <div class="form-group">
          <label class="form-label" id="lbl-group-max"></label>
          <input type="number" id="inp-group-max" class="form-input" min="1" step="1" placeholder="20">
        </div>
        <div class="form-group">
          <label class="form-label" id="lbl-group-from"></label>
          <input type="time" id="inp-group-from" class="form-input" step="300" placeholder="16:00">
        </div>
        <div class="form-group">
          <label class="form-label" id="lbl-group-to"></label>
          <input type="time" id="inp-group-to" class="form-input" step="300" placeholder="18:00">
        </div>
      </div>

      <div class="flex gap-2" style="margin-top:12px;">
        <button class="btn w-full" id="btn-group-save" onclick="saveGroupMeta()"></button>
        <button class="btn btn-sec w-full" id="btn-group-cancel" onclick="toggleGroupEdit(false)"></button>
      </div>
    </div>

    <hr style="margin:18px 0; border:0; border-top:1px solid var(--border);">
    <h4 id="lbl-group-students" style="margin:0 0 8px 0;"></h4>
    <div id="group-det-students"></div>
  </div>
</div>

<div class="modal-overlay" id="user-modal">
  <div class="modal-content">
    <button class="close-icon" onclick="closeModal('user-modal')"><i class="fa-solid fa-xmark"></i></button>
    <h2 id="lbl-user-modal-title">Benutzer</h2>
    <input type="hidden" id="user-edit-idx">
    <div class="form-group"><label class="form-label">Name</label><input type="text" id="new-user-name" class="form-input" placeholder="Name"></div>
    <div class="form-group"><label class="form-label">PIN</label><input type="text" id="new-user-pin" class="form-input" placeholder="PIN"></div>
    <div class="form-group"><label class="form-label">Rolle</label><select id="new-user-role" class="form-select"><option value="Lehrer">Lehrer (معلم)</option><option value="Admin">Admin (إدارة)</option></select></div>
    <div class="flex gap-2" style="margin-top:1rem;"><button class="btn" onclick="submitUser()" id="btn-save-user">Speichern</button></div>
  </div>
</div>


<div class="modal-overlay" id="lesson-modal">
  <div class="modal-content">
    <button class="close-icon" onclick="closeModal('lesson-modal')"><i class="fa-solid fa-xmark"></i></button>
    
    
    <!-- Immersive (student) overlay controls -->
    <div id="lesson-immersive-handle" class="lesson-immersive-handle" onclick="showLessonImmersiveBar(true)" aria-hidden="true"></div>
    <div id="lesson-immersive-bar" class="lesson-immersive-bar" aria-hidden="true">
      <button class="lesson-immersive-btn" onclick="closeModal('lesson-modal')" title="إغلاق / Schließen">
        <i id="lesson-immersive-backicon" class="fa-solid fa-arrow-left"></i>
      </button>
      <div class="lesson-immersive-title" id="lesson-immersive-title">—</div>
      <div class="lesson-immersive-actions">
        <button class="lesson-immersive-btn" onclick="toggleLessonTranslation()" title="ترجمة / Übersetzung"><i class="fa-solid fa-language"></i></button>
        <button class="lesson-immersive-btn" onclick="playAssignedRange()" title="تشغيل / Play"><i class="fa-solid fa-play"></i></button>
        <button class="lesson-immersive-btn" onclick="stopRangePlayback()" title="إيقاف / Stop"><i class="fa-solid fa-stop"></i></button>
      </div>
    </div>

    <!-- Search Bar for Quran -->
    <div class="quran-search-bar">
      <input type="text" id="lesson-search-input" class="quran-search-input" placeholder="سورة أو آية... / Sure oder Vers..." 
             onkeypress="if(event.key === 'Enter') searchInLesson()">
      <button class="quran-search-btn" onclick="searchInLesson()">بحث / Suche</button>
    </div>

    <!-- Surah Header -->
    <div id="surah-header" class="surah-header">
      <div class="surah-name-arabic" id="surah-name-arabic">الفاتحة</div>
      <div class="surah-name-latin" id="surah-name-latin">Al-Fātiha</div>
      <div class="surah-info">
        <span id="surah-number">الجزء 1</span>
        <span id="surah-verse-count">7 آيات</span>
      </div>
    </div>

    <div class="card" style="display:flex; flex-direction:column; gap:10px;">
      <div class="text-sm text-sec" id="lesson-hint">
        🎧 Play drücken • 📖 Bedeutung lesen
      </div>
      <audio id="lesson-audio" preload="none" style="display:none;"></audio>
      <div class="lesson-memo-player-actions" style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-start;">
        <button class="audio-btn" onclick="playAssignedRange()" id="btn-play-range" title="Play / تشغيل">▶</button>
        <button class="audio-btn sec" onclick="stopRangePlayback()" id="btn-stop-range" title="Stop / إيقاف">■</button>
</div>
    </div>

    <div style="margin-top: 10px;">
      <div class="lesson-view-toolbar">
        <button class="pill-btn" onclick="toggleLessonTranslation()" id="btn-toggle-translation">📝 ترجمة</button>
</div>

      <div id="lesson-verses"></div>
      <div id="lesson-translation" class="lesson-translation hidden"></div>
    </div>
  </div>
</div>


<!-- Student floating reader toggle (stays visible in student mode) -->
<button id="reader-toggle-fab" class="reader-fab hidden" onclick="toggleLessonFab()" aria-label="إخفاء/إظهار نافذة القراءة">
  <i id="reader-fab-icon" class="fa-solid fa-eye"></i>
</button>

<div id="print-container"></div>
<div id="toast">Gespeichert</div>

<!-- Quick Verse Sheet (Meaning / Phonetic) -->
<div id="quick-verse-sheet" class="quick-sheet-overlay" onclick="if(event.target.id==='quick-verse-sheet') hideQuickVerseSheet();">
  <div class="quick-sheet" role="dialog" aria-modal="true">
    <div class="quick-sheet-top">
      <div>
        <div class="quick-sheet-title" id="qvs-title">Vers</div>
        <div class="quick-sheet-sub" id="qvs-sub">Doppeltippen: Bedeutung • 4× Tippen: Phonetik</div>
      </div>
      <div class="quick-sheet-actions">
<button class="quick-sheet-btn quick-sheet-close" title="Schließen" onclick="hideQuickVerseSheet()"><i class="fa-solid fa-xmark"></i></button>
      </div>
    </div>
    <div class="quick-sheet-ar" id="qvs-ar">—</div>
    <div class="quick-sheet-body" id="qvs-body">—</div>
  </div>
</div>


<script>
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycby4li-qZFJCx_0MoXEA6zV390FjD9A9k_-XyZMV2CH4V9CZyhDXjWbGgvdikZVvZoUj/exec'; 


// --- Optimistic UI + background Google Sheets sync (queue + retry) ---
const SYNC_QUEUE_KEY = 'pendingOps_v1';
const SYNC_FAILED_KEY = 'failedOps_v1';

let __pendingOps = [];
let __failedOps  = [];
let __syncProcessing = false;

function __loadQueues(){
  try{ __pendingOps = JSON.parse(localStorage.getItem(SYNC_QUEUE_KEY) || '[]') || []; }catch(e){ __pendingOps = []; }
  try{ __failedOps  = JSON.parse(localStorage.getItem(SYNC_FAILED_KEY) || '[]') || []; }catch(e){ __failedOps = []; }
}

function __saveQueues(){
  try{ localStorage.setItem(SYNC_QUEUE_KEY, JSON.stringify(__pendingOps)); }catch(e){}
  try{ localStorage.setItem(SYNC_FAILED_KEY, JSON.stringify(__failedOps)); }catch(e){}
  __updateCloudIcon();
}

function __updateCloudIcon(){
  const btn = document.getElementById('btn-cloud');
  const badge = document.getElementById('badge-cloud');
  if(!btn) return;

  // If not logged in yet, keep neutral
  if(!state || !state.user){
    btn.classList.remove('cloud-ok','cloud-pending','cloud-error');
    btn.classList.add('cloud-ok');
    btn.title = '—';
    if(badge) badge.classList.add('hidden');
    return;
  }

  const pending = __pendingOps.length;
  const failed  = __failedOps.length;

  btn.classList.remove('cloud-ok','cloud-pending','cloud-error');
  if(failed > 0){
    btn.classList.add('cloud-error');
    btn.title = (state.lang === 'de')
      ? `Nicht gespeichert (${failed}) – klicken für Details`
      : `غير محفوظ (${failed}) – اضغط للتفاصيل`;
    if(badge){
      badge.innerText = String(failed);
      badge.classList.remove('hidden');
    }
  } else if(pending > 0){
    btn.classList.add('cloud-pending');
    btn.title = (state.lang === 'de')
      ? `Speichere… (${pending})`
      : `جارٍ الإرسال… (${pending})`;
    if(badge) badge.classList.add('hidden');
  } else {
    btn.classList.add('cloud-ok');
    btn.title = (state.lang === 'de') ? 'Alles gespeichert' : 'تم حفظ كل شيء';
    if(badge) badge.classList.add('hidden');
  }
}

function enqueueSheetWrite(payload, meta = {}){
  // Ensure idempotency across retries
  try{
    if(payload && typeof payload === 'object' && !payload.requestId){
      payload.requestId = (crypto && crypto.randomUUID) ? crypto.randomUUID() : (Date.now() + '_' + Math.random().toString(16).slice(2));
    }
  }catch(e){}
  __loadQueues();
  const op = {
    id: (crypto && crypto.randomUUID) ? crypto.randomUUID() : (Date.now() + '_' + Math.random().toString(16).slice(2)),
    createdAt: Date.now(),
    attempts: 0,
    maxAttempts: meta.maxAttempts || 1,
    payload: payload,
    label: meta.label || payload?.action || 'write'
  };
  try{ if(op && op.payload && !op.payload.requestId) op.payload.requestId = op.id; }catch(e){}
  __pendingOps.push(op);
  __saveQueues();
  __processQueue();
  return op.id;
}

async function __sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

function getLocalISODate(d = new Date()){
  try{
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }catch(e){
    return '';
  }
}

function getLocalDMYDate(d = new Date()){
  try{
    const dd = String(d.getDate()).padStart(2,'0');
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const yyyy = d.getFullYear();
    return `${dd}.${mm}.${yyyy}`;
  }catch(e){
    return '';
  }
}

function normalizeDateToDMY(input){
  const s = String(input || '').trim();
  if(!s) return '';
  // already dd.mm.yyyy
  let m = s.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})/);
  if(m){
    const dd = String(m[1]).padStart(2,'0');
    const mm = String(m[2]).padStart(2,'0');
    const yyyy = m[3];
    return `${dd}.${mm}.${yyyy}`;
  }
  // yyyy-mm-dd (optionally with time)
  m = s.match(/^(\d{4})-(\d{2})-(\d{2})/);
  if(m){
    const yyyy = m[1], mm = m[2], dd = m[3];
    return `${dd}.${mm}.${yyyy}`;
  }
  // dd/mm/yyyy
  m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
  if(m){
    const dd = String(m[1]).padStart(2,'0');
    const mm = String(m[2]).padStart(2,'0');
    const yyyy = m[3];
    return `${dd}.${mm}.${yyyy}`;
  }
  // fallback parse
  const t = Date.parse(s);
  if(!isNaN(t)){
    return getLocalDMYDate(new Date(t));
  }
  return s;
}

function dateToTS(input){
  const s = String(input || '').trim();
  if(!s) return 0;
  let m = s.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})/);
  if(m){
    const dd = Number(m[1]), mm = Number(m[2]), yyyy = Number(m[3]);
    return new Date(yyyy, mm-1, dd).getTime();
  }
  m = s.match(/^(\d{4})-(\d{2})-(\d{2})/);
  if(m){
    const yyyy = Number(m[1]), mm = Number(m[2]), dd = Number(m[3]);
    return new Date(yyyy, mm-1, dd).getTime();
  }
  const t = Date.parse(s);
  return isNaN(t) ? 0 : t;
}


async function __processQueue(){
  if(__syncProcessing) return;
  __loadQueues();
  if(!state || !state.user) { __updateCloudIcon(); return; }
  if(__pendingOps.length === 0) { __updateCloudIcon(); return; }

  __syncProcessing = true;
  try{
    while(__pendingOps.length > 0){
      __updateCloudIcon();
      const op = __pendingOps[0];

      try{
        const res = await fetch(WEB_APP_URL, {
          method:'POST',
          headers: { "Content-Type": "text/plain" },
          body: JSON.stringify(op.payload)
        }).then(r => r.json()).catch(()=>null);

        if(res && res.ok){
          __pendingOps.shift();
          __saveQueues();
          continue;
        }

        throw new Error((res && res.error) ? String(res.error) : 'no_response');
      }catch(err){
        // IMPORTANT: no immediate retry here. We record the failure once.
        op.attempts = (op.attempts || 0) + 1;

        const failedOp = { ...op, failedAt: Date.now(), lastError: String(err && err.message ? err.message : err) };
        __failedOps.push(failedOp);
        __pendingOps.shift();
        __saveQueues();

        // Soft warning (batch flow may retry later after sync)
        showToast(state.lang === 'de'
          ? `Nicht gespeichert (1 Versuch): ${failedOp.label}. Wird später erneut versucht.`
          : `لم يتم الحفظ (محاولة واحدة): ${failedOp.label}. سيتم إعادة المحاولة لاحقاً.`);
      }
    }
  } finally {
    __syncProcessing = false;
    __updateCloudIcon();
  }
}

function openSyncIssues(){
  __loadQueues();
  __updateCloudIcon();

  if(!state || !state.user) return;

  if(__failedOps.length === 0){
    showToast(state.lang === 'de' ? 'Alles gespeichert.' : 'تم حفظ كل شيء.');
    return;
  }

  const titleEl = document.getElementById('sync-modal-title');
  const bodyEl  = document.getElementById('sync-modal-body');

  const lines = __failedOps.slice(-20).reverse().map(op=>{
    const dt = new Date(op.createdAt);
    const t = dt.toLocaleString('de-DE');
    return `• ${op.label} — ${t}`;
  });

  if(titleEl) titleEl.innerText = (state.lang === 'de') ? 'Nicht gespeicherte Änderungen' : 'تغييرات لم تُحفظ';
  if(bodyEl){
    bodyEl.innerText = (state.lang === 'de')
      ? `Fehlgeschlagene Änderungen (max. 20):\n\n${lines.join('\n')}\n\nBitte wiederhole diese Eingaben manuell.\n\nTipp: Du kannst unten "Wiederholen" drücken, wenn du gerade online bist.`
      : `التغييرات التي فشلت (حد أقصى 20):\n\n${lines.join('\n')}\n\nيرجى إعادة إدخالها يدويًا.\n\nملاحظة: يمكنك الضغط على "إعادة المحاولة" إذا عاد الاتصال.`;
  }

  openModal('sync-modal', {noHistory:true});
}

function retryFailedOps(){
  __loadQueues();
  if(__failedOps.length === 0){
    showToast(state.lang === 'de' ? 'Keine Warnungen.' : 'لا توجد تحذيرات.');
    return;
  }
  // move failed back to pending (keep order)
  __pendingOps = __pendingOps.concat(__failedOps.map(op=>{
    const copy = { ...op };
    delete copy.failedAt;
    copy.attempts = 0;
    return copy;
  }));
  __failedOps = [];
  __saveQueues();
  showToast(state.lang === 'de' ? 'Wiederhole Speichern...' : 'جارٍ إعادة المحاولة...');
  kickSyncQueue();
}

function clearFailedOps(){
  __loadQueues();
  __failedOps = [];
  __saveQueues();
  showToast(state.lang === 'de' ? 'Warnungen gelöscht.' : 'تم مسح التحذيرات.');
  closeModal('sync-modal');
}


// Call this after login or when app becomes active
function kickSyncQueue(){
  __loadQueues();
  __updateCloudIcon();
  __processQueue();
}

// Wait until all queued sheet writes are done (prevents re-sending because of slow Apps Script)
async function waitForSheetWritesComplete({minDelayMs=0, maxWaitMs=60000} = {}){
  const start = Date.now();
  while(true){
    try{ __loadQueues(); }catch(e){}
    const pending = (typeof __pendingOps !== 'undefined') ? (__pendingOps.length || 0) : 0;
    const processing = (typeof __syncProcessing !== 'undefined') ? !!__syncProcessing : false;
    if(!processing && pending === 0) break;
    if(Date.now() - start > maxWaitMs) break;
    await __sleep(450);
  }
  if(minDelayMs > 0){
    const spent = Date.now() - start;
    if(spent < minDelayMs) await __sleep(minDelayMs - spent);
  }
}

let state = {
  user: null,
  role: null,
  lang: 'de',
  darkMode: false,
  students: [],
  attendance: [],
  messages: [],
  teachers: [],
  allUsers: [],
  studentInfos: [],
  documents: [],
  filter: { groups: [], days: [], search: '', financial: false, abgemeldet: false, waitlistOnly: false },
  filteredStudents: [],
  filteredWaitlist: [],
  adminBranch: 'groups',
  loginMode: 'auto',
  studentData: null,
  currentDetailStudent: null,
  parentAbsencesToday: [],
  parentAbsentSet: new Set(),
  lastId: '',
  groupMeta: {},
  currentGroupDetail: null,
  groupDetailEdit: false
};
let editingStudent = null; 
let msgPollingInterval = null;
let msgBgPollingInterval = null;
let studentPollingInterval = null;
let studentPollingPrimed = false;
let selectedForAttendance = new Set();
let editingUserIdx = null; 

// FLOATING AUDIO PLAYER STATE
let floatingAudio = {
  element: null,
  title: '',
  currentSurah: null,
  currentAyah: 1,
  totalAyahs: 0,
  verseList: [],
  repeatCount: 1,
  repeatLeft: 0,
  isPlaying: false,
  audioElement: null,
  mode: 'single'
};


// --- Ensure floating audio player is at top-level (above any modal overlays) ---
(function ensureFloatingAudioOnBody(){
  try{
    const p = document.getElementById('floating-audio-player');
    if(!p) return;
    // Move to <body> to avoid being trapped under parent stacking contexts.
    if(p.parentElement && p.parentElement !== document.body){
      document.body.appendChild(p);
    }
    // Always allow interaction above overlays
    p.style.pointerEvents = 'auto';
  }catch(e){}
})();

// Attach an existing <audio> element to the floating player (pause/resume controls always visible)
function attachFloatingPlayerToAudio(audioEl, opts={}) {
  if(!audioEl) return;
  floatingAudio.audioElement = audioEl;
  floatingAudio.mode = opts.mode || floatingAudio.mode || 'single';
  if(opts.title) document.getElementById('floating-audio-title').textContent = opts.title;
  if(opts.info)  document.getElementById('floating-audio-info').textContent  = opts.info;

  // Keep repeat available (works for single ayah and for assigned ranges)
  const rep = document.getElementById('floating-audio-repeat');
  if(rep) rep.disabled = false;

  // Apply selected speed
  const sp = document.getElementById('floating-audio-speed');
  if(sp && audioEl){
    const v = parseFloat(sp.value);
    audioEl.playbackRate = (v && !isNaN(v)) ? v : 1;
  }

  // Add listeners once per audio element
  if(!audioEl._qsFloatingListenersAdded){
    audioEl.addEventListener('play', () => {
      floatingAudio.isPlaying = true;
      updatePlayPauseButton();
      showFloatingAudio();
    });
    audioEl.addEventListener('pause', () => {
      floatingAudio.isPlaying = false;
      updatePlayPauseButton();
    });
    audioEl.addEventListener('ended', () => {
      floatingAudio.isPlaying = false;
      updatePlayPauseButton();
    });
    audioEl.addEventListener('timeupdate', () => {
      updateFloatingProgress();
    });
    audioEl._qsFloatingListenersAdded = true;
  }

  showFloatingAudio();
  updatePlayPauseButton();
  updateFloatingProgress();
}

function updateFloatingProgress(){
  const a = floatingAudio.audioElement;
  const seek = document.getElementById('floating-audio-seek');

  // Range playback: represent progress by queue index (seek disabled)
  if(floatingAudio.mode === 'range' && rangePlayback && rangePlayback.queue && rangePlayback.queue.length){
    if(seek){
      seek.disabled = true;
      const currentIndex = Math.max(0, (rangePlayback.idx || 0) - 1);
      const pct = (currentIndex / Math.max(1, rangePlayback.queue.length)) * 100;
      seek.value = String(pct);
    }
    return;
  }

  if(seek){
    seek.disabled = false;
    if(a && a.duration && !isNaN(a.duration)){
      seek.value = String((a.currentTime / a.duration) * 100);
    }
  }
}


// WORD-BY-WORD AUDIO (click on a word to hear its pronunciation)
// Quran.com supports word-level audio via "audio_url" inside the "words" array (relative paths like "wbw/001_001_001.mp3").
// We resolve it using the Qurancdn base.
// Docs: https://api-docs.quran.foundation/docs/content_apis_versioned/verses-by-verse-key/
const WBW_AUDIO_BASE = 'https://audio.qurancdn.com/';

// Build a deterministic WBW audio path from verseKey + word position.
// This avoids rare cases where API-provided audio_url can mismatch a token.
// Pattern: wbw/002_080_008.mp3  (3-digit surah, ayah, word index)
function __wbwPad3(n){
  n = parseInt(n,10);
  if(!n || isNaN(n)) n = 0;
  return String(n).padStart(3,'0');
}
function __wbwBuildAudioPath(verseKey, pos){
  try{
    const parts = String(verseKey||'').split(':');
    const s = parseInt(parts[0],10);
    const a = parseInt(parts[1],10);
    const p = parseInt(pos,10);
    if(!s || !a || !p) return '';
    return `wbw/${__wbwPad3(s)}_${__wbwPad3(a)}_${__wbwPad3(p)}.mp3`;
  }catch(e){
    return '';
  }
}

const __wbwWordCache = new Map(); // verseKey -> words[]

function __resolveWbwAudioUrl(audioPath){
  if(!audioPath) return '';
  if(/^https?:\/\//i.test(audioPath)) return audioPath;
  const cleaned = String(audioPath).replace(/^\/+/, '');
  return WBW_AUDIO_BASE + cleaned;
}

async function __fetchWbwWordsForVerse(verseKey){
  if(__wbwWordCache.has(verseKey)) return __wbwWordCache.get(verseKey);

  const url = `https://api.quran.com/api/v4/verses/by_key/${encodeURIComponent(verseKey)}?words=true&word_fields=audio_url,text_uthmani,char_type_name,position&fields=text_uthmani`;
  const res = await fetch(url);
  if(!res.ok) throw new Error('WBW request failed: ' + res.status);
  const json = await res.json();
  const words = (json && json.verse && Array.isArray(json.verse.words)) ? json.verse.words : [];
  __wbwWordCache.set(verseKey, words);
  return words;
}

// Single audio element for WBW playback
let __wbwAudioEl = null;
let __wbwResumeMain = null;

function __ensureWbwAudioEl(){
  if(__wbwAudioEl) return __wbwAudioEl;
  __wbwAudioEl = new Audio();
  __wbwAudioEl.preload = 'none';

  __wbwAudioEl.addEventListener('ended', () => {
    try{ document.querySelectorAll('.ayah-word.playing').forEach(s => s.classList.remove('playing')); }catch(e){}
    try{ if(typeof __wbwResumeMain === 'function') __wbwResumeMain(); }catch(e){}
    __wbwResumeMain = null;
  });

  __wbwAudioEl.addEventListener('error', () => {
    try{ document.querySelectorAll('.ayah-word.playing').forEach(s => s.classList.remove('playing')); }catch(e){}
    try{ if(typeof __wbwResumeMain === 'function') __wbwResumeMain(); }catch(e){}
    __wbwResumeMain = null;
  });

  return __wbwAudioEl;
}

// Fallback: browser TTS (works only if the device has an Arabic voice installed)
function __speakWordFallback(word){
  if(!word) return;
  if(!('speechSynthesis' in window)) return;
  try{ window.speechSynthesis.cancel(); }catch(e){}
  try{
    const u = new SpeechSynthesisUtterance(word);
    u.lang = 'ar-SA';
    // Try to honor the current speed selector roughly
    const sp = document.getElementById('floating-audio-speed');
    if(sp){
      const r = parseFloat(sp.value);
      if(r && !isNaN(r)) u.rate = Math.max(0.6, Math.min(1.6, r));
    }
    window.speechSynthesis.speak(u);
  }catch(e){}
}

function __playWbwWordFromSpan(span){
  if(!span) return;
  const audioPath = (span.dataset.audioGen || span.dataset.audio || '');
  const wordText  = span.dataset.word  || span.textContent || '';

  const url = __resolveWbwAudioUrl(audioPath);
  if(!url){
    __speakWordFallback(wordText);
    return;
  }

  // Highlight
  try{ document.querySelectorAll('.ayah-word.playing').forEach(s => s.classList.remove('playing')); }catch(e){}
  span.classList.add('playing');

  // Pause any main audio (range playback / lesson audio) while WBW plays to avoid overlap
  const main = (floatingAudio && floatingAudio.audioElement) ? floatingAudio.audioElement : null;
  const lessonA = document.getElementById('lesson-audio');
  const koranA  = document.getElementById('koranAudio');

  const wasMainPlaying   = !!(main && !main.paused);
  const wasLessonPlaying = !!(lessonA && !lessonA.paused);
  const wasKoranPlaying  = !!(koranA && !koranA.paused);

  // Suspend auto-advance in range playback while WBW is active
  try{ rangePlayback._suspendedByWbw = true; }catch(e){}

  __wbwResumeMain = () => {
    try{ rangePlayback._suspendedByWbw = false; }catch(e){}
    if(wasMainPlaying && main){ main.play().catch(()=>{}); }
    if(wasLessonPlaying && lessonA && lessonA !== main){ lessonA.play().catch(()=>{}); }
    if(wasKoranPlaying && koranA && koranA !== main){ koranA.play().catch(()=>{}); }
  };

  try{ if(wasMainPlaying && main) main.pause(); }catch(e){}
  try{ if(wasLessonPlaying && lessonA) lessonA.pause(); }catch(e){}
  try{ if(wasKoranPlaying && koranA) koranA.pause(); }catch(e){}

  const a = __ensureWbwAudioEl();
  try{
    // Set speed similar to main player speed
    const sp = document.getElementById('floating-audio-speed');
    if(sp){
      const rate = parseFloat(sp.value);
      a.playbackRate = (rate && !isNaN(rate)) ? rate : 1;
    } else {
      a.playbackRate = 1;
    }

    if(a.src !== url) a.src = url;
    a.currentTime = 0;
    a.play().catch(() => __speakWordFallback(wordText));
  }catch(e){
    __speakWordFallback(wordText);
  }
}

function __pickWordSpanFromPoint(container, clientX, clientY){
  if(!container) return null;
  const spans = container.querySelectorAll('.ayah-word');
  if(!spans || !spans.length) return null;

  let best = null;
  let bestScore = Infinity;

  spans.forEach(sp => {
    const r = sp.getBoundingClientRect();
    // distance from point to rect (0 if inside)
    const dx = (clientX < r.left) ? (r.left - clientX) : (clientX > r.right ? (clientX - r.right) : 0);
    const dy = (clientY < r.top) ? (r.top - clientY) : (clientY > r.bottom ? (clientY - r.bottom) : 0);
    const score = (dx*dx) + (dy*dy);

    if(score < bestScore){
      bestScore = score;
      best = sp;
    }
  });

  return best;
}

// Render clickable words inside a container using Quran.com "words" data (audio_url + text_uthmani)
function __renderClickableAyahWords(container, verseKey, fallbackAyahText){
  if(!container) return;

  // show something immediately
  container.textContent = fallbackAyahText || '';
  container.dataset.verseKey = verseKey;

  __fetchWbwWordsForVerse(verseKey).then(words => {
    if(!Array.isArray(words) || words.length === 0) return;

    // Build spans
    container.innerHTML = '';
    const frag = document.createDocumentFragment();

    words.forEach(w => {
      const ct = (w && w.char_type_name) ? String(w.char_type_name) : '';
      // Keep "word" and also clitics if the API returns them (prefix/suffix).
      if(ct && !['word','prefix','suffix'].includes(ct)) return;

      const txt = (w && (w.text_uthmani || w.text)) ? String(w.text_uthmani || w.text).trim() : '';
      if(!txt) return;

      // Skip pure number markers if any (just in case)
      if(/^[0-9\u0660-\u0669]+$/.test(txt)) return;

      const sp = document.createElement('span');
      sp.className = 'ayah-word';
      sp.textContent = txt;
      sp.dataset.word = txt;
      const __pos = (w && w.position != null) ? String(w.position) : '';
      sp.dataset.pos = __pos;
      // Prefer deterministic path based on verseKey + position
      sp.dataset.audioGen = (__pos ? __wbwBuildAudioPath(verseKey, __pos) : '');
      // Keep API audio_url as a fallback
      sp.dataset.audio = (w && w.audio_url) ? String(w.audio_url) : '';

      frag.appendChild(sp);
      frag.appendChild(document.createTextNode(' '));
    });

if(!frag.childNodes.length){
      container.textContent = fallbackAyahText || '';
      return;
    }

    container.appendChild(frag);
    // Delegate clicks to the closest word span (more reliable for short words like حروف الجر)
    if(!container.__wbwDelegated){
      container.__wbwDelegated = true;
      container.addEventListener('click', (e) => {
        const sp = __pickWordSpanFromPoint(container, e.clientX, e.clientY) ||
                   (e.target && e.target.closest ? e.target.closest('.ayah-word') : null);
        if(!sp) return;
        e.preventDefault();
        e.stopPropagation();
        __playWbwWordFromSpan(sp);
      }, true);
    }
  }).catch(() => {
    // keep fallback text
  });
}




// --- Arabic -> simple phonetic (Arabizi-style) for memorization helper ---
function __arabicToPhonetic(input){
  try{
    if(!input) return '';
    // Normalize Arabic presentation forms & remove Quranic symbols that aren't letters
    let s = String(input);

    // Remove ayah markers, punctuation, tatweel
    s = s.replace(/[\u06DD\u06DE\u06E9\u06D6-\u06ED\u0640]/g, ' ');
    // Normalize some characters
    s = s.replace(/[ٱ]/g,'ا').replace(/[ى]/g,'ي');

    // Keep harakat for vowel heuristics
    const FATHA = '\u064E';
    const DAMMA = '\u064F';
    const KASRA = '\u0650';
    const SUKUN = '\u0652';
    const SHADDA = '\u0651';
    const TANWIN_F = '\u064B';
    const TANWIN_D = '\u064C';
    const TANWIN_K = '\u064D';

    const isMark = (ch)=> /[\u064B-\u0652\u0670]/.test(ch); // includes dagger alif
    const baseMap = {
      'ا':'a','ب':'b','ت':'t','ث':'t','ج':'j','ح':'7','خ':'5',
      'د':'d','ذ':'d','ر':'r','ز':'z','س':'s','ش':'sh','ص':'s','ض':'d',
      'ط':'t','ظ':'z','ع':'3','غ':'8','ف':'f','ق':'9','ك':'k','ل':'l','م':'m',
      'ن':'n','ه':'h','ة':'h','و':'w','ي':'y','ء':'', 'ئ':'', 'ؤ':'', 'أ':'', 'إ':'', 'آ':'a'
    };

    const out = [];
    const chars = Array.from(s);

    // Helper: get combining marks following index i
    function collectMarks(i){
      let j=i+1, marks='';
      while(j<chars.length && isMark(chars[j])){ marks+=chars[j]; j++; }
      return marks;
    }
    function nextBaseIndex(i){
      let j=i+1;
      while(j<chars.length && isMark(chars[j])) j++;
      return j;
    }

    for(let i=0;i<chars.length;i++){
      const ch = chars[i];
      if(ch === '\u0000') continue;

      // spaces / punctuation
      if(/\s/.test(ch)) { out.push(' '); continue; }
      if(/[0-9\u0660-\u0669]/.test(ch)) continue; // ignore numbers
      if(isMark(ch)) continue;

      const marks = collectMarks(i);
      const nb = chars[nextBaseIndex(i)] || '';

      // base consonant (special-case lam-alif ligature)
      if(ch === 'ﻻ' || ch === 'لا'){ out.push('la'); continue; }

      let cons = baseMap[ch] != null ? baseMap[ch] : ch;

      // Shadda doubles consonant (except multi-letter digraphs)
      if(marks.includes(SHADDA)){
        cons = cons + cons;
      }

      // Determine vowel from marks (support tanween as -n endings)
      let vowel = '';
      if(marks.includes(TANWIN_F)) vowel = 'an';
      else if(marks.includes(TANWIN_K)) vowel = 'in';
      else if(marks.includes(TANWIN_D)) vowel = 'on';
      else if(marks.includes(FATHA) || marks.includes('\u0670')) vowel = 'a';
      else if(marks.includes(KASRA)) vowel = 'i';
      else if(marks.includes(DAMMA)) vowel = 'o';
      else if(marks.includes(SUKUN)) vowel = '';

// Long vowel heuristics: FATHA + ا , KASRA + ي , DAMMA + و
      // To match user style (9ol a3odo) we keep single vowel letter and skip the long-vowel carrier.
      const v0 = vowel ? vowel[0] : '';
      if(v0 && ((v0==='a' && nb==='ا') || (v0==='i' && nb==='ي') || (v0==='o' && nb==='و'))){
        // skip the carrier on next iteration
        // mark next base char as consumed by replacing it with space
        chars[nextBaseIndex(i)] = '\u0000';
      }

      // If this is a carrier letter without its own vowel marks, render as vowel-ish in some contexts
      if((ch==='و' || ch==='ي') && !vowel && !marks){
        // default to 'o' or 'i' when used as vowel
        // simple heuristic: if previous output ends with consonant, treat as vowel
        const prev = out.length ? out[out.length-1] : '';
        if(ch==='و') cons = 'o';
        if(ch==='ي') cons = 'i';
      }

      // Special-case ta marbuta at end-of-word: prefer waqf form "...ah" and ignore tanween endings
      if(ch === 'ة'){
        const nextBase = nb;
        const endWord = (!nextBase) || /\s/.test(nextBase) || /[\.,;:!\?،؛؟]/.test(nextBase);
        if(endWord){
          out.push('ah');
          continue;
        }
      }

out.push(cons + vowel);
    }

    // cleanup spaces
    return out.join('')
      .replace(/\s+/g,' ')
      .replace(/(^\s+|\s+$)/g,'');
  }catch(e){
    return String(input || '');
  }
}

// I18N
const i18n = {
  ar: {
    loginTitle: "تسجيل الدخول",
    loginBtn: "دخول",
    title: "طلاب دار القرآن",
    sync: "جاري المزامنة...",
    syncDone: "آخر تحديث: ",
    search: "ابحث بالاسم، الولي، الهاتف...",
    groups: "الأقسام",
    days: "أيام الدراسة",
    capWarn: "القسم ممتلئ",
    sendMsg: "إرسال رسالة",
    statsTitle: "الإحصائيات",
    totalStud: "عدد الطلاب الكلي",
    absentToday: "عدد الغياب لليوم",
    attendedToday: "عدد الحضور لليوم",
    presentCount: "عدد الحضور",
    navStud: "الطلاب",
    navComm: "التواصل",
    navStats: "إحصاء",
    navDocs: "وثائق",
navHw: "الواجبات",
hwAdminTitle: "الواجبات المنزلية",
hwPickGroup: "اختر القسم",
hwPickDay: "اختر اليوم",
hwLoadStudents: "عرض الطلاب",
hwUseFilter: "استخدام الفلتر الحالي",
hwSelectAll: "تحديد الكل",
hwAssign: "إرسال الواجب",
hwTypeMem: "حفظ من الآية… إلى الآية…",
hwTypeText: "نص حر",
hwSearchStud: "بحث طالب...",
    docsTitle: "الوثائق",
    absentAlert: "هذا التلميذ تغيب 3 مرات متتالية، اتصل بالولي.",
    btnAbsent: "غياب",
    btnLate: "تأخير",
    lateToday: "تأخير اليوم",
    repeatedAbs: "غياب متكرر",
    printStud: "طباعة هذا التلميذ",
    editStud: "تعديل",
    save: "حفظ",
    cancel: "إلغاء",
    delete: "مسح الطالب",
    newMsg: "جديد",
    msgTo: "إلى",
    msgFrom: "من",
    saved: "تم الحفظ بنجاح",
    error: "حدث خطأ",
    expected: "المتوقع",
    confirmDelete: "هل أنت متأكد أنك تريد مسح هذا الطالب؟",
    studentNotes: "ملاحظات المعلم",
    addNote: "إضافة ملاحظة",
    l_referenz: "رقم الطالب",
    l_lastName: "اللقب",
    l_firstName: "الاسم",
    l_geburtsdatum: "تاريخ الميلاد", 
    l_parentName: "الولي",
    l_phone: "الهاتف",
    l_email: "البريد",
    l_days: "الأيام",
    l_group: "القسم", 
    l_warteliste: "Warteliste (الانتظار)",
    l_iban: "IBAN",
    l_betrag: "المبلغ",
    l_alter: "العمر",
    l_gender: "الجنس",
    l_infos: "ملاحظات",
    l_fotoUrl: "رابط الصورة",
    l_abgemeldet: "منسحب (x)",
    l_kontrolleBank: "البنك (J)",
    l_finanzMark: "المالية (Y)",
    sendBatch: "إرسال",
    navUsers: "الإدارة",
    manageUsers: "الإدارة",
    addUser: "إضافة مستخدم",
    editUser: "تعديل مستخدم",
    role: "الدور",
    pin: "الرمز السري",
    name: "الاسم",
    visibleToTeacher: "يظهر للمعلم؟",
    userPlaceholder: "اسم المستخدم",
    pinPlaceholder: "PIN",
    confirmDelUser: "هل أنت متأكد من حذف هذا المستخدم؟",
    lblFinProb: "مشاكل دفع",
    lblAbgemeldet: "إظهار المنسحبين",
    lblWaitlistOnly: "قائمة الانتظار",
    branchUsers: "المستخدمون",
    branchWaitlist: "قائمة الإنتظار",
    branchGroups: "الأقسام",
    waitlistHint: "طلاب قائمة الإنتظار (العمود U في الشيت SCHUELER_STAMMDATEN). اضغط على الاسم لعرض التفاصيل.",
    groupsHint: "الأحمر = ممتلئ • الأخضر = يوجد أماكن. نفس الفلتر في الأعلى يطبق هنا.",
    emptyWaitlist: "لا يوجد طلاب في قائمة الإنتظار حسب الفلتر الحالي.",
    emptyGroups: "لا توجد أقسام مطابقة للفلتر الحالي.",
    groupDetailsTitle: "تفاصيل القسم",
    groupEditEnable: "تفعيل التعديل",
    groupEditDisable: "إيقاف التعديل",
    groupTeacher: "الأستاذ",
    groupTimeFrom: "من",
    groupTimeTo: "إلى",
    groupMax: "الحد الأقصى",
    groupStudentsIn: "طلاب هذا القسم"

  },
  de: {
    loginTitle: "Anmelden",
    loginBtn: "Einloggen",
    title: "Koran-Schule Schüler",
    sync: "Synchronisiere...",
    syncDone: "Letztes Update: ",
    search: "Suche Name, Eltern, Tel...",
    groups: "Gruppen",
    days: "Unterrichtstage",
    capWarn: "Gruppe voll",
    sendMsg: "Nachricht senden",
    statsTitle: "Statistiken",
    totalStud: "Gesamtzahl Schüler",
    absentToday: "Fehlzeiten heute",
    attendedToday: "Anwesenheit heute",
    presentCount: "Anwesend",
    navStud: "Schüler",
    navComm: "Komm.",
    navStats: "Statistik",
    navDocs: "Doku",
navHw: "Aufgaben",
hwAdminTitle: "Hausaufgaben",
hwPickGroup: "Gruppe wählen",
hwPickDay: "Tag wählen",
hwLoadStudents: "Schüler anzeigen",
hwUseFilter: "Aktuellen Filter verwenden",
hwSelectAll: "Alle auswählen",
hwAssign: "Hausaufgabe senden",
hwTypeMem: "Auswendig (Von–Bis)",
hwTypeText: "Freier Text",
hwSearchStud: "Schüler suchen...",
    docsTitle: "Dokumente",
    absentAlert: "Schüler fehlt 3x in Folge. Eltern kontaktieren.",
    btnAbsent: "Abwesend",
    btnLate: "Verspätet",
    lateToday: "Verspätet heute",
    repeatedAbs: "Häufiges Fehlen",
    printStud: "Drucken",
    editStud: "Bearbeiten",
    save: "Speichern",
    cancel: "Abbrechen",
    delete: "Schüler löschen",
    newMsg: "NEU",
    msgTo: "An",
    msgFrom: "Von",
    saved: "Erfolgreich gespeichert",
    error: "Fehler aufgetreten",
    expected: "Erwartet",
    confirmDelete: "Sind Sie sicher, dass Sie diesen Schüler löschen möchten?",
    studentNotes: "Lehrer Notizen",
    addNote: "Notiz hinzufügen",
    l_referenz: "Student ID",
    l_lastName: "Nachname",
    l_firstName: "Vorname",
    l_geburtsdatum: "Geburtsdatum", 
    l_parentName: "Eltern",
    l_phone: "Telefon",
    l_email: "Email",
    l_days: "Tage",
    l_group: "Gruppe", 
    l_warteliste: "Warteliste",
    l_iban: "IBAN",
    l_betrag: "Betrag",
    l_alter: "Alter",
    l_gender: "Geschlecht",
    l_infos: "Infos",
    l_fotoUrl: "Foto URL",
    l_abgemeldet: "Abgemeldet (x)",
    l_kontrolleBank: "Kontrolle Bank (J)",
    l_finanzMark: "Finanz Markierung (Y)",
    sendBatch: "Senden",
    navUsers: "Verwaltung",
    manageUsers: "Verwaltung",
    addUser: "Nutzer hinzufügen",
    editUser: "Nutzer bearbeiten",
    role: "Rolle",
    pin: "PIN",
    name: "Name",
    visibleToTeacher: "Sichtbar für Lehrer?",
    userPlaceholder: "Benutzername",
    pinPlaceholder: "PIN",
    confirmDelUser: "Benutzer wirklich löschen?",
    lblFinProb: "Zahlungsprobleme",
    lblAbgemeldet: "Abgemeldete anzeigen",
    lblWaitlistOnly: "Warteliste",
    branchUsers: "Benutzer",
    branchWaitlist: "Warteliste",
    branchGroups: "Gruppen",
    waitlistHint: "Warteliste (Spalte U in SCHUELER_STAMMDATEN). Namen anklicken für Details.",
    groupsHint: "Rot = voll • Grün = frei. Der Filter oben gilt auch hier.",
    emptyWaitlist: "Keine Schüler in der Warteliste (Filter).",
    emptyGroups: "Keine Gruppen passend zum Filter.",
    groupDetailsTitle: "Gruppendetails",
    groupEditEnable: "Bearbeiten aktivieren",
    groupEditDisable: "Bearbeiten deaktivieren",
    groupTeacher: "Lehrer",
    groupTimeFrom: "Von",
    groupTimeTo: "Bis",
    groupMax: "Max. Schüler",
    groupStudentsIn: "Schüler in dieser Gruppe"

  }
};

function t(key) { return i18n[state.lang][key] || key; }

// --- FLOATING AUDIO PLAYER FUNCTIONS ---

function expandFloatingAudioPanel(){
  const p = document.getElementById('floating-audio-player');
  if(!p) return;
  p.classList.add('expanded');
  p.classList.remove('collapsed');
}
function collapseFloatingAudioPanel(){
  const p = document.getElementById('floating-audio-player');
  if(!p) return;
  p.classList.remove('expanded');
  p.classList.add('collapsed');
}
function audioFabClick(){
  // No audio attached yet → do nothing
  if(!floatingAudio.audioElement){
    // try to hook to lesson audio if it's playing
    const la = document.getElementById('lesson-audio');
    if(la){
      attachFloatingPlayerToAudio(la, { mode:'range' });
    } else {
      return;
    }
  }

  // If playing: pause + open controls (as requested)
  if(floatingAudio.isPlaying){
    try{ floatingAudio.audioElement.pause(); }catch(e){}
    expandFloatingAudioPanel();
    return;
  }

  // If paused: play + keep minimized
  try{ floatingAudio.audioElement.play().catch(()=>{}); }catch(e){}
  collapseFloatingAudioPanel();
}

function showFloatingAudio() {
  const p = document.getElementById('floating-audio-player');
  if(!p) return;
  p.classList.add('show');
  // keep it minimized by default
  if(!p.classList.contains('expanded')) p.classList.add('collapsed');
}

function hideFloatingAudio() {
  const p = document.getElementById('floating-audio-player');
  if(p){ p.classList.remove('show'); p.classList.remove('expanded'); p.classList.add('collapsed'); }
// stop range playback (if active)
  try {
    if (rangePlayback) rangePlayback.active = false;
  } catch(e) {}

  if (floatingAudio.audioElement) {
    floatingAudio.audioElement.pause();
    floatingAudio.isPlaying = false;
    updatePlayPauseButton();
  }
}

// Keep the floating player visible while the memorization modal is open
function __syncLessonMemoPlayer(isOpen){
  try{
    const modal = document.getElementById('lesson-modal');
    const vm = modal ? (modal.dataset.viewMode || '') : '';

    // Memorization (Hausaufgaben) overlay behavior
    if(vm === 'memorize'){
      const fp = document.getElementById('floating-audio-player');

      if(isOpen){
        document.body.classList.add('lesson-memo-open');

        // Make sure the floating player is visible فوق نافذة الحفظ
        if(fp){
          fp.classList.add('show');
          fp.classList.add('expanded');
          fp.classList.remove('collapsed');
        }

        // Default to infinite loop for memorization range (repeat all)
        const rep = document.getElementById('floating-audio-repeat');
        if(rep){
          try{
            if(!Array.from(rep.options || []).some(o => String(o.value) === 'inf')){
              const opt = document.createElement('option');
              opt.value = 'inf';
              opt.textContent = '∞';
              rep.appendChild(opt);
            }
          }catch(e){}
          rep.value = 'inf';
        }

        // Attach floating player to lesson audio (even if paused) so speed works immediately
        const la = document.getElementById('lesson-audio');
        if(la){
          attachFloatingPlayerToAudio(la, {
            mode:'single',
            title: (state.lang === 'de') ? 'Hausaufgaben Audio' : 'صوت الحفظ',
            info: (state.lang === 'de') ? 'Bereit' : 'جاهز'
          });
        }
        return;
      }

      // Closing memorization overlay: KEEP audio playing + keep player visible
      document.body.classList.remove('lesson-memo-open');
      if(fp){
        fp.classList.add('show');
        // keep as a small floating card when the modal is closed
        fp.classList.remove('expanded');
        fp.classList.add('collapsed');
      }
      return;
    }

    // Non-memorize view: original behavior
    if(isOpen){
      return;
    }

    document.body.classList.remove('lesson-memo-open');

    // Clean up lesson audio bindings (only when not memorize)
    const la = document.getElementById('lesson-audio');
    try{
      if(la){
        la.onended = null;
      }
    }catch(e){}

    // Hide only if the floating player is currently attached to the lesson audio
    try{
      if(window.floatingAudio && la && floatingAudio.audioElement === la){
        hideFloatingAudio();
      }
    }catch(e){}
  }catch(e){}
}



function setupFloatingAudio(surah, start, end, verses) {
  floatingAudio.mode = 'single';
  floatingAudio.currentSurah = surah;
  floatingAudio.currentAyah = start;
  floatingAudio.verseList = verses;
  floatingAudio.totalAyahs = verses.length;
  floatingAudio.repeatLeft = parseInt(document.getElementById('floating-audio-repeat').value) || 1;
  
  const surahInfo = getSurahInfo(surah);
  document.getElementById('floating-audio-title').textContent = 
    `${surahInfo.arabic} - ${surahInfo.latin} (${start}-${end})`;
  
  showFloatingAudio();
  playCurrentAyah();
}

function playCurrentAyah() {
  if (floatingAudio.currentAyah < 1 || floatingAudio.currentAyah > floatingAudio.totalAyahs) {
    hideFloatingAudio();
    return;
  }

  const verse = floatingAudio.verseList[floatingAudio.currentAyah - 1];
  if (!verse || !verse.audio_url) return;

  // Create audio element if needed
  if (!floatingAudio.audioElement || floatingAudio.mode !== 'single') {
    floatingAudio.audioElement = new Audio();
  }
  floatingAudio.mode = 'single';

  const surahInfo = getSurahInfo(floatingAudio.currentSurah);
  attachFloatingPlayerToAudio(floatingAudio.audioElement, {
    mode: 'single',
    title: `${surahInfo.arabic} - ${surahInfo.latin}`,
    info: `سورة ${surahInfo.arabic} - آية ${floatingAudio.currentAyah}`
  });

  // (Re)bind ended handler for playlist+repeat
  floatingAudio.audioElement.onended = () => {
    floatingAudio.repeatLeft--;
    if (floatingAudio.repeatLeft > 0) {
      floatingAudio.audioElement.currentTime = 0;
      floatingAudio.audioElement.play().catch(()=>{});
      return;
    }
    floatingAudio.repeatLeft = parseInt(document.getElementById('floating-audio-repeat').value) || 1;
    if (floatingAudio.currentAyah < floatingAudio.totalAyahs) {
      floatingAudio.currentAyah++;
      playCurrentAyah();
    } else {
      hideFloatingAudio();
      showToast(state.lang === 'de' ? 'Lektion beendet' : 'انتهت الدرس');
    }
  };

  floatingAudio.audioElement.src = verse.audio_url;
  floatingAudio.audioElement.play().then(() => {
    floatingAudio.isPlaying = true;
    updatePlayPauseButton();
    updateFloatingProgress();
  }).catch(() => {});
}

function previousAyah() {
  if (floatingAudio.mode === 'range' && rangePlayback && rangePlayback.active && typeof rangePlayback._playNext === 'function') {
    // idx points to the next ayah -> go back one
    rangePlayback.idx = Math.max(0, (rangePlayback.idx || 0) - 2);
    rangePlayback._playNext();
    return;
  }

  if (floatingAudio.currentAyah > 1) {
    floatingAudio.currentAyah--;
    floatingAudio.repeatLeft = parseInt(document.getElementById('floating-audio-repeat').value) || 1;
    playCurrentAyah();
  }
}

function nextAyah() {
  if (floatingAudio.mode === 'range' && rangePlayback && rangePlayback.active && typeof rangePlayback._playNext === 'function') {
    rangePlayback._playNext();
    return;
  }

  if (floatingAudio.currentAyah < floatingAudio.totalAyahs) {
    floatingAudio.currentAyah++;
    floatingAudio.repeatLeft = parseInt(document.getElementById('floating-audio-repeat').value) || 1;
    playCurrentAyah();
  } else {
    hideFloatingAudio();
    showToast(state.lang === 'de' ? 'Lektion beendet' : 'انتهت الدرس');
  }
}

function togglePlayPause() {
  // If something is playing in the lesson player (range playback), hook it automatically
  if (!floatingAudio.audioElement) {
    const la = document.getElementById('lesson-audio');
    if (la && !la.paused) {
      attachFloatingPlayerToAudio(la, { mode: 'range' });
    } else {
      return;
    }
  }

  if (floatingAudio.isPlaying) {
    floatingAudio.audioElement.pause();
  } else {
    floatingAudio.audioElement.play().catch(()=>{});
  }
}

function updatePlayPauseButton() {
  const btn = document.getElementById('btn-play-pause');
  const fabIcon = document.getElementById('audio-fab-icon');

  const isPlaying = !!floatingAudio.isPlaying;

  if (btn) btn.textContent = isPlaying ? '❚❚' : '▶';
  if (fabIcon) fabIcon.className = isPlaying ? 'fa-solid fa-pause' : 'fa-solid fa-play';
}

// Update floating audio repeat count when changed
document.getElementById('floating-audio-repeat')?.addEventListener('change', function() {
  floatingAudio.repeatLeft = parseInt(this.value) || 1;
});


// Seekbar + Speed controls
(function wireFloatingAudioExtraControls(){
  const seek = document.getElementById('floating-audio-seek');
  if(seek){
    seek.addEventListener('input', ()=>{
      const a = floatingAudio.audioElement;
      if(!a || !a.duration || isNaN(a.duration) || floatingAudio.mode === 'range') return;
      const pct = parseFloat(seek.value) / 100;
      a.currentTime = Math.max(0, Math.min(a.duration, pct * a.duration));
    });
  }

  const speed = document.getElementById('floating-audio-speed');
  if(speed){
    speed.addEventListener('change', ()=>{
      const a = floatingAudio.audioElement;
      if(!a) return;
      const v = parseFloat(speed.value);
      a.playbackRate = (v && !isNaN(v)) ? v : 1;
    });
  }
})();

// --- LOGIN LOGIC ---
function rememberedKey(){ return 'qs_remember_v1'; }

// Saved profiles store (multi account on same device)
function profilesKey(){ return 'qs_profiles_v1'; }

function getSavedProfiles(){
  try{
    const raw = localStorage.getItem(profilesKey());
    if(!raw) return [];
    const arr = JSON.parse(raw);
    return Array.isArray(arr) ? arr : [];
  }catch(e){ return []; }
}

function setSavedProfiles(arr){
  try{ localStorage.setItem(profilesKey(), JSON.stringify(arr || [])); }catch(e){}
}

function initialsFromName(name){
  const s = (name || '').trim();
  if(!s) return '👤';
  const parts = s.split(/\s+/).filter(Boolean);
  const a = parts[0]?.[0] || '';
  const b = parts.length>1 ? (parts[parts.length-1]?.[0] || '') : (parts[0]?.[1] || '');
  const out = (a + b).toUpperCase();
  return out || '👤';
}

function displayNameFromProfile(p){
  return (p && (p.displayName || p.userName || p.name)) ? String(p.displayName || p.userName || p.name) : (p?.identifier || '');
}

function upsertSavedProfile(profile){
  if(!profile || !profile.identifier) return;
  const id = String(profile.identifier).trim();
  if(!id) return;

  const arr = getSavedProfiles().filter(p => String(p.identifier||'').trim() !== id);
  const item = {
    identifier: id,
    pin: String(profile.pin || ''),
    displayName: String(profile.displayName || id),
    role: String(profile.role || ''),
    lastType: profile.lastType || null,
    lastUsed: Date.now()
  };
  arr.unshift(item);

  // keep it small
  const max = 10;
  setSavedProfiles(arr.slice(0, max));
  renderSavedProfiles();
}

function removeSavedProfile(identifier){
  const id = String(identifier || '').trim();
  if(!id) return;
  const arr = getSavedProfiles().filter(p => String(p.identifier||'').trim() !== id);
  setSavedProfiles(arr);
  renderSavedProfiles();
}

function renderSavedProfiles(){
  const box = document.getElementById('saved-profiles');
  const list = document.getElementById('saved-profiles-list');
  const title = document.getElementById('lbl-saved-profiles');
  const hint  = document.getElementById('lbl-saved-profiles-hint');
  if(!box || !list) return;

  const arr = getSavedProfiles()
    .slice()
    .sort((a,b) => (b?.lastUsed||0) - (a?.lastUsed||0));

  // Localized labels
  if(title){
    title.textContent = (state.lang === 'ar' ? 'تسجيل سريع' : 'Schnellstart');
  }
  if(hint){
    hint.textContent = (state.lang === 'ar'
      ? 'اضغط على الملف للدخول بسرعة (أو لملء البيانات).'
      : 'Tippe auf ein Profil für schnellen Login (oder zum Ausfüllen).');
  }

  if(arr.length === 0){
    box.classList.add('hidden');
    list.innerHTML = '';
    return;
  }

  box.classList.remove('hidden');
  list.innerHTML = '';

  arr.forEach(p => {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'profile-tile';
    btn.title = (state.lang === 'ar'
      ? 'اضغط لتسجيل الدخول'
      : 'Zum Anmelden tippen');

    const avatar = document.createElement('div');
    avatar.className = 'profile-avatar';
    avatar.textContent = initialsFromName(displayNameFromProfile(p));

    const name = document.createElement('div');
    name.className = 'profile-name';
    name.textContent = displayNameFromProfile(p);

    const sub = document.createElement('div');
    sub.className = 'profile-sub';
    const role = String(p.role||'').toLowerCase();
    sub.textContent = role ? (role.includes('student') ? (state.lang==='ar'?'طالب':'Student') : (state.lang==='ar'?'طاقم':'Staff')) : '';

    const rm = document.createElement('button');
    rm.type = 'button';
    rm.className = 'profile-remove';
    rm.textContent = '×';
    rm.title = (state.lang === 'ar' ? 'حذف' : 'Entfernen');
    rm.addEventListener('click', (ev) => {
      ev.preventDefault();
      ev.stopPropagation();
      removeSavedProfile(p.identifier);
    });

    btn.addEventListener('click', () => {
      const idEl = document.getElementById('login-identifier');
      const pinEl = document.getElementById('login-pin');
      const chk = document.getElementById('chk-remember');

      if(idEl) idEl.value = p.identifier || '';
      if(chk) chk.checked = true; // profile implies "remember me"
      if(pinEl) pinEl.value = p.pin || '';

      // Prefer last type when choosing order
      if(p.lastType) state.loginMode = p.lastType;

      // One-tap login only if we have a stored PIN
      if(p.pin){
        doLogin();
      }else{
        try{ pinEl?.focus(); }catch(e){}
      }
    });

    btn.appendChild(avatar);
    btn.appendChild(name);
    if(sub.textContent) btn.appendChild(sub);
    btn.appendChild(rm);
    list.appendChild(btn);
  });

  // Also update inline dropdown inside the username field
  try{ setupIdentifierDropdown(); }catch(e){}
  try{ renderSavedProfilesDropdown(''); }catch(e){}
}



// --- Saved profiles dropdown inside username input ---
let __idDropdownSetupDone = false;
let __idDropdownOpen = false;

function setupIdentifierDropdown(){
  if(__idDropdownSetupDone) return;
  const idEl = document.getElementById('login-identifier');
  const panel = document.getElementById('id-dropdown-panel');
  const btn = document.getElementById('btn-id-dropdown');
  const wrap = document.getElementById('login-identifier-wrap');
  if(!idEl || !panel || !btn || !wrap) return;
  __idDropdownSetupDone = true;

  btn.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();
    toggleIdDropdown();
  });

  idEl.addEventListener('focus', () => {
    renderSavedProfilesDropdown('');
    showIdDropdownIfAny(true);
  });

  idEl.addEventListener('input', () => {
    renderSavedProfilesDropdown('');
    showIdDropdownIfAny(true);
  });

  idEl.addEventListener('keydown', (ev) => {
    if(ev.key === 'Escape'){
      hideIdDropdown();
    }
  });

  // Close when clicking outside
  document.addEventListener('click', (ev) => {
    if(!wrap.contains(ev.target)){
      hideIdDropdown();
    }
  });
}

function showIdDropdownIfAny(forceShow=false){
  const panel = document.getElementById('id-dropdown-panel');
  if(!panel) return;
  const hasItems = !!panel.querySelector('.dd-item');
  if(!hasItems){
    panel.classList.add('hidden');
    __idDropdownOpen = false;
    return;
  }
  if(forceShow){
    panel.classList.remove('hidden');
    __idDropdownOpen = true;
  }
}

function toggleIdDropdown(){
  const panel = document.getElementById('id-dropdown-panel');
  const idEl = document.getElementById('login-identifier');
  if(!panel || !idEl) return;

  renderSavedProfilesDropdown('');
  const hasItems = !!panel.querySelector('.dd-item');

  if(!hasItems){
    panel.classList.add('hidden');
    __idDropdownOpen = false;
    return;
  }

  if(panel.classList.contains('hidden')){
    panel.classList.remove('hidden');
    __idDropdownOpen = true;
    try{ idEl.focus(); }catch(e){}
  }else{
    hideIdDropdown();
  }
}

function hideIdDropdown(){
  const panel = document.getElementById('id-dropdown-panel');
  if(panel) panel.classList.add('hidden');
  __idDropdownOpen = false;
}

function renderSavedProfilesDropdown(filterText=''){
  const panel = document.getElementById('id-dropdown-panel');
  if(!panel) return;

  const arr = getSavedProfiles()
    .slice()
    .sort((a,b) => (b?.lastUsed||0) - (a?.lastUsed||0));

  /* show all saved profiles even if user typed something */
  const filtered = arr;

  panel.innerHTML = '';
  filtered.forEach(p => {
    const item = document.createElement('button');
    item.type = 'button';
    item.className = 'dd-item';
    item.setAttribute('role','option');
    item.title = (state.lang === 'ar' ? 'اضغط لتسجيل الدخول' : 'Zum Anmelden tippen');

    const avatar = document.createElement('div');
    avatar.className = 'dd-avatar';
    avatar.textContent = initialsFromName(displayNameFromProfile(p));

    const meta = document.createElement('div');
    meta.className = 'dd-meta';

    const nm = document.createElement('div');
    nm.className = 'dd-name';
    nm.textContent = displayNameFromProfile(p);

    const sub = document.createElement('div');
    sub.className = 'dd-sub';
    const role = String(p.role||'').toLowerCase();
    const roleLabel = role ? (role.includes('student') ? (state.lang==='ar'?'طالب':'Student') : (state.lang==='ar'?'طاقم':'Staff')) : '';
    sub.textContent = (p.identifier ? String(p.identifier) : '') + (roleLabel ? ` • ${roleLabel}` : '');

    meta.appendChild(nm);
    meta.appendChild(sub);

    const rm = document.createElement('button');
    rm.type = 'button';
    rm.className = 'dd-remove';
    rm.textContent = '×';
    rm.title = (state.lang === 'ar' ? 'حذف' : 'Entfernen');
    rm.addEventListener('click', (ev) => {
      ev.preventDefault();
      ev.stopPropagation();
      removeSavedProfile(p.identifier);
      renderSavedProfilesDropdown('');
      showIdDropdownIfAny(true);
    });

    item.addEventListener('click', () => {
      const idEl = document.getElementById('login-identifier');
      const pinEl = document.getElementById('login-pin');
      const chk = document.getElementById('chk-remember');

      if(idEl) idEl.value = p.identifier || '';
      if(chk) chk.checked = true; // profile implies "remember me"
      if(pinEl) pinEl.value = p.pin || '';

      if(p.lastType) state.loginMode = p.lastType;

      hideIdDropdown();

      if(p.pin){
        doLogin();
      }else{
        try{ pinEl?.focus(); }catch(e){}
      }
    });

    item.appendChild(avatar);
    item.appendChild(meta);
    item.appendChild(rm);
    panel.appendChild(item);
  });
}


function applyRemembered(){
  try{
    const raw = localStorage.getItem(rememberedKey());
    if(!raw) return;
    const obj = JSON.parse(raw);
    document.getElementById('chk-remember').checked = !!obj.remember;

    const idEl  = document.getElementById('login-identifier');
    const pinEl = document.getElementById('login-pin');
    if(idEl)  idEl.value  = obj.identifier || obj.staffUser || obj.studentId || '';
    if(pinEl) pinEl.value = obj.pin || obj.staffPin || obj.studentPin || '';

    // optional: prefer the last successful type when auto-trying
    if(obj.lastType) state.loginMode = obj.lastType;
  }catch(e){}
}

function saveRemembered(lastType){
  const remember = !!document.getElementById('chk-remember')?.checked;
  const idVal  = (document.getElementById('login-identifier')?.value || '').trim();
  const pinVal = (document.getElementById('login-pin')?.value || '').trim();

  const payload = {
    remember: remember,
    identifier: remember ? idVal : '',
    pin: remember ? pinVal : '',
    lastType: remember ? (lastType || null) : null
  };
  try{ localStorage.setItem(rememberedKey(), JSON.stringify(payload)); }catch(e){}
}

// Auto-login on next visits when "Angemeldet bleiben" is enabled.
// This uses the stored identifier + PIN (saved only when the checkbox is checked).
function autoLoginIfRemembered(){
  try{
    // Avoid repeated auto attempts within the same tab session
    if(sessionStorage.getItem('qs_auto_login_tried') === '1') return;
    sessionStorage.setItem('qs_auto_login_tried','1');
  }catch(e){}

  let remember = false;
  let id = '';
  let pin = '';
  try{
    const raw = localStorage.getItem(rememberedKey());
    if(raw){
      const obj = JSON.parse(raw);
      remember = !!obj.remember;
      id  = obj.identifier || obj.staffUser || obj.studentId || '';
      pin = obj.pin || obj.staffPin || obj.studentPin || '';
    }
  }catch(e){}

  if(!remember) return;
  if(!id || !pin) return;

  try{ document.getElementById('chk-remember').checked = true; }catch(e){}
  try{ const idEl = document.getElementById('login-identifier'); if(idEl) idEl.value = id; }catch(e){}
  try{ const pinEl = document.getElementById('login-pin'); if(pinEl) pinEl.value = pin; }catch(e){}

  try{ showLoginLoading(true, (state.lang==='ar' ? 'تسجيل الدخول تلقائياً…' : 'Automatische Anmeldung…')); }catch(e){}
  // Let the UI paint the loading overlay first
  setTimeout(()=>{ try{ doLogin(); }catch(e2){ try{ showLoginLoading(false); }catch(e3){} } }, 60);
}



function toggleLoginMode(mode) {
  state.loginMode = mode;

  document.querySelectorAll('.login-tab').forEach(el => el.classList.remove('active'));
  const tab = document.getElementById(`tab-login-${mode}`);
  if(tab) tab.classList.add('active');

  const staff = document.getElementById('login-staff-fields');
  const stu   = document.getElementById('login-student-fields');
  if(staff) staff.classList.toggle('hidden', mode !== 'staff');
  if(stu)   stu.classList.toggle('hidden', mode !== 'student');

  applyRemembered();
}

function showLoginLoading(show, msg){
  const overlay = document.getElementById('login-loading-overlay');
  if(!overlay) return;
  const tEl = document.getElementById('login-loading-text');
  const sEl = document.getElementById('login-loading-sub');

  const isAr = (typeof state !== 'undefined' && state.lang === 'ar');
  const defaultMsg = isAr ? 'جارٍ التحقق...' : 'Anmeldung wird geprüft…';
  const defaultSub = isAr ? 'الرجاء الانتظار…' : 'Bitte warten…';

  if(tEl) tEl.textContent = msg || defaultMsg;
  if(sEl) sEl.textContent = isAr ? defaultSub : defaultSub;

  const btn = document.getElementById('lbl-login-btn');
  if(btn) btn.disabled = !!show;

  if(show){
    overlay.classList.remove('hidden');
    // ensure transition
    requestAnimationFrame(() => overlay.classList.add('visible'));
  }else{
    overlay.classList.remove('visible');
    setTimeout(() => overlay.classList.add('hidden'), 260);
  }
}

async function doLogin() {
  const errEl = document.getElementById('login-error');
  if(errEl) errEl.innerText = "";
  const btnTxt = document.getElementById('lbl-login-btn');
  if(btnTxt) btnTxt.innerText = "...";

  // Show loading immediately while we verify credentials
  showLoginLoading(true);

  const identifierRaw = (document.getElementById('login-identifier')?.value || '').trim();
  const pinRaw = (document.getElementById('login-pin')?.value || '').trim();

  if(!identifierRaw){
    if(errEl) errEl.innerText = (state.lang === 'de' ? 'Bitte Benutzername/Student ID eingeben' : 'الرجاء إدخال اسم المستخدم أو رقم الطالب');
    if(btnTxt) btnTxt.innerText = t('loginBtn');
    showLoginLoading(false);
    return;
  }
  if(!pinRaw){
    if(errEl) errEl.innerText = (state.lang === 'de' ? 'Bitte PIN eingeben' : 'الرجاء إدخال الرقم السري');
    if(btnTxt) btnTxt.innerText = t('loginBtn');
    showLoginLoading(false);
    return;
  }

  // Case-insensitive fallback: try typed / lower / upper
  const normalizeDigits = (s) => {
    const v = String(s ?? '');
    const map = {
      '٠':'0','١':'1','٢':'2','٣':'3','٤':'4','٥':'5','٦':'6','٧':'7','٨':'8','٩':'9',
      '۰':'0','۱':'1','۲':'2','۳':'3','۴':'4','۵':'5','۶':'6','۷':'7','۸':'8','۹':'9'
    };
    return v.replace(/[٠-٩۰-۹]/g, ch => (map[ch] ?? ch));
  };

  const uniq = (arr) => arr.filter((x, i) => arr.indexOf(x) === i);

  const caseVariants = (s) => {
    const v = String(s ?? '');
    const out = [v];
    const low = v.toLowerCase();
    const up  = v.toUpperCase();
    if(low !== v) out.push(low);
    if(up !== v && up !== low) out.push(up);
    // de-dup while preserving order
    return uniq(out);
  };

  const identifierNorm = normalizeDigits(identifierRaw);
  const pinNorm = normalizeDigits(pinRaw);

  const looksStudentId = /^[0-9]{2,}$/.test(identifierNorm); // student IDs are usually numeric
  let inferred = looksStudentId ? 'student' : 'staff';

  // If this identifier exists in saved profiles, trust the last successful type
  try{
    const profiles = getSavedProfiles();
    const hit = profiles.find(p => {
      const pid = String(p.identifier || '').trim();
      return pid === String(identifierRaw).trim() || pid === String(identifierNorm).trim();
    });
    if(hit && (hit.lastType === 'student' || hit.lastType === 'staff')) inferred = hit.lastType;
  }catch(e){}

  const idBase = uniq([identifierRaw, identifierNorm].map(v => String(v || '').trim()).filter(Boolean));
  const pinBase = uniq([pinNorm].map(v => String(v || '').trim()).filter(Boolean));

  // For staff usernames, try case variants; for numeric student IDs keep it strict (faster)
  const idCandidates  = looksStudentId ? idBase : uniq(idBase.flatMap(v => caseVariants(v)));
  const pinCandidates = pinBase; // PIN is numeric → avoid extra slow retries

  // Decide try order (fast path for inferred type; fallback to other)
  const order = [];
  if(state.loginMode === 'student') order.push('student','staff');
  else if(state.loginMode === 'staff') order.push('staff','student');
  else order.push(inferred, inferred === 'student' ? 'staff' : 'student');


let lastError = null;

  for(const mode of order){
    for(const identifier of idCandidates){
      for(const pin of pinCandidates){
        const payload = { action:'login' };
        if(mode === 'staff'){
          payload.loginType = 'staff';
          payload.userName = identifier;
          payload.pin = pin;
        } else {
          payload.loginType = 'student';
          payload.studentId = identifier;
          payload.pin = pin;
        }

        try{
          const res = await fetch(WEB_APP_URL, {
            method:'POST',
            headers: { "Content-Type": "text/plain" },
            body: JSON.stringify(payload)
          }).then(r=>r.json());

          if(res && res.ok){
            saveRemembered(mode);

            // Store successful profile (multi profiles on same device) if 'remember me' is checked
            try{
              if(!!document.getElementById('chk-remember')?.checked){
                upsertSavedProfile({
                  identifier: identifier,
                  pin: pin,
                  displayName: (res && res.userName) ? res.userName : identifier,
                  role: (res && res.role) ? res.role : mode,
                  lastType: mode
                });
              }
            }catch(e){}

            state.user = res.userName;
            state.role = res.role;

            
            // start background queue syncing after login
            try{ kickSyncQueue(); }catch(e){}
if (String(state.role).toLowerCase() === 'student') {
              state.role = 'Student';
              state.studentData = { referenz: res.studentRef || payload.studentId };
            }
            showLoginLoading(false);
            document.getElementById('login-overlay').classList.add('hidden');
            document.getElementById('qs-app-root').classList.remove('hidden');

            setupUI();
            if(state.role !== 'Student') {
              loadData();
            } else {
              setupStudentUI();
            }
            // Background messages polling (works even when Messages tab is closed)
            try{ startBackgroundMessagePolling(); }catch(e){}
if(btnTxt) btnTxt.innerText = t('loginBtn');
            return;
          } else {
            lastError = (res && res.error) ? res.error : null;
          }
        }catch(e){
          lastError = (state.lang === 'de' ? 'Verbindungsfehler: ' : 'خطأ في الاتصال: ') + (e?.message || e);
          break;
        }
      }
      if(lastError && String(lastError).toLowerCase().includes('verbindungsfehler')) break;
    }
    if(lastError && String(lastError).toLowerCase().includes('verbindungsfehler')) break;
  }
  showLoginLoading(false);

  if(errEl) errEl.innerText = lastError || (state.lang === 'de' ? 'Login fehlgeschlagen' : 'فشل تسجيل الدخول');
  if(btnTxt) btnTxt.innerText = t('loginBtn');
}

function setupUI() {
  // Reset navigation cache/history guards when role changes (prevents Student from seeing staff tabs via Back)
  try{ resetNavState(); }catch(e){}
  document.getElementById('hdr-user').innerText = `User: ${state.user} (${state.role})`;
  try{ document.getElementById('btn-stu-comm')?.classList.add('hidden'); }catch(e){}
  
  if(state.role === 'Student') {
      // Hide Teacher Navs
      document.getElementById('nav-users').classList.add('hidden');
      document.getElementById('nav-students').classList.add('hidden');
      document.getElementById('nav-stats').classList.add('hidden');
      document.getElementById('nav-docs').classList.add('hidden');
      document.getElementById('nav-homework-admin').classList.add('hidden');
      document.getElementById('btn-filter').classList.add('hidden');
      
      // Show Student Nav
      document.getElementById('nav-stu-home').classList.remove('hidden');
      document.getElementById('nav-stu-hw').classList.remove('hidden');
      document.getElementById('nav-stu-mem').classList.remove('hidden');
      document.getElementById('nav-stu-rate').classList.remove('hidden');
      document.getElementById('nav-stu-parent').classList.remove('hidden');
      // Student can use messages tab
      try{ document.getElementById('nav-comm').classList.remove('hidden'); }catch(e){}

      // Default tab
      setReaderFabVisible(true);
      switchTab('student-home');
      return;
  }

  setReaderFabVisible(false);
  clearLessonFab();

  // Lehrer: show homework tab (Admin removed)
  if(state.role === 'Lehrer'){
      document.getElementById('nav-homework-admin')?.classList.remove('hidden');
  } else {
      document.getElementById('nav-homework-admin')?.classList.add('hidden');
  }

  // Teacher/Admin Setup
  if(state.role === 'Admin') {
      document.getElementById('btn-add-student').classList.remove('hidden');
      document.getElementById('nav-users').classList.remove('hidden');
      document.getElementById('admin-filters').classList.remove('hidden');
  } else {
      document.getElementById('nav-users').classList.add('hidden');
      document.getElementById('admin-filters').classList.add('hidden');
  }
  updateLang();
  initMessageNotificationsUI();
  const daysMap = ["Sonntag","Montag","Dienstag","Mittwoch","Donnerstag","Freitag","Samstag"];

// Admin: never auto-select filters
if(String(state.role || '') === 'Admin'){
  state.filter.days = [];
  state.filter.groups = [];
} else if(String(state.role || '') === 'Lehrer' || String(state.role || '') === 'Teacher'){
  // Lehrer: selection will be applied automatically based on Gruppenverwaltung schedule (if a class is active right now)
  state.filter.days = [];
  state.filter.groups = [];
  state.__teacherFilterManual = false;
  state.__teacherAutoKey = '';
} else {
  // Fallback (other staff roles): default to today's day
  state.filter.days = [daysMap[new Date().getDay()]];
  state.filter.groups = [];
}

  if (localStorage.getItem('darkMode') === 'true') state.darkMode = true; else state.darkMode = false;
  updateDarkModeIcon();

  setupHomeworkSurahDropdown();
  try{ setupHomeworkSurahDropdownAdmin(); }catch(e){}
  try{ toggleHomeworkAdminTypeUI(); }catch(e){}
  try{ initBulkHomeworkUI(); }catch(e){}
  try{ initAllHomeworkUI(); }catch(e){}
}

// --- LOGOUT ---
function resetNavDefaults(){
  // Teacher nav visible by default
  ['nav-students','nav-homework-admin','nav-comm','nav-stats','nav-docs'].forEach(id => {
    document.getElementById(id)?.classList.remove('hidden');
  });
  // Users only for Admin (keep hidden by default until login sets it)
  document.getElementById('nav-users')?.classList.add('hidden');

  // Student nav hidden by default
  ['nav-stu-home','nav-stu-hw','nav-stu-mem','nav-stu-rate','nav-stu-parent'].forEach(id => {
    document.getElementById(id)?.classList.add('hidden');
  });

  // Header actions defaults
  document.getElementById('btn-filter')?.classList.remove('hidden');
  document.getElementById('btn-add-student')?.classList.add('hidden');
  document.getElementById('admin-filters')?.classList.add('hidden');

  try{ setReaderFabVisible(false); }catch(e){}
}

function doLogout(){
  try{ showLoginLoading(false); }catch(e){}
  // Stop polling
  try{ if(msgPollingInterval){ clearInterval(msgPollingInterval); msgPollingInterval = null; } }catch(e){}
  
  try{ if(msgBgPollingInterval){ clearInterval(msgBgPollingInterval); msgBgPollingInterval = null; } }catch(e){}
try{ if(studentPollingInterval){ clearInterval(studentPollingInterval); studentPollingInterval = null; } }catch(e){}
  try{ studentPollingPrimed = false; }catch(e){}

  // Close overlays/modals
  try{ hideFloatingAudio(); }catch(e){}
  try{ document.querySelectorAll('.modal-overlay.visible').forEach(el => el.classList.remove('visible')); }catch(e){}
  try{ document.getElementById('progress-overlay')?.classList.remove('visible'); }catch(e){}
  try{ hideQuickVerseSheet(); }catch(e){}
  try{ clearLessonFab(); }catch(e){}
  try{ setReaderFabVisible(false); }catch(e){}

  // Reset volatile state (keep language + dark mode)
  state.user = null;
  state.role = null;
  state.students = [];
  state.attendance = [];
  state.messages = [];
  state.teachers = [];
  state.allUsers = [];
  state.studentInfos = [];
  state.documents = [];
  state.filteredStudents = [];

  // If composing a message to students, keep the recipient list in sync with current filters
  try{
    if(state.commUi?.composeOpen && document.getElementById('msg-dest-type')?.value === 'Student') populateMsgStudentSelect();
  }catch(e){}
  state.studentData = null;
  state.currentDetailStudent = null;
  state.parentAbsencesToday = [];
  state.parentAbsentSet = new Set();
  state.studentHomeAlerts = [];

  try{ selectedForAttendance = new Set(); }catch(e){}
  try{ editingStudent = null; }catch(e){}
  try{ editingUserIdx = null; }catch(e){}

  // Reset UI defaults
  try{ resetNavState(); }catch(e){}
  resetNavDefaults();
  try{ switchTab('students', {noHistory:true}); }catch(e){}

  // Show login screen
  document.getElementById('qs-app-root')?.classList.add('hidden');
  document.getElementById('login-overlay')?.classList.remove('hidden');

  // Header text reset
  const hu = document.getElementById('hdr-user');
  if(hu) hu.innerText = '';
  const hs = document.getElementById('hdr-sync');
  if(hs) hs.innerText = t('sync');

  // Optional: clear PIN if remember is off
  try{
    const remember = !!document.getElementById('chk-remember')?.checked;
    if(!remember){
      const pinEl = document.getElementById('login-pin');
      if(pinEl) pinEl.value = '';
    }
  }catch(e){}


  // Explicit logout: disable auto-login next time
  try{
    localStorage.removeItem(rememberedKey());
    const chk = document.getElementById('chk-remember');
    if(chk) chk.checked = false;
  }catch(e){}
  try{ renderSavedProfiles(); }catch(e){}

  try{ document.getElementById('login-identifier')?.focus(); }catch(e){}
}

// --- STUDENT UI LOGIC ---

function setupStudentUI() {
  updateLang();
  // Security hardening: ensure no staff data is kept in memory in Student mode
  try{ state.students = []; state.filteredStudents = []; state.attendance = []; state.messages = []; state.teachers = []; }catch(e){}
  try{ initCommUI(); }catch(e){}
  try{ document.getElementById('students-list') && (document.getElementById('students-list').innerHTML = ''); }catch(e){}
  try{ history.replaceState({qsNav:true, kind:'main', tab:'student-home'}, ''); ensureExitGuardState(); }catch(e){}
  // Popup alerts (lateness/absence/new entries)
  fetchStudentPopupAlerts({noModal:true});

  loadStudentHomework();
  loadStudentEvaluations();
  loadStudentAttendance();
    loadStudentProgress();
  loadParentAbsentState();
  try{ initStudentHomeAbsentUI(); }catch(e){}
  renderSurahList();
  initStudentNotificationsUI();
  // Start polling only if user enabled notifications
  if(isStudentNotificationsEnabled()){
    startStudentPolling();
  }
}

// --- Student Home (Main tab) ---
state.studentHomeAlerts = state.studentHomeAlerts || [];

function isStudentHomeVisible(){
  const el = document.getElementById('tab-student-home');
  return !!el && !el.classList.contains('hidden');
}

async function loadStudentHome(){
  const listEl = document.getElementById('student-home-alerts');
  if(listEl){
    listEl.innerHTML = `<div class="text-sec text-center">${state.lang === 'de' ? 'Lade…' : 'جارٍ التحميل…'}</div>`;
  }
  // Use alerts API as the source of truth for "new updates"
  await fetchStudentPopupAlerts({ noModal:true, force:true });
}

function renderStudentHomeAlerts(alerts){
  const arr = Array.isArray(alerts) ? alerts : [];
  const listEl = document.getElementById('student-home-alerts');
  const countEl = document.getElementById('student-home-count');
  const btnAll = document.getElementById('stu-home-btn-markall');

  if(countEl) countEl.innerText = String(arr.length || 0);
  showDotBadge('badge-stu-home', arr.length > 0);

  if(btnAll){
    btnAll.classList.toggle('hidden', arr.length === 0);
  }

  if(!listEl) return;
  listEl.innerHTML = '';

  if(arr.length === 0){
    // If there are no alerts, show achievements alone (no "no updates") unless achievements are also empty.
    const hasAch = !!(state.studentProgress && state.studentProgress.length);
    listEl.innerHTML = hasAch ? '' : `<div class="text-sec text-center" style="padding:10px 0;">${state.lang === 'de' ? 'Keine neuen Einträge.' : 'لا توجد مستجدات جديدة.'}</div>`;
    renderStudentHomeAchievements();
    return;
  }

  arr.forEach((a, i) => {
    const txt = buildStudentAlertText(a);
    const date = dateOnly(a.date || a.timestamp || '');
    let gotoTab = '';
    if(a.type === 'homework') gotoTab = 'student-homework';
    else if(a.type === 'evaluation' || a.type === 'attendance') gotoTab = 'student-rating';

    const openBtn = gotoTab ? `
      <button class="btn btn-sec" style="flex:1;" onclick="switchTab('${gotoTab}')">
        ${state.lang === 'de' ? 'Öffnen' : 'فتح'}
      </button>` : '';

    listEl.innerHTML += `
      <div class="card flex-col" style="align-items:flex-start; padding:12px;">
        <div style="display:flex; width:100%; justify-content:space-between; align-items:flex-start; gap:10px;">
          <div style="font-weight:bold;">${escapeHtml(txt.title || '')}</div>
          <div class="text-sm text-sec" style="white-space:nowrap;">${escapeHtml(date || '')}</div>
        </div>
        <div class="text-sm" style="white-space:pre-wrap; margin-top:8px; line-height:1.5;">${escapeHtml(txt.body || '')}</div>
        <div style="display:flex; gap:10px; width:100%; margin-top:12px;">
          ${openBtn}
          <button class="btn" style="flex:1;" onclick="markStudentHomeAlertRead(${i})">
            ${state.lang === 'de' ? 'Gelesen' : 'تمت القراءة'}
          </button>
        </div>
      </div>
    `;
  });

  renderStudentHomeAchievements();
}

async function markStudentHomeAlertRead(i){
  const a = (state.studentHomeAlerts || [])[i];
  if(!a?.id) return;

  try{
    await fetch(WEB_APP_URL, {
      method:'POST',
      headers: { "Content-Type": "text/plain" },
      body: JSON.stringify({ action:'markStudentAlertRead', studentRef: state.studentData.referenz, alertId: a.id })
    }).then(r=>r.json());
  }catch(e){}

  // Refresh list (and keep popup state consistent)
  await fetchStudentPopupAlerts({ noModal:true, force:true });
}

async function markAllStudentHomeAlertsRead(){
  const arr = (state.studentHomeAlerts || []).slice();
  if(!arr.length) return;

  for(const a of arr){
    if(!a?.id) continue;
    try{
      await fetch(WEB_APP_URL, {
        method:'POST',
        headers: { "Content-Type": "text/plain" },
        body: JSON.stringify({ action:'markStudentAlertRead', studentRef: state.studentData.referenz, alertId: a.id })
      }).then(r=>r.json());
    }catch(e){}
  }
  await fetchStudentPopupAlerts({ noModal:true, force:true });
}


// --- Student Popup Alerts (shown on login + when new items arrive) ---
state.popupAlerts = state.popupAlerts || [];
state.popupAlertIndex = state.popupAlertIndex || 0;

async function fetchStudentPopupAlerts(opts = {}){
  try{
    if(!state.studentData?.referenz) return [];
    const noModal = !!(opts && opts.noModal);
    const force = !!(opts && opts.force);

    // Don’t interrupt if already visible (unless force refresh)
    const modal = document.getElementById('alert-modal');
    if(modal && modal.classList.contains('visible') && !force) return (state.popupAlerts || []);

    const res = await fetch(WEB_APP_URL, {
      method:'POST',
      headers: { "Content-Type": "text/plain" },
      body: JSON.stringify({ action:'getStudentAlerts', studentRef: state.studentData.referenz })
    }).then(r=>r.json());

    const alertsAll = (res && res.ok && Array.isArray(res.alerts)) ? res.alerts : [];

    // We already show NEW homework as notification-cards on the Student Home.
    // So we hide/ignore homework alerts here to avoid duplicate homework notifications.
    // To prevent them from reappearing forever, we mark homework alerts as read in the background.
    const homeworkAlerts = alertsAll.filter(a => a && a.type === 'homework' && a.id);
    const alerts = alertsAll.filter(a => !a || a.type !== 'homework');

    // Fire-and-forget: mark homework alerts as read so they don't keep showing up.
    // (Do NOT block the UI. If network fails, they'll reappear next refresh.)
    if(homeworkAlerts.length && state.studentData?.referenz){
      (async () => {
        for(const a of homeworkAlerts){
          try{
            await fetch(WEB_APP_URL, {
              method:'POST',
              headers: { "Content-Type": "text/plain" },
              body: JSON.stringify({ action:'markStudentAlertRead', studentRef: state.studentData.referenz, alertId: a.id })
            });
          }catch(e){}
        }
      })();
    }

    state.popupAlerts = alerts;
    state.popupAlertIndex = 0;

    // Keep a copy for the Student "Home" tab
    state.studentHomeAlerts = alerts;
    renderStudentHomeAlerts(alerts);

    const onHome = isStudentHomeVisible();
    if(!noModal && !onHome && alerts.length){
      showCurrentStudentAlert();
    }
    return alerts;
  }catch(e){
    return [];
  }
}
function buildStudentAlertText(a){
  const de = (state.lang === 'de');
  if(!a) return { title:'', body:'' };

  // Attendance (late/absent)
  if(a.type === 'attendance'){
    const st = String(a.status || '').trim();
    const date = a.date || '';
    const isLate = (st === 'تأخير' || st === 'Verspätet' || st.toLowerCase() === 'late');
    const isAbs  = (st === 'غياب' || st === 'Abwesend' || st.toLowerCase() === 'absent');

    if(isLate){
      return {
        title: de ? '⚠️ Verspätung' : '⚠️ تنبيه تأخير',
        body:  de ? `Hinweis: Der Schüler ist am ${date} verspätet.` : `تنبيه: الطالب تأخر بتاريخ ${date}.`
      };
    }
    if(isAbs){
      return {
        title: de ? '⚠️ Abwesenheit' : '⚠️ تنبيه غياب',
        body:  de ? `Hinweis: Der Schüler war am ${date} abwesend.` : `تنبيه: الطالب تغيب بتاريخ ${date}.`
      };
    }
    return {
      title: de ? '⚠️ Hinweis' : '⚠️ تنبيه',
      body:  de ? `Es gibt einen neuen Hinweis (${date}).` : `يوجد تنبيه جديد (${date}).`
    };
  }

  // Homework
  if(a.type === 'homework'){
    const date = a.date || '';
    const info = decodeHomeworkSurah(a.surah || '');
    const range = (a.start && a.end) ? ` (${a.start}-${a.end})` : '';
    if(info.kind === 'text'){
      const txt = info.freeText || '';
      return {
        title: de ? '📝 Neue Hausaufgabe' : '📝 واجب جديد',
        body:  de ? `Datum: ${date}\n\n${txt}` : `التاريخ: ${date}\n\n${txt}`
      };
    }
    const label = info.label || (de ? 'Hausaufgabe' : 'واجب');
    return {
      title: de ? '📝 Neue Hausaufgabe' : '📝 واجب جديد',
      body:  de ? `Datum: ${date}\n${label}${range}` : `التاريخ: ${date}\n${label}${range}`
    };
  }

  // Evaluation / Note
  if(a.type === 'evaluation'){
    const date = a.date || '';
    const note = String(a.note || '').trim();
    const mem = String(a.memorization || '').trim();
    const taj = String(a.tajweed || '').trim();
    const beh = String(a.behavior || '').trim();

    let lines = [];
    if(mem) lines.push((de ? 'Hifz: ' : 'حفظ: ') + mem);
    if(taj) lines.push((de ? 'Tajweed: ' : 'تجويد: ') + taj);
    if(beh) lines.push((de ? 'Verhalten: ' : 'سلوك: ') + beh);
    if(note) lines.push((de ? 'Notiz: ' : 'ملاحظة: ') + note);

    const body = (de ? `Datum: ${date}` : `التاريخ: ${date}`) + (lines.length ? `\n\n${lines.join('\n')}` : '');
    return {
      title: de ? '📌 Neue Notiz/Bewertung' : '📌 ملاحظة/تقييم جديد',
      body
    };
  }

  // Fallback
  return {
    title: de ? '📢 Neuer Hinweis' : '📢 تنبيه جديد',
    body:  String(a.message || a.body || '')
  };
}

function showCurrentStudentAlert(){
  const arr = state.popupAlerts || [];
  const idx = Number(state.popupAlertIndex || 0);
  const a = arr[idx];
  if(!a) return;

  const txt = buildStudentAlertText(a);

  const titleEl = document.getElementById('alert-modal-title');
  const bodyEl  = document.getElementById('alert-modal-body');
  const cntEl   = document.getElementById('alert-modal-counter');
  const btnOk   = document.getElementById('alert-modal-confirm');
  const btnCls  = document.getElementById('alert-modal-close');

  if(titleEl) titleEl.innerText = txt.title || '';
  if(bodyEl)  bodyEl.innerText  = txt.body  || '';
  if(cntEl)   cntEl.innerText   = `${idx + 1} / ${arr.length}`;

  if(btnOk)  btnOk.innerText  = (state.lang === 'de' ? 'Gelesen bestätigen' : 'تأكيد القراءة');
  if(btnCls) btnCls.innerText = (state.lang === 'de' ? 'Schließen' : 'إغلاق');

  openModal('alert-modal', { noHistory:true });
}

function closeStudentAlertModal(){
  closeModal('alert-modal', { noHistory:true });
}

async function confirmStudentAlertRead(){
  const arr = state.popupAlerts || [];
  const idx = Number(state.popupAlertIndex || 0);
  const a = arr[idx];
  if(!a?.id) { closeStudentAlertModal(); return; }

  try{
    await fetch(WEB_APP_URL, {
      method:'POST',
      headers: { "Content-Type": "text/plain" },
      body: JSON.stringify({ action:'markStudentAlertRead', studentRef: state.studentData.referenz, alertId: a.id })
    }).then(r=>r.json());
  }catch(e){}

  // next alert
  state.popupAlertIndex = idx + 1;
  if(arr[state.popupAlertIndex]){
    showCurrentStudentAlert();
  } else {
    closeStudentAlertModal();
    state.popupAlerts = [];
    state.popupAlertIndex = 0;
  }
}

// Close WITHOUT confirming: will show again next login/poll until confirmed.
function dismissStudentAlertTemporarily(){
  closeStudentAlertModal();
}


// --- Student Notifications (Browser notifications while app is open) ---
function studentNotifEnabledKey(){
  return `qs_stu_notif_enabled:${state.studentData?.referenz || 'unknown'}`;
}
function studentLastHwKey(){
  return `qs_stu_last_hw:${state.studentData?.referenz || 'unknown'}`;
}
function studentLastEvKey(){
  return `qs_stu_last_ev:${state.studentData?.referenz || 'unknown'}`;
}
function isStudentNotificationsEnabled(){
  try{ return localStorage.getItem(studentNotifEnabledKey()) === '1'; }catch(e){ return false; }
}
function setStudentNotificationsEnabled(on){
  try{ localStorage.setItem(studentNotifEnabledKey(), on ? '1' : '0'); }catch(e){}
}
function setStuNotifStatus(text){
  const el = document.getElementById('stu-notif-status');
  if(el) el.innerText = text || '';
}
function initStudentNotificationsUI(){
  const box = document.getElementById('chk-stu-notif');
  const hint = document.getElementById('stu-notif-hint');
  const head = document.getElementById('stu-notif-head');
  const lbl  = document.getElementById('stu-notif-label');

  // i18n (simple inline)
  if(head) head.innerText = (state.lang === 'de' ? 'Benachrichtigungen' : 'تنبيهات');
  if(hint) hint.innerText = (state.lang === 'de'
    ? 'Aktiviere Browser-Benachrichtigungen für neue Hinweise / Notizen (solange die Seite geöffnet ist).'
    : 'فعّل تنبيهات المتصفح عند وصول تنبيهات أو ملاحظات جديدة (طالما الصفحة مفتوحة).');
  if(lbl) lbl.innerText = (state.lang === 'de'
    ? 'Bei neuen Einträgen benachrichtigen'
    : 'تنبيه عند وصول جديد');

  if(!box) return;

  const supported = ('Notification' in window);
  box.disabled = !supported;
  box.checked = isStudentNotificationsEnabled() && supported;

  if(!supported){
    setStuNotifStatus(state.lang === 'de' ? 'Nicht unterstützt in diesem Browser.' : 'غير مدعوم في هذا المتصفح.');
  } else {
    setStuNotifStatus('');
  }
}

// --- Small "red dot" badges for tabs (new items) ---
function showDotBadge(badgeId, show){
  const el = document.getElementById(badgeId);
  if(!el) return;
  el.classList.toggle('hidden', !show);
}
function clearStudentBadgeForTab(tabId){
  if(tabId === 'student-homework') showDotBadge('badge-stu-hw', false);
  if(tabId === 'student-rating')  showDotBadge('badge-stu-rate', false);
}

// --- Change Student PIN (from Parent tab) ---
function updateRememberedPin(newPin){
  try{
    const raw = localStorage.getItem(rememberedKey());
    if(!raw) return;
    const obj = JSON.parse(raw);
    if(obj && obj.remember){
      obj.pin = newPin;
      localStorage.setItem(rememberedKey(), JSON.stringify(obj));
    }
  }catch(e){}
}
function setStuPinStatus(text){
  const el = document.getElementById('stu-pin-status');
  if(el) el.textContent = text || '';
}

async function changeStudentPin(){
  if(!state.studentData?.referenz){
    showToast(state.lang === 'de' ? 'Student nicht erkannt.' : 'لم يتم التعرف على الطالب.');
    return;
  }
  const oldPin = (document.getElementById('stu-old-pin')?.value || '').trim();
  const newPin = (document.getElementById('stu-new-pin')?.value || '').trim();
  const newPin2 = (document.getElementById('stu-new-pin2')?.value || '').trim();

  if(!newPin || newPin.length < 4){
    showToast(state.lang === 'de' ? 'Bitte neue PIN (mind. 4 Zeichen) eingeben.' : 'الرجاء إدخال رقم سري جديد (٤ أرقام على الأقل).');
    return;
  }
  if(newPin !== newPin2){
    showToast(state.lang === 'de' ? 'PIN-Bestätigung stimmt nicht.' : 'تأكيد الرقم السري غير مطابق.');
    return;
  }

  setStuPinStatus(state.lang === 'de' ? 'Speichern…' : 'جارٍ الحفظ…');

  try{
    const res = await fetch(WEB_APP_URL, {
      method:'POST',
      headers: { "Content-Type": "text/plain" },
      body: JSON.stringify({
        action: 'changeStudentPin',
        studentRef: state.studentData.referenz,
        oldPin: oldPin,
        newPin: newPin
      })
    }).then(r=>r.json());

    if(res && res.ok){
      showToast(state.lang === 'de' ? 'PIN geändert' : 'تم تغيير الرقم السري');
      updateRememberedPin(newPin);
      setStuPinStatus(state.lang === 'de' ? 'Erfolgreich gespeichert.' : 'تم الحفظ بنجاح.');
      ['stu-old-pin','stu-new-pin','stu-new-pin2'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
    } else {
      const msg = (res && res.error) ? res.error : (state.lang === 'de' ? 'Fehler beim Speichern.' : 'حدث خطأ أثناء الحفظ.');
      showToast(msg);
      setStuPinStatus(msg);
    }
  }catch(e){
    const msg = (state.lang === 'de' ? 'Verbindungsfehler: ' : 'خطأ في الاتصال: ') + (e?.message || e);
    showToast(msg);
    setStuPinStatus(msg);
  }
}



async function toggleStudentNotifications(){
  const box = document.getElementById('chk-stu-notif');
  if(!box) return;

  if(!('Notification' in window)){
    box.checked = false;
    setStuNotifStatus(state.lang === 'de' ? 'Nicht unterstützt in diesem Browser.' : 'غير مدعوم في هذا المتصفح.');
    return;
  }

  const wantOn = !!box.checked;

  if(wantOn){
    // Request permission
    let ok = false;
    try{
      if(Notification.permission === 'granted') ok = true;
      else if(Notification.permission === 'denied') ok = false;
      else {
        const perm = await Notification.requestPermission();
        ok = (perm === 'granted');
      }
    }catch(e){ ok = false; }

    if(!ok){
      box.checked = false;
      setStudentNotificationsEnabled(false);
      setStuNotifStatus(state.lang === 'de'
        ? 'Benachrichtigungen sind blockiert. Bitte im Browser erlauben.'
        : 'التنبيهات محجوبة. يرجى السماح بها من إعدادات المتصفح.');
      return;
    }

    setStudentNotificationsEnabled(true);
    setStuNotifStatus(state.lang === 'de' ? '✅ Aktiviert.' : '✅ تم التفعيل.');
    startStudentPolling();
    // Small test notification (optional)
    try{ new Notification(state.lang === 'de' ? 'Benachrichtigungen aktiv' : 'تم تفعيل التنبيهات', { body: state.lang === 'de' ? 'Du wirst bei neuen Einträgen informiert.' : 'سيصلك تنبيه عند وصول جديد.' }); }catch(e){}
  } else {
    setStudentNotificationsEnabled(false);
    stopStudentPolling();
    setStuNotifStatus(state.lang === 'de' ? 'Deaktiviert.' : 'تم الإيقاف.');
  }
}

function stopStudentPolling(){
  if(studentPollingInterval) clearInterval(studentPollingInterval);
  studentPollingInterval = null;
  studentPollingPrimed = false;
}

function makeItemSig(obj, keys){
  try{
    return keys.map(k => String(obj?.[k] ?? '')).join('|');
  }catch(e){
    return '';
  }
}

function dateKey(raw){
  const s = String(raw || '').trim();
  if(!s) return '';
  const mIso = s.match(/(\d{4})-(\d{2})-(\d{2})/);
  if(mIso) return `${mIso[1]}${mIso[2]}${mIso[3]}` + (s.match(/(\d{2}):(\d{2})/) ? s.match(/(\d{2}):(\d{2})/)[0].replace(':','') : '');
  const mDe = s.match(/(\d{2})\.(\d{2})\.(\d{4})/);
  if(mDe) return `${mDe[3]}${mDe[2]}${mDe[1]}` + (s.match(/(\d{2}):(\d{2})/) ? s.match(/(\d{2}):(\d{2})/)[0].replace(':','') : '');
  const d = new Date(s);
  if(!isNaN(d.getTime())){
    return `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}${String(d.getHours()).padStart(2,'0')}${String(d.getMinutes()).padStart(2,'0')}`;
  }
  return s;
}

function pickLatest(list, dateField){
  if(!Array.isArray(list) || list.length === 0) return null;
  let best = list[0];
  let bestKey = dateKey(best[dateField]);
  for(const it of list){
    const k = dateKey(it?.[dateField]);
    if(String(k) > String(bestKey)){
      best = it;
      bestKey = k;
    }
  }
  return best;
}

async function checkStudentUpdates({baseline=false} = {}){
  if(!state.studentData?.referenz) return;

  // Fetch homework + evaluations
  let hwRes = null, evRes = null;
  try{
    hwRes = await fetch(WEB_APP_URL, {
      method:'POST',
      headers: { "Content-Type": "text/plain" },
      body: JSON.stringify({ action: 'getStudentHomework', studentRef: state.studentData.referenz })
    }).then(r=>r.json());
  }catch(e){}
  try{
    evRes = await fetch(WEB_APP_URL, {
      method:'POST',
      headers: { "Content-Type": "text/plain" },
      body: JSON.stringify({ action: 'getStudentEvaluations', studentRef: state.studentData.referenz })
    }).then(r=>r.json());
  }catch(e){}

  // Homework
  if(hwRes && hwRes.ok && Array.isArray(hwRes.homework)){
    const latestHw = pickLatest(hwRes.homework, 'date');
    const sigHw = latestHw ? (dateKey(latestHw.date) + '|' + makeItemSig(latestHw, ['surah','start','end','date'])) : '';
    const prev = localStorage.getItem(studentLastHwKey()) || '';
    if(!studentPollingPrimed || baseline){
      try{ localStorage.setItem(studentLastHwKey(), sigHw); }catch(e){}
    } else if(sigHw && sigHw !== prev){
      try{ localStorage.setItem(studentLastHwKey(), sigHw); }catch(e){}
      const title = (state.lang === 'de' ? 'Neue Hausaufgabe' : 'واجب جديد');
      const body  = (state.lang === 'de' ? 'Es gibt eine neue Hausaufgabe.' : 'وصل واجب جديد.');
      showToast(body);
      if(isStudentNotificationsEnabled() && Notification.permission === 'granted'){
        try{ new Notification(title, { body }); }catch(e){}
      }
      // refresh UI if visible
      showDotBadge('badge-stu-hw', true);
      loadStudentHomework();
      // Also show as popup alert (until confirmed)
      fetchStudentPopupAlerts();
    }
  }

  // Evaluations / notes
  if(evRes && evRes.ok && Array.isArray(evRes.evaluations)){
    const latestEv = pickLatest(evRes.evaluations, 'date');
    const sigEv = latestEv ? (dateKey(latestEv.date) + '|' + makeItemSig(latestEv, ['memorization','tajweed','behavior','note','date'])) : '';
    const prev = localStorage.getItem(studentLastEvKey()) || '';
    if(!studentPollingPrimed || baseline){
      try{ localStorage.setItem(studentLastEvKey(), sigEv); }catch(e){}
    } else if(sigEv && sigEv !== prev){
      try{ localStorage.setItem(studentLastEvKey(), sigEv); }catch(e){}
      const title = (state.lang === 'de' ? 'Neue Notiz/Bewertung' : 'ملاحظة/تقييم جديد');
      const body  = (state.lang === 'de' ? 'Es gibt eine neue Notiz oder Bewertung.' : 'وصلت ملاحظة أو تقييم جديد.');
      showToast(body);
      if(isStudentNotificationsEnabled() && Notification.permission === 'granted'){
        try{ new Notification(title, { body }); }catch(e){}
      }
      showDotBadge('badge-stu-rate', true);
      loadStudentEvaluations();
      // Also show as popup alert (until confirmed)
      fetchStudentPopupAlerts();
    }
  }

  studentPollingPrimed = true;
}

function startStudentPolling(){
  stopStudentPolling();
  // Prime baseline once so we don’t notify on first login
  checkStudentUpdates({baseline:true});
  studentPollingInterval = setInterval(() => checkStudentUpdates(), 30000);
}

let _stuUnseenHomeworkRowIndices = [];

async function markStudentHomeworkSeenAll(){
  if(!state.studentData?.referenz) return;
  const btn = document.getElementById('btn-stu-hw-parentseen');
  const panel = document.getElementById('stu-hw-parentseen-panel');
  const rows = Array.isArray(_stuUnseenHomeworkRowIndices) ? _stuUnseenHomeworkRowIndices.slice() : [];
  if(rows.length === 0){
    if(panel) panel.classList.add('hidden');
    return showToast(state.lang==='de' ? 'Keine offenen Hausaufgaben.' : 'لا توجد واجبات غير مُؤكدة.');
  }

  try{
    if(btn){
      btn.disabled = true;
      btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
    }

    const res = await fetch(WEB_APP_URL, {
      method:'POST',
      headers: { "Content-Type": "text/plain" },
      body: JSON.stringify({ action:'markHomeworkParentSeen', studentRef: state.studentData.referenz, rowIndices: rows })
    }).then(r=>r.json());

    if(res && res.ok){
      showToast(state.lang==='de' ? 'Bestätigt ✓' : 'تم التأكيد ✓');
      await loadStudentHomework();
    }else{
      showToast((res && res.error) ? res.error : (state.lang==='de' ? 'Fehler' : 'حدث خطأ'));
    }
  }catch(e){
    showToast((state.lang==='de' ? 'Verbindungsfehler: ' : 'خطأ في الاتصال: ') + (e?.message || e));
  }finally{
    if(btn){
      btn.disabled = false;
      btn.textContent = (state.lang==='de' ? 'Bestätigen' : 'تأكيد');
    }
  }
}


function markStudentHomeworkSeenOne(rowIndex, btn){
  if(!rowIndex) return;
  const b = btn;
  const origHtml = b ? b.innerHTML : '';
  try{
    if(b){
      b.disabled = true;
      b.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
    }
    return fetch(WEB_APP_URL, {
      method:'POST',
      headers: { "Content-Type": "text/plain" },
      body: JSON.stringify({ action:'markHomeworkParentSeen', studentRef: state.studentData.referenz, rowIndices: [rowIndex] })
    }).then(r=>r.json()).then(async res=>{
      if(res && res.ok){
        showToast(state.lang==='de' ? 'Bestätigt ✓' : 'تم التأكيد ✓');
        await loadStudentHomework();
      } else {
        showToast((res && res.error) ? res.error : (state.lang==='de' ? 'Fehler' : 'حدث خطأ'));
      }
    }).catch(e=>{
      showToast((state.lang==='de' ? 'Verbindungsfehler: ' : 'خطأ في الاتصال: ') + (e?.message || e));
    }).finally(()=>{
      if(b){
        b.disabled = false;
        b.innerHTML = origHtml || (state.lang==='de' ? 'Eltern bestätigen' : 'تأكيد ولي الأمر');
      }
    });
  }catch(e){
    showToast((state.lang==='de' ? 'Verbindungsfehler: ' : 'خطأ في الاتصال: ') + (e?.message || e));
    if(b){
      b.disabled = false;
      b.innerHTML = origHtml || (state.lang==='de' ? 'Eltern bestätigen' : 'تأكيد ولي الأمر');
    }
  }
}


// --- Student Homework quick-open helpers (Home card + item cards) ---
function openQuranAt(surahNum, ayahStart, ayahEnd, opts = {}){
  // Opens the memorization modal for the given range WITHOUT showing the full Koran reader page.
  // Used by homework cards/buttons.
  const s = Number(surahNum||0);
  const a1 = Number(ayahStart||0);
  const a2 = Number(ayahEnd||0);

  // If something is missing, just open the homework list.
  if(!s || !a1 || !a2) { try{ switchTab('student-homework'); }catch(e){} return; }

  // Keep the student in the homework view (Hausaufgaben) and open the memorize overlay.
  try{ switchTab('student-homework'); }catch(e){}

  try{
    openLesson(s, a1, a2, { viewMode: 'memorize' });
  }catch(e){
    // fallback
    try{ openLesson(s, a1, a2); }catch(_e){}
  }
}

function openStudentHomeworkShortcut(ev){
  try{
    const t = ev && ev.target;
    // don't hijack clicks on internal buttons or the list itself
    if(t && (t.closest('button') || t.closest('#student-home-homework-list'))) return;
  }catch(e){}
  const list = (state && Array.isArray(state.studentHomework)) ? state.studentHomework : [];
  const unseen = list.filter(hw => !isParentSeenHomework(hw));
  const base = unseen.length ? unseen : list;

  const sorted = base.slice().sort((a,b)=>{
    const da = String(a?.date || '');
    const db = String(b?.date || '');
    if(db !== da) return db.localeCompare(da);
    return (Number(b?.rowIndex)||0) - (Number(a?.rowIndex)||0);
  });

  const pick = sorted.find(hw=>{
    const info = decodeHomeworkSurah(hw?.surah);
    const s1 = getAyahStart(hw);
    const s2 = getAyahEnd(hw);
    return !!info.surahNum && !!s1 && !!s2;
  });

  if(pick){
    const info = decodeHomeworkSurah(pick.surah);
    const s1 = getAyahStart(pick);
    const s2 = getAyahEnd(pick);
    openQuranAt(Number(info.surahNum), Number(s1), Number(s2), {from:'student-home-hw-card'});
  }else{
    switchTab('student-homework');
  }
}

function renderStudentHomeworkCards(homeworkArr, contEl){
  if(!contEl) return;
  const list = Array.isArray(homeworkArr) ? homeworkArr : [];
  contEl.innerHTML = '';

  list.forEach(hw=>{
    const parentSeen = isParentSeenHomework(hw);
    const parentChip = parentSeen
      ? `<span class="chip chip-green" style="font-size:0.72rem; padding:2px 8px; border-radius:999px; margin-inline-start:6px;">👁️ ${(state.lang==='de'?'Gesehen':'تم الاطلاع')}</span>`
      : `<span class="chip chip-orange" style="font-size:0.72rem; padding:2px 8px; border-radius:999px; margin-inline-start:6px;">👁️ ${(state.lang==='de'?'Neu':'جديد')}</span>`;

    const meta = `${escapeHtml(normalizeDateToDMY(hw.date || ''))}`;

    // Free text homework
    const txt = (hw && (hw.text || hw.body || hw.note || hw.freeText || hw.typeText || hw.homeworkText)) ? String(hw.text || hw.body || hw.note || hw.freeText || hw.typeText || hw.homeworkText) : '';
    if(txt && (!hw.surah && !hw.surahName && !hw.surahNum && !hw.sura && !hw.surahNo)){
      const confirmBtn = !parentSeen && hw && hw.rowIndex
        ? `<button class="btn btn-sm" type="button" style="width:100%;" onclick="markStudentHomeworkSeenOne(${Number(hw.rowIndex)}, this)">${state.lang==='de' ? 'Eltern bestätigen' : 'تأكيد ولي الأمر'}</button>`
        : '';
      contEl.innerHTML += `
        <div class="card flex-col student-hw-card" style="align-items:flex-start;">
          <div style="font-weight:900; color:var(--primary);">${state.lang==='de' ? 'Hausaufgabe' : 'واجب'}</div>
          <div class="text-sm" style="white-space:pre-wrap;">${escapeHtml(txt)}</div>
          <div class="text-sm text-sec">${meta} ${parentChip}</div>
          ${confirmBtn ? `<div class="stu-hw-actions" style="flex-direction:column;">${confirmBtn}</div>` : ''}
        </div>`;
      return;
    }

    // Verse-based homework
    const info = decodeHomeworkSurah(hw.surah);
    const badge = info.badge ? `<span style="font-size:0.72rem; padding:2px 8px; border-radius:999px; background:rgba(0,0,0,0.06); margin-inline-start:6px;">${escapeHtml(info.badge)}</span>` : '';

    const confirmed = isHomeworkConfirmed(hw);
    const a1 = getAyahStart(hw);
    const a2 = getAyahEnd(hw);
    const rangeTxt = (a1 && a2) ? `${escapeHtml(a1)} - ${escapeHtml(a2)}` : escapeHtml(a1 || a2 || '');
    const rangeHtml = rangeTxt ? `<span class="hw-ayah-range ${confirmed ? 'confirmed' : 'pending'}">${rangeTxt}</span>` : '';

    const canOpen = !!info.surahNum && !!a1 && !!a2;
    const cardOnclick = canOpen
      ? `onclick="handleStudentHwCardClick(event, ${Number(info.surahNum)}, ${Number(a1)}, ${Number(a2)})"`
      : '';
    const cardCursor = canOpen ? 'cursor:pointer;' : '';

    const cardCls = confirmed ? 'hw-confirmed' : 'hw-pending';
    const confText = confirmed
      ? (state.lang === 'de' ? '✅ Bestätigt' : '✅ تم التسميع')
      : (state.lang === 'de' ? '⏳ Offen' : '⏳ غير مسمَّع');

    const openBtn = canOpen
      ? `<button class="btn btn-sm" type="button" style="flex:1;" onclick="openQuranAt(${Number(info.surahNum)}, ${Number(a1)}, ${Number(a2)}, {from:'student-hw'})">📖 ${state.lang === 'de' ? 'Öffnen' : 'فتح'}</button>`
      : '';
    const confirmBtn = !parentSeen && hw && hw.rowIndex
      ? `<button class="btn btn-sm" type="button" style="flex:1;" onclick="markStudentHomeworkSeenOne(${Number(hw.rowIndex)}, this)">${state.lang==='de' ? 'Eltern bestätigen' : 'تأكيد ولي الأمر'}</button>`
      : '';

    const actionsRow = (openBtn || confirmBtn)
      ? `<div class="stu-hw-actions">${openBtn}${confirmBtn}</div>`
      : '';

    contEl.innerHTML += `
      <div class="card flex-col student-hw-card ${cardCls}" style="align-items:flex-start; ${cardCursor}" ${cardOnclick}>
        <div style="font-weight:bold; color:var(--primary);">${escapeHtml(info.label)} ${badge}</div>
        ${rangeHtml ? `<div class="text-sm">${state.lang === 'de' ? 'Verse' : 'الآيات'}: ${rangeHtml}</div>` : ''}
        <div class="text-sm text-sec">${meta} ${parentChip}</div>
        <div class="text-sm stu-hw-status" style="font-weight:800; color:${confirmed ? 'var(--success)' : 'var(--warning)'};">${confText}</div>
        ${actionsRow}
      </div>`;
  });
}

function loadStudentHomework() {
  return fetch(WEB_APP_URL, {
      method: 'POST',
      headers: { "Content-Type": "text/plain" },
      body: JSON.stringify({ action: 'getStudentHomework', studentRef: state.studentData.referenz })
  }).then(r=>r.json()).then(res => {
      const contTab = document.getElementById('student-homework-list');
      const contHome = document.getElementById('student-home-homework-list');
      const homeHwCard = document.getElementById('stu-home-hw-card');

      const pPanel = document.getElementById('stu-hw-parentseen-panel');
      const pTitle = document.getElementById('stu-hw-parentseen-title');
      const pHint  = document.getElementById('stu-hw-parentseen-hint');
      const pBtn   = document.getElementById('btn-stu-hw-parentseen');

      _stuUnseenHomeworkRowIndices = [];

      if(res && res.ok && Array.isArray(res.homework) && res.homework.length > 0){
        try{ state.studentHomework = res.homework || []; }catch(e){}

        // Track unseen rows for "confirm all"
        res.homework.forEach(hw=>{
          const parentSeen = isParentSeenHomework(hw);
          if(!parentSeen && hw && hw.rowIndex) _stuUnseenHomeworkRowIndices.push(hw.rowIndex);
        });

        renderStudentHomeworkCards(res.homework, contTab);

        // Home should show ONLY NEW homework (as a notification), not the full list.
        const unseen = res.homework.filter(hw => !isParentSeenHomework(hw));
        // Show up to 3 newest unseen items on Home; full list remains in Aufgaben tab.
        const unseenSorted = unseen.slice().sort((a,b)=>{
          const da = String(a?.date || '');
          const db = String(b?.date || '');
          if(db !== da) return db.localeCompare(da);
          return (Number(b?.rowIndex)||0) - (Number(a?.rowIndex)||0);
        });
        const toShow = unseenSorted.slice(0, 3);

        // Home card is notification-only: hide it when there are NO new (unseen) items.
        // (Student can still access "Aufgaben" via bottom navigation.)
        if(homeHwCard) homeHwCard.classList.toggle('hidden', toShow.length === 0);

        if(contHome){
          if(toShow.length === 0){
            contHome.innerHTML = `<div class="text-sec text-center">${state.lang==='de' ? 'Keine neuen Hausaufgaben.' : 'لا توجد واجبات جديدة.'}</div>`;
          } else {
            renderStudentHomeworkCards(toShow, contHome);
            if(unseenSorted.length > toShow.length){
              contHome.innerHTML += `<div class="text-sm text-sec" style="margin-top:4px; text-align:center;">${state.lang==='de' ? `+${unseenSorted.length - toShow.length} weitere…` : `+${unseenSorted.length - toShow.length} أخرى…`} <button class="btn btn-sm btn-sec" type="button" style="margin-top:4px; width:100%;" onclick="switchTab('student-homework')">${state.lang==='de' ? 'Alle anzeigen' : 'عرض الكل'}</button></div>`;
            }
          }
        }

        // Show/hide confirm-all panel
        const hasUnseen = _stuUnseenHomeworkRowIndices.length > 0;
        if(pPanel) pPanel.classList.toggle('hidden', !hasUnseen);
        if(pTitle) pTitle.textContent = (state.lang==='de' ? 'Eltern bestätigen' : 'تأكيد ولي الأمر');
        if(pHint)  pHint.textContent  = (state.lang==='de' ? 'Bestätige, dass ein Elternteil die Hausaufgaben gesehen hat.' : 'اضغط لتأكيد اطلاع ولي الأمر على الواجبات الحالية.');
        if(pBtn)   pBtn.textContent   = (state.lang==='de' ? 'Bestätigen' : 'تأكيد');
      }
      else {
        try{ state.studentHomework = []; }catch(e){}
        if(contTab) contTab.innerHTML = `<div class="text-sec text-center">${state.lang==='de' ? 'Keine Hausaufgaben.' : 'لا توجد واجبات منزلية.'}</div>`;
        // Home is notification-only
        if(contHome) contHome.innerHTML = `<div class="text-sec text-center">${state.lang==='de' ? 'Keine neuen Hausaufgaben.' : 'لا توجد واجبات جديدة.'}</div>`;
        if(homeHwCard) homeHwCard.classList.add('hidden');
        if(pPanel) pPanel.classList.add('hidden');
      }

      return res;
  }).catch(e=>{
      const msg = (state.lang==='de' ? 'Verbindungsfehler: ' : 'خطأ في الاتصال: ') + (e?.message || e);
      try{
        const contTab = document.getElementById('student-homework-list');
        const contHome = document.getElementById('student-home-homework-list');
        const homeHwCard = document.getElementById('stu-home-hw-card');
        // On errors, keep the card visible so the user can see the message.
        if(homeHwCard) homeHwCard.classList.remove('hidden');
        if(contTab) contTab.innerHTML = `<div class="text-sec text-center">${escapeHtml(msg)}</div>`;
        if(contHome) contHome.innerHTML = `<div class="text-sec text-center">${escapeHtml(msg)}</div>`;
      }catch(_){}
      showToast(msg);
  });
}

function evalToStars(text) {
  const t = String(text || '').trim().toLowerCase();
  if(!t) return null;
  if (t.includes('sehr gut') || t.includes('ممتاز')) return 5;
  if (t.includes('gut') || t.includes('جيد')) return 4;
  if (t.includes('mittel') || t.includes('متوسط')) return 3;
  if (t.includes('schwach') || t.includes('ضعيف')) return 2;
  return 3;
}

function renderStars(n) {
  n = Math.max(0, Math.min(5, n|0));
  return '★★★★★'.slice(0,n) + '☆☆☆☆☆'.slice(0,5-n);
}

function gradeFromStars(stars){
  const s = Math.max(0, Math.min(5, Number(stars) || 0));
  // 1 = best, 6 = worst
  return Math.max(1, Math.min(6, 6 - Math.round(s)));
}

function isLateStatus(status){
  const st = String(status || '').trim().toLowerCase();
  return (st === 'تأخير' || st === 'verspätet' || st === 'late' || st.includes('versp'));
}
function isAbsentStatus(status){
  const st = String(status || '').trim().toLowerCase();
  return (st === 'غياب' || st === 'abwesend' || st === 'absent' || st.includes('abw'));
}

async function loadStudentEvaluations() {
  try{
    if(!state.studentData?.referenz) return;

    const res = await fetch(WEB_APP_URL, {
      method: 'POST',
      headers: { "Content-Type": "text/plain" },
      body: JSON.stringify({ action: 'getStudentEvaluations', studentRef: state.studentData.referenz })
    }).then(r=>r.json());

    const starsSummaryEl = document.getElementById('akte-eval-stars');
    const gradeSummaryEl = document.getElementById('akte-eval-grade');
    const listEl = document.getElementById('akte-eval-history-list');

    const evaluations = (res && res.ok && Array.isArray(res.evaluations)) ? res.evaluations : [];
    state.studentEvaluations = evaluations;
    state.studentEvaluationsLoaded = true;

    if(listEl) listEl.innerHTML = '';

    let allStars = [];

    if(evaluations.length > 0) {
      evaluations.forEach(ev => {
        const hasRating = !!String((ev.memorization||'') + (ev.tajweed||'') + (ev.behavior||'') + (ev.attendance||'')).trim();
        const d = escapeHtml(dateOnly(ev.date || ev.timestamp || ''));

        // NOTE ONLY (no rating fields)
        if(!hasRating){
          if(listEl){
            listEl.innerHTML += `
              <div class="card flex-col" style="align-items:flex-start; padding:12px; margin-bottom:6px;">
                <div style="font-weight:bold;">${d}</div>
                <div class="text-sm" style="margin-top:6px; font-style:italic;">📝 ${state.lang === 'de' ? 'Notiz' : 'ملاحظة'}</div>
                ${ev.note ? `<div class="text-sm" style="margin-top:6px; font-style:italic;">"${escapeHtml(ev.note)}"</div>` : ''}
              </div>`;
          }
          return;
        }

        const s1 = evalToStars(ev.memorization);
        const s2 = evalToStars(ev.tajweed);
        const parts = [s1, s2].filter(x => x !== null);
        const s = parts.length ? Math.round(parts.reduce((a,b)=>a+b,0) / parts.length) : null;
        if(s !== null) allStars.push(s);

        const grade = (s === null) ? null : gradeFromStars(s);

        if(listEl){
          listEl.innerHTML += `
            <div class="card flex-col" style="align-items:flex-start; padding:12px; margin-bottom:6px;">
              <div style="display:flex; width:100%; justify-content:space-between; align-items:flex-start; gap:10px;">
                <div style="font-weight:bold;">${d}</div>
                <div style="text-align:right;">
                  <div style="font-weight:900;">${s === null ? '—' : (renderStars(s) + ' (' + s + '/5)')}</div>
                  <div class="text-sm text-sec">${grade === null ? '' : ((state.lang==='de' ? 'Note' : 'التقييم') + ': ' + grade)}</div>
                </div>
              </div>
              <div class="text-sm" style="margin-top:6px;">${state.lang === 'de' ? 'Hifz' : 'الحفظ'}:
                <span style="font-weight:bold;">${s1 === null ? '—' : (renderStars(s1) + ' (' + escapeHtml(ev.memorization) + ')')}</span>
              </div>
              <div class="text-sm">${state.lang === 'de' ? 'Tajweed' : 'التجويد'}:
                <span style="font-weight:bold;">${s2 === null ? '—' : (renderStars(s2) + ' (' + escapeHtml(ev.tajweed) + ')')}</span>
              </div>
              ${ev.note ? `<div class="text-sm" style="margin-top:6px; font-style:italic;">"${escapeHtml(ev.note)}"</div>` : ''}
            </div>`;
        }
      });

      if(allStars.length > 0){
        const avg = Math.round(allStars.reduce((a,b)=>a+b,0)/allStars.length);
        const gradeAvg = gradeFromStars(avg);
        if(starsSummaryEl) starsSummaryEl.innerText = renderStars(avg) + `  (${avg}/5)`;
        if(gradeSummaryEl) gradeSummaryEl.innerText = (state.lang === 'de' ? `Note: ${gradeAvg}` : `التقييم: ${gradeAvg}`);
      } else {
        if(starsSummaryEl) starsSummaryEl.innerText = '—';
        if(gradeSummaryEl) gradeSummaryEl.innerText = '—';
      }
    } else {
      if(listEl){
        listEl.innerHTML = `<div class="text-sec text-center">${state.lang === 'de' ? 'Keine Einträge.' : 'لا توجد سجلات.'}</div>`;
      }
      if(starsSummaryEl) starsSummaryEl.innerText = '—';
      if(gradeSummaryEl) gradeSummaryEl.innerText = '—';
    }
  }catch(e){
    // Graceful fallback
    const starsSummaryEl = document.getElementById('akte-eval-stars');
    const gradeSummaryEl = document.getElementById('akte-eval-grade');
    const listEl = document.getElementById('akte-eval-history-list');
    if(listEl) listEl.innerHTML = `<div class="text-sec text-center">${state.lang === 'de' ? 'Fehler beim Laden.' : 'تعذر تحميل البيانات.'}</div>`;
    if(starsSummaryEl) starsSummaryEl.innerText = '—';
    if(gradeSummaryEl) gradeSummaryEl.innerText = '—';
  }
}

async function loadStudentAttendance(){
  try{
    if(!state.studentData?.referenz) return;

    const res = await fetch(WEB_APP_URL, {
      method: 'POST',
      headers: { "Content-Type": "text/plain" },
      body: JSON.stringify({ action: 'getStudentAttendance', studentRef: state.studentData.referenz })
    }).then(r=>r.json());

    const lateCountEl = document.getElementById('akte-att-late-count');
    const absCountEl  = document.getElementById('akte-att-abs-count');
    const listEl = document.getElementById('akte-att-history-list');

    const records = (res && res.ok && Array.isArray(res.records)) ? res.records : [];
    state.studentAttendance = records;
    state.studentAttendanceLoaded = true;

    let lateCount = 0, absCount = 0;
    for(const r of records){
      if(isLateStatus(r.status)) lateCount++;
      else if(isAbsentStatus(r.status)) absCount++;
    }

    if(lateCountEl) lateCountEl.innerText = String(lateCount);
    if(absCountEl)  absCountEl.innerText  = String(absCount);

    if(listEl){
      listEl.innerHTML = '';
      if(records.length === 0){
        listEl.innerHTML = `<div class="text-sec text-center">${state.lang === 'de' ? 'Keine Einträge.' : 'لا توجد سجلات.'}</div>`;
      } else {
        records.forEach(r => {
          const d = escapeHtml(dateOnly(r.date || ''));
          const st = String(r.status || '').trim();
          const late = isLateStatus(st);
          const abs  = isAbsentStatus(st);
          const col = abs ? 'var(--danger)' : (late ? 'var(--warning)' : 'var(--text)');
          listEl.innerHTML += `
            <div class="card flex-col" style="align-items:flex-start; padding:12px; margin-bottom:6px;">
              <div style="display:flex; width:100%; justify-content:space-between; align-items:center; gap:10px;">
                <div style="font-weight:bold;">${d}</div>
                <div style="font-weight:900; color:${col};">${escapeHtml(st)}</div>
              </div>
            </div>`;
        });
      }
    }

  }catch(e){
    const lateCountEl = document.getElementById('akte-att-late-count');
    const absCountEl  = document.getElementById('akte-att-abs-count');
    const listEl = document.getElementById('akte-att-history-list');
    if(lateCountEl) lateCountEl.innerText = '0';
    if(absCountEl)  absCountEl.innerText  = '0';
    if(listEl) listEl.innerHTML = `<div class="text-sec text-center">${state.lang === 'de' ? 'Fehler beim Laden.' : 'تعذر تحميل البيانات.'}</div>`;
  }
}


// --- Student: Fortschritt / تقدمي (confirmed memorization ranges) ---
state.studentProgress = state.studentProgress || [];
state.studentProgressLoaded = state.studentProgressLoaded || false;

// Merge overlapping/adjacent ranges within a surah (e.g. 1-6 then 3-10 => 1-10)
function mergeRanges_(ranges){
  const arr = (Array.isArray(ranges) ? ranges : [])
    .map(r => ({ start: Number(r.start||0), end: Number(r.end||0) }))
    .filter(r => Number.isFinite(r.start) && Number.isFinite(r.end) && r.start >= 1 && r.end >= r.start)
    .map(r => ({ start: Math.floor(r.start), end: Math.floor(r.end) }))
    .sort((a,b)=> a.start - b.start);

  const out = [];
  for(const r of arr){
    if(!out.length){ out.push({start:r.start, end:r.end}); continue; }
    const last = out[out.length-1];
    if(r.start <= last.end + 1){
      last.end = Math.max(last.end, r.end);
    } else {
      out.push({start:r.start, end:r.end});
    }
  }
  return out;
}

// Normalize + group progress by surah and merge ranges (prevents double count)
function normalizeStudentProgress_(progress){
  const arr = Array.isArray(progress) ? progress : [];
  const byKey = new Map();

  for(const p of arr){
    const surahText = String(p?.surahText ?? p?.surah ?? '').trim();
    const surahNum = parseSurahNumber(surahText);
    const key = surahNum ? `N:${surahNum}` : `T:${surahText}`;
    if(!surahText && !surahNum) continue;

    const entry = byKey.get(key) || {
      surahNum: surahNum || null,
      surahText: surahText || (surahNum ? String(surahNum) : ''),
      ranges: [],
      lastUpdatedKey: ''
    };

    const lk = String(p?.lastUpdatedKey ?? p?.lastUpdated ?? p?.updated ?? '').trim();
    if(lk && lk > String(entry.lastUpdatedKey || '')) entry.lastUpdatedKey = lk;

    const ranges = Array.isArray(p?.ranges) ? p.ranges : [];
    ranges.forEach(r => entry.ranges.push({ start: r?.start, end: r?.end }));

    byKey.set(key, entry);
  }

  const out = [];
  for(const entry of byKey.values()){
    const totalAyahs = entry.surahNum ? getSurahAyahCount(entry.surahNum) : 0;

    // Clamp + merge ranges
    let ranges = (entry.ranges || []).map(r => ({
      start: Math.max(1, Math.floor(Number(r.start || 0))),
      end: Math.floor(Number(r.end || 0))
    })).filter(r => Number.isFinite(r.start) && Number.isFinite(r.end) && r.end >= r.start);

    if(totalAyahs){
      ranges = ranges.map(r => ({ start: r.start, end: Math.min(totalAyahs, r.end) }))
                     .filter(r => r.end >= r.start);
    }

    ranges = mergeRanges_(ranges);

    const memorizedAyahs = ranges.reduce((acc, r) => acc + (r.end - r.start + 1), 0);
    const denom = totalAyahs || Math.max(0, ...ranges.map(r => r.end), 0);
    const pct = denom ? Math.min(100, Math.floor((memorizedAyahs / denom) * 100)) : 0;
    const complete = denom ? (memorizedAyahs >= denom) : false;

    out.push({
      ...entry,
      ranges,
      memorizedAyahs,
      totalAyahs: denom,
      pct,
      complete
    });
  }

  out.sort((a,b) => {
    const na = a.surahNum || 9999;
    const nb = b.surahNum || 9999;
    if(na !== nb) return na - nb;
    return String(a.surahText||'').localeCompare(String(b.surahText||''));
  });

  return out;
}

function fmtPct_(n){
  n = Math.max(0, Math.min(100, Number(n || 0)));
  return state.lang === 'ar' ? `${n}٪` : `${n}%`;
}

function buildProgressInlineHtml_(progress){
  const arr = Array.isArray(progress) ? progress.slice() : [];
  if(!arr.length) return '';

  // newest surahs on top (by last update), then by surah number
  arr.sort((a,b) => {
    const ka = String(a.lastUpdatedKey || '');
    const kb = String(b.lastUpdatedKey || '');
    if(kb !== ka) return kb.localeCompare(ka);

    const na = a.surahNum || parseSurahNumber(a.surahText || '') || 0;
    const nb = b.surahNum || parseSurahNumber(b.surahText || '') || 0;
    return na - nb;
  });

  return arr.map(p => {
    const surahNum = p.surahNum || parseSurahNumber(p.surahText || '');
    const label = surahNum ? getSurahLabel(surahNum) : (p.surahText || '');
    const safe = escapeHtml(label);

    if(p.complete){
      // complete: green, no percentage
      return `<div class="prog-item complete">${safe}</div>`;
    }
    // partial: red + percentage
    return `<div class="prog-item partial">${safe} ${escapeHtml(fmtPct_(p.pct))}</div>`;
  }).join('');
}


function calcTotalAyahs_(progress){
  let total = 0;
  (progress || []).forEach(p => {
    if(Number.isFinite(Number(p.memorizedAyahs))){
      total += Number(p.memorizedAyahs);
      return;
    }
    (p.ranges || []).forEach(r => {
      const s = Number(r.start || 0);
      const e = Number(r.end || 0);
      if(!isNaN(s) && !isNaN(e) && e >= s) total += (e - s + 1);
    });
  });
  return total;
}

function progressLastLabel_(progress){
  const arr = (progress || []).slice();
  arr.sort((a,b)=> String(b.lastUpdatedKey||'').localeCompare(String(a.lastUpdatedKey||'')));
  const p = arr[0];
  if(!p) return '—';
  const surahNum = p.surahNum || parseSurahNumber(p.surahText || '');
  const label = surahNum ? getSurahLabel(surahNum) : (p.surahText || '');
  const ranges = (p.ranges || []).map(r => `${r.start}-${r.end}`).join(', ');
  return (label && ranges) ? `${label} (${ranges})` : (label || ranges || '—');
}

async function loadStudentProgress(){
  try{
    if(!state.studentData?.referenz) return;

    const res = await fetch(WEB_APP_URL, {
      method: 'POST',
      headers: { "Content-Type": "text/plain" },
      body: JSON.stringify({ action: 'getStudentProgress', studentRef: state.studentData.referenz })
    }).then(r=>r.json());

    const progressRaw = (res && res.ok && Array.isArray(res.progress)) ? res.progress : [];
    const progress = normalizeStudentProgress_(progressRaw);

    state.studentProgress = progress;
    state.studentProgressLoaded = true;

    const sumEl = document.getElementById('akte-prog-sum');
    const lastEl = document.getElementById('akte-prog-last');

    if(sumEl){
      if(progress.length){
        sumEl.innerHTML = buildProgressInlineHtml_(progress);
      }else{
        sumEl.textContent = '—';
      }
    }

    if(lastEl){
      const totalAyahs = calcTotalAyahs_(progress);
      lastEl.textContent = progress.length
        ? (state.lang === 'de' ? `${totalAyahs} Verse` : `${totalAyahs} آية`)
        : '—';
    }

    renderStudentProgressList(progress);
    renderStudentHomeAchievements();
  }catch(e){
    state.studentProgress = [];
    state.studentProgressLoaded = true;
    renderStudentProgressList([]);
    renderStudentHomeAchievements();
    const sumEl = document.getElementById('akte-prog-sum');
    const lastEl = document.getElementById('akte-prog-last');
    if(sumEl) sumEl.textContent = '—';
    if(lastEl) lastEl.textContent = '—';
  }
}

function renderStudentProgressList(progress){
  const listEl = document.getElementById('akte-prog-history-list');
  if(!listEl) return;
  listEl.innerHTML = '';

  const arr = Array.isArray(progress) ? progress : [];
  if(arr.length === 0){
    listEl.innerHTML = `<div class="text-sec text-center">${state.lang === 'de' ? 'Noch keine Einträge.' : 'لا توجد إنجازات بعد.'}</div>`;
    return;
  }

  const sorted = arr.slice().sort((a,b) => {
    const na = a.surahNum || parseSurahNumber(a.surahText || '') || 9999;
    const nb = b.surahNum || parseSurahNumber(b.surahText || '') || 9999;
    if(na !== nb) return na - nb;
    return String(a.surahText||'').localeCompare(String(b.surahText||''));
  });

  sorted.forEach(p => {
    const surahNum = p.surahNum || parseSurahNumber(p.surahText || '');
    const label = surahNum ? getSurahLabel(surahNum) : (p.surahText || '');
    const ranges = (p.ranges || []).map(r => `${r.start} – ${r.end}`).join(' , ');

    const titleHtml = p.complete
      ? `<span class="prog-item complete">${escapeHtml(label)}</span>`
      : `<span class="prog-item partial">${escapeHtml(label)} ${escapeHtml(fmtPct_(p.pct))}</span>`;

    const metaRight = (p.totalAyahs && p.memorizedAyahs)
      ? `${p.memorizedAyahs}/${p.totalAyahs}`
      : (state.lang === 'de' ? `${(p.memorizedAyahs||0)} Verse` : `${(p.memorizedAyahs||0)} آية`);

    listEl.innerHTML += `
      <div class="card flex-col" style="align-items:flex-start; padding:12px;">
        <div style="display:flex; width:100%; justify-content:space-between; align-items:flex-start; gap:10px;">
          <div style="font-weight:bold;">${titleHtml}</div>
          <div class="text-sm text-sec" style="white-space:nowrap;">${escapeHtml(metaRight)}</div>
        </div>
        ${ranges ? `<div class="text-sm" style="margin-top:6px;">${state.lang === 'de' ? 'Bereich' : 'النطاق'}: <b>${escapeHtml(ranges)}</b></div>` : ''}
      </div>
    `;
  });
}

async function openStudentAkteProgress(){
  if(!state.studentProgressLoaded) await loadStudentProgress();
  openModal('stu-akte-prog-modal');
}

function renderStudentHomeAchievements(){
  const cont = document.getElementById('student-home-achievements');
  if(!cont) return;

  const progress = state.studentProgress || [];
  cont.innerHTML = '';

  cont.innerHTML += `
    <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-top:6px;">
      <div style="font-weight:800;" id="stu-home-ach-head">${state.lang === 'de' ? 'Meine Erfolge' : 'إنجازاتي'}</div>
      <div class="text-sm text-sec">${progress.length ? (state.lang === 'de' ? `${progress.length} Suren` : `${progress.length} سور`) : ''}</div>
    </div>
  `;

  if(!progress.length){
    cont.innerHTML += `<div class="text-sec text-center" style="padding:4px 0;">${state.lang === 'de' ? 'Noch keine bestätigten Fortschritte.' : 'لا توجد إنجازات مؤكدة حتى الآن.'}</div>`;
    return;
  }

  const totalAyahs = calcTotalAyahs_(progress);
  const lastLabel = progressLastLabel_(progress);

  cont.innerHTML += `
    <div class="card flex-col" style="align-items:flex-start; padding:10px; margin-top:4px;">
      <div style="display:flex; width:100%; justify-content:space-between; align-items:flex-start; gap:10px;">
        <div style="font-weight:800; color:var(--primary);">${state.lang === 'de' ? 'Fortschritt' : 'تقدمي'}</div>
        <div class="text-sm text-sec" style="white-space:nowrap;">${state.lang === 'de' ? `${totalAyahs} Verse` : `${totalAyahs} آية`}</div>
      </div>
      <div class="prog-inline" style="justify-content:flex-start; margin-top:4px;">${buildProgressInlineHtml_(progress)}</div>
      <div class="text-sm text-sec" style="margin-top:4px;">${state.lang === 'de' ? 'Zuletzt' : 'آخر تحديث'}: <b>${escapeHtml(lastLabel)}</b></div>
    </div>
  `;
}


async function openStudentAkteEval(){
  if(!state.studentEvaluationsLoaded) await loadStudentEvaluations();
  openModal('stu-akte-eval-modal');
}

async function openStudentAkteAttendance(){
  if(!state.studentAttendanceLoaded) await loadStudentAttendance();
  openModal('stu-akte-att-modal');
}

// --- Helpers (Student) ---
function escapeHtml(str){
  return String(str ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

// Format server timestamps to DATE only (hide hours/minutes)
function dateOnly(raw){
  const s = String(raw || '').trim();
  if(!s) return '';
  // dd.mm.yyyy
  const m1 = s.match(/(\d{2}\.\d{2}\.\d{4})/);
  if(m1) return m1[1];
  // yyyy-mm-dd
  const m2 = s.match(/(\d{4}-\d{2}-\d{2})/);
  if(m2){
    const parts = m2[1].split('-'); // [yyyy,mm,dd]
    if(parts.length === 3) return `${parts[2]}.${parts[1]}.${parts[0]}`;
    return m2[1];
  }
  // Fallback: Date parsing
  const d = new Date(s);
  if(!isNaN(d.getTime())){
    const loc = (state && state.lang === 'ar') ? 'ar-EG' : 'de-DE';
    return d.toLocaleDateString(loc, { day:'2-digit', month:'2-digit', year:'numeric' });
  }
  // Last resort: cut at first space
  return s.split(' ')[0];
}


const SURAH_LIST = [
  [1, "Al-Fātiha", "الفاتحة"], [2,"Al-Baqara","البقرة"], [3,"Āl ʿImrān","آل عمران"], [4,"An-Nisāʾ","النساء"],
  [5,"Al-Māʾida","المائدة"], [6,"Al-Anʿām","الأنعام"], [7,"Al-Aʿrāf","الأعراف"], [8,"Al-Anfāl","الأنفال"],
  [9,"At-Tawba","التوبة"], [10,"Yūnus","يونس"], [11,"Hūd","هود"], [12,"Yūsuf","يوسف"],
  [13,"Ar-Raʿd","الرعد"], [14,"Ibrāhīm","إبراهيم"], [15,"Al-Ḥijr","الحجر"], [16,"An-Naḥl","النحل"],
  [17,"Al-Isrāʾ","الإسراء"], [18,"Al-Kahf","الكهف"], [19,"Maryam","مريم"], [20,"Ṭā-Hā","طه"],
  [21,"Al-Anbiyāʾ","الأنبياء"], [22,"Al-Ḥajj","الحج"], [23,"Al-Muʾminūn","المؤمنون"], [24,"An-Nūr","النور"],
  [25,"Al-Furqān","الفرقان"], [26,"Ash-Shuʿarāʾ","الشعراء"], [27,"An-Naml","النمل"], [28,"Al-Qaṣaṣ","القصص"],
  [29,"Al-ʿAnkabūt","العنكبوت"], [30,"Ar-Rūm","الروم"], [31,"Luqmān","لقمان"], [32,"As-Sajda","السجدة"],
  [33,"Al-Aḥzāb","الأحزاب"], [34,"Sabaʾ","سبأ"], [35,"Fāṭir","فاطر"], [36,"Yā-Sīn","يس"],
  [37,"Aṣ-Ṣāffāt","الصافات"], [38,"Ṣād","ص"], [39,"Az-Zumar","الزمر"], [40,"Ghāfir","غافر"],
  [41,"Fuṣṣilat","فصلت"], [42,"Ash-Shūrā","الشورى"], [43,"Az-Zukhruf","الزخرف"], [44,"Ad-Dukhān","الدخان"],
  [45,"Al-Jāthiya","الجاثية"], [46,"Al-Aḥqāf","الأحقاف"], [47,"Muḥammad","محمد"], [48,"Al-Fatḥ","الفتح"],
  [49,"Al-Ḥujurāt","الحجرات"], [50,"Qāf","ق"], [51,"Adh-Dhāriyāt","الذاريات"], [52,"Aṭ-Ṭūr","الطور"],
  [53,"An-Najm","النجم"], [54,"Al-Qamar","القمر"], [55,"Ar-Raḥmān","الرحمن"], [56,"Al-Wāqiʿa","الواقعة"],
  [57,"Al-Ḥadīd","الحديد"], [58,"Al-Mujādila","المجادلة"], [59,"Al-Ḥashr","الحشر"], [60,"Al-Mumtaḥana","الممتحنة"],
  [61,"Aṣ-Ṣaff","الصف"], [62,"Al-Jumuʿa","الجمعة"], [63,"Al-Munāfiqūn","المنافقون"], [64,"At-Taghābun","التغابن"],
  [65,"Aṭ-Ṭalāq","الطلاق"], [66,"At-Taḥrīm","التحريم"], [67,"Al-Mulk","الملك"], [68,"Al-Qalem","القلم"],
  [69,"Al-Ḥāqqa","الحاقة"], [70,"Al-Maʿārij","المعارج"], [71,"Nūḥ","نوح"], [72,"Al-Jinn","الجن"],
  [73,"Al-Muzzammil","المزمل"], [74,"Al-Muddaththir","المدثر"], [75,"Al-Qiyāma","القيامة"], [76,"Al-Insān","الإنسان"],
  [77,"Al-Mursalāt","المرسلات"], [78,"An-Nabaʾ","النبأ"], [79,"An-Nāziʿāt","النازعات"], [80,"ʿAbasa","عبس"],
  [81,"At-Takwīr","التكوير"], [82,"Al-Infiṭār","الإنفطار"], [83,"Al-Muṭaffifīn","المطففين"], [84,"Al-Inshiqqāq","الإنشقاق"],
  [85,"Al-Burūj","البروج"], [86,"Aṭ-Ṭāriq","الطارق"], [87,"Al-Aʿlā","الأعلى"], [88,"Al-Ghāshiya","الغاشية"],
  [89,"Al-Fajr","الفجر"], [90,"Al-Balad","البلد"], [91,"Ash-Shams","الشمس"], [92,"Al-Layl","الليل"],
  [93,"Aḍ-Ḍuḥā","الضحى"], [94,"Ash-Sharḥ","الشرح"], [95,"At-Tīn","التين"], [96,"Al-ʿAlaq","العلق"],
  [97,"Al-Qadr","القدر"], [98,"Al-Bayyina","البينة"], [99,"Az-Zalzala","الزلزلة"], [100,"Al-ʿĀdiyāt","العاديات"],
  [101,"Al-Qāriʿa","القارعة"], [102,"At-Takāthur","التكاثر"], [103,"Al-ʿAṣr","العصر"], [104,"Al-Humaza","الهمزة"],
  [105,"Al-Fīl","الفيل"], [106,"Quraysh","قريش"], [107,"Al-Māʿūn","الماعون"], [108,"Al-Kawthar","الكوثر"],
  [109,"Al-Kāfirūn","الكافرون"], [110,"An-Naṣr","النصر"], [111,"Al-Masad","المسد"], [112,"Al-Ikhlāṣ","الإخلاص"],
  [113,"Al-Falaq","الفلق"], [114,"An-Nās","الناس"]
];

function getSurahInfo(surahNumber) {
  const row = SURAH_LIST.find(x => x[0] === surahNumber);
  if(!row) return { number: surahNumber, latin: `Sure ${surahNumber}`, arabic: `سورة ${surahNumber}` };
  return { number: row[0], latin: row[1], arabic: row[2] };
}

function initialsOfName(str){
  str = String(str||'').trim();
  if(!str) return '';
  const parts = str.split(/\s+/).filter(Boolean);
  return parts.map(p=>p[0]).join('').toLowerCase();
}

function setupHomeworkSurahDropdown(){
  const inp = document.getElementById('hw-surah');
  const dd = document.getElementById('hw-surah-dd');
  if(!inp || !dd) return;

  function close(){
    dd.classList.add('hidden');
    dd.innerHTML = '';
  }

  inp.addEventListener('input', ()=>{
    const q = (inp.value||'').trim().toLowerCase();
    dd.innerHTML = '';
    if(!q){ close(); return; }

    const matches = SURAH_LIST.filter(([num,de,ar])=>{
      const n = String(num);
      const deL = String(de).toLowerCase();
      const arS = String(ar);
      const iniDe = initialsOfName(de);
      const iniAr = initialsOfName(arS);
      return n.startsWith(q) || deL.includes(q) || arS.includes(q) || iniDe.startsWith(q) || iniAr.startsWith(q);
    }).slice(0, 20);

    if(matches.length === 0){ close(); return; }

    matches.forEach(([num,de,ar])=>{
      const item = document.createElement('div');
      item.style.padding = '8px';
      item.style.borderBottom = '1px solid var(--border)';
      item.style.cursor = 'pointer';
      item.innerHTML = `<b style=\"color:var(--primary)\">${num}</b> — ${escapeHtml(ar)}`;
      item.onclick = ()=>{
        inp.value = String(num);
        close();
      };
      dd.appendChild(item);
    });

    dd.classList.remove('hidden');
  });

  inp.addEventListener('blur', ()=> setTimeout(close, 150));
}

function getSurahLabel(n){
  const row = SURAH_LIST.find(x => x[0] === n);
  if(!row) return `Sure ${n}`;
  return `${row[1]} — ${row[2]}`;
}

// --- Homework helpers (support: TEXT|..., MEM|...) ---
function decodeHomeworkSurah(raw){
  raw = String(raw || '').trim();
  let kind = 'verses';
  let surahText = raw;
  let freeText = '';
  let badge = '';

  if(raw.startsWith('TEXT|')){
    kind = 'text';
    freeText = raw.slice(5).trim();
    surahText = '';
  } else if(raw.startsWith('MEM|')){
    kind = 'memorized';
    surahText = raw.slice(4).trim();
    badge = (state.lang === 'de' ? 'Auswendig' : 'محفوظ');
  }

  const surahNum = parseSurahNumber(surahText);
  const label = surahNum ? getSurahLabel(surahNum) : (surahText || (kind === 'text' ? (state.lang === 'de' ? 'Freier Text' : 'نص حر') : ''));
  return { kind, surahText, surahNum, label, freeText, badge };
}




// ===== Homework Edit (per entry) =====
let hwEditCtx = null; // {ref,rowIndex,orig,origConfirmed,origDate,origTeacher}

function setHwEditType(type){
  type = (type === 'text') ? 'text' : 'quran';
  const bQ = document.getElementById('hw-edit-type-quran');
  const bT = document.getElementById('hw-edit-type-text');
  if(bQ) bQ.classList.toggle('active', type==='quran');
  if(bT) bT.classList.toggle('active', type==='text');

  document.getElementById('hw-edit-quran-fields')?.classList.toggle('hidden', type!=='quran');
  document.getElementById('hw-edit-text-fields')?.classList.toggle('hidden', type!=='text');
  if(hwEditCtx) hwEditCtx.type = type;
}

function openHomeworkEditModal(ref, hw, rowIndex){
  ref = String(ref||'').trim();
  rowIndex = Number(rowIndex||0);
  if(!ref || !rowIndex) return;

  const rawSur = (hw && (hw.surah || hw.sura || hw.surahName || hw.surahNum || hw.surahNo || hw.surahText)) || '';
  const info = decodeHomeworkSurah(rawSur);

  const confirmed = (hw?.confirmed === true)
    || (String(hw?.confirmed || '').trim() === '1')
    || (String(hw?.confirmed || '').toLowerCase() === 'true')
    || (String(hw?.confirmedFlag || '').trim() === '1')
    || (String(hw?.confirmedFlag || '').toLowerCase() === 'true');

  hwEditCtx = {
    ref,
    rowIndex,
    orig: hw || {},
    origConfirmed: confirmed,
    origDate: String(hw?.date || hw?.datum || '').trim(),
    origTeacher: String(hw?.teacherName || hw?.teacher || hw?.lehrer || '').trim(),
    type: (info.kind === 'text') ? 'text' : 'quran'
  };

  const titleEl = document.getElementById('hw-edit-title');
  if(titleEl){
    titleEl.textContent = (state.lang==='de') ? 'Hausaufgabe bearbeiten' : 'تعديل الواجب';
  }

  const status = document.getElementById('hw-edit-status');
  if(status) status.textContent = '';

  // Fill fields
  if(hwEditCtx.type === 'text'){
    setHwEditType('text');
    document.getElementById('hw-edit-text').value = info.freeText || '';
  }else{
    setHwEditType('quran');
    const sur = (info.surahText || rawSur || '').replace(/^MEM\|/,'').trim();
    document.getElementById('hw-edit-surah').value = sur;
    document.getElementById('hw-edit-start').value = String(hw?.ayahStart || hw?.start || '').trim();
    document.getElementById('hw-edit-end').value = String(hw?.ayahEnd || hw?.end || '').trim();

    // autocomplete
    try{
      const inp = document.getElementById('hw-edit-surah');
      const dd  = document.getElementById('hw-edit-surah-dd');
      if(inp && dd && typeof bindSurahAutocomplete === 'function'){
        bindSurahAutocomplete(inp, dd);
      }
    }catch(e){}
  }

  openModal('hw-edit-modal');
}

async function saveHomeworkEdit(){
  if(!hwEditCtx || !hwEditCtx.ref || !hwEditCtx.rowIndex) return;

  const status = document.getElementById('hw-edit-status');
  const btn = document.getElementById('btn-hw-edit-save');
  if(status) status.textContent = (state.lang==='de') ? 'Speichere…' : 'جارٍ الحفظ…';
  if(btn) btn.disabled = true;

  const type = (hwEditCtx.type === 'text') ? 'text' : 'quran';
  const preserveConfirmed = !!hwEditCtx.origConfirmed;

  // Preserve parentSeen if it was already acknowledged by parent
  let preserveSeen = false;
  try{
    preserveSeen = (hwEditCtx.orig && (hwEditCtx.orig.parentSeen === true
      || String(hwEditCtx.orig.parentSeen||'').trim() === '1'
      || String(hwEditCtx.orig.parentSeen||'').toLowerCase() === 'true'));
  }catch(e){ preserveSeen = false; }

  let surah = '';
  let start = '';
  let end   = '';

  if(type === 'text'){
    const txt = (document.getElementById('hw-edit-text')?.value || '').trim();
    if(!txt){
      if(status) status.textContent = (state.lang==='de') ? 'Bitte Text eingeben' : 'اكتب نص الواجب';
      if(btn) btn.disabled = false;
      return;
    }
    surah = 'TEXT|' + txt;
  }else{
    surah = (document.getElementById('hw-edit-surah')?.value || '').trim();
    start = (document.getElementById('hw-edit-start')?.value || '').trim();
    end   = (document.getElementById('hw-edit-end')?.value || '').trim();
    if(!surah || !start || !end){
      if(status) status.textContent = (state.lang==='de') ? 'Bitte Sure + Versbereich ausfüllen' : 'أكمل السورة ونطاق الآيات';
      if(btn) btn.disabled = false;
      return;
    }
  }

  // 1) delete old row
  try{ await deleteHomeworkRowSilent(hwEditCtx.rowIndex); }catch(e){}

  // 2) re-assign with updated content (store requestId so we can find the new row)
  const dateLocal = hwEditCtx.origDate || getLocalDMYDate();
  const teacherName = state.user || hwEditCtx.origTeacher || '';
  const requestId = 'EDIT_' + String(hwEditCtx.rowIndex) + '_' + String(Date.now()) + '_' + Math.random().toString(16).slice(2);

  try{
    const res = await fetch(WEB_APP_URL, {
      method:'POST',
      headers: { "Content-Type": "text/plain" },
      body: JSON.stringify({
        action:'assignHomework',
        requestId,
        studentRef: hwEditCtx.ref,
        surah,
        ayahStart: start,
        ayahEnd: end,
        teacherName,
        date: dateLocal,
        clientTs: Date.now()
      })
    }).then(r=>r.json());

    if(res && res.ok){
      // find new rowIndex (by requestId)
      let newRowIndex = 0;
      try{
        const res2 = await fetch(WEB_APP_URL, {
          method:'POST',
          headers: { "Content-Type": "text/plain" },
          body: JSON.stringify({ action:'getStudentHomework', studentRef: hwEditCtx.ref })
        }).then(r=>r.json());
        const arr = (res2 && res2.ok) ? (res2.homework || []) : [];
        const found = (arr||[]).find(x => String(x?.requestId||'').trim() === requestId);
        newRowIndex = Number(found?.rowIndex || 0);
      }catch(e){ newRowIndex = 0; }

      // restore confirmation/seen status if possible
      if(newRowIndex && preserveConfirmed){
        try{ await toggleHomeworkConfirmedSilent(newRowIndex, true); }catch(e){}
      }
      if(newRowIndex && preserveSeen){
        try{
          await fetch(WEB_APP_URL, {
            method:'POST',
            headers: { "Content-Type": "text/plain" },
            body: JSON.stringify({ action:'markHomeworkParentSeen', studentRef: hwEditCtx.ref, rowIndices: [newRowIndex] })
          }).then(r=>r.json());
        }catch(e){}
      }

      if(status) status.textContent = (state.lang==='de') ? 'Gespeichert.' : 'تم الحفظ.';
      showToast(state.lang==='de' ? 'Gespeichert.' : 'تم الحفظ.');
      closeModal('hw-edit-modal');

      // refresh caches + views
      try{ hwAllHomeworkCache?.delete(String(hwEditCtx.ref)); }catch(e){}
      try{ hwAdmHomeworkCache?.delete(String(hwEditCtx.ref)); }catch(e){}

      try{ if(typeof renderHomeworkAdminStudents === 'function') renderHomeworkAdminStudents(); }catch(e){}
      try{
        if(typeof ensureHomeworkAdminLoaded === 'function' && hwAdmExpandedRefs?.has(String(hwEditCtx.ref))){
          ensureHomeworkAdminLoaded(String(hwEditCtx.ref));
        }
      }catch(e){}

      try{ if(typeof renderAllHomeworkStudents === 'function') renderAllHomeworkStudents(); }catch(e){}
      try{
        if(typeof ensureAllHomeworkLoaded === 'function' && hwAllExpandedRefs?.has(String(hwEditCtx.ref))){
          ensureAllHomeworkLoaded(String(hwEditCtx.ref));
        }
      }catch(e){}
      try{ schedulePrimeAllHomeworkOptions(); }catch(e){}

      try{
        const sRef = state.currentDetailStudent?.referenz;
        if(sRef && String(sRef) === String(hwEditCtx.ref) && typeof loadHomeworkHistory === 'function'){
          loadHomeworkHistory(sRef);
        }
      }catch(e){}
    }else{
      if(status) status.textContent = (state.lang==='de') ? 'Fehler beim Speichern.' : 'خطأ أثناء الحفظ.';
      showToast(state.lang==='de' ? 'Fehler' : 'خطأ');
    }
  }catch(e){
    if(status) status.textContent = (state.lang==='de') ? 'Netzwerkfehler.' : 'خطأ بالشبكة.';
    showToast(state.lang==='de' ? 'Netzwerkfehler' : 'خطأ بالشبكة');
  }finally{
    if(btn) btn.disabled = false;
  }
}



function renderSurahList(){
  const q = (document.getElementById('surah-search')?.value || '').trim().toLowerCase();
  const cont = document.getElementById('surah-list');
  if(!cont) return;

  cont.innerHTML = '';
  cont.style.display = 'grid';
  cont.style.gridTemplateColumns = 'repeat(auto-fill, minmax(240px, 1fr))';
  cont.style.gap = '10px';

  const rows = SURAH_LIST.filter(([num,de,ar]) => !q || String(num).includes(q) || de.toLowerCase().includes(q) || ar.includes(q));

  rows.forEach(([num,de,ar]) => {
    const ayahCount = getSurahAyahCount(num);

    const el = document.createElement('div');
    el.className = 'surah-card';
    el.innerHTML = `
      <div class="surah-left">
        <div class="surah-badge">${num}</div>
        <div class="surah-names">
          <div class="surah-ar">${escapeHtml(ar)}</div>
          <div class="surah-la">${escapeHtml(de)}</div>
          <div class="surah-meta">${state.lang === 'de' ? `${ayahCount} Verse` : `${ayahCount} آية`}</div>
        </div>
      </div>
      <button class="btn surah-open" onclick="openLesson(${num}, 1, getSurahAyahCount(${num}))">📖</button>
    `;

    el.onclick = (e) => {
      if(e.target && e.target.tagName === 'BUTTON') return;
      openLesson(num, 1, getSurahAyahCount(num));
    };

    cont.appendChild(el);
  });
}

// --- Parent absence (student / parents) ---
function todayKey(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const da = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${da}`;
}

function normId(s){
  return String(s||'').trim().toLowerCase();
}

function parentAbsentStorageKey(){
  return `qs_parent_absent:${state.studentData?.referenz || 'unknown'}:${todayKey()}`;
}

function toggleParentAbsentUI(){
  const chk = document.getElementById('chk-parent-absent');
  const extra = document.getElementById('parent-absent-extra');
  if(extra) extra.classList.toggle('hidden', !chk?.checked);
}

async function loadParentAbsentState(){
  const chk = document.getElementById('chk-parent-absent');
  const st  = document.getElementById('stu-parent-status');
  const extra = document.getElementById('parent-absent-extra');
  const reasonEl = document.getElementById('parent-absent-reason');
  const certEl   = document.getElementById('chk-parent-cert');
  if(!chk || !st || !state.studentData) return;

  // 1) Try server (sync across devices)
  try{
    const res = await fetch(WEB_APP_URL, {
      method:'POST',
      headers: { "Content-Type": "text/plain" },
      body: JSON.stringify({
        action: 'getParentAbsentStatus',
        studentRef: state.studentData.referenz,
        date: todayKey()
      })
    }).then(r=>r.json());

    if(res && res.ok){
      const val = !!res.value;
      chk.checked = val;
      if(extra) extra.classList.toggle('hidden', !val);
      if(reasonEl) reasonEl.value = res.reason || '';
      if(certEl) certEl.checked = !!res.certificate;

      // cache locally (optional)
      try { localStorage.setItem(parentAbsentStorageKey(), val ? '1' : '0'); } catch(e){}

      st.innerText = val
        ? (state.lang === 'de' ? '✅ Abwesenheit gemeldet (synchronisiert).' : '✅ تم التبليغ عن الغياب (مزامن).')
        : '';
      return;
    }
  }catch(e){
    // ignore -> fallback local
  }

  // 2) Fallback: local storage
  const val = localStorage.getItem(parentAbsentStorageKey()) === '1';
  chk.checked = val;
  if(extra) extra.classList.toggle('hidden', !val);
  st.innerText = val ? (state.lang === 'de' ? '✅ Abwesenheit gemeldet.' : '✅ تم التبليغ عن الغياب.') : '';
}

async function submitParentAbsent(){
  if(!state.studentData) return;

  const chk = document.getElementById('chk-parent-absent');
  const st  = document.getElementById('stu-parent-status');
  const isOn = !!chk?.checked;

  const reason = (document.getElementById('parent-absent-reason')?.value || '').trim();
  const cert = !!document.getElementById('chk-parent-cert')?.checked;

  // require reason when absent is ON
  if(isOn && !reason){
    showToast(state.lang === 'de' ? 'Bitte Grund eingeben.' : 'اكتب سبب الغياب.');
    return;
  }

  showToast(state.lang === 'de' ? 'Sende...' : 'جاري الإرسال...');

  try{
    const res = await fetch(WEB_APP_URL, {
      method:'POST',
      headers: { "Content-Type": "text/plain" },
      body: JSON.stringify({
        action: 'setParentAbsentStatus',
        studentRef: state.studentData.referenz,
        date: todayKey(),
        value: isOn,
        reason: reason,
        certificate: cert
      })
    }).then(r=>r.json());

    if(res && res.ok){
      // Update local cache
      try { localStorage.setItem(parentAbsentStorageKey(), isOn ? '1' : '0'); } catch(e){}
      
      // Update UI
      st.innerText = isOn 
        ? (state.lang === 'de' ? '✅ Abwesenheit gemeldet (synchronisiert).' : '✅ تم التبليغ عن الغياب (مزامن).')
        : '';
      
      showToast(state.lang === 'de' ? 'Gesendet!' : 'تم الإرسال!');
    } else {
      showToast(state.lang === 'de' ? 'Fehler beim Senden.' : 'خطأ في الإرسال.');
    }
  } catch(e) {
    showToast(state.lang === 'de' ? 'Verbindungsfehler.' : 'خطأ في الاتصال.');
  }
}

// --- Student Home absence (multi-date) ---
function homeAbsentStorageKey(dateISO){
  return `qs_parent_absent:${state.studentData?.referenz || 'unknown'}:${dateISO}`;
}

function toggleHomeAbsentUI(){
  const chk = document.getElementById('chk-home-absent');
  const panel = document.getElementById('home-absent-extra');
  const isOn = !!chk?.checked;
  if(panel) panel.classList.toggle('hidden', !isOn);

  if(isOn){
    ensureHomeAbsentDateRows();
    try{ panel.scrollIntoView({behavior:'smooth', block:'start'}); }catch(e){}
  }
}

function ensureHomeAbsentDateRows(){
  const cont = document.getElementById('home-abs-dates');
  if(!cont) return;
  const inputs = cont.querySelectorAll('input.home-abs-date');
  if(!inputs || inputs.length === 0){
    cont.innerHTML = '';
    addHomeAbsentDateRow(todayKey());
  } else {
    updateHomeAbsentDateRowControls();
  }
}

function updateHomeAbsentDateRowControls(){
  const cont = document.getElementById('home-abs-dates');
  if(!cont) return;
  const rows = Array.from(cont.querySelectorAll('.abs-date-row'));
  rows.forEach(row => {
    const btn = row.querySelector('button.abs-date-remove');
    if(btn){
      const locked = rows.length <= 1;
      btn.disabled = locked;
      btn.style.opacity = locked ? '0.45' : '1';
      btn.style.pointerEvents = locked ? 'none' : 'auto';
    }
  });
}

function addHomeAbsentDateRow(prefill){
  const cont = document.getElementById('home-abs-dates');
  if(!cont) return;

  const row = document.createElement('div');
  row.className = 'abs-date-row';
  row.style.display = 'flex';
  row.style.gap = '8px';
  row.style.alignItems = 'center';
  row.style.marginTop = cont.children.length ? '8px' : '0';

  const input = document.createElement('input');
  input.type = 'date';
  input.className = 'form-input home-abs-date';
  input.value = prefill || '';

  const btn = document.createElement('button');
  btn.type = 'button';
  btn.className = 'icon-btn abs-date-remove';
  btn.setAttribute('aria-label', 'remove-date');
  btn.style.width = '44px';
  btn.style.height = '44px';
  btn.innerHTML = '<i class="fa-solid fa-trash"></i>';
  btn.onclick = () => removeHomeAbsentDateRow(btn);

  row.appendChild(input);
  row.appendChild(btn);
  cont.appendChild(row);

  updateHomeAbsentDateRowControls();
}

function removeHomeAbsentDateRow(btn){
  const row = btn?.closest('.abs-date-row');
  if(row) row.remove();
  ensureHomeAbsentDateRows();
}

function getHomeAbsentDates(){
  const cont = document.getElementById('home-abs-dates');
  if(!cont) return [];
  const vals = Array.from(cont.querySelectorAll('input.home-abs-date'))
    .map(el => (el.value || '').trim())
    .filter(Boolean);

  const set = new Set();
  vals.forEach(v => set.add(v));
  return Array.from(set).sort();
}

async function submitHomeAbsent(){
  if(!state.studentData) return;

  const enabled = !!document.getElementById('chk-home-absent')?.checked;
  if(!enabled){
    showToast(state.lang === 'de' ? 'Bitte Checkbox aktivieren.' : 'فعّل مربع الإبلاغ عن الغياب أولاً.');
    return;
  }

  const dates = getHomeAbsentDates();
  if(!dates.length){
    showToast(state.lang === 'de' ? 'Bitte Datum auswählen.' : 'اختر تاريخ الغياب.');
    return;
  }

  const st  = document.getElementById('home-abs-status');
  const reason = (document.getElementById('home-absent-reason')?.value || '').trim();
  const cert = !!document.getElementById('chk-home-cert')?.checked;

  // Keep the same validation as before: require a reason
  if(!reason){
    showToast(state.lang === 'de' ? 'Bitte Grund eingeben.' : 'اكتب سبب الغياب.');
    return;
  }

  showToast(state.lang === 'de' ? 'Sende...' : 'جاري الإرسال...');

  let okCount = 0;
  let failCount = 0;

  for(const dateISO of dates){
    try{
      const res = await fetch(WEB_APP_URL, {
        method:'POST',
        headers: { "Content-Type": "text/plain" },
        body: JSON.stringify({
          action: 'setParentAbsentStatus',
          studentRef: state.studentData.referenz,
          date: dateISO,
          value: true,
          reason: reason,
          certificate: cert
        })
      }).then(r=>r.json());

      if(res && res.ok){
        okCount++;
        try { localStorage.setItem(homeAbsentStorageKey(dateISO), '1'); } catch(e){}

        // If the reported day is TODAY, also auto-create the attendance entry
        // so the teacher doesn't need to mark it manually.
        if(dateISO === todayKey()){
          try{
            enqueueSheetWrite({
              action: 'markAttendance',
              group: state.studentData.group,
              days: state.studentData.days,
              lastName: state.studentData.lastName,
              firstName: state.studentData.firstName,
              fullName: state.studentData.fullName,
              status: 'غياب',
              teacherName: 'Eltern/Student'
            }, { label: (state.lang === 'de') ? 'Eltern-Abmeldung' : 'تبليغ الغياب' });
            kickSyncQueue();
          }catch(e){}
        }
      } else {
        failCount++;
      }
    } catch(e) {
      failCount++;
    }
  }

  if(st){
    if(okCount > 0 && failCount === 0){
      st.innerText = (state.lang === 'de')
        ? `✅ Abwesenheit für ${okCount} Datum/Daten gemeldet.`
        : `✅ تم التبليغ عن الغياب لـ ${okCount} تاريخ/تواريخ.`;
    } else if(okCount > 0){
      st.innerText = (state.lang === 'de')
        ? `⚠️ Teilweise gesendet: ${okCount} ok, ${failCount} Fehler.`
        : `⚠️ تم الإرسال جزئياً: ${okCount} نجاح، ${failCount} فشل.`;
    } else {
      st.innerText = (state.lang === 'de') ? '❌ Fehler beim Senden.' : '❌ خطأ في الإرسال.';
    }
  }

  showToast((okCount > 0) ? (state.lang === 'de' ? 'Gesendet!' : 'تم الإرسال!') : (state.lang === 'de' ? 'Fehler.' : 'خطأ.'));
}

function initStudentHomeAbsentUI(){
  if(!state.studentData) return;

  // Default: closed panel
  const chk = document.getElementById('chk-home-absent');
  if(chk) chk.checked = false;
  const panel = document.getElementById('home-absent-extra');
  if(panel) panel.classList.add('hidden');

  // Ensure at least one date row (today)
  const cont = document.getElementById('home-abs-dates');
  if(cont){
    cont.innerHTML = '';
    addHomeAbsentDateRow(todayKey());
  }

  // reset status
  const st = document.getElementById('home-abs-status');
  if(st) st.innerText = '';
  try{ updateHomeAbsentDateRowControls(); }catch(e){}
}



// --- QURAN LESSON (Arabic + German + Audio) ---
const QURANENC_TRANSLATION_KEY = 'german_aburida';

// Ayah count for each surah (index 1..114)
const SURAH_AYAHS = [7,286,200,176,120,165,206,75,129,109,123,111,43,52,99,128,111,110,98,135,112,78,118,64,77,227,93,88,69,60,34,30,73,54,45,83,182,88,75,85,54,53,89,59,37,35,38,29,18,45,60,49,62,55,78,96,29,22,24,13,14,11,11,18,12,12,30,52,52,44,28,28,20,56,40,31,50,40,46,42,29,19,36,25,22,17,19,26,30,20,15,21,11,8,8,19,5,8,8,11,11,8,3,9,5,4,7,3,6,3,5,4,5,6];

function getSurahAyahCount(surahNumber){
  const n = parseInt(surahNumber,10);
  if(!n || n<1 || n>114) return 7;
  return SURAH_AYAHS[n-1] || 7;
}

function pad3(n) {
  n = parseInt(n, 10);
  return String(n).padStart(3, '0');
}

function everyAyahUrl(surahNumber, ayahNumber) {
  return `https://everyayah.com/data/Alafasy_64kbps/${pad3(surahNumber)}${pad3(ayahNumber)}.mp3`;
}

// Playback state for "range repeat"
let rangePlayback = {
  active:false,
  surahNumber:null,
  start:1,
  end:1,
  queue:[],
  idx:0,
  repeatLeft:1
};

function stopRangePlayback(){
  rangePlayback.active = false;
  rangePlayback.queue = [];
  rangePlayback.idx = 0;
  const audio = document.getElementById('lesson-audio');
  if(audio) {
    audio.pause();
  }
  showToast(state.lang === 'de' ? 'Gestoppt' : 'تم الإيقاف');
}

function playAssignedRange(){
  if(!rangePlayback.surahNumber) {
    showToast(state.lang === 'de' ? 'Keine Lektion geladen' : 'لم يتم تحميل الدرس');
    return;
  }
  const audio = document.getElementById('lesson-audio');
  if(!audio) return;

  const repeatSel = document.getElementById('floating-audio-repeat');
  const repeatVal = (repeatSel ? String(repeatSel.value || '1') : '1').trim();
  let repeatCount = (repeatVal === 'inf' || repeatVal === '∞') ? Infinity : (parseInt(repeatVal, 10) || 1);

  // In memorization (Hausaufgaben) mode: keep looping through all assigned ayat
  try{
    const modal = document.getElementById('lesson-modal');
    const vm = modal ? (modal.dataset.viewMode || '') : '';
    if(vm === 'memorize') repeatCount = Infinity;
  }catch(e){}

  rangePlayback.active = true;
  rangePlayback.repeatLeft = repeatCount;
  rangePlayback.idx = 0;
  rangePlayback.queue = [];
  for(let a=rangePlayback.start; a<=rangePlayback.end; a++) rangePlayback.queue.push(a);

  const surahInfo = getSurahInfo(rangePlayback.surahNumber);
  attachFloatingPlayerToAudio(audio, {
    mode: 'range',
    title: `${surahInfo.arabic} - ${surahInfo.latin} (${rangePlayback.start}-${rangePlayback.end})`,
    info: `سورة ${surahInfo.arabic} - آية ${rangePlayback.start}`
  });

  const playNext = () => {
    if(rangePlayback && rangePlayback._suspendedByWbw) return;
    if(!rangePlayback.active) return;

    if(rangePlayback.idx >= rangePlayback.queue.length) {
      rangePlayback.repeatLeft -= 1;
      if(rangePlayback.repeatLeft <= 0) {
        rangePlayback.active = false;
        showToast(state.lang === 'de' ? 'Fertig' : 'انتهى');
        hideFloatingAudio();
        return;
      }
      rangePlayback.idx = 0;
    }

    const ayah = rangePlayback.queue[rangePlayback.idx];
    rangePlayback.idx += 1;

    document.getElementById('floating-audio-info').textContent = `سورة ${surahInfo.arabic} - آية ${ayah}`;
    updateFloatingProgress();

    const el = document.querySelector(`[data-ayah-card="1"][data-ayah="${ayah}"]`);
    if(el) {
      el.scrollIntoView({behavior:'smooth', block:'center'});
      el.classList.add('selected');
      setTimeout(()=>el.classList.remove('selected'), 600);
    }

    audio.src = everyAyahUrl(rangePlayback.surahNumber, ayah);
    audio.play().catch(()=>{});
  };

  rangePlayback._playNext = playNext;
  audio.onended = playNext;
  playNext();
}

const SURAH_NAME_TO_NUM = {
  // Arabic
  "الفاتحة": 1, "البقرة": 2,
  // Common Latin
  "al-fatiha": 1, "fatiha": 1, "al fatiha": 1,
  "al-baqara": 2, "baqara": 2, "al baqara": 2,
  "ali-imran": 3, "al imran": 3, "imran": 3,
  "an-nisa": 4, "an nisa": 4, "nisa": 4,
  "al-maidah": 5, "al maidah": 5, "maidah": 5,
  "al-anam": 6, "al anam": 6, "anam": 6,
  "al-araf": 7, "al araf": 7, "araf": 7
};

function parseSurahNumber(input) {
  if (input === null || input === undefined) return null;
  const s = String(input).trim();
  if (!s) return null;

  if (/^\d+$/.test(s)) {
    const n = parseInt(s, 10);
    if (n >= 1 && n <= 114) return n;
  }

  const norm = s.toLowerCase()
    .replace(/[’'`]/g, '')
    .replace(/[\u064B-\u0652]/g, '')
    .replace(/[^a-z0-9\u0600-\u06FF\s-]/g, '')
    .replace(/\s+/g, ' ')
    .trim();

  if (SURAH_NAME_TO_NUM[norm]) return SURAH_NAME_TO_NUM[norm];

  const m1 = norm.match(/\((\d{1,3})\)/);
  if (m1) {
    const n = parseInt(m1[1], 10);
    if (n >= 1 && n <= 114) return n;
  }
  const m2 = norm.match(/^(\d{1,3})\b/);
  if (m2) {
    const n = parseInt(m2[1], 10);
    if (n >= 1 && n <= 114) return n;
  }

  return null;
}

async function fetchGermanTranslationForSura(surahNumber) {
  const url = `https://quranenc.com/api/v1/translation/sura/${QURANENC_TRANSLATION_KEY}/${surahNumber}`;
  const r = await fetch(url);
  if (!r.ok) throw new Error('QuranEnc Fehler: ' + r.status);
  const data = await r.json();
  const arr = Array.isArray(data) ? data : (data.result || data.data || data.translations || []);
  return arr;
}

async function fetchArabicSurahUthmani(surahNumber){
  const url = `https://api.quran.com/api/v4/quran/verses/uthmani?chapter_number=${surahNumber}`;
  const r = await fetch(url);
  if(!r.ok) throw new Error('Quran.com Arabic Fehler: ' + r.status);
  const data = await r.json();
  const verses = data?.verses || data?.quran_verses || data?.data || [];
  const map = new Map();
  verses.forEach(v => {
    const vk = v.verse_key || '';
    let ay = v.verse_number;
    if(!ay && vk.includes(':')) ay = parseInt(vk.split(':')[1], 10);
    const txt = v.text_uthmani || v.text || v.uthmani || '';
    if(ay) map.set(parseInt(ay,10), txt);
  });
  return map;
}

async function fetchArabicAyahFallback(surahNumber, ayahNumber) {
  const url = `https://api.alquran.cloud/v1/ayah/${surahNumber}:${ayahNumber}/quran-uthmani`;
  const r = await fetch(url);
  if (!r.ok) throw new Error('Arabic API Fehler: ' + r.status);
  const data = await r.json();
  return data?.data?.text || '';
}

// --- Quran Reader UI (mushaf / Tarteel-like) ---
let lessonFabState = { hasLesson:false, hidden:false };
let mushafFontRem = 1.65;

function arabicIndicDigits(n){
  return String(n).replace(/\d/g, d => "٠١٢٣٤٥٦٧٨٩"[parseInt(d,10)]);
}

function setReaderFabVisible(isVisible){
  const fab = document.getElementById('reader-toggle-fab');
  if(!fab) return;
  fab.classList.toggle('hidden', !isVisible);
  updateLessonFab();
}

function updateLessonFab(){
  const fab = document.getElementById('reader-toggle-fab');
  const icon = document.getElementById('reader-fab-icon');
  if(!fab || !icon) return;

  // Hide the reader toggle completely if no lesson is open
  if(!lessonFabState.hasLesson){
    fab.classList.add('hidden');
    return;
  }

  fab.classList.remove('hidden');

  if(lessonFabState.hidden){
    icon.className = 'fa-solid fa-eye';
    fab.title = (state.lang === 'de' ? 'Leser anzeigen' : 'إظهار نافذة القراءة');
  } else {
    icon.className = 'fa-solid fa-eye-slash';
    fab.title = (state.lang === 'de' ? 'Leser ausblenden' : 'إخفاء نافذة القراءة');
  }
}

function toggleLessonFab(){
  if(!lessonFabState.hasLesson){
    showToast(state.lang === 'de' ? 'Kein Leser geöffnet' : 'لا يوجد درس مفتوح');
    return;
  }
  const modal = document.getElementById('lesson-modal');
  if(!modal) return;

  const isVisible = modal.classList.contains('visible');
  if(isVisible){
    hideModalOnly('lesson-modal');
    lessonFabState.hidden = true;
  } else {
    openModal('lesson-modal');
    lessonFabState.hidden = false;
  }
  updateLessonFab();
}

function clearLessonFab(){
  lessonFabState.hasLesson = false;
  lessonFabState.hidden = false;
  updateLessonFab();
}

function toggleLessonTranslation(){
  const el = document.getElementById('lesson-translation');
  if(!el) return;
  el.classList.toggle('hidden');
}

function adjustMushafFont(delta){
  mushafFontRem = Math.max(1.15, Math.min(2.4, mushafFontRem + (delta * 0.1)));
  document.documentElement.style.setProperty('--mushaf-font', mushafFontRem + 'rem');
}


// --- Immersive Quran UI (student): hide header, show overlay bar ---
let __lessonImmersiveHideTimer = null;

function __syncLessonImmersiveBackIcon(){
  const ic = document.getElementById('lesson-immersive-backicon');
  if(!ic) return;
  ic.className = (document.documentElement.dir === 'rtl')
    ? 'fa-solid fa-arrow-right'
    : 'fa-solid fa-arrow-left';
}

function setLessonImmersiveMode(on, surahInfo=null){
  const modal = document.getElementById('lesson-modal');
  if(!modal) return;
  modal.classList.toggle('immersive', !!on);

  // Update title in overlay (doesn't take layout space)
  const ttl = document.getElementById('lesson-immersive-title');
  if(ttl && surahInfo){
    ttl.textContent = (state.lang === 'ar') ? (surahInfo.arabic || '—') : (surahInfo.latin || '—');
  }

  __syncLessonImmersiveBackIcon();
  if(!on) hideLessonImmersiveBar(true);
}

function showLessonImmersiveBar(autoHide=true){
  const modal = document.getElementById('lesson-modal');
  if(!modal || !modal.classList.contains('immersive')) return;
  // Never show immersive top controls in memorization view
  if((modal.dataset && (modal.dataset.viewMode||'')) === 'memorize') return;
  const bar = document.getElementById('lesson-immersive-bar');
  if(!bar) return;

  bar.classList.add('show');

  if(__lessonImmersiveHideTimer) clearTimeout(__lessonImmersiveHideTimer);
  if(autoHide){
    __lessonImmersiveHideTimer = setTimeout(()=> hideLessonImmersiveBar(), 1700);
  }
}

function hideLessonImmersiveBar(force=false){
  const bar = document.getElementById('lesson-immersive-bar');
  if(!bar) return;
  bar.classList.remove('show');
  if(force && __lessonImmersiveHideTimer){
    clearTimeout(__lessonImmersiveHideTimer);
    __lessonImmersiveHideTimer = null;
  }
}


let __lessonImmersiveWired = false;
function wireLessonImmersiveTaps(){
  if(__lessonImmersiveWired) return;
  __lessonImmersiveWired = true;

  // Tap anywhere in the mushaf to show controls (capture phase so it still works with stopPropagation)
  document.addEventListener('click', (e)=>{
    const modal = document.getElementById('lesson-modal');
    if(!modal || !modal.classList.contains('visible') || !modal.classList.contains('immersive')) return;
    if((modal.dataset && (modal.dataset.viewMode||'')) === 'memorize') return;
    if(e.target && e.target.closest && e.target.closest('#lesson-immersive-bar')) return;
    if(e.target && e.target.closest && e.target.closest('.quick-sheet')) return;
    showLessonImmersiveBar(true);
  }, true);
}

function setPlayingAyah(ayah){
  document.querySelectorAll('.ayah-span.playing').forEach(x => x.classList.remove('playing'));
  const el = document.querySelector(`.ayah-span[data-ayah="${ayah}"]`);
  if(el) el.classList.add('playing');
}

// ===== Multi-Tap on Ayah (2× = German meaning, 4×+ = phonetic) =====
let quickVerseSheetState = { title:'', ar:'', body:'' };

function showQuickVerseSheet({ title, sub, ar, body }) {
  const ov = document.getElementById('quick-verse-sheet');
  if(!ov) return;

  const tEl = document.getElementById('qvs-title');
  const sEl = document.getElementById('qvs-sub');
  const aEl = document.getElementById('qvs-ar');
  const bEl = document.getElementById('qvs-body');

  quickVerseSheetState = { title: title || '', ar: ar || '', body: body || '' };

  if(tEl) tEl.textContent = title || '';
  if(sEl) sEl.textContent = sub || '';
  if(aEl) aEl.textContent = ar || '';
  if(bEl) bEl.textContent = body || '';

  ov.classList.add('show');
}

function hideQuickVerseSheet(){
  document.getElementById('quick-verse-sheet')?.classList.remove('show');
}

async function copyQuickVerseSheet(){
  const txt = `${quickVerseSheetState.ar}\n\n${quickVerseSheetState.body}`.trim();
  if(!txt) return;
  try{
    await navigator.clipboard.writeText(txt);
    showToast(state.lang === 'de' ? 'Kopiert' : 'تم النسخ');
  }catch(e){
    showToast(state.lang === 'de' ? 'Kopieren nicht möglich' : 'لا يمكن النسخ');
  }
}

// A pragmatic Arabic → Latin phonetic (good enough for memorization cues)
function arabicToPhonetic(input){
  if(!input) return '';
  let s = String(input);

  // normalize Allah ligatures + remove common Quran punctuation
  s = s.replace(/ﷲ/g, 'الله')
       .replace(/[۝ۖۗۘۙۚۛۜ۞ۣ۟۠ۡۢۤۥۦۧۨ۩]/g,'')
       .replace(/[﴿﴾]/g,'')
       .replace(/\s+/g,' ')
       .trim();

  // keep spaces, remove Arabic-Indic digits and verse ornaments
  s = s.replace(/[0-9٠-٩]/g,'').replace(/[ـ]/g,''); // tatweel

  const HARAKAT = {
    '\u064B':'an', '\u064C':'un', '\u064D':'in',
    '\u064E':'a',  '\u064F':'u',  '\u0650':'i',
    '\u0652':'',   '\u0670':'a',  // sukun, dagger alif
  };
  const SHADDA = '\u0651';

  const MAP = {
    'ا':'a','أ':'a','إ':'i','آ':'aa','ٱ':'a',
    'ب':'b','ت':'t','ث':'th','ج':'j','ح':'h','خ':'kh',
    'د':'d','ذ':'dh','ر':'r','ز':'z','س':'s','ش':'sh',
    'ص':'s','ض':'d','ط':'t','ظ':'z','ع':'‘','غ':'gh',
    'ف':'f','ق':'q','ك':'k','ل':'l','م':'m','ن':'n',
    'ه':'h','ة':'a','و':'w','ي':'y','ى':'a','ء':"’",'ؤ':'u','ئ':'i',
    'ﻻ':'la','لا':'la',
  };

  // helper: strip non-letters except spaces
  const keep = s.replace(/[^\u0600-\u06FF\s]/g,' ').replace(/\s+/g,' ').trim();

  // build per-character with diacritics support
  let out = '';
  let prevCons = '';
  for(let i=0;i<keep.length;i++){
    const ch = keep[i];

    if(ch === ' '){
      out += ' ';
      prevCons = '';
      continue;
    }

    // diacritics
    if(HARAKAT[ch] !== undefined){
      out += HARAKAT[ch];
      continue;
    }
    if(ch === SHADDA){
      // double the previous consonant token
      out += prevCons;
      continue;
    }

    let token = MAP[ch];
    if(token === undefined){
      token = '';
    }

    // store last consonant-ish token for shadda doubling
    prevCons = (token && !['a','i','u','aa','an','in','un'].includes(token)) ? token : prevCons;

    out += token;
  }

  // Post-processing: clean up
  out = out
    .replace(/\s+/g,' ')
    .replace(/‘/g,'')          // optional: remove ayn marker for simplicity
    .replace(/’/g,'')          // optional: remove hamza marker
    .replace(/\bllaah\b/g,'allah') // fallback
    .trim()
    .toLowerCase();

  // Arabic definite article "ال" often becomes "al" (simplistic)
  // Fix common: "alhamd" spacing to match your example style
  out = out.replace(/^al(?=[a-z])/,'al ');

  // Some small friendly fixes
  out = out.replace(/\ballah\b/g,'allah');
  return out;
}

// Attach gesture to each ayah span without breaking existing playback
function attachAyahMultiTap(span, verse, surahNumber, verses){
  let taps = 0;
  let timer = null;

  const doPlay = () => {
    stopRangePlayback();
    setPlayingAyah(verse.ayah);
    setupFloatingAudio(surahNumber, verse.ayah, verse.ayah, verses);
  };

  const doMeaning = () => {
    const info = getSurahInfo(surahNumber);
    const title = `${info.latin} • ${surahNumber}:${verse.ayah}`;
    const body = (verse.german || '').trim() || (state.lang==='de'?'(Keine Übersetzung verfügbar)':'(لا توجد ترجمة متاحة)');
    showQuickVerseSheet({
      title,
      sub: 'Deutsch (Bedeutung) — Doppeltippen',
      ar: (verse.arabic || '').trim(),
      body
    });
  };

  const doPhonetic = () => {
    const info = getSurahInfo(surahNumber);
    const title = `${info.latin} • ${surahNumber}:${verse.ayah}`;
    const phon = arabicToPhonetic((verse.arabic || '').trim());
    showQuickVerseSheet({
      title,
      sub: 'Phonetik — 4× Tippen oder mehr',
      ar: (verse.arabic || '').trim(),
      body: phon || '(—)'
    });
  };

  span.addEventListener('click', (ev) => {
    // prevent accidental selection on fast multi-tap, and avoid bubbling to mushaf container
    try { ev.preventDefault(); } catch(e) {}
    ev.stopPropagation();

    taps += 1;
    span.classList.add('selected');

    if(timer) clearTimeout(timer);
    timer = setTimeout(() => {
      span.classList.remove('selected');
      const c = taps;
      taps = 0;

      if(c === 1) return doPlay();
      if(c === 2 || c === 3) return doMeaning();
      if(c >= 4) return doPhonetic();
    }, 340);
  }, { passive: false });
}


function renderLessonVerses({ surahNumber, surahLabel, start, end, verses, viewMode = 'mushaf' }) {
  const searchInput = document.getElementById('lesson-search-input');
  const surahNameArabic = document.getElementById('surah-name-arabic');
  const surahNameLatin = document.getElementById('surah-name-latin');
  const surahNumberSpan = document.getElementById('surah-number');
  const surahVerseCount = document.getElementById('surah-verse-count');
  const cont = document.getElementById('lesson-verses');
  const transCont = document.getElementById('lesson-translation');
  const audio = document.getElementById('lesson-audio');

  const surahInfo = getSurahInfo(surahNumber);
  if(surahNameArabic) surahNameArabic.textContent = surahInfo.arabic;
  if(surahNameLatin)  surahNameLatin.textContent = surahInfo.latin;
  if(surahNumberSpan) surahNumberSpan.textContent = state.lang === 'de' ? `Sure ${surahNumber}` : `سورة ${surahNumber}`;
  if(surahVerseCount) surahVerseCount.textContent = state.lang === 'de' ? `${verses.length} Verse` : `${verses.length} آيات`;

  rangePlayback.surahNumber = surahNumber;
  rangePlayback.start = start;
  rangePlayback.end = end;

  if(cont) cont.innerHTML = '';
  if(transCont) { transCont.innerHTML = ''; transCont.classList.add('hidden'); }

  if(audio){
    audio.pause();
    audio.removeAttribute('src');
    audio.load();
    audio.onended = null;
  }

  // Remember view mode on the modal (used for UI tweaks)
  const modal = document.getElementById('lesson-modal');
  if(modal) modal.dataset.viewMode = viewMode;

  // Hide translation toggle in memorization view (translation is shown per-ayah)
  const tBtn = document.getElementById('btn-toggle-translation');
  if(tBtn) tBtn.style.display = (viewMode === 'memorize') ? 'none' : '';

  if(viewMode === 'memorize'){
    // Memorization (save) view: each ayah as its own card with translation
    const cards = document.createElement('div');
    cards.className = 'ayah-cards';

    verses
      .filter(v => v.ayah >= start && v.ayah <= end)
      .forEach(v => {
        const ayText = (v.arabic || '').trim() || (state.lang === 'de' ? '(Arabischer Text nicht verfügbar)' : '(النص العربي غير متوفر)');

        const card = document.createElement('div');
        card.className = 'ayah-card';

        const head = document.createElement('div');
        head.className = 'ayah-card-head';

        const title = document.createElement('div');
        title.className = 'ayah-card-title';
        title.textContent = state.lang === 'de' ? `Vers ${v.ayah}` : `آية ${v.ayah}`;

        const actions = document.createElement('div');
        actions.style.display = 'flex';
        actions.style.gap = '8px';

        const btnPlay = document.createElement('button');
        btnPlay.className = 'audio-btn';
        btnPlay.textContent = '▶';
        btnPlay.title = state.lang === 'de' ? 'Abspielen' : 'تشغيل';
        btnPlay.onclick = () => {
          stopRangePlayback();
          setupFloatingAudio(surahNumber, v.ayah, v.ayah, verses);
        };

        const __phon = __arabicToPhonetic(ayText);
        let __trEl = null;

        const btnPhon = document.createElement('button');
        btnPhon.className = 'audio-btn sec';
        btnPhon.textContent = 'Ph';
        btnPhon.title = state.lang === 'de' ? 'Phonetik' : 'فونيتك';
        btnPhon.onclick = () => {
          if(!__trEl) return;
          const isPh = (__trEl.dataset.mode === 'phon');
          if(isPh){
            __trEl.dataset.mode = 'de';
            __trEl.classList.remove('phonetic');
            __trEl.textContent = __trEl.dataset.de || '';
            btnPhon.classList.remove('active');
          }else{
            __trEl.dataset.mode = 'phon';
            __trEl.classList.add('phonetic');
            __trEl.textContent = (__trEl.dataset.phon || __phon || '');
            btnPhon.classList.add('active');
          }
        };


        const btnCopy = document.createElement('button');
        btnCopy.className = 'audio-btn sec';
        btnCopy.textContent = '⧉';
        btnCopy.title = state.lang === 'de' ? 'Kopieren' : 'نسخ';
        btnCopy.onclick = async () => {
          const text = `${(v.arabic || '').trim()}

${v.german || ''}`.trim();
          try { await navigator.clipboard.writeText(text); showToast(state.lang==='de'?'Kopiert':'تم النسخ'); }
          catch(e){ showToast(state.lang==='de'?'Kopieren nicht möglich':'لا يمكن النسخ'); }
        };

        actions.appendChild(btnPlay);
        actions.appendChild(btnPhon);
        actions.appendChild(btnCopy);

        head.appendChild(title);
        head.appendChild(actions);

        const ar = document.createElement('div');
        ar.className = 'ayah-card-ar';
        const verseKey = `${surahNumber}:${v.ayah}`;
        __renderClickableAyahWords(ar, verseKey, ayText);

        const tr = document.createElement('div');
        tr.className = 'ayah-card-tr';
        tr.dataset.de = v.german || '';
        tr.dataset.phon = __phon || '';
        tr.dataset.mode = 'de';
        tr.textContent = tr.dataset.de;
        __trEl = tr;

        card.appendChild(head);
        card.appendChild(ar);
        card.appendChild(tr);
        cards.appendChild(card);
      });

    if(cont) cont.appendChild(cards);
    if(transCont) { transCont.innerHTML = ''; transCont.classList.add('hidden'); }
  } else {
  // Build mushaf-like card
    const mushafCard = document.createElement('div');
    mushafCard.className = 'mushaf-card';

    const arWrap = document.createElement('div');
    arWrap.className = 'mushaf-arabic';
    arWrap.setAttribute('lang','ar');

    verses.forEach(v => {
      const ayText = (v.arabic || '').trim() || (state.lang === 'de' ? '(Arabischer Text nicht verfügbar)' : '(النص العربي غير متوفر)');
      const span = document.createElement('span');
      span.className = 'ayah-span';
      span.dataset.ayahCard = "1";
      span.dataset.ayah = String(v.ayah);
      if(v.ayah >= start && v.ayah <= end) span.classList.add('in-range');

      attachAyahMultiTap(span, v, surahNumber, verses);

      span.appendChild(document.createTextNode(ayText + ' '));

      const num = document.createElement('span');
      num.className = 'ayah-num';
      num.textContent = (state.lang === 'ar') ? arabicIndicDigits(v.ayah) : String(v.ayah);

      span.appendChild(num);
      span.appendChild(document.createTextNode(' '));

      arWrap.appendChild(span);
    });

    mushafCard.appendChild(arWrap);
    if(cont) cont.appendChild(mushafCard);

    // Translation cards (only assigned range by default)
    if(transCont){
      verses
        .filter(v => v.ayah >= start && v.ayah <= end)
        .forEach(v => {
          const item = document.createElement('div');
          item.className = 'trans-item';

          const head = document.createElement('div');
          head.className = 'trans-head';

          const ay = document.createElement('div');
          ay.className = 'trans-ayah';
          ay.textContent = state.lang === 'de' ? `Vers ${v.ayah}` : `آية ${v.ayah}`;

          const actions = document.createElement('div');
          actions.style.display = 'flex';
          actions.style.gap = '8px';

          const btnPlay = document.createElement('button');
          btnPlay.className = 'audio-btn';
          btnPlay.textContent = state.lang === 'de' ? '▶' : '▶';
          btnPlay.title = state.lang === 'de' ? 'Abspielen' : 'تشغيل';
          btnPlay.onclick = () => {
            stopRangePlayback();
            setPlayingAyah(v.ayah);
            setupFloatingAudio(surahNumber, v.ayah, v.ayah, verses);
          };

          const btnCopy = document.createElement('button');
          btnCopy.className = 'audio-btn sec';
          btnCopy.textContent = '⧉';
          btnCopy.title = state.lang === 'de' ? 'Kopieren' : 'نسخ';
          btnCopy.onclick = async () => {
            const text = `${(v.arabic || '').trim()}\n\n${v.german || ''}`.trim();
            try { await navigator.clipboard.writeText(text); showToast(state.lang==='de'?'Kopiert':'تم النسخ'); }
            catch(e){ showToast(state.lang==='de'?'Kopieren nicht möglich':'لا يمكن النسخ'); }
          };

          actions.appendChild(btnPlay);
          actions.appendChild(btnCopy);

          head.appendChild(ay);
          head.appendChild(actions);

          const txt = document.createElement('div');
          txt.className = 'trans-text';
          txt.textContent = v.german || '';

          item.appendChild(head);
          item.appendChild(txt);
          transCont.appendChild(item);
        });
    }

  
  }
// Student: immersive mushaf (hide header for more space)
// IMPORTANT: In memorization (Hausaufgaben) view, we do NOT enable immersive top controls,
// because they look like a "strange player" flashing at the top.
  const isStudent = (String(state.role || '') === 'Student');
  const immersive = isStudent && (String(viewMode||'') !== 'memorize');

  try{
    if(String(viewMode||'') === 'memorize'){
      setLessonImmersiveMode(false, surahInfo);
      hideLessonImmersiveBar(true);
    }else{
      setLessonImmersiveMode(immersive, surahInfo);
    }
  }catch(e){}

  // Focus search input (only in non-immersive mode)
  if (searchInput && !immersive && String(viewMode||'') !== 'memorize') searchInput.focus();

  // show modal + enable fab
  lessonFabState.hasLesson = true;
  lessonFabState.hidden = false;
  updateLessonFab();

  openModal('lesson-modal');
  try{ __syncLessonMemoPlayer(true); }catch(e){}
  if(immersive) showLessonImmersiveBar(true);
}

function searchInLesson() {
  const searchInput = document.getElementById('lesson-search-input');
  const searchValue = searchInput.value.trim();
  
  if (!searchValue) return;
  
  // Check if it's a surah number
  const surahNum = parseSurahNumber(searchValue);
  if (surahNum) {
    openLesson(surahNum, 1, getSurahAyahCount(surahNum));
    searchInput.value = '';
    return;
  }
  
  // Check if it's a verse reference (e.g., 2:255)
  const verseMatch = searchValue.match(/^(\d+)[:.](\d+)$/);
  if (verseMatch) {
    const surah = parseInt(verseMatch[1]);
    const ayah = parseInt(verseMatch[2]);
    if (surah >= 1 && surah <= 114 && ayah >= 1) {
      openLesson(surah, ayah, ayah);
      searchInput.value = '';
      return;
    }
  }
  
  // Search in surah list
  const surahMatch = SURAH_LIST.find(([num, latin, arabic]) => 
    latin.toLowerCase().includes(searchValue.toLowerCase()) || 
    arabic.includes(searchValue)
  );
  
  if (surahMatch) {
    openLesson(surahMatch[0], 1, getSurahAyahCount(surahMatch[0]));
    searchInput.value = '';
    return;
  }
  
  showToast(state.lang === 'de' ? 'Nicht gefunden' : 'غير موجود');
}

async function openLesson(surahInput, start, end, opts = {}) {
  try {
    const surahNumber = (typeof surahInput === 'number') ? surahInput : parseSurahNumber(surahInput);
    if (!surahNumber) {
      alert(state.lang === 'de'
        ? 'Bitte gib die Sure als Nummer ein (1–114) oder wähle eine Sure in der Liste.'
        : 'اكتب رقم السورة (1-114) أو اخترها من القائمة.');
      return;
    }
    start = parseInt(start, 10);
    end = parseInt(end, 10);
    if (!start || !end || start < 1 || end < start) {
      alert(state.lang === 'de' ? 'Ungültiger Vers-Bereich.' : 'نطاق الآيات غير صحيح.');
      return;
    }

    const ayahCount = getSurahAyahCount(surahNumber);
    const fullStart = 1;
    const fullEnd = ayahCount;

    const viewMode = (opts && opts.viewMode) ? opts.viewMode : 'mushaf';

    showToast(state.lang === 'de' ? 'Lade Sure...' : 'جاري تحميل السورة...');

    const tArr = await fetchGermanTranslationForSura(surahNumber);
    const tMap = new Map();
    tArr.forEach(x => {
      const ay = parseInt(x.aya ?? x.ayah ?? x.verse ?? x.a, 10);
      if(ay) tMap.set(ay, x.translation || x.text || x.trans || '');
    });

    let aMap = null;
    try {
      aMap = await fetchArabicSurahUthmani(surahNumber);
    } catch(e) {
      aMap = null;
    }

    const verses = [];
    for(let ay=fullStart; ay<=fullEnd; ay++) {
      let arabic = '';
      if(aMap && aMap.get(ay)) {
        arabic = aMap.get(ay) || '';
      } else {
        try {
          arabic = await fetchArabicAyahFallback(surahNumber, ay);
        } catch(e) {
          arabic = '';
        }
      }
      verses.push({
        ayah: ay,
        arabic,
        german: tMap.get(ay) || '',
        audio_url: everyAyahUrl(surahNumber, ay)
      });
    }

    renderLessonVerses({
      surahNumber,
      surahLabel: String(surahInput || 'Sure'),
      start,
      end,
      verses,
      viewMode
    });

  } catch (e) {
    console.error(e);
    alert((state.lang === 'de' ? 'Fehler beim Laden der Verse: ' : 'خطأ أثناء تحميل الآيات: ') + (e?.message || e));
  }
}

// --- STANDARD FUNCTIONS ---
function updateLang() {
  const L = i18n[state.lang];
  document.documentElement.lang = state.lang;
  document.documentElement.dir = state.lang === 'ar' ? 'rtl' : 'ltr';
  try{ __syncLessonImmersiveBackIcon(); }catch(e){}
  document.getElementById('hdr-title').innerText = L.title;
  document.getElementById('search-input').placeholder = L.search;
  document.getElementById('lbl-groups').innerText = L.groups;
  document.getElementById('lbl-days').innerText = L.days;
  document.getElementById('lbl-cap-warn').innerText = L.capWarn;
  document.getElementById('lbl-send-msg').innerText = L.sendMsg;
  if(document.getElementById('lbl-msg-send-btn')) document.getElementById('lbl-msg-send-btn').innerText = (state.lang==='de'?'Senden':'إرسال');
  if(document.getElementById('lbl-msg-recipient-type')) document.getElementById('lbl-msg-recipient-type').innerText = (state.lang==='de'?'Empfänger':'المستلم');
  if(document.getElementById('lbl-msg-teachers')) document.getElementById('lbl-msg-teachers').innerText = (state.lang==='de'?'Lehrer auswählen:':'اختر المعلمين:');
  if(document.getElementById('lbl-msg-stu-all')) document.getElementById('lbl-msg-stu-all').innerText = (state.lang==='de'?'Alle':'الكل');
  document.getElementById('lbl-stats-title').innerText = L.statsTitle;
  if(document.getElementById('lbl-total-students')) document.getElementById('lbl-total-students').innerText = L.totalStud;
  if(document.getElementById('lbl-absent-today')) document.getElementById('lbl-absent-today').innerText = L.absentToday;
  if(document.getElementById('lbl-present-today')) document.getElementById('lbl-present-today').innerText = L.attendedToday;
  if(document.getElementById('lbl-late-today')) document.getElementById('lbl-late-today').innerText = L.lateToday;
  document.getElementById('lbl-nav-stud').innerText = L.navStud;
  document.getElementById('lbl-nav-comm').innerText = L.navComm;
  if(document.getElementById('lbl-nav-stu-comm')) document.getElementById('lbl-nav-stu-comm').innerText = L.navComm;
  document.getElementById('lbl-nav-stats').innerText = L.navStats;
  document.getElementById('lbl-nav-docs').innerText = L.navDocs;
if(document.getElementById('lbl-nav-hw')) document.getElementById('lbl-nav-hw').innerText = L.navHw || (state.lang==='de'?'Aufgaben':'الواجبات');

// Bulk Homework UI
if(document.getElementById('hw-admin-title')) document.getElementById('hw-admin-title').innerText = L.hwAdminTitle || (state.lang==='de'?'Hausaufgaben':'الواجبات المنزلية');
if(document.getElementById('hw-lbl-group')) document.getElementById('hw-lbl-group').innerText = L.hwPickGroup || (state.lang==='de'?'Gruppe wählen':'اختر القسم');
if(document.getElementById('hw-lbl-day')) document.getElementById('hw-lbl-day').innerText = L.hwPickDay || (state.lang==='de'?'Tag wählen':'اختر اليوم');
if(document.getElementById('btn-hw-load')) document.getElementById('btn-hw-load').innerText = L.hwLoadStudents || (state.lang==='de'?'Schüler anzeigen':'عرض الطلاب');
if(document.getElementById('btn-hw-use-filter')) document.getElementById('btn-hw-use-filter').innerText = L.hwUseFilter || (state.lang==='de'?'Aktuellen Filter verwenden':'استخدام الفلتر الحالي');

if(document.getElementById('txt-hw-go-all')) document.getElementById('txt-hw-go-all').innerText = (state.lang==='de'?'Übersicht':'ملخص');
if(document.getElementById('txt-hw-back')) document.getElementById('txt-hw-back').innerText = (state.lang==='de'?'Zurück':'رجوع');
if(document.getElementById('hw-all-title')) document.getElementById('hw-all-title').innerText = (state.lang==='de'?'Alle Hausaufgaben':'كل الواجبات المنزلية');
if(document.getElementById('hw-all-lbl-group')) document.getElementById('hw-all-lbl-group').innerText = (state.lang==='de'?'Gruppe wählen':'اختر القسم');
if(document.getElementById('hw-all-lbl-day')) document.getElementById('hw-all-lbl-day').innerText = (state.lang==='de'?'Tag wählen':'اختر اليوم');
if(document.getElementById('hw-all-search')) document.getElementById('hw-all-search').placeholder = (state.lang==='de'?'Suchen...':'بحث...');
if(document.getElementById('hw-all-selectall-label')) document.getElementById('hw-all-selectall-label').innerText = (state.lang==='de'?'Alle auswählen':'تحديد الكل');
if(document.getElementById('txt-hw-all-confirm')) document.getElementById('txt-hw-all-confirm').innerText = (state.lang==='de'?'Bestätigen':'تأكيد');
if(document.getElementById('txt-hw-all-unconfirm')) document.getElementById('txt-hw-all-unconfirm').innerText = (state.lang==='de'?'Bestätigung entfernen':'إلغاء التأكيد');
if(document.getElementById('hw-bulk-selectall-label')) document.getElementById('hw-bulk-selectall-label').innerText = L.hwSelectAll || (state.lang==='de'?'Alle auswählen':'تحديد الكل');
if(document.getElementById('btn-hw-assign')) document.getElementById('btn-hw-assign').innerText = L.hwAssign || (state.lang==='de'?'Hausaufgabe senden':'إرسال الواجب');
if(document.getElementById('hw-bulk-type-mem')) document.getElementById('hw-bulk-type-mem').innerText = L.hwTypeMem || (state.lang==='de'?'Auswendig (Von–Bis)':'حفظ من الآية… إلى الآية…');
if(document.getElementById('hw-bulk-type-text')) document.getElementById('hw-bulk-type-text').innerText = L.hwTypeText || (state.lang==='de'?'Freier Text':'نص حر');
if(document.getElementById('hw-bulk-search')) document.getElementById('hw-bulk-search').placeholder = L.hwSearchStud || (state.lang==='de'?'Schüler suchen...':'بحث طالب...');
  document.getElementById('lbl-docs-title').innerText = L.docsTitle;
  document.getElementById('btn-print-stud').innerText = L.printStud;
  document.getElementById('btn-edit-stud').innerText = L.editStud;
  document.getElementById('lbl-login-btn').innerText = L.loginBtn;

  // Login (redesign)
  if(document.getElementById('lbl-login-title')) document.getElementById('lbl-login-title').innerText = L.loginTitle || (state.lang === 'de' ? 'Anmelden' : 'تسجيل الدخول');
  if(document.getElementById('lbl-login-id')) document.getElementById('lbl-login-id').innerText = (state.lang === 'de' ? 'Benutzername / Student ID' : 'اسم المستخدم / رقم الطالب');
  if(document.getElementById('lbl-login-pin')) document.getElementById('lbl-login-pin').innerText = (state.lang === 'de' ? 'PIN' : 'الرقم السري');
  if(document.getElementById('lbl-login-sub')) document.getElementById('lbl-login-sub').innerText = (state.lang === 'de' ? 'Lehrer / Schüler / Admin' : 'معلم / طالب / إدارة');
  if(document.getElementById('lbl-remember')) document.getElementById('lbl-remember').innerText = (state.lang === 'de' ? 'Angemeldet bleiben' : 'تذكرني');

  document.getElementById('btn-send').innerText = 'Senden';
  document.getElementById('btn-save-stud').innerText = L.save;
  document.getElementById('btn-cancel-stud').innerText = L.cancel;
  document.getElementById('btn-delete-stud').innerText = L.delete;
  document.getElementById('lbl-student-notes').innerText = L.studentNotes;
  document.getElementById('btn-save-note').innerText = L.addNote;
  document.getElementById('lbl-nav-users').innerText = t('navUsers');
  document.getElementById('lbl-manage-users').innerText = t('manageUsers');
  if(document.getElementById('lbl-branch-users')) document.getElementById('lbl-branch-users').innerText = L.branchUsers || (state.lang==='de'?'Benutzer':'المستخدمون');
  if(document.getElementById('lbl-branch-waitlist')) document.getElementById('lbl-branch-waitlist').innerText = L.branchWaitlist || (state.lang==='de'?'Warteliste':'قائمة الإنتظار');
  if(document.getElementById('lbl-branch-groups')) document.getElementById('lbl-branch-groups').innerText = L.branchGroups || (state.lang==='de'?'Gruppen':'الأقسام');
  if(document.getElementById('lbl-waitlist-hint')) document.getElementById('lbl-waitlist-hint').innerText = L.waitlistHint || '';
  if(document.getElementById('lbl-groups-hint')) document.getElementById('lbl-groups-hint').innerText = L.groupsHint || '';
  document.getElementById('new-user-name').placeholder = t('userPlaceholder');
  document.getElementById('new-user-pin').placeholder = t('pinPlaceholder');
  document.getElementById('btn-save-user').innerText = L.save;
  document.getElementById('lbl-fin-prob').innerText = L.lblFinProb;
  document.getElementById('lbl-abgemeldet').innerText = L.lblAbgemeldet;
  if(document.getElementById('lbl-waitlist-only')) document.getElementById('lbl-waitlist-only').innerText = L.lblWaitlistOnly;

  if(document.getElementById('lbl-repeat')) document.getElementById('lbl-repeat').innerText = (state.lang==='de'?'Wiederholen':'تكرار');
  if(document.getElementById('btn-play-range')) document.getElementById('btn-play-range').innerText = (state.lang==='de'?'▶ Bereich abspielen':'▶ تشغيل المقطع');
  if(document.getElementById('btn-stop-range')) document.getElementById('btn-stop-range').innerText = (state.lang==='de'?'■ Stop':'■ إيقاف');
  if(document.getElementById('btn-parent-absent-send')) document.getElementById('btn-parent-absent-send').innerText = (state.lang==='de'?'Senden':'إرسال');
  
  // Update floating audio player buttons
  if(document.getElementById('btn-prev-ayah')) document.getElementById('btn-prev-ayah').innerText = (state.lang==='de'?'◀ Zurück':'◀ السابق');
  if(document.getElementById('btn-next-ayah')) document.getElementById('btn-next-ayah').innerText = (state.lang==='de'?'▶▶ Weiter':'▶▶ التالي');
  if(document.getElementById('floating-audio-title') && floatingAudio.title) {
    document.getElementById('floating-audio-title').textContent = floatingAudio.title;
  }

  updateFabVisibility();
  if(state.students.length > 0) renderStudentList();

  if(document.getElementById('stu-hw-title')) document.getElementById('stu-hw-title').innerText = (state.lang === 'de' ? 'Meine Hausaufgaben' : 'واجباتي');
  if(document.getElementById('stu-home-hw-title')) document.getElementById('stu-home-hw-title').innerText = (state.lang === 'de' ? 'Hausaufgaben' : 'الواجبات المنزلية');
  if(document.getElementById('stu-hw-parentseen-title')) document.getElementById('stu-hw-parentseen-title').innerText = (state.lang === 'de' ? 'Eltern: Bestätigung' : 'تأكيد اطلاع ولي الأمر');
  if(document.getElementById('stu-hw-parentseen-hint')) document.getElementById('stu-hw-parentseen-hint').innerText = (state.lang === 'de' ? 'Bitte bestätigen, dass die Hausaufgaben gelesen wurden.' : 'اضغط لتأكيد اطلاع ولي الأمر على الواجبات الحالية.');
  if(document.getElementById('btn-stu-hw-parentseen')) document.getElementById('btn-stu-hw-parentseen').innerText = (state.lang === 'de' ? 'Bestätigen' : 'تأكيد');
  if(document.getElementById('stu-mem-title')) document.getElementById('stu-mem-title').innerText = (state.lang === 'de' ? 'Auswendiglernen' : 'الحفظ');
    if(document.getElementById('stu-akte-title')) document.getElementById('stu-akte-title').innerText = 'Akte';
if(document.getElementById('akte-eval-head')) document.getElementById('akte-eval-head').innerText = (state.lang === 'de' ? 'Bewertung' : 'التقييم');
if(document.getElementById('akte-eval-sub')) document.getElementById('akte-eval-sub').innerText = (state.lang === 'de' ? 'Durchschnitt' : 'المعدل');
if(document.getElementById('akte-eval-grade') && (document.getElementById('akte-eval-grade').innerText || '').trim() === '—'){
  // keep placeholder
  // Messages tab: keep inbox labels + buttons in sync
  try{ initCommUI(); renderMessages(); }catch(e){}
}
if(document.getElementById('akte-att-head')) document.getElementById('akte-att-head').innerText = (state.lang === 'de' ? 'Anwesenheit' : 'الحضور');
if(document.getElementById('akte-att-sub')) document.getElementById('akte-att-sub').innerText = (state.lang === 'de' ? 'Verspätungen & Fehlzeiten' : 'التأخيرات والغيابات');
if(document.getElementById('akte-att-late-label')) document.getElementById('akte-att-late-label').innerText = (state.lang === 'de' ? 'Verspätungen' : 'تأخير');
if(document.getElementById('akte-att-abs-label')) document.getElementById('akte-att-abs-label').innerText = (state.lang === 'de' ? 'Fehlzeiten' : 'غياب');
if(document.getElementById('stu-akte-eval-modal-title')) document.getElementById('stu-akte-eval-modal-title').innerText = (state.lang === 'de' ? 'Bewertungen' : 'سجل التقييمات');
if(document.getElementById('stu-akte-att-modal-title')) document.getElementById('stu-akte-att-modal-title').innerText = (state.lang === 'de' ? 'Anwesenheit' : 'سجل التأخير والغياب');

  // Student: Home tab

if(document.getElementById('akte-prog-head')) document.getElementById('akte-prog-head').innerText = (state.lang === 'de' ? 'Fortschritt' : 'تقدمي');
if(document.getElementById('akte-prog-sub')) document.getElementById('akte-prog-sub').innerText = (state.lang === 'de' ? 'Auswendig gelernte Verse' : 'الآيات المحفوظة');
if(document.getElementById('stu-akte-prog-modal-title')) document.getElementById('stu-akte-prog-modal-title').innerText = (state.lang === 'de' ? 'Fortschritt' : 'تقدمي');

  // Student: Home tab
  if(document.getElementById('stu-home-title')) document.getElementById('stu-home-title').innerText = (state.lang === 'de' ? 'Home' : 'الرئيسية');
  if(document.getElementById('stu-home-abs-head')) document.getElementById('stu-home-abs-head').innerText = (state.lang === 'de' ? '- Abwesenheit melden -' : '- الإبلاغ عن الغياب -');
  if(document.getElementById('stu-home-abs-hint')) document.getElementById('stu-home-abs-hint').innerText = (state.lang === 'de'
    ? 'Wähle die Fehl-Tage (du kannst mehrere Daten hinzufügen) und sende die Abmeldung.'
    : 'اختر تواريخ الغياب (يمكنك إضافة أكثر من تاريخ) ثم أرسل البلاغ.');
  if(document.getElementById('stu-home-abs-date-label')) document.getElementById('stu-home-abs-date-label').innerText = (state.lang === 'de' ? 'Datum' : 'تاريخ الغياب');
  if(document.getElementById('stu-home-absent-label')) document.getElementById('stu-home-absent-label').innerText = (state.lang === 'de' ? 'Ich bin an diesem Tag abwesend' : 'سأكون غائباً في هذا اليوم');
  if(document.getElementById('home-cert-label')) document.getElementById('home-cert-label').innerText = (state.lang === 'de' ? 'Attest vorhanden' : 'شهادة طبية');
  if(document.getElementById('btn-home-abs-send')) document.getElementById('btn-home-abs-send').innerText = (state.lang === 'de' ? 'Senden' : 'إرسال');

  
  if(document.getElementById('lbl-home-abs-adddate')) document.getElementById('lbl-home-abs-adddate').innerText = (state.lang === 'de' ? 'Datum hinzufügen' : 'إضافة تاريخ');if(document.getElementById('stu-home-new-head')) document.getElementById('stu-home-new-head').innerText = (state.lang === 'de' ? 'Neuigkeiten' : 'المستجدات');
  if(document.getElementById('stu-home-new-sub')) document.getElementById('stu-home-new-sub').innerText = (state.lang === 'de'
    ? 'Neue Verspätung/Abwesenheit, Hausaufgabe oder Bewertung wird hier angezeigt.'
    : 'أي تأخير/غياب جديد أو واجب منزلي جديد أو تقييم جديد سيظهر هنا.');
  if(document.getElementById('stu-home-count-label')) document.getElementById('stu-home-count-label').innerText = (state.lang === 'de' ? 'Neue Einträge' : 'مستجدات');
  if(document.getElementById('stu-home-btn-markall')) document.getElementById('stu-home-btn-markall').innerText = (state.lang === 'de' ? 'Alles als gelesen' : 'تأكيد قراءة الكل');
  if(document.getElementById('stu-home-btn-hw')) document.getElementById('stu-home-btn-hw').innerText = (state.lang === 'de' ? 'Aufgaben' : 'الواجبات');
  if(document.getElementById('stu-home-btn-akte')) document.getElementById('stu-home-btn-akte').innerText = (state.lang === 'de' ? 'Akte' : 'الملف');
  if(document.getElementById('stu-home-btn-parent')) document.getElementById('stu-home-btn-parent').innerText = (state.lang === 'de' ? 'Eltern' : 'ولي الأمر');

  if(document.getElementById('stu-parent-title')) document.getElementById('stu-parent-title').innerText = (state.lang === 'de' ? 'Elterninfo' : 'معلومات ولي الأمر');
  if(document.getElementById('stu-parent-head')) document.getElementById('stu-parent-head').innerText = (state.lang === 'de' ? 'Abmeldung für heute' : 'إبلاغ الغياب لليوم');
  if(document.getElementById('stu-parent-hint')) document.getElementById('stu-parent-hint').innerText = (state.lang === 'de'
    ? 'Wenn Ihr Kind heute nicht kommt, aktivieren Sie bitte diese Option. Der Lehrer sieht dann eine Markierung beim Namen.'
    : 'إذا لم يحضر الطفل اليوم، فعّل هذا الخيار ليظهر تنبيه للمعلم بجانب اسم الطالب.');
  if(document.getElementById('stu-parent-label')) document.getElementById('stu-parent-label').innerText = (state.lang === 'de' ? 'Mein Kind ist heute abwesend' : 'طفلي غائب اليوم');
  if(document.getElementById('stu-notif-head')) document.getElementById('stu-notif-head').innerText = (state.lang === 'de' ? 'Benachrichtigungen' : 'تنبيهات');
  if(document.getElementById('stu-notif-hint')) document.getElementById('stu-notif-hint').innerText = (state.lang === 'de' ? 'Aktiviere Browser-Benachrichtigungen für neue Hinweise / Notizen (solange die Seite geöffnet ist).' : 'فعّل تنبيهات المتصفح عند وصول تنبيهات أو ملاحظات جديدة (طالما الصفحة مفتوحة).');
  if(document.getElementById('stu-notif-label')) document.getElementById('stu-notif-label').innerText = (state.lang === 'de' ? 'Bei neuen Einträgen benachrichtigen' : 'تنبيه عند وصول جديد');
    if(document.getElementById('lbl-nav-stu-home')) document.getElementById('lbl-nav-stu-home').innerText = (state.lang === 'de' ? 'Home' : 'الرئيسية');
if(document.getElementById('lbl-nav-stu-hw')) document.getElementById('lbl-nav-stu-hw').innerText = (state.lang === 'de' ? 'Aufgaben' : 'واجب');
  if(document.getElementById('lbl-nav-stu-mem')) document.getElementById('lbl-nav-stu-mem').innerText = (state.lang === 'de' ? 'Koran' : 'حفظ');
    if(document.getElementById('lbl-nav-stu-rate')) document.getElementById('lbl-nav-stu-rate').innerText = 'Akte';
  if(document.getElementById('lbl-nav-stu-parent')) document.getElementById('lbl-nav-stu-parent').innerText = (state.lang === 'de' ? 'Eltern' : 'ولي');
  if(document.getElementById('lesson-hint')) document.getElementById('lesson-hint').innerText = (state.lang === 'de' ? '🎧 Play drücken • 📖 Bedeutung lesen' : '🎧 اضغط تشغيل للاستماع • 📖 اقرأ المعنى بالألمانية');
  if(document.getElementById('surah-search')) document.getElementById('surah-search').placeholder = (state.lang === 'de' ? 'Sure suchen...' : 'ابحث عن سورة...');
  if(document.getElementById('lesson-search-input')) document.getElementById('lesson-search-input').placeholder = (state.lang === 'de' ? 'سورة أو آية... / Sure oder Vers...' : 'سورة أو آية... / Sure oder Vers...');

// Student: Parent tab - PIN change
  if(document.getElementById('stu-pin-head')) document.getElementById('stu-pin-head').innerText = (state.lang === 'de' ? 'PIN ändern' : 'تغيير الرقم السري');
  if(document.getElementById('stu-pin-hint')) document.getElementById('stu-pin-hint').innerText = (state.lang === 'de'
    ? 'Ändern Sie die PIN dieses Schülers. Bitte bewahren Sie die neue PIN sicher auf.'
    : 'يمكنك تغيير الرقم السري لهذا الطالب. الرجاء حفظ الرقم الجديد في مكان آمن.');
  if(document.getElementById('lbl-stu-old-pin')) document.getElementById('lbl-stu-old-pin').innerText = (state.lang === 'de' ? 'Alte PIN' : 'الرقم الحالي');
  if(document.getElementById('lbl-stu-new-pin')) document.getElementById('lbl-stu-new-pin').innerText = (state.lang === 'de' ? 'Neue PIN' : 'رقم جديد');
  if(document.getElementById('lbl-stu-new-pin2')) document.getElementById('lbl-stu-new-pin2').innerText = (state.lang === 'de' ? 'Neue PIN bestätigen' : 'تأكيد الرقم الجديد');
  if(document.getElementById('btn-stu-pin-save')) document.getElementById('btn-stu-pin-save').innerText = (state.lang === 'de' ? 'Speichern' : 'حفظ');


  // Re-render student progress / achievements in the new language (no new fetch)
  try{
    const totalAyahs = calcTotalAyahs_(state.studentProgress || []);
    const sumEl = document.getElementById('akte-prog-sum');
    const lastEl = document.getElementById('akte-prog-last');
    if(sumEl) sumEl.innerText = (state.studentProgress && state.studentProgress.length) ? (state.lang === 'de' ? `${totalAyahs} Verse` : `${totalAyahs} آية`) : '—';
    if(lastEl) lastEl.innerText = (state.studentProgress && state.studentProgress.length) ? progressLastLabel_(state.studentProgress) : '—';
    renderStudentProgressList(state.studentProgress || []);
    renderStudentHomeAchievements();
  }catch(e){}

  // Staff: message notifications label
  initMessageNotificationsUI();

  // Keep Aufgaben filter summary in sync
  try{ updateHomeworkFilterSummary(); }catch(e){}
}


function toggleLang() { 
  state.lang = state.lang === 'ar' ? 'de' : 'ar';
  try{ localStorage.setItem('qs_lang', state.lang); }catch(e){}
  updateLang(); 
  try{ __updateCloudIcon(); }catch(e){}
}

function toggleDarkMode() { 
  state.darkMode = !state.darkMode; 
  localStorage.setItem('darkMode', state.darkMode); 
  updateDarkModeIcon(); 
}

function updateDarkModeIcon() {
  const root = document.documentElement;
  const icon = document.getElementById('dark-mode-icon');
  if (!icon) return;
  if (state.darkMode) {
    root.classList.add('dark-mode');
    icon.classList.remove('fa-moon');
    icon.classList.add('fa-sun');
  } else {
    root.classList.remove('dark-mode');
    icon.classList.remove('fa-sun');
    icon.classList.add('fa-moon');
  }
}



function __updateHeaderHeightVar(){
  const hdr = document.querySelector('header.app-header');
  if(!hdr) return;
  document.documentElement.style.setProperty('--header-h', hdr.offsetHeight + 'px');
}


document.addEventListener('DOMContentLoaded', ()=>{
  // Restore preferred language (persist across sessions)
  try{
    const savedLang = localStorage.getItem('qs_lang');
    if(savedLang === 'ar' || savedLang === 'de') state.lang = savedLang;
  }catch(e){}
  try{ updateLang(); }catch(e){}
  try{ wireLessonImmersiveTaps(); }catch(e){}

  updateDarkModeIcon();
  __updateHeaderHeightVar();
  window.addEventListener('resize', __updateHeaderHeightVar);
  // Unified login: no manual mode switching needed
  state.loginMode = state.loginMode || 'auto';
  applyRemembered();
  try{ renderSavedProfiles(); }catch(e){}
  try{ autoLoginIfRemembered(); }catch(e){}

  try{ wireIosExitConfirm(); }catch(e){}
  try{ ensureExitGuardState(); }catch(e){}
});


function autoApplyParentAbsencesToAttendanceToday(){
  if(String(state.role || '') !== 'Lehrer') return;
  if(!state.parentAbsentSet || !state.parentAbsentSet.size) return;

  const todayDate = new Date().toLocaleDateString('de-DE', {day:'2-digit', month:'2-digit', year:'numeric'});
  let marked = 0;

  // Mark only if there is no attendance entry yet (so we don't override teacher input).
  (state.students || []).forEach(s => {
    const ref = String(s.referenz || '').trim();
    if(!ref) return;
    if(!state.parentAbsentSet.has(ref)) return;

    const existing = (state.attendance || []).find(a => a.fullName === s.fullName && a.date === todayDate);
    if(existing) return;

    // Avoid duplicate queuing in the same day if refresh happens before server returns updated attendance
    const guardKey = `qs_auto_abs:${ref}:${todayKey()}`;
    try{
      if(localStorage.getItem(guardKey) === '1') return;
      localStorage.setItem(guardKey, '1');
    }catch(e){}

    // Optimistic local UI
    state.attendance = state.attendance || [];
    state.attendance.push({ fullName: s.fullName, date: todayDate, status: 'غياب' });

    // Queue write (retry-safe)
    enqueueSheetWrite({
      action: 'markAttendance',
      group: s.group,
      days: s.days,
      lastName: s.lastName,
      firstName: s.firstName,
      fullName: s.fullName,
      status: 'غياب',
      teacherName: (state.user || '') + ' (auto)'
    }, { label: (state.lang === 'de') ? 'Auto-Abwesenheit' : 'غياب تلقائي' });

    marked++;
  });

  if(marked > 0){
    try{ kickSyncQueue(); }catch(e){}
    // Silent by default (avoid toast spam). Uncomment if you want:
    // showToast(state.lang === 'de' ? `✅ ${marked} Abwesenheit(en) automatisch gesetzt.` : `✅ تم تسجيل ${marked} غياب تلقائياً.`);
  }
}


function loadData(opts = {}) {
  opts = (opts && typeof opts === 'object') ? opts : {};
  const scope = String(opts.scope || opts.tab || 'all');

  const hdr = document.getElementById('hdr-sync');
  if(hdr) hdr.innerText = t('sync');

  return fetch(WEB_APP_URL, { 
    method: 'POST', 
    body: JSON.stringify({ action: 'getData', userName: state.user, role: state.role }) 
  })
  .then(r => r.json())
  .then(res => {
    if(res && res.ok) {
      state.students = res.students; 
      state.attendance = res.attendance; 
      state.teachers = res.teachers || [];
      try{ const r=String(state.role||''); if(r==='Admin' || r==='Lehrer' || r==='Teacher'){ loadGroupMetaAll(); } }catch(e){}
      state.lastId = res.lastId || 'N/A'; 
      state.studentInfos = res.studentInfos || []; 
      state.documents = res.documents || [];
      state.allUsers = res.allUsers || [];
      state.parentAbsencesToday = res.parentAbsencesToday || [];
      state.parentAbsentSet = new Set((state.parentAbsencesToday || []).map(x => String(x.studentRef || '').trim()).filter(Boolean));

      // Sync localStorage cache so teacher sees parent-reported absences immediately
      try {
        const k = todayKey();
        (state.students || []).forEach(st => {
          const ref = String(st.referenz || '').trim();
          if(!ref) return;
          localStorage.setItem(`qs_parent_absent:${ref}:${k}`, state.parentAbsentSet.has(ref) ? '1' : '0');
        });
      } catch(e) {}


      // Teacher: auto-mark parent-reported absences for today (no manual marking needed)
      try{ autoApplyParentAbsencesToAttendanceToday(); }catch(e){}
      // Update only the currently requested scope (so the refresh icon updates ONLY the open tab)
      if(scope === 'students'){
        initFilters();
        // Lehrer: auto-select filters based on Gruppenverwaltung schedule (if active right now)
        try{ loadGroupMetaAll().then(()=>{ try{ autoApplyTeacherFilterNow_(true); }catch(e){}; try{ startTeacherAutoFilterLoop_(); }catch(e){}; }); }catch(e){}
        try{ initBulkHomeworkUI(); }catch(e){}
  try{ initAllHomeworkUI(); }catch(e){}
        applyFilters();
        selectedForAttendance.clear();
        updateFabVisibility();
      } else if(scope === 'docs'){
        renderDocuments();
      } else if(scope === 'users'){
        if(state.role === 'Admin') renderUsersList();
      } else if(scope === 'stats'){
        renderStatistics();
      } else {
        // default full refresh (e.g., after login)
        if(state.role === 'Admin') renderUsersList();
        renderDocuments();
        populateTeacherSelect();
        initFilters();
        // Lehrer: auto-select filters based on Gruppenverwaltung schedule (if active right now)
        try{ loadGroupMetaAll().then(()=>{ try{ autoApplyTeacherFilterNow_(true); }catch(e){}; try{ startTeacherAutoFilterLoop_(); }catch(e){}; try{ applyFilters(); }catch(e){}; }); }catch(e){}
        try{ initBulkHomeworkUI(); }catch(e){}
  try{ initAllHomeworkUI(); }catch(e){}
        applyFilters();
        loadMessages();
        selectedForAttendance.clear();
        updateFabVisibility();
      }

      const now = new Date(); 
      if(hdr){
        hdr.innerText = t('syncDone') + 
          now.getHours().toString().padStart(2,'0') + ":" + 
          now.getMinutes().toString().padStart(2,'0');
      }
    }
    return res;
  });
}

async function refreshData() {
  const hdr = document.getElementById('hdr-sync');
  if(hdr) hdr.innerText = t('sync');

  const tab = navState.currentTab || getMainTabId();
  const role = String(state.role || '').toLowerCase();

  const stampDone = () => {
    const now = new Date();
    if(hdr){
      hdr.innerText = t('syncDone') + 
        now.getHours().toString().padStart(2,'0') + ":" + 
        now.getMinutes().toString().padStart(2,'0');
    }
  };

  try{
    // Student: sync only the visible tab (plus anything it depends on)
    if(role === 'student'){
      if(tab === 'student-home'){
        await Promise.all([ loadStudentHome(), loadStudentProgress() ]);
      } else if(tab === 'student-homework'){
        await loadStudentHomework();
      } else if(tab === 'student-rating'){
        await Promise.all([ loadStudentEvaluations(), loadStudentAttendance(), loadStudentProgress() ]);
      } else if(tab === 'student-parent'){
        await loadParentAbsentState();
      } else if(tab === 'comm'){
        // Student messaging: load minimal teachers list + messages
        try{ await loadTeachersForMessagingStudent(); }catch(e){}
        await loadMessages();
      } else if(tab === 'student-memorize'){
        renderSurahList();
      } else {
        await loadStudentHome();
      }
      stampDone();
      return;
    }

    // Staff/Admin: refresh ONLY the open tab
    if(tab === 'comm'){
      await loadMessages();
      stampDone();
      return;
    }
    if(tab === 'docs'){
      await loadData({scope:'docs'});
      return;
    }
    if(tab === 'users'){
      await loadData({scope:'users'});
      return;
    }
    if(tab === 'stats'){
      await loadData({scope:'stats'});
      return;
    }
    // students (default)
    await loadData({scope:'students'});
  }catch(e){
    if(hdr) hdr.innerText = (state.lang === 'de' ? 'Synchronisierung fehlgeschlagen' : 'فشلت المزامنة');
  }
}

function toggleFilter() {
  const panel = document.getElementById('filter-panel');
  if (!panel) return;
  panel.classList.toggle('open');

  // When opening, keep UI tidy
  if (!panel.classList.contains('open')) {
    closeFilters();
  } else {
    // Ensure dropdowns exist (in case of late init)
    try { initFilters(); } catch (e) {}
  }
}

function closeFilters() {
  const panel = document.getElementById('filter-panel');
  if (panel) panel.classList.remove('open');

  const wrap = document.getElementById('search-wrap');
  if (wrap) wrap.classList.add('hidden');

  const inp = document.getElementById('search-input');
  if (inp) inp.value = '';

  updateFilterState();
}

function toggleSearchBar() {
  const wrap = document.getElementById('search-wrap');
  const inp = document.getElementById('search-input');
  if (!wrap || !inp) return;

  wrap.classList.toggle('hidden');
  if (!wrap.classList.contains('hidden')) {
    inp.focus();
  } else {
    inp.value = '';
    updateFilterState();
  }
}

function handleSearchInput() {
  const val = (document.getElementById('search-input')?.value || '').trim();
  // If user searches, clear dropdown selections (to avoid confusion)
  if (val.length > 0) {
    const gSel = document.getElementById('group-select');
    const dSel = document.getElementById('day-select');
    if (gSel) gSel.value = '';
    if (dSel) dSel.value = '';
  }
  updateFilterState();
}

const DAY_DE_TO_AR = {
  "Montag": "الإثنين",
  "Dienstag": "الثلاثاء",
  "Mittwoch": "الأربعاء",
  "Donnerstag": "الخميس",
  "Freitag": "الجمعة",
  "Samstag": "السبت",
  "Sonntag": "الأحد",
};

// Match day chip key (German) against student.days string (which may be German or Arabic)
function dayMatches(studentDaysStr, dayKeyDe){
  const s = String(studentDaysStr || '');
  const lower = s.toLowerCase();

  const ar = DAY_DE_TO_AR[dayKeyDe] || '';
  const variants = [
    dayKeyDe,
    dayKeyDe.toLowerCase(),
    ar,
    ar.replace(/^ال/, ''), // sometimes stored without "ال"
    ar.replace('إ', 'ا'),
    ar.replace('أ', 'ا'),
    ar.replace('آ', 'ا'),
  ].filter(Boolean);

  return variants.some(v => s.includes(v) || lower.includes(String(v).toLowerCase()));
}


// ===== Lehrer: Auto-Filter nach Stundenplan (Gruppenverwaltung) =====
const DAY_AR_TO_DE = {
  "الأحد":"Sonntag",
  "الاحد":"Sonntag",
  "الإثنين":"Montag",
  "الاثنين":"Montag",
  "الثلاثاء":"Dienstag",
  "الاربعاء":"Mittwoch",
  "الأربعاء":"Mittwoch",
  "الخميس":"Donnerstag",
  "الجمعة":"Freitag",
  "السبت":"Samstag"
};

function normalizeDayDe_(val){
  const s = String(val || '').trim();
  if(!s) return '';
  if(DAY_AR_TO_DE[s]) return DAY_AR_TO_DE[s];
  // If already German or contains German day name
  const DAYS = ["Montag","Dienstag","Mittwoch","Donnerstag","Freitag","Samstag","Sonntag"];
  for(const d of DAYS){
    if(s.includes(d)) return d;
  }
  return s;
}

function parseTimeToMinutes_(val){
  const raw = String(val || '').trim();
  if(!raw) return null;

  // If the value is a Date-like string (e.g. "Sat Dec 30 1899 02:45:00 ..."),
  // extract the first HH:MM / HH.MM occurrence and ignore the rest.
  let m = raw.match(/(\d{1,2})\s*[:.]\s*(\d{2})/);
  if(m){
    const hh0 = parseInt(m[1],10);
    const mm0 = parseInt(m[2],10);
    if(Number.isFinite(hh0) && Number.isFinite(mm0) && hh0>=0 && hh0<=23 && mm0>=0 && mm0<=59){
      return hh0*60 + mm0;
    }
  }

  let s = raw;
  s = s.replace(/[٫،]/g, ':').replace(/[.]/g, ':'); // Arabic dot / dot
  s = s.replace(/\s/g,'');
  // keep only digits and ':'
  s = s.replace(/[^0-9:]/g,'');
  if(!s) return null;

  if(/^\d{3,4}$/.test(s)){
    // e.g. 930 or 0930 or 1430
    s = s.padStart(4,'0');
    s = s.slice(0,2) + ':' + s.slice(2);
  }
  const parts = s.split(':').filter(Boolean);
  if(parts.length < 2) return null;

  const hh = parseInt(parts[0],10);
  const mm = parseInt(parts[1],10);
  if(!Number.isFinite(hh) || !Number.isFinite(mm)) return null;
  if(hh < 0 || hh > 23 || mm < 0 || mm > 59) return null;
  return hh*60 + mm;
}


function normalizeTimeHHMM_(val){
  const raw = String(val || '').trim();
  if(!raw) return '';
  // Find an HH:MM or HH.MM pattern anywhere in the string
  let m = raw.match(/(\d{1,2})\s*[:.]\s*(\d{2})/);
  if(m){
    const hh = parseInt(m[1],10);
    const mm = parseInt(m[2],10);
    if(Number.isFinite(hh) && Number.isFinite(mm) && hh>=0 && hh<=23 && mm>=0 && mm<=59){
      return String(hh).padStart(2,'0') + ':' + String(mm).padStart(2,'0');
    }
  }
  // Also accept 3-4 digits e.g. 930, 1430
  const s2 = raw.replace(/\D/g,'');
  if(/^\d{3,4}$/.test(s2)){
    const s = s2.padStart(4,'0');
    const hh = parseInt(s.slice(0,2),10);
    const mm = parseInt(s.slice(2),10);
    if(hh>=0 && hh<=23 && mm>=0 && mm<=59){
      return String(hh).padStart(2,'0') + ':' + String(mm).padStart(2,'0');
    }
  }
  return '';
}


function getTodayDayDe_(){
  const daysMap = ["Sonntag","Montag","Dienstag","Mittwoch","Donnerstag","Freitag","Samstag"];
  return daysMap[new Date().getDay()];
}

function computeActiveTeacherSession_(){
  const role = String(state.role || '').toLowerCase();
  if(role !== 'lehrer' && role !== 'teacher') return null;

  const teacher = String(state.user || '').trim().toLowerCase();
  if(!teacher) return null;

  const now = new Date();
  const nowMin = now.getHours()*60 + now.getMinutes();
  const todayDe = getTodayDayDe_();

  const items = Object.values(state.groupMeta || {});
  const matches = [];

  for(const it of items){
    if(!it) continue;
    const itTeacher = String(it.teacher || '').trim().toLowerCase();
    if(!itTeacher) continue;
    if(itTeacher !== teacher) continue;

    const d = normalizeDayDe_(it.day);
    if(d !== todayDe) continue;

    const g = String(it.group || '').trim();
    if(!g) continue;

    const fromMin = parseTimeToMinutes_(it.timeFrom);
    const toMin   = parseTimeToMinutes_(it.timeTo);
    if(fromMin == null || toMin == null) continue;
    if(toMin <= fromMin) continue;

    if(nowMin >= fromMin && nowMin < toMin){
      matches.push({ day: todayDe, group: g, fromMin, toMin });
    }
  }

  if(!matches.length) return null;

  // Prefer the session that started most recently (closest to "now")
  matches.sort((a,b)=> b.fromMin - a.fromMin);
  
return matches[0];
}

// --- Teacher Auto-Filter Lock (keeps the chosen filter until lesson end) ---
function minutesToTodayTs_(min){
  const base = new Date();
  base.setHours(0,0,0,0);
  return base.getTime() + (Number(min)||0) * 60 * 1000;
}
function teacherAutoLockActive_(){
  const lock = state.__teacherAutoLock;
  if(!lock) return false;
  return Date.now() < Number(lock.untilTs || 0);
}
function setTeacherAutoLock_(active){
  if(!active) return;
  const untilTs = minutesToTodayTs_(active.toMin);
  state.__teacherAutoLock = {
    day: active.day,
    group: active.group,
    fromMin: active.fromMin,
    toMin: active.toMin,
    untilTs
  };

  // Schedule automatic unlock right after lesson end
  try{ if(state.__teacherAutoUnlockTmr) clearTimeout(state.__teacherAutoUnlockTmr); }catch(e){}
  const delay = Math.max(500, untilTs - Date.now() + 1500);
  state.__teacherAutoUnlockTmr = setTimeout(()=>{
    try{
      const l = state.__teacherAutoLock;
      if(!l) return;
      if(Date.now() < Number(l.untilTs||0)) return; // still active (clock drift)
      // Clear only if teacher did not manually set filters
      if(!state.__teacherFilterManual){
        // Cancel filter at lesson end
        try{ state.filter.days = []; state.filter.groups = []; }catch(e){}
        state.__teacherAutoLock = null;
        state.__teacherAutoKey = '';
        // Try to auto-apply the next session (if a new lesson starts immediately)
        try{ autoApplyTeacherFilterNow_(true); }catch(e){}
        try{ initFilters(); }catch(e){}
        try{ applyFilters(); }catch(e){}
      }
    }catch(e){}
  }, delay);
}

function markTeacherFilterManual_(){
  const role = String(state.role || '').toLowerCase();
  if(role === 'lehrer' || role === 'teacher'){
    state.__teacherFilterManual = true;
    // When teacher manually changes filters, stop any auto-lock forcing
    try{ state.__teacherAutoLock = null; }catch(e){}
    try{ state.__teacherAutoKey = ''; }catch(e){}
    try{ if(state.__teacherAutoUnlockTmr) clearTimeout(state.__teacherAutoUnlockTmr); }catch(e){}
  }
}

function autoApplyTeacherFilterNow_(force){
  const role = String(state.role || '').toLowerCase();
  if(role !== 'lehrer' && role !== 'teacher') return;

  // If the teacher manually adjusted filters, do not override (unless forced)
  if(!force && state.__teacherFilterManual) return;

  const active = computeActiveTeacherSession_();

  // If no class is active: keep current filters (do not clear automatically)
  if(!active) return;

  const key = active.day + '||' + active.group + '||' + active.fromMin + '||' + active.toMin;

  // If same active session and lock is still valid, do nothing
  if(!force && state.__teacherAutoKey === key && teacherAutoLockActive_()) return;

  state.__teacherAutoKey = key;

  // Apply filters and lock them until lesson end
  state.filter.days = [active.day];
  state.filter.groups = [active.group];
  setTeacherAutoLock_(active);

  // Re-render chips + apply
  try{ initFilters(); }catch(e){}
  try{ applyFilters(); }catch(e){}
}

// Start/refresh the auto-filter loop for teachers (checks frequently)
function startTeacherAutoFilterLoop_(){
  const role = String(state.role || '').toLowerCase();
  if(role !== 'lehrer' && role !== 'teacher') return;

  try{ if(state.__teacherAutoLoop) clearInterval(state.__teacherAutoLoop); }catch(e){}
  state.__teacherAutoLoop = setInterval(()=>{ 
    try{ autoApplyTeacherFilterNow_(false); }catch(e){} 
  }, 20*1000);
}


function initFilters() {
  const groups = [...new Set(state.students.map(s => s.group).filter(Boolean))].sort();
  const days = ["Montag", "Dienstag", "Mittwoch", "Donnerstag", "Freitag", "Samstag", "Sonntag"];

  // Groups dropdown
  const gSel = document.getElementById('group-select');
  if (gSel) {
    gSel.innerHTML = '';
    const allOpt = document.createElement('option');
    allOpt.value = '';
    allOpt.textContent = 'Alle / الكل';
    gSel.appendChild(allOpt);

    groups.forEach(g => {
      const opt = document.createElement('option');
      opt.value = g;
      opt.textContent = g;
      gSel.appendChild(opt);
    });
  }

  // Days dropdown
  const dSel = document.getElementById('day-select');
  if (dSel) {
    dSel.innerHTML = '';
    const allOpt = document.createElement('option');
    allOpt.value = '';
    allOpt.textContent = 'Alle / الكل';
    dSel.appendChild(allOpt);

    days.forEach(d => {
      const opt = document.createElement('option');
      opt.value = d;
      opt.textContent = d;
      dSel.appendChild(opt);
    });
  }

  updateFilterState();
}

function updateFilterState() {
  const gSel = document.getElementById('group-select');
  const dSel = document.getElementById('day-select');

  const gVal = String(gSel?.value || '').trim();
  const dVal = String(dSel?.value || '').trim();

  state.filter.groups = gVal ? [gVal] : [];
  state.filter.days = dVal ? [dVal] : [];

  state.filter.search = (document.getElementById('search-input')?.value || '').toLowerCase();

  const finEl = document.getElementById('chk-fin-prob');
  const abgEl = document.getElementById('chk-abgemeldet');
  state.filter.financial = !!finEl?.checked;
  state.filter.abgemeldet = !!abgEl?.checked;

  const wlEl = document.getElementById('chk-warteliste');
  state.filter.waitlistOnly = !!wlEl?.checked;

  applyFilters();
}

function applyFilters() {
  const f = state.filter;

  // Teacher: keep the auto-applied filter stable until the lesson ends (prevents "filter disappears" after refresh)
  let __teacherLockActive = false;
  try{
    const role = String(state.role || '');
    __teacherLockActive = (role === 'Lehrer' || role === 'Teacher') && !state.__teacherFilterManual && teacherAutoLockActive_();
    if(__teacherLockActive && state.__teacherAutoLock){
      const l = state.__teacherAutoLock;
      const wantDays = [l.day];
      const wantGroups = [l.group];
      const need = (f.days || []).join('|') !== wantDays.join('|') || (f.groups || []).join('|') !== wantGroups.join('|');
      if(need){
        f.days = wantDays;
        f.groups = wantGroups;
        // Sync UI chips after this call (avoid recursion)
        setTimeout(()=>{ try{ initFilters(); }catch(e){} }, 0);
      }
    }
  }catch(e){}

  function matchesDayForStudent(s){
    if(f.days.length === 0) return true;
    const dayStr = String(s.days || '');
    return f.days.some(dKey => dayMatches(dayStr, dKey));
  }

  const baseFilter = (s) => {
    let raw = s.abgemeldet;
    // Robust "withdrawn/abgemeldet" detection (supports Arabic/DE variants)
    if (raw === true) raw = "true";
    if (raw === false) raw = "false";
    const t = String(raw ?? '').trim().toLowerCase();

    const isAbgemeldet = !!t &&
      !['false','0','nein','no','n','-','—','none','null','undefined','لا','كلا'].includes(t);

    if (f.abgemeldet) {
      if (!isAbgemeldet) return false;
    } else {
      if (isAbgemeldet) return false;
    }

    const matchesGroup = f.groups.length === 0 || f.groups.includes(s.group);
    const matchesSearch = !f.search || (s.fullName + " " + s.parentName + " " + s.phone).toLowerCase().includes(f.search);

    let matchesFin = true;
    if (f.financial) {
      matchesFin = (s.kontrolleBank && s.kontrolleBank !== "") || (s.finanzMark && s.finanzMark !== "");
    }

    // apply day filter only in "normal" view (not when viewing only abgemeldet)
    let matchesDay = true;
    if (!f.abgemeldet) matchesDay = matchesDayForStudent(s);

    return matchesGroup && matchesDay && matchesSearch && matchesFin;
  };

  const __isWaitlist = (s) => String(s.warteliste || '').trim() !== '';

  state.filteredWaitlist = state.students.filter(__isWaitlist).filter(baseFilter);
  state.filteredStudents = state.students
    .filter(s => (f.waitlistOnly ? __isWaitlist(s) : !__isWaitlist(s)))
    .filter(baseFilter);

  // If day filter kills the list completely (common when days are stored in Arabic),
  // auto-clear day filter so users don't think the list is broken.
  if(
    !__teacherLockActive &&
    state.filteredStudents.length === 0 &&
    state.students.length > 0 &&
    f.days.length > 0 &&
    !f.search &&
    f.groups.length === 0 &&
    !f.financial &&
    !f.abgemeldet
  ){
    f.days = [];
    initFilters(); // re-render chips with cleared selection
    return;
  }

  const countEl = document.getElementById('student-count-result');
  if(countEl) countEl.innerText = `Gefilterte Schüler: ${state.filteredStudents.length}`;

  renderStudentList();
  renderStatistics();
  try{ renderWaitlistList(); }catch(e){}
  try{ renderGroupsCards(); }catch(e){}
  // keep Aufgaben tab in sync with the global filter
  try{ updateHomeworkFilterSummary(); }catch(e){}
  try{
    if(!document.getElementById("tab-homework-admin")?.classList.contains("hidden")){
      renderHomeworkAdminStudents();
      hwAdminQueueStatusRefresh(true);
    }
  }catch(e){}
}

function renderStudentList() {
  const container = document.getElementById('students-list'); 
  container.innerHTML = '';
  const attendanceMap = state.attendance.reduce((acc, a) => { 
    (acc[a.fullName] = acc[a.fullName] || []).push(a); 
    return acc; 
  }, {});
  
  const todayDate = new Date().toLocaleDateString('de-DE', {day:'2-digit', month:'2-digit', year:'numeric'});
  
  state.filteredStudents.forEach(s => {
    const studentAttendance = attendanceMap[s.fullName] || [];
    const todayRecord = studentAttendance.find(a => a.date === todayDate);
    const currentStatus = todayRecord ? (todayRecord.status || 'N/A') : 'N/A'; 
    const isAbsentInDB = currentStatus.includes('غياب') || currentStatus.includes('Abwesend');
    const isLateInDB = currentStatus.includes('تأخير') || currentStatus.includes('Verspätet');
const myAtt = studentAttendance.sort((a,b) => b.date.localeCompare(a.date));
    
    let consecAbsences = 0; 
    for(let i=0; i<myAtt.length; i++) { 
      if(myAtt[i].status.includes("غياب") || myAtt[i].status === "Abwesend") {
        consecAbsences++; 
      } else if (myAtt[i].status.includes("حضور")) break; 
    }
    
    const isWarning = consecAbsences >= 3;
    const isFinancial = (s.kontrolleBank && s.kontrolleBank !== "") || (s.finanzMark && s.finanzMark !== "");
    
    const el = document.createElement('div');
    const pKey = `qs_parent_absent:${s.referenz}:${todayKey()}`;
    const parentAbsent = (state.parentAbsentSet && state.parentAbsentSet.has(String(s.referenz || '').trim())) || (localStorage.getItem(pKey) === '1');
    
    el.className = 'card';
    const imgHtml = s.fotoUrl ? `<img src="${s.fotoUrl}">` : (s.firstName ? s.firstName[0] : '?');
    
    let rightSide = '';
    if(state.role === 'Lehrer') {
      let btnClass, iconSvg;
      if(isAbsentInDB) {
        btnClass = 'att-select-btn is-absent-db';
        iconSvg = `<i class="fa-solid fa-circle-xmark"></i>`;
      } else {
        btnClass = 'att-select-btn is-present';
        iconSvg = `<i class="fa-solid fa-circle-check"></i>`;
      }
      const lateBtnClass = isLateInDB ? 'att-select-btn is-late-db' : 'att-select-btn';
      const lateIcon = `<i class="fa-solid fa-clock"></i>`;
      rightSide = `<div class="attend-actions">
        <button class="${btnClass}" onclick="toggleAbsentAttendance(this, ${s.rowIndex})" title="${t('btnAbsent')}">${iconSvg}</button>
        <button class="${lateBtnClass}" onclick="toggleLateAttendance(this, ${s.rowIndex})" title="${t('btnLate')}">${lateIcon}</button>
      </div>`;
    }
    
    el.innerHTML = `
      ${(state.role === 'Admin' && isFinancial) ? '<div class="money-badge">€</div>' : ''}
      <div class="card-avatar" onclick="openStudentDetail(${s.rowIndex})">${imgHtml}</div>
      <div class="card-info" onclick="openStudentDetail(${s.rowIndex})">
        <div class="font-bold" style="color: var(--text);">${s.fullName} ${(state.role !== 'Lehrer') ? `<span style="font-size:0.7rem; color:var(--primary);">[${s.referenz}]</span>` : ''}</div>
        ${parentAbsent ? `<div class="status-badge" style="background: var(--danger); color: white; opacity:0.9;"><i class="fa-solid fa-ban"></i> ${state.lang === 'de' ? 'Abwesend gemeldet' : 'مبلّغ غياب'}</div>` : ''}
        ${isLateInDB ? `<div class="status-badge" style="background: var(--warning); color: var(--text); opacity:0.9;"><i class="fa-solid fa-clock"></i> ${state.lang === 'de' ? 'Verspätet' : 'متأخر'}</div>` : ''}
        <div class="text-sm text-sec">${s.group} • ${s.days}</div>
        ${isWarning ? `<span class="status-badge status-warning">${t('repeatedAbs')}</span>` : ''}
        ${s.abgemeldet ? `<span class="status-badge status-warning">Abgemeldet</span>` : ''}
      </div>
      ${rightSide}
    `;
    
    container.appendChild(el);
  });
}


function toggleAbsentAttendance(btnElement, rowIndex) {
  const s = state.students.find(x => x.rowIndex === rowIndex);
  if(!s) return;

  // Build a map for quick lookup (fullName -> records)
  const todayDate = new Date().toLocaleDateString('de-DE', {day:'2-digit', month:'2-digit', year:'numeric'});
  const studentAttendance = (state.attendance || []).filter(a => a.fullName === s.fullName);
  const todayRecord = studentAttendance.find(a => a.date === todayDate);
  const currentStatus = todayRecord ? (todayRecord.status || 'N/A') : 'N/A';
  const isAbsentInDB = String(currentStatus).includes('غياب') || String(currentStatus).includes('Abwesend');

  // Toggle
  const newStatus = isAbsentInDB ? 'NULL' : 'غياب';

  // 1) Optimistic UI update
  if(todayRecord){
    todayRecord.status = newStatus;
  } else {
    state.attendance = state.attendance || [];
    state.attendance.push({ fullName: s.fullName, date: todayDate, status: newStatus });
  }

  // Re-render immediately
  renderStudentList();

  // 2) Background save (queue + retry)
  enqueueSheetWrite({
    action: 'markAttendance',
    group: s.group,
    days: s.days,
    lastName: s.lastName,
    firstName: s.firstName,
    fullName: s.fullName,
    status: newStatus,
    teacherName: state.user
  }, { label: (state.lang === 'de') ? 'Abwesenheit' : 'غياب' });

  // UX feedback
  if(newStatus === 'NULL'){
    showToast(state.lang === 'de' ? 'Abwesenheit entfernt (wird gespeichert...)' : 'تم حذف الغياب (جارٍ الحفظ...)');
  } else {
    showToast(state.lang === 'de' ? 'Abwesenheit gesetzt (wird gespeichert...)' : 'تم تسجيل الغياب (جارٍ الحفظ...)');
  }

  // kick background processing
  kickSyncQueue();
}




function toggleLateAttendance(btnElement, rowIndex) {
  const s = state.students.find(x => x.rowIndex == rowIndex);
  if(!s) return;

  const todayDate = new Date().toLocaleDateString('de-DE', {day:'2-digit', month:'2-digit', year:'numeric'});
  const todayRecord = state.attendance.find(a => a.fullName === s.fullName && a.date === todayDate);
  const currentStatus = todayRecord ? (todayRecord.status || '') : '';
  const isLate = currentStatus.includes('تأخير') || currentStatus.includes('Verspätet');
  const newStatus = isLate ? 'NULL' : 'تأخير';

  // 1) Optimistic UI update (instant)
  if(todayRecord){
    todayRecord.status = newStatus;
  } else {
    state.attendance.push({ fullName: s.fullName, date: todayDate, status: newStatus });
  }

  // Re-render immediately so the button/badge becomes orange/normal right away
  renderStudentList();
  updateFabVisibility();

  // 2) Background save (queue + retry)
  enqueueSheetWrite({
    action: 'markAttendance',
    group: s.group,
    days: s.days,
    lastName: s.lastName,
    firstName: s.firstName,
    fullName: s.fullName,
    status: newStatus,
    teacherName: state.user
  }, { label: (state.lang === 'de') ? 'Verspätung' : 'تأخير' });

  // UX feedback
  if(newStatus === 'NULL'){
    showToast(state.lang === 'de' ? 'Verspätung entfernt (wird gespeichert...)' : 'تم حذف التأخير (جارٍ الحفظ...)');
  } else {
    showToast(state.lang === 'de' ? 'Verspätung gesetzt (wird gespeichert...)' : 'تم تسجيل التأخير (جارٍ الحفظ...)');
  }

  // kick background processing (safe)
  kickSyncQueue();
}


function updateFabVisibility() { 
  const fab = document.getElementById('fab-attendance'); 
  if(selectedForAttendance.size > 0) { 
    fab.classList.add('show'); 
    document.getElementById('lbl-send-btn').innerText = `${t('sendBatch')} (${selectedForAttendance.size})`; 
  } else { 
    fab.classList.remove('show'); 
  } 
}

async function submitBatchAttendance() {
  if(selectedForAttendance.size === 0) return;
  const studentsToProcess = state.students.filter(s => selectedForAttendance.has(s.rowIndex));
  document.getElementById('fab-attendance').classList.remove('show');
  document.getElementById('progress-overlay').classList.add('visible');
  const todayDate = new Date().toLocaleDateString('de-DE', {day:'2-digit', month:'2-digit', year:'numeric'});
  const attendanceMap = state.attendance.reduce((acc, a) => { 
    (acc[a.fullName] = acc[a.fullName] || []).push(a); 
    return acc; 
  }, {});
  
  let processedCount = 0;

  for (const s of studentsToProcess) {
    const currentStatus = (attendanceMap[s.fullName] || []).find(a => a.date === todayDate)?.status || 'N/A';
    let newStatus = (currentStatus.includes('غياب') || currentStatus.includes('Abwesend')) ? 'NULL' : 'غياب';
    
    await fetch(WEB_APP_URL, { 
      method: 'POST', 
      body: JSON.stringify({ 
        action: 'markAttendance', 
        group: s.group, 
        days: s.days, 
        lastName: s.lastName, 
        firstName: s.firstName, 
        fullName: s.fullName, 
        status: newStatus, 
        teacherName: state.user 
      }) 
    });
    
    processedCount++;
    document.getElementById('progress-fill').style.width = `${(processedCount / studentsToProcess.length) * 100}%`;
    document.getElementById('progress-text').innerText = `${processedCount} / ${studentsToProcess.length}`;
  }
  
  document.getElementById('success-msg').style.display = 'block';
  setTimeout(() => { 
    document.getElementById('progress-overlay').classList.remove('visible'); 
    selectedForAttendance.clear(); 
    refreshData(); 
  }, 1500);
}

// --- DETAIL & TABS LOGIC ---
function openStudentDetail(rowIndex) {
  const s = state.students.find(x => x.rowIndex == rowIndex); 
  if(!s) return;
  
  state.currentDetailStudent = s; 
  // reset evaluation UI (note-only switch)
  try{
    const chk = document.getElementById('eval-note-only');
    if(chk) chk.checked = false;
    const noteEl = document.getElementById('eval-note');
    if(noteEl) noteEl.value = '';
    toggleEvalNoteOnly();
  } catch(e) {}
  
  // reset homework UI (default: verses)
  try{
    const r = document.querySelector('input[name="hw-type"][value="memorized"]');
    if(r) r.checked = true;
    toggleHomeworkTypeUI();
    const ft = document.getElementById('hw-free-text');
    if(ft) ft.value = '';
    // keep verse fields as-is? better clear
    const hs = document.getElementById('hw-surah'); if(hs) hs.value = '';
    const h1 = document.getElementById('hw-start'); if(h1) h1.value = '';
    const h2 = document.getElementById('hw-end'); if(h2) h2.value = '';
  } catch(e) {}
document.getElementById('det-name').innerText = s.fullName;
  document.getElementById('det-sub').innerText = `${s.group} • ${s.days}`;
  document.getElementById('det-avatar').innerHTML = s.fotoUrl ? `<img src="${s.fotoUrl}">` : (s.firstName ? s.firstName[0] : '?');
  
  const grid = document.getElementById('det-grid'); 
  grid.innerHTML = '';
  
  const addField = (lbl, val) => { 
    if(val) grid.innerHTML += `<div class="detail-item"><div class="detail-label">${lbl}</div><div style="font-weight:600;">${linkify(val.toString())}</div></div>`; 
  };
  
  if (state.role === 'Admin') addField("Student ID", s.referenz);
  addField("Group", s.group); 
  addField("Days", s.days); 
  addField("Age", s.alter);
  addField("Gender", s.gender); 
  addField("Birth", s.birthDate); 
  addField("Infos", s.infos);
  addField("Phone", s.phone); 

  if(state.role === 'Admin') {
    addField("Parent", s.parentName); 
    addField("Email", s.email);
    addField("IBAN", s.iban); 
    addField("Betrag", s.betrag);
    if(s.kontrolleBank) addField("Bank Check", `<span style="color:var(--danger);"⚠️ ${s.kontrolleBank}</span>`);
    if(s.finanzMark) addField("Finance", `<span style="color:var(--danger);">⚠️ ${s.finanzMark}</span>`);
    addField("Abgemeldet", s.abgemeldet); 
    addField("Foto URL", s.fotoUrl);
    document.getElementById('btn-edit-stud').classList.remove('hidden');
    document.getElementById('btn-edit-stud').onclick = () => openEditStudent(s);
  } else {
    document.getElementById('btn-edit-stud').classList.add('hidden');
  }

  const myAtt = state.attendance.filter(a => a.fullName === s.fullName).sort((a,b) => b.date.localeCompare(a.date));
  const abs = myAtt.filter(a => a.status.includes('غياب') || a.status === 'Abwesend').map(a => a.date);
  
  document.getElementById('det-attendance-list').innerHTML = abs.length > 0 ? 
    `<h4 style="color:var(--danger)">Fehlzeiten (${abs.length})</h4><ul>${abs.map(d=>`<li>${d}</li>`).join('')}</ul>` : 
    `<p class="text-sec">Keine Fehlzeiten</p>`;
    
  const nList = document.getElementById('notes-list'); 
  nList.innerHTML = ''; 
  nList.dataset.studentName = s.fullName;
  
  state.studentInfos.filter(n => n.studentName === s.fullName).forEach(n => {
    nList.innerHTML += `<div class="note-item"><div>${linkify(n.message)}</div><div class="note-meta"><span>${n.author}</span><span>${n.date}</span></div></div>`;
  });

  loadHomeworkHistory(s.referenz);
  loadEvalHistory(s.referenz);
  
  let consec = 0; 
  for(let a of myAtt) { 
    if(a.status.includes("غياب")) consec++; 
    else break; 
  }
  
  const alertBox = document.getElementById('det-alert');
  if(consec >= 3) { 
    alertBox.innerText = t('absentAlert'); 
    alertBox.classList.remove('hidden'); 
  } else {
    alertBox.classList.add('hidden');
  }

  document.getElementById('btn-print-stud').onclick = () => printSingleStudent(s);

  switchDetailTab('info');
  openModal('detail-modal');
}

function switchDetailTab(tab) {
  ['info','attendance','curriculum','eval'].forEach(t => {
    document.getElementById(`dview-${t}`).classList.add('hidden');
    document.getElementById(`dt-${t}`).classList.remove('active');
  });
  
  document.getElementById(`dview-${tab}`).classList.remove('hidden');
  document.getElementById(`dt-${tab}`).classList.add('active');
}

// --- HOMEWORK & EVAL LOGIC ---
function getSelectedHomeworkType(){
  return document.querySelector('input[name="hw-type"]:checked')?.value || 'memorized';
}

function toggleHomeworkTypeUI(){
  const type = getSelectedHomeworkType();
  const verseFields = document.getElementById('hw-verses-fields');
  const textFields  = document.getElementById('hw-text-fields');
  if(verseFields) verseFields.classList.toggle('hidden', type === 'text');
  if(textFields)  textFields.classList.toggle('hidden', type !== 'text');
}

function assignHomework() {
  const sRef = state.currentDetailStudent?.referenz;
  if(!sRef) return;

  const type = getSelectedHomeworkType();

  let surah = '';
  let start = '';
  let end   = '';

  if(type === 'text'){
    const txt = (document.getElementById('hw-free-text')?.value || '').trim();
    if(!txt) return showToast(state.lang === 'de' ? 'Bitte Text eingeben' : 'اكتب نص الواجب');
    surah = 'TEXT|' + txt;
  } else {
    surah = (document.getElementById('hw-surah')?.value || '').trim();
    start = (document.getElementById('hw-start')?.value || '').trim();
    end   = (document.getElementById('hw-end')?.value || '').trim();

    if(!surah) return showToast(state.lang === 'de' ? 'Bitte Sure eingeben' : 'ادخل السورة');
    if(!start || !end) return showToast(state.lang === 'de' ? 'Bitte Vers-Bereich eingeben' : 'ادخل نطاق الآيات');

    // Verse-Range is always treated as memorization (Auswendig)
    surah = 'MEM|' + surah;
  }

  const reqId = (crypto && crypto.randomUUID) ? crypto.randomUUID() : (Date.now() + '_' + Math.random().toString(16).slice(2));

  fetch(WEB_APP_URL, {
    method: 'POST',
    headers: { "Content-Type": "text/plain" },
    body: JSON.stringify({
      action: 'assignHomework',
      requestId: reqId, 
      studentRef: sRef, 
      surah, 
      ayahStart: start, 
      ayahEnd: end, 
      teacherName: state.user,
      date: getLocalDMYDate(),
      clientTs: Date.now()
    })
  }).then(r=>r.json()).then(res => {
    if(res.ok) { 
      showToast(state.lang === 'de' ? 'Gespeichert' : 'تم الحفظ'); 
      if(type === 'text'){
        const t = document.getElementById('hw-free-text'); 
        if(t) t.value = '';
      } else {
        document.getElementById('hw-surah').value = ''; 
        document.getElementById('hw-start').value = ''; 
        document.getElementById('hw-end').value = ''; 
      }
      loadHomeworkHistory(sRef); 
    }
  });
}


/* --- BULK HOMEWORK (Teacher/Admin) --- */
let bulkHwSelectedRefs = new Set();
let bulkHwListOverride = null; // when using current filter

function getBulkHomeworkType(){
  return document.querySelector('input[name="hw-type-bulk"]:checked')?.value || 'memorized';
}

function toggleBulkHomeworkTypeUI(){
  const type = getBulkHomeworkType();
  const verseFields = document.getElementById('hw-bulk-verses-fields');
  const textFields  = document.getElementById('hw-bulk-text-fields');
  if(verseFields) verseFields.classList.toggle('hidden', type === 'text');
  if(textFields)  textFields.classList.toggle('hidden', type !== 'text');
}

function setupHomeworkSurahDropdownBulk(){
  const inp = document.getElementById('hw-bulk-surah');
  const dd = document.getElementById('hw-bulk-surah-dd');
  if(!inp || !dd) return;

  function close(){
    dd.classList.add('hidden');
    dd.innerHTML = '';
  }

  // Avoid duplicate listeners if called multiple times
  if(inp._qsSurahBulkBound) return;
  inp._qsSurahBulkBound = true;

  inp.addEventListener('input', ()=>{
    const q = (inp.value||'').trim().toLowerCase();
    dd.innerHTML = '';
    if(!q){ close(); return; }

    const matches = SURAH_LIST.filter(([num,de,ar])=>{
      const n = String(num);
      const deL = String(de).toLowerCase();
      const arS = String(ar);
      const iniDe = initialsOfName(de);
      const iniAr = initialsOfName(arS);
      return n.startsWith(q) || deL.includes(q) || arS.includes(q) || iniDe.startsWith(q) || iniAr.startsWith(q);
    }).slice(0, 20);

    if(matches.length === 0){ close(); return; }

    matches.forEach(([num,de,ar])=>{
      const item = document.createElement('div');
      item.style.padding = '8px';
      item.style.borderBottom = '1px solid var(--border)';
      item.style.cursor = 'pointer';
      item.innerHTML = `<b style="color:var(--primary)">${num}</b> — ${escapeHtml(ar)}`;
      item.onclick = ()=>{
        inp.value = String(num);
        close();
      };
      dd.appendChild(item);
    });

    dd.classList.remove('hidden');
  });

  inp.addEventListener('blur', ()=> setTimeout(()=>{
    try{
      if(document.activeElement !== inp) close();
    }catch(e){ close(); }
  }, 150));
}


function setupHomeworkSurahDropdownAdmin(){
  const inp = document.getElementById('hw-admin-add-surah');
  const dd  = document.getElementById('hw-admin-add-surah-dd');
  if(!inp || !dd) return;

  function close(){
    dd.classList.add('hidden');
    dd.innerHTML = '';
  }

  // Avoid duplicate listeners if called multiple times
  if(inp._qsSurahAdmBound) return;
  inp._qsSurahAdmBound = true;

  inp.addEventListener('input', ()=>{
    const q = (inp.value||'').trim().toLowerCase();
    dd.innerHTML = '';
    if(!q){ close(); return; }

    const matches = SURAH_LIST.filter(([num,de,ar])=>{
      const n = String(num);
      const deL = String(de).toLowerCase();
      const arS = String(ar);
      const iniDe = initialsOfName(de);
      const iniAr = initialsOfName(arS);
      return n.startsWith(q) || deL.includes(q) || arS.includes(q) || iniDe.startsWith(q) || iniAr.startsWith(q);
    }).slice(0, 20);

    if(matches.length === 0){ close(); return; }

    matches.forEach(([num,de,ar])=>{
      const item = document.createElement('div');
      item.style.padding = '8px';
      item.style.borderBottom = '1px solid var(--border)';
      item.style.cursor = 'pointer';
      item.innerHTML = `<b style="color:var(--primary)">${num}</b> — ${escapeHtml(ar)}`;
      item.onclick = ()=>{
        inp.value = String(num);
        close();
      };
      dd.appendChild(item);
    });

    dd.classList.remove('hidden');
  });

  inp.addEventListener('blur', ()=> setTimeout(()=>{
    try{
      if(document.activeElement !== inp) close();
    }catch(e){ close(); }
  }, 150));
}



function formatUnifiedFilterSummary(){
  const groups = (state.filter && Array.isArray(state.filter.groups)) ? state.filter.groups : [];
  const days   = (state.filter && Array.isArray(state.filter.days)) ? state.filter.days : [];

  const gText = (groups.length > 0) ? groups.join(', ') : (state.lang==='de' ? 'Alle Gruppen' : 'كل الأقسام');
  const dText = (days.length > 0)
    ? days.map(d => (state.lang==='ar' ? (DAY_DE_TO_AR[d] || d) : d)).join(', ')
    : (state.lang==='de' ? 'Alle Tage' : 'كل الأيام');

  return (state.lang==='de')
    ? `Filter: ${gText} • ${dText}`
    : `الفلتر: ${gText} • ${dText}`;
}

function updateHomeworkFilterSummary(){
  const t1 = document.getElementById('hw-filter-summary-assign-text');
  const t2 = document.getElementById('hw-filter-summary-all-text');
  const t3 = document.getElementById('hw-filter-summary-admin-text');
  const txt = formatUnifiedFilterSummary();
  if(t1) t1.textContent = txt;
  if(t2) t2.textContent = txt;
  if(t3) t3.textContent = txt;

  const b1 = document.getElementById('txt-hw-open-filter');
  const b2 = document.getElementById('txt-hw-open-filter-2');
  if(b1) b1.textContent = (state.lang==='de') ? 'Filter' : 'فلتر';
  if(b2) b2.textContent = (state.lang==='de') ? 'Filter' : 'فلتر';
}
// ===== Aufgaben (Manager/Teacher): Schülerliste + Expand für Hausaufgaben =====
let hwAdmExpandedRefs = new Set();
let hwAdmHomeworkCache = new Map(); // ref -> homework array
let hwParentSeenStatusMap = new Map(); // ref -> latestParentSeen boolean
let hwParentSeenLastFetch = 0;
let hwParentSeenLoading = false;

let hwTeacherConfirmStatusMap = new Map(); // ref -> {hasHomework:boolean, latestConfirmed:boolean}
let hwTeacherConfirmLastFetch = 0;
let hwTeacherConfirmLoading = false;


function jsIsTrue(v){
  if(v === true) return true;
  const s = String(v || '').trim().toLowerCase();
  return (s === 'true' || s === 'yes' || s === '1' || s === 'ja');
}
function isParentSeenHomework(h){
  const v = h ? (h.parentSeen ?? h.parent_seen ?? h.parent ?? h.seen) : '';
  return jsIsTrue(v);
}
function hwGetParentSeenForRef(ref){
  ref = String(ref||'').trim();
  if(!ref) return false;
  try{
    const cached = hwAdmHomeworkCache.get(ref);
    if(Array.isArray(cached) && cached.length){
      return isParentSeenHomework(cached[0]);
    }
  }catch(e){}
  return !!hwParentSeenStatusMap.get(ref);
}
function hwHasHomeworkForRef(ref){
  ref = String(ref||'').trim();
  if(!ref) return null;
  try{
    const cached = hwAdmHomeworkCache.get(ref);
    if(Array.isArray(cached)){
      // If we have already fetched, cached length is authoritative
      return cached.length > 0;
    }
  }catch(e){}
  const t = hwTeacherConfirmStatusMap.get(ref);
  if(t && typeof t.hasHomework === 'boolean') return t.hasHomework;
  return null; // unknown yet
}

function hwParentSeenIconHtml(ref){
  const hasHw = hwHasHomeworkForRef(ref);
  if(hasHw === false){
    const title = (state.lang==='de') ? 'Keine Hausaufgaben' : 'لا توجد واجبات منزلية';
    return `<span class="hw-parent-icon is-none" title="${title}"><i class="fa-solid fa-clipboard"></i></span>`;
  }
  const seen = hwGetParentSeenForRef(ref);
  if(seen){
    const title = (state.lang==='de') ? 'Eltern haben die Hausaufgabe gesehen' : 'وليّ الأمر اطّلع على الواجب';
    return `<span class="hw-parent-icon is-green" title="${title}"><i class="fa-solid fa-eye"></i></span>`;
  }
  if(hasHw === null){
    const title = (state.lang==='de') ? 'Status wird geladen…' : 'جارٍ تحميل الحالة…';
    return `<span class="hw-parent-icon is-none" title="${title}"><i class="fa-solid fa-hourglass-half"></i></span>`;
  }
  const title = (state.lang==='de') ? 'Eltern haben noch nicht bestätigt' : 'وليّ الأمر لم يؤكد الاطلاع بعد';
  return `<span class="hw-parent-icon is-red" title="${title}"><i class="fa-solid fa-eye"></i></span>`;
}



function hwParseDateKey_(d){
  const s = String(d || '').trim();
  if(!s) return '';
  // dd.MM.yyyy
  let m = s.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})$/);
  if(m){
    const dd = String(m[1]).padStart(2,'0');
    const mm = String(m[2]).padStart(2,'0');
    const yyyy = String(m[3]);
    return `${yyyy}${mm}${dd}`;
  }
  // yyyy-MM-dd (or yyyy-MM-ddTHH...)
  m = s.match(/^(\d{4})-(\d{2})-(\d{2})/);
  if(m){
    return `${m[1]}${m[2]}${m[3]}`;
  }
  const dt = new Date(s);
  if(!isNaN(dt.getTime())){
    const yyyy = dt.getFullYear();
    const mm = String(dt.getMonth()+1).padStart(2,'0');
    const dd = String(dt.getDate()).padStart(2,'0');
    return `${yyyy}${mm}${dd}`;
  }
  return '';
}

function hwPickLatestHomework_(list){
  let best = null;
  let bestKey = '';
  let bestRow = -1;
  for(const hw of (list || [])){
    if(!hw) continue;
    const key = hwParseDateKey_(hw.date || hw.timestamp || hw.createdAt || hw.confirmedAt || '');
    const row = Number(hw.rowIndex || hw.row || hw._rowIndex || 0) || 0;

    if(!best){
      best = hw; bestKey = key; bestRow = row;
      continue;
    }

    if(key && bestKey){
      if(key > bestKey){
        best = hw; bestKey = key; bestRow = row;
        continue;
      }
      if(key === bestKey && row > bestRow){
        best = hw; bestRow = row;
        continue;
      }
    }else{
      if(row > bestRow){
        best = hw; bestRow = row; bestKey = key || bestKey;
        continue;
      }
    }
  }
  return best;
}

function hwTeacherStatusFromList_(list){
  const latest = hwPickLatestHomework_(list);
  if(!latest) return { hasHomework:false, latestConfirmed:false };
  return {
    hasHomework: true,
    latestConfirmed: jsIsTrue(latest.confirmed)
  };
}

function hwTeacherStatusForRef_(ref){
  const r = String(ref||'').trim();
  if(!r) return null;

  // Prefer cache if available
  try{
    const cached = hwAdmHomeworkCache.get(r) || hwAllHomeworkCache.get(r);
    if(Array.isArray(cached) && cached.length){
      return hwTeacherStatusFromList_(cached);
    }
  }catch(e){}

  const v = hwTeacherConfirmStatusMap.get(r);
  if(v && typeof v === 'object') return v;
  if(typeof v === 'boolean') return { hasHomework:true, latestConfirmed: !!v };
  return null;
}

function hwStudentSeenState(ref){
  const st = hwTeacherStatusForRef_(ref);
  if(!st || !st.hasHomework) return null;
  return !!st.latestConfirmed;
}
function hwStudentSeenClass(ref){
  const st = hwStudentSeenState(ref);
  if(st === null) return '';
  return st ? 'hw-seen' : 'hw-unseen';
}



async function refreshHwTeacherConfirmStatus(force=false){
  const now = Date.now();
  if(!force && (now - hwTeacherConfirmLastFetch) < 15000) return;
  if(hwTeacherConfirmLoading) return;
  hwTeacherConfirmLoading = true;
  try{
    const list = getHomeworkAdminCurrentList();
    const refs = (list||[]).map(s=>String(s?.referenz||'').trim()).filter(Boolean);
    if(refs.length === 0) return;

    const res = await fetch(WEB_APP_URL, {
      method: 'POST',
      headers: { "Content-Type": "text/plain" },
      body: JSON.stringify({ action: 'getHomeworkTeacherConfirmStatus', studentRefs: refs })
    }).then(r=>r.json());

    if(res && res.ok && res.status){
      for(const ref of Object.keys(res.status)){
        const info = res.status[ref] || {};
        hwTeacherConfirmStatusMap.set(String(ref).trim(), {
          hasHomework: !!info.hasHomework,
          latestConfirmed: jsIsTrue(info.latestConfirmed)
        });
      }
      hwTeacherConfirmLastFetch = now;
    }
  }catch(e){
    // ignore
  }finally{
    hwTeacherConfirmLoading = false;
  }
}

async function refreshHwParentSeenStatus(force=false){
  const now = Date.now();
  if(!force && (now - hwParentSeenLastFetch) < 15000) return;
  if(hwParentSeenLoading) return;
  hwParentSeenLoading = true;
  hwParentSeenLastFetch = now;

  try{
    const list = getHomeworkAdminCurrentList();
    const refs = (list||[]).map(s=>String(s?.referenz||'').trim()).filter(Boolean);
    if(refs.length === 0){ hwParentSeenStatusMap = new Map(); return; }

    const res = await fetch(WEB_APP_URL, {
      method:'POST',
      headers: { "Content-Type": "text/plain" },
      body: JSON.stringify({ action:'getHomeworkParentSeenStatus', studentRefs: refs })
    }).then(r=>r.json());

    if(res && res.ok && res.status){
      const mp = new Map();
      Object.keys(res.status).forEach(k=>{
        mp.set(k, !!res.status[k]?.latestParentSeen);
      });
      hwParentSeenStatusMap = mp;
    }
  }catch(e){
    // ignore
  }finally{
    hwParentSeenLoading = false;
    try{ renderHomeworkAdminStudents(); }catch(e){}
  }
}


// Debounced status refresh for Aufgaben list (fast, only latest status/icons)
let hwAdmStatusRefreshTimer = null;
function hwAdminQueueStatusRefresh(force=true){
  try{
    if(hwAdmStatusRefreshTimer) clearTimeout(hwAdmStatusRefreshTimer);
  }catch(e){}
  hwAdmStatusRefreshTimer = setTimeout(async ()=>{
    try{
      if(navState.currentTab !== 'homework-admin') return;
      await Promise.all([
        refreshHwTeacherConfirmStatus(!!force),
        refreshHwParentSeenStatus(!!force)
      ]);
      try{ renderHomeworkAdminStudents(); }catch(e){}
    }catch(e){}
  }, 180);
}

let hwAdminSendChain = Promise.resolve(); // ensures sequential sending (avoids dropped writes)

let hwAdmStatusPriming = false;
async function primeHomeworkAdminStatuses(){
  if(hwAdmStatusPriming) return;
  hwAdmStatusPriming = true;
  try{
    const list = getHomeworkAdminCurrentList();
    const refs = (list||[]).map(s=>String(s?.referenz||'').trim()).filter(Boolean);
    for(const ref of refs){
      if(hwAdmHomeworkCache.has(ref)) continue;
      await fetchStudentHomeworkIntoAdminCache(ref);
      // small delay to stay gentle with the backend
      await new Promise(r=>setTimeout(r, 80));
      // rerender to update green highlight
      renderHomeworkAdminStudents();
    }
  }catch(e){
    // ignore
  }finally{
    hwAdmStatusPriming = false;
  }
}

let hwAdmCachePriming = false;
let hwAdmPrimeToken = 0;

// Background preload of homework lists (gentle). Keeps UI responsive.
// Called when opening Aufgaben (teacher) AFTER parent-seen status is fetched.
async function primeHomeworkAdminCachesGradually(token){
  if(hwAdmCachePriming) return;
  hwAdmCachePriming = true;

  try{
    const list = getHomeworkAdminCurrentList();
    const refsAll = (list||[]).map(s=>String(s?.referenz||'').trim()).filter(Boolean);

    // preload only missing refs
    const refs = refsAll.filter(r => !hwAdmHomeworkCache.has(r));
    if(refs.length === 0) return;

    const batchSize = 20;
    for(let i=0;i<refs.length;i+=batchSize){
      if(token && token !== hwAdmPrimeToken) break;
      if(navState.currentTab !== 'homework-admin') break;

      const batch = refs.slice(i, i+batchSize);
      if(batch.length === 0) continue;

      try{
        const res = await fetch(WEB_APP_URL, {
          method:'POST',
          headers: { "Content-Type": "text/plain" },
          body: JSON.stringify({ action:'getHomeworkForStudents', studentRefs: batch })
        }).then(r=>r.json());

        if(res && res.ok && res.homeworkByStudent && typeof res.homeworkByStudent === 'object'){
          for(const ref of batch){
            const arr = Array.isArray(res.homeworkByStudent[ref]) ? res.homeworkByStudent[ref] : [];
            hwAdmHomeworkCache.set(ref, arr);
          try{ hwTeacherConfirmStatusMap.set(ref, hwTeacherStatusFromList_(arr)); }catch(e){}
            try{ hwTeacherConfirmStatusMap.set(ref, hwTeacherStatusFromList_(arr)); }catch(e){}
          }
        }else{
          // fallback: per-student
          for(const ref of batch){
            if(token && token !== hwAdmPrimeToken) break;
            if(navState.currentTab !== 'homework-admin') break;
            await fetchStudentHomeworkIntoAdminCache(ref);
            await new Promise(r=>setTimeout(r, 80));
          }
        }
      }catch(e){
        // fallback per-student on error
        for(const ref of batch){
          if(token && token !== hwAdmPrimeToken) break;
          if(navState.currentTab !== 'homework-admin') break;
          await fetchStudentHomeworkIntoAdminCache(ref);
          await new Promise(r=>setTimeout(r, 80));
        }
      }

      // Update colors/icons as cache arrives (optional)
      try{ renderHomeworkAdminStudents(); }catch(e){}
      await new Promise(r=>setTimeout(r, 150));
    }
  }catch(e){
    // ignore
  }finally{
    hwAdmCachePriming = false;
  }
}


function queueHwAdminSend(taskFn){
  hwAdminSendChain = hwAdminSendChain
    .then(()=>taskFn())
    .catch(e=>{ try{ console.warn('hw send error', e); }catch(_){} });
  return hwAdminSendChain;
}


let hwAdminAssignMode = false;
let hwAdminManageMode = false;
let hwAdminSelectedRefs = new Set();

let hwAdminQuickType = 'quran'; // 'quran' | 'text'

function setHwAdminQuickType(type){
  hwAdminQuickType = (type === 'text') ? 'text' : 'quran';

  const bQ = document.getElementById('hw-admin-type-quran');
  const bT = document.getElementById('hw-admin-type-text');
  if(bQ) bQ.classList.toggle('active', hwAdminQuickType === 'quran');
  if(bT) bT.classList.toggle('active', hwAdminQuickType === 'text');

  const tw = document.getElementById('hw-admin-text-wrap');
  if(tw) tw.classList.add('hidden');

  // Re-render quick-assign rows to match the selected type
  if(hwAdminAssignMode){
    renderHomeworkAdminStudents();
  }
}


// Quick-assign (+) pending verification (send once, verify after 5s)
let hwQuickPending = new Map(); // requestId -> {ref, rowEl, btnEl, statusEl}
let hwQuickVerifyTimer = null;
let hwQuickLastSendAt = 0;
function initHomeworkAdminUI(){
  // Uses the unified global filter (same as Schüler tab)
  try{ updateHomeworkFilterSummary(); }catch(e){}

  const s = document.getElementById('hw-admin-search');
  if(s) s.placeholder = (state.lang === 'de') ? 'Suchen...' : 'بحث...';
  if(s && !s._hwAdmBound){
    s._hwAdmBound = true;
    s.addEventListener('input', ()=>{
      try{ renderHomeworkAdminStudents(); }catch(e){}
      // If filter/search changes, re-fetch statuses for the current visible list.
      hwAdminQueueStatusRefresh(true);
    });
  }

  const hint = document.getElementById('hw-admin-hint');
  if(hint){
    hint.textContent = (state.lang === 'de')
      ? 'Tip: Name anklicken, um alle Hausaufgaben zu sehen.'
      : 'اضغط على اسم الطالب لعرض جميع الواجبات المنزلية.';
  }

  // Quick-assign config (type selector + free-text)
  const cfgLbl = document.getElementById('hw-admin-config-label');
  if(cfgLbl) cfgLbl.textContent = (state.lang === 'de') ? 'Aufgabe-Typ' : 'نوع الواجب';

  const bQ = document.getElementById('hw-admin-type-quran');
  const bT = document.getElementById('hw-admin-type-text');
  if(bQ) bQ.textContent = (state.lang === 'de') ? 'Koran' : 'واجب قرآني';
  if(bT) bT.textContent = (state.lang === 'de') ? 'Freier Text' : 'نص حر';

  const tw = document.getElementById('hw-admin-text-wrap');
  if(tw) tw.classList.add('hidden');

  const tInp = document.getElementById('hw-admin-text-global');
  if(tInp) tInp.placeholder = (state.lang === 'de') ? 'Hausaufgabe (Text)…' : 'اكتب نوع الواجب المنزلي...';

  try{ setHwAdminQuickType(hwAdminQuickType); }catch(e){}

  const addBtn = document.getElementById('hw-admin-add-toggle');
  if(addBtn) addBtn.title = (state.lang === 'de') ? 'Hausaufgaben hinzufügen' : 'إضافة واجب';

  const manageBtn = document.getElementById('hw-admin-manage-toggle');
  if(manageBtn) manageBtn.title = (state.lang === 'de') ? 'Hausaufgaben bearbeiten/löschen' : 'تعديل/حذف واجب';

  const mTitle = document.getElementById('hw-admin-manage-title');
  if(mTitle) mTitle.textContent = (state.lang === 'de') ? 'Hausaufgabe bearbeiten / löschen' : 'تعديل / حذف واجب منزلي';

  const mSelLbl = document.getElementById('hw-admin-manage-select-label');
  if(mSelLbl) mSelLbl.textContent = (state.lang === 'de') ? 'Hausaufgabe auswählen' : 'اختر الواجب';

  const mEdit = document.getElementById('txt-hw-admin-manage-edit');
  if(mEdit) mEdit.textContent = (state.lang === 'de') ? 'Bearbeiten' : 'تعديل';

  const mDel = document.getElementById('txt-hw-admin-manage-delete');
  if(mDel) mDel.textContent = (state.lang === 'de') ? 'Löschen' : 'حذف';

  const mSave = document.getElementById('txt-hw-admin-manage-save');
  if(mSave) mSave.textContent = (state.lang === 'de') ? 'Speichern' : 'حفظ';

  const mCancel = document.getElementById('txt-hw-admin-manage-cancel');
  if(mCancel) mCancel.textContent = (state.lang === 'de') ? 'Abbrechen' : 'إلغاء';

  const typeLbl = document.getElementById('hw-admin-add-type-label');
  if(typeLbl) typeLbl.textContent = (state.lang === 'de') ? 'Aufgabe-Typ' : 'نوع الواجب';

  const optMem = document.getElementById('hw-admin-add-type-mem');
  if(optMem) optMem.textContent = (state.lang === 'de') ? 'Auswendig (Von–Bis)' : 'آيات (من–إلى)';

  const optText = document.getElementById('hw-admin-add-type-text');
  if(optText) optText.textContent = (state.lang === 'de') ? 'Freier Text' : 'إدخال نص حر';

  const surLbl = document.getElementById('hw-admin-add-surah-label');
  if(surLbl) surLbl.textContent = (state.lang === 'de') ? 'Sure' : 'السورة';

  const fromLbl = document.getElementById('hw-admin-add-from-label');
  if(fromLbl) fromLbl.textContent = (state.lang === 'de') ? 'Von Vers' : 'من آية';

  const toLbl = document.getElementById('hw-admin-add-to-label');
  if(toLbl) toLbl.textContent = (state.lang === 'de') ? 'Bis Vers' : 'إلى آية';

  const assignTxt = document.getElementById('txt-hw-admin-assign');
  if(assignTxt) assignTxt.textContent = (state.lang === 'de') ? 'Hausaufgabe senden' : 'إرسال الواجب';

  try{ toggleHomeworkAdminTypeUI(); }catch(e){}
  try{ updateHomeworkAdminSelectedCount();
        if(hwAdminManageMode){
          updateHomeworkAdminManageSelectedCount();
          updateHomeworkAdminManageDropdown();
        } }catch(e){}

}

function getHomeworkAdminCurrentList(){
  const base = Array.isArray(state.filteredStudents) ? state.filteredStudents : (state.students || []);
  const q = (document.getElementById('hw-admin-search')?.value || '').trim().toLowerCase();
  return (base || []).filter(s=>{
    if(q){
      const hay = `${s.fullName||''} ${s.parentName||''} ${s.phone||''} ${s.referenz||''}`.toLowerCase();
      if(!hay.includes(q)) return false;
    }
    return true;
  });
}

function updateHomeworkAdminSelectedCount(){
  // (+) quick-assign does not use selection anymore
  const el = document.getElementById('hw-admin-selected-count');
  if(el) el.textContent = '';
}

function toggleHomeworkAdminAssignMode(force){
  // (+) Quick-assign mode: per-student inputs + send arrow
  hwAdminAssignMode = (typeof force === 'boolean') ? force : !hwAdminAssignMode;

  // mutually exclusive with manage mode
  if(hwAdminAssignMode){
    hwAdminManageMode = false;
    const mp = document.getElementById('hw-admin-manage-panel');
    if(mp) mp.classList.add('hidden');
    const mb = document.getElementById('hw-admin-manage-toggle');
    if(mb) mb.classList.remove('active');
  }

  // reset selection (selection is only used by manage mode)
  hwAdminSelectedRefs = new Set();

  // keep the legacy add-panel hidden (we now assign inline)
  const panel = document.getElementById('hw-admin-add-panel');
  if(panel) panel.classList.add('hidden');
  const cfg = document.getElementById('hw-admin-config');
  if(cfg) cfg.classList.toggle('hidden', !hwAdminAssignMode);

  const btn = document.getElementById('hw-admin-add-toggle');
  if(btn) btn.classList.toggle('active', hwAdminAssignMode);

  renderHomeworkAdminStudents();
  updateHomeworkAdminSelectedCount();
  if(hwAdminManageMode){
    updateHomeworkAdminManageSelectedCount();
    updateHomeworkAdminManageDropdown();
  }

  updateHomeworkAdminSelectAllUI();
}

// ===== Aufgaben (Manager): Bearbeiten/Löschen gemeinsamer Hausaufgaben =====
let hwAdminManageCommonMap = new Map(); // key -> { label, sample, perRefRows: Map(ref -> rowIndex[])}
let hwAdminManageCurrentKey = '';

function toggleHomeworkAdminManageMode(force){
  hwAdminManageMode = (typeof force === 'boolean') ? force : !hwAdminManageMode;

  // mutually exclusive with assign mode
  if(hwAdminManageMode){
    hwAdminAssignMode = false;
    const ap = document.getElementById('hw-admin-add-panel');
    if(ap) ap.classList.add('hidden');
    const ab = document.getElementById('hw-admin-add-toggle');
    if(ab) ab.classList.remove('active');
  }

  // reset selection when toggling on/off
  hwAdminSelectedRefs = new Set();
  hwAdminManageCommonMap = new Map();
  hwAdminManageCurrentKey = '';

  const panel = document.getElementById('hw-admin-manage-panel');
  if(panel) panel.classList.toggle('hidden', !hwAdminManageMode);

  const btn = document.getElementById('hw-admin-manage-toggle');
  if(btn) btn.classList.toggle('active', hwAdminManageMode);

  // hide edit subpanel
  homeworkAdminManageCancelEdit();

  renderHomeworkAdminStudents();
  updateHomeworkAdminSelectedCount();
  updateHomeworkAdminManageSelectedCount();
  updateHomeworkAdminManageDropdown();

  const cfg = document.getElementById('hw-admin-config');
  if(cfg) cfg.classList.toggle('hidden', !hwAdminAssignMode);

  updateHomeworkAdminSelectAllUI();
}

function updateHomeworkAdminManageSelectedCount(){
  const el = document.getElementById('hw-admin-manage-selected-count');
  if(!el) return;
  if(!hwAdminManageMode){
    el.textContent = '';
    return;
  }
  const n = hwAdminSelectedRefs.size;
  el.textContent = (state.lang === 'de') ? `Ausgewählt: ${n}` : `المحدد: ${n}`;

  updateHomeworkAdminSelectAllUI();
}

function updateHomeworkAdminSelectAllUI(){
  const row = document.getElementById('hw-admin-select-all-row');
  const cb  = document.getElementById('hw-admin-select-all');
  if(!row || !cb) return;

  // Select-all is used ONLY for manage mode (-), not for quick assign (+)
  const enabled = hwAdminManageMode;
  row.classList.toggle('hidden', !enabled);

  if(!enabled){
    cb.checked = false;
    cb.indeterminate = false;
    return;
  }

  const list = getHomeworkAdminCurrentList();
  const refs = list.map(s=>String(s.referenz||'').trim()).filter(Boolean);
  const total = refs.length;
  const sel = refs.filter(r=>hwAdminSelectedRefs.has(r)).length;

  cb.checked = (total>0 && sel === total);
  cb.indeterminate = (sel>0 && sel<total);
}

function hwAdminToggleSelectAll(checked){
  const list = getHomeworkAdminCurrentList();
  const refs = list.map(s=>String(s.referenz||'').trim()).filter(Boolean);

  if(checked){
    refs.forEach(r=>hwAdminSelectedRefs.add(r));
  }else{
    // unselect only currently visible refs (keep other selections if user filtered)
    refs.forEach(r=>hwAdminSelectedRefs.delete(r));
  }

  renderHomeworkAdminStudents();
  updateHomeworkAdminSelectedCount();
  updateHomeworkAdminManageSelectedCount();
  if(hwAdminManageMode) updateHomeworkAdminManageDropdown();
  updateHomeworkAdminSelectAllUI();
}

async function getHomeworkAdminListForRef(ref){
  ref = String(ref||'').trim();
  if(!ref) return [];
  if(hwAdmHomeworkCache.has(ref)){
    const cached = hwAdmHomeworkCache.get(ref);
    return Array.isArray(cached) ? cached : [];
  }
  try{
    const res = await fetch(WEB_APP_URL, {
      method: 'POST',
      body: JSON.stringify({ action: 'getStudentHomework', studentRef: ref })
    }).then(r=>r.json());
    const arr = (res && res.ok) ? (res.homework || []) : [];
    hwAdmHomeworkCache.set(ref, arr);
    return Array.isArray(arr) ? arr : [];
  }catch(e){
    return [];
  }
}

function hwAdminNormalizeTeacher(h){
  return String(h?.teacher || h?.teacherName || '').trim();
}
function hwAdminNormalizeDate(h){
  return normalizeDateToDMY(h?.date || '');
}
function hwAdminHomeworkKey(h){
  const raw = String(h?.surah || '').trim();
  const info = decodeHomeworkSurah(raw);
  const kind = String(info.kind || 'verses');
  const a1 = String(h?.ayahStart ?? h?.start ?? '').trim();
  const a2 = String(h?.ayahEnd ?? h?.end ?? '').trim();

  const normNum = (v)=>{
    const n = Number(String(v||'').replace(/[^\d]/g,''));
    return Number.isFinite(n) && n>0 ? String(n) : '';
  };

  const normText = (t)=>{
    return String(t||'').toLowerCase().replace(/\s+/g,' ').trim();
  };

  let surahId = '';
  if(kind === 'text'){
    surahId = 'TEXT|' + normText(info.freeText || '');
    return `${kind}|${surahId}`;
  }

  if(info.surahNum){
    surahId = 'S' + String(info.surahNum);
  }else{
    surahId = 'T' + normText(info.surahText || raw);
  }

  return `${kind}|${surahId}|${normNum(a1)}|${normNum(a2)}`;
}
function hwAdminHomeworkLabel(h){
  const raw = String(h?.surah || h?.sura || '').trim();
  const info = decodeHomeworkSurah(raw);

  // Support multiple field names coming from the sheet / legacy versions
  const a1 = String(
    h?.ayahStart ?? h?.start ?? h?.ayah_from ?? h?.ayahFrom ?? h?.fromAyah ?? h?.from ?? h?.von ?? ''
  ).trim();
  const a2 = String(
    h?.ayahEnd ?? h?.end ?? h?.ayah_to ?? h?.ayahTo ?? h?.toAyah ?? h?.to ?? h?.bis ?? ''
  ).trim();

  const range0 = [a1,a2].filter(Boolean).join(' - ');
  const rangeAlt = String(h?.ayahRange ?? h?.range ?? '').trim();
  const range = (range0 || rangeAlt);

  if(info.kind === 'text'){
    // Free text can also be stored in other columns; fall back if needed
    const fallbackText = (h?.text ?? h?.freeText ?? h?.note ?? h?.notes ?? '').toString();
    const t = (info.freeText || fallbackText || '').trim();
    const short = t.length > 70 ? (t.slice(0,70) + '…') : t;
    return `📝 ${(state.lang==='de'?'Text':'نص')}: ${short || (state.lang==='de'?'(leer)':'(فارغ)')}`;
  }

  const icon = (info.kind === 'memorized') ? '📗' : '📖';
  // Show surah label + ayah range (so you can distinguish tasks easily)
  let title = (info.label || info.surahText || (state.lang==='de'?'Hausaufgabe':'واجب'));
  if(info.badge) title += ` (${info.badge})`;
  return `${icon} ${title}${range ? ' • ' + range : ''}`;
}

function hwAdminFilterHidden(homework){
  const hidden = (typeof getHiddenHwSet === 'function') ? getHiddenHwSet() : new Set();
  const raw = Array.isArray(homework) ? homework : [];
  return raw.filter(h=>{
    const row = Number(h?.rowIndex||0);
    if(row && hidden.has(row)) return false;
    return true;
  });
}

async function updateHomeworkAdminManageDropdown(){
  const sel = document.getElementById('hw-admin-manage-select');
  const hint = document.getElementById('hw-admin-manage-common-hint');
  if(!sel) return;

  if(!hwAdminManageMode){
    sel.innerHTML = '';
    if(hint) hint.textContent = '';
    return;
  }

  const refs = Array.from(hwAdminSelectedRefs);
  sel.innerHTML = '';
  hwAdminManageCommonMap = new Map();
  hwAdminManageCurrentKey = '';

  // placeholder
  const ph = document.createElement('option');
  ph.value = '';
  ph.textContent = (state.lang==='de') ? '— Bitte Schüler auswählen —' : '— اختر الطلاب أولاً —';
  sel.appendChild(ph);

  if(refs.length === 0){
    if(hint) hint.textContent = (state.lang==='de')
      ? 'Wähle zuerst Schüler per Checkbox.'
      : 'حدد الطلاب عبر المربعات ثم اختر الواجب.';
    return;
  }

  // load homework for each selected ref
  const lists = await Promise.all(refs.map(r=>getHomeworkAdminListForRef(r)));
  const maps = lists.map(arr=>{
    const mp = new Map();
    const filtered = hwAdminFilterHidden(arr);
    filtered.forEach(h=>{
      const key = hwAdminHomeworkKey(h);
      if(!mp.has(key)) mp.set(key, []);
      mp.get(key).push(h);
    });
    return mp;
  });

  // intersection of keys
  let common = [];
  if(maps.length > 0){
    common = Array.from(maps[0].keys());
    for(let i=1;i<maps.length;i++){
      const mi = maps[i];
      common = common.filter(k=>mi.has(k));
    }
  }

  if(common.length === 0){
    if(hint) hint.textContent = (state.lang==='de')
      ? 'Keine gemeinsamen Hausaufgaben für die ausgewählten Schüler.'
      : 'لا توجد واجبات مشتركة بين الطلاب المحددين.';
    return;
  }

  // Build map key -> perRef rows + sample
  common.forEach(key=>{
    const entry = { label:'', sample:null, perRefRows: new Map() };
    refs.forEach((ref, idx)=>{
      const arr = maps[idx].get(key) || [];
      const rows = arr.map(x=>Number(x?.rowIndex||0)).filter(Boolean);
      entry.perRefRows.set(ref, rows);
      if(!entry.sample && arr.length) entry.sample = arr[0];
    });
    entry.label = entry.sample ? hwAdminHomeworkLabel(entry.sample) : key;
    hwAdminManageCommonMap.set(key, entry);
  });

  // sort by date desc (best effort)
  common.sort((a,b)=>{
    const ea = hwAdminManageCommonMap.get(a);
    const eb = hwAdminManageCommonMap.get(b);
    const da = ea?.sample ? hwAdminNormalizeDate(ea.sample) : '';
    const db = eb?.sample ? hwAdminNormalizeDate(eb.sample) : '';
    return (dateToTS(db) - dateToTS(da));
  });

  // add options
  common.forEach(key=>{
    const opt = document.createElement('option');
    opt.value = key;
    opt.textContent = hwAdminManageCommonMap.get(key)?.label || key;
    sel.appendChild(opt);
  });

  if(hint) hint.textContent = (state.lang==='de')
    ? `Gemeinsame Hausaufgaben: ${common.length}`
    : `الواجبات المشتركة: ${common.length}`;

  sel.onchange = ()=>{
    hwAdminManageCurrentKey = sel.value || '';
    homeworkAdminManageCancelEdit();
  };

  // auto-select first real option
  if(common.length){
    sel.value = common[0];
    hwAdminManageCurrentKey = common[0];
  }
}

function homeworkAdminManageOpenEdit(){
  if(!hwAdminManageMode) return;
  const key = hwAdminManageCurrentKey || document.getElementById('hw-admin-manage-select')?.value || '';
  if(!key || !hwAdminManageCommonMap.has(key)){
    return showToast(state.lang==='de' ? 'Bitte zuerst eine Hausaufgabe auswählen.' : 'اختر واجباً أولاً.');
  }
  const entry = hwAdminManageCommonMap.get(key);
  const sample = entry?.sample || null;
  if(!sample) return;

  const editPanel = document.getElementById('hw-admin-manage-edit-panel');
  if(editPanel) editPanel.classList.remove('hidden');

  const btnSave = document.getElementById('btn-hw-admin-manage-save');
  const btnCancel = document.getElementById('btn-hw-admin-manage-cancel');
  if(btnSave) btnSave.classList.remove('hidden');
  if(btnCancel) btnCancel.classList.remove('hidden');

  // prefill fields based on sample
  const info = decodeHomeworkSurah(String(sample?.surah||'').trim());
  const kind = info.kind;

  // set radio
  const radios = document.querySelectorAll('input[name="hw-admin-manage-type"]');
  radios.forEach(r=>{
    if(kind === 'text' && r.value==='text') r.checked = true;
    if(kind !== 'text' && r.value!=='text') r.checked = true;
  });

  // fill inputs
  const sur = document.getElementById('hw-admin-manage-surah');
  const st  = document.getElementById('hw-admin-manage-start');
  const en  = document.getElementById('hw-admin-manage-end');
  const txt = document.getElementById('hw-admin-manage-free-text');

  if(sur) sur.value = info.surahText || '';
  if(st) st.value = String(sample?.ayahStart || '');
  if(en) en.value = String(sample?.ayahEnd || '');
  if(txt) txt.value = info.freeText || '';

  toggleHomeworkAdminManageTypeUI();
  try{ setupHomeworkSurahDropdownAdminManage(); }catch(e){}
}

function homeworkAdminManageCancelEdit(){
  const editPanel = document.getElementById('hw-admin-manage-edit-panel');
  if(editPanel) editPanel.classList.add('hidden');

  const btnSave = document.getElementById('btn-hw-admin-manage-save');
  const btnCancel = document.getElementById('btn-hw-admin-manage-cancel');
  if(btnSave) btnSave.classList.add('hidden');
  if(btnCancel) btnCancel.classList.add('hidden');
}

function getHomeworkAdminManageType(){
  return document.querySelector('input[name="hw-admin-manage-type"]:checked')?.value || 'memorized';
}

function toggleHomeworkAdminManageTypeUI(){
  const type = getHomeworkAdminManageType();
  const verseFields = document.getElementById('hw-admin-manage-verses-fields');
  const textFields  = document.getElementById('hw-admin-manage-text-fields');
  if(verseFields) verseFields.classList.toggle('hidden', type === 'text');
  if(textFields)  textFields.classList.toggle('hidden', type !== 'text');
  try{ setupHomeworkSurahDropdownAdminManage(); }catch(e){}
}

function setupHomeworkSurahDropdownAdminManage(){
  const inp = document.getElementById('hw-admin-manage-surah');
  const dd  = document.getElementById('hw-admin-manage-surah-dd');
  if(!inp || !dd) return;

  function close(){
    dd.classList.add('hidden');
    dd.innerHTML = '';
  }

  if(inp._qsSurahAdmManageBound) return;
  inp._qsSurahAdmManageBound = true;

  inp.addEventListener('input', ()=>{
    const q = (inp.value||'').trim().toLowerCase();
    dd.innerHTML = '';
    if(!q){ close(); return; }

    const matches = SURAH_LIST.filter(([num,de,ar])=>{
      const n = String(num);
      const deL = String(de).toLowerCase();
      const arS = String(ar);
      const iniDe = initialsOfName(de);
      const iniAr = initialsOfName(arS);
      return n.startsWith(q) || deL.includes(q) || arS.includes(q) || iniDe.startsWith(q) || iniAr.startsWith(q);
    }).slice(0, 20);

    if(matches.length === 0){ close(); return; }

    matches.forEach(([num,de,ar])=>{
      const item = document.createElement('div');
      item.style.padding = '8px';
      item.style.borderBottom = '1px solid var(--border)';
      item.style.cursor = 'pointer';
      item.innerHTML = `<b style="color:var(--primary)">${num}</b> — ${escapeHtml(ar)}`;
      item.onclick = ()=>{
        inp.value = String(num);
        close();
      };
      dd.appendChild(item);
    });

    dd.classList.remove('hidden');
  });

  inp.addEventListener('blur', ()=> setTimeout(()=>{
    try{ if(document.activeElement !== inp) close(); }catch(e){ close(); }
  }, 150));
}

async function homeworkAdminManageDeleteSelected(){
  if(!hwAdminManageMode) return;

  const status = document.getElementById('hw-admin-manage-status');
  if(status) status.textContent = '';

  const key = hwAdminManageCurrentKey || document.getElementById('hw-admin-manage-select')?.value || '';
  if(!key || !hwAdminManageCommonMap.has(key)){
    return showToast(state.lang==='de' ? 'Bitte eine Hausaufgabe auswählen.' : 'اختر واجباً.');
  }

  const refs = Array.from(hwAdminSelectedRefs);
  if(refs.length === 0){
    return showToast(state.lang==='de' ? 'Bitte Schüler auswählen.' : 'اختر الطلاب.');
  }

  const ok = confirm(state.lang==='de'
    ? 'Diese Hausaufgabe für alle ausgewählten Schüler löschen?'
    : 'هل تريد حذف هذا الواجب لكل الطلاب المحددين؟');
  if(!ok) return;

  const entry = hwAdminManageCommonMap.get(key);
  let delCount = 0;

  for(const ref of refs){
    const rows = entry?.perRefRows?.get(ref) || [];
    for(const row of rows){
      const okDel = await deleteHomeworkRowSilent(row);
      if(okDel) delCount++;
    }
    // clear cache so it reloads
    hwAdmHomeworkCache.delete(ref);
  }

  // refresh expanded panels if open
  refs.forEach(r=>{
    if(hwAdmExpandedRefs.has(r)) ensureHomeworkAdminLoaded(r);
  });

  if(status){
    status.textContent = (state.lang==='de')
      ? `Gelöscht: ${delCount}`
      : `تم الحذف: ${delCount}`;
  }

  updateHomeworkAdminManageDropdown();
  renderHomeworkAdminStudents();
}

async function homeworkAdminManageSaveChanges(){
  if(!hwAdminManageMode) return;

  const status = document.getElementById('hw-admin-manage-status');
  if(status) status.textContent = '';

  const key = hwAdminManageCurrentKey || document.getElementById('hw-admin-manage-select')?.value || '';
  if(!key || !hwAdminManageCommonMap.has(key)){
    return showToast(state.lang==='de' ? 'Bitte zuerst eine Hausaufgabe auswählen.' : 'اختر واجباً أولاً.');
  }

  const refs = Array.from(hwAdminSelectedRefs);
  if(refs.length === 0){
    return showToast(state.lang==='de' ? 'Bitte Schüler auswählen.' : 'اختر الطلاب.');
  }

  const type = getHomeworkAdminManageType();

  let surah = '';
  let start = '';
  let end   = '';

  if(type === 'text'){
    const txt = (document.getElementById('hw-admin-manage-free-text')?.value || '').trim();
    if(!txt) return showToast(state.lang === 'de' ? 'Bitte Text eingeben' : 'اكتب نص الواجب');
    surah = 'TEXT|' + txt;
  }else{
    const s = (document.getElementById('hw-admin-manage-surah')?.value || '').trim();
    start = (document.getElementById('hw-admin-manage-start')?.value || '').trim();
    end   = (document.getElementById('hw-admin-manage-end')?.value || '').trim();
    if(!s) return showToast(state.lang === 'de' ? 'Bitte Sure eingeben' : 'ادخل السورة');
    if(!start || !end) return showToast(state.lang === 'de' ? 'Bitte Vers-Bereich eingeben' : 'ادخل نطاق الآيات');
    surah = 'MEM|' + s;
  }

  const entry = hwAdminManageCommonMap.get(key);

  const ok = confirm(state.lang==='de'
    ? 'Hausaufgabe für alle ausgewählten Schüler ändern? (Alt wird gelöscht und neu gesendet)'
    : 'هل تريد تعديل الواجب لكل الطلاب المحددين؟ (سيتم حذف القديم وإرسال الجديد)');
  if(!ok) return;

  let changed = 0;
  const dateLocal = getLocalDMYDate();

  for(const ref of refs){
    const rows = entry?.perRefRows?.get(ref) || [];
    for(const row of rows){
      const okDel = await deleteHomeworkRowSilent(row);
      if(okDel) changed++;
    }

    // assign new homework
    const payload = { action:'assignHomework', studentRef: String(ref), surah: surah, ayahStart: start, ayahEnd: end, teacherName: state.user, date: dateLocal, clientTs: Date.now() };
    try{
      await fetch(WEB_APP_URL, {
        method: 'POST',
        headers: { "Content-Type": "text/plain" },
        body: JSON.stringify(payload)
      }).then(r=>r.json());
    }catch(e){}
    hwAdmHomeworkCache.delete(ref);
    await __sleep(250);
  }

  refs.forEach(r=>{
    if(hwAdmExpandedRefs.has(r)) ensureHomeworkAdminLoaded(r);
  });

  if(status){
    status.textContent = (state.lang==='de')
      ? `Aktualisiert (gelöscht+neu): ${changed}`
      : `تم التعديل (حذف+إرسال): ${changed}`;
  }

  homeworkAdminManageCancelEdit();
  updateHomeworkAdminManageDropdown();
  renderHomeworkAdminStudents();
}

function getHomeworkAdminType(){
  return document.querySelector('input[name="hw-admin-type"]:checked')?.value || 'memorized';
}

function toggleHomeworkAdminTypeUI(){
  const type = getHomeworkAdminType();
  const verseFields = document.getElementById('hw-admin-add-verses-fields');
  const textFields  = document.getElementById('hw-admin-add-text-fields');
  if(verseFields) verseFields.classList.toggle('hidden', type === 'text');
  if(textFields)  textFields.classList.toggle('hidden', type !== 'text');
  try{ setupHomeworkSurahDropdownAdmin(); }catch(e){}
}

async function homeworkAdminAssignHomework(){
  if(state.role === 'Student') return;

  const list = getHomeworkAdminCurrentList();
  const selected = list.filter(s => hwAdminSelectedRefs.has(String(s.referenz||'').trim()));

  const status = document.getElementById('hw-admin-assign-status');
  if(status) status.textContent = '';

  if(selected.length === 0){
    return showToast(state.lang === 'de' ? 'Bitte mindestens einen Schüler auswählen.' : 'اختر طالباً واحداً على الأقل.');
  }

  const type = getHomeworkAdminType();

  let surah = '';
  let start = '';
  let end   = '';

  if(type === 'text'){
    const txt = (document.getElementById('hw-admin-add-free-text')?.value || '').trim();
    if(!txt) return showToast(state.lang === 'de' ? 'Bitte Text eingeben' : 'اكتب نص الواجب');
    surah = 'TEXT|' + txt;
  }else{
    surah = (document.getElementById('hw-admin-add-surah')?.value || '').trim();
    start = (document.getElementById('hw-admin-add-start')?.value || '').trim();
    end   = (document.getElementById('hw-admin-add-end')?.value || '').trim();

    if(!surah) return showToast(state.lang === 'de' ? 'Bitte Sure eingeben' : 'ادخل السورة');
    if(!start || !end) return showToast(state.lang === 'de' ? 'Bitte Vers-Bereich eingeben' : 'ادخل نطاق الآيات');

    surah = 'MEM|' + surah;
  }

  const btn = document.getElementById('btn-hw-admin-assign');
  if(btn) btn.disabled = true;

  // Use LOCAL date (avoids "yesterday" issues caused by UTC/Timezone shifts)
  const dateLocal = getLocalDMYDate();

  let okCount = 0;
  let queuedCount = 0;

  // Send sequentially (and also sequential across multiple clicks) to avoid dropped writes
  await queueHwAdminSend(async ()=>{
    for(let i=0;i<selected.length;i++){
      const st = selected[i];
      const ref = String(st.referenz||'').trim();
      if(!ref) continue;

      if(status){
        status.textContent = (state.lang==='de')
          ? `Sende… ${i+1}/${selected.length}`
          : `جارٍ الإرسال… ${i+1}/${selected.length}`;
      }

      const payload = {
        action:'assignHomework',
        studentRef: ref,
        surah,
        ayahStart: start,
        ayahEnd: end,
        teacherName: state.user,
        date: dateLocal,
        clientTs: Date.now()
      };

      try{
        const res = await fetch(WEB_APP_URL, {
          method: 'POST',
          headers: { "Content-Type": "text/plain" },
          body: JSON.stringify(payload)
        }).then(r=>r.json());

        if(res && res.ok){
          okCount++;
        }else{
          if(typeof enqueueSheetWrite === 'function'){
            enqueueSheetWrite(payload, { label: (state.lang==='de'?'Hausaufgabe':'واجب') + ` • ${st.fullName||ref}` });
            queuedCount++;
          }
        }
      }catch(e){
        if(typeof enqueueSheetWrite === 'function'){
          enqueueSheetWrite(payload, { label: (state.lang==='de'?'Hausaufgabe':'واجب') + ` • ${st.fullName||ref}` });
          queuedCount++;
        }
      }

      // refresh cache if panel expanded
      try{
        hwAdmHomeworkCache.delete(ref);
        if(hwAdmExpandedRefs.has(ref)) ensureHomeworkAdminLoaded(ref);
      }catch(e){}

      // small delay helps Apps Script / Sheets not to drop writes
      await __sleep(250);
    }
  });

  if(btn) btn.disabled = false;

  try{ if(typeof kickSyncQueue === 'function') kickSyncQueue(); }catch(e){}

  // reset selection
  hwAdminSelectedRefs = new Set();
  renderHomeworkAdminStudents();
  updateHomeworkAdminSelectedCount();

  // optional clear inputs
  try{
    if(type === 'text'){
      const t = document.getElementById('hw-admin-add-free-text'); if(t) t.value = '';
    }else{
      const a = document.getElementById('hw-admin-add-surah'); if(a) a.value = '';
      const b = document.getElementById('hw-admin-add-start'); if(b) b.value = '';
      const c = document.getElementById('hw-admin-add-end'); if(c) c.value = '';
    }
  }catch(e){}

  const msg = (state.lang==='de')
    ? `Fertig: ${okCount} gespeichert${queuedCount ? `, ${queuedCount} in Warteschlange (offline/Fehler).` : '.'}`
    : `تم: حفظ ${okCount}${queuedCount ? `، و ${queuedCount} في قائمة الانتظار (بدون اتصال/خطأ).` : '.'}`;

  if(status) status.textContent = msg;
  showToast((state.lang==='de') ? 'Hausaufgabe gesendet.' : 'تم إرسال الواجب.');
}


function renderHomeworkAdminStudents(){
  const box = document.getElementById('hw-admin-students');
  const countEl = document.getElementById('hw-admin-count');
  if(!box) return;

  const list = getHomeworkAdminCurrentList();
  if(countEl){
    countEl.textContent = (state.lang === 'de')
      ? `Schüler: ${list.length}`
      : `عدد الطلاب: ${list.length}`;
  }

  box.innerHTML = '';
  if(list.length === 0){
    const empty = document.createElement('div');
    empty.className = 'bulk-empty';
    empty.textContent = (state.lang === 'de') ? 'Keine Treffer.' : 'لا توجد نتائج.';
    box.appendChild(empty);
    updateHomeworkAdminSelectAllUI();
    return;
  }

  
  // (+) Quick-assign mode: per-student send (no bulk send)
  if(hwAdminAssignMode){
    const isTextMode = (hwAdminQuickType === 'text');


    // Row "Alle/الكل": write once, apply to all students' quick-assign inputs
    const allRow = document.createElement('div');
    allRow.className = 'hw-qa-row hw-qa-all' + (isTextMode ? ' hw-qa-text' : '');

    const allName = (state.lang === 'de') ? 'Alle' : 'الكل';
    const appliedMsg = (state.lang === 'de') ? 'Auf alle angewendet' : 'تم تطبيقه على الجميع';
    const needFillMsg = (state.lang === 'de') ? 'Bitte Felder ausfüllen' : 'املأ الحقول أولاً';

    if(isTextMode){
      allRow.innerHTML = `
        <div class="hw-qa-name">
          <div class="bulk-name" style="color:var(--primary);">${allName}</div>
        </div>

        <input type="text" class="form-input hw-qa-free" placeholder="${state.lang==='de' ? 'Text für alle…' : 'نص للجميع…'}">

        <button class="icon-btn hw-qa-send" type="button" aria-label="apply-all">
          <i class="fa-solid fa-check"></i>
        </button>

        <div class="hw-qa-status text-sm text-sec"></div>
      `;

      const inpFreeAll = allRow.querySelector('.hw-qa-free');
      const btnAll = allRow.querySelector('.hw-qa-send');
      const statusEl = allRow.querySelector('.hw-qa-status');

      const applyAll = ()=>{
        const v = (inpFreeAll?.value || '').trim();
        if(!v){
          if(statusEl) statusEl.textContent = needFillMsg;
          return;
        }
        // Apply to all visible student rows
        box.querySelectorAll('.hw-qa-row:not(.hw-qa-all) .hw-qa-free').forEach(inp=>{
          try{ inp.value = v; }catch(e){}
        });
        if(statusEl){
          statusEl.textContent = appliedMsg;
          setTimeout(()=>{ try{ statusEl.textContent=''; }catch(e){} }, 1200);
        }
      };

      btnAll?.addEventListener('click', (ev)=>{ ev.stopPropagation(); applyAll(); });
      inpFreeAll?.addEventListener('keydown', (e)=>{
        if(e.key === 'Enter'){ e.preventDefault(); applyAll(); }
      });

    }else{
      allRow.innerHTML = `
        <div class="hw-qa-name">
          <div class="bulk-name" style="color:var(--primary);">${allName}</div>
        </div>

        <div class="hw-qa-surah-wrap">
          <input type="text" class="form-input hw-qa-surah" placeholder="${state.lang==='de'?'Sure':'السورة'}">
          <div class="card hidden hw-qa-dd"></div>
        </div>

        <input type="number" class="form-input hw-qa-start" placeholder="${state.lang==='de'?'Von':'من'}">
        <input type="number" class="form-input hw-qa-end" placeholder="${state.lang==='de'?'Bis':'إلى'}">

        <button class="icon-btn hw-qa-send" type="button" aria-label="apply-all">
          <i class="fa-solid fa-check"></i>
        </button>

        <div class="hw-qa-status text-sm text-sec"></div>
      `;

      const inpSurAll = allRow.querySelector('.hw-qa-surah');
      const ddAll = allRow.querySelector('.hw-qa-dd');
      const inpStAll = allRow.querySelector('.hw-qa-start');
      const inpEnAll = allRow.querySelector('.hw-qa-end');
      const btnAll = allRow.querySelector('.hw-qa-send');
      const statusEl = allRow.querySelector('.hw-qa-status');

      bindSurahAutocomplete(inpSurAll, ddAll);

      const applyAll = ()=>{
        const sur = (inpSurAll?.value || '').trim();
        const st  = (inpStAll?.value || '').trim();
        const en  = (inpEnAll?.value || '').trim();
        if(!sur || !st || !en){
          if(statusEl) statusEl.textContent = needFillMsg;
          return;
        }
        box.querySelectorAll('.hw-qa-row:not(.hw-qa-all) .hw-qa-surah').forEach(inp=>{ try{ inp.value = sur; }catch(e){} });
        box.querySelectorAll('.hw-qa-row:not(.hw-qa-all) .hw-qa-start').forEach(inp=>{ try{ inp.value = st; }catch(e){} });
        box.querySelectorAll('.hw-qa-row:not(.hw-qa-all) .hw-qa-end').forEach(inp=>{ try{ inp.value = en; }catch(e){} });
        if(statusEl){
          statusEl.textContent = appliedMsg;
          setTimeout(()=>{ try{ statusEl.textContent=''; }catch(e){} }, 1200);
        }
      };

      btnAll?.addEventListener('click', (ev)=>{ ev.stopPropagation(); applyAll(); });
      [inpSurAll, inpStAll, inpEnAll].forEach(el=>{
        el?.addEventListener('keydown', (e)=>{
          if(e.key === 'Enter'){ e.preventDefault(); applyAll(); }
        });
      });
    }

    box.appendChild(allRow);
    list.forEach(s=>{
      const ref = String(s.referenz || '').trim();
      const row = document.createElement('div');
      row.className = 'hw-qa-row' + (isTextMode ? ' hw-qa-text' : '');

      if(isTextMode){
        row.innerHTML = `
          <div class="hw-qa-name">
            <div class="bulk-name ${hwStudentSeenClass(ref)}">${hwParentSeenIconHtml(ref)}${escapeHtml(s.fullName || '')}</div>
          </div>

          <input type="text" class="form-input hw-qa-free" placeholder="${state.lang==='de' ? 'Text…' : 'اكتب الواجب…'}" ${ref ? '' : 'disabled'}>

          <button class="icon-btn hw-qa-send" type="button" ${ref ? '' : 'disabled'} aria-label="send">
            <i class="fa-solid fa-chevron-right"></i>
          </button>

          <div class="hw-qa-status text-sm text-sec"></div>
        `;

        const inpFree = row.querySelector('.hw-qa-free');
        const btn = row.querySelector('.hw-qa-send');
        const statusEl = row.querySelector('.hw-qa-status');

        btn?.addEventListener('click', (ev)=>{
          ev.stopPropagation();
          if(!ref) return;
          hwQuickAssignSendOne(ref, null, null, null, btn, statusEl, row, inpFree);
        });

        // Enter to send
        inpFree?.addEventListener('keydown', (e)=>{
          if(e.key === 'Enter'){
            e.preventDefault();
            btn?.click();
          }
        });

        box.appendChild(row);
        return;
      }

      // Quran mode row (surah + from/to)
      row.innerHTML = `
        <div class="hw-qa-name">
          <div class="bulk-name ${hwStudentSeenClass(ref)}">${hwParentSeenIconHtml(ref)}${escapeHtml(s.fullName || '')}</div>
        </div>

        <div class="hw-qa-surah-wrap">
          <input type="text" class="form-input hw-qa-surah" placeholder="${state.lang==='de'?'Sure':'السورة'}" ${ref ? '' : 'disabled'}>
          <div class="card hidden hw-qa-dd"></div>
        </div>

        <input type="number" class="form-input hw-qa-start" placeholder="${state.lang==='de'?'Von':'من'}" ${ref ? '' : 'disabled'}>
        <input type="number" class="form-input hw-qa-end" placeholder="${state.lang==='de'?'Bis':'إلى'}" ${ref ? '' : 'disabled'}>

        <button class="icon-btn hw-qa-send" type="button" ${ref ? '' : 'disabled'} aria-label="send">
          <i class="fa-solid fa-chevron-right"></i>
        </button>

        <div class="hw-qa-status text-sm text-sec"></div>
      `;

      const inpSur = row.querySelector('.hw-qa-surah');
      const dd = row.querySelector('.hw-qa-dd');
      const inpSt = row.querySelector('.hw-qa-start');
      const inpEn = row.querySelector('.hw-qa-end');
      const btn = row.querySelector('.hw-qa-send');
      const statusEl = row.querySelector('.hw-qa-status');

      bindSurahAutocomplete(inpSur, dd);

      btn?.addEventListener('click', (ev)=>{
        ev.stopPropagation();
        if(!ref) return;
        hwQuickAssignSendOne(ref, inpSur, inpSt, inpEn, btn, statusEl, row, null);
      });

      // allow Enter key to send (from last input)
      [inpEn].forEach(inp=>{
        inp?.addEventListener('keydown', (e)=>{
          if(e.key === 'Enter'){
            e.preventDefault();
            btn?.click();
          }
        });
      });

      box.appendChild(row);
    });

    updateHomeworkAdminSelectAllUI(); // hidden in quick mode
    return;
  }

  // Normal view (expand) + manage mode (-) selection
  list.forEach(s=>{
    const ref = String(s.referenz || '').trim();

    const row = document.createElement('div');
    row.className = 'bulk-row';

    // Highlight student when all Quran homework is confirmed
    try{
      const cachedHw = ref ? hwAdmHomeworkCache.get(ref) : null;
      if(ref && Array.isArray(cachedHw)){
        const qItems = cachedHw.filter(h=>{
          const info = decodeHomeworkSurah(h?.surah);
          return info.kind !== 'text';
        });
        if(qItems.length > 0 && qItems.every(isHomeworkConfirmed)){
          row.classList.add('hw-all-confirmed');
        }
      }
    }catch(e){}

    const caret = hwAdmExpandedRefs.has(ref)
      ? '<i class="fa-solid fa-chevron-up"></i>'
      : '<i class="fa-solid fa-chevron-down"></i>';

    const checked = (hwAdminManageMode) && ref && hwAdminSelectedRefs.has(ref);

    row.innerHTML = `
      <div class="bulk-left" style="gap:10px;">
        ${hwAdminManageMode ? `<input type="checkbox" class="hw-adm-cb" ${checked ? 'checked' : ''} ${ref ? '' : 'disabled'} aria-label="select">` : ''}
        <div style="min-width:0;">
          <div class="bulk-name ${hwStudentSeenClass(ref)}">${hwParentSeenIconHtml(ref)}${escapeHtml(s.fullName || '')}</div>
        </div>
      </div>
      <button class="hw-expand-btn" type="button" ${ref ? '' : 'disabled'} aria-label="expand">${caret}</button>
    `;

    const cb = row.querySelector('.hw-adm-cb');
    if(cb){
      cb.addEventListener('change', ()=>{
        if(!ref) return;
        if(cb.checked) hwAdminSelectedRefs.add(ref);
        else hwAdminSelectedRefs.delete(ref);
        updateHomeworkAdminManageSelectedCount();
        updateHomeworkAdminManageDropdown();
        updateHomeworkAdminSelectAllUI();
      });
    }

    const btn = row.querySelector('.hw-expand-btn');
    btn?.addEventListener('click', (ev)=>{
      ev.stopPropagation();
      if(!ref) return;
      if(hwAdmExpandedRefs.has(ref)) hwAdmExpandedRefs.delete(ref);
      else hwAdmExpandedRefs.add(ref);
      renderHomeworkAdminStudents();
      if(hwAdmExpandedRefs.has(ref)) ensureHomeworkAdminLoaded(ref);
    });

    row.addEventListener('click', (ev)=>{
      const tag = (ev.target && ev.target.tagName) ? ev.target.tagName.toLowerCase() : '';
      if(tag === 'button' || tag === 'input' || (ev.target && ev.target.closest && ev.target.closest('.hw-expand-btn'))) return;

      if(hwAdminManageMode){
        if(cb){
          cb.checked = !cb.checked;
          cb.dispatchEvent(new Event('change'));
        }
        return;
      }

      if(!ref) return;
      if(hwAdmExpandedRefs.has(ref)) hwAdmExpandedRefs.delete(ref);
      else hwAdmExpandedRefs.add(ref);
      renderHomeworkAdminStudents();
      if(hwAdmExpandedRefs.has(ref)) ensureHomeworkAdminLoaded(ref);
    });

    box.appendChild(row);

    if(ref && hwAdmExpandedRefs.has(ref)){
      const panel = document.createElement('div');
      panel.className = 'hw-all-panel';
      panel.id = 'hwadmin_' + safeIdFromRef(ref);
      panel.innerHTML = `<div class="text-sm text-sec">${state.lang==='de'?'Lade...':'جارٍ التحميل...'}</div>`;
      box.appendChild(panel);

      const cached = hwAdmHomeworkCache.get(ref);
      if(Array.isArray(cached)){
        renderHomeworkAdminPanel(ref, cached);
      }
    }
  });

  updateHomeworkAdminSelectAllUI();
}

function _makeRequestId(){
  try{
    if(typeof crypto !== 'undefined' && crypto.randomUUID) return crypto.randomUUID();
  }catch(e){}
  return Date.now() + '_' + Math.random().toString(16).slice(2);
}

// Autocomplete for surah input (same matching logic as Quran section)
function bindSurahAutocomplete(inp, dd){
  if(!inp || !dd) return;
  if(inp._qsBound) return;
  inp._qsBound = true;

  // Ensure dd styles
  dd.style.marginTop = '6px';
  dd.style.padding = '8px';
  dd.style.maxHeight = '180px';
  dd.style.overflow = 'auto';

  function close(){
    dd.classList.add('hidden');
    dd.innerHTML = '';
  }

  inp.addEventListener('input', ()=>{
    const q = (inp.value||'').trim().toLowerCase();
    dd.innerHTML = '';
    if(!q){ close(); return; }

    const matches = SURAH_LIST.filter(([num,de,ar])=>{
      const n = String(num);
      const deL = String(de).toLowerCase();
      const arS = String(ar);
      const iniDe = initialsOfName(de);
      const iniAr = initialsOfName(arS);
      return n.startsWith(q) || deL.includes(q) || arS.includes(q) || iniDe.startsWith(q) || iniAr.startsWith(q);
    }).slice(0, 20);

    if(matches.length === 0){ close(); return; }

    matches.forEach(([num,de,ar])=>{
      const item = document.createElement('div');
      item.style.padding = '8px';
      item.style.borderBottom = '1px solid var(--border)';
      item.style.cursor = 'pointer';
      item.innerHTML = `<b style="color:var(--primary)">${num}</b> — ${escapeHtml(ar)}`;
      item.onclick = ()=>{
        inp.value = String(num);
        close();
      };
      dd.appendChild(item);
    });

    dd.classList.remove('hidden');
  });

  inp.addEventListener('blur', ()=> setTimeout(()=>{
    try{
      // close if focus isn't on input or inside dropdown
      if(document.activeElement !== inp && !dd.contains(document.activeElement)) close();
    }catch(e){ close(); }
  }, 150));
}

// Send homework for ONE student (no retries). After all sends, verify after 5 seconds and allow retry only if missing.

function hwQuickAssignSendOne(ref, inpSur, inpSt, inpEn, btn, statusEl, rowEl, inpFreeText){
  ref = String(ref||'').trim();
  if(!ref) return;

  const requestId = _makeRequestId();
  const dateLocal = getLocalDMYDate();

  let payload = null;

  if(hwAdminQuickType === 'text'){
    const free = (inpFreeText?.value || '').trim();
    if(!free){
      return showToast(state.lang==='de' ? 'Bitte Text eingeben' : 'اكتب نوع الواجب');
    }

    payload = {
      action: 'assignHomework',
      studentRef: ref,
      surah: 'TEXT|' + free,
      ayahStart: '',
      ayahEnd: '',
      teacherName: state.user,
      date: dateLocal,
      clientTs: Date.now(),
      requestId
    };
  }else{
    const surRaw = (inpSur?.value || '').trim();
    const start = (inpSt?.value || '').toString().trim();
    const end   = (inpEn?.value || '').toString().trim();

    if(!surRaw){
      return showToast(state.lang==='de' ? 'Bitte Sure eingeben' : 'ادخل السورة');
    }
    if(!start || !end){
      return showToast(state.lang==='de' ? 'Bitte Vers-Bereich eingeben' : 'ادخل نطاق الآيات');
    }

    payload = {
      action: 'assignHomework',
      studentRef: ref,
      surah: 'MEM|' + surRaw,
      ayahStart: start,
      ayahEnd: end,
      teacherName: state.user,
      date: dateLocal,
      clientTs: Date.now(),
      requestId
    };
  }

  // UI
  try{
    rowEl?.classList.remove('hw-qa-ok','hw-qa-fail');
    if(statusEl) statusEl.textContent = (state.lang==='de') ? 'Sende…' : 'جارٍ الإرسال…';
    if(btn){
      btn.disabled = true;
      btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
    }
  }catch(e){}

  // store for later verification (even if the response is delayed/lost)
  hwQuickPending.set(requestId, { ref, rowEl, btnEl: btn, statusEl });

  // Send sequentially to be gentle with Apps Script
  queueHwAdminSend(async ()=>{
    try{
      const res = await fetch(WEB_APP_URL, {
        method: 'POST',
        headers: { "Content-Type": "text/plain" },
        body: JSON.stringify(payload)
      }).then(r=>r.json());

      // don't retry here — we'll verify after 5s and only then allow manual resend
      if(res && res.ok){
        if(statusEl) statusEl.textContent = (state.lang==='de') ? 'Gesendet (warte auf Bestätigung)…' : 'تم الإرسال (بانتظار التأكيد)…';
      }else{
        if(statusEl) statusEl.textContent = (state.lang==='de') ? 'Gesendet (prüfe ob gespeichert)…' : 'تم الإرسال (سنتحقق من الحفظ)…';
      }
    }catch(e){
      if(statusEl) statusEl.textContent = (state.lang==='de') ? 'Keine Antwort (prüfe in 5s)…' : 'لا يوجد رد (سنتحقق بعد 5 ثوان)…';
    }finally{
      scheduleHwQuickVerify();
    }
  });
}

function scheduleHwQuickVerify(){
  hwQuickLastSendAt = Date.now();
  if(hwQuickVerifyTimer) clearTimeout(hwQuickVerifyTimer);
  hwQuickVerifyTimer = setTimeout(()=>{ runHwQuickVerify(); }, 5000);
}

async function runHwQuickVerify(){
  try{ if(hwQuickVerifyTimer) clearTimeout(hwQuickVerifyTimer); }catch(e){}
  hwQuickVerifyTimer = null;

  const entries = Array.from(hwQuickPending.entries());
  if(entries.length === 0) return;

  // group requestIds by studentRef to reduce calls
  const byRef = new Map(); // ref -> [{requestId, obj}]
  entries.forEach(([rid, obj])=>{
    if(!obj || !obj.ref) return;
    const ref = String(obj.ref);
    if(!byRef.has(ref)) byRef.set(ref, []);
    byRef.get(ref).push({ requestId: rid, obj });
  });

  for(const [ref, arr] of byRef.entries()){
    let hw = [];
    try{
      const res = await fetch(WEB_APP_URL, {
        method: 'POST',
        body: JSON.stringify({ action: 'getStudentHomework', studentRef: ref })
      }).then(r=>r.json());
      hw = (res && res.ok) ? (res.homework || []) : [];
    }catch(e){
      hw = [];
    }

    // update cache for normal view
    try{ hwAdmHomeworkCache.set(ref, hw); }catch(e){}

    for(const it of arr){
      const rid = it.requestId;
      const obj = it.obj;
      const rowEl = obj?.rowEl;
      const statusEl = obj?.statusEl;
      const btn = obj?.btnEl;

      const found = (hw || []).some(h=>{
        const hrid = String(h?.requestId || h?.requestID || '').trim();
        return hrid && hrid === rid;
      });

      if(found){
        try{
          rowEl?.classList.add('hw-qa-ok');
          if(statusEl) statusEl.textContent = (state.lang==='de') ? 'Gespeichert ✓' : 'تم الحفظ ✓';
          if(btn){
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-check"></i>';
          }
          // optional: clear inputs
          try{
            rowEl?.querySelector('.hw-qa-surah')?.blur();
            try{ rowEl?.querySelector('.hw-qa-free') && (rowEl.querySelector('.hw-qa-free').value = ''); }catch(e){}
          }catch(e){}
        }catch(e){}
      }else{
        try{
          rowEl?.classList.add('hw-qa-fail');
          if(statusEl) statusEl.textContent = (state.lang==='de') ? 'Nicht gespeichert – bitte erneut senden' : 'لم يُسجَّل – أعد الإرسال';
          if(btn){
            btn.disabled = false;
            btn.innerHTML = '<i class="fa-solid fa-chevron-right"></i>';
          }
        }catch(e){}
      }

      hwQuickPending.delete(rid);
    }

    await __sleep(120);
  }
}


function ensureHomeworkAdminLoaded(ref){
  ref = String(ref||'').trim();
  if(!ref) return;

  try{
    if(typeof hwAdmHomeworkCache !== 'undefined' && hwAdmHomeworkCache.has(ref)){
      const cached = hwAdmHomeworkCache.get(ref);
      if(Array.isArray(cached)) renderHomeworkAdminPanel(ref, cached);
      return;
    }
  }catch(e){}

  // Load into the correct cache (hwAdmHomeworkCache), then render
  fetchStudentHomeworkIntoAdminCache(ref)
    .then(arr=>{ try{ renderHomeworkAdminPanel(ref, Array.isArray(arr)?arr:[]); }catch(e){} })
    .catch(()=>{ try{ renderHomeworkAdminPanel(ref, []); }catch(e){} });
}



function renderHomeworkAdminPanel(ref, homework){
  const panel = document.getElementById('hwadmin_' + safeIdFromRef(ref));
  if(!panel) return;

  const hidden = (typeof getHiddenHwSet === 'function') ? getHiddenHwSet() : new Set();
  const raw = Array.isArray(homework) ? homework : [];
  const list = raw.filter(h=>{
    const row = Number(h?.rowIndex||0);
    if(row && hidden.has(row)) return false;
    return true;
  });

  if(list.length === 0){
    panel.innerHTML = `<div class="text-sm text-sec">${state.lang==='de'?'Keine Einträge.':'لا يوجد واجبات.'}</div>`;
    return;
  }

  const sorted = list.slice().sort((a,b)=>{
    const da = dateToTS(a?.date||'');
    const db = dateToTS(b?.date||'');
    return db - da;
  });

  panel.innerHTML = '';
  sorted.forEach(h=>{
    const info = decodeHomeworkSurah(h?.surah);
    const date = escapeHtml(normalizeDateToDMY(h?.date || ''));
    const teacher = ''; // hidden by request
    const confirmed = isHomeworkConfirmed(h);
    const rowIndex = Number(h?.rowIndex||0);

    let title = '';
    let body = '';
    let bodyClass = '';
    let right = '';

    if(info.kind === 'text'){
      title = state.lang==='de' ? '📝 Freier Text' : '📝 نص حر';
      const txt = (info.freeText || '').trim();
      body = escapeHtml(txt);
      bodyClass = confirmed ? 'confirmed' : 'pending';

      // Optional: allow confirming "done" for free text too
      if(rowIndex){
        right = `
          <div class="hw-mini-stack">
            <label class="hw-mini-toggle">
            <input type="checkbox" ${confirmed ? 'checked' : ''} onchange="toggleHomeworkConfirmed(${rowIndex}, this.checked)">
            <span>${state.lang==='de' ? 'Erledigt' : 'تم'}</span>
          </label>
            <button class=\"hw-mini-edit-btn\" type=\"button\" data-hw-edit title=\"${state.lang==='de'?'Bearbeiten':'تعديل'}\"><i class=\"fa-solid fa-pen\"></i><span>${state.lang==='de'?'Bearbeiten':'تعديل'}</span></button>
          </div>
        `;
      }
    }else{
      title = escapeHtml(info.label || info.surahText || '');
      const rangeTxt = getAyahRangeText(h);
      body = rangeTxt ? `<span class="hw-ayah-range ${confirmed ? 'confirmed' : 'pending'}">${escapeHtml(rangeTxt)}</span>` : '';
      bodyClass = confirmed ? 'confirmed' : 'pending';

      if(info.badge){
        title += ` <span class="pill" style="margin-left:6px; font-size:0.78rem; padding:2px 8px;">${escapeHtml(info.badge)}</span>`;
      }

      // Quran tasmi' confirmation
      if(rowIndex){
        right = `
          <div class="hw-mini-stack">
            <label class="hw-mini-toggle">
            <input type="checkbox" ${confirmed ? 'checked' : ''} onchange="toggleHomeworkConfirmed(${rowIndex}, this.checked)">
            <span>${state.lang==='de' ? 'Tasmiʿ bestätigt' : 'تأكيد التسميع'}</span>
          </label>
            <button class=\"hw-mini-edit-btn\" type=\"button\" data-hw-edit title=\"${state.lang==='de'?'Bearbeiten':'تعديل'}\"><i class=\"fa-solid fa-pen\"></i><span>${state.lang==='de'?'Bearbeiten':'تعديل'}</span></button>
          </div>
        `;
      }else if(confirmed){
        right = `<span class="pill" style="font-size:0.78rem; padding:2px 8px;">${state.lang==='de'?'Bestätigt':'مؤكد'}</span>`;
      }
    }

    const el = document.createElement('div');
    el.className = `hw-all-item ${bodyClass === 'confirmed' ? 'hw-confirmed' : 'hw-pending'}`;
    el.innerHTML = `
      <div class="hw-all-left">
        <div class="hw-all-title" style="font-weight:900; font-size:0.95rem;">${title}</div>
        <div class="hw-all-meta text-sm text-sec" style="margin-top:1px;">${date}${teacher}</div>
        ${body ? `<div class="hw-all-body" style="margin-top:3px; white-space:pre-wrap;">${body}</div>` : ``}
      </div>
      <div class="hw-all-actions">${right}</div>
    `;
        const editBtn = el.querySelector('button[data-hw-edit]');
    editBtn?.addEventListener('click', (ev)=>{
      ev.stopPropagation();
      if(!rowIndex) return;
      openHomeworkEditModal(String(ref), h, rowIndex);
    });
panel.appendChild(el);
  });
}



function initBulkHomeworkUI(){
  // Teacher/Admin: Aufgaben uses the SAME filter as Schüler (global filter panel)
  try{ updateHomeworkFilterSummary(); }catch(e){}

  // Ensure UI state
  setupHomeworkSurahDropdownBulk();
  toggleBulkHomeworkTypeUI();

  // Render list (keep selection)
  renderBulkHomeworkStudents();
}




// ===== Homework Admin: All Homework View =====
let hwAllSelectedRefs = new Set();
let hwAllExpandedRefs = new Set();
let hwAllHomeworkCache = new Map(); // ref -> homework array

// --- Homework selection + bulk actions (by homework item) ---
const LOCAL_HIDDEN_HW_KEY = 'hidden_hw_rowidx_v1';
let hwAllPrimeTimer = null;
let hwAllPriming = false;

function getHiddenHwSet(){
  try{
    const raw = localStorage.getItem(LOCAL_HIDDEN_HW_KEY);
    const arr = raw ? JSON.parse(raw) : [];
    return new Set((Array.isArray(arr)?arr:[]).map(n=>Number(n)||0).filter(Boolean));
  }catch(e){ return new Set(); }
}
function persistHiddenHwSet(set){
  try{
    const arr = Array.from(set||[]).map(n=>Number(n)||0).filter(Boolean);
    localStorage.setItem(LOCAL_HIDDEN_HW_KEY, JSON.stringify(arr));
  }catch(e){}
}
function hideHomeworkRowLocal(rowIndex){
  rowIndex = Number(rowIndex||0);
  if(!rowIndex) return;
  const set = getHiddenHwSet();
  set.add(rowIndex);
  persistHiddenHwSet(set);
}


function isHomeworkConfirmed(h){
  return (h?.confirmed === true)
    || (String(h?.confirmed || '').trim() === '1')
    || (String(h?.confirmed || '').toLowerCase() === 'true')
    || (String(h?.confirmedFlag || '').trim() === '1')
    || (String(h?.confirmedFlag || '').toLowerCase() === 'true');
}
function getAyahStart(h){
  return String(h?.ayahStart ?? h?.start ?? h?.from ?? h?.ayahFrom ?? '').trim();
}
function getAyahEnd(h){
  return String(h?.ayahEnd ?? h?.end ?? h?.to ?? h?.ayahTo ?? '').trim();
}
function getAyahRangeText(h){
  const a1 = getAyahStart(h);
  const a2 = getAyahEnd(h);
  if(a1 && a2) return `${a1} - ${a2}`;
  return (a1 || a2 || '');
}

function hwKeyObj(h){
  const surah = String(h?.surah||'').trim();
  const a1 = String(h?.ayahStart ?? h?.start ?? '').trim();
  const a2 = String(h?.ayahEnd ?? h?.end ?? '').trim();
  return { surah: surah, ayahStart: a1, ayahEnd: a2 };
}
function hwKeyStr(h){
  return JSON.stringify(hwKeyObj(h));
}
function hwKeyEqual(h, keyObj){
  if(!keyObj) return false;
  const o = hwKeyObj(h);
  return (
    o.surah === String(keyObj.surah||'').trim() &&
    o.ayahStart === String(keyObj.ayahStart||'').trim() &&
    o.ayahEnd === String(keyObj.ayahEnd||'').trim()
  );
}


function hwDisplayLabel(h){
  const info = decodeHomeworkSurah(h?.surah);
  const a1 = getAyahStart(h);
  const a2 = getAyahEnd(h);

  if(info.kind === 'text'){
    const txt = (info.freeText || '').trim();
    const shortTxt = txt.length > 40 ? (txt.slice(0,40)+'…') : txt;
    return (state.lang==='de' ? `Text: ${shortTxt}` : `نص: ${shortTxt}`);
  }

  const sur = info.label || info.surahText || '';
  const range = (a1 && a2) ? `${a1}-${a2}` : (a1||a2||'');
  const badge = info.kind==='memorized' ? (state.lang==='de'?'(Auswendig)':'(حفظ)') : '';
  return `${sur}${range ? ' • '+range : ''} ${badge}`.trim();
}


function setAllHomeworkSelectOptions(options){
  const sel = document.getElementById('hw-all-hw-select');
  if(!sel) return;
  const prev = sel.value || '';
  sel.innerHTML = '';
  const o0 = document.createElement('option');
  o0.value = '';
  o0.textContent = (state.lang==='de') ? 'Hausaufgabe wählen…' : 'اختر الواجب…';
  sel.appendChild(o0);

  (options||[]).forEach(opt=>{
    const o = document.createElement('option');
    o.value = opt.sigKey;
    o.textContent = opt.label;
    sel.appendChild(o);
  });

  if(prev && Array.from(sel.options).some(o=>o.value===prev)){
    sel.value = prev;
  }
}

function schedulePrimeAllHomeworkOptions(){
  clearTimeout(hwAllPrimeTimer);
  hwAllPrimeTimer = setTimeout(()=>primeAllHomeworkOptionsForVisibleStudents(), 450);
}

async function fetchStudentHomeworkIntoCache(ref){
  ref = String(ref||'').trim();
  if(!ref) return [];
  if(hwAllHomeworkCache.has(ref)) return hwAllHomeworkCache.get(ref) || [];
  try{
    const res = await fetch(WEB_APP_URL, {
      method: 'POST',
      headers: { "Content-Type": "text/plain" },
      body: JSON.stringify({ action: 'getStudentHomework', studentRef: ref })
    }).then(r=>r.json());
    const raw = (res && res.ok) ? (res.homework || []) : [];
    // Normalize field names for consistent matching
    const list = (raw||[]).map(h=>({
      ...h,
      ayahStart: String(h?.ayahStart ?? h?.start ?? '').trim(),
      ayahEnd:   String(h?.ayahEnd ?? h?.end ?? '').trim()
    }));
    hwAllHomeworkCache.set(ref, list);
    try{ hwTeacherConfirmStatusMap.set(ref, hwTeacherStatusFromList_(list)); }catch(e){}
    return list;
  }catch(e){
    hwAllHomeworkCache.set(ref, []);
    return [];
  }
}

// ===== Aufgaben (Teacher/Admin tab): cache helper for Admin/Teacher student-list panels =====
// NOTE: This writes to hwAdmHomeworkCache (NOT hwAllHomeworkCache) to avoid partial loading / stopping.
async function fetchStudentHomeworkIntoAdminCache(ref){
  ref = String(ref||'').trim();
  if(!ref) return [];
  try{
    if(typeof hwAdmHomeworkCache !== 'undefined' && hwAdmHomeworkCache.has(ref)){
      return hwAdmHomeworkCache.get(ref) || [];
    }
  }catch(e){}

  // Robust JSON parsing (Apps Script can sometimes return HTML on quota/timeouts)
  async function __safeJson(resp){
    try{ return await resp.json(); }catch(e){ return null; }
  }

  try{
    const resp = await fetch(WEB_APP_URL, {
      method: 'POST',
      headers: { "Content-Type": "text/plain" },
      body: JSON.stringify({ action: 'getStudentHomework', studentRef: ref })
    });
    const res = await __safeJson(resp);

    const raw = (res && res.ok) ? (res.homework || []) : [];
    const list = (raw||[]).map(h=>({
      ...h,
      ayahStart: String(h?.ayahStart ?? h?.start ?? '').trim(),
      ayahEnd:   String(h?.ayahEnd ?? h?.end ?? '').trim()
    }));

    try{ if(typeof hwAdmHomeworkCache !== 'undefined') hwAdmHomeworkCache.set(ref, list); }catch(e){}
    try{ if(typeof hwTeacherConfirmStatusMap !== 'undefined') hwTeacherConfirmStatusMap.set(ref, hwTeacherStatusFromList_(list)); }catch(e){}

    return list;
  }catch(e){
    try{ if(typeof hwAdmHomeworkCache !== 'undefined') hwAdmHomeworkCache.set(ref, []); }catch(e2){}
    return [];
  }
}


async function primeAllHomeworkOptionsForVisibleStudents(){
  if(hwAllPriming) return;
  hwAllPriming = true;

  const statusEl = document.getElementById('hw-all-status');
  try{
    const list = getAllHomeworkCurrentStudentList();
    if(list.length === 0){
      setAllHomeworkSelectOptions([]);
      if(statusEl) statusEl.textContent = '';
      return;
    }

    if(statusEl) statusEl.textContent = (state.lang==='de') ? 'Lade Hausaufgaben-Liste…' : 'جارٍ تجهيز قائمة الواجبات…';

    const hidden = getHiddenHwSet();
    const sigMap = new Map(); // keyStr -> {sigKey,label}

    const refs = list.map(s=>String(s.referenz||'').trim()).filter(Boolean);

    // Prefer ONE backend call (fast)
    let bulkOk = false;
    try{
      const res = await fetch(WEB_APP_URL, {
        method:'POST',
        headers: { "Content-Type": "text/plain" },
        body: JSON.stringify({ action:'getHomeworkForStudents', studentRefs: refs })
      }).then(r=>r.json());

      if(res && res.ok && res.homeworkByStudent && typeof res.homeworkByStudent === 'object'){
        bulkOk = true;
        for(const ref of refs){
          const raw = Array.isArray(res.homeworkByStudent[ref]) ? res.homeworkByStudent[ref] : [];
          const norm = raw.map(h=>({
            ...h,
            ayahStart: String(h?.ayahStart ?? h?.start ?? '').trim(),
            ayahEnd:   String(h?.ayahEnd ?? h?.end ?? '').trim()
          }));
          hwAllHomeworkCache.set(ref, norm);
          norm.forEach(h=>{
            const row = Number(h.rowIndex||0);
            if(row && hidden.has(row)) return;
            const keyStr = hwKeyStr(h);
            if(!keyStr) return;
            if(!sigMap.has(keyStr)){
              sigMap.set(keyStr, { sigKey: encodeURIComponent(keyStr), label: hwDisplayLabel(h) });
            }
          });
        }
      }
    }catch(e){ /* ignore, fallback below */ }

    if(!bulkOk){
      // Fallback: per-student fetching (older backend)
      const limit = 4;
      let i = 0;

      async function worker(){
        while(i < refs.length){
          const my = refs[i++];
          const hw = await fetchStudentHomeworkIntoCache(my);
          (hw||[]).forEach(h=>{
            const row = Number(h.rowIndex||0);
            if(row && hidden.has(row)) return;
            const keyStr = hwKeyStr(h);
            if(!keyStr) return;
            if(!sigMap.has(keyStr)){
              sigMap.set(keyStr, { sigKey: encodeURIComponent(keyStr), label: hwDisplayLabel(h) });
            }
          });
        }
      }

      const workers = Array.from({length: Math.min(limit, refs.length)}, ()=>worker());
      await Promise.all(workers);
    }

    const options = Array.from(sigMap.values()).sort((a,b)=>String(a.label).localeCompare(String(b.label)));
    setAllHomeworkSelectOptions(options);

    if(statusEl) statusEl.textContent = (state.lang==='de')
      ? `Bereit • ${options.length} Hausaufgaben gefunden.`
      : `جاهز • تم العثور على ${options.length} واجب.`;
  }finally{
    hwAllPriming = false;
  }
}

function getSelectedHomeworkSig(){
  const sel = document.getElementById('hw-all-hw-select');
  const rawVal = sel ? String(sel.value||'') : '';
  if(!rawVal) return null;
  try{
    const jsonStr = decodeURIComponent(rawVal);
    const obj = JSON.parse(jsonStr);
    if(!obj || typeof obj !== 'object') return null;
    return {
      surah: String(obj.surah||'').trim(),
      ayahStart: String(obj.ayahStart||'').trim(),
      ayahEnd: String(obj.ayahEnd||'').trim()
    };
  }catch(e){
    return null;
  }
}

async function deleteHomeworkRowSilent(rowIndex){
  rowIndex = Number(rowIndex||0);
  if(!rowIndex) return false;

  // Try known/likely backend actions
  const tries = ['deleteHomeworkRow','deleteHomework','removeHomework'];
  for(const actionName of tries){
    try{
      const res = await fetch(WEB_APP_URL, {
        method:'POST',
        headers: { "Content-Type": "text/plain" },
        body: JSON.stringify({ action: actionName, rowIndex: rowIndex, teacherName: state.user })
      }).then(r=>r.json());
      if(res && res.ok) return true;
    }catch(e){}
  }
  return false;
}

async function bulkConfirmSelectedHomework(makeConfirmed){
  const keyObj = getSelectedHomeworkSig();
  if(!keyObj){
    showToast(state.lang==='de' ? 'Bitte Hausaufgabe auswählen.' : 'اختر الواجب أولاً.');
    return;
  }

  const refs = Array.from(hwAllSelectedRefs || []);
  if(refs.length === 0){
    showToast(state.lang==='de' ? 'Bitte mindestens einen Schüler auswählen.' : 'اختر طالباً واحداً على الأقل.');
    return;
  }

  const statusEl = document.getElementById('hw-all-status');
  if(statusEl) statusEl.textContent = (state.lang==='de' ? 'Aktualisiere…' : 'جارٍ التحديث…');

  // Try server-side bulk update (fast)
  try{
    const res = await fetch(WEB_APP_URL, {
      method:'POST',
      headers: { "Content-Type": "text/plain" },
      body: JSON.stringify({
        action: 'bulkSetHomeworkConfirmed',
        studentRefs: refs,
        surah: keyObj.surah,
        ayahStart: keyObj.ayahStart,
        ayahEnd: keyObj.ayahEnd,
        confirmed: !!makeConfirmed,
        teacherName: state.user
      })
    }).then(r=>r.json());

    if(res && res.ok){
      if(statusEl){
        statusEl.textContent = (state.lang==='de')
          ? `Fertig: ${res.updated || 0} aktualisiert.`
          : `تم: تحديث ${res.updated || 0}.`;
      }
      showToast(state.lang==='de' ? 'Aktualisiert' : 'تم التحديث');

      // refresh caches + UI
      refs.forEach(r=>hwAllHomeworkCache.delete(r));
      hwAllExpandedRefs.forEach(r=>{
        if(refs.includes(r)) ensureAllHomeworkLoaded(r);
      });
      renderAllHomeworkStudents();
      schedulePrimeAllHomeworkOptions();
      return;
    }
  }catch(e){}

  // Fallback (older backend): toggle per-row
  let touched = 0, ok = 0;
  for(const ref of refs){
    const list = await fetchStudentHomeworkIntoCache(ref);
    const matches = (list||[]).filter(h=>hwKeyEqual(h, keyObj));
    for(const h of matches){
      const rowIndex = Number(h.rowIndex||0);
      if(!rowIndex) continue;
      touched++;
      const resOk = await toggleHomeworkConfirmedSilent(rowIndex, !!makeConfirmed);
      if(resOk) ok++;
    }
    hwAllHomeworkCache.delete(ref);
    if(hwAllExpandedRefs.has(ref)) ensureAllHomeworkLoaded(ref);
  }

  if(statusEl){
    statusEl.textContent = (state.lang==='de')
      ? `Fertig: ${ok}/${touched} aktualisiert.`
      : `تم: تحديث ${ok} من ${touched}.`;
  }
  if(touched>0) showToast(state.lang==='de' ? 'Aktualisiert' : 'تم التحديث');
  schedulePrimeAllHomeworkOptions();
}

async function bulkDeleteSelectedHomework(){
  const keyObj = getSelectedHomeworkSig();
  if(!keyObj){
    showToast(state.lang==='de' ? 'Bitte Hausaufgabe auswählen.' : 'اختر الواجب أولاً.');
    return;
  }

  const refs = Array.from(hwAllSelectedRefs || []);
  if(refs.length === 0){
    showToast(state.lang==='de' ? 'Bitte mindestens einen Schüler auswählen.' : 'اختر طالباً واحداً على الأقل.');
    return;
  }

  const statusEl = document.getElementById('hw-all-status');
  if(statusEl) statusEl.textContent = (state.lang==='de' ? 'Lösche…' : 'جارٍ الحذف…');

  // Try server-side bulk delete (fast)
  try{
    const res = await fetch(WEB_APP_URL, {
      method:'POST',
      headers: { "Content-Type": "text/plain" },
      body: JSON.stringify({
        action: 'bulkDeleteHomework',
        studentRefs: refs,
        surah: keyObj.surah,
        ayahStart: keyObj.ayahStart,
        ayahEnd: keyObj.ayahEnd,
        teacherName: state.user
      })
    }).then(r=>r.json());

    if(res && res.ok){
      if(statusEl){
        statusEl.textContent = (state.lang==='de')
          ? `Fertig: ${res.deleted || 0} gelöscht.`
          : `تم: حذف ${res.deleted || 0}.`;
      }
      showToast(state.lang==='de' ? 'Erledigt' : 'تم');

      refs.forEach(r=>hwAllHomeworkCache.delete(r));
      hwAllExpandedRefs.forEach(r=>{
        if(refs.includes(r)) ensureAllHomeworkLoaded(r);
      });
      renderAllHomeworkStudents();
      schedulePrimeAllHomeworkOptions();
      return;
    }
  }catch(e){}

  // Fallback (older backend): delete by rowIndex (or hide locally)
  let touched = 0, ok = 0, hiddenOnly = 0;

  for(const ref of refs){
    const list = await fetchStudentHomeworkIntoCache(ref);
    const matches = (list||[]).filter(h=>hwKeyEqual(h, keyObj));
    for(const h of matches){
      const rowIndex = Number(h.rowIndex||0);
      if(!rowIndex) continue;
      touched++;
      const resOk = await deleteHomeworkRowSilent(rowIndex);
      if(resOk){
        ok++;
      }else{
        hideHomeworkRowLocal(rowIndex);
        hiddenOnly++;
      }
    }
    hwAllHomeworkCache.delete(ref);
    if(hwAllExpandedRefs.has(ref)) ensureAllHomeworkLoaded(ref);
  }

  if(statusEl){
    if(hiddenOnly>0 && ok===0){
      statusEl.textContent = (state.lang==='de')
        ? `Hinweis: Einträge wurden lokal ausgeblendet (${hiddenOnly}). (Server-Löschung nicht verfügbar)`
        : `ملاحظة: تم إخفاء ${hiddenOnly} إدخال محلياً (الحذف من السيرفر غير متاح).`;
    }else{
      statusEl.textContent = (state.lang==='de')
        ? `Fertig: ${ok}/${touched} gelöscht.`
        : `تم: حذف ${ok} من ${touched}.`;
    }
  }
  showToast(state.lang==='de' ? 'Erledigt' : 'تم');
  renderAllHomeworkStudents();
  schedulePrimeAllHomeworkOptions();
}


async function deleteOneHomeworkEntryForStudent(ref, rowIndex){
  ref = String(ref||'').trim();
  rowIndex = Number(rowIndex||0);
  if(!ref || !rowIndex) return;

  const ok = await deleteHomeworkRowSilent(rowIndex);
  if(ok){
    showToast(state.lang==='de' ? 'Gelöscht' : 'تم الحذف');
  }else{
    hideHomeworkRowLocal(rowIndex);
    showToast(state.lang==='de' ? 'Ausgeblendet (lokal)' : 'تم الإخفاء (محلياً)');
  }

  hwAllHomeworkCache.delete(ref);
  if(hwAllExpandedRefs.has(ref)) ensureAllHomeworkLoaded(ref);
  renderAllHomeworkStudents();
  schedulePrimeAllHomeworkOptions();
}


function openAllHomeworkAdmin(){
  document.getElementById('hw-admin-assign-header')?.classList.add('hidden');
  document.getElementById('hw-admin-assign-view')?.classList.add('hidden');
  document.getElementById('hw-admin-all-view')?.classList.remove('hidden');
  // ensure filters are populated
  try{ initAllHomeworkUI(); }catch(e){}
  renderAllHomeworkStudents();
  // update top button label if needed
  try{ updateLang(); }catch(e){}
}

function openAssignHomeworkAdmin(){
  document.getElementById('hw-admin-assign-header')?.classList.remove('hidden');
  document.getElementById('hw-admin-all-view')?.classList.add('hidden');
  document.getElementById('hw-admin-assign-view')?.classList.remove('hidden');
  // no-op
}

function initAllHomeworkUI(){
  // Teacher/Admin: Aufgaben uses the SAME filter as Schüler (global filter panel)
  try{ updateHomeworkFilterSummary(); }catch(e){}

  // placeholder
  const s = document.getElementById('hw-all-search');
  if(s) s.placeholder = (state.lang === 'de') ? 'Suchen...' : 'بحث...';

  // homework selector placeholder handled in updateLang()
}


function getAllHomeworkCurrentStudentList(){
  // Use the unified global filter (same as Schüler tab)
  const base = Array.isArray(state.filteredStudents) ? state.filteredStudents : (state.students || []);
  const q = (document.getElementById('hw-all-search')?.value || '').trim().toLowerCase();

  return (base || []).filter(s=>{
    if(q){
      const hay = `${s.fullName||''} ${s.parentName||''} ${s.phone||''} ${s.referenz||''}`.toLowerCase();
      if(!hay.includes(q)) return false;
    }
    return true;
  });
}


function toggleAllHomeworkSelectAll(checked){
  const list = getAllHomeworkCurrentStudentList();
  if(checked){
    list.forEach(s=>{
      const ref = String(s.referenz||'').trim();
      if(ref) hwAllSelectedRefs.add(ref);
    });
  }else{
    // only clear visible
    list.forEach(s=>{
      const ref = String(s.referenz||'').trim();
      if(ref) hwAllSelectedRefs.delete(ref);
    });
  }
  renderAllHomeworkStudents();
}

function safeIdFromRef(ref){
  return 'hwref_' + String(ref||'').replace(/[^a-zA-Z0-9_-]/g,'_');
}

function renderAllHomeworkStudents(){
  const box = document.getElementById('hw-all-students');
  const countEl = document.getElementById('hw-all-count');
  const selAll = document.getElementById('hw-all-selectall');
  if(!box) return;

  const list = getAllHomeworkCurrentStudentList();
  if(countEl) countEl.textContent = String(list.length);

  // sync select-all with visible list
  if(selAll){
    const visibleRefs = list.map(s=>String(s.referenz||'').trim()).filter(Boolean);
    selAll.checked = visibleRefs.length>0 && visibleRefs.every(r=>hwAllSelectedRefs.has(r));
  }

  box.innerHTML = '';
  if(list.length === 0){
    const empty = document.createElement('div');
    empty.className = 'bulk-empty';
    empty.textContent = (state.lang==='de') ? 'Keine Schüler gefunden.' : 'لا يوجد طلاب.';
    box.appendChild(empty);
    return;
  }

  list.forEach(s=>{
    const ref = String(s.referenz||'').trim();
    const row = document.createElement('div');
    row.className = 'bulk-row';
    const checked = ref && hwAllSelectedRefs.has(ref);
    const expanded = ref && hwAllExpandedRefs.has(ref);
    const caret = expanded ? '▾' : '▸';

    row.innerHTML = `
      <div class="bulk-left">
        <input type="checkbox" ${checked ? 'checked' : ''} ${ref ? '' : 'disabled'} />
        <div style="min-width:0;">
          <div class="bulk-name">${escapeHtml(s.fullName || '')}</div>
        </div>
      </div>
      <button class="hw-expand-btn" type="button" ${ref ? '' : 'disabled'} aria-label="expand">${caret}</button>
    `;

    const cb = row.querySelector('input[type="checkbox"]');
    cb?.addEventListener('change', ()=>{
      if(!ref) return;
      if(cb.checked) hwAllSelectedRefs.add(ref);
      else hwAllSelectedRefs.delete(ref);
      renderAllHomeworkStudents();
    });

    const btn = row.querySelector('.hw-expand-btn');
    btn?.addEventListener('click', (ev)=>{
      ev.stopPropagation();
      if(!ref) return;
      if(hwAllExpandedRefs.has(ref)) hwAllExpandedRefs.delete(ref);
      else hwAllExpandedRefs.add(ref);
      renderAllHomeworkStudents();
      if(hwAllExpandedRefs.has(ref)){
        ensureAllHomeworkLoaded(ref);
      }
    });

    // click row toggles expand (not checkbox)
    row.addEventListener('click', (ev)=>{
      if(ev.target && (ev.target.tagName||'').toLowerCase()==='input') return;
      if(ev.target && ev.target.classList && ev.target.classList.contains('hw-expand-btn')) return;
      if(!ref) return;
      if(hwAllExpandedRefs.has(ref)) hwAllExpandedRefs.delete(ref);
      else hwAllExpandedRefs.add(ref);
      renderAllHomeworkStudents();
      if(hwAllExpandedRefs.has(ref)){
        ensureAllHomeworkLoaded(ref);
      }
    });

    box.appendChild(row);

    // panel
    if(ref && hwAllExpandedRefs.has(ref)){
      const panel = document.createElement('div');
      panel.className = 'hw-all-panel';
      panel.id = safeIdFromRef(ref);
      panel.innerHTML = `<div class="text-sm text-sec">${state.lang==='de'?'Lade...':'جارٍ التحميل...'}</div>`;
      box.appendChild(panel);

      // if already cached, render immediately
      const cached = hwAllHomeworkCache.get(ref);
      if(Array.isArray(cached)){
        renderAllHomeworkPanel(ref, cached);
      }
    }
  });
  schedulePrimeAllHomeworkOptions();
}

function ensureAllHomeworkLoaded(ref){
  ref = String(ref||'').trim();
  if(!ref) return;
  if(hwAllHomeworkCache.has(ref)){
    const cached = hwAllHomeworkCache.get(ref);
    if(Array.isArray(cached)) renderAllHomeworkPanel(ref, cached);
    return;
  }

  fetch(WEB_APP_URL, { 
    method: 'POST', 
    body: JSON.stringify({ action: 'getStudentHomework', studentRef: ref }) 
  }).then(r=>r.json()).then(res=>{
    if(res && res.ok){
      hwAllHomeworkCache.set(ref, res.homework || []);
      renderAllHomeworkPanel(ref, res.homework || []);
    }else{
      hwAllHomeworkCache.set(ref, []);
      renderAllHomeworkPanel(ref, []);
    }
  }).catch(()=>{
    hwAllHomeworkCache.set(ref, []);
    renderAllHomeworkPanel(ref, []);
  });
}

function renderAllHomeworkPanel(ref, homework){
  const panel = document.getElementById(safeIdFromRef(ref));
  if(!panel) return;

  const hidden = getHiddenHwSet();
  const raw = Array.isArray(homework) ? homework : [];
  const list = raw.filter(h=>{
    const row = Number(h?.rowIndex||0);
    if(row && hidden.has(row)) return false;
    return true;
  });

  if(list.length === 0){
    panel.innerHTML = `<div class="text-sm text-sec">${state.lang==='de'?'Keine Einträge.':'لا يوجد واجبات.'}</div>`;
    return;
  }

  // newest first if date is present
  const sorted = list.slice().sort((a,b)=>{
    const da = dateToTS(a?.date||'');
    const db = dateToTS(b?.date||'');
    return db - da;
  });

  panel.innerHTML = '';
  sorted.forEach(h=>{
    const info = decodeHomeworkSurah(h?.surah);
    const date = escapeHtml(normalizeDateToDMY(h?.date || ''));
    const teacher = '';
    const rowIndex = Number(h?.rowIndex || 0);
    const sigKey = encodeURIComponent(hwKeyStr(h));

    const confirmed = (h?.confirmed === true)
      || (String(h?.confirmed || '').trim() === '1')
      || (String(h?.confirmed || '').toLowerCase() === 'true')
      || (String(h?.confirmedFlag || '').trim() === '1')
      || (String(h?.confirmedFlag || '').toLowerCase() === 'true');

    const confLabel = (info.kind === 'text')
      ? (state.lang==='de'?'Als erledigt bestätigt':'تم تنفيذ الواجب')
      : (state.lang==='de'?'Als auswendig bestätigt':'تم التسميع (حفظ)');

    let title = '';
    let body = '';

    if(info.kind === 'text'){
      title = (state.lang==='de' ? 'Text' : 'نص');
      body = escapeHtml(info.freeText || '');
    } else {
      title = escapeHtml(info.label || info.surahText || '');
      const a1 = String(h?.ayahStart || '').trim();
      const a2 = String(h?.ayahEnd || '').trim();
      body = escapeHtml([a1,a2].filter(Boolean).join(' - '));
      if(info.badge){
        title += ` <span class="pill" style="margin-left:6px; font-size:0.78rem; padding:2px 8px;">${escapeHtml(info.badge)}</span>`;
      }
    }

    const el = document.createElement('div');
    el.className = 'hw-all-item';
    el.dataset.rowIndex = String(rowIndex||'');
    el.dataset.sig = sigKey;

    el.innerHTML = `
      <div class="hw-all-left">
        <div class="hw-all-title" style="font-weight:900; font-size:0.95rem;">${title}</div>
        <div class="hw-all-meta text-sm text-sec" style="margin-top:1px;">${date}${teacher}</div>
        ${body ? `<div class="hw-all-body" style="margin-top:3px; white-space:pre-wrap;">${body}</div>` : ``}
      </div>
      <div class="hw-all-actions" style="flex-direction:column; align-items:flex-end; gap:4px;">
        <label class="hw-mini-toggle">
          <input type="checkbox" ${confirmed ? 'checked' : ''} ${rowIndex ? '' : 'disabled'} />
          <span>${escapeHtml(confLabel)}</span>
        </label>
        <button class="icon-btn-mini" type="button" data-hw-edit ${rowIndex ? '' : 'disabled'} title="${state.lang==='de'?'Bearbeiten':'تعديل'}">
          <i class="fa-solid fa-pen"></i>
        </button>
      </div>
    `;

        const chk = el.querySelector('input[type="checkbox"]');
        chk?.addEventListener('change', ()=>{
          if(!rowIndex) return;
          toggleHomeworkConfirmedSilent(rowIndex, chk.checked).then(ok=>{
            if(ok){
              hwAllHomeworkCache.delete(String(ref));
              ensureAllHomeworkLoaded(String(ref));
              schedulePrimeAllHomeworkOptions();
            }
          });
        });

        const editBtn = el.querySelector('button[data-hw-edit]');
        editBtn?.addEventListener('click', (ev)=>{
          ev.stopPropagation();
          if(!rowIndex) return;
          openHomeworkEditModal(String(ref), h, rowIndex);
        });


panel.appendChild(el);
  });
}


function toggleHomeworkConfirmedSilent(rowIndex, confirmed){
  rowIndex = Number(rowIndex || 0);
  if(!rowIndex) return Promise.resolve(false);

  return fetch(WEB_APP_URL, {
    method: 'POST',
    headers: { "Content-Type": "text/plain" },
    body: JSON.stringify({
      action: 'toggleHomeworkConfirmed',
      rowIndex: rowIndex,
      confirmed: !!confirmed,
      teacherName: state.user
    })
  }).then(r=>r.json()).then(res=>{
    if(res && res.ok){
      return true;
    }
    return false;
  }).catch(()=>false);
}

async function bulkConfirmAllHomework(makeConfirmed){
  const statusEl = document.getElementById('hw-all-status');
  const refs = Array.from(hwAllSelectedRefs || []);
  if(refs.length === 0){
    showToast(state.lang==='de' ? 'Bitte mindestens einen Schüler auswählen.' : 'اختر طالباً واحداً على الأقل.');
    return;
  }
  if(statusEl) statusEl.textContent = (state.lang==='de' ? 'Lade Hausaufgaben...' : 'جارٍ تحميل الواجبات...');

  let touched = 0;
  let ok = 0;

  for(const ref of refs){
    let list = hwAllHomeworkCache.get(ref);
    if(!Array.isArray(list)){
      // fetch on demand
      try{
        const res = await fetch(WEB_APP_URL, { method:'POST', body: JSON.stringify({ action:'getStudentHomework', studentRef: ref }) }).then(r=>r.json());
        list = (res && res.ok) ? (res.homework || []) : [];
        hwAllHomeworkCache.set(ref, list);
      }catch(e){
        list = [];
        hwAllHomeworkCache.set(ref, list);
      }
    }

    // toggle only those that differ
    const toToggle = (list||[]).filter(h=>{
      const rowIndex = Number(h.rowIndex||0);
      if(!rowIndex) return false;
      const confirmed = (h.confirmed === true) || (String(h.confirmed || '').trim().toLowerCase() === 'true') || (String(h.confirmed || '').trim() === '1');
      return makeConfirmed ? !confirmed : confirmed;
    });

    for(const h of toToggle){
      touched++;
      const rowIndex = Number(h.rowIndex||0);
      const r = await toggleHomeworkConfirmedSilent(rowIndex, makeConfirmed);
      if(r) ok++;
    }

    // refresh cache for this student if expanded or selected
    hwAllHomeworkCache.delete(ref);
    if(hwAllExpandedRefs.has(ref)) ensureAllHomeworkLoaded(ref);
  }

  if(statusEl){
    statusEl.textContent = (state.lang==='de')
      ? `Fertig: ${ok}/${touched} aktualisiert.`
      : `تم: تحديث ${ok} من ${touched}.`;
  }
  if(touched>0) showToast(state.lang==='de' ? 'Aktualisiert' : 'تم التحديث');
}

function useCurrentFilterForHomework(){
  bulkHwListOverride = Array.isArray(state.filteredStudents) ? state.filteredStudents.slice() : null;
  bulkHwSelectedRefs = new Set((bulkHwListOverride||[]).map(s => String(s.referenz||'').trim()).filter(Boolean));
  const selAll = document.getElementById('hw-bulk-selectall');
  if(selAll) selAll.checked = true;
  renderBulkHomeworkStudents();
  showToast(state.lang === 'de' ? 'Filter übernommen.' : 'تم استخدام الفلتر الحالي.');
}

function toggleBulkHomeworkSelectAll(checked){
  const list = getBulkHomeworkCurrentList();
  const refs = list.map(s => String(s.referenz||'').trim()).filter(Boolean);
  if(checked){
    refs.forEach(r=>bulkHwSelectedRefs.add(r));
  }else{
    refs.forEach(r=>bulkHwSelectedRefs.delete(r));
  }
  renderBulkHomeworkStudents();
}

function getBulkHomeworkCurrentList(){
  // Use the unified global filter (same as Schüler tab)
  const base = Array.isArray(state.filteredStudents) ? state.filteredStudents : (state.students || []);
  const q = (document.getElementById('hw-bulk-search')?.value || '').trim().toLowerCase();

  return (base || []).filter(s=>{
    if(q){
      const hay = `${s.fullName||''} ${s.parentName||''} ${s.phone||''} ${s.referenz||''}`.toLowerCase();
      if(!hay.includes(q)) return false;
    }
    return true;
  });
}


function renderBulkHomeworkStudents(forceFromSelect=false){
  if(forceFromSelect){
    // user explicitly clicked "Schüler anzeigen" => follow selects
    bulkHwListOverride = null;
  }

  const box = document.getElementById('hw-bulk-students');
  const countEl = document.getElementById('hw-bulk-count');
  const selAll = document.getElementById('hw-bulk-selectall');

  if(!box) return;

  const list = getBulkHomeworkCurrentList();

  if(countEl) countEl.textContent = String(list.length);

  // Update select-all state (based on current list)
  if(selAll){
    const refs = list.map(s=>String(s.referenz||'').trim()).filter(Boolean);
    const allSelected = refs.length > 0 && refs.every(r => bulkHwSelectedRefs.has(r));
    selAll.checked = allSelected;
  }

  box.innerHTML = '';
  if(list.length === 0){
    box.innerHTML = `<div class="bulk-empty">${state.lang==='de' ? 'Keine Schüler gefunden.' : 'لا يوجد طلاب.'}</div>`;
    return;
  }

  list.forEach(s=>{
    const ref = String(s.referenz||'').trim();
    const checked = ref && bulkHwSelectedRefs.has(ref);
    const row = document.createElement('div');
    row.className = 'bulk-row';
    row.innerHTML = `
      <div class="bulk-left">
        <input type="checkbox" ${checked ? 'checked' : ''} ${ref ? '' : 'disabled'} />
        <div style="min-width:0;">
          <div class="bulk-name">${escapeHtml(s.fullName || '')}</div>
          <div class="bulk-meta">${escapeHtml(s.group || '')} • ${escapeHtml(s.days || '')}${ref ? '' : ' • (no ID)'}</div>
        </div>
      </div>
      <div class="text-sm text-sec">${escapeHtml(ref)}</div>
    `;
    const cb = row.querySelector('input[type="checkbox"]');
    cb.addEventListener('change', ()=>{
      if(!ref) return;
      if(cb.checked) bulkHwSelectedRefs.add(ref);
      else bulkHwSelectedRefs.delete(ref);
      // keep select-all in sync
      try{ renderBulkHomeworkStudents(); }catch(e){}
    });
    // click row toggles checkbox
    row.addEventListener('click', (ev)=>{
      if(ev.target && (ev.target.tagName || '').toLowerCase() === 'input') return;
      if(!ref) return;
      cb.checked = !cb.checked;
      cb.dispatchEvent(new Event('change'));
    });

    box.appendChild(row);
  });
}


// --- Bulk homework: send ONCE per student, then after 5s sync and retry ONLY missing rows ---
async function __fetchHomeworkMapForRefs(refs){
  try{
    const res = await fetch(WEB_APP_URL, {
      method:'POST',
      headers: { "Content-Type": "text/plain" },
      body: JSON.stringify({ action:'getHomeworkForStudents', studentRefs: refs })
    }).then(r=>r.json());
    if(res && res.ok && res.homeworkByStudent && typeof res.homeworkByStudent === 'object'){
      return res.homeworkByStudent;
    }
  }catch(e){}
  // Fallback: empty map
  const out = {};
  (refs||[]).forEach(r=>{ out[String(r||'').trim()] = []; });
  return out;
}

function __homeworkRowMatchesJob(row, job, dateDMY){
  if(!row || !job) return false;
  const rid = String(row.requestId || row.requestID || '').trim();
  if(rid && job.requestId && rid === job.requestId) return true;

  const sig = String(row.signature || '').trim();
  if(sig && job.signature && sig === job.signature){
    // If date exists, prefer matching same date
    const d = normalizeDateToDMY(row.date || row.timestamp || '');
    if(dateDMY) return d === dateDMY;
    return true;
  }

  // Fallback comparison by fields
  const s = String(row.surah || '').trim();
  const a1 = String(row.ayahStart ?? row.start ?? '').trim();
  const a2 = String(row.ayahEnd ?? row.end ?? '').trim();
  if(s === String(job.surah||'').trim() && a1 === String(job.ayahStart||'').trim() && a2 === String(job.ayahEnd||'').trim()){
    const d = normalizeDateToDMY(row.date || row.timestamp || '');
    if(dateDMY) return d === dateDMY;
    return true;
  }

  return false;
}
async function bulkAssignHomework(){
  if(state.role === 'Student') return;

  const list = getBulkHomeworkCurrentList();
  const selected = list.filter(s => bulkHwSelectedRefs.has(String(s.referenz||'').trim()));

  if(selected.length === 0){
    return showToast(state.lang === 'de' ? 'Bitte mindestens einen Schüler auswählen.' : 'اختر طالباً واحداً على الأقل.');
  }

  const type = getBulkHomeworkType();
  let surah = '';
  let start = '';
  let end   = '';

  if(type === 'text'){
    const txt = (document.getElementById('hw-bulk-free-text')?.value || '').trim();
    if(!txt) return showToast(state.lang === 'de' ? 'Bitte Text eingeben' : 'اكتب نص الواجب');
    surah = 'TEXT|' + txt;
  } else {
    surah = (document.getElementById('hw-bulk-surah')?.value || '').trim();
    start = (document.getElementById('hw-bulk-start')?.value || '').trim();
    end   = (document.getElementById('hw-bulk-end')?.value || '').trim();

    if(!surah) return showToast(state.lang === 'de' ? 'Bitte Sure eingeben' : 'ادخل السورة');
    if(!start || !end) return showToast(state.lang === 'de' ? 'Bitte Vers-Bereich eingeben' : 'ادخل نطاق الآيات');

    surah = 'MEM|' + surah;
  }

  // Progress overlay
  const ov = document.getElementById('hw-bulk-progress');
  const fill = document.getElementById('hw-bulk-progress-fill');
  const txtEl = document.getElementById('hw-bulk-progress-text');
  const titleEl = document.getElementById('hw-bulk-progress-title');
  if(titleEl) titleEl.textContent = (state.lang === 'de') ? 'Sende Hausaufgaben...' : 'جارٍ إرسال الواجب...';
  if(fill) fill.style.width = '0%';
  if(txtEl) txtEl.textContent = `0 / ${selected.length}`;
  if(ov) ov.classList.add('visible');

  const dateLocal = getLocalDMYDate();

  // Build jobs and enqueue ONCE (no immediate retries)
  const batchJobs = [];
  for(let i=0; i<selected.length; i++){
    const st = selected[i];
    const ref = String(st.referenz||'').trim();
    const reqId = (crypto && crypto.randomUUID) ? crypto.randomUUID() : (Date.now() + '_' + ref + '_' + Math.random().toString(16).slice(2));

    const payload = {
      action:'assignHomework',
      requestId: reqId,
      studentRef: ref,
      surah,
      ayahStart: start,
      ayahEnd: end,
      teacherName: state.user,
      date: dateLocal,
      clientTs: Date.now()
    };

    const signature = [String(surah||'').trim(), String(start||'').trim(), String(end||'').trim()].join('|');

    batchJobs.push({
      studentName: st.fullName || '',
      studentRef: ref,
      requestId: reqId,
      signature,
      surah,
      ayahStart: start,
      ayahEnd: end,
      payload
    });

    enqueueSheetWrite(payload, { label: (state.lang==='de'?'Hausaufgabe':'واجب') + ` • ${st.fullName}`, maxAttempts: 1 });

    const done = i+1;
    if(fill) fill.style.width = `${(done/selected.length)*100}%`;
    if(txtEl) txtEl.textContent = `${done} / ${selected.length}`;
    await __sleep(120);
  }

  // Send queued operations (first pass)
  try{ kickSyncQueue(); }catch(e){}
  try{ await waitForSheetWritesComplete({ minDelayMs: 0, maxWaitMs: 90000 }); }catch(e){}

  // IMPORTANT: wait 5 seconds, then sync, then retry only missing rows
  if(titleEl) titleEl.textContent = (state.lang === 'de') ? 'Warte auf Speicherung…' : 'انتظار حفظ البيانات…';
  if(txtEl) txtEl.textContent = (state.lang === 'de') ? 'Bitte warten…' : 'يرجى الانتظار…';
  await __sleep(5000);

  const refs = Array.from(new Set(batchJobs.map(j=>j.studentRef)));
  const map = await __fetchHomeworkMapForRefs(refs);

  const missing = [];
  for(const job of batchJobs){
    const rows = Array.isArray(map[job.studentRef]) ? map[job.studentRef] : [];
    const ok = rows.some(r => __homeworkRowMatchesJob(r, job, dateLocal));
    if(!ok) missing.push(job);
  }

  let retried = 0;
  if(missing.length > 0){
    if(titleEl) titleEl.textContent = (state.lang === 'de') ? 'Erneuter Versuch (nur fehlende)…' : 'إعادة المحاولة (للناقص فقط)…';
    if(fill) fill.style.width = '0%';
    if(txtEl) txtEl.textContent = `0 / ${missing.length}`;

    for(let i=0; i<missing.length; i++){
      const job = missing[i];
      // Retry with SAME requestId (idempotent)
      enqueueSheetWrite(job.payload, { label: (state.lang==='de'?'Hausaufgabe (Retry)':'واجب (إعادة)') + ` • ${job.studentName}`, maxAttempts: 1 });
      retried++;
      const done = i+1;
      if(fill) fill.style.width = `${(done/missing.length)*100}%`;
      if(txtEl) txtEl.textContent = `${done} / ${missing.length}`;
      await __sleep(120);
    }

    try{ kickSyncQueue(); }catch(e){}
    try{ await waitForSheetWritesComplete({ minDelayMs: 0, maxWaitMs: 90000 }); }catch(e){}
  }

  if(ov) ov.classList.remove('visible');

  // Final sync for UI
  try{ await primeAllHomeworkOptionsForVisibleStudents(); }catch(e){}
  try{ renderHomeworkAdminStudents(); }catch(e){}

  // Status message
  const status = document.getElementById('hw-bulk-status');
  if(status){
    const msg = (state.lang==='de')
      ? `Fertig. Erste Runde: ${batchJobs.length}. Fehlend: ${missing.length}. Erneut versucht: ${retried}.`
      : `تم. الجولة الأولى: ${batchJobs.length}. الناقص: ${missing.length}. تمت إعادة المحاولة: ${retried}.`;
    status.textContent = msg;
  }

  showToast(state.lang==='de'
    ? `Hausaufgabe gesendet. Fehlende wurden nach 5s erneut versucht.`
    : `تم إرسال الواجب. تمت إعادة محاولة الناقص بعد 5 ثوانٍ.`);

  // Clear selection + inputs
  bulkHwSelectedRefs = new Set();
  const selAll = document.getElementById('hw-bulk-selectall');
  if(selAll) selAll.checked = false;

  try{
    if(type === 'text'){
      const t = document.getElementById('hw-bulk-free-text'); if(t) t.value = '';
    }else{
      const a = document.getElementById('hw-bulk-surah'); if(a) a.value = '';
      const b = document.getElementById('hw-bulk-start'); if(b) b.value = '';
      const c = document.getElementById('hw-bulk-end'); if(c) c.value = '';
    }
  }catch(e){}

  renderBulkHomeworkStudents();
}



// Teacher: confirm (checked) => counts as memorized/progress

function updateHomeworkConfirmedInCaches(rowIndex, confirmed, confirmedBy, confirmedAt){
  rowIndex = Number(rowIndex||0);
  if(!rowIndex) return;

  function patchList(list){
    if(!Array.isArray(list)) return;
    list.forEach(h=>{
      if(Number(h?.rowIndex||0) === rowIndex){
        h.confirmed = !!confirmed;
        if(confirmedBy !== undefined) h.confirmedBy = confirmedBy;
        if(confirmedAt !== undefined) h.confirmedAt = confirmedAt;
      }
    });
  }

  try{
    // Admin homework cache (Aufgaben tab)
    if(typeof hwAdmHomeworkCache !== 'undefined'){
      for(const [ref, list] of hwAdmHomeworkCache.entries()){
        patchList(list);
      }
    }
  }catch(e){}
  try{
    // "All homework" cache (if used elsewhere)
    if(typeof hwAllHomeworkCache !== 'undefined'){
      for(const [ref, list] of hwAllHomeworkCache.entries()){
        patchList(list);
      }
    }
  }catch(e){}
}

function rerenderHomeworkPanelsAfterConfirm(){
  try{
    // refresh admin list highlight
    if(typeof renderHomeworkAdminStudents === 'function') renderHomeworkAdminStudents();
    // refresh any open panels
    if(typeof hwAdmExpandedRefs !== 'undefined' && typeof hwAdmHomeworkCache !== 'undefined'){
      hwAdmExpandedRefs.forEach(ref=>{
        const cached = hwAdmHomeworkCache.get(ref);
        if(Array.isArray(cached)) renderHomeworkAdminPanel(ref, cached);
      });
    }
  }catch(e){}
  try{
    if(typeof renderAllHomeworkStudents === 'function') renderAllHomeworkStudents();
    if(typeof hwAllExpandedRefs !== 'undefined' && typeof hwAllHomeworkCache !== 'undefined'){
      hwAllExpandedRefs.forEach(ref=>{
        const cached = hwAllHomeworkCache.get(ref);
        if(Array.isArray(cached) && typeof renderAllHomeworkPanel === 'function') renderAllHomeworkPanel(ref, cached);
      });
    }
  }catch(e){}
}

function toggleHomeworkConfirmed(rowIndex, confirmed){
  rowIndex = Number(rowIndex || 0);
  if(!rowIndex) return;

  fetch(WEB_APP_URL, {
    method: 'POST',
    headers: { "Content-Type": "text/plain" },
    body: JSON.stringify({
      action: 'toggleHomeworkConfirmed',
      rowIndex: rowIndex,
      confirmed: !!confirmed,
      teacherName: state.user
    })
  }).then(r=>r.json()).then(res => {
    if(res && res.ok){
      showToast(state.lang === 'de' ? 'Aktualisiert' : 'تم التحديث');

      // Update caches + UI immediately
      updateHomeworkConfirmedInCaches(rowIndex, !!confirmed, res.confirmedBy, res.confirmedAt);
      rerenderHomeworkPanelsAfterConfirm();

      // If user is on student detail view, refresh its history too
      const sRef = state.currentDetailStudent?.referenz;
      if(sRef) loadHomeworkHistory(sRef);
    }else{
      showToast((state.lang === 'de' ? 'Fehler: ' : 'خطأ: ') + (res?.error || ''));
      rerenderHomeworkPanelsAfterConfirm();
    }
  }).catch(() => {
    showToast(state.lang === 'de' ? 'Fehler beim Speichern.' : 'تعذر الحفظ.');
    rerenderHomeworkPanelsAfterConfirm();
  });
}


function loadHomeworkHistory(ref) {
  const box = document.getElementById('hw-history-list');
  if(!box) return;
  box.innerHTML = (state.lang === 'de') ? 'Lade...' : 'جارٍ التحميل...';

  fetch(WEB_APP_URL, {
    method: 'POST',
    body: JSON.stringify({ action: 'getStudentHomework', studentRef: ref })
  })
  .then(r=>r.json()).then(res => {
    box.innerHTML = '';
    if(res && res.ok && Array.isArray(res.homework) && res.homework.length > 0) {
      res.homework.forEach(h => {
        const info = decodeHomeworkSurah(h.surah);
        const date = escapeHtml(normalizeDateToDMY(h.date || ''));
        const teacher = ''; // hidden
        const confirmed = isHomeworkConfirmed(h);
        const rowIndex = Number(h?.rowIndex||0);

        const confBy = (h.confirmedBy ? escapeHtml(h.confirmedBy) : '');
        const confAt = (h.confirmedAt ? escapeHtml(h.confirmedAt) : '');
        const confMeta = confirmed && (confBy || confAt)
          ? `<div style="font-size:0.72rem; margin-top:4px; color:var(--text-sec);">✅ ${state.lang === 'de' ? 'Bestätigt' : 'تم التسميع'}${confBy ? (' • ' + confBy) : ''}${confAt ? (' • ' + confAt) : ''}</div>`
          : '';

        if(info.kind === 'text'){
          const txt = (info.freeText || '').trim();
          const confRow = rowIndex ? `
            <label class="filter-checkbox" style="margin-top:8px; width:100%; justify-content:flex-start;">
              <input type="checkbox" ${confirmed ? 'checked' : ''} onchange="toggleHomeworkConfirmed(${rowIndex}, this.checked)" />
              <span>${state.lang === 'de' ? 'Als erledigt bestätigt' : 'تم تنفيذ الواجب'}</span>
            </label>
            ${confMeta}
          ` : '';

          box.innerHTML += `
            <div class="hw-all-item ${confirmed ? 'hw-confirmed' : 'hw-pending'}" style="border-bottom:1px solid #eee; padding:8px 5px;">
              <b>📝 ${state.lang === 'de' ? 'Freier Text' : 'نص حر'}</b><br>
              ${txt ? `<div class="text-sm" style="white-space:pre-wrap; margin-top:6px;">${escapeHtml(txt)}</div>` : ''}
              <span style="font-size:0.7rem">${date}${teacher}</span>
              ${confRow}
            </div>`;
          return;
        }

        const badge = info.badge
          ? ` <span style="font-size:0.7rem; padding:2px 8px; border-radius:999px; border:1px solid var(--border); background:var(--surface-2);">${escapeHtml(info.badge)}</span>`
          : '';

        const rangeTxt = getAyahRangeText(h);
        const range = rangeTxt
          ? ` <span class="hw-ayah-range ${confirmed ? 'confirmed' : 'pending'}">${escapeHtml(rangeTxt)}</span>`
          : '';

        const confRow = rowIndex ? `
          <label class="filter-checkbox" style="margin-top:8px; width:100%; justify-content:flex-start;">
            <input type="checkbox" ${confirmed ? 'checked' : ''} onchange="toggleHomeworkConfirmed(${rowIndex}, this.checked)" />
            <span>${state.lang === 'de' ? 'Tasmiʿ bestätigt' : 'تأكيد التسميع'}</span>
          </label>
          ${confMeta}
        ` : confMeta;

        box.innerHTML += `
          <div class="hw-all-item ${confirmed ? 'hw-confirmed' : 'hw-pending'}" style="border-bottom:1px solid #eee; padding:8px 5px;">
            <b>${escapeHtml(info.label)}${badge}</b>${range}<br>
            <span style="font-size:0.7rem">${date}${teacher}</span>
            ${confRow}
          </div>`;
      });
    } else {
      box.innerHTML = (state.lang === 'de') ? 'Keine Einträge.' : 'لا توجد عناصر.';
    }
  }).catch(() => {
    box.innerHTML = (state.lang === 'de') ? 'Fehler beim Laden.' : 'تعذر التحميل.';
  });
}

function toggleEvalNoteOnly(){
  const chk = document.getElementById('eval-note-only');
  const on = !!chk?.checked;

  ['eval-hifz','eval-tajweed','eval-behavior'].forEach(id => {
    const el = document.getElementById(id);
    if(!el) return;
    el.disabled = on;
    el.style.opacity = on ? 0.55 : 1;
    if(on) el.value = '';
  });
}

function applyEvalNoteTemplate(text, sendNow){
  const noteEl = document.getElementById('eval-note');
  const chk = document.getElementById('eval-note-only');
  if(noteEl) noteEl.value = text || '';
  if(chk) chk.checked = true;
  toggleEvalNoteOnly();
  if(sendNow) submitEvaluation({ noteOnly: true });
}

function submitEvaluation(opts = {}) {
  const sRef = state.currentDetailStudent?.referenz;
  if(!sRef) return;

  const noteOnly = !!opts.noteOnly || !!document.getElementById('eval-note-only')?.checked;

  let mem = document.getElementById('eval-hifz')?.value || '';
  let taj = document.getElementById('eval-tajweed')?.value || '';
  let beh = document.getElementById('eval-behavior')?.value || '';
  const note = (document.getElementById('eval-note')?.value || '').trim();

  // NOTE ONLY: no ratings required
  if(noteOnly){
    mem = ''; taj = ''; beh = '';
    if(!note){
      showToast(state.lang === 'de' ? 'Bitte Notiz eingeben.' : 'اكتب الملاحظة.');
      return;
    }
  }

  fetch(WEB_APP_URL, {
    method: 'POST', 
    body: JSON.stringify({ 
      action: 'submitEvaluation', 
      studentRef: sRef, 
      memorization: mem, 
      tajweed: taj, 
      behavior: beh, 
      note: note, 
      teacherName: state.user 
    })
  }).then(r=>r.json()).then(res => {
    if(res.ok) { 
      showToast(noteOnly ? (state.lang === 'de' ? 'Notiz gesendet' : 'تم إرسال الملاحظة') 
                        : (state.lang === 'de' ? 'Bewertung gesendet' : 'تم إرسال التقييم')); 
      document.getElementById('eval-note').value = ''; 
      // reset note-only switch after sending
      const chk = document.getElementById('eval-note-only');
      if(chk && noteOnly){ chk.checked = false; toggleEvalNoteOnly(); }
      loadEvalHistory(sRef); 
    } else {
      showToast("Fehler: " + (res.error || ''));
    }
  });
}

function loadEvalHistory(ref) {
  document.getElementById('eval-history-list').innerHTML = "Lade...";
  fetch(WEB_APP_URL, { 
    method: 'POST', 
    body: JSON.stringify({ action: 'getStudentEvaluations', studentRef: ref }) 
  })
  .then(r=>r.json()).then(res => {
    const d = document.getElementById('eval-history-list'); 
    d.innerHTML = '';
    if(res.ok && res.evaluations.length > 0) {
      res.evaluations.forEach(h => {
        const hasRating = !!String((h.memorization || '') + (h.tajweed || '') + (h.behavior || '')).trim();
        const head = hasRating
          ? `<b>${escapeHtml(h.memorization || '—')}</b> | ${escapeHtml(h.tajweed || '—')}`
          : `<b>📝 ${state.lang === 'de' ? 'Notiz' : 'ملاحظة'}</b>`;
        const noteHtml = h.note ? `<div class="text-sm" style="margin-top:6px; font-style:italic;">"${escapeHtml(h.note)}"</div>` : '';
        const meta = `<span style="font-size:0.7rem">${escapeHtml(normalizeDateToDMY(h.date || ''))}</span>`;
        d.innerHTML += `<div style="border-bottom:1px solid #eee; padding:8px 5px;">${head}<br>${meta}${noteHtml}</div>`;
      });
    } else {
      d.innerHTML = "Keine Einträge.";
    }
  });
}


// --- Back button behavior (Android/browser) ---
// Rules:
// 1) If a modal is open -> close it.
// 2) Else if we are in a sub-tab -> go back to main tab.
// 3) Only allow leaving the page when already on the main tab.
let navState = {
  mainTab: null,
  currentTab: null,
  modalStack: [],
  popHandling: false,
  ignoreNextPop: false
};


// --- Back button exit confirmation
function resetNavState(){
  try{
    navState.mainTab = null;
    navState.currentTab = null;
    navState.modalStack = [];
    navState.popHandling = false;
    navState.ignoreNextPop = false;
    navState.exitAllow = false;
    navState.exitUiOpen = false;
  }catch(e){}
}

// --- Back button exit confirmation (iOS-style) ---
navState.exitAllow = false;           // when true, next popstate will actually exit (via double-back)
navState.exitUiOpen = false;

function __iosExitEl(){ return document.getElementById('ios-exit-confirm'); }

function showIosExitConfirm(){
  const el = __iosExitEl();
  if(!el) return;
  if(navState.exitUiOpen) return;
  navState.exitUiOpen = true;
  el.classList.remove('hidden');
  el.setAttribute('aria-hidden', 'false');
  // trigger transition
  requestAnimationFrame(()=> el.classList.add('visible'));
}

function hideIosExitConfirm(){
  const el = __iosExitEl();
  if(!el) return;
  navState.exitUiOpen = false;
  el.classList.remove('visible');
  try{ if(id==='lesson-modal') __syncLessonMemoPlayer(false); }catch(e){}
  el.setAttribute('aria-hidden', 'true');
  setTimeout(()=> el.classList.add('hidden'), 220);
}

function ensureExitGuardState(){
  try{
    if(history.state && history.state.qsNav && history.state.kind === 'exitGuard') return;
    history.pushState({qsNav:true, kind:'exitGuard'}, '');
  }catch(e){}
}

function wireIosExitConfirm(){
  const el = __iosExitEl();
  if(!el) return;

  const btnCancel = document.getElementById('ios-exit-cancel');
  const btnOk = document.getElementById('ios-exit-ok');
  const backdrop = el.querySelector('.ios-backdrop');

  if(btnCancel){
    btnCancel.addEventListener('click', ()=>{
      hideIosExitConfirm();
      ensureExitGuardState();
    });
  }
  if(backdrop){
    backdrop.addEventListener('click', ()=>{
      hideIosExitConfirm();
      ensureExitGuardState();
    });
  }
  if(btnOk){
    btnOk.addEventListener('click', ()=>{
      // Step 1: go back from guard -> main (popstate will fire)
      // Step 2: popstate sees exitAllow and performs the real exit (second back)
      navState.exitAllow = true;
      hideIosExitConfirm();
      try{ history.back(); }catch(e){}
    });
  }
}

function getMainTabId(){
  // IMPORTANT: do not cache across role changes (security: Student must never fall back to 'students')
  const role = String(state.role || '').toLowerCase();
  return (role === 'student') ? 'student-home' : 'students';
}

function getVisibleModalIds(){
  const ids = ['lesson-modal','detail-modal','edit-modal','user-modal','stu-akte-eval-modal','stu-akte-att-modal','alert-modal', 'group-modal'];
  return ids.filter(id => document.getElementById(id)?.classList.contains('visible'));
}

function getTopVisibleModalId(){
  const visible = getVisibleModalIds();
  if(visible.length === 0) return null;

  // Prefer last opened (stack), fallback to last visible
  for(let i = (navState.modalStack || []).length - 1; i >= 0; i--){
    const id = navState.modalStack[i];
    if(visible.includes(id)) return id;
  }
  return visible[visible.length - 1];
}

function openModal(id, opts={}){
  const el = document.getElementById(id);
  if(!el) return;

  el.classList.add('visible');

  // maintain modal stack
  try{
    navState.modalStack = (navState.modalStack || []).filter(x => x !== id);
    navState.modalStack.push(id);
  }catch(e){}

  if(opts.noHistory || navState.popHandling) return;

  try{
    history.pushState({qsNav:true, kind:'modal', id:id, tab:(navState.currentTab || getMainTabId())}, '');
  }catch(e){}
}


function hideModalOnly(id, opts={}){
  const el = document.getElementById(id);
  if(!el) return;
  el.classList.remove('visible');
  try{ if(id==='lesson-modal') __syncLessonMemoPlayer(false); }catch(e){}

  // Keep modal stack clean
  try { navState.modalStack = (navState.modalStack || []).filter(x => x !== id); } catch(e) {}

  if(opts.fromPop || navState.popHandling) return;

  try{
    const st = history.state;
    if(st && st.qsNav && st.kind === 'modal' && st.id === id){
      navState.ignoreNextPop = true;
      history.back();
    }
  }catch(e){}
}

window.addEventListener('popstate', () => {
  // If the user isn't logged in yet, don't intercept.
  const appRoot = document.getElementById('qs-app-root');
  const appVisible = appRoot && !appRoot.classList.contains('hidden');
  if(!appVisible) return;

  // Ignore programmatic back (e.g., when user closes a modal via X and we call history.back()).
  if(navState.ignoreNextPop){
    navState.ignoreNextPop = false;
    return;
  }

  navState.popHandling = true;
  try{
    const modalId = getTopVisibleModalId();
    if(modalId){
      closeModal(modalId, {fromPop:true});
      return;
    }

    // Koran overlays: close drawer / audio sheet first on Back
    if(document.body.classList.contains('koran-mode')){
      const dr = document.getElementById('koranDrawer');
      const drOv = document.getElementById('koranDrawerOverlay');
      const adv = document.getElementById('koranAudioAdvanced');
      const sheetBackdrop = document.getElementById('qcAudioSheetBackdrop');

      const drawerOpen = dr && !dr.classList.contains('hidden');
      const sheetOpen = adv && adv.classList.contains('open');

      if(sheetOpen){
        try{
          if(sheetBackdrop) sheetBackdrop.hidden = true;
          adv.classList.remove('open');
          adv.setAttribute('aria-hidden','true');
          navState.modalStack = (navState.modalStack || []).filter(x => x !== 'qcAudioSheet');
        }catch(e){}
        ensureExitGuardState();
        return;
      }

      if(drawerOpen){
        try{
          if(drOv){ drOv.classList.add('hidden'); drOv.setAttribute('aria-hidden','true'); }
          dr.classList.add('hidden'); dr.setAttribute('aria-hidden','true');
          navState.modalStack = (navState.modalStack || []).filter(x => x !== 'koranDrawer');
        }catch(e){}
        ensureExitGuardState();
        return;
      }
    }

    const mainTab = getMainTabId();
    if(navState.currentTab && navState.currentTab !== mainTab){
      switchTab(mainTab, {fromPop:true});
      ensureExitGuardState();
      return;
    }

    // We are already on the main tab -> allow leaving the page/app.
  
    // Instead of leaving immediately, show an iOS-style confirmation.
    // If user confirmed exit, perform a second back to actually leave the page/app.
    if(navState.exitAllow){
      navState.exitAllow = false;
      // perform the real exit (second back)
      setTimeout(()=>{ try{ history.back(); }catch(e){} }, 0);
      return;
    }
    showIosExitConfirm();
    // keep a guard state on top so the page doesn't close while the dialog is open
    ensureExitGuardState();
    return;
} finally {
    navState.popHandling = false;
  }
});

function dismissAllModalsNoHistory(){
  try{
    const visible = document.querySelectorAll('.modal-overlay.visible');
    visible.forEach(el => {
      const id = el.id || '';
      el.classList.remove('visible');
  try{ if(id==='lesson-modal') __syncLessonMemoPlayer(false); }catch(e){}
      try { navState.modalStack = (navState.modalStack || []).filter(x => x !== id); } catch(e) {}
      // clean up special modal resources
      if(id === 'lesson-modal'){
        const vm = (() => { try{ const m = document.getElementById('lesson-modal'); return m ? (m.dataset.viewMode || '') : ''; }catch(e){ return ''; } })();
        if(vm === 'memorize'){
          try{ __syncLessonMemoPlayer(false); }catch(e){}
        }else{
          try{ stopRangePlayback(); }catch(e){}
          try{ hideFloatingAudio(); }catch(e){}
          try{ clearLessonFab(); }catch(e){}
        }
      }
    });
  }catch(e){}
}

function switchTab(tabId, opts={}) {

  // Back-button navigation state
  if(!opts || typeof opts !== 'object') opts = {};
  const roleLower = String(state.role || '').toLowerCase();

  // SECURITY: Student must never navigate to staff/admin tabs (even via Back/History).
  if(roleLower === 'student'){
    const allowed = ['student-home','student-homework','student-memorize','student-rating','student-parent','comm'];
    if(!allowed.includes(tabId)) tabId = 'student-home';
  }

  
  // Admin: Aufgaben tab is disabled in Admin mode
  if(roleLower === 'admin' && tabId === 'homework-admin'){
    tabId = 'students';
  }

const mainTab = getMainTabId();
  navState.currentTab = tabId;

  // Ensure modals from previous view do not cover the new tab
  if(!opts.keepModals) dismissAllModalsNoHistory();
const tabs = ['students', 'homework-admin', 'comm', 'stats', 'docs', 'users',
                'student-home','student-homework','student-memorize','student-rating','student-parent'];
  const navs = ['students','homework-admin','comm','stats','docs','users',
                'stu-home','stu-hw','stu-mem','stu-rate','stu-parent'];

  tabs.forEach(tid => {
    const el = document.getElementById('tab-'+tid);
    if(el) el.classList.add('hidden');
  });

  navs.forEach(nid => {
    const nav = document.getElementById('nav-'+nid);
    if(nav) nav.classList.remove('active');
  });

  const tabEl = document.getElementById('tab-'+tabId);
  if(tabEl) tabEl.classList.remove('hidden');

  const navEl = (document.getElementById('nav-'+tabId) || ({
    'student-home': document.getElementById('nav-stu-home'),
    'student-homework': document.getElementById('nav-stu-hw'),
    'student-memorize': document.getElementById('nav-stu-mem'),
    'student-rating': document.getElementById('nav-stu-rate'),
    'student-parent': document.getElementById('nav-stu-parent'),
  }[tabId]));
  
  if(navEl) navEl.classList.add('active');

  // Koran tab: hide header & enable immersive reading
  document.body.classList.toggle('koran-mode', tabId === 'student-memorize');
  try{ updateKoranBottomOffset(); }catch(e){}


  if(tabId === 'stats') renderStatistics();
  if(tabId === 'users' && state.role === 'Admin') { try{ switchAdminBranch(state.adminBranch || 'users'); }catch(e){ renderUsersList(); } }
  if(tabId === 'docs') renderDocuments();
  if(tabId === 'homework-admin') {
    try{ initHomeworkAdminUI(); }catch(e){}
    try{ renderHomeworkAdminStudents(); }catch(e){}

    // 1) Fast: fetch statuses (teacher-confirm for color + parent-seen for eye icon)
    hwAdmPrimeToken++;
    const _tok = hwAdmPrimeToken;
    try{
      Promise.all([
        refreshHwTeacherConfirmStatus(true),
        refreshHwParentSeenStatus(true)
      ]).then(()=>{
        if(_tok !== hwAdmPrimeToken) return;
        try{ renderHomeworkAdminStudents(); }catch(e){}
      });
      // Also queue a debounced refresh (covers cases where filters/search update fast)
      try{ hwAdminQueueStatusRefresh(true); }catch(e){}
    }catch(e){}
    // 2) Slow background preload disabled (we only need latest status for colors/icons)
    //    Full homework list will load only when you expand a student.
}
  if(tabId === 'student-home') { try{ initStudentHomeAbsentUI(); }catch(e){} loadStudentHome(); }
  if(tabId === 'student-homework') { clearStudentBadgeForTab(tabId); loadStudentHomework(); }
  if(tabId === 'student-rating') { clearStudentBadgeForTab(tabId); loadStudentEvaluations(); }
  if(tabId === 'student-memorize') { try{ initKoranTab(); }catch(e){} }
  if(tabId === 'student-parent') loadParentAbsentState();
  if(tabId === 'comm') { 
    initCommUI(); 
    renderMessages(); 
    // Ensure teachers list for students (and when using student recipients)
    try{
      const rl = String(state.role||'').toLowerCase();
      if(rl === 'student'){ loadTeachersForMessagingStudent(); }
    }catch(e){}
    try{ loadMessages(); }catch(e){}
  }
  // Sync browser history so "Back" behaves like: modal close -> back to main tab -> then allow exit
  if(!opts.fromPop && !navState.popHandling && !opts.noHistory){
    try{
      if(tabId === mainTab){
        history.replaceState({qsNav:true, kind:'main', tab:tabId}, '');
      } else {
        history.pushState({qsNav:true, kind:'tab', tab:tabId}, '');
      }
    }catch(e){}
  }

  // Keep an extra guard state so browser 'Back' shows exit confirmation instead of closing immediately
  if(!opts.noHistory && tabId === getMainTabId()) { try{ ensureExitGuardState(); }catch(e){} }
}

function closeModal(id, opts={}) { 
  const el = document.getElementById(id);
  if(el) el.classList.remove('visible');

  // keep modal stack clean
  try { navState.modalStack = (navState.modalStack || []).filter(x => x !== id); } catch(e) {}

  if(id === 'lesson-modal'){
    const vm = (() => {
      try{
        const m = document.getElementById('lesson-modal');
        return m ? (m.dataset.viewMode || '') : '';
      }catch(e){ return ''; }
    })();

    // In memorization (Hausaufgaben) mode: do NOT stop the audio when closing the overlay
    if(vm === 'memorize'){
      try{ __syncLessonMemoPlayer(false); }catch(e){}
    }else{
      try{ stopRangePlayback(); }catch(e){}
      try{ hideFloatingAudio(); }catch(e){}
      clearLessonFab();
      try{ hideLessonImmersiveBar(true); }catch(e){}
    }
  }

  // If user closed the modal manually (X/button), keep history in sync by going back one step.
  // IMPORTANT: do NOT treat this programmatic back as a "user back" (so we don't jump tabs).
  if(opts && opts.fromPop) return;
  if(navState && navState.popHandling) return;
  if(opts && opts.noHistory) return;

  try{
    const st = history.state;
    if(st && st.qsNav && st.kind === 'modal' && st.id === id){
      navState.ignoreNextPop = true;
      history.back();
    }
  }catch(e){}
}

function showToast(msg) { 
  const t = document.getElementById('toast'); 
  t.innerText = msg; 
  t.classList.add('show'); 
  setTimeout(() => t.classList.remove('show'), 3000); 
}

function renderStatistics() {
  const totalNonWaitlist = state.students.filter(s => String(s.warteliste || '').trim() === '').length;
  if (document.getElementById('stat-total')) document.getElementById('stat-total').innerText = totalNonWaitlist;
  const todayDate = new Date().toLocaleDateString('de-DE', {day:'2-digit', month:'2-digit', year:'numeric'});
  const groupStats = {};
  
  state.filteredStudents.forEach(s => {
    if (!s.group) return;
    if (!groupStats[s.group]) groupStats[s.group] = { 
      totalStudents: 0, 
      absentCount: 0, 
      absentNames: [], 
      lateCount: 0, 
      lateNames: [], 
      presentCount: 0 
    };
    groupStats[s.group].totalStudents++;
  });
  
  let totalAbsentToday = 0; 
  let totalLateToday = 0; 
  let totalPresentToday = 0;
  
  state.filteredStudents.forEach(s => {
    const a = state.attendance.find(att => att.fullName === s.fullName && att.date === todayDate);
    const g = s.group;
    if (a && (a.status === 'غياب' || a.status === 'Abwesend')) {
      totalAbsentToday++;
      if (g && groupStats[g]) { 
        groupStats[g].absentCount++; 
        groupStats[g].absentNames.push({ name: s.fullName, row: s.rowIndex });
      }
    } else {
      // present includes "late"
      totalPresentToday++;

      if (a && (a.status === 'تأخير' || a.status === 'Verspätet')) {
        totalLateToday++;
        if (g && groupStats[g]) { 
          groupStats[g].lateCount++; 
          groupStats[g].lateNames.push({ name: s.fullName, row: s.rowIndex });
        }
      }

      if (g && groupStats[g]) groupStats[g].presentCount++;
    }
  });
  
  if (document.getElementById('stat-absent-today')) {
    document.getElementById('stat-absent-today').innerText = totalAbsentToday;
  }
  
  if (document.getElementById('stat-present-today')) {
    document.getElementById('stat-present-today').innerText = totalPresentToday;
  }

  if (document.getElementById('stat-late-today')) {
    document.getElementById('stat-late-today').innerText = totalLateToday;
  }
  
  const box = document.getElementById('stats-groups'); 
  box.innerHTML = '';
  
  Object.keys(groupStats).sort().forEach(g => {
    const st = groupStats[g];
    let html = `
      <div class="card flex-col" style="margin-top: 1rem;">
        <div style="display:flex; justify-content:space-between; width:100%; border-bottom: 1px solid var(--border); padding-bottom: 8px;">
          <span class="font-bold">${g}</span><span class="text-sec">${st.totalStudents} (${t('expected')})</span>
        </div>
        <div style="display:flex; justify-content:space-between; width:100%; margin-top: 10px;">
          <div class="text-sec">${t('presentCount')}</div><div class="font-bold" style="color:var(--success);">${st.presentCount}</div>
        </div>
        <div style="display:flex; justify-content:space-between; width:100%; margin-top: 10px;">
          <div class="text-sec">${t('absentToday')}</div><div class="font-bold" style="color:var(--danger);">${st.absentCount}</div>
        </div>
        <div style="display:flex; justify-content:space-between; width:100%; margin-top: 10px;">
          <div class="text-sec">${t('lateToday')}</div><div class="font-bold" style="color:var(--warning);">${st.lateCount}</div>
        </div>`;
    
    if (st.absentNames.length > 0) {
      html += `
        <div style="width:100%; margin-top: 15px; padding-top: 10px; border-top: 1px solid var(--border);">
          <div class="text-sm font-bold" style="color:var(--danger); margin-bottom: 5px;">${t('btnAbsent')} (${st.absentCount})</div>
          <ul style="list-style: none; padding: 0; margin: 0; font-size: 0.9rem;">
            ${st.absentNames.map(obj => `<li onclick="openStudentDetail(${obj.row})" class="clickable-name" style="margin-bottom: 3px; color:var(--danger);">${obj.name}</li>`).join('')}
          </ul>
        </div>`;
    }
    
    if (st.lateNames.length > 0) {
      html += `
        <div style="width:100%; margin-top: 15px; padding-top: 10px; border-top: 1px solid var(--border);">
          <div class="text-sm font-bold" style="color:var(--warning); margin-bottom: 5px;">${t('btnLate')} (${st.lateCount})</div>
          <ul style="list-style: none; padding: 0; margin: 0; font-size: 0.9rem;">
            ${st.lateNames.map(obj => `<li onclick="openStudentDetail(${obj.row})" style="margin-bottom: 3px; color:var(--warning);">${obj.name}</li>`).join('')}
          </ul>
        </div>`;
    }

    html += `</div>`;
    box.innerHTML += html;
  });
}

function renderDocuments() {
  const container = document.getElementById('docs-list');
  container.innerHTML = '';
  const searchInput = document.getElementById('doc-search-input');
  const searchVal = searchInput ? searchInput.value.toLowerCase() : '';
  const filteredDocs = state.documents.filter(doc => doc.name && doc.name.toLowerCase().includes(searchVal));

  if (filteredDocs.length === 0) { 
    container.innerHTML = '<div class="text-sec" style="text-align:center; margin-top:20px;">Keine Dokumente gefunden</div>'; 
    return; 
  }

  filteredDocs.forEach(doc => {
    let directLink = doc.link;
    if (directLink && directLink.includes('docs.google.com') && directLink.includes('/d/')) {
      directLink = directLink.replace(/\/edit.*$|\/view.*$/, '/export?format=pdf');
    }
    
    let visibilityToggle = '';
    if (state.role === 'Admin') {
      const isChecked = doc.visibleToTeacher ? 'checked' : '';
      visibilityToggle = `
        <div style="margin-top:10px; border-top:1px solid var(--border); padding-top:5px;">
          <label class="checkbox-item" style="border:none; padding:0;">
            <input type="checkbox" ${isChecked} onchange="toggleDocVisibility(${doc.rowIndex}, this.checked)">
            <span>${t('visibleToTeacher')}</span>
          </label>
        </div>`;
    }
    
    const el = document.createElement('div'); 
    el.className = 'card flex-col'; 
    el.style.alignItems = 'stretch';
    
    el.innerHTML = `
      <div style="display:flex; align-items:center; gap:10px;">
        <div class="card-avatar" style="background:var(--surface-2); color:var(--primary);">
          <i class="fa-solid fa-file-pdf"></i>
        </div>
        <div class="card-info">
          <div class="font-bold" style="color: var(--text);">${doc.name}</div>
          <div class="text-sm text-sec">PDF</div>
        </div>
        <div class="doc-actions">
          <button class="doc-btn" onclick="openInGhostWindow('${directLink}')">
            <i class="fa-solid fa-download"></i>
          </button>
        </div>
      </div>
      ${visibilityToggle}
    `;
    
    container.appendChild(el);
  });
}

function openInGhostWindow(url) {
  var newWindow = window.open('', '_blank');
  if (newWindow) {
    newWindow.document.write('<p style="text-align:center; margin-top:50px; font-family:sans-serif;">Dokument wird vorbereitet...</p>');
    setTimeout(function() { newWindow.location.href = url; }, 100); 
  } else { 
    window.open(url, '_blank'); 
  }
}

function renderUsersList() {
  const container = document.getElementById('users-list-container');
  if (!container) return;

  container.innerHTML = '';

  const byRole = {};
  (state.allUsers || []).forEach(u => {
    const role = (u && u.role) ? String(u.role) : '—';
    (byRole[role] ||= []).push(u);
  });

  const preferredOrder = ['Schüler', 'Lehrer', 'Admin', 'Eltern'];
  const roles = [
    ...preferredOrder.filter(r => byRole[r]?.length),
    ...Object.keys(byRole).filter(r => !preferredOrder.includes(r)).sort((a,b)=>a.localeCompare(b))
  ];

  // default: open first group on first render
  if (!state.adminUserGroupsOpen) {
    state.adminUserGroupsOpen = {};
    if (roles[0]) state.adminUserGroupsOpen[roles[0]] = true;
  }

  roles.forEach(role => {
    const users = byRole[role] || [];
    const groupCard = document.createElement('div');
    groupCard.className = 'card user-group-card';

    const bodyId = 'users-group-body-' + safeGroupKey(role);
    const isOpen = !!state.adminUserGroupsOpen?.[role];

    groupCard.innerHTML = `
      <div class="user-group-header" data-role="${encodeURIComponent(role)}" data-body="${bodyId}" onclick="toggleUserGroup(this)">
        <div class="user-group-title">
          <div class="font-bold">${getUserRoleGroupLabel(role)}</div>
          <div class="text-sm text-sec">${users.length} Benutzer</div>
        </div>
        <i class="fa-solid fa-chevron-down user-group-chevron ${isOpen ? 'open' : ''}"></i>
      </div>
      <div class="user-group-body ${isOpen ? '' : 'hidden'}" id="${bodyId}"></div>
    `;

    container.appendChild(groupCard);

    const body = groupCard.querySelector('#' + CSS.escape(bodyId));
    users.forEach(user => {
      const row = document.createElement('div');
      row.className = 'user-row';
      row.innerHTML = `
        <div style="flex:1; min-width:0;">
          <div class="font-bold" style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${user.userName || ''}</div>
          <div class="text-sm text-sec">${user.role || ''} - PIN: ****</div>
        </div>
        <div style="display:flex; gap:8px; flex-shrink:0;">
          <button class="user-action-btn" title="${t('edit') || 'Bearbeiten'}" onclick='openEditUser(${JSON.stringify(user)})'>
            <i class="fa-solid fa-pen-to-square"></i>
          </button>
          <button class="user-action-btn" title="${t('delete') || 'Löschen'}" style="color:var(--danger);" onclick="deleteUser(${user.rowIndex})">
            <i class="fa-solid fa-trash"></i>
          </button>
        </div>
      `;
      body.appendChild(row);
    });
  });
}

function toggleUserGroup(el) {
  if (!el) return;
  const role = decodeURIComponent(el.dataset.role || '');
  const bodyId = el.dataset.body;
  const body = document.getElementById(bodyId);
  if (!body) return;

  state.adminUserGroupsOpen ||= {};
  const next = !(state.adminUserGroupsOpen[role]);
  state.adminUserGroupsOpen[role] = next;

  body.classList.toggle('hidden', !next);
  const chevron = el.querySelector('.user-group-chevron');
  if (chevron) chevron.classList.toggle('open', next);
}

function safeGroupKey(role) {
  try {
    return btoa(unescape(encodeURIComponent(role))).replace(/=+/g, '').replace(/[^a-zA-Z0-9]/g,'_');
  } catch (e) {
    return String(role || '').replace(/[^a-zA-Z0-9]+/g, '_');
  }
}

function getUserRoleGroupLabel(role) {
  const map = {
    'Schüler': 'Schüler / طلاب',
    'Lehrer': 'Lehrer / مدرس',
    'Admin': 'Admin / مُسير',
    'Eltern': 'Eltern / وليّ أمر'
  };
  return map[role] || role;
}


function switchAdminBranch(branch){
  state.adminBranch = branch || 'users';

  const map = {users:'admin-branch-users', waitlist:'admin-branch-waitlist', groups:'admin-branch-groups'};
  Object.values(map).forEach(id => document.getElementById(id)?.classList.add('hidden'));
  const activeId = map[state.adminBranch] || map.users;
  document.getElementById(activeId)?.classList.remove('hidden');

  ['users','waitlist','groups'].forEach(b=>{
    const btn = document.getElementById('btn-branch-'+b);
    if(btn) btn.classList.toggle('active', b === state.adminBranch);
  });

  const fab = document.getElementById('fab-add-user');
  if(fab) fab.classList.toggle('hidden', state.adminBranch !== 'users');

  // Re-render branch contents
  if(state.adminBranch === 'users') renderUsersList();
  if(state.adminBranch === 'waitlist') renderWaitlistList();
  if(state.adminBranch === 'groups') renderGroupsCards();
}

function renderWaitlistList(){
  const container = document.getElementById('waitlist-list-container');
  if(!container) return;

  container.innerHTML = '';
  const list = Array.isArray(state.filteredWaitlist) ? state.filteredWaitlist : [];

  const hint = document.getElementById('lbl-waitlist-hint');
  if(hint){
    const baseHint = i18n[state.lang]?.waitlistHint || '';
    hint.innerText = baseHint ? (baseHint + ` (${list.length})`) : `(${list.length})`;
  }

  if(list.length === 0){
    container.innerHTML = `<div class="text-sm text-sec" style="text-align:center; padding:18px;">${t('emptyWaitlist')}</div>`;
    return;
  }

  list.forEach(s => {
    const el = document.createElement('div');
    el.className = 'card';

    const avatar = s.fotoUrl ? `<img src="${s.fotoUrl}">` : ((s.firstName || '?')[0]);
    const note = String(s.warteliste || '').trim();

    el.innerHTML = `
      <div class="card-avatar" onclick="openStudentDetail(${s.rowIndex})">${avatar}</div>
      <div class="card-info" onclick="openStudentDetail(${s.rowIndex})">
        <div class="font-bold">${s.fullName} <span style="font-size:0.7rem; color:var(--primary);">[${s.referenz}]</span></div>
        <div class="text-sm text-sec">${note || '—'}</div>
      </div>
      <div style="display:flex; align-items:center; justify-content:flex-end;">
        <i class="fa-solid fa-chevron-right" style="color:var(--text-sec);"></i>
      </div>
    `;
    container.appendChild(el);
  });
}

function renderGroupsCards(){
  const container = document.getElementById('groups-cards-container');
  if(!container) return;
  container.innerHTML = '';

  const hint = document.getElementById('lbl-groups-hint');
  if(hint) hint.innerText = i18n[state.lang]?.groupsHint || '';

  const DAYS = ["Montag","Dienstag","Mittwoch","Donnerstag","Freitag","Samstag","Sonntag"];
  const selectedDays = (state.filter && Array.isArray(state.filter.days)) ? state.filter.days : [];
  const dayUniverse = (selectedDays && selectedDays.length) ? selectedDays : DAYS;

  const base = Array.isArray(state.filteredStudents) ? state.filteredStudents : [];
  const baseNoWait = base.filter(s => !String(s.warteliste || '').trim());

  // key = day||group -> count
  const map = new Map();
  for(const s of baseNoWait){
    const group = String(s.group || '').trim();
    if(!group) continue;

    for(const d of dayUniverse){
      if(dayMatches(String(s.days || ''), d)){
        const key = d + "||" + group;
        map.set(key, (map.get(key) || 0) + 1);
      }
    }
  }

  // Hide groups with 0 students (map already does that)
  const items = Array.from(map.entries()).map(([key, count]) => {
    const parts = key.split("||");
    return { day: parts[0], group: parts[1], count };
  }).sort((a,b)=>{
    const da = DAYS.indexOf(a.day), db = DAYS.indexOf(b.day);
    if(da === db) return a.group.localeCompare(b.group, 'de');
    return da - db;
  });

  if(items.length === 0){
    container.innerHTML = `<div class="text-sm text-sec" style="text-align:center; padding:18px;">${t('emptyGroups')}</div>`;
    return;
  }

  for(const it of items){
    const cap = getGroupCap(it.day, it.group);
    const isFull = it.count >= cap;
    const card = document.createElement('div');
    card.className = `group-card ${isFull ? 'full' : 'ok'}`;
    card.setAttribute('role','button');
    card.setAttribute('tabindex','0');

    const dayLabel = (state.lang === 'ar') ? (DAY_DE_TO_AR[it.day] || it.day) : it.day;

    const meta = getGroupMeta(it.day, it.group) || {};
    const teacherName = String(meta.teacher || '').trim() || '—';
    const tFrom = normalizeTimeHHMM_(meta.timeFrom);
    const tTo = normalizeTimeHHMM_(meta.timeTo);
    const timeStr = (tFrom || tTo) ? `${tFrom || ''}${(tFrom && tTo) ? '–' : ''}${tTo || ''}` : '—';

    card.innerHTML = `
      <div class="group-card-title">${it.group} • ${dayLabel}</div>
      <div class="group-card-extra">
        <div class="line"><i class="fa-solid fa-chalkboard-user"></i> ${escapeHtml(teacherName)}</div>
        <div class="line"><i class="fa-solid fa-clock"></i> ${escapeHtml(timeStr)}</div>
      </div>
      <div class="group-card-meta">
        <span class="badge-pill"><i class="fa-solid fa-users"></i> ${it.count}/${cap}</span>
        <span class="badge-pill"><i class="fa-solid ${isFull ? 'fa-xmark' : 'fa-check'}"></i> ${isFull ? (state.lang==='de'?'Voll':'ممتلئ') : (state.lang==='de'?'Frei':'فيه أماكن')}</span>
      </div>
    `;

    const open = ()=>openGroupDetails(it.day, it.group);
    card.addEventListener('click', open);
    card.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); open(); } });

    container.appendChild(card);
  }
}


// ===== Gruppenverwaltung: Details + Meta (Lehrer/Zeiten/Kapazität) =====
function groupMetaKey(day, group){
  return String(day || '').trim() + "||" + String(group || '').trim();
}

function getGroupMeta(day, group){
  try{
    return (state.groupMeta || {})[groupMetaKey(day, group)] || null;
  }catch(e){
    return null;
  }
}

function getGroupCap(day, group){
  const meta = getGroupMeta(day, group);
  const cap = parseInt(meta && meta.maxStudents, 10);
  return (Number.isFinite(cap) && cap > 0) ? cap : 20;
}

function loadGroupMetaAll(){
  const role = String(state.role || '');
  if(role !== 'Admin' && role !== 'Lehrer' && role !== 'Teacher') return Promise.resolve({ok:true, items:[]});

  return fetch(WEB_APP_URL, {
    method: 'POST',
    headers: { "Content-Type": "text/plain" },
    body: JSON.stringify({ action: 'getGroupMetaAll', userName: state.user })
  })
  .then(r=>r.json())
  .then(res=>{
    if(res && res.ok){
      state.groupMeta = {};
      (res.items || []).forEach(it=>{
        if(!it) return;
        const d = String(it.day || '').trim();
        const g = String(it.group || '').trim();
        if(!d || !g) return;
        state.groupMeta[groupMetaKey(d,g)] = it;
      });

      // refresh UI if needed
      try{ if(state.adminBranch === 'groups') renderGroupsCards(); }catch(e){}
      try{ if(document.getElementById('group-modal')?.classList.contains('visible') && state.currentGroupDetail){ renderGroupDetailsView(); } }catch(e){}
    }
    return res;
  })
  .catch(err => ({ ok:false, error:String(err) }));
}

function openGroupDetails(day, group){
  state.currentGroupDetail = { day, group };
  state.groupDetailEdit = false;

  // set texts (i18n)
  try{
    document.getElementById('btn-group-edit-toggle').innerText = t('groupEditEnable');
    document.getElementById('lbl-group-teacher').innerText = t('groupTeacher');
    document.getElementById('lbl-group-max').innerText = t('groupMax');
    document.getElementById('lbl-group-from').innerText = t('groupTimeFrom');
    document.getElementById('lbl-group-to').innerText = t('groupTimeTo');
    document.getElementById('lbl-group-students').innerText = t('groupStudentsIn');
    document.getElementById('btn-group-save').innerText = t('save');
    document.getElementById('btn-group-cancel').innerText = t('cancel');
  }catch(e){}

  renderGroupDetailsView();
  toggleGroupEdit(false);
  openModal('group-modal');
}

function renderGroupDetailsView(){
  const gd = state.currentGroupDetail;
  if(!gd) return;

  const day = gd.day, group = gd.group;
  const dayLabel = (state.lang === 'ar') ? (DAY_DE_TO_AR[day] || day) : day;

  // Students shown in details follow the SAME header filter (as requested).
  const list = (state.filteredStudents || []).filter(s =>
    String(s.group || '').trim() === String(group || '').trim() &&
    dayMatches(String(s.days || ''), String(day || ''))
  );

  const meta = getGroupMeta(day, group) || {};
  const cap = getGroupCap(day, group);
  const count = list.length;
  const isFull = count >= cap;

  const titleEl = document.getElementById('group-det-title');
  const subEl = document.getElementById('group-det-sub');
  const badgesEl = document.getElementById('group-det-badges');
  const infoEl = document.getElementById('group-det-info');
  const studsEl = document.getElementById('group-det-students');

  if(titleEl) titleEl.innerText = `${group} • ${dayLabel}`;
  if(subEl) subEl.innerText = (state.lang === 'de')
    ? `Status: ${isFull ? 'Voll' : 'Frei'}`
    : `الحالة: ${isFull ? 'ممتلئ' : 'فيه أماكن'}`;

  if(badgesEl){
    badgesEl.innerHTML = `
      <span class="badge-pill"><i class="fa-solid fa-users"></i> ${count}/${cap}</span>
      <span class="badge-pill"><i class="fa-solid ${isFull ? 'fa-circle-xmark' : 'fa-circle-check'}"></i> ${isFull ? (state.lang==='de'?'Voll':'ممتلئ') : (state.lang==='de'?'Frei':'فيه أماكن')}</span>
    `;
  }

  const teacher = String(meta.teacher || '').trim() || '—';
  const timeFrom = normalizeTimeHHMM_(meta.timeFrom);
  const timeTo = normalizeTimeHHMM_(meta.timeTo);
  const timeStr = (timeFrom || timeTo) ? `${timeFrom || '—'} – ${timeTo || '—'}` : '—';

  if(infoEl){
    infoEl.innerHTML = `
      <div class="group-info-row"><div class="k">${t('groupTeacher')}</div><div class="v">${escapeHtml(teacher)}</div></div>
      <div class="group-info-row"><div class="k">${state.lang==='de'?'Zeit':'الوقت'}</div><div class="v">${escapeHtml(timeStr)}</div></div>
      <div class="group-info-row"><div class="k">${t('groupMax')}</div><div class="v">${cap}</div></div>
    `;
  }

  if(studsEl){
    studsEl.innerHTML = '';
    if(list.length === 0){
      studsEl.innerHTML = `<div class="text-sm text-sec" style="text-align:center; padding:10px;">${state.lang==='de'?'Keine Schüler (Filter).':'لا يوجد طلاب حسب الفلتر.'}</div>`;
    } else {
      list.forEach(s=>{
        const row = document.createElement('div');
        row.className = 'group-student-row';
        const sub = [s.parentName, s.phone].filter(Boolean).join(' • ') || (state.lang==='de'?'Keine Kontaktdaten':'لا توجد بيانات تواصل');
        row.innerHTML = `
          <div>
            <div class="name">${escapeHtml(s.fullName || (s.firstName+' '+s.lastName))}</div>
            <div class="sub">${escapeHtml(sub)}</div>
          </div>
          <i class="fa-solid fa-chevron-right" style="opacity:0.6;"></i>
        `;
        row.addEventListener('click', ()=>{
          closeModal('group-modal');
          openStudentDetail(s.rowIndex);
        });
        studsEl.appendChild(row);
      });
    }
  }

  // Update edit form defaults if edit panel is open
  try{
    if(state.groupDetailEdit){
      populateGroupEditForm(meta, cap);
    }
  }catch(e){}
}

function populateGroupEditForm(meta, capFallback){
  const gd = state.currentGroupDetail;
  if(!gd) return;

  const teacherSel = document.getElementById('inp-group-teacher');
  if(teacherSel){
    // build dropdown from teachers list
    const current = String((meta && meta.teacher) || '').trim();
    teacherSel.innerHTML = '';
    const opt0 = document.createElement('option');
    opt0.value = '';
    opt0.textContent = (state.lang === 'de') ? '—' : '—';
    teacherSel.appendChild(opt0);

    const names = Array.from(new Set((state.teachers || []).map(x=>String(x||'').trim()).filter(Boolean))).sort((a,b)=>a.localeCompare(b,'de'));
    names.forEach(n=>{
      const o = document.createElement('option');
      o.value = n;
      o.textContent = n;
      teacherSel.appendChild(o);
    });
    teacherSel.value = current;
  }

  const inpMax = document.getElementById('inp-group-max');
  if(inpMax) inpMax.value = String(parseInt((meta && meta.maxStudents) || capFallback || 20, 10) || 20);

  const inpFrom = document.getElementById('inp-group-from');
  if(inpFrom) inpFrom.value = normalizeTimeHHMM_((meta && meta.timeFrom) || '');

  const inpTo = document.getElementById('inp-group-to');
  if(inpTo) inpTo.value = normalizeTimeHHMM_((meta && meta.timeTo) || '');
}

function toggleGroupEdit(force){
  if(typeof force === 'boolean'){
    state.groupDetailEdit = force;
  } else {
    state.groupDetailEdit = !state.groupDetailEdit;
  }

  const panel = document.getElementById('group-edit-panel');
  const btn = document.getElementById('btn-group-edit-toggle');
  if(panel) panel.classList.toggle('hidden', !state.groupDetailEdit);

  if(btn){
    btn.innerText = state.groupDetailEdit ? t('groupEditDisable') : t('groupEditEnable');
  }

  if(state.groupDetailEdit){
    const gd = state.currentGroupDetail;
    if(!gd) return;
    const meta = getGroupMeta(gd.day, gd.group) || {};
    populateGroupEditForm(meta, getGroupCap(gd.day, gd.group));
  }
}

function saveGroupMeta(){
  const gd = state.currentGroupDetail;
  if(!gd) return;

  const day = gd.day, group = gd.group;

  const teacher = String(document.getElementById('inp-group-teacher')?.value || '').trim();
  const timeFrom = String(document.getElementById('inp-group-from')?.value || '').trim();
  const timeTo = String(document.getElementById('inp-group-to')?.value || '').trim();
  const maxStudentsRaw = String(document.getElementById('inp-group-max')?.value || '').trim();

  let maxStudents = parseInt(maxStudentsRaw, 10);
  if(!Number.isFinite(maxStudents) || maxStudents <= 0) maxStudents = 20;

  showToast(state.lang==='de' ? 'Speichern...' : 'جارٍ الحفظ...');

  fetch(WEB_APP_URL, {
    method: 'POST',
    headers: { "Content-Type": "text/plain" },
    body: JSON.stringify({
      action: 'setGroupMeta',
      userName: state.user,
      day, group,
      teacher,
      timeFrom,
      timeTo,
      maxStudents
    })
  })
  .then(r=>r.json())
  .then(res=>{
    if(res && res.ok){
      state.groupMeta = state.groupMeta || {};
      state.groupMeta[groupMetaKey(day, group)] = {
        day, group, teacher, timeFrom, timeTo,
        maxStudents: String(maxStudents),
        updatedAt: res.updatedAt || '',
        updatedBy: res.updatedBy || state.user || ''
      };
      showToast(t('saved'));
      toggleGroupEdit(false);
      renderGroupDetailsView();
      try{ renderGroupsCards(); }catch(e){}
    } else {
      showToast((state.lang==='de'?'Fehler: ':'خطأ: ') + (res && res.error ? res.error : '—'));
    }
  })
  .catch(err=>{
    showToast((state.lang==='de'?'Fehler: ':'خطأ: ') + String(err));
  });
}


function openAddStudent() {
  editingStudent = null; 
  document.getElementById('edit-title').innerText = "Neuer Schüler";
  document.getElementById('last-id-display').innerText = `Letzte ID im System: ${state.lastId}`;
  document.getElementById('btn-delete-stud').classList.add('hidden'); 
  renderForm({}); 
  openModal('edit-modal');
}

function openEditStudent(s) {
  if(!s) s = state.currentDetailStudent;
  editingStudent = s; 
  document.getElementById('edit-title').innerText = "Schüler bearbeiten";
  document.getElementById('last-id-display').innerText = "";
  document.getElementById('btn-delete-stud').classList.remove('hidden'); 
  renderForm(s); 
  closeModal('detail-modal'); 
  openModal('edit-modal');
}

function renderForm(vals) {
  const f = document.getElementById('edit-form'); 
  f.innerHTML = '';
  
  if (!editingStudent) {
    f.innerHTML += `
      <div class="form-group">
        <label class="form-label" style="color:var(--primary);">Manuelle ID (optional - leer lassen für automatisch)</label>
        <input type="text" class="form-input" id="inp-manualId" placeholder="z.B.: Dark 0500">
      </div>
    `;
  }
  
  const fields = [
    {k:'referenz', l:'l_referenz'}, 
    {k:'lastName', l:'l_lastName'}, 
    {k:'firstName', l:'l_firstName'}, 
    {k:'geburtsdatum', l:'l_geburtsdatum'}, 
    {k:'parentName', l:'l_parentName'}, 
    {k:'phone', l:'l_phone'}, 
    {k:'email', l:'l_email'},
    {k:'days', l:'l_days'}, 
    {k:'group', l:'l_group'}, 
    {k:'warteliste', l:'l_warteliste'}, 
    {k:'iban', l:'l_iban'}, 
    {k:'betrag', l:'l_betrag'},
    {k:'alter', l:'l_alter'}, 
    {k:'gender', l:'l_gender'}, 
    {k:'infos', l:'l_infos'}, 
    {k:'fotoUrl', l:'l_fotoUrl'},
    {k:'abgemeldet', l:'l_abgemeldet'}, 
    {k:'kontrolleBank', l:'l_kontrolleBank'}, 
    {k:'finanzMark', l:'l_finanzMark'}
  ];
  
  fields.forEach(field => {
    if(field.k === 'abgemeldet' && !editingStudent) return;
    if((field.k === 'kontrolleBank' || field.k === 'finanzMark') && state.role !== 'Admin') return; 
    
    let extraAttr = ""; 
    if (field.k === 'alter') extraAttr = "readonly style='background:var(--surface-2); opacity:0.7;'";
    
    f.innerHTML += `
      <div class="form-group">
        <label class="form-label">${t(field.l)}</label>
        <input type="text" class="form-input" id="inp-${field.k}" value="${vals[field.k] || ''}" ${extraAttr}>
      </div>
    `;
  });
  
  const birthInput = document.getElementById('inp-geburtsdatum');
  const ageInput = document.getElementById('inp-alter');
  if(birthInput && ageInput) {
    birthInput.addEventListener('input', function() { 
      ageInput.value = calculateAge(this.value); 
    });
    
    if(!ageInput.value && birthInput.value) { 
      ageInput.value = calculateAge(birthInput.value); 
    }
  }
}

function calculateAge(dateString) {
  if (!dateString) return "";
  const parts = dateString.split('.'); 
  if (parts.length !== 3) return "";
  
  const birth = new Date(parseInt(parts[2], 10), parseInt(parts[1], 10) - 1, parseInt(parts[0], 10));
  const today = new Date();
  let age = today.getFullYear() - birth.getFullYear();
  const m = today.getMonth() - birth.getMonth();
  
  if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) { 
    age--; 
  }
  
  return age >= 0 ? age : "";
}

function saveStudent() {
  const payload = { userName: state.user };
  const fields = ['lastName','firstName','geburtsdatum','parentName','phone','email','days','group','warteliste','iban','betrag','alter','gender','infos','fotoUrl'];
  
  fields.forEach(k => payload[k] = document.getElementById('inp-'+k).value);
  
  if(editingStudent) {
    payload.action = 'updateStudent'; 
    payload.rowIndex = editingStudent.rowIndex;
    payload.abgemeldet = document.getElementById('inp-abgemeldet').value;
    payload.referenz = document.getElementById('inp-referenz').value;
    
    if(state.role === 'Admin') {
      payload.kontrolleBank = document.getElementById('inp-kontrolleBank').value;
      payload.finanzMark = document.getElementById('inp-finanzMark').value;
    }
  } else {
    payload.action = 'addStudent'; 
    payload.vereinsmitglied = ""; 
    payload.mitgliedSchule = ""; 
    payload.anmeldung = "";
    payload.manualId = document.getElementById('inp-manualId').value;
  }
  
  showToast("Speichern...");
  
  fetch(WEB_APP_URL, { 
    method: 'POST', 
    headers: { "Content-Type": "text/plain" }, 
    body: JSON.stringify(payload) 
  })
  .then(r=>r.json()).then(res => {
    if(res.ok) { 
      showToast(t('saved')); 
      closeModal('edit-modal'); 
      refreshData(); 
    } else {
      showToast("Fehler: " + res.error);
    }
  });
}

function deleteStudent() {
  if(!editingStudent) return;
  
  if(confirm(t('confirmDelete'))) {
    showToast("Lösche...");
    
    fetch(WEB_APP_URL, { 
      method: 'POST', 
      headers: { "Content-Type": "text/plain" }, 
      body: JSON.stringify({ 
        action: 'deleteStudent', 
        rowIndex: editingStudent.rowIndex, 
        userName: state.user 
      }) 
    })
  .then(r=>r.json()).then(res => {
      if(res.ok) { 
        showToast("Gelöscht"); 
        closeModal('edit-modal'); 
        refreshData(); 
      } else { 
        showToast("Fehler: " + res.error); 
      }
    });
  }
}

function printSingleStudent(s) {
  document.getElementById('print-container').innerHTML = `
    <div style="text-align:center; border:2px solid black; padding:20px; color:black; background:white;">
      <h1>${t('title')}</h1>
      ${s.fotoUrl ? `<img src="${s.fotoUrl}" style="width:100px; margin:10px;">` : ''}
      <h2>${s.fullName} <span style="font-size:0.8em;">[${s.referenz}]</span></h2>
      <h3>${s.group}</h3>
      <p>${s.days}</p>
      <hr>
      <p>Eltern: ${s.parentName || '-'}</p>
    </div>
  `;
  
  window.print();
}

function saveStudentNote() {
  const txt = document.getElementById('new-student-note').value;
  const sName = document.getElementById('notes-list').dataset.studentName;
  
  if (!txt || !sName) return;
  
  fetch(WEB_APP_URL, { 
    method: 'POST', 
    body: JSON.stringify({ 
      action: 'saveStudentInfo', 
      studentName: sName, 
      message: txt, 
      author: state.user 
    }) 
  })
  .then(r=>r.json()).then(res => { 
    if(res.ok) { 
      showToast("Gespeichert"); 
      document.getElementById('new-student-note').value = ''; 
      closeModal('detail-modal'); 
      refreshData(); 
    } 
  });
}

function sendTeacherMessage() {
  let type = document.getElementById('msg-dest-type')?.value || 'Lehrer';
  if(type !== 'Admin' && type !== 'Lehrer' && type !== 'Student') type = 'Lehrer';
  // Students can only message Lehrer/Admin
  try{ if(String(state.role||'').toLowerCase()==='student' && type==='Student') type='Lehrer'; }catch(e){}

  const txt = (document.getElementById('msg-body')?.value || '').trim();
  let recipients = [];

  if (type === 'Admin') {
    recipients = ['Admin'];
  } else if(type === 'Student') {
    // Selected student references (Studentref). We store and send Studentref to the sheet.
    try{
      recipients = Array.from(state.commUi?.selStudents || []).map(x => String(x || '').trim()).filter(Boolean);
    }catch(e){
      recipients = [];
    }
  } else {
    document.querySelectorAll('#teacher-checklist input:checked').forEach(cb => recipients.push(cb.value));
  }


  if(!txt){
    showToast(state.lang === 'de' ? 'Bitte Nachricht eingeben.' : 'اكتب الرسالة.');
    return;
  }
  if(recipients.length === 0){
    showToast(state.lang === 'de' ? 'Empfänger wählen.' : 'اختر المستلمين.');
    return;
  }

  fetch(WEB_APP_URL, {
    method: 'POST',
    body: JSON.stringify({
      action: 'addTeacherMessage',
      senderName: state.user,
      recipientType: type,
      recipientName: recipients,
      messageText: txt
    })
  })
  .then(r=>r.json()).then(res => {
    if(res.ok) {
      const body = document.getElementById('msg-body');
      if(body) body.value = '';
      try{ if(state.commUi?.selStudents) state.commUi.selStudents.clear(); }catch(e){}
      toggleComposePanel(false);
      showToast(state.lang === 'de' ? 'Gesendet!' : 'تم الإرسال!');
      loadMessages();
    } else {
      showToast(state.lang === 'de' ? 'Senden fehlgeschlagen.' : 'فشل الإرسال.');
    }
  }).catch(()=>{
    showToast(state.lang === 'de' ? 'Netzwerkfehler.' : 'خطأ في الاتصال.');
  });
}

function msgLastKey(){ return `qs_last_msg_sig:${state.user || 'unknown'}`; }

function loadMessages() {
  return fetch(WEB_APP_URL, { 
    method: 'POST', 
    body: JSON.stringify({ action: 'getMessages', userName: state.user, role: state.role, studentRef: (state.studentData && state.studentData.referenz) ? state.studentData.referenz : '' }) 
  })
  .then(r => r.json()).then(res => { 
    if(res.ok) { 
      const prevSig = (()=>{ try{ return localStorage.getItem(msgLastKey()) || ''; }catch(e){ return ''; } })();

      state.messages = res.messages || []; 
      renderMessages(); 
      updateMsgBadge();

            // Update message high-watermark so background polling doesn't re-notify old messages
      try{
        const maxRow = (state.messages||[]).reduce((m,x)=>Math.max(m, (parseInt(x?.rowIndex||0,10)||0)), 0);
        if(maxRow) setMsgAfterRow(maxRow);
      }catch(e){}
// Simple "push-like" browser notification on NEW unread message
      const unread = state.messages.filter(m => isUnreadInbound(m));
      const latest = unread.reduce((a,b)=>{
        const ai = parseInt(a?.rowIndex ?? -1,10);
        const bi = parseInt(b?.rowIndex ?? -1,10);
        return (bi > ai) ? b : a;
      }, null);

      const sig = latest ? String(latest.rowIndex ?? '') : '';
      if(sig && sig !== prevSig){
        try{ localStorage.setItem(msgLastKey(), sig); }catch(e){}
        if(isMessageNotificationsEnabled() && ('Notification' in window) && Notification.permission === 'granted'){
          const title = (state.lang === 'de' ? 'Neue Nachricht' : 'رسالة جديدة');
          const body  = (latest.text ? String(latest.text).slice(0,120) : (state.lang === 'de' ? 'Neue Nachricht erhalten.' : 'تم استلام رسالة جديدة.'));
          // Show only if user is not already on messages tab OR tab is hidden
          const isCommVisible = !document.getElementById('tab-comm')?.classList.contains('hidden');
          if(document.hidden || !isCommVisible){
            try{ new Notification(title, { body }); }catch(e){}
          }
        }
      } else if(!sig && !prevSig){
        // keep empty
      } else if(!sig){
        try{ localStorage.setItem(msgLastKey(), ''); }catch(e){}
      }
    }
  });
}


function ensureCommUi(){
  if(!state.commUi){
    state.commUi = { box: 'inbox', filter: 'all', search: '', open: null, composeOpen: false, selStudents: new Set() };
  }
  if(!state.commUi.box) state.commUi.box = 'inbox';
  // normalize legacy shapes
  if(!(state.commUi.selStudents instanceof Set)){
    try{ state.commUi.selStudents = new Set(state.commUi.selStudents || []); }catch(e){ state.commUi.selStudents = new Set(); }
  }
}

function commStrings(){
  const de = state.lang === 'de';
  return {
    title: de ? 'Nachrichten' : 'الرسائل',
    inbox: de ? 'Eingang' : 'الوارد',
    sent: de ? 'Gesendet' : 'المرسلة',
    all: de ? 'Alle' : 'الكل',
    unread: de ? 'Ungelesen' : 'غير مقروء',
    search: de ? 'Suchen…' : 'بحث…',
    empty: de ? 'Keine Nachrichten.' : 'لا توجد رسائل.',
    copy: de ? 'Kopieren' : 'نسخ',
    close: de ? 'Schließen' : 'إغلاق',
    markRead: de ? 'Als gelesen markieren' : 'تعيين كمقروء',
    copied: de ? 'Kopiert.' : 'تم النسخ.'
  };
}

function syncCommHeaderText(){
  ensureCommUi();
  const S = commStrings();

  const title = document.getElementById('comm-inbox-title');
  if(title) title.textContent = S.title;

  const search = document.getElementById('msg-search');
  if(search) search.placeholder = S.search;

  // chips + unread count
  const unreadCount = (state.messages || []).filter(m => m && isUnreadInbound(m)).length;
  const allBtn = document.getElementById('msg-chip-all');
  const unBtn = document.getElementById('msg-chip-unread');
  if(allBtn) allBtn.textContent = S.all;
  if(unBtn) unBtn.textContent = unreadCount ? `${S.unread} (${unreadCount})` : S.unread;

  const inboxBtn = document.getElementById('msg-chip-inbox');
  const sentBtn  = document.getElementById('msg-chip-sent');
  if(inboxBtn) inboxBtn.textContent = S.inbox;
  if(sentBtn)  sentBtn.textContent  = S.sent;

  const boxMode = state.commUi.box || 'inbox';
  if(inboxBtn) inboxBtn.classList.toggle('active', boxMode !== 'sent');
  if(sentBtn)  sentBtn.classList.toggle('active', boxMode === 'sent');

  const filterWrap = document.getElementById('msg-filter-chips');
  if(filterWrap) filterWrap.classList.toggle('hidden', boxMode === 'sent');

  const filter = state.commUi.filter || 'all';
  if(allBtn) allBtn.classList.toggle('active', filter !== 'unread');
  if(unBtn) unBtn.classList.toggle('active', filter === 'unread');

  const clear = document.getElementById('msg-search-clear');
  if(clear) clear.classList.toggle('hidden', !(state.commUi.search || '').trim());

  // translate recipient type text (keep values stable)
  const dest = document.getElementById('msg-dest-type');
  if(dest){
    const optTeacher = dest.querySelector('option[value="Lehrer"]');
    const optAdmin = dest.querySelector('option[value="Admin"]');
if(optTeacher) optTeacher.textContent = (state.lang === 'de') ? 'Lehrer' : 'المعلمون';
    if(optAdmin) optAdmin.textContent = (state.lang === 'de') ? 'Admin' : 'الإدارة';
}

  // compose placeholders
  const body = document.getElementById('msg-body');
  if(body){
    body.placeholder = (state.lang === 'de') ? 'Nachricht schreiben…' : 'اكتب رسالتك…';
  }
}

function initCommUI(){
  ensureCommUi();
  const panel = document.getElementById('compose-panel');
  const overlay = document.getElementById('compose-overlay');
  if(panel) panel.classList.toggle('hidden', !state.commUi.composeOpen);
  if(overlay) overlay.classList.toggle('hidden', !state.commUi.composeOpen);
  document.body.classList.toggle('compose-open', !!state.commUi.composeOpen);
  syncCommHeaderText();
}
function setMsgFilter(mode){
  ensureCommUi();
  state.commUi.filter = (mode === 'unread') ? 'unread' : 'all';
  state.commUi.open = null;
  syncCommHeaderText();
  renderMessages();
}

function setMsgBox(mode){
  ensureCommUi();
  const next = (mode === 'sent') ? 'sent' : 'inbox';
  if(state.commUi.box === next) return;
  state.commUi.box = next;
  state.commUi.open = null;
  // Sent box does not have unread filter
  if(next === 'sent') state.commUi.filter = 'all';
  syncCommHeaderText();
  renderMessages();
}

function onMsgSearch(val){
  ensureCommUi();
  state.commUi.search = String(val || '');
  state.commUi.open = null;
  syncCommHeaderText();
  renderMessages();
}

function clearMsgSearch(){
  const input = document.getElementById('msg-search');
  if(input) input.value = '';
  onMsgSearch('');
}

function updateVisualViewportVars(){
  try{
    const vv = window.visualViewport;
    if(!vv) return;
    document.documentElement.style.setProperty('--vvh', `${vv.height}px`);
  }catch(e){}
}

function toggleComposePanel(force){
  ensureCommUi();
  if(typeof force === 'boolean') state.commUi.composeOpen = force;
  else state.commUi.composeOpen = !state.commUi.composeOpen;

  const panel = document.getElementById('compose-panel');
  const overlay = document.getElementById('compose-overlay');
  if(panel) panel.classList.toggle('hidden', !state.commUi.composeOpen);
  if(overlay) overlay.classList.toggle('hidden', !state.commUi.composeOpen);

  document.body.classList.toggle('compose-open', !!state.commUi.composeOpen);

  if(state.commUi.composeOpen){
    updateVisualViewportVars();
    try{ syncMsgRecipientOptions(); }catch(e){}
    try{ toggleMsgRecipient(); }catch(e){}
    setTimeout(()=>{ 
      const el = document.getElementById('msg-body');
      try{ el?.scrollIntoView?.({block:'start', behavior:'smooth'}); }catch(e){}
      try{ el?.focus?.(); }catch(e){}
    }, 0);
  }
}

try{
  if(window.visualViewport){
    window.visualViewport.addEventListener('resize', updateVisualViewportVars);
    window.visualViewport.addEventListener('scroll', updateVisualViewportVars);
  }
  window.addEventListener('resize', updateVisualViewportVars);
}catch(e){}
function toggleMsgOpen(rowIndex){
  ensureCommUi();
  const next = (rowIndex === null || rowIndex === undefined) ? null : String(rowIndex);
  state.commUi.open = (state.commUi.open === next) ? null : next;

  if(state.commUi.open){
    const msg = (state.messages || []).find(m => String(m.rowIndex) === state.commUi.open);
    if(msg && msg.status === 'neu' && isInboundToMe(msg) && !isFromMeMessage(msg)){
      markRead(msg.rowIndex);
      return;
    }
  }
  renderMessages();
}

function fallbackCopyText(text, onDone){
  try{
    const ta = document.createElement('textarea');
    ta.value = text;
    ta.setAttribute('readonly', '');
    ta.style.position = 'fixed';
    ta.style.top = '-1000px';
    ta.style.opacity = '0';
    document.body.appendChild(ta);
    ta.focus();
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    if(typeof onDone === 'function') onDone();
  }catch(e){}
}

function copyMsg(rowIndex){
  const S = commStrings();
  const msg = (state.messages || []).find(m => String(m.rowIndex) === String(rowIndex));
  const txt = msg ? String(msg.messageText || '') : '';
  if(!txt) return;

  const done = ()=>showToast(S.copied);

  if(navigator.clipboard && navigator.clipboard.writeText){
    navigator.clipboard.writeText(txt).then(done).catch(()=>fallbackCopyText(txt, done));
  }else{
    fallbackCopyText(txt, done);
  }
}

function resolveStudentNameByRef(ref){
  const r = String(ref || '').trim();
  if(!r) return '';
  const list = Array.isArray(state.students) ? state.students : [];
  const s = list.find(x => String(x?.referenz ?? x?.studentRef ?? x?.ref ?? '').trim() === r);
  return s ? String(s.fullName || '').trim() : '';
}

function msgRecipientDisplay(msg){
  const de = (state.lang === 'de');
  const type = String(msg?.recipientType || '').trim();
  const nameRaw = String(msg?.recipientName || '').trim();

  if(type === 'Admin') return de ? 'Admin' : 'الإدارة';
  if(type === 'Lehrer') return nameRaw || (de ? 'Lehrer' : 'المعلمون');
  if(type === 'Student'){
    const friendly = resolveStudentNameByRef(nameRaw);
    return friendly || nameRaw || (de ? 'Schüler' : 'طالب');
  }
  return nameRaw || (de ? 'Empfänger' : 'مستلم');
}

function renderMessages() {
  ensureCommUi();
  syncCommHeaderText();

  const box = document.getElementById('messages-list');
  if(!box) return;

  const raw = Array.isArray(state.messages) ? state.messages.slice() : [];

  // newest first (rowIndex is usually increasing)
  raw.sort((a,b)=>{
    const ai = parseInt(a?.rowIndex, 10);
    const bi = parseInt(b?.rowIndex, 10);
    if(!isNaN(ai) && !isNaN(bi)) return bi - ai;
    return 0;
  });

  const boxMode = state.commUi.box || 'inbox';
  const filter = state.commUi.filter || 'all';
  const q = (state.commUi.search || '').trim().toLowerCase();

  let msgs = raw.filter(m=>{
    if(!m) return false;
    if(boxMode === 'sent') return isFromMeMessage(m);
    // inbox
    return isInboundToMe(m) && !isFromMeMessage(m);
  });

  msgs = msgs.filter(m=>{
    if(boxMode !== 'sent'){
      if(filter === 'unread' && !isUnreadInbound(m)) return false;
    }
    if(q){
      const hay = `${m.senderName||''} ${m.recipientType||''} ${m.recipientName||''} ${m.timestamp||''} ${m.messageText||''}`.toLowerCase();
      if(!hay.includes(q)) return false;
    }
    return true;
  });

  if(msgs.length === 0){
    const S = commStrings();
    const empty = (boxMode === 'sent')
      ? ((state.lang === 'de') ? 'Keine gesendeten Nachrichten.' : 'لا توجد رسائل مرسلة.')
      : S.empty;
    box.innerHTML = `<div class="msg-empty">${escapeHtml(empty)}</div>`;
    return;
  }

  const openId = state.commUi.open ? String(state.commUi.open) : null;
  const de = state.lang === 'de';

  let html = '';
  msgs.forEach(msg=>{
    const id = String(msg.rowIndex || '');
    const isOpen = openId && openId === id;

    const rawText = String(msg.messageText || '');
    const snippet = rawText.replace(/\s+/g,' ').trim().slice(0, 140);
    const snippetHtml = escapeHtml(snippet);

    const isUnread = (boxMode !== 'sent' && isUnreadInbound(msg));

    const title = (boxMode === 'sent')
      ? `${de ? 'An: ' : 'إلى: '}${escapeHtml(msgRecipientDisplay(msg))}`
      : escapeHtml(msg.senderName || (de ? 'Unbekannt' : 'غير معروف'));

    const time = escapeHtml(msg.timestamp || '');

    html += `
      <div class="msg-item ${isUnread ? 'unread' : ''}">
        <div class="msg-top" onclick="toggleMsgOpen('${id}')">
          <div class="msg-left">
            <div style="display:flex; align-items:baseline; justify-content:space-between; gap:10px;">
              <div class="msg-sender">${title}</div>
              <div class="msg-time">${time}</div>
            </div>
            <div class="msg-snippet">${snippetHtml || '&nbsp;'}</div>
          </div>
          ${isUnread ? '<div class="msg-dot" title="new"></div>' : ''}
        </div>

        ${isOpen ? `
          <div class="msg-open" onclick="event.stopPropagation()">
            <div class="msg-full">${linkify(rawText)}</div>
            <div class="msg-actions">
              ${isUnread ? `<button class="btn btn-sec" type="button" onclick="markRead('${id}'); event.stopPropagation();">${de ? 'Als gelesen markieren' : 'تعيين كمقروء'}</button>` : ''}
              <button class="btn btn-sec" type="button" onclick="copyMsg('${id}'); event.stopPropagation();">${de ? 'Kopieren' : 'نسخ'}</button>
              <button class="btn btn-sec" type="button" onclick="toggleMsgOpen(null); event.stopPropagation();">${de ? 'Schließen' : 'إغلاق'}</button>
            </div>
          </div>
        ` : ''}
      </div>
    `;
  });

  box.innerHTML = html;
}


function markRead(idx) {
  // 1) Optimistic UI: mark as read immediately so the badge/notification disappears
  const msg = state.messages.find(m => String(m.rowIndex) === String(idx));
  if(msg) msg.status = 'read';
  renderMessages();
  updateMsgBadge();

  // 2) Background save (queue + retry)
  enqueueSheetWrite({ action: 'markMessageRead', rowIndex: idx }, { label: (state.lang === 'de') ? 'Nachricht gelesen' : 'تأكيد قراءة رسالة' });
  showToast(state.lang === 'de' ? 'Bestätigt (wird gespeichert...)' : 'تم التأكيد (جارٍ الحفظ...)');

  kickSyncQueue();
}


function updateMsgBadge() {
  const msgs = Array.isArray(state.messages) ? state.messages : [];
  const c = msgs.filter(m => m && isUnreadInbound(m)).length;

  const setBadge = (el) => {
    if(!el) return;
    if(c > 0){
      el.innerText = c;
      el.classList.remove('hidden');
    } else {
      el.classList.add('hidden');
    }
  };

  setBadge(document.getElementById('badge-msg-nav'));       // staff bottom nav
  setBadge(document.getElementById('badge-msg-nav-stu'));   // student bottom nav (kept hidden)
  setBadge(document.getElementById('badge-msg-hdr-stu'));   // student header icon
}



function populateTeacherSelect() {
  const w = document.getElementById('teacher-checklist'); 
  w.innerHTML = '';
  
  state.teachers.forEach((tName, i) => { 
    w.innerHTML += `
      <div class="checkbox-item">
        <label for="chk-t-${i}">${tName}</label>
        <input type="checkbox" id="chk-t-${i}" value="${tName}">
      </div>
    `; 
  });
}


function loadTeachersForMessagingStudent(){
  // minimal fetch: we only keep the teachers list for the messaging tab
  return fetch(WEB_APP_URL, { 
    method: 'POST', 
    body: JSON.stringify({ action: 'getData', userName: state.user, role: state.role })
  })
  .then(r => r.json())
  .then(res => {
    if(res && res.ok){
      state.teachers = res.teachers || [];
      try{ populateTeacherSelect(); }catch(e){}
    }
  })
  .catch(()=>{});
}

function getMsgStudentSourceList(){
  // Use the same global student filter used in the Students tab
  const list = (state.filteredStudents && state.filteredStudents.length) ? state.filteredStudents : (state.students || []);
  return Array.isArray(list) ? list : [];
}

function onMsgStudentCheckboxChange(key, checked){
  ensureCommUi();
  const k = String(key);
  if(checked) state.commUi.selStudents.add(k);
  else state.commUi.selStudents.delete(k);
  updateMsgStudentSelectionUI();
}

function updateMsgStudentSelectionUI(){
  ensureCommUi();
  const list = getMsgStudentSourceList();
  const keys = list.map((s,i) => String(s?.referenz ?? s?.studentRef ?? s?.ref ?? s?.rowIndex ?? i));
  const selectedVisible = keys.filter(k => state.commUi.selStudents.has(k)).length;

  const countEl = document.getElementById('msg-stu-count');
  if(countEl) countEl.innerText = String(selectedVisible);

  const selAll = document.getElementById('msg-stu-selectall');
  if(selAll){
    selAll.checked = (keys.length > 0 && selectedVisible === keys.length);
    selAll.indeterminate = (selectedVisible > 0 && selectedVisible < keys.length);
  }
}

function populateMsgStudentSelect(){
  ensureCommUi();
  const w = document.getElementById('student-checklist');
  if(!w) return;

  const list = getMsgStudentSourceList();
  w.innerHTML = '';

  const hint = document.getElementById('msg-stu-filter-hint');
  if(hint){
    const n = list.length;
    hint.innerText = (state.lang === 'de')
      ? `Empfängerliste folgt dem aktuellen Schüler-Filter: ${n} Schüler`
      : `قائمة المستلمين تتبع فلتر الطلبة الحالي: ${n} طالب`;
  }

  list.forEach((s, i) => {
    const key = String(s?.referenz ?? s?.studentRef ?? s?.ref ?? s?.rowIndex ?? i);
    const name = String(s?.fullName ?? '');
    const sub = [s?.group, s?.day].filter(Boolean).join(' • ');
    const id = `chk-msg-stu-${key}`;
    const checked = state.commUi.selStudents.has(key);

    w.innerHTML += `
      <div class="checkbox-item">
        <label for="${escapeHtml(id)}">
          <div style="font-weight:800;">${escapeHtml(name)}</div>
          ${sub ? `<div class="text-sec" style="font-size:0.82rem; margin-top:2px;">${escapeHtml(sub)}</div>` : ``}
        </label>
        <input type="checkbox" id="${escapeHtml(id)}" value="${escapeHtml(key)}" ${checked ? 'checked' : ''} onchange="onMsgStudentCheckboxChange('${escapeHtml(key)}', this.checked)">
      </div>
    `;
  });

  updateMsgStudentSelectionUI();
}

function toggleMsgStudentSelectAll(on){
  ensureCommUi();
  const list = getMsgStudentSourceList();
  list.forEach((s,i) => {
    const key = String(s?.referenz ?? s?.studentRef ?? s?.ref ?? s?.rowIndex ?? i);
    if(on) state.commUi.selStudents.add(key);
    else state.commUi.selStudents.delete(key);
  });
  document.querySelectorAll('#student-checklist input[type="checkbox"]').forEach(cb => cb.checked = !!on);
  updateMsgStudentSelectionUI();
}

function syncMsgRecipientOptions(){
  const sel = document.getElementById('msg-dest-type');
  if(!sel) return;
  const rl = String(state.role||'').toLowerCase();
  const optStudent = Array.from(sel.options || []).find(o => String(o.value) === 'Student');
  if(optStudent){
    // Students should not see "Schüler" as a recipient type
    optStudent.hidden = (rl === 'student');
    optStudent.disabled = (rl === 'student');
  }
  // If currently selected option is hidden, fall back
  if(sel.value === 'Student' && (rl === 'student')){
    sel.value = 'Lehrer';
  }
}

function toggleMsgRecipient() { 
  let t = document.getElementById('msg-dest-type')?.value || 'Lehrer';
  if(t !== 'Admin' && t !== 'Lehrer' && t !== 'Student') t = 'Lehrer'; 

  // In student mode: never allow selecting Student recipients
  try{
    const rl = String(state.role||'').toLowerCase();
    if(rl === 'student' && t === 'Student') t = 'Lehrer';
  }catch(e){}

  const wrap = document.getElementById('msg-dest-wrapper');
  if(wrap) wrap.classList.toggle('hidden', t === 'Admin');

  const teacherBox = document.getElementById('teacher-select-container');
  if(teacherBox) teacherBox.classList.toggle('hidden', t !== 'Lehrer');

  const studentBox = document.getElementById('student-select-container');
  if(studentBox) studentBox.classList.toggle('hidden', t !== 'Student');

  if(t === 'Student'){
    try{ populateMsgStudentSelect(); }catch(e){}
  }
}


// ================================
// Background Messages Delivery (Polling + Sound + Browser Notifications)
// Works even when the Messages tab is NOT open (as long as the web app page is open).
// ================================
function msgAfterRowKey(){
  const u = state.user || 'unknown';
  const r = String(state.role || '').toLowerCase();
  return `qs_msg_after_row:${u}:${r}`;
}
function getMsgAfterRow(){
  try{
    const v = localStorage.getItem(msgAfterRowKey());
    const n = parseInt(v || '0', 10);
    return isNaN(n) ? 0 : n;
  }catch(e){ return 0; }
}
function setMsgAfterRow(n){
  try{
    const num = parseInt(n || 0, 10);
    if(!isNaN(num)) localStorage.setItem(msgAfterRowKey(), String(num));
  }catch(e){}
}

function isCommTabVisible(){
  const el = document.getElementById('tab-comm');
  return !!el && !el.classList.contains('hidden');
}

function normalizePersonKey(v){
  // normalize names like "Soulayman (Lehrer)" -> "soulayman"
  let s = String(v || '').trim();
  s = s.replace(/\s+/g,' ');
  // remove trailing role suffix in parentheses
  s = s.replace(/\s*\([^)]*\)\s*$/,'');
  // common separators
  s = s.replace(/\s*[-–—]\s*(admin|lehrer|student|schüler|eltern)\s*$/i,'');
  return s.trim().toLowerCase();
}

function isFromMeMessage(m){
  const myUser = normalizePersonKey(state.user || '');
  const myRef  = String(state.studentData?.referenz || '').trim();
  const senderRaw = String(m?.senderName || '').trim();
  const sender = normalizePersonKey(senderRaw);

  // direct name match (normalized)
  if(myUser && sender && sender === myUser) return true;

  // fallback: sometimes senderName contains role or extra info
  if(myUser && senderRaw && normalizePersonKey(senderRaw).startsWith(myUser)) return true;

  // studentRef match (some sheets store sender as ref)
  if(myRef && senderRaw && String(senderRaw).trim() === myRef) return true;

  return false;
}

function isInboundToMe(m){
  const role = String(state.role || '').toLowerCase();
  if(role === 'admin') return String(m?.recipientType||'') === 'Admin';
  if(role === 'lehrer' || role === 'teacher'){
    const recType = String(m?.recipientType||'');
    if(recType !== 'Lehrer') return false;
    const to = normalizePersonKey(m?.recipientName || '');
    const me = normalizePersonKey(state.user || '');
    return !!me && !!to && to === me;
  }
  if(role === 'student'){
    const myRef = String(state.studentData?.referenz || '').trim();
    const to = String(m?.recipientName||'').trim();
    return String(m?.recipientType||'') === 'Student' && (
      (myRef && to === myRef) || (!myRef && normalizePersonKey(to) === normalizePersonKey(state.user||''))
    );
  }
  return false;
}

function isUnreadInbound(m){
  return !!m && String(m.status||'') === 'neu' && isInboundToMe(m) && !isFromMeMessage(m);
}

// Small beep without external audio files
function playMsgBeep(){
  try{
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = 'sine';
    o.frequency.value = 880;
    g.gain.value = 0.05;
    o.connect(g); g.connect(ctx.destination);
    o.start();
    setTimeout(()=>{ try{ o.stop(); ctx.close(); }catch(e){} }, 180);
  }catch(e){}
}

function showBrowserNotificationForMsg(m){
  try{
    if(!('Notification' in window)) return;
    if(Notification.permission !== 'granted') return;
    if(!isMessageNotificationsEnabled()) return;

    const sender = String(m?.senderName || '').trim() || (state.lang==='de' ? 'Unbekannt' : 'غير معروف');
    const text   = String(m?.messageText || '').trim();
    const title  = (state.lang === 'de') ? `Neue Nachricht – ${sender}` : `رسالة جديدة – ${sender}`;
    const body   = text ? (text.length > 160 ? text.slice(0,160)+'…' : text) : ((state.lang==='de') ? 'Neue Nachricht erhalten.' : 'تم استلام رسالة جديدة.');

    // Only show notification if the user is not actively reading the messages
    if(document.hidden || !isCommTabVisible()){
      const n = new Notification(title, { body });
      n.onclick = () => { try{ window.focus(); }catch(e){} try{ showTab('comm'); }catch(e){} };
    }
  }catch(e){}
}

async function pollNewMessagesLight(opts={}){
  if(!state.user || !state.role) return;
  const after = (opts.afterRowIndex != null) ? parseInt(opts.afterRowIndex,10) : getMsgAfterRow();
  const payload = {
    action: 'getMessagesSince',
    afterRowIndex: isNaN(after) ? 0 : after,
    userName: state.user,
    role: state.role,
    studentRef: (state.studentData && state.studentData.referenz) ? state.studentData.referenz : ''
  };

  try{
    const res = await fetch(WEB_APP_URL, { method:'POST', body: JSON.stringify(payload) }).then(r=>r.json());
    if(!res || !res.ok) return;

    // Always update watermark to server last row (prevents re-fetch/re-notify)
    const serverLast = parseInt(res.lastRowIndex || 0, 10);
    if(serverLast && serverLast > getMsgAfterRow()) setMsgAfterRow(serverLast);

    const newMsgs = Array.isArray(res.messages) ? res.messages : [];
    if(!newMsgs.length) { updateMsgBadge(); return; }

    // Merge into local state (for badge + messages view)
    if(!Array.isArray(state.messages)) state.messages = [];
    const existing = new Set(state.messages.map(x => String(x?.rowIndex||'')));
    for(const m of newMsgs){
      const k = String(m?.rowIndex||'');
      if(k && !existing.has(k)){
        state.messages.unshift(m);
        existing.add(k);
      }
    }

    // Update watermark to max row in the response
    let maxRow = getMsgAfterRow();
    for(const m of newMsgs){
      const ri = parseInt(m?.rowIndex||0,10);
      if(ri && ri > maxRow) maxRow = ri;
    }
    if(maxRow) setMsgAfterRow(maxRow);

    // Re-render only if messages tab is visible
    if(isCommTabVisible()){
      try{ renderMessages(); }catch(e){}
      try{ syncCommHeaderText(); }catch(e){}
    }
    updateMsgBadge();

    // Notify only for inbound messages not sent by me
    const inbound = newMsgs.filter(m => isInboundToMe(m) && !isFromMeMessage(m));
    if(inbound.length){
      const last = inbound.reduce((a,b)=>{
        const ai = parseInt(a?.rowIndex||0,10)||0;
        const bi = parseInt(b?.rowIndex||0,10)||0;
        return bi > ai ? b : a;
      }, inbound[0]);

      // Sound + Notification (if enabled)
      if(isMessageNotificationsEnabled()){
        playMsgBeep();
      }
      showBrowserNotificationForMsg(last);
      // Optional toast
      try{
        if(document.hidden || !isCommTabVisible()){
          showToast(state.lang==='de' ? 'Neue Nachricht erhalten.' : 'وصلت رسالة جديدة.');
        }
      }catch(e){}
    }
  }catch(e){
    // ignore network errors (will try again next tick)
  }
}

function startBackgroundMessagePolling(){
  try{ if(msgBgPollingInterval){ clearInterval(msgBgPollingInterval); msgBgPollingInterval = null; } }catch(e){}

  // Default: enable notifications switch ON (user still must grant permission in browser once)
  try{
    const k = msgNotifEnabledKey();
    if(localStorage.getItem(k) == null){
      localStorage.setItem(k, '1');
    }
  }catch(e){}

  // Baseline watermark without fetching all history:
  // ask server "since a very high row index" so it returns 0 messages but returns lastRowIndex.
  try{ pollNewMessagesLight({ afterRowIndex: 999999999 }); }catch(e){}

  // Poll every 12 seconds
  msgBgPollingInterval = setInterval(() => { pollNewMessagesLight(); }, 12000);

  // Also poll when the tab becomes visible again
  if(!state._msgVisHooked){
    state._msgVisHooked = true;
    document.addEventListener('visibilitychange', () => {
      try{ if(!document.hidden) pollNewMessagesLight(); }catch(e){}
    });
  }
}


function startMessagePolling() {
  // Deprecated – background delivery is handled by startBackgroundMessagePolling()
  try{ startBackgroundMessagePolling(); }catch(e){}
}
// --- Message Notifications (staff) ---
function msgNotifEnabledKey(){
  return `qs_msg_notif_enabled:${state.user || 'unknown'}`;
}
function isMessageNotificationsEnabled(){
  try{ return localStorage.getItem(msgNotifEnabledKey()) === '1'; }catch(e){ return false; }
}
function setMessageNotificationsEnabled(on){
  try{ localStorage.setItem(msgNotifEnabledKey(), on ? '1' : '0'); }catch(e){}
}
function setMsgNotifStatus(text){
  const el = document.getElementById('msg-notif-status');
  if(el) el.innerText = text || '';
}
function initMessageNotificationsUI(){
  const box = document.getElementById('chk-msg-notif');
  const lbl = document.getElementById('lbl-msg-notif');
  if(lbl) lbl.innerText = (state.lang === 'de' ? 'Benachrichtigungen für neue Nachrichten' : 'تنبيه عند وصول رسالة جديدة');

  if(!box) return;
  const supported = ('Notification' in window);
  box.disabled = !supported;
  box.checked = isMessageNotificationsEnabled() && supported;

  if(!supported){
    setMsgNotifStatus(state.lang === 'de' ? 'Nicht unterstützt in diesem Browser.' : 'غير مدعوم في هذا المتصفح.');
  } else {
    setMsgNotifStatus('');
  }
}

async function toggleMessageNotifications(){
  const box = document.getElementById('chk-msg-notif');
  if(!box) return;

  if(!('Notification' in window)){
    box.checked = false;
    setMsgNotifStatus(state.lang === 'de' ? 'Nicht unterstützt in diesem Browser.' : 'غير مدعوم في هذا المتصفح.');
    return;
  }

  const wantOn = !!box.checked;
  if(wantOn){
    if(Notification.permission === 'default'){
      const p = await Notification.requestPermission();
      if(p !== 'granted'){
        box.checked = false;
        setMessageNotificationsEnabled(false);
        setMsgNotifStatus(state.lang === 'de' ? 'Berechtigung abgelehnt.' : 'تم رفض الإذن.');
        return;
      }
    }
    if(Notification.permission !== 'granted'){
      box.checked = false;
      setMessageNotificationsEnabled(false);
      setMsgNotifStatus(state.lang === 'de' ? 'Berechtigung fehlt.' : 'لا يوجد إذن.');
      return;
    }
    setMessageNotificationsEnabled(true);
    setMsgNotifStatus(state.lang === 'de' ? 'Aktiviert.' : 'تم التفعيل.');
  } else {
    setMessageNotificationsEnabled(false);
    setMsgNotifStatus(state.lang === 'de' ? 'Deaktiviert.' : 'تم الإلغاء.');
  }
}



function openAddUser() {
  editingUserIdx = null;
  document.getElementById('lbl-user-modal-title').innerText = t('addUser');
  document.getElementById('new-user-name').value = '';
  document.getElementById('new-user-name').disabled = false;
  document.getElementById('new-user-pin').value = '';
  document.getElementById('new-user-role').value = 'Lehrer';
  document.getElementById('new-user-role').disabled = false;
  openModal('user-modal');
}

function openEditUser(user) {
  editingUserIdx = user.rowIndex;
  document.getElementById('lbl-user-modal-title').innerText = t('editUser');
  document.getElementById('new-user-name').value = user.userName;
  document.getElementById('new-user-name').disabled = true; 
  document.getElementById('new-user-pin').value = user.pin; 
  document.getElementById('new-user-role').value = user.role;
  document.getElementById('new-user-role').disabled = true;
  openModal('user-modal');
}

function submitUser() {
  const name = document.getElementById('new-user-name').value;
  const pin = document.getElementById('new-user-pin').value;
  const role = document.getElementById('new-user-role').value;
  
  if (!name || !pin) { 
    showToast("Bitte Name und PIN eingeben"); 
    return; 
  }
  
  let actionPayload = {};
  
  if (editingUserIdx) { 
    actionPayload = { 
      action: 'manageUser', 
      subAction: 'update', 
      rowIndex: editingUserIdx, 
      newPin: pin 
    }; 
  } else { 
    actionPayload = { 
      action: 'manageUser', 
      subAction: 'add', 
      newUserName: name, 
      newPin: pin, 
      newRole: role 
    }; 
  }
  
  showToast("Speichern...");
  
  fetch(WEB_APP_URL, { 
    method: 'POST', 
    headers: { "Content-Type": "text/plain" }, 
    body: JSON.stringify(actionPayload) 
  })
  .then(r => r.json()).then(res => { 
    if (res.ok) { 
      showToast("Gespeichert"); 
      closeModal('user-modal'); 
      refreshData(); 
    } else { 
      showToast("Fehler: " + res.error); 
    } 
  });
}

function deleteUser(rowIndex) {
  if (!confirm(t('confirmDelUser'))) return;
  
  fetch(WEB_APP_URL, { 
    method: 'POST', 
    headers: { "Content-Type": "text/plain" }, 
    body: JSON.stringify({ 
      action: 'manageUser', 
      subAction: 'delete', 
      rowIndex: rowIndex 
    }) 
  })
  .then(r => r.json()).then(res => { 
    if (res.ok) { 
      showToast("Benutzer gelöscht"); 
      refreshData(); 
    } else { 
      showToast("Fehler: " + res.error); 
    } 
  });
}

function toggleDocVisibility(rowIndex, isVisible) {
  fetch(WEB_APP_URL, { 
    method: 'POST', 
    headers: { "Content-Type": "text/plain" }, 
    body: JSON.stringify({ 
      action: 'toggleDoc', 
      rowIndex: rowIndex, 
      isVisible: isVisible 
    }) 
  })
  .then(r => r.json()).then(res => { 
    if (res.ok) { 
      showToast("Sichtbarkeit aktualisiert"); 
    } else { 
      showToast("Fehler: " + res.error); 
    } 
  });
}

function linkify(text) {
  if (!text) return "";
  var urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
  
  return text.replace(urlRegex, function(url) {
    var safeUrl = url.replace(/'/g, "\\'");
    return '<a href="javascript:void(0)" onclick="openInGhostWindow(\'' + safeUrl + '\')" style="color:var(--primary); text-decoration:underline;">' + url + '</a>';
  });
}

document.getElementById("login-pin")?.addEventListener("keydown", function(event) { 
  if ((event.key === "Enter") || (event.keyCode === 13)) { 
    event.preventDefault(); 
    doLogin(); 
  } 
});

document.getElementById("login-identifier")?.addEventListener("keydown", function(event) { 
  if ((event.key === "Enter") || (event.keyCode === 13)) { 
    event.preventDefault(); 
    const pinEl = document.getElementById("login-pin");
    if (pinEl && (!pinEl.value || pinEl.value.trim() === "")) {
      pinEl.focus();
      return;
    }
    doLogin(); 
  } 
});

// Add keypress listener for lesson search
document.getElementById("lesson-search-input")?.addEventListener("keydown", function(event) { 
  if ((event.key === "Enter") || (event.keyCode === 13)) { 
    event.preventDefault(); 
    searchInLesson(); 
  } 
});

/* ===========================
   Koran Tab Reader (Pages)
   =========================== */
const KORAN_TOTAL_PAGES = 604;
const KORAN_PAGE_IMAGE_BASE = "https://cdn.jsdelivr.net/gh/GovarJabbar/Quran-PNG@master/"; // 001.png ... 604.png
const KORAN_PAGE_META_URL = "https://api.qurani.ai/gw/qh/v1/page/metadata";
const KORAN_PAGE_TEXT_SOURCES = [
  (p)=>`https://api.alquran.cloud/v1/page/${p}/quran-uthmani`,
  (p)=>`https://api.quran.com/api/v4/verses/by_page/${p}?fields=text_uthmani,verse_key&per_page=350`,
  (p)=>`https://api.qurani.ai/gw/qh/v1/page/${p}`
];

// Settings
function koranGetBool(key, def=true){
  try{
    const v = localStorage.getItem(key);
    if(v === null || v === undefined || v === '') return def;
    return v === '1' || v === 'true';
  }catch(e){ return def; }
}
function koranSetBool(key, v){
  try{ localStorage.setItem(key, v ? '1' : '0'); }catch(e){}
}


let koranTab = {
  inited: false,
  currentPage: 1,
  pageMeta: null, // [{number, firstAyahNumber, firstSurahNumber, ...}]
  pageTextCache: new Map(), // page -> [{surah, ayah, verseKey, text}]
  audio: null,
  audioQueue: [],
  audioIdx: 0,
  audioSurah: null,
  audioPlaying: false,
  repeatCount: (function(){ try{ return Math.max(1, parseInt(localStorage.getItem('koran_repeat_count')||'1',10) || 1); }catch(e){ return 1; } })(),
  repeatRemaining: 1,
  autoNext: koranGetBool('koran_auto_next', true),
  autoScroll: koranGetBool('koran_auto_scroll', true),
  playbackRate: (function(){ try{ return parseFloat(localStorage.getItem('koran_speed')||'1') || 1; }catch(e){ return 1; } })(),
  currentVerseKey: null
};

function updateKoranBottomOffset(){
  const bn = document.querySelector('.bottom-nav');
  const h = bn ? bn.getBoundingClientRect().height : 0;
  document.documentElement.style.setProperty('--koran-bottom-offset', `${h}px`);
}
function updateKoranAudioHeight(){
  const bar = document.getElementById('koranAudioBar');
  if(!bar) return;
  const h = Math.ceil(bar.getBoundingClientRect().height);
  if(h && h > 0){
    document.documentElement.style.setProperty('--koran-audio-h', `${h}px`);
  }
}

function koranPageUrl(page){
  const p = String(parseInt(page,10)).padStart(3,'0');
  return `${KORAN_PAGE_IMAGE_BASE}${p}.png`;
}
function koranToArabicIndic(n){
  const d = String(n||'').split('');
  const map = {'0':'٠','1':'١','2':'٢','3':'٣','4':'٤','5':'٥','6':'٦','7':'٧','8':'٨','9':'٩'};
  return d.map(ch=>map[ch] ?? ch).join('');
}

function koranFmtTime(sec){
  sec = Math.max(0, Math.floor(sec||0));
  const m = Math.floor(sec/60);
  const s = sec%60;
  return String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0');
}

function koranShowLoading(show){
  const el = document.getElementById('koranPageLoading');
  if(!el) return;
  el.classList.toggle('hidden', !show);
}

function koranGetCachedPageText(page){
  const p = koranClampPage(page);
  if(koranTab.pageTextCache.has(p)) return koranTab.pageTextCache.get(p);
  try{
    const raw = localStorage.getItem('koran_page_text_'+p);
    if(!raw) return null;
    const arr = JSON.parse(raw);
    if(!Array.isArray(arr) || !arr.length) return null;
    koranTab.pageTextCache.set(p, arr);
    return arr;
  }catch(e){
    return null;
  }
}

function koranSetCachedPageText(page, verses){
  const p = koranClampPage(page);
  try{
    const clean = Array.isArray(verses) ? verses.slice(0, 500) : [];
    koranTab.pageTextCache.set(p, clean);
    // keep storage light: only save last ~25 pages
    try{
      const key = 'koran_page_text_'+p;
      localStorage.setItem(key, JSON.stringify(clean));
      const idxKey = 'koran_page_text_index';
      const idx = (localStorage.getItem(idxKey) ? JSON.parse(localStorage.getItem(idxKey)) : []);
      const arr = Array.isArray(idx) ? idx : [];
      if(!arr.includes(p)) arr.push(p);
      while(arr.length > 25){
        const rm = arr.shift();
        try{ localStorage.removeItem('koran_page_text_'+rm); }catch(e){}
      }
      localStorage.setItem(idxKey, JSON.stringify(arr));
    }catch(e){}
  }catch(e){}
}

async function koranFetchJson(url){
  const ctrl = new AbortController();
  const t = setTimeout(()=>ctrl.abort(), 9000);
  try{
    const r = await fetch(url, {method:'GET', signal: ctrl.signal});
    if(!r.ok) throw new Error('HTTP '+r.status);
    return await r.json();
  } finally {
    clearTimeout(t);
  }
}

function koranNormalizePageVerses(json){
  // alquran.cloud
  if(json && json.data && Array.isArray(json.data.ayahs)){
    return json.data.ayahs.map(a=>({
      surah: a.surah?.number ?? a.surahNumber ?? a.surah ?? null,
      ayah: a.numberInSurah ?? a.ayahNumber ?? a.number ?? null,
      verseKey: (a.surah?.number && a.numberInSurah) ? `${a.surah.number}:${a.numberInSurah}` : (a.verse_key ?? a.verseKey ?? ''),
      text: a.text ?? a.text_uthmani ?? a.uthmani ?? ''
    })).filter(v=>v.surah && v.ayah && v.text);
  }
  // quran.com
  if(json && Array.isArray(json.verses)){
    return json.verses.map(v=>({
      surah: parseInt(String(v.verse_key||'').split(':')[0],10),
      ayah: parseInt(String(v.verse_key||'').split(':')[1],10),
      verseKey: v.verse_key,
      text: v.text_uthmani || v.text || ''
    })).filter(v=>v.surah && v.ayah && v.text);
  }
  if(json && json.data && Array.isArray(json.data.verses)){
    return json.data.verses.map(v=>({
      surah: parseInt(String(v.verse_key||'').split(':')[0],10),
      ayah: parseInt(String(v.verse_key||'').split(':')[1],10),
      verseKey: v.verse_key,
      text: v.text_uthmani || v.text || ''
    })).filter(v=>v.surah && v.ayah && v.text);
  }
  // qurani.ai (best effort)
  if(json && json.data && Array.isArray(json.data.ayahs)){
    return json.data.ayahs.map(v=>({
      surah: v.surahNumber ?? v.surah ?? null,
      ayah: v.ayahNumber ?? v.ayah ?? null,
      verseKey: v.verseKey ?? v.verse_key ?? (v.surahNumber && v.ayahNumber ? `${v.surahNumber}:${v.ayahNumber}` : ''),
      text: v.text ?? v.uthmani ?? v.text_uthmani ?? ''
    })).filter(v=>v.surah && v.ayah && v.text);
  }
  return null;
}

async function koranLoadPageText(page){
  const p = koranClampPage(page);
  const cached = koranGetCachedPageText(p);
  if(cached) return cached;

  for(const mk of KORAN_PAGE_TEXT_SOURCES){
    const url = mk(p);
    try{
      const j = await koranFetchJson(url);
      const verses = koranNormalizePageVerses(j);
      if(Array.isArray(verses) && verses.length){
        koranSetCachedPageText(p, verses);
        return verses;
      }
    }catch(e){
      // try next source
    }
  }
  return null;
}

function koranRenderPageText(page, verses){
  const txt = document.getElementById('koranPageText');
  const img = document.getElementById('koranPageImg');
  if(!txt) return;

  if(Array.isArray(verses) && verses.length){
    // Build spans for click + highlight
    txt.innerHTML = verses.map(v=>{
      const verseKey = escapeHtml(v.verseKey || `${v.surah}:${v.ayah}`);
      const t = escapeHtml(v.text || '');
      const n = koranToArabicIndic(v.ayah);
      return `<span class="ayah" data-verse="${verseKey}" data-surah="${v.surah}" data-ayah="${v.ayah}">${t} <span class="ayah-num">﴿${n}﴾</span></span>`;
    }).join(' ');
    txt.classList.remove('hidden');
    if(img) img.classList.add('hidden');
  } else {
    txt.classList.add('hidden');
    if(img) img.classList.remove('hidden');
  }
}

function koranHighlightVerse(surah, ayah){
  const key = `${parseInt(surah,10)}:${parseInt(ayah,10)}`;
  koranTab.currentVerseKey = key;

  const box = document.getElementById('koranPageText');
  if(!box) return;

  box.querySelectorAll('.ayah.active').forEach(el=>el.classList.remove('active'));
  const el = box.querySelector(`.ayah[data-verse="${CSS.escape(key)}"]`);
  if(el){
    el.classList.add('active');
    if(koranTab.autoScroll){
      try{ el.scrollIntoView({block:'center', inline:'nearest', behavior:'smooth'}); }catch(e){}
    }
  }
}

async function koranLoadAndRenderPage(page){
  const p = koranClampPage(page);
  const img = document.getElementById('koranPageImg');
  // try text first
  koranShowLoading(true);
  const verses = await koranLoadPageText(p);
  koranRenderPageText(p, verses);
  if(!verses && img){
    img.src = koranPageUrl(p);
    img.alt = `Quran page ${p}`;
    // Preload neighbors for smoother paging (images)
    try{
      const pre = (n) => { const i = new Image(); i.src = koranPageUrl(n); };
      if(p>1) pre(p-1);
      if(p<KORAN_TOTAL_PAGES) pre(p+1);
    }catch(e){}
  }
  koranShowLoading(false);
}


function koranClampPage(p){
  p = parseInt(p,10);
  if(!Number.isFinite(p)) p = 1;
  return Math.max(1, Math.min(KORAN_TOTAL_PAGES, p));
}

function koranSetPage(page, opts={}){
  const save = opts.save !== false;
  const wrap = document.getElementById('koran-page-wrap');

  const prev = koranTab.currentPage || 1;
  const p = koranClampPage(page);

  // Direction for flip: forward (next page) should feel like RTL turning.
  // p > prev  => next, use -1 (turn left). p < prev => previous, use +1 (turn right).
  const dir = (p > prev) ? -1 : 1;
  if(wrap) wrap.style.setProperty('--flip-dir', String(dir));

  // Animate out -> swap -> animate in
  const doRender = ()=>{
    koranTab.currentPage = p;

    const numEl = document.getElementById('koranPageNumber');
    const totalEl = document.getElementById('koranPageTotal');
    if(totalEl) totalEl.textContent = String(KORAN_TOTAL_PAGES);
    if(numEl) numEl.textContent = String(p);

    // Render: prefer text (low data) then fallback to PNG
    koranLoadAndRenderPage(p);

    if(save){
      try{ localStorage.setItem('koran_last_page', String(p)); }catch(e){}
    }
  };

  if(!wrap){
    doRender();
    return;
  }

  // If already flipping, just render without stacking animations
  if(wrap.classList.contains('koran-flip-leave') || wrap.classList.contains('koran-flip-enter')){
    doRender();
    return;
  }

  wrap.classList.add('koran-flip-leave');
  setTimeout(()=>{
    wrap.classList.remove('koran-flip-leave');
    doRender();
    wrap.classList.add('koran-flip-enter');
    setTimeout(()=> wrap.classList.remove('koran-flip-enter'), 280);
  }, 170);
}


function koranGetLastPage(){
  try{
    const v = parseInt(localStorage.getItem('koran_last_page') || '1', 10);
    return koranClampPage(v);
  }catch(e){
    return 1;
  }
}

function koranOpenDrawer(){
  const ov = document.getElementById('koranDrawerOverlay');
  const dr = document.getElementById('koranDrawer');
  if(ov) { ov.classList.remove('hidden'); ov.setAttribute('aria-hidden','false'); }
  if(dr) { dr.classList.remove('hidden'); dr.setAttribute('aria-hidden','false'); }

  // Register as "modal" for back-button handling
  try{
    navState.modalStack = (navState.modalStack || []).filter(x => x !== 'koranDrawer');
    navState.modalStack.push('koranDrawer');
    if(!navState.popHandling){
      history.pushState({qsNav:true, kind:'koranOverlay', id:'koranDrawer'}, '');
    }
  }catch(e){}

  try{ renderKoranBookmarks(); }catch(e){}
}

function koranCloseDrawer(opts={}){
  const ov = document.getElementById('koranDrawerOverlay');
  const dr = document.getElementById('koranDrawer');
  if(ov) { ov.classList.add('hidden'); ov.setAttribute('aria-hidden','true'); }
  if(dr) { dr.classList.add('hidden'); dr.setAttribute('aria-hidden','true'); }

  try{
    navState.modalStack = (navState.modalStack || []).filter(x => x !== 'koranDrawer');
  }catch(e){}

  // If user explicitly closed it (not via popstate), try to go back one history step
  if(!opts || !opts.noHistory){
    try{
      if(!navState.popHandling) history.back();
    }catch(e){}
  }
}

function koranLoadPageMeta(){
  if(koranTab.pageMeta) return Promise.resolve(koranTab.pageMeta);
  return fetch(KORAN_PAGE_META_URL, {method:'GET'})
    .then(r => r.json())
    .then(j => {
      const arr = (j && j.data) ? j.data : null;
      if(!Array.isArray(arr) || !arr.length) throw new Error('Bad page meta');
      // Normalize + sort
      koranTab.pageMeta = arr
        .map(x => ({
          number: parseInt(x.number,10),
          firstAyahNumber: parseInt(x.firstAyahNumber,10),
          firstSurahNumber: parseInt(x.firstSurahNumber,10)
        }))
        .filter(x => Number.isFinite(x.number) && Number.isFinite(x.firstAyahNumber))
        .sort((a,b)=>a.number-b.number);
      return koranTab.pageMeta;
    })
    .catch(err => {
      console.warn('Koran page metadata failed', err);
      koranTab.pageMeta = null;
      return null;
    });
}

function koranSurahStartGlobalAyah(surahNumber){
  // Global ayah index: 1..6236
  const s = parseInt(surahNumber,10);
  if(!s || s<1 || s>114) return 1;
  let sum = 0;
  for(let i=0; i<s-1; i++) sum += (SURAH_AYAHS[i] || 0);
  return sum + 1;
}

function koranPageForGlobalAyah(globalAyah){
  const meta = koranTab.pageMeta;
  if(!meta || !meta.length) return 1;
  let lo = 0, hi = meta.length-1, ans = 1;
  while(lo <= hi){
    const mid = (lo + hi) >> 1;
    if(meta[mid].firstAyahNumber <= globalAyah){
      ans = meta[mid].number;
      lo = mid + 1;
    } else {
      hi = mid - 1;
    }
  }
  return koranClampPage(ans);
}

function koranGotoSurah(surahNumber){
  const startGlobal = koranSurahStartGlobalAyah(surahNumber);
  const page = koranTab.pageMeta ? koranPageForGlobalAyah(startGlobal) : null;
  if(page){
    koranSetPage(page);
  } else {
    // If metadata not loaded yet, fall back to a reasonable page guess (beginning), then fetch and correct
    koranSetPage(1, {save:false});
    koranLoadPageMeta().then(()=>{ try{ koranSetPage(koranPageForGlobalAyah(startGlobal)); }catch(e){} });
  }

  // Prepare audio for this surah
  try{ koranPrepareSurahAudio(surahNumber); }catch(e){}
  koranCloseDrawer();
}

function renderKoranSurahList(filterText=''){
  const list = document.getElementById('koranSurahList');
  if(!list) return;

  const q = String(filterText||'').trim();
  const qNorm = q.toLowerCase();
  const items = SURAH_LIST
    .map(row => ({num: row[0], latin: row[1], arabic: row[2]}))
    .filter(s => {
      if(!q) return true;
      return String(s.num).includes(qNorm) ||
             s.latin.toLowerCase().includes(qNorm) ||
             s.arabic.includes(q);
    });

  list.innerHTML = '';
  items.forEach(s => {
    const el = document.createElement('div');
    el.className = 'koran-item';
    el.innerHTML = `
      <div style="min-width:0;">
        <div class="name">${s.arabic}</div>
        <div class="meta">سورة ${s.num} • ${s.latin}</div>
      </div>
      <div class="meta">↩</div>
    `;
    el.addEventListener('click', ()=> koranGotoSurah(s.num));
    list.appendChild(el);
  });
}

function koranGetBookmarks(){
  try{
    const raw = localStorage.getItem('koran_bookmarks');
    const arr = raw ? JSON.parse(raw) : [];
    if(!Array.isArray(arr)) return [];
    return arr.map(x=>parseInt(x,10)).filter(n=>Number.isFinite(n) && n>=1 && n<=KORAN_TOTAL_PAGES);
  }catch(e){
    return [];
  }
}

function koranSetBookmarks(arr){
  try{
    const clean = Array.from(new Set((arr||[]).map(x=>parseInt(x,10)).filter(n=>Number.isFinite(n) && n>=1 && n<=KORAN_TOTAL_PAGES))).sort((a,b)=>a-b);
    localStorage.setItem('koran_bookmarks', JSON.stringify(clean));
  }catch(e){}
}

function renderKoranBookmarks(){
  const list = document.getElementById('koranBookmarksList');
  if(!list) return;
  const bm = koranGetBookmarks();
  if(!bm.length){
    list.innerHTML = `<div class="text-sm" style="opacity:.75;">لا توجد علامات محفوظة بعد.</div>`;
    return;
  }
  list.innerHTML = '';
  bm.forEach(p => {
    const row = document.createElement('div');
    row.className = 'koran-item';
    row.innerHTML = `
      <div style="min-width:0;">
        <div class="name">صفحة ${p}</div>
        <div class="meta">انتقال سريع</div>
      </div>
      <button class="del" type="button" title="حذف"><i class="fa-solid fa-trash"></i></button>
    `;
    row.addEventListener('click', (e)=>{
      // ignore if trash clicked
      if(e.target && (e.target.closest && e.target.closest('button.del'))) return;
      koranSetPage(p);
      koranCloseDrawer();
    });
    row.querySelector('button.del')?.addEventListener('click', (e)=>{
      e.stopPropagation();
      const next = bm.filter(x=>x!==p);
      koranSetBookmarks(next);
      renderKoranBookmarks();
      showToast(state.lang === 'de' ? 'Gelöscht' : 'تم الحذف');
    });
    list.appendChild(row);
  });
}

function koranAddBookmark(page){
  const p = koranClampPage(page);
  const bm = koranGetBookmarks();
  if(!bm.includes(p)){
    bm.push(p);
    koranSetBookmarks(bm);
    showToast(state.lang === 'de' ? 'Gespeichert' : 'تم حفظ الصفحة');
  } else {
    showToast(state.lang === 'de' ? 'Schon gespeichert' : 'الصفحة محفوظة مسبقاً');
  }
  try{ renderKoranBookmarks(); }catch(e){}
}

/* ---- Audio (EveryAyah) ---- */
function koranPrepareSurahAudio(surahNumber){
  const s = parseInt(surahNumber,10);
  if(!s || s<1 || s>114) return;
  const count = getSurahAyahCount(s);
  koranTab.audioSurah = s;
  koranTab.audioQueue = [];
  for(let a=1; a<=count; a++) koranTab.audioQueue.push(a);
  koranTab.audioIdx = 0;

  const info = getSurahInfo(s);
  const titleEl = document.getElementById('koranAudioTitle');
  const infoEl = document.getElementById('koranAudioInfo');
  if(titleEl) titleEl.textContent = info.arabic;
  if(infoEl) infoEl.textContent = `سورة ${info.arabic} • ${count} آية`;
}

function koranSetPlayIcon(isPlaying){
  const btn = document.getElementById('koranAudioToggle');
  const lab = document.getElementById('koranPlayLabel');
  if(!btn) return;
  const html = isPlaying
    ? '<i class="fa-solid fa-pause"></i>'
    : '<i class="fa-solid fa-play"></i>';
  if(lab) lab.innerHTML = html;
  else btn.innerHTML = html;
  btn.setAttribute('aria-label', isPlaying ? (state.lang==='de' ? 'Pause' : 'إيقاف مؤقت') : (state.lang==='de' ? 'Play' : 'تشغيل'));
  btn.title = isPlaying ? (state.lang==='de' ? 'Pause' : 'إيقاف مؤقت') : (state.lang==='de' ? 'Play' : 'تشغيل');
}


function koranSyncSeekUI(force=false){
  const a = koranTab.audio;
  const seek = document.getElementById('koranSeek');
  const t = document.getElementById('koranTime');
  if(!a || !seek || !t) return;

  const dur = (Number.isFinite(a.duration) && a.duration>0) ? a.duration : 0;
  const cur = (Number.isFinite(a.currentTime) && a.currentTime>=0) ? a.currentTime : 0;

  if(dur > 0){
    const v = Math.max(0, Math.min(1000, Math.round((cur/dur)*1000)));
    if(force || document.activeElement !== seek) seek.value = String(v);
    t.textContent = `${koranFmtTime(cur)} / ${koranFmtTime(dur)}`;
  } else {
    if(force) seek.value = '0';
    t.textContent = `00:00 / 00:00`;
  }
}


function koranPlayAtIndex(idx, opts={}){
  const audio = koranTab.audio;
  if(!audio || !koranTab.audioSurah || !koranTab.audioQueue.length) return;
  const i = Math.max(0, Math.min(koranTab.audioQueue.length-1, idx));
  const prevIdx = koranTab.audioIdx;
  koranTab.audioIdx = i;
  // Reset repeat counter when moving to a new ayah (or when explicitly requested)
  if(opts && opts.resetRepeat){
    koranTab.repeatRemaining = Math.max(1, koranTab.repeatCount || 1);
  } else if(prevIdx !== i){
    koranTab.repeatRemaining = Math.max(1, koranTab.repeatCount || 1);
  }
  const ayah = koranTab.audioQueue[i];

  const info = getSurahInfo(koranTab.audioSurah);
  const infoEl = document.getElementById('koranAudioInfo');
  if(infoEl) infoEl.textContent = `سورة ${info.arabic} • آية ${ayah}`;

  try{ koranHighlightVerse(koranTab.audioSurah, ayah); }catch(e){}

  audio.src = everyAyahUrl(koranTab.audioSurah, ayah);
  audio.play().then(()=>{
    try{ koranSyncSeekUI(true); }catch(e){}

    koranTab.audioPlaying = true;
    koranSetPlayIcon(true);
  }).catch(()=>{
    koranTab.audioPlaying = false;
    koranSetPlayIcon(false);
  });
}

function koranPlayNext(){
  if(!koranTab.audioQueue.length) return;
  const next = koranTab.audioIdx + 1;
  if(next >= koranTab.audioQueue.length){
    koranTab.audioPlaying = false;
    koranSetPlayIcon(false);
    showToast(state.lang === 'de' ? 'Fertig' : 'انتهى');
    return;
  }
  koranPlayAtIndex(next, {resetRepeat:true});
}

function koranPlayPrev(){
  if(!koranTab.audioQueue.length) return;
  const prev = koranTab.audioIdx - 1;
  koranPlayAtIndex(Math.max(0, prev), {resetRepeat:true});
}

function initKoranTab(){
  if(koranTab.inited) return;

  koranTab.inited = true;
  updateKoranBottomOffset();
  window.addEventListener('resize', ()=>{ try{ updateKoranBottomOffset(); }catch(e){} try{ updateKoranAudioHeight(); }catch(e){} });

  // Page init
  koranSetPage(koranGetLastPage(), {save:false});

  // Load page meta in background (needed for surah->page jump)
  koranLoadPageMeta().then(()=>{ /* no-op */ });

  // Controls
  document.getElementById('koranPrevPage')?.addEventListener('click', ()=> koranSetPage(koranTab.currentPage - 1));
  document.getElementById('koranNextPage')?.addEventListener('click', ()=> koranSetPage(koranTab.currentPage + 1));

  // Swipe gesture
  const wrap = document.getElementById('koran-page-wrap');
  let x0 = null, t0 = 0;
  wrap?.addEventListener('touchstart', (e)=>{
    if(!e.touches || !e.touches.length) return;
    x0 = e.touches[0].clientX;
    t0 = Date.now();
  }, {passive:true});
  wrap?.addEventListener('touchend', (e)=>{
    if(x0 === null) return;
    const dt = Date.now() - t0;
    const x1 = (e.changedTouches && e.changedTouches.length) ? e.changedTouches[0].clientX : x0;
    const dx = x1 - x0;
    x0 = null;

    // quick swipe
    if(dt < 400 && Math.abs(dx) > 45){
      if(dx < 0) koranSetPage(koranTab.currentPage - 1);
      else koranSetPage(koranTab.currentPage + 1);
    }
  }, {passive:true});

  // Pointer swipe (mouse/pen)
  let px0 = null, pt0 = 0;
  wrap?.addEventListener('pointerdown', (e)=>{
    // only primary button / touch-like
    if(e.pointerType === 'mouse' && e.button !== 0) return;
    px0 = e.clientX;
    pt0 = Date.now();
  });
  wrap?.addEventListener('pointerup', (e)=>{
    if(px0 === null) return;
    const dt = Date.now() - pt0;
    const dx = e.clientX - px0;
    px0 = null;
    if(dt < 600 && Math.abs(dx) > 55){
      if(dx < 0) koranSetPage(koranTab.currentPage - 1);
      else koranSetPage(koranTab.currentPage + 1);
    }
  });


  
  // Click on ayah in text view to play from that ayah
  const txtBox = document.getElementById('koranPageText');
  txtBox?.addEventListener('click', (e)=>{
    const el = e.target?.closest ? e.target.closest('.ayah') : null;
    if(!el) return;
    const s = parseInt(el.getAttribute('data-surah')||'',10);
    const a = parseInt(el.getAttribute('data-ayah')||'',10);
    if(!s || !a) return;
    try{
      // Prepare audio for that surah and start from the selected ayah
      koranPrepareSurahAudio(s);
      koranPlayAtIndex(Math.max(0, a-1), {resetRepeat:true});
      koranHighlightVerse(s, a);
    }catch(err){}
  });
// Drawer
  document.getElementById('koranIndexFab')?.addEventListener('click', koranOpenDrawer);
  document.getElementById('koranDrawerOverlay')?.addEventListener('click', koranCloseDrawer);
  document.getElementById('koranDrawerClose')?.addEventListener('click', koranCloseDrawer);

  // Jump to page
  document.getElementById('koranJumpPageBtn')?.addEventListener('click', ()=>{
    const v = document.getElementById('koranJumpPageInput')?.value;
    koranSetPage(v);
    koranCloseDrawer();
  });
  document.getElementById('koranJumpPageInput')?.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter'){
      e.preventDefault();
      document.getElementById('koranJumpPageBtn')?.click();
    }
  });

  // Surah list + filter
  renderKoranSurahList('');
  const search = document.getElementById('koranSurahSearch');
  search?.addEventListener('input', ()=> renderKoranSurahList(search.value || ''));

  // Bookmarks
  document.getElementById('koranBookmarkBtn')?.addEventListener('click', ()=> koranAddBookmark(koranTab.currentPage));


  // Audio
  koranTab.audio = document.getElementById('koranAudio');
  const audio = koranTab.audio;
  if(audio){
    // Restore speed
    try{
      audio.playbackRate = koranTab.playbackRate || 1;
      const sel = document.getElementById('koranSpeedSel');
      if(sel) sel.value = String(audio.playbackRate);
    }catch(e){}

    // Repeat / next behavior
    audio.onended = () => {
      try{
        // repeat current ayah N times, then (optionally) go next
        if(koranTab.repeatRemaining > 1){
          koranTab.repeatRemaining = Math.max(1, koranTab.repeatRemaining - 1);
          koranPlayAtIndex(koranTab.audioIdx, {resetRepeat:false});
          return;
        }
        if(koranTab.autoNext){
          koranPlayNext();
        } else {
          koranTab.audioPlaying = false;
          koranSetPlayIcon(false);
        }
      }catch(e){}
    };

    // Seekbar updates
    audio.ontimeupdate = () => { try{ koranSyncSeekUI(); }catch(e){} };
    audio.onloadedmetadata = () => { try{ koranSyncSeekUI(true); }catch(e){} };
  }

    // Repeat count
  const repSel = document.getElementById('koranRepeatCount');
  if(repSel){
    try{ repSel.value = String(koranTab.repeatCount || 1); }catch(e){}
    repSel.addEventListener('change', (e)=>{
      const v = Math.max(1, parseInt(e.target.value||'1',10) || 1);
      koranTab.repeatCount = v;
      try{ localStorage.setItem('koran_repeat_count', String(v)); }catch(err){}
    });
  }

  // Auto-next + Auto-scroll (same toggle)
  const autoChk = document.getElementById('koranAutoNextChk');
  if(autoChk){
    try{ autoChk.checked = !!koranTab.autoNext; }catch(e){}
    autoChk.addEventListener('change', ()=>{
      koranTab.autoNext = !!autoChk.checked;
      // keep previous behavior for scrolling highlight
      koranTab.autoScroll = !!autoChk.checked;
      koranSetBool('koran_auto_next', koranTab.autoNext);
      koranSetBool('koran_auto_scroll', koranTab.autoScroll);
    });
  }

  // Speed
  document.getElementById('koranSpeedSel')?.addEventListener('change', (e)=>{
    const v = parseFloat(e.target.value||'1') || 1;
    if(koranTab.audio) koranTab.audio.playbackRate = v;
    koranTab.playbackRate = v;
    try{ localStorage.setItem('koran_speed', String(v)); }catch(err){}
  });

  // Stop
  document.getElementById('koranAudioStop')?.addEventListener('click', ()=>{
    const a = koranTab.audio;
    if(!a) return;
    try{ a.pause(); a.currentTime = 0; }catch(e){}
    koranTab.audioPlaying = false;
    koranSetPlayIcon(false);
  });

  // Keep koran reader bottom padding accurate (dynamic audio dock height)
  try{ updateKoranAudioHeight(); }catch(e){}

  document.getElementById('koranAudioToggle')?.addEventListener('click', ()=>{
    const audio = koranTab.audio;
    if(!audio) return;

    if(!koranTab.audioQueue.length){
      // Default: prepare audio of current visible page's first surah (best effort) by asking user to choose
      showToast(state.lang === 'de' ? 'Bitte Sure wählen' : 'اختر سورة من الفهرس');
      koranOpenDrawer();
      return;
    }

    if(!audio.src){
      koranPlayAtIndex(koranTab.audioIdx || 0, {resetRepeat:true});
      return;
    }

    if(audio.paused){
      audio.play().then(()=>{
        koranTab.audioPlaying = true;
        koranSetPlayIcon(true);
      }).catch(()=>{});
    } else {
      audio.pause();
      koranTab.audioPlaying = false;
      koranSetPlayIcon(false);
    }
  });

  document.getElementById('koranAudioNext')?.addEventListener('click', ()=> koranPlayNext());
  document.getElementById('koranAudioPrev')?.addEventListener('click', ()=> koranPlayPrev());

  // Start with last selected surah (optional)
  try{
    const lastS = parseInt(localStorage.getItem('koran_last_surah') || '', 10);
    if(lastS>=1 && lastS<=114){
      koranPrepareSurahAudio(lastS);
      koranSetPlayIcon(false);
    }
  }catch(e){}

  // Save last surah when prepared
  const origPrepare = koranPrepareSurahAudio;
  koranPrepareSurahAudio = function(s){
    origPrepare(s);
    try{ localStorage.setItem('koran_last_surah', String(parseInt(s,10))); }catch(e){}
  };
}

</script>


<!-- Student Akte: Evaluation History -->
<div id="stu-akte-eval-modal" class="modal-overlay" aria-hidden="true">
  <div class="modal-content" role="dialog" aria-modal="true">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
      <div id="stu-akte-eval-modal-title" class="font-bold" style="font-size:1.05rem;">Bewertungen</div>
      <button class="icon-btn" onclick="closeModal('stu-akte-eval-modal')" aria-label="Close"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <div style="margin-top:12px;">
      <div id="akte-eval-history-list" style="display:flex; flex-direction:column; gap:6px;"></div>
    </div>
  </div>
</div>

<!-- Student Akte: Attendance History -->
<div id="stu-akte-att-modal" class="modal-overlay" aria-hidden="true">
  <div class="modal-content" role="dialog" aria-modal="true">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
      <div id="stu-akte-att-modal-title" class="font-bold" style="font-size:1.05rem;">Anwesenheit</div>
      <button class="icon-btn" onclick="closeModal('stu-akte-att-modal')" aria-label="Close"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <div style="margin-top:12px;">
      <div id="akte-att-history-list" style="display:flex; flex-direction:column; gap:6px;"></div>
    </div>
  </div>
</div>


<!-- Student Akte: Fortschritt / تقدمي -->
<div id="stu-akte-prog-modal" class="modal-overlay" aria-hidden="true">
  <div class="modal-content" role="dialog" aria-modal="true">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
      <div id="stu-akte-prog-modal-title" class="font-bold" style="font-size:1.05rem;">Fortschritt</div>
      <button class="icon-btn" onclick="closeModal('stu-akte-prog-modal')" aria-label="Close"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <div style="margin-top:12px;">
      <div id="akte-prog-history-list" style="display:flex; flex-direction:column; gap:6px;"></div>
    </div>
  </div>
</div>

<!-- Student Alert Popup (shows late/absent + new notes/homework/evaluations until confirmed) -->
<div id="alert-modal" class="modal-overlay" aria-hidden="true">
  <div class="modal-content" role="dialog" aria-modal="true">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
      <div id="alert-modal-title" class="font-bold" style="font-size:1.05rem;"></div>
      <button class="icon-btn" onclick="dismissStudentAlertTemporarily()" aria-label="Close"><i class="fa-solid fa-xmark"></i></button>
    </div>

    <div id="alert-modal-body" style="white-space:pre-wrap; line-height:1.5; margin-top:10px;"></div>

    <div style="display:flex; gap:10px; margin-top:14px;">
      <button id="alert-modal-confirm" class="btn" onclick="confirmStudentAlertRead()" style="flex:1;"></button>
      <button id="alert-modal-close" class="btn btn-sec" onclick="dismissStudentAlertTemporarily()" style="flex:1;"></button>
    </div>

    <div id="alert-modal-counter" class="text-sm text-sec" style="text-align:center; margin-top:8px;"></div>
  </div>
</div>



<!-- Sync Issues Modal (unsaved actions) -->
<div id="sync-modal" class="modal-overlay" aria-hidden="true">
  <div class="modal-content" role="dialog" aria-modal="true">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
      <div id="sync-modal-title" class="font-bold" style="font-size:1.05rem;"></div>
      <button class="icon-btn" onclick="closeModal('sync-modal')" aria-label="Close"><i class="fa-solid fa-xmark"></i></button>
    </div>

    <div id="sync-modal-body" style="white-space:pre-wrap; line-height:1.5; margin-top:10px;"></div>

    <div style="display:flex; gap:10px; margin-top:14px; flex-wrap:wrap;">
      <button class="btn" onclick="retryFailedOps()">إعادة المحاولة / Wiederholen</button>
      <button class="btn" style="background: var(--surface-2); color: var(--text);" onclick="clearFailedOps()">مسح التحذيرات / Warnungen löschen</button>
    </div>
  </div>
</div>


  <!-- iOS-style exit confirmation -->
  <div id="ios-exit-confirm" class="hidden" aria-hidden="true">
    <div class="ios-backdrop"></div>
    <div class="ios-card" role="dialog" aria-modal="true" aria-labelledby="ios-exit-title" aria-describedby="ios-exit-msg">
      <div class="ios-body">
        <div id="ios-exit-title" class="ios-title">الخروج من التطبيق</div>
        <div id="ios-exit-msg" class="ios-msg">هل تريد فعلاً الخروج من التطبيق؟</div>
      </div>
      <div class="ios-actions">
        <button id="ios-exit-cancel" class="ios-btn ios-cancel" type="button">إلغاء</button>
        <button id="ios-exit-ok" class="ios-btn ios-exit" type="button">خروج</button>
      </div>
    </div>
  </div>

<script id="qc-audio-js">
(function(){
  const bar = document.getElementById('koranAudioBar');
  const a = document.getElementById('koranAudio');
  const seek = document.getElementById('koranSeek');
  const more = document.getElementById('koranAudioMoreBtn');
  const adv = document.getElementById('koranAudioAdvanced');
  const backdrop = document.getElementById('qcAudioSheetBackdrop');
  const muteBtn = document.getElementById('qcMuteBtn');

  if(!bar || !a) return;

  function openSheet(){
    if(backdrop) backdrop.hidden = false;
    if(adv){ adv.classList.add('open'); adv.setAttribute('aria-hidden','false'); }

    // Register as "modal" for back-button handling
    try{
      navState.modalStack = (navState.modalStack || []).filter(x => x !== 'qcAudioSheet');
      navState.modalStack.push('qcAudioSheet');
      if(!navState.popHandling){
        history.pushState({qsNav:true, kind:'koranOverlay', id:'qcAudioSheet'}, '');
      }
    }catch(e){}
  }
  function closeSheet(opts={}){
    if(backdrop) backdrop.hidden = true;
    if(adv){ adv.classList.remove('open'); adv.setAttribute('aria-hidden','true'); }

    try{
      navState.modalStack = (navState.modalStack || []).filter(x => x !== 'qcAudioSheet');
    }catch(e){}

    if(!opts || !opts.noHistory){
      try{
        if(!navState.popHandling) history.back();
      }catch(e){}
    }
  }

  if(more){ more.addEventListener('click', openSheet); }
  if(backdrop){ backdrop.addEventListener('click', closeSheet); }

  // Close sheet on ESC
  document.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape') closeSheet();
  });

  // Seek works with existing time/progress updaters; keep IDs same.
  if(seek){
    const seekTo = ()=>{
      const dur = (Number.isFinite(a.duration) && a.duration>0) ? a.duration : 0;
      if(dur<=0) return;
      const v = Math.max(0, Math.min(1000, Number(seek.value)||0));
      a.currentTime = (v/1000)*dur;
    };
    seek.addEventListener('input', seekTo);
    seek.addEventListener('change', seekTo);
  }

  // Basic mute toggle (optional)
  if(muteBtn){
    const syncIcon = ()=>{
      muteBtn.innerHTML = a.muted ? '<i class="fa-solid fa-volume-xmark"></i>' : '<i class="fa-solid fa-volume-high"></i>';
      muteBtn.setAttribute('aria-pressed', a.muted ? 'true' : 'false');
      muteBtn.title = a.muted ? 'إلغاء كتم الصوت' : 'كتم الصوت';
    };
    muteBtn.addEventListener('click', ()=>{
      a.muted = !a.muted;
      syncIcon();
    });
    a.addEventListener('volumechange', syncIcon);
    syncIcon();
  }

  // If advanced controls get focus, open sheet (keyboard accessibility)
  ['koranRepeatCount','koranSpeedSel','koranAutoNextChk','koranAudioPrev','koranAudioNext','koranAudioStop','koranBookmarkBtn'].forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    el.addEventListener('focus', openSheet);
  });

  // Expose helpers for other scripts if needed
  window.qcAudioSheet = { open: openSheet, close: closeSheet };
})();
</script>
</body>
</html>
